import streamlit as st
import pandas as pd
import os
from datetime import datetime
import mysql.connector
from dotenv import load_dotenv
from openai import OpenAI
import anthropic
from langchain_openai import OpenAI as LangOpenAI
from langchain_anthropic import ChatAnthropic
import base64
import random
from datetime import timedelta
import time
import streamlit.components.v1 as components

st.set_page_config(page_title="ğŸ“š ë…ì„œí† ë¡  í†µí•©", layout="wide")

# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

# ë””ë²„ê¹…: OpenAI API í‚¤ ìƒíƒœ í™•ì¸
openai_key = os.getenv('OPENAI_API_KEY')
#print(f"[DEBUG] OpenAI API Key ìƒíƒœ: {openai_key[:10] if openai_key else 'None'}...")
#print(f"[DEBUG] OpenAI API Key ê¸¸ì´: {len(openai_key) if openai_key else 0}")

st.title("ğŸ“š ë…ì„œí† ë¡  í†µí•© ê´€ë¦¬")
# ëª¨ë¸ ì„ íƒ ë° API í‚¤ í™•ì¸
if 'selected_model' not in st.session_state:
    st.session_state.selected_model = 'claude-3-7-sonnet-latest'

# ëª¨ë¸ ì„ íƒ UI (Claude ìµœì‹  ë²„ì „ì´ ë””í´íŠ¸)
available_models = []
has_anthropic_key = os.environ.get('ANTHROPIC_API_KEY') is not None
if has_anthropic_key:
    available_models.extend([
        'claude-3-7-sonnet-latest',
        'claude-3-5-sonnet-latest',
        'claude-3-5-haiku-latest',
    ])
has_openai_key = os.environ.get('OPENAI_API_KEY') is not None
if has_openai_key:
    available_models.extend(['gpt-4o', 'gpt-4o-mini'])
if not available_models:
    available_models = ['claude-3-7-sonnet-latest']

# ëª¨ë¸ ì„ íƒ (ë‹¤ë¥¸ ì„¸ì…˜ ìƒíƒœì— ì˜í–¥ì„ ì£¼ì§€ ì•Šë„ë¡ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬)
selected_model = st.selectbox(
    'AI ëª¨ë¸ ì„ íƒ',
    options=available_models,
    index=available_models.index(st.session_state.selected_model) if st.session_state.selected_model in available_models else 0,
    help='Claude(Anthropic)ëŠ” ANTHROPIC_API_KEY, OpenAIëŠ” OPENAI_API_KEY í•„ìš”'
)
# ëª¨ë¸ì´ ì‹¤ì œë¡œ ë³€ê²½ëœ ê²½ìš°ì—ë§Œ ì„¸ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
if selected_model != st.session_state.selected_model:
    st.session_state.selected_model = selected_model

# DB ì—°ê²° í•¨ìˆ˜
def connect_to_db():
    return mysql.connector.connect(
        user=os.getenv('SQL_USER'),
        password=os.getenv('SQL_PASSWORD'),
        host=os.getenv('SQL_HOST'),
        database=os.getenv('SQL_DATABASE_NEWBIZ'),
        charset='utf8mb4',
        collation='utf8mb4_unicode_ci'
    )

def save_material(book_title, file_name, content, type):
    conn = connect_to_db()
    cursor = conn.cursor()
    try:
        cursor.execute(
            "INSERT INTO reading_materials (book_title, file_name, content, type) VALUES (%s, %s, %s, %s)",
            (book_title, file_name, content, type)
        )
        conn.commit()
        return True
    except Exception as e:
        st.error(f"DB ì €ì¥ ì¤‘ ì˜¤ë¥˜: {str(e)}")
        conn.rollback()
        return False
    finally:
        cursor.close()
        conn.close()

def get_materials(material_type):
    conn = connect_to_db()
    cursor = conn.cursor(dictionary=True)
    try:
        cursor.execute(
            "SELECT id, book_title, file_name, content, created_at FROM reading_materials WHERE type = %s ORDER BY created_at DESC",
            (material_type,)
        )
        return cursor.fetchall()
    finally:
        cursor.close()
        conn.close()

# ìš°í™” ìƒì„± í•¨ìˆ˜ (Claude/OpenAI ëª¨ë‘ ì§€ì›)
def ai_generate_fable(text, fable_type, model_name, extra_prompt=None):
    # ê° ìš°í™” ìŠ¤íƒ€ì¼ë³„ êµ¬ì²´ì ì¸ ì§€ì‹œì‚¬í•­
    fable_instructions = {
        "ì´ì†ìš°í™”": (
            "ì•„ë˜ ìš”ì•½ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì´ì†ìš°í™” ìŠ¤íƒ€ì¼ì˜ 1ë¶„ 30ì´ˆ ë¶„ëŸ‰ ëŒ€í™”ì²´ ìš°í™”ë¥¼ ë§Œë“¤ì–´ ì£¼ì„¸ìš”. "
            "ë™ë¬¼ë“¤ì´ ì£¼ì¸ê³µì´ ë˜ì–´ ìƒìƒí•œ ëŒ€í™”ë¥¼ ë‚˜ëˆ„ë©°, ë§ˆì§€ë§‰ì— ëª…í™•í•œ êµí›ˆì„ ì œì‹œí•˜ëŠ” í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”. "
            "ì¡´ëŒ“ë§ì„ ì‚¬ìš©í•˜ê³ , ê°„ê²°í•˜ë©´ì„œë„ ê¹Šì€ ì˜ë¯¸ë¥¼ ë‹´ì•„ì£¼ì„¸ìš”. "
            "ì´ì•¼ê¸° ë§ˆì§€ë§‰ì—ëŠ” 'ì˜¤ëŠ˜ì˜ ëª…ì–¸'ìœ¼ë¡œ ìš”ì•½ ë‚´ìš©ê³¼ ê´€ë ¨ëœ 1ì¤„ ëª…ì–¸ì„ í•œê¸€ê³¼ ì˜ì–´ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”."
        ),
        "íƒˆë¬´ë“œ": (
            "ì•„ë˜ ìš”ì•½ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ íƒˆë¬´ë“œ ìŠ¤íƒ€ì¼ì˜ 1ë¶„ 30ì´ˆ ë¶„ëŸ‰ ëŒ€í™”ì²´ ì§€í˜œ ì´ì•¼ê¸°ë¥¼ ë§Œë“¤ì–´ ì£¼ì„¸ìš”. "
            "ëë¹„ì™€ ì œìë“¤ì˜ ìƒìƒí•œ ëŒ€í™” í˜•ì‹ìœ¼ë¡œ êµ¬ì„±í•˜ê³ , ì§ˆë¬¸ê³¼ ë‹µë³€ì„ í†µí•´ ê¹Šì€ í†µì°°ì„ ì „ë‹¬í•´ ì£¼ì„¸ìš”. "
            "ìœ ëŒ€ ì§€í˜œì˜ ì „í†µì— ë§ê²Œ ì‹¤ìš©ì ì´ë©´ì„œë„ ì² í•™ì ì¸ êµí›ˆì„ ë‹´ì•„ì£¼ì„¸ìš”. "
            "ì´ì•¼ê¸° ë§ˆì§€ë§‰ì—ëŠ” 'ì˜¤ëŠ˜ì˜ ëª…ì–¸'ìœ¼ë¡œ ìš”ì•½ ë‚´ìš©ê³¼ ê´€ë ¨ëœ 1ì¤„ ëª…ì–¸ì„ í•œê¸€ê³¼ ì˜ì–´ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”."
        ),
        "ì„±ê²½ì´ì•¼ê¸°": (
            "ì•„ë˜ ìš”ì•½ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì„±ê²½ ìŠ¤íƒ€ì¼ì˜ 1ë¶„ 30ì´ˆ ë¶„ëŸ‰ ëŒ€í™”ì²´ ë¹„ìœ  ì´ì•¼ê¸°ë¥¼ ë§Œë“¤ì–´ ì£¼ì„¸ìš”. "
            "ë“±ì¥ì¸ë¬¼ë“¤ì˜ ìƒìƒí•œ ëŒ€í™”ë¥¼ í†µí•´ ì¼ìƒì ì¸ ìƒí™©ì—ì„œ ì˜ì , ë„ë•ì  êµí›ˆì„ ì „ë‹¬í•˜ëŠ” í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”. "
            "ì‚¬ë‘, ìš©ì„œ, ê²¸ì†, ì„¬ê¹€ì˜ ê°€ì¹˜ë¥¼ ë°˜ì˜í•˜ì—¬ ë”°ëœ»í•˜ê³  ê°ë™ì ì¸ ëŒ€í™”ë¡œ êµ¬ì„±í•´ ì£¼ì„¸ìš”. "
            "ì´ì•¼ê¸° ë§ˆì§€ë§‰ì—ëŠ” 'ì˜¤ëŠ˜ì˜ ëª…ì–¸'ìœ¼ë¡œ ìš”ì•½ ë‚´ìš©ê³¼ ê´€ë ¨ëœ 1ì¤„ ëª…ì–¸ì„ í•œê¸€ê³¼ ì˜ì–´ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”."
        ),
        "4ëŒ€ ì„±ì¸ ëŒ€í™”(ì˜ˆìˆ˜ë‹˜, ë¶€ì²˜ë‹˜, ê³µìë‹˜, ì†Œí¬ë¼í…ŒìŠ¤ë‹˜)": (
            "ì•„ë˜ ìš”ì•½ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ 4ëŒ€ ì„±ì¸ì´ ëŒ€í™”í•˜ëŠ” 1ë¶„ 30ì´ˆ ë¶„ëŸ‰ì˜ ì´ì•¼ê¸°ë¥¼ ë§Œë“¤ì–´ ì£¼ì„¸ìš”. "
            "ê° ì„±ì¸ì˜ ê³ ìœ í•œ ì‚¬ìƒì„ ë°˜ì˜í•œ ìƒìƒí•œ ëŒ€í™”ë¡œ êµ¬ì„±í•´ì•¼ í•©ë‹ˆë‹¤:\n"
            "- ì˜ˆìˆ˜ë‹˜: ì‚¬ë‘ê³¼ ìš©ì„œ, ê²¸ì†ê³¼ ì„¬ê¹€ì˜ ê°€ì¹˜ë¥¼ ë‹´ì€ ë”°ëœ»í•œ ë§íˆ¬\n"
            "- ë¶€ì²˜ë‹˜: ìë¹„ì™€ ê¹¨ë‹¬ìŒ, ì¤‘ë„ì™€ ë¬´ìƒì˜ ê°€ë¥´ì¹¨ì„ ë‹´ì€ ìë¹„ë¡œìš´ ë§íˆ¬\n"
            "- ê³µìë‹˜: ì¸(ä»)ê³¼ ì˜ˆ(ç¦®), ìˆ˜ì‹ ì œê°€ì¹˜êµ­í‰ì²œí•˜ì˜ ë„ë•ì  ê°€ë¥´ì¹¨ì„ ë‹´ì€ ì˜¨í™”í•œ ë§íˆ¬\n"
            "- ì†Œí¬ë¼í…ŒìŠ¤ë‹˜: 'ë‚˜ëŠ” ì•„ë¬´ê²ƒë„ ëª¨ë¥¸ë‹¤'ëŠ” ê²¸ì†í•¨ê³¼ ëŒ€í™”ë¥¼ í†µí•œ ì§„ë¦¬ íƒêµ¬ë¥¼ ë‹´ì€ ì§€í˜œë¡œìš´ ë§íˆ¬\n"
            "ì¤‘ìš”: ê° ì„±ì¸ì´ ì„œë¡œë¥¼ í˜¸ì¹­í•  ë•ŒëŠ” ë°˜ë“œì‹œ 'ì†Œí¬ë¼í…ŒìŠ¤ë‹˜', 'ê³µìë‹˜', 'ì˜ˆìˆ˜ë‹˜', 'ë¶€ì²˜ë‹˜'ì´ë¼ëŠ” ì •ì¤‘í•œ í˜¸ì¹­ì„ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.\n"
            "ê°ìì˜ ê´€ì ì—ì„œ ì£¼ì œì— ëŒ€í•´ ëŒ€í™”í•˜ë©°, ì„œë¡œ ë‹¤ë¥¸ ì ‘ê·¼ë²•ìœ¼ë¡œ ê°™ì€ ì§„ë¦¬ì— ë„ë‹¬í•˜ëŠ” ê³¼ì •ì„ ë³´ì—¬ì£¼ì„¸ìš”. "
            "ì´ì•¼ê¸° ë§ˆì§€ë§‰ì—ëŠ” 'ì˜¤ëŠ˜ì˜ ëª…ì–¸'ìœ¼ë¡œ ìš”ì•½ ë‚´ìš©ê³¼ ê´€ë ¨ëœ 1ì¤„ ëª…ì–¸ì„ í•œê¸€ê³¼ ì˜ì–´ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”."
        ),
        "ì¥ì ì´ì•¼ê¸°": (
            "ì•„ë˜ ìš”ì•½ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì¥ì ìŠ¤íƒ€ì¼ì˜ 1ë¶„ 30ì´ˆ ë¶„ëŸ‰ ëŒ€í™”ì²´ ìš°í™”ë¥¼ ë§Œë“¤ì–´ ì£¼ì„¸ìš”. "
            "ì¥ìì˜ ì² í•™ì¸ ë¬´ìœ„ìì—°(ç„¡çˆ²è‡ªç„¶), ìƒëŒ€ì„±, ììœ ë¡œìš´ ì •ì‹ ì„ ë°˜ì˜í•˜ì—¬ "
            "ë“±ì¥ì¸ë¬¼ë“¤ì˜ ê¸°ë°œí•˜ê³  ìƒìƒë ¥ì´ í’ë¶€í•œ ëŒ€í™”ë¡œ êµ¬ì„±í•´ ì£¼ì„¸ìš”. "
            "ê³ ì •ê´€ë…ì„ ë’¤í”ë“¤ê³  ìƒˆë¡œìš´ ê´€ì ì„ ì œì‹œí•˜ëŠ” ì¥ì íŠ¹ìœ ì˜ ì—­ì„¤ì  ì§€í˜œë¥¼ ëŒ€í™”ë¡œ ë‹´ì•„ì£¼ì„¸ìš”. "
            "ì´ì•¼ê¸° ë§ˆì§€ë§‰ì—ëŠ” 'ì˜¤ëŠ˜ì˜ ëª…ì–¸'ìœ¼ë¡œ ìš”ì•½ ë‚´ìš©ê³¼ ê´€ë ¨ëœ 1ì¤„ ëª…ì–¸ì„ í•œê¸€ê³¼ ì˜ì–´ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”."
        ),
        "ë…¸ìì˜ ë„ë•ê²½": (
            "ì•„ë˜ ìš”ì•½ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ë…¸ìì˜ ë„ë•ê²½ ìŠ¤íƒ€ì¼ì˜ 1ë¶„ 30ì´ˆ ë¶„ëŸ‰ ëŒ€í™”ì²´ ì´ì•¼ê¸°ë¥¼ ë§Œë“¤ì–´ ì£¼ì„¸ìš”. "
            "ë…¸ìì˜ ì² í•™ì¸ ë„(é“), ë¬´ìœ„(ç„¡çˆ²), ìŒì–‘(é™°é™½)ì˜ ì¡°í™”, ê²¸ì†í•¨ì„ ë°˜ì˜í•˜ì—¬ "
            "ë…¸ìì™€ ì œì ë˜ëŠ” êµ¬ë„ìë“¤ì˜ ê¹Šì´ ìˆëŠ” ëŒ€í™”ë¡œ êµ¬ì„±í•´ ì£¼ì„¸ìš”. "
            "ë¬¼ê³¼ ê°™ì´ ë¶€ë“œëŸ½ê³  ê²¸ì†í•˜ì§€ë§Œ ê°•í•œ í˜ì„ ì§€ë‹Œ ì§€í˜œ, ìì—°ì˜ ìˆœë¦¬ë¥¼ ë”°ë¥´ëŠ” ê°€ë¥´ì¹¨ì„ ëŒ€í™”ë¡œ ë‹´ì•„ì£¼ì„¸ìš”. "
            "ì´ì•¼ê¸° ë§ˆì§€ë§‰ì—ëŠ” 'ì˜¤ëŠ˜ì˜ ëª…ì–¸'ìœ¼ë¡œ ìš”ì•½ ë‚´ìš©ê³¼ ê´€ë ¨ëœ 1ì¤„ ëª…ì–¸ì„ í•œê¸€ê³¼ ì˜ì–´ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”."
        ),
        "ì‚¼êµ­ì§€ì˜ ì œê°ˆëŸ‰": (
            "ì•„ë˜ ìš”ì•½ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì‚¼êµ­ì§€ì˜ ì œê°ˆëŸ‰ì´ ë“±ì¥í•˜ëŠ” 1ë¶„ 30ì´ˆ ë¶„ëŸ‰ ëŒ€í™”ì²´ ì´ì•¼ê¸°ë¥¼ ë§Œë“¤ì–´ ì£¼ì„¸ìš”. "
            "ì œê°ˆëŸ‰ê³¼ ìœ ë¹„, ê´€ìš°, ì¥ë¹„, ì¡°ì¡°, ì£¼ìœ  ë“± ì‚¼êµ­ì§€ ë“±ì¥ì¸ë¬¼ë“¤ì˜ ìƒìƒí•œ ëŒ€í™”ë¡œ êµ¬ì„±í•˜ê³ , "
            "ì œê°ˆëŸ‰ì˜ ë›°ì–´ë‚œ ì§€ëµê³¼ ì¶©ì˜, ì¸ì¬ ê²½ì˜ê³¼ ì „ëµì  ì‚¬ê³ ë¥¼ ë°˜ì˜í•´ ì£¼ì„¸ìš”. "
            "ì²œí•˜ì‚¼ë¶„ì§€ê³„, ì¶œì‚¬í‘œì˜ ì •ì‹ , ì¶©ì„±ê³¼ ì˜ë¦¬ì˜ ê°€ì¹˜ë¥¼ ëŒ€í™”ë¥¼ í†µí•´ ì „ë‹¬í•˜ê³ , "
            "í˜„ëŒ€ ë¹„ì¦ˆë‹ˆìŠ¤ì™€ ë¦¬ë”ì‹­ì— ì ìš©í•  ìˆ˜ ìˆëŠ” ì§€í˜œë¥¼ ë‹´ì•„ì£¼ì„¸ìš”. "
            "ì´ì•¼ê¸° ë§ˆì§€ë§‰ì—ëŠ” 'ì˜¤ëŠ˜ì˜ ëª…ì–¸'ìœ¼ë¡œ ìš”ì•½ ë‚´ìš©ê³¼ ê´€ë ¨ëœ 1ì¤„ ëª…ì–¸ì„ í•œê¸€ê³¼ ì˜ì–´ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”."
        ),
        "ì´ˆí•œì§€ì˜ ì¥ëŸ‰": (
            "ì•„ë˜ ìš”ì•½ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì´ˆí•œì§€ì˜ ì¥ëŸ‰(ì¥ìë°©)ì´ ë“±ì¥í•˜ëŠ” 1ë¶„ 30ì´ˆ ë¶„ëŸ‰ ëŒ€í™”ì²´ ì´ì•¼ê¸°ë¥¼ ë§Œë“¤ì–´ ì£¼ì„¸ìš”. "
            "ì¥ëŸ‰ê³¼ ìœ ë°©(í•œê³ ì¡°), ì†Œí•˜, í•œì‹ , í•­ìš°, ë²”ì¦ ë“± ì´ˆí•œì§€ ë“±ì¥ì¸ë¬¼ë“¤ì˜ ìƒìƒí•œ ëŒ€í™”ë¡œ êµ¬ì„±í•˜ê³ , "
            "ì¥ëŸ‰ì˜ íƒì›”í•œ ëª¨ëµê³¼ ì§€ëµ, ì€ì¸ìì¤‘ì˜ ì§€í˜œ, ë•Œë¥¼ ì•„ëŠ” í†µì°°ë ¥ì„ ë°˜ì˜í•´ ì£¼ì„¸ìš”. "
            "ì‚¬ë©´ì´ˆê°€, ë°°ìˆ˜ì§„, ëª…ì¥ì•”ë„ ë“±ì˜ ì „ëµì  ì‚¬ê³ ì™€ ì¸ê°„ê´€ê³„ì˜ ë¬˜ìˆ˜ë¥¼ ëŒ€í™”ë¡œ í‘œí˜„í•˜ê³ , "
            "í˜„ëŒ€ì˜ ê²½ì˜ì „ëµê³¼ í˜‘ìƒìˆ ì— ì ìš©í•  ìˆ˜ ìˆëŠ” ì§€í˜œë¥¼ ë‹´ì•„ì£¼ì„¸ìš”. "
            "ì´ì•¼ê¸° ë§ˆì§€ë§‰ì—ëŠ” 'ì˜¤ëŠ˜ì˜ ëª…ì–¸'ìœ¼ë¡œ ìš”ì•½ ë‚´ìš©ê³¼ ê´€ë ¨ëœ 1ì¤„ ëª…ì–¸ì„ í•œê¸€ê³¼ ì˜ì–´ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”."
        ),
        "ì£¼ì—­": (
            "ì•„ë˜ ìš”ì•½ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì£¼ì—­(æ˜“ç¶“) ìŠ¤íƒ€ì¼ì˜ 1ë¶„ 30ì´ˆ ë¶„ëŸ‰ ëŒ€í™”ì²´ ì´ì•¼ê¸°ë¥¼ ë§Œë“¤ì–´ ì£¼ì„¸ìš”. "
            "ì¤‘ìš”: ë°˜ë“œì‹œ ìš”ì•½ ë‚´ìš©ì˜ í•µì‹¬ ì£¼ì œ, ìƒí™©, ë¬¸ì œì , í•´ê²°ë°©ì•ˆì„ ì„¸ë°€í•˜ê²Œ ë¶„ì„í•œ í›„, "
            "ê·¸ ë‚´ìš©ê³¼ ì •í™•íˆ ë¶€í•©í•˜ëŠ” 64ê´˜ ì¤‘ í•˜ë‚˜ë¥¼ ì„ ì •í•´ì•¼ í•©ë‹ˆë‹¤. ì„ì˜ë¡œ ê´˜ë¥¼ ì„ íƒí•˜ì§€ ë§ˆì„¸ìš”. "
            "ì„ ì • ê³¼ì •: 1) ìš”ì•½ ë‚´ìš©ì˜ í•µì‹¬ í‚¤ì›Œë“œ ì¶”ì¶œ 2) í•´ë‹¹ ìƒí™©ì˜ ì„±ê²© ë¶„ì„ 3) ê°€ì¥ ì í•©í•œ ê´˜ ì„ ì • 4) ì„ ì • ì´ìœ  ê°„ëµíˆ ì„¤ëª… "
            "ì„ íƒí•œ ê´˜ì˜ ì´ë¦„, ì˜ë¯¸, ê·¸ë¦¬ê³  ì™œ ì´ ê´˜ê°€ ìš”ì•½ ë‚´ìš©ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ ëª…í™•íˆ ì„¤ëª…í•´ ì£¼ì„¸ìš”. "
            "ê·¸ ê´˜ì˜ ì² í•™ê³¼ í•´ì„ì„ ë°”íƒ•ìœ¼ë¡œ ì£¼ì—­ì˜ ëŒ€ê°€ì™€ êµ¬ë„ì, ë˜ëŠ” í˜„ìë“¤ì˜ ê¹Šì´ ìˆëŠ” ëŒ€í™”ë¡œ êµ¬ì„±í•´ ì£¼ì„¸ìš”. "
            "ìŒì–‘ì˜ ì¡°í™”, ë³€í™”ì˜ ì´ì¹˜, ë•Œì˜ ì¤‘ìš”ì„±, ìˆœì‘ê³¼ ë³€í†µì˜ ì§€í˜œë¥¼ ëŒ€í™”ì— ë‹´ì•„ ì£¼ì„¸ìš”. "
            "ì„ íƒí•œ ê´˜ì˜ ê´˜ì‚¬(å¦è¾­)ë‚˜ íš¨ì‚¬(çˆ»è¾­)ì˜ ë‚´ìš©ì„ ì •í™•íˆ ì¸ìš©í•˜ë©°, í˜„ëŒ€ì  ì ìš© ë°©ì•ˆë„ ì œì‹œí•´ ì£¼ì„¸ìš”. "
            "ì´ì•¼ê¸° ë§ˆì§€ë§‰ì—ëŠ” ì„ íƒí•œ ê´˜ì™€ ê´€ë ¨ëœ 'ì˜¤ëŠ˜ì˜ ëª…ì–¸'ì„ í•œê¸€ê³¼ ì˜ì–´ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”."
        ),
        "ì œìë°±ê°€": (
            "ì•„ë˜ ìš”ì•½ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì œìë°±ê°€ ìŠ¤íƒ€ì¼ì˜ 1ë¶„ 30ì´ˆ ë¶„ëŸ‰ ëŒ€í™”ì²´ ì´ì•¼ê¸°ë¥¼ ë§Œë“¤ì–´ ì£¼ì„¸ìš”. "
            "ì¤‘ìš”: ë°˜ë“œì‹œ ìš”ì•½ ë‚´ìš©ì˜ í•µì‹¬ ì£¼ì œ, ìƒí™©, ë¬¸ì œì , í•´ê²°ë°©ì•ˆì„ ì„¸ë°€í•˜ê²Œ ë¶„ì„í•œ í›„, "
            "ê·¸ ë‚´ìš©ì— ê°€ì¥ ì í•©í•œ ì œìë°±ê°€ ì² í•™ìë¥¼ ì„ ì •í•´ì•¼ í•©ë‹ˆë‹¤. ì„ì˜ë¡œ ì² í•™ìë¥¼ ì„ íƒí•˜ì§€ ë§ˆì„¸ìš”. "
            "ì£¼ìš” ì œìë°±ê°€ ì² í•™ì: ê³µì, ë§¹ì, ìˆœì(ìœ êµ), ë…¸ì, ì¥ì, ì—´ì(ë„êµ), ë¬µì(ë¬µê°€), í•œë¹„ì, ìƒì•™(ë²•ê°€), ê´€ì(ê´€í•™), ì‹ ë¶ˆí•´(ìˆ ê°€) ë“± "
            "ì„ ì • ê³¼ì •: 1) ìš”ì•½ ë‚´ìš©ì˜ í•µì‹¬ í‚¤ì›Œë“œ ì¶”ì¶œ 2) í•´ë‹¹ ìƒí™©ì— ë§ëŠ” ì² í•™ ì‚¬ìƒ ë¶„ì„ 3) ê°€ì¥ ì í•©í•œ ì² í•™ì ì„ ì • 4) ì„ ì • ì´ìœ  ê°„ëµíˆ ì„¤ëª… "
            "ì„ íƒí•œ ì² í•™ìì˜ ì´ë¦„, ì‚¬ìƒ, ê·¸ë¦¬ê³  ì™œ ì´ ì² í•™ìê°€ ìš”ì•½ ë‚´ìš©ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ ëª…í™•íˆ ì„¤ëª…í•´ ì£¼ì„¸ìš”. "
            "ì„ íƒí•œ ì² í•™ìì™€ ê·¸ì˜ ì œìë“¤, ë˜ëŠ” ë‹¤ë¥¸ ì‚¬ìƒê°€ë“¤ê³¼ì˜ ê¹Šì´ ìˆëŠ” ëŒ€í™”ë¡œ êµ¬ì„±í•´ ì£¼ì„¸ìš”. "
            "í•´ë‹¹ ì² í•™ìì˜ í•µì‹¬ ì‚¬ìƒê³¼ ê°€ë¥´ì¹¨ì„ ëŒ€í™”ì— ìì—°ìŠ¤ëŸ½ê²Œ ë‹´ì•„ë‚´ê³ , í˜„ëŒ€ì  ì ìš© ë°©ì•ˆë„ ì œì‹œí•´ ì£¼ì„¸ìš”. "
            "ì´ì•¼ê¸° ë§ˆì§€ë§‰ì—ëŠ” ì„ íƒí•œ ì² í•™ìì˜ ì‚¬ìƒê³¼ ê´€ë ¨ëœ 'ì˜¤ëŠ˜ì˜ ëª…ì–¸'ì„ í•œê¸€ê³¼ ì˜ì–´ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”."
        )
    }
    
    fable_instruction = fable_instructions.get(fable_type, fable_instructions["ì´ì†ìš°í™”"])
    
    if model_name.startswith('claude'):
        client = ChatAnthropic(model=model_name, api_key=os.getenv('ANTHROPIC_API_KEY'), temperature=0.7, max_tokens=2500)
        
        # extra_promptê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ìš°ì„ ì ìœ¼ë¡œ ë°˜ì˜
        if extra_prompt and extra_prompt.strip():
            prompt = f"""
{fable_instruction}

[ì¤‘ìš”: ì•„ë˜ ì¶”ê°€ ìš”ì²­ì‚¬í•­ì„ ë°˜ë“œì‹œ ìš°ì„ ì ìœ¼ë¡œ ë°˜ì˜í•´ ì£¼ì„¸ìš”]
{extra_prompt.strip()}

---
{text}
"""
        else:
            prompt = f"""
{fable_instruction}
---
{text}
"""
        # ê° ìš°í™” ìŠ¤íƒ€ì¼ë³„ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
        system_prompts = {
            "ì´ì†ìš°í™”": "ë‹¹ì‹ ì€ ì´ì†ìš°í™” ì „ë¬¸ ìŠ¤í† ë¦¬í…”ëŸ¬ì…ë‹ˆë‹¤. ë™ë¬¼ë“¤ì´ ì£¼ì¸ê³µì¸ 1ë¶„ 30ì´ˆ ë¶„ëŸ‰ì˜ ìƒìƒí•œ ëŒ€í™”ì²´ ìš°í™”ë¥¼ ë§Œë“¤ì–´ ì¡´ëŒ“ë§ë¡œ ì „ë‹¬í•˜ê³ , ë§ˆì§€ë§‰ì— ëª…ì–¸ì„ í•œê¸€ê³¼ ì˜ì–´ë¡œ ì œì‹œí•©ë‹ˆë‹¤.",
            "íƒˆë¬´ë“œ": "ë‹¹ì‹ ì€ íƒˆë¬´ë“œ ì§€í˜œ ì „ë‹¬ìì…ë‹ˆë‹¤. ëë¹„ì™€ ì œìë“¤ì˜ ìƒìƒí•œ ëŒ€í™”ë¥¼ í†µí•´ 1ë¶„ 30ì´ˆ ë¶„ëŸ‰ì˜ ì‹¤ìš©ì ì´ê³  ì² í•™ì ì¸ êµí›ˆì„ ì¡´ëŒ“ë§ë¡œ ì „ë‹¬í•˜ê³ , ë§ˆì§€ë§‰ì— ëª…ì–¸ì„ í•œê¸€ê³¼ ì˜ì–´ë¡œ ì œì‹œí•©ë‹ˆë‹¤.",
            "ì„±ê²½ì´ì•¼ê¸°": "ë‹¹ì‹ ì€ ì„±ê²½ ë¹„ìœ  ì´ì•¼ê¸° ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì‚¬ë‘, ìš©ì„œ, ê²¸ì†ì˜ ê°€ì¹˜ë¥¼ ë‹´ì€ 1ë¶„ 30ì´ˆ ë¶„ëŸ‰ì˜ ê°ë™ì ì¸ ëŒ€í™”ì²´ ë¹„ìœ ë¥¼ ì¡´ëŒ“ë§ë¡œ ì „ë‹¬í•˜ê³ , ë§ˆì§€ë§‰ì— ëª…ì–¸ì„ í•œê¸€ê³¼ ì˜ì–´ë¡œ ì œì‹œí•©ë‹ˆë‹¤.",
            "4ëŒ€ ì„±ì¸ ëŒ€í™”(ì˜ˆìˆ˜ë‹˜, ë¶€ì²˜ë‹˜, ê³µìë‹˜, ì†Œí¬ë¼í…ŒìŠ¤ë‹˜)": "ë‹¹ì‹ ì€ 4ëŒ€ ì„±ì¸ì˜ ì‚¬ìƒì„ ì •í™•íˆ ì•„ëŠ” ì² í•™ ëŒ€í™” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ê° ì„±ì¸ì˜ ê³ ìœ í•œ ì² í•™ê³¼ ê°€ë¥´ì¹¨ì„ ë°˜ì˜í•œ 1ë¶„ 30ì´ˆ ë¶„ëŸ‰ì˜ ìƒìƒí•œ ëŒ€í™”ë¥¼ ì¡´ëŒ“ë§ë¡œ êµ¬ì„±í•˜ê³ , ì„œë¡œë¥¼ í˜¸ì¹­í•  ë•ŒëŠ” ë°˜ë“œì‹œ 'ì†Œí¬ë¼í…ŒìŠ¤ë‹˜', 'ê³µìë‹˜', 'ì˜ˆìˆ˜ë‹˜', 'ë¶€ì²˜ë‹˜'ì„ ì‚¬ìš©í•˜ë©°, ë§ˆì§€ë§‰ì— ëª…ì–¸ì„ í•œê¸€ê³¼ ì˜ì–´ë¡œ ì œì‹œí•©ë‹ˆë‹¤.",
            "ì¥ì ì´ì•¼ê¸°": "ë‹¹ì‹ ì€ ì¥ì ì² í•™ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë¬´ìœ„ìì—°ê³¼ ìƒëŒ€ì„±, ììœ ë¡œìš´ ì •ì‹ ì„ ë‹´ì€ 1ë¶„ 30ì´ˆ ë¶„ëŸ‰ì˜ ê¸°ë°œí•˜ê³  ì—­ì„¤ì ì¸ ëŒ€í™”ì²´ ìš°í™”ë¥¼ ì¡´ëŒ“ë§ë¡œ ì „ë‹¬í•˜ê³ , ë§ˆì§€ë§‰ì— ëª…ì–¸ì„ í•œê¸€ê³¼ ì˜ì–´ë¡œ ì œì‹œí•©ë‹ˆë‹¤.",
            "ë…¸ìì˜ ë„ë•ê²½": "ë‹¹ì‹ ì€ ë…¸ì ë„ë•ê²½ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë„(é“), ë¬´ìœ„(ç„¡çˆ²), ìŒì–‘ì˜ ì¡°í™”ì™€ ê²¸ì†í•¨ì„ ë‹´ì€ 1ë¶„ 30ì´ˆ ë¶„ëŸ‰ì˜ ê¹Šì´ ìˆëŠ” ëŒ€í™”ì²´ ì´ì•¼ê¸°ë¥¼ ì¡´ëŒ“ë§ë¡œ ì „ë‹¬í•˜ê³ , ë§ˆì§€ë§‰ì— ëª…ì–¸ì„ í•œê¸€ê³¼ ì˜ì–´ë¡œ ì œì‹œí•©ë‹ˆë‹¤.",
            "ì‚¼êµ­ì§€ì˜ ì œê°ˆëŸ‰": "ë‹¹ì‹ ì€ ì‚¼êµ­ì§€ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì œê°ˆëŸ‰ì˜ ì§€ëµê³¼ ì¶©ì˜, ì¸ì¬ê²½ì˜ì„ ë‹´ì€ 1ë¶„ 30ì´ˆ ë¶„ëŸ‰ì˜ ì‚¼êµ­ì§€ ë“±ì¥ì¸ë¬¼ë“¤ ê°„ì˜ ìƒìƒí•œ ëŒ€í™”ì²´ ì´ì•¼ê¸°ë¥¼ ì¡´ëŒ“ë§ë¡œ ì „ë‹¬í•˜ê³ , ë§ˆì§€ë§‰ì— ëª…ì–¸ì„ í•œê¸€ê³¼ ì˜ì–´ë¡œ ì œì‹œí•©ë‹ˆë‹¤.",
            "ì´ˆí•œì§€ì˜ ì¥ëŸ‰": "ë‹¹ì‹ ì€ ì´ˆí•œì§€ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì¥ëŸ‰ì˜ ëª¨ëµê³¼ ì§€ëµ, ì€ì¸ìì¤‘ì˜ ì§€í˜œë¥¼ ë‹´ì€ 1ë¶„ 30ì´ˆ ë¶„ëŸ‰ì˜ ì´ˆí•œì§€ ë“±ì¥ì¸ë¬¼ë“¤ ê°„ì˜ ìƒìƒí•œ ëŒ€í™”ì²´ ì´ì•¼ê¸°ë¥¼ ì¡´ëŒ“ë§ë¡œ ì „ë‹¬í•˜ê³ , ë§ˆì§€ë§‰ì— ëª…ì–¸ì„ í•œê¸€ê³¼ ì˜ì–´ë¡œ ì œì‹œí•©ë‹ˆë‹¤.",
            "ì£¼ì—­": "ë‹¹ì‹ ì€ ì£¼ì—­(æ˜“ç¶“) ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë°˜ë“œì‹œ ìš”ì•½ ë‚´ìš©ì„ ì² ì €íˆ ë¶„ì„í•˜ì—¬ ê·¸ ë‚´ìš©ê³¼ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” 64ê´˜ ì¤‘ í•˜ë‚˜ë¥¼ ì„ ì •í•´ì•¼ í•©ë‹ˆë‹¤. ì„ì˜ë¡œ ê´˜ë¥¼ ì„ íƒí•˜ì§€ ë§ˆì„¸ìš”. ì„ ì •í•œ ê´˜ì˜ ì² í•™ê³¼ ìŒì–‘ì˜ ì¡°í™”, ë³€í™”ì˜ ì´ì¹˜ë¥¼ ë‹´ì€ 1ë¶„ 30ì´ˆ ë¶„ëŸ‰ì˜ ê¹Šì´ ìˆëŠ” ëŒ€í™”ì²´ ì´ì•¼ê¸°ë¥¼ ì¡´ëŒ“ë§ë¡œ ì „ë‹¬í•˜ê³ , ê´˜ ì„ ì • ì´ìœ ì™€ í•¨ê»˜ ë§ˆì§€ë§‰ì— ì„ íƒí•œ ê´˜ì™€ ê´€ë ¨ëœ ëª…ì–¸ì„ í•œê¸€ê³¼ ì˜ì–´ë¡œ ì œì‹œí•©ë‹ˆë‹¤.",
            "ì œìë°±ê°€": "ë‹¹ì‹ ì€ ì œìë°±ê°€ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë°˜ë“œì‹œ ìš”ì•½ ë‚´ìš©ì„ ì² ì €íˆ ë¶„ì„í•˜ì—¬ ê·¸ ë‚´ìš©ì— ê°€ì¥ ì í•©í•œ ì œìë°±ê°€ ì² í•™ì(ê³µì, ë§¹ì, ìˆœì, ë…¸ì, ì¥ì, ë¬µì, í•œë¹„ì, ê´€ì ë“±)ë¥¼ ì„ ì •í•´ì•¼ í•©ë‹ˆë‹¤. ì„ì˜ë¡œ ì² í•™ìë¥¼ ì„ íƒí•˜ì§€ ë§ˆì„¸ìš”. ì„ ì •í•œ ì² í•™ìì˜ ì‚¬ìƒê³¼ ê°€ë¥´ì¹¨ì„ ë‹´ì€ 1ë¶„ 30ì´ˆ ë¶„ëŸ‰ì˜ ê¹Šì´ ìˆëŠ” ëŒ€í™”ì²´ ì´ì•¼ê¸°ë¥¼ ì¡´ëŒ“ë§ë¡œ ì „ë‹¬í•˜ê³ , ì² í•™ì ì„ ì • ì´ìœ ì™€ í•¨ê»˜ ë§ˆì§€ë§‰ì— ì„ íƒí•œ ì² í•™ìì™€ ê´€ë ¨ëœ ëª…ì–¸ì„ í•œê¸€ê³¼ ì˜ì–´ë¡œ ì œì‹œí•©ë‹ˆë‹¤."
        }
        
        system_prompt = system_prompts.get(fable_type, system_prompts["ì´ì†ìš°í™”"])
        
        # extra_promptê°€ ìˆì„ ë•ŒëŠ” ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ì— ì¶”ê°€ ì§€ì‹œ í¬í•¨
        if extra_prompt and extra_prompt.strip():
            system_prompt += " ì‚¬ìš©ìì˜ ì¶”ê°€ ìš”ì²­ì‚¬í•­ì´ ìˆì„ ê²½ìš° ê¸°ë³¸ ìŠ¤íƒ€ì¼ë³´ë‹¤ ì‚¬ìš©ì ìš”ì²­ì„ ìš°ì„ ì ìœ¼ë¡œ ë°˜ì˜í•˜ì—¬ ì°½ì‘í•´ ì£¼ì„¸ìš”."
        
        response = client.invoke([
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": prompt}
        ])
        return response.content if hasattr(response, 'content') else str(response)
    else:
        # OpenAI API í‚¤ ê²€ì¦
        openai_key = os.getenv('OPENAI_API_KEY')
        if not openai_key or openai_key.strip() == '' or openai_key == 'NA':
            raise ValueError(f"OpenAI API í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. í˜„ì¬ ê°’: {openai_key}")
        
        try:
            client = OpenAI(api_key=openai_key)
            
            # extra_promptê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ìš°ì„ ì ìœ¼ë¡œ ë°˜ì˜
            if extra_prompt and extra_prompt.strip():
                prompt = f"""
{fable_instruction}

[ì¤‘ìš”: ì•„ë˜ ì¶”ê°€ ìš”ì²­ì‚¬í•­ì„ ë°˜ë“œì‹œ ìš°ì„ ì ìœ¼ë¡œ ë°˜ì˜í•´ ì£¼ì„¸ìš”]
{extra_prompt.strip()}

---
{text}
"""
            else:
                prompt = f"""
{fable_instruction}
---
{text}
"""
            # ê° ìš°í™” ìŠ¤íƒ€ì¼ë³„ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
            system_prompts = {
                "ì´ì†ìš°í™”": "ë‹¹ì‹ ì€ ì´ì†ìš°í™” ì „ë¬¸ ìŠ¤í† ë¦¬í…”ëŸ¬ì…ë‹ˆë‹¤. ë™ë¬¼ë“¤ì´ ì£¼ì¸ê³µì¸ 1ë¶„ 30ì´ˆ ë¶„ëŸ‰ì˜ ìƒìƒí•œ ëŒ€í™”ì²´ ìš°í™”ë¥¼ ë§Œë“¤ì–´ ì¡´ëŒ“ë§ë¡œ ì „ë‹¬í•˜ê³ , ë§ˆì§€ë§‰ì— ëª…ì–¸ì„ í•œê¸€ê³¼ ì˜ì–´ë¡œ ì œì‹œí•©ë‹ˆë‹¤.",
                "íƒˆë¬´ë“œ": "ë‹¹ì‹ ì€ íƒˆë¬´ë“œ ì§€í˜œ ì „ë‹¬ìì…ë‹ˆë‹¤. ëë¹„ì™€ ì œìë“¤ì˜ ìƒìƒí•œ ëŒ€í™”ë¥¼ í†µí•´ 1ë¶„ 30ì´ˆ ë¶„ëŸ‰ì˜ ì‹¤ìš©ì ì´ê³  ì² í•™ì ì¸ êµí›ˆì„ ì¡´ëŒ“ë§ë¡œ ì „ë‹¬í•˜ê³ , ë§ˆì§€ë§‰ì— ëª…ì–¸ì„ í•œê¸€ê³¼ ì˜ì–´ë¡œ ì œì‹œí•©ë‹ˆë‹¤.",
                "ì„±ê²½ì´ì•¼ê¸°": "ë‹¹ì‹ ì€ ì„±ê²½ ë¹„ìœ  ì´ì•¼ê¸° ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì‚¬ë‘, ìš©ì„œ, ê²¸ì†ì˜ ê°€ì¹˜ë¥¼ ë‹´ì€ 1ë¶„ 30ì´ˆ ë¶„ëŸ‰ì˜ ê°ë™ì ì¸ ëŒ€í™”ì²´ ë¹„ìœ ë¥¼ ì¡´ëŒ“ë§ë¡œ ì „ë‹¬í•˜ê³ , ë§ˆì§€ë§‰ì— ëª…ì–¸ì„ í•œê¸€ê³¼ ì˜ì–´ë¡œ ì œì‹œí•©ë‹ˆë‹¤.",
                "4ëŒ€ ì„±ì¸ ëŒ€í™”(ì˜ˆìˆ˜ë‹˜, ë¶€ì²˜ë‹˜, ê³µìë‹˜, ì†Œí¬ë¼í…ŒìŠ¤ë‹˜)": "ë‹¹ì‹ ì€ 4ëŒ€ ì„±ì¸ì˜ ì‚¬ìƒì„ ì •í™•íˆ ì•„ëŠ” ì² í•™ ëŒ€í™” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ê° ì„±ì¸ì˜ ê³ ìœ í•œ ì² í•™ê³¼ ê°€ë¥´ì¹¨ì„ ë°˜ì˜í•œ 1ë¶„ 30ì´ˆ ë¶„ëŸ‰ì˜ ìƒìƒí•œ ëŒ€í™”ë¥¼ ì¡´ëŒ“ë§ë¡œ êµ¬ì„±í•˜ê³ , ì„œë¡œë¥¼ í˜¸ì¹­í•  ë•ŒëŠ” ë°˜ë“œì‹œ 'ì†Œí¬ë¼í…ŒìŠ¤ë‹˜', 'ê³µìë‹˜', 'ì˜ˆìˆ˜ë‹˜', 'ë¶€ì²˜ë‹˜'ì„ ì‚¬ìš©í•˜ë©°, ë§ˆì§€ë§‰ì— ëª…ì–¸ì„ í•œê¸€ê³¼ ì˜ì–´ë¡œ ì œì‹œí•©ë‹ˆë‹¤.",
                "ì¥ì ì´ì•¼ê¸°": "ë‹¹ì‹ ì€ ì¥ì ì² í•™ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë¬´ìœ„ìì—°ê³¼ ìƒëŒ€ì„±, ììœ ë¡œìš´ ì •ì‹ ì„ ë‹´ì€ 1ë¶„ 30ì´ˆ ë¶„ëŸ‰ì˜ ê¸°ë°œí•˜ê³  ì—­ì„¤ì ì¸ ëŒ€í™”ì²´ ìš°í™”ë¥¼ ì¡´ëŒ“ë§ë¡œ ì „ë‹¬í•˜ê³ , ë§ˆì§€ë§‰ì— ëª…ì–¸ì„ í•œê¸€ê³¼ ì˜ì–´ë¡œ ì œì‹œí•©ë‹ˆë‹¤.",
                "ë…¸ìì˜ ë„ë•ê²½": "ë‹¹ì‹ ì€ ë…¸ì ë„ë•ê²½ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë„(é“), ë¬´ìœ„(ç„¡çˆ²), ìŒì–‘ì˜ ì¡°í™”ì™€ ê²¸ì†í•¨ì„ ë‹´ì€ 1ë¶„ 30ì´ˆ ë¶„ëŸ‰ì˜ ê¹Šì´ ìˆëŠ” ëŒ€í™”ì²´ ì´ì•¼ê¸°ë¥¼ ì¡´ëŒ“ë§ë¡œ ì „ë‹¬í•˜ê³ , ë§ˆì§€ë§‰ì— ëª…ì–¸ì„ í•œê¸€ê³¼ ì˜ì–´ë¡œ ì œì‹œí•©ë‹ˆë‹¤.",
                "ì‚¼êµ­ì§€ì˜ ì œê°ˆëŸ‰": "ë‹¹ì‹ ì€ ì‚¼êµ­ì§€ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì œê°ˆëŸ‰ì˜ ì§€ëµê³¼ ì¶©ì˜, ì¸ì¬ê²½ì˜ì„ ë‹´ì€ 1ë¶„ 30ì´ˆ ë¶„ëŸ‰ì˜ ì‚¼êµ­ì§€ ë“±ì¥ì¸ë¬¼ë“¤ ê°„ì˜ ìƒìƒí•œ ëŒ€í™”ì²´ ì´ì•¼ê¸°ë¥¼ ì¡´ëŒ“ë§ë¡œ ì „ë‹¬í•˜ê³ , ë§ˆì§€ë§‰ì— ëª…ì–¸ì„ í•œê¸€ê³¼ ì˜ì–´ë¡œ ì œì‹œí•©ë‹ˆë‹¤.",
                "ì´ˆí•œì§€ì˜ ì¥ëŸ‰": "ë‹¹ì‹ ì€ ì´ˆí•œì§€ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì¥ëŸ‰ì˜ ëª¨ëµê³¼ ì§€ëµ, ì€ì¸ìì¤‘ì˜ ì§€í˜œë¥¼ ë‹´ì€ 1ë¶„ 30ì´ˆ ë¶„ëŸ‰ì˜ ì´ˆí•œì§€ ë“±ì¥ì¸ë¬¼ë“¤ ê°„ì˜ ìƒìƒí•œ ëŒ€í™”ì²´ ì´ì•¼ê¸°ë¥¼ ì¡´ëŒ“ë§ë¡œ ì „ë‹¬í•˜ê³ , ë§ˆì§€ë§‰ì— ëª…ì–¸ì„ í•œê¸€ê³¼ ì˜ì–´ë¡œ ì œì‹œí•©ë‹ˆë‹¤.",
                "ì£¼ì—­": "ë‹¹ì‹ ì€ ì£¼ì—­(æ˜“ç¶“) ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë°˜ë“œì‹œ ìš”ì•½ ë‚´ìš©ì„ ì² ì €íˆ ë¶„ì„í•˜ì—¬ ê·¸ ë‚´ìš©ê³¼ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” 64ê´˜ ì¤‘ í•˜ë‚˜ë¥¼ ì„ ì •í•´ì•¼ í•©ë‹ˆë‹¤. ì„ì˜ë¡œ ê´˜ë¥¼ ì„ íƒí•˜ì§€ ë§ˆì„¸ìš”. ì„ ì •í•œ ê´˜ì˜ ì² í•™ê³¼ ìŒì–‘ì˜ ì¡°í™”, ë³€í™”ì˜ ì´ì¹˜ë¥¼ ë‹´ì€ 1ë¶„ 30ì´ˆ ë¶„ëŸ‰ì˜ ê¹Šì´ ìˆëŠ” ëŒ€í™”ì²´ ì´ì•¼ê¸°ë¥¼ ì¡´ëŒ“ë§ë¡œ ì „ë‹¬í•˜ê³ , ê´˜ ì„ ì • ì´ìœ ì™€ í•¨ê»˜ ë§ˆì§€ë§‰ì— ì„ íƒí•œ ê´˜ì™€ ê´€ë ¨ëœ ëª…ì–¸ì„ í•œê¸€ê³¼ ì˜ì–´ë¡œ ì œì‹œí•©ë‹ˆë‹¤.",
                "ì œìë°±ê°€": "ë‹¹ì‹ ì€ ì œìë°±ê°€ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë°˜ë“œì‹œ ìš”ì•½ ë‚´ìš©ì„ ì² ì €íˆ ë¶„ì„í•˜ì—¬ ê·¸ ë‚´ìš©ì— ê°€ì¥ ì í•©í•œ ì œìë°±ê°€ ì² í•™ì(ê³µì, ë§¹ì, ìˆœì, ë…¸ì, ì¥ì, ë¬µì, í•œë¹„ì, ê´€ì ë“±)ë¥¼ ì„ ì •í•´ì•¼ í•©ë‹ˆë‹¤. ì„ì˜ë¡œ ì² í•™ìë¥¼ ì„ íƒí•˜ì§€ ë§ˆì„¸ìš”. ì„ ì •í•œ ì² í•™ìì˜ ì‚¬ìƒê³¼ ê°€ë¥´ì¹¨ì„ ë‹´ì€ 1ë¶„ 30ì´ˆ ë¶„ëŸ‰ì˜ ê¹Šì´ ìˆëŠ” ëŒ€í™”ì²´ ì´ì•¼ê¸°ë¥¼ ì¡´ëŒ“ë§ë¡œ ì „ë‹¬í•˜ê³ , ì² í•™ì ì„ ì • ì´ìœ ì™€ í•¨ê»˜ ë§ˆì§€ë§‰ì— ì„ íƒí•œ ì² í•™ìì™€ ê´€ë ¨ëœ ëª…ì–¸ì„ í•œê¸€ê³¼ ì˜ì–´ë¡œ ì œì‹œí•©ë‹ˆë‹¤."
            }
            
            system_prompt = system_prompts.get(fable_type, system_prompts["ì´ì†ìš°í™”"])
            
            # extra_promptê°€ ìˆì„ ë•ŒëŠ” ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ì— ì¶”ê°€ ì§€ì‹œ í¬í•¨
            if extra_prompt and extra_prompt.strip():
                system_prompt += " ì‚¬ìš©ìì˜ ì¶”ê°€ ìš”ì²­ì‚¬í•­ì´ ìˆì„ ê²½ìš° ê¸°ë³¸ ìŠ¤íƒ€ì¼ë³´ë‹¤ ì‚¬ìš©ì ìš”ì²­ì„ ìš°ì„ ì ìœ¼ë¡œ ë°˜ì˜í•˜ì—¬ ì°½ì‘í•´ ì£¼ì„¸ìš”."
            
            response = client.chat.completions.create(
                model=model_name,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": prompt}
                ],
                max_tokens=2500,
                temperature=0.7
            )
            return response.choices[0].message.content
        except Exception as e:
            st.error(f"OpenAI API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜: {str(e)}")
            st.error(f"API í‚¤ ìƒíƒœ: {openai_key[:10] if openai_key else 'None'}... (ê¸¸ì´: {len(openai_key) if openai_key else 0})")
            raise e

# ìš”ì•½ í•¨ìˆ˜ (Claude/OpenAI ëª¨ë‘ ì§€ì›)
def ai_summarize(text, model_name, extra_prompt=None):
    summary_instruction = (
        "ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ 600~900ì ë‚´ì™¸, bullet point 10~15ê°œë¡œ, ì£¼ì œë³„ë¡œ ì œëª©(êµµê²Œ)ì„ ë¶™ì—¬ í•µì‹¬ë§Œ ê°„ê²°í•˜ê²Œ ìš”ì•½í•´ ì£¼ì„¸ìš”. "
        "ê° í•­ëª©ì€ '~í•¨' í˜•íƒœì˜ ê°„ê²°í•œ í•œê¸€ë¡œ ì‘ì„±í•˜ê³ , ì¡´ëŒ“ë§ì€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”. "
        "ë¶ˆí•„ìš”í•œ ì„¤ëª…ì€ ìƒëµí•˜ê³ , ê¼­ í•„ìš”í•œ í•µì‹¬ë§Œ ìš”ì•½í•´ ì£¼ì„¸ìš”."
    )
    if model_name.startswith('claude'):
        client = ChatAnthropic(model=model_name, api_key=os.getenv('ANTHROPIC_API_KEY'), temperature=0.3, max_tokens=4000)
        prompt = f"""
{summary_instruction}
---
{text}
"""
        if extra_prompt and extra_prompt.strip():
            prompt += f"\n[ì°¸ê³  ë‚´ìš©]\n{extra_prompt.strip()}\n"
        response = client.invoke([
            {"role": "system", "content": "ë‹¹ì‹ ì€ ìš”ì•½ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. í•­ìƒ 600~900ì ë‚´ì™¸, 10~15ê°œ bullet pointë¡œ, ì£¼ì œë³„ ì œëª©ê³¼ í•¨ê»˜ '~í•¨' í˜•íƒœì˜ ê°„ê²°ì²´ë¡œ ì‘ì„±í•©ë‹ˆë‹¤. ì¡´ëŒ“ë§ì€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¶ˆí•„ìš”í•œ ì„¤ëª… ì—†ì´ ê¼­ í•„ìš”í•œ í•µì‹¬ë§Œ ìš”ì•½í•©ë‹ˆë‹¤."},
            {"role": "user", "content": prompt}
        ])
        return response.content if hasattr(response, 'content') else str(response)
    else:
        # OpenAI API í‚¤ ê²€ì¦
        openai_key = os.getenv('OPENAI_API_KEY')
        if not openai_key or openai_key.strip() == '' or openai_key == 'NA':
            raise ValueError(f"OpenAI API í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. í˜„ì¬ ê°’: {openai_key}")
        
        try:
            client = OpenAI(api_key=openai_key)
            prompt = f"""
{summary_instruction}
---
{text}
"""
            if extra_prompt and extra_prompt.strip():
                prompt += f"\n[ì°¸ê³  ë‚´ìš©]\n{extra_prompt.strip()}\n"
            response = client.chat.completions.create(
                model=model_name,
                messages=[
                    {"role": "system", "content": "ë‹¹ì‹ ì€ ìš”ì•½ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. í•­ìƒ 600~900ì ë‚´ì™¸, 10~15ê°œ bullet pointë¡œ, ì£¼ì œë³„ ì œëª©ê³¼ í•¨ê»˜ '~í•¨' í˜•íƒœì˜ ê°„ê²°ì²´ë¡œ ì‘ì„±í•©ë‹ˆë‹¤. ì¡´ëŒ“ë§ì€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¶ˆí•„ìš”í•œ ì„¤ëª… ì—†ì´ ê¼­ í•„ìš”í•œ í•µì‹¬ë§Œ ìš”ì•½í•©ë‹ˆë‹¤."},
                    {"role": "user", "content": prompt}
                ],
                max_tokens=4000,
                temperature=0.3
            )
            return response.choices[0].message.content
        except Exception as e:
            st.error(f"OpenAI API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜: {str(e)}")
            st.error(f"API í‚¤ ìƒíƒœ: {openai_key[:10] if openai_key else 'None'}... (ê¸¸ì´: {len(openai_key) if openai_key else 0})")
            raise e

# ì ìš© íŒŒì¼ ìƒì„± í•¨ìˆ˜ (Claude/OpenAI ëª¨ë‘ ì§€ì›)
def ai_generate_application(summary_text, application_text, model_name, extra_prompt=None):
    if model_name.startswith('claude'):
        client = ChatAnthropic(model=model_name, api_key=os.getenv('ANTHROPIC_API_KEY'), temperature=0.3, max_tokens=8192)
        prompt = f"""
ì•„ë˜ì˜ 'ìš”ì•½ ë‚´ìš©'ê³¼ 'ê¸°ì¡´ ì ìš© íŒŒì¼'ì„ ì°¸ê³ í•˜ì—¬, ê¸°ì¡´ ì ìš© íŒŒì¼ì„ ê°œì„ /ë³´ì™„í•œ ìƒˆë¡œìš´ ì ìš© íŒŒì¼ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”.\n\n[ì ˆëŒ€ì  ìš”êµ¬ì‚¬í•­]\n- ê¸°ì¡´ ì ìš© íŒŒì¼ì˜ ëŒ€ë¶€ë¶„ì˜ í•µì‹¬ ë‚´ìš©ì´ ë¹ ì§ì—†ì´ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ì¤‘ìš”í•œ ë‚´ìš©ì´ ëˆ„ë½ë˜ì§€ ì•Šë„ë¡ í•˜ì„¸ìš”.\n- ê¸°ì¡´ ì ìš© íŒŒì¼ì˜ ëª¨ë“  ì„¹ì…˜, ì†Œì œëª©, êµ¬ì¡°ë¥¼ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ì„¸ìš”.\n- ìš”ì•½ ë‚´ìš©ì˜ í•µì‹¬ ì¸ì‚¬ì´íŠ¸ì™€ ì§€ì¹¨ì„ ë°˜ë“œì‹œ ë°˜ì˜í•´ ì£¼ì„¸ìš”.\n- ê¸°ì¡´ ì ìš© íŒŒì¼ì˜ êµ¬ì¡°ì™€ ë§¥ë½ì„ ìµœëŒ€í•œ ìœ ì§€í•˜ë˜, ì¤‘ë³µì€ í”¼í•˜ê³  ìì—°ìŠ¤ëŸ½ê²Œ í†µí•©í•´ ì£¼ì„¸ìš”.\n- ë°˜ë“œì‹œ ì¡´ëŒ“ë§ì„ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.\n\n[ìš”ì•½ ë‚´ìš©]\n{summary_text}\n\n[ê¸°ì¡´ ì ìš© íŒŒì¼]\n{application_text}\n"""
        if extra_prompt and extra_prompt.strip():
            prompt += f"\n[ì°¸ê³  ë‚´ìš©]\n{extra_prompt.strip()}\n"
        response = client.invoke([
            {"role": "system", "content": "ë‹¹ì‹ ì€ ì ìš© íŒŒì¼ í†µí•© ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë°˜ë“œì‹œ ê¸°ì¡´ ì ìš© íŒŒì¼ì˜ ëŒ€ë¶€ë¶„ì˜ í•µì‹¬ ë‚´ìš©ì´ ë¹ ì§ì—†ì´ í¬í•¨ë˜ê³ , êµ¬ì¡°ì™€ ë§¥ë½ì„ ìœ ì§€í•˜ë©°, ì¡´ëŒ“ë§ë¡œ ì‘ì„±í•©ë‹ˆë‹¤. ì¤‘ìš”í•œ ë‚´ìš© ëˆ„ë½ ê¸ˆì§€."},
            {"role": "user", "content": prompt}
        ])
        return response.content if hasattr(response, 'content') else str(response)
    else:
        # OpenAI API í‚¤ ê²€ì¦
        openai_key = os.getenv('OPENAI_API_KEY')
        if not openai_key or openai_key.strip() == '' or openai_key == 'NA':
            raise ValueError(f"OpenAI API í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. í˜„ì¬ ê°’: {openai_key}")
        
        try:
            client = OpenAI(api_key=openai_key)
            prompt = f"""
ì•„ë˜ì˜ 'ìš”ì•½ ë‚´ìš©'ê³¼ 'ê¸°ì¡´ ì ìš© íŒŒì¼'ì„ ì°¸ê³ í•˜ì—¬, ê¸°ì¡´ ì ìš© íŒŒì¼ì„ ê°œì„ /ë³´ì™„í•œ ìƒˆë¡œìš´ ì ìš© íŒŒì¼ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”.\n\n[ì ˆëŒ€ì  ìš”êµ¬ì‚¬í•­]\n- ê¸°ì¡´ ì ìš© íŒŒì¼ì˜ ëŒ€ë¶€ë¶„ì˜ í•µì‹¬ ë‚´ìš©ì´ ë¹ ì§ì—†ì´ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ì¤‘ìš”í•œ ë‚´ìš©ì´ ëˆ„ë½ë˜ì§€ ì•Šë„ë¡ í•˜ì„¸ìš”.\n- ê¸°ì¡´ ì ìš© íŒŒì¼ì˜ ëª¨ë“  ì„¹ì…˜, ì†Œì œëª©, êµ¬ì¡°ë¥¼ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ì„¸ìš”.\n- ìš”ì•½ ë‚´ìš©ì˜ í•µì‹¬ ì¸ì‚¬ì´íŠ¸ì™€ ì§€ì¹¨ì„ ë°˜ë“œì‹œ ë°˜ì˜í•´ ì£¼ì„¸ìš”.\n- ê¸°ì¡´ ì ìš© íŒŒì¼ì˜ êµ¬ì¡°ì™€ ë§¥ë½ì„ ìµœëŒ€í•œ ìœ ì§€í•˜ë˜, ì¤‘ë³µì€ í”¼í•˜ê³  ìì—°ìŠ¤ëŸ½ê²Œ í†µí•©í•´ ì£¼ì„¸ìš”.\n- ë°˜ë“œì‹œ ì¡´ëŒ“ë§ì„ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.\n\n[ìš”ì•½ ë‚´ìš©]\n{summary_text}\n\n[ê¸°ì¡´ ì ìš© íŒŒì¼]\n{application_text}\n"""
            if extra_prompt and extra_prompt.strip():
                prompt += f"\n[ì°¸ê³  ë‚´ìš©]\n{extra_prompt.strip()}\n"
            response = client.chat.completions.create(
                model=model_name,
                messages=[
                    {"role": "system", "content": "ë‹¹ì‹ ì€ ì ìš© íŒŒì¼ í†µí•© ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë°˜ë“œì‹œ ê¸°ì¡´ ì ìš© íŒŒì¼ì˜ ëŒ€ë¶€ë¶„ì˜ í•µì‹¬ ë‚´ìš©ì´ ë¹ ì§ì—†ì´ í¬í•¨ë˜ê³ , êµ¬ì¡°ì™€ ë§¥ë½ì„ ìœ ì§€í•˜ë©°, ì¡´ëŒ“ë§ë¡œ ì‘ì„±í•©ë‹ˆë‹¤. ì¤‘ìš”í•œ ë‚´ìš© ëˆ„ë½ ê¸ˆì§€."},
                    {"role": "user", "content": prompt}
                ],
                max_tokens=8192,
                temperature=0.3
            )
            return response.choices[0].message.content
        except Exception as e:
            st.error(f"OpenAI API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜: {str(e)}")
            st.error(f"API í‚¤ ìƒíƒœ: {openai_key[:10] if openai_key else 'None'}... (ê¸¸ì´: {len(openai_key) if openai_key else 0})")
            raise e

def summarize_for_tts(text, max_length=3500):
    if len(text) <= max_length:
        return text
    lines = text.split('\n')
    summary = []
    current_length = 0
    for line in lines:
        if line.startswith('#') or line.startswith('##'):
            if current_length + len(line) + 2 <= max_length:
                summary.append(line)
                current_length += len(line) + 2
        elif '[í•µì‹¬ ìš”ì•½]' in line or '[ì£¼ìš” ë¶„ì„]' in line or '[ì‹¤í–‰ ì œì•ˆ]' in line:
            if current_length + len(line) + 2 <= max_length:
                summary.append(line)
                current_length += len(line) + 2
    return '\n'.join(summary)

def text_to_speech(text):
    try:
        # OpenAI API í‚¤ ê²€ì¦
        openai_key = os.getenv('OPENAI_API_KEY')
        if not openai_key or openai_key.strip() == '' or openai_key == 'NA':
            st.error(f"OpenAI API í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. í˜„ì¬ ê°’: {openai_key}")
            return None
            
        client = OpenAI(api_key=openai_key)
        response = client.audio.speech.create(
            model="tts-1",
            voice="alloy",
            input=text
        )
        audio_data = response.content
        audio_base64 = base64.b64encode(audio_data).decode('utf-8')
        audio_html = f'''
            <audio controls>
                <source src="data:audio/mp3;base64,{audio_base64}" type="audio/mp3">
                Your browser does not support the audio element.
            </audio>
        '''
        return audio_html
    except Exception as e:
        st.error(f"ìŒì„± ë³€í™˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
        if 'openai_key' in locals():
            st.error(f"API í‚¤ ìƒíƒœ: {openai_key[:10] if openai_key else 'None'}... (ê¸¸ì´: {len(openai_key) if openai_key else 0})")
        return None

def text_to_speech_fable(text, fable_type):
    """ìš°í™”ìš© ë‹¤ì¤‘ í™”ì ìŒì„± ìƒì„± í•¨ìˆ˜"""
    try:
        # OpenAI API í‚¤ ê²€ì¦
        openai_key = os.getenv('OPENAI_API_KEY')
        if not openai_key or openai_key.strip() == '' or openai_key == 'NA':
            st.error(f"OpenAI API í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. í˜„ì¬ ê°’: {openai_key}")
            return None
            
        client = OpenAI(api_key=openai_key)
        
        # ìš°í™” ìŠ¤íƒ€ì¼ë³„ voice ë° ì†ë„ ì„¤ì •
        voice_settings = {
            "ì´ì†ìš°í™”": {"voice": "nova", "speed": 1.0},  # í™œë°œí•œ ë™ë¬¼ ìºë¦­í„°
            "íƒˆë¬´ë“œ": {"voice": "echo", "speed": 0.9},   # ì§€í˜œë¡œìš´ ëë¹„
            "ì„±ê²½ì´ì•¼ê¸°": {"voice": "shimmer", "speed": 0.9},  # ë”°ëœ»í•œ ì„±ê²½ ì´ì•¼ê¸°
            "4ëŒ€ ì„±ì¸ ëŒ€í™”(ì˜ˆìˆ˜ë‹˜, ë¶€ì²˜ë‹˜, ê³µìë‹˜, ì†Œí¬ë¼í…ŒìŠ¤ë‹˜)": {"voice": "onyx", "speed": 0.8},  # ê±°ë£©í•˜ê³  ê¹Šì´ ìˆëŠ” ëª©ì†Œë¦¬
            "ì¥ì ì´ì•¼ê¸°": {"voice": "alloy", "speed": 0.9},  # ì‹ ë¹„ë¡œìš´ ì² í•™ì
            "ë…¸ìì˜ ë„ë•ê²½": {"voice": "onyx", "speed": 0.8},  # ê¹Šì´ ìˆê³  ê±°ë£©í•œ ëª©ì†Œë¦¬
            "ì‚¼êµ­ì§€ì˜ ì œê°ˆëŸ‰": {"voice": "echo", "speed": 0.9},  # ì§€ëµê°€ì˜ ì°¨ë¶„í•œ ëª©ì†Œë¦¬
            "ì´ˆí•œì§€ì˜ ì¥ëŸ‰": {"voice": "alloy", "speed": 0.9},  # ëª¨ëµê°€ì˜ ì‹ ì¤‘í•œ ëª©ì†Œë¦¬
            "ì£¼ì—­": {"voice": "onyx", "speed": 0.8},  # ê¹Šì´ ìˆê³  ì‹ ë¹„ë¡œìš´ ì£¼ì—­ í˜„ìì˜ ëª©ì†Œë¦¬
            "ì œìë°±ê°€": {"voice": "echo", "speed": 0.9}  # ì² í•™ìë“¤ì˜ ê¹Šì´ ìˆê³  ì§€í˜œë¡œìš´ ëª©ì†Œë¦¬
        }
        
        # ê¸°ë³¸ê°’ ì„¤ì •
        setting = voice_settings.get(fable_type, {"voice": "alloy", "speed": 1.0})
        
        response = client.audio.speech.create(
            model="tts-1",
            voice=setting["voice"],
            input=text,
            speed=setting["speed"]
        )
        audio_data = response.content
        audio_base64 = base64.b64encode(audio_data).decode('utf-8')
        audio_html = f'''
            <audio controls>
                <source src="data:audio/mp3;base64,{audio_base64}" type="audio/mp3">
                Your browser does not support the audio element.
            </audio>
        '''
        return audio_html
    except Exception as e:
        st.error(f"ìš°í™” ìŒì„± ë³€í™˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
        if 'openai_key' in locals():
            st.error(f"API í‚¤ ìƒíƒœ: {openai_key[:10] if openai_key else 'None'}... (ê¸¸ì´: {len(openai_key) if openai_key else 0})")
        return None

# --- JS ë™ì  íš¨ê³¼ í•¨ìˆ˜ ì¶”ê°€ (ìŠ¤ì½”í”„ ì ìš©) ---
def get_alarm_js_scoped():
    return """
    <script>
    let audioContext = null;
    let isAudioInitialized = false;
    async function initAudioContext() {
        if (!isAudioInitialized) {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                await audioContext.resume();
                isAudioInitialized = true;
            } catch (e) { console.error('ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨:', e); }
        }
    }
    async function playBeep() {
        await initAudioContext();
        if (!audioContext) return;
        try {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        } catch (e) { console.error('ë¹„í”„ìŒ ì¬ìƒ ì‹¤íŒ¨:', e); }
    }
    window.playBeep = playBeep;
    </script>
    """
def get_toast_notification_js_scoped():
    return """
    <style>
    .order-tab-root .toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #ff4b4b; color: white; text-align: center; border-radius: 10px; padding: 16px; position: fixed; z-index: 1000; left: 50%; bottom: 30px; font-size: 18px; font-weight: bold; box-shadow: 0px 0px 10px rgba(0,0,0,0.5); transition: visibility 0.5s, opacity 0.5s; opacity: 0; }
    .order-tab-root .toast.show { visibility: visible; opacity: 1; }
    </style>
    <div class="toast"></div>
    <script>
    function showToast(message) {
        const toast = document.querySelector('.order-tab-root .toast');
        if (!toast) return;
        toast.textContent = message;
        toast.className = "toast show";
        setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
    }
    window.showToast = showToast;
    </script>
    """

def get_obsidian_notification_js_scoped():
    return '''
    <div class="obsidian-alert" style="display: none;">
        <div class="alert-content">
            <div class="large-emoji">ğŸ™ï¸</div>
            <div class="alert-text">ì˜µì‹œë””ì–¸ ë…¹ìŒê¸°ëŠ¥ì„ í™œì„±í™”í•´ ì£¼ì„¸ìš”!</div>
        </div>
    </div>
    <script>
    function showObsidianNotification() {
        const alert = document.querySelector('.order-tab-root .obsidian-alert');
        if (!alert) return;
        alert.style.display = 'flex';
        setTimeout(() => { alert.style.display = 'none'; }, 3000);
    }
    window.showObsidianNotification = showObsidianNotification;
    </script>
    <style>
    .order-tab-root .obsidian-alert {
        position: fixed;
        top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(0, 102, 204, 0.95);
        display: none; justify-content: center; align-items: center;
        z-index: 9999; animation: pulse 2s;
    }
    .order-tab-root .obsidian-alert .alert-content {
        background: white; padding: 2rem; border-radius: 20px; text-align: center;
        box-shadow: 0 0 30px rgba(0,0,0,0.3); animation: bounce 1s;
    }
    .order-tab-root .obsidian-alert .large-emoji { font-size: 5rem; margin-bottom: 1rem; }
    .order-tab-root .obsidian-alert .alert-text { font-size: 2rem; font-weight: bold; color: #0066cc; margin: 1rem 0; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
    </style>
    '''

def discussion_order_tab():
    # ìºë¦­í„°/ìƒìˆ˜ (í•¨ìˆ˜ ìµœìƒë‹¨ì— ìœ„ì¹˜)
    CHARACTERS = {"í˜„ì² ë‹˜": "ğŸ§™â€â™‚ï¸ ì§€í˜œì˜ í˜„ì", "ì°½í™˜ë‹˜": "ğŸš€ ë¯¸ë˜ì˜ ì„ êµ¬ì", "ì„±ë²”ë‹˜": "ğŸ¯ í†µì°°ì˜ ëŒ€ê°€", "ìƒí˜„ë‹˜": "ğŸ­ ì§ˆë¬¸ì˜ ì˜ˆìˆ ê°€", "ì„±ì¼ë‹˜": "ğŸ’¡ í˜ì‹ ì˜ ì•„ì´ì½˜", "ê²½í˜¸ë‹˜": "ğŸ¦¾ ì „ëµì˜ ë§ˆì—ìŠ¤íŠ¸ë¡œ", "ì¬ì›ë‹˜": "âš¡ï¸ ê¸°ìˆ ì˜ì—…ì˜ ë‹¬ì¸"}
    VALUES = [
        "Success is not the key to happiness. Happiness is the key to success.\nì„±ê³µì´ í–‰ë³µì˜ ì—´ì‡ ê°€ ì•„ë‹ˆë¼, í–‰ë³µì´ ì„±ê³µì˜ ì—´ì‡ ë‹¤.",
        "I find that the harder I work, the more luck I seem to have. â€“ Thomas Jefferson\nì—´ì‹¬íˆ ì¼ í• ìˆ˜ë¡ ìš´ì´ ë” ì¢‹ì•„ì§€ëŠ” ê²ƒ ê°™ë‹¤. â€“ í† ë¨¸ìŠ¤ ì œí¼ìŠ¨",
        # ... (í•„ìš”ì‹œ ì¶”ê°€)
    ]
    
    # ë‹¤ë¥¸ íƒ­ì˜ ë³´í˜¸ëœ ìƒíƒœë“¤ì„ ì ˆëŒ€ ê±´ë“œë¦¬ì§€ ì•Šë„ë¡ ë³´í˜¸
    protected_keys = ['ai_summary_result', 'tts_audio', 'ai_app_summary_result', 'tts_app_audio', 
                     'ai_fable_result', 'tts_fable_audio',
                     'ai_summary_result_backup', 'tts_audio_backup', 'ai_app_summary_result_backup', 'tts_app_audio_backup',
                     'ai_fable_result_backup', 'tts_fable_audio_backup']
    
    # ìˆœì„œ/íƒ€ì´ë¨¸ ê´€ë ¨ ìƒíƒœë§Œ ì´ˆê¸°í™” (ë‹¤ë¥¸ ìƒíƒœëŠ” ë³´í˜¸)
    timer_only_states = {
        'order_generated': False,
        'final_order': [],
        'order_timer_started': False,
        'order_start_time': None,
        'order_duration': timedelta(minutes=15),
        'order_timer_finished': False,
        'order_alarm_enabled': True,
        'order_toast_enabled': True
    }
    
    # íƒ€ì´ë¨¸ ê´€ë ¨ ìƒíƒœë§Œ ì•ˆì „í•˜ê²Œ ì´ˆê¸°í™” (ë³´í˜¸ëœ ìƒíƒœëŠ” ì ˆëŒ€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
    for key, default_value in timer_only_states.items():
        if key not in st.session_state:
            st.session_state[key] = default_value
    
    # ìŠ¤íƒ€ì¼ ë° JS (ìµœì´ˆ 1íšŒë§Œ)
    if 'order_js_loaded' not in st.session_state:
        st.markdown("""
        <style>
        .order-tab-root .character-card { background-color: #f8f9fa; padding: 1rem; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 1rem; }
        .order-tab-root .character-name { color: #0066cc; font-weight: bold; }
        .order-tab-root .timer-display { color: #1f1f1f; font-size: 4rem; font-weight: bold; text-align: center; }
        .order-tab-root .timer-status { font-size: 1.2rem; text-align: center; }
        .order-tab-root .intense-warning { background: linear-gradient(145deg, #ff4b4b, #ff6b6b); color: white; padding: 20px; border-radius: 15px; text-align: center; font-size: 28px; font-weight: bold; margin: 20px 0; animation: blink-intense 0.7s infinite; box-shadow: 0 4px 15px rgba(255, 75, 75, 0.5); }
        .order-tab-root .fullscreen-alert { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(255, 75, 75, 0.95); display: flex; justify-content: center; align-items: center; z-index: 9999; animation: pulse 2s infinite; }
        .order-tab-root .alert-content { background: white; padding: 2rem; border-radius: 20px; text-align: center; box-shadow: 0 0 30px rgba(0,0,0,0.3); animation: bounce 1s infinite; }
        .order-tab-root .large-emoji { font-size: 5rem; margin-bottom: 1rem; }
        .order-tab-root .alert-text { font-size: 2rem; font-weight: bold; color: #ff4b4b; margin: 1rem 0; }
        .order-tab-root .alert-subtext { font-size: 1.2rem; color: #666; }
        @keyframes blink-intense { 0% { transform: scale(1); background: linear-gradient(145deg, #ff4b4b, #ff6b6b); } 50% { transform: scale(1.05); background: linear-gradient(145deg, #ff6b6b, #ff8b8b); } 100% { transform: scale(1); background: linear-gradient(145deg, #ff4b4b, #ff6b6b); } }
        @keyframes pulse { 0% { background: rgba(255, 75, 75, 0.95); } 50% { background: rgba(255, 75, 75, 0.7); } 100% { background: rgba(255, 75, 75, 0.95); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        </style>
        """, unsafe_allow_html=True)
        st.markdown(get_alarm_js_scoped(), unsafe_allow_html=True)
        st.markdown(get_toast_notification_js_scoped(), unsafe_allow_html=True)
        st.session_state.order_js_loaded = True
    st.markdown("<div class='order-tab-root'>", unsafe_allow_html=True)
    # ì˜µì‹œë””ì–¸ ë…¹ìŒê¸°ëŠ¥ ì•Œë¦¼ (í•œ ë²ˆë§Œ, ì •ì )
    if 'order_initial_notice_shown' not in st.session_state:
        st.markdown('''
        <div class="notice-container" style="background: linear-gradient(145deg, #0066cc, #0052a3); color: white; padding: 20px; border-radius: 15px; text-align: center; margin: 20px auto; max-width: 600px; animation: slideIn 0.5s ease-out;">
            <div class="notice-icon" style="font-size: 48px; margin-bottom: 10px; display: inline-block;">ğŸ™ï¸</div>
            <div class="notice-text" style="font-size: 24px; font-weight: bold; margin: 10px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">ì˜µì‹œë””ì–¸ ë…¹ìŒê¸°ëŠ¥ì„ í™œì„±í™”í•´ ì£¼ì„¸ìš”!</div>
            <div class="notice-subtext">
                <div class="highlight" style="background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 5px; display: inline-block; margin: 5px 0;">í† ë¡  ë‚´ìš© ê¸°ë¡ì„ ìœ„í•´ ê¼­ í•„ìš”í•©ë‹ˆë‹¤</div>
                <div class="highlight" style="background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 5px; display: inline-block; margin: 5px 0;">ì‹œì‘ ì „ ë°˜ë“œì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”</div>
            </div>
        </div>
        ''', unsafe_allow_html=True)
        st.session_state.order_initial_notice_shown = True
    # í—¤ë”© ìƒ‰ìƒ í°ìƒ‰ìœ¼ë¡œ ë³€ê²½
    st.markdown('<h1 style="color: #fff;">ğŸ¯ ë…ì„œí† ë¡  ìˆœì„œ ì •í•˜ê¸°</h1>', unsafe_allow_html=True)
    st.markdown('<h3 style="color: #fff;">ğŸ² ì˜¤ëŠ˜ì˜ í† ë¡  ë©¤ë²„ë¥¼ í™•ì¸í•˜ì„¸ìš”!</h3>', unsafe_allow_html=True)
    cols = st.columns(len(CHARACTERS))
    for i, (person, character) in enumerate(CHARACTERS.items()):
        with cols[i]:
            st.markdown(f"<div class='character-card'><h3>{character}</h3><p class='character-name'>{person}</p></div>", unsafe_allow_html=True)
    st.markdown("---")
    if not st.session_state.order_generated:
        if st.button("ğŸ¯ ë°œí‘œ ìˆœì„œ ì •í•˜ê¸°!", key="order_btn", use_container_width=True):
            with st.spinner("ìˆœì„œë¥¼ ì •í•˜ëŠ” ì¤‘..."):
                # ë£°ë › ì• ë‹ˆë©”ì´ì…˜ (ë™ì )
                placeholder = st.empty()
                participants = list(CHARACTERS.keys())
                for _ in range(30):
                    random.shuffle(participants)
                    display_text = "\n".join([f"<div style='font-size:28px; font-weight:bold; color:#0066cc;'>{CHARACTERS[p]} <span style='color:#fff;'>{p}</span></div>" for p in participants])
                    placeholder.markdown(f"<div class='order-tab-root'>{display_text}</div>", unsafe_allow_html=True)
                    time.sleep(0.08)
                other_participants = [p for p in participants if p != "í˜„ì² ë‹˜"]
                random.shuffle(other_participants)
                st.session_state.final_order = other_participants + ["í˜„ì² ë‹˜"]
                st.session_state.order_generated = True
                st.balloons()
    if st.session_state.order_generated:
        col1, col2 = st.columns([1, 1], gap="large")
        with col1:
            st.markdown('<h2 style="color: #fff; font-size: 24px; margin-bottom: 20px;">ğŸ‰ ë°œí‘œ ìˆœì„œ</h2>', unsafe_allow_html=True)
            for i, person in enumerate(st.session_state.final_order, 1):
                st.markdown(f"<div style='background: linear-gradient(145deg, #ffffff, #f0f0f0); padding: 10px; border-radius: 8px; margin: 5px 0; box-shadow: 3px 3px 6px #d9d9d9, -3px -3px 6px #ffffff;'><div style='color: #0066cc; margin: 0; font-size: 16px; display: flex; align-items: center;'><span style='font-weight: bold; min-width: 24px;'>{i}.</span><span style='margin-left: 8px;'>{person}</span><span style='margin-left: 8px; opacity: 0.8;'>{CHARACTERS[person]}</span></div></div>", unsafe_allow_html=True)
        with col2:
            st.markdown('<h2 style="color: #fff; font-size: 24px; margin-bottom: 20px;">â±ï¸ í† ë¡  íƒ€ì´ë¨¸</h2>', unsafe_allow_html=True)
            
            # íƒ€ì´ë¨¸ ì‹œê°„ ì„¤ì • ìŠ¬ë¼ì´ë” (1~30ë¶„, ê¸°ë³¸ 15ë¶„)
            timer_duration = st.slider("â° ì‹œê°„ (ë¶„)", min_value=1, max_value=30, value=int(st.session_state.order_duration.total_seconds() // 60), key="order_timer_duration")
            st.session_state.order_duration = timedelta(minutes=timer_duration)

            if not st.session_state.order_timer_started:
                if st.button("â±ï¸ í† ë¡  ì‹œì‘í•˜ê¸°", use_container_width=True):
                    # ë‹¤ë¥¸ íƒ­ì˜ ì„¸ì…˜ ìƒíƒœ ë³´í˜¸ë¥¼ ìœ„í•œ ë°±ì—…
                    for key in protected_keys:
                        if key in st.session_state and st.session_state[key] is not None:
                            st.session_state[f"{key}_protected"] = st.session_state[key]
                    
                    # íƒ€ì´ë¨¸ë§Œ ì‹œì‘
                    st.session_state.order_timer_started = True
                    st.session_state.order_start_time = datetime.now().timestamp()
                    st.session_state.order_timer_finished = False
            else:
                if st.button("ğŸ”„ íƒ€ì´ë¨¸ ë¦¬ì…‹", use_container_width=True):
                    # ë‹¤ë¥¸ íƒ­ì˜ ì„¸ì…˜ ìƒíƒœ ë³´í˜¸ë¥¼ ìœ„í•œ ë°±ì—… ë³µì›
                    for key in protected_keys:
                        protected_key = f"{key}_protected"
                        if protected_key in st.session_state:
                            st.session_state[key] = st.session_state[protected_key]
                    
                    # íƒ€ì´ë¨¸ ê´€ë ¨ ìƒíƒœë§Œ ë¦¬ì…‹ (ë³´í˜¸ëœ ìƒíƒœëŠ” ì ˆëŒ€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
                    st.session_state.order_timer_started = False
                    st.session_state.order_start_time = None
                    st.session_state.order_timer_finished = False
                    
                # JS ê¸°ë°˜ ì‹¤ì‹œê°„ íƒ€ì´ë¨¸ í‘œì‹œ
                start_time = st.session_state.order_start_time
                duration = int(st.session_state.order_duration.total_seconds())  # ì´ˆ ë‹¨ìœ„
                audio_base64 = st.session_state.get('order_end_audio', '')
                # íƒ€ì´ë¨¸+ìŒì„± HTML ì‚½ì… (ì¢…ë£Œ ì‹œ srcë¥¼ ë™ì ìœ¼ë¡œ í• ë‹¹í•˜ê³  play)
                components.html(f'''
                <div id='timer' style='font-size:2rem; text-align:center; color:#fff; background:#222; border-radius:10px; padding:10px 0; margin:10px 0;'></div>
                <audio id='endAudio' style='display:none;'></audio>
                <script>
                const start = {start_time} * 1000;
                const duration = {duration} * 1000;
                const audioBase64 = "{audio_base64}";
                function updateTimer() {{
                    const now = Date.now();
                    const elapsed = now - start;
                    const remaining = Math.max(0, duration - elapsed);
                    const sec = Math.floor(remaining / 1000);
                    const min = Math.floor(sec / 60);
                    const secDisplay = String(sec % 60).padStart(2, '0');
                    const minDisplay = String(min).padStart(2, '0');
                    document.getElementById('timer').innerText = 'ë‚¨ì€ ì‹œê°„: ' + minDisplay + ':' + secDisplay;
                    if (remaining > 0) {{
                        setTimeout(updateTimer, 1000);
                    }} else {{
                        document.getElementById('timer').innerText = 'íƒ€ì´ë¨¸ ì¢…ë£Œ!';
                        // ì¢…ë£Œ ìŒì„± ìë™ ì¬ìƒ (srcë¥¼ ë™ì ìœ¼ë¡œ í• ë‹¹)
                        const audio = document.getElementById('endAudio');
                        if (audio && audioBase64) {{
                            audio.src = 'data:audio/mp3;base64,' + audioBase64;
                            audio.currentTime = 0;
                            audio.play();
                        }}
                    }}
                }}
                updateTimer();
                </script>
                ''', height=80)
    st.markdown("---")
    if st.button("ğŸ”„ ë‹¤ì‹œ ì •í•˜ê¸°", key="order_reset", use_container_width=True):
        # ë‹¤ë¥¸ íƒ­ì˜ ì„¸ì…˜ ìƒíƒœ ë³´í˜¸ë¥¼ ìœ„í•œ ë°±ì—… ë³µì› (ìš°í™” í¬í•¨)
        for key in protected_keys:
            protected_key = f"{key}_protected"
            if protected_key in st.session_state:
                st.session_state[key] = st.session_state[protected_key]
        
        # íƒ€ì´ë¨¸ ê´€ë ¨ ì„¸ì…˜ ìƒíƒœë§Œ ì´ˆê¸°í™” (ë³´í˜¸ëœ ìƒíƒœëŠ” ì ˆëŒ€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
        st.session_state.order_generated = False
        st.session_state.order_timer_started = False
        st.session_state.order_start_time = None
        st.session_state.order_timer_finished = False
        st.session_state.final_order = []
    st.markdown("</div>", unsafe_allow_html=True)

def main():
    # ë…ì„œí† ë¡  ê²€ìƒ‰/ì¡°íšŒ íƒ­ì˜ ì„¸ì…˜ ìƒíƒœë¥¼ ì˜êµ¬ì ìœ¼ë¡œ ë³´í˜¸ - ë” ê°•í™”ëœ ë³´í˜¸
    protected_states = {
        'ai_summary_result': None,
        'tts_audio': None,
        'ai_app_summary_result': None,
        'tts_app_audio': None,
        'ai_fable_result': None,
        'tts_fable_audio': None
    }
    
    # ë³´í˜¸ëœ ìƒíƒœë“¤ì„ ì•ˆì „í•˜ê²Œ ì´ˆê¸°í™” (ê¸°ì¡´ ê°’ì´ ìˆìœ¼ë©´ ìœ ì§€)
    for key, default_value in protected_states.items():
        if key not in st.session_state:
            st.session_state[key] = default_value
        # ì¶”ê°€ ë³´í˜¸: Noneì´ ì•„ë‹Œ ê°’ì´ ìˆë‹¤ë©´ ë°±ì—…
        if st.session_state[key] is not None:
            st.session_state[f"{key}_backup"] = st.session_state[key]
    
    # íƒ€ì´ë¨¸ ê´€ë ¨ ìƒíƒœë“¤ë„ ì•ˆì „í•˜ê²Œ ì´ˆê¸°í™”
    timer_states = {
        'order_generated': False,
        'final_order': [],
        'order_timer_started': False,
        'order_start_time': None,
        'order_duration': timedelta(minutes=15),
        'order_timer_finished': False,
        'order_alarm_enabled': True,
        'order_toast_enabled': True
    }
    
    for key, default_value in timer_states.items():
        if key not in st.session_state:
            st.session_state[key] = default_value
   
    tab1, tab2, tab3, tab_order = st.tabs(["ìš”ì•½/ì ìš© íŒŒì¼ ë“±ë¡", "ì ìš© íŒŒì¼ ìƒì„±", "ë…ì„œí† ë¡  ê²€ìƒ‰/ì¡°íšŒ", "ë°œí‘œ ìˆœì„œ/íƒ€ì´ë¨¸"])
    
    with tab1:
        st.header("ìš”ì•½/ì ìš© íŒŒì¼ ë“±ë¡")
        col1, col2 = st.columns(2)
        with col1:
            st.subheader("íŒŒì¼ ì—…ë¡œë“œ")
            uploaded_file = st.file_uploader("ìš”ì•½/ì ìš© íŒŒì¼ ì—…ë¡œë“œ (txt, md)", type=["txt", "md"])
        with col2:
            st.subheader("í…ìŠ¤íŠ¸ ì§ì ‘ ì…ë ¥")
            text_input = st.text_area("í…ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í•´ ë„£ìœ¼ì„¸ìš”", height=200)
        # ì±… ì œëª© ì„ íƒ (selectbox, ê¸°ë³¸ê°’: Good to Great)
        book_title = st.selectbox(
            "ì±… ì œëª©",
            ["í¼ìŠ¤ë„ MBA", "ë ˆì´ë‹¬ë¦¬ì˜¤ì˜ ì›ì¹™", "Good to Great"],
            index=2
        )
        material_type = st.selectbox("ìë£Œ ìœ í˜•", ["ìš”ì•½", "ì ìš©"])
        openai_api_key = os.getenv('OPENAI_API_KEY')
        file_name = None
        raw_text = None
        # --- ì¶”ê°€: AI í”„ë¡¬í”„íŠ¸ìš© í…ìŠ¤íŠ¸ ë°•ìŠ¤ ---
        extra_prompt_reg = st.text_area("AI í”„ë¡¬í”„íŠ¸ì— ì¶”ê°€ë¡œ ì°¸ê³ í•  ë‚´ìš©(ì„ íƒ)", key="reg_extra_prompt", placeholder="íŠ¹ì • ê´€ì , ê°•ì¡°ì , ì¶”ê°€ ì§€ì‹œì‚¬í•­ ë“± ììœ ë¡­ê²Œ ì…ë ¥í•˜ì„¸ìš”.", height=80)
        # ---
        if uploaded_file:
            file_name = uploaded_file.name
            raw_text = uploaded_file.read().decode('utf-8')
        elif text_input.strip():
            file_name = f"manual_input_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt"
            raw_text = text_input
        if st.button("ë“±ë¡ (AI ìš”ì•½ ë° ì €ì¥)"):
            if not raw_text:
                st.warning("íŒŒì¼ ì—…ë¡œë“œ ë˜ëŠ” í…ìŠ¤íŠ¸ ì…ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤.")
            elif not openai_api_key and not uploaded_file:
                st.error("OpenAI API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            else:
                with st.spinner("ì €ì¥ ì¤‘ì…ë‹ˆë‹¤..."):
                    try:
                        if uploaded_file:
                            # íŒŒì¼ ì—…ë¡œë“œ ì‹œ AI ìš”ì•½ ì—†ì´ ì›ë¬¸ ì €ì¥
                            saved = save_material(book_title, file_name, raw_text, "summary" if material_type=="ìš”ì•½" else "application")
                            preview_content = raw_text
                        else:
                            # ì§ì ‘ ì…ë ¥ ì‹œ AI ìš”ì•½ í›„ ì €ì¥ (ìš”ì•½/ì ìš© ëª¨ë‘)
                            summary = ai_summarize(raw_text, st.session_state.selected_model, extra_prompt_reg)
                            saved = save_material(book_title, file_name, summary, "summary" if material_type=="ìš”ì•½" else "application")
                            preview_content = summary
                        if saved:
                            st.success("ì €ì¥ ì™„ë£Œ!")
                            st.markdown("### ì €ì¥ëœ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°")
                            st.markdown(format_bullet_points(preview_content))
                    except Exception as e:
                        st.error(f"AI ìš”ì•½/ì €ì¥ ì¤‘ ì˜¤ë¥˜: {str(e)}")

    with tab2:
        st.header("ì ìš© íŒŒì¼ ìƒì„±")
        openai_api_key = os.getenv('OPENAI_API_KEY')
        # ìš”ì•½ íŒŒì¼, ê¸°ì¡´ ì ìš© íŒŒì¼ ì„ íƒ
        summaries = get_materials("summary")
        applications = get_materials("application")
        summary_options = [f"{s['book_title']} - {s['file_name']}" for s in summaries]
        application_options = [f"{a['book_title']} - {a['file_name']}" for a in applications]
        selected_summary = st.selectbox("ìš”ì•½ íŒŒì¼ ì„ íƒ", options=summary_options)
        selected_application = st.selectbox("ê¸°ì¡´ ì ìš© íŒŒì¼ ì„ íƒ", options=application_options)
        extra_prompt = st.text_area("AI í”„ë¡¬í”„íŠ¸ì— ì¶”ê°€ë¡œ ì°¸ê³ í•  ë‚´ìš©(ì„ íƒ)", placeholder="íŠ¹ì • ê´€ì , ê°•ì¡°ì , ì¶”ê°€ ì§€ì‹œì‚¬í•­ ë“± ììœ ë¡­ê²Œ ì…ë ¥í•˜ì„¸ìš”.", height=80)
        if st.button("AI ì ìš© íŒŒì¼ ìƒì„± ë° ì €ì¥"):
            if not openai_api_key:
                st.error("OpenAI API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            else:
                with st.spinner("AIê°€ ì ìš© íŒŒì¼ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤..."):
                    try:
                        summary_text = summaries[summary_options.index(selected_summary)]['content']
                        application_text = applications[application_options.index(selected_application)]['content']
                        result = ai_generate_application(summary_text, application_text, st.session_state.selected_model, extra_prompt)
                        # ì €ì¥
                        book_title = summaries[summary_options.index(selected_summary)]['book_title']
                        file_name = f"AI_ì ìš©íŒŒì¼_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
                        saved = save_material(book_title, file_name, result, "application")
                        if saved:
                            st.success("ì ìš© íŒŒì¼ ìƒì„± ë° ì €ì¥ ì™„ë£Œ!")
                            st.markdown("### ìƒì„±ëœ ì ìš© íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°")
                            st.markdown(result)
                    except Exception as e:
                        st.error(f"AI ì ìš© íŒŒì¼ ìƒì„±/ì €ì¥ ì¤‘ ì˜¤ë¥˜: {str(e)}")

    with tab3:
        st.header("ë…ì„œí† ë¡  ê²€ìƒ‰/ì¡°íšŒ")
        
        # ë°±ì—…ëœ ìƒíƒœê°€ ìˆë‹¤ë©´ ë³µì› (ì¶”ê°€ ë³´í˜¸)
        for key in protected_states.keys():
            backup_key = f"{key}_backup"
            permanent_backup_key = f"{key}_permanent_backup"
            
            # ì˜êµ¬ ë°±ì—…ì—ì„œ ë³µì› (ìµœìš°ì„ )
            if permanent_backup_key in st.session_state and st.session_state[permanent_backup_key] is not None:
                if st.session_state[key] is None:
                    st.session_state[key] = st.session_state[permanent_backup_key]
                    # ì¼ë°˜ ë°±ì—…ë„ ë™ì‹œì— ë³µì›
                    st.session_state[backup_key] = st.session_state[permanent_backup_key]
            # ì¼ë°˜ ë°±ì—…ì—ì„œ ë³µì› (ì°¨ì„ )
            elif backup_key in st.session_state and st.session_state[backup_key] is not None:
                if st.session_state[key] is None:
                    st.session_state[key] = st.session_state[backup_key]
        
        subtab1, subtab2, subtab3 = st.tabs(["ìš”ì•½ íŒŒì¼", "ì ìš© íŒŒì¼", "ìš°í™”"])
        with subtab1:
            st.subheader("ìš”ì•½ íŒŒì¼ ê²€ìƒ‰/AI ìš”ì•½/ìŒì„± ìƒì„±")
            summaries = get_materials("summary")
            previous_topic = st.text_input("ì´ì „ í† ë¡  ì£¼ì œ", placeholder="ì´ì „ ë…ì„œ í† ë¡ ì˜ ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”", key="prev_topic_tts")
            if summaries:
                summary_options = [f"{s['book_title']} - {s['file_name']} ({s['created_at'].strftime('%Y-%m-%d')})" for s in summaries]
                selected_idx = st.selectbox("ìš”ì•½ íŒŒì¼ ì„ íƒ (ìµœì‹ ìˆœ)", range(len(summary_options)), format_func=lambda i: summary_options[i], key="summary_selectbox")
                selected_summary = summaries[selected_idx]
                st.write(f"### {selected_summary['file_name']}")
                st.markdown(format_bullet_points(selected_summary['content']))
                st.write(f"*ë“±ë¡ì¼: {selected_summary['created_at'].strftime('%Y-%m-%d')}*")
                extra_prompt_summary = st.text_area("AI í”„ë¡¬í”„íŠ¸ì— ì¶”ê°€ë¡œ ì°¸ê³ í•  ë‚´ìš©(ì„ íƒ)", key="summary_extra_prompt", placeholder="íŠ¹ì • ê´€ì , ê°•ì¡°ì , ì¶”ê°€ ì§€ì‹œì‚¬í•­ ë“± ììœ ë¡­ê²Œ ì…ë ¥í•˜ì„¸ìš”.", height=80)
                if st.button("AI ìš”ì•½"):
                    with st.spinner("AIê°€ í•µì‹¬ ìš”ì•½ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤..."):
                        try:
                            ai_summary = ai_summarize_keypoints(selected_summary['content'], st.session_state.selected_model, extra_prompt_summary)
                            st.session_state['ai_summary_result'] = ai_summary
                            # ë°±ì—…ë„ í•¨ê»˜ ì €ì¥
                            st.session_state['ai_summary_result_backup'] = ai_summary
                            # ì˜êµ¬ ë°±ì—…ë„ í•¨ê»˜ ì €ì¥
                            st.session_state['ai_summary_result_permanent_backup'] = ai_summary
                        except Exception as e:
                            st.error(f"AI ìš”ì•½ ì¤‘ ì˜¤ë¥˜: {str(e)}")
                if st.session_state['ai_summary_result']:
                    st.markdown("### ë¹„ì¦ˆë‹ˆìŠ¤ ì‹¤ì „ ì ìš© í•µì‹¬")
                    st.markdown(format_bullet_points(st.session_state['ai_summary_result']))
                if st.button("ìŒì„± ìƒì„±", key="summary_tts_btn"):
                    with st.spinner("ìŒì„±ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤..."):
                        try:
                            opening_ment = f"ì•ˆë…•í•˜ì„¸ìš”. ì¢‹ì€ ì•„ì¹¨ì…ë‹ˆë‹¤. ì§€ë‚œë²ˆ ì‹œê°„ì—ëŠ” {previous_topic if previous_topic else 'ì´ì „ ì£¼ì œ'}ì˜ ë‚´ìš©ìœ¼ë¡œ ë…ì„œí† ë¡ ì„ ì§„í–‰í–ˆìŠµë‹ˆë‹¤. ê·¸ëŸ¼ ì˜¤ëŠ˜ ë…ì„œ í† ë¡  ë‚´ìš©ì„ ìš”ì•½í•´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤."
                            full_text = f"""
{opening_ment}
\nìš”ì•½ ë‚´ìš©ì…ë‹ˆë‹¤.\n{selected_summary['content']}"""
                            if st.session_state.get('ai_summary_result'):
                                full_text += f"\n\në¹„ì¦ˆë‹ˆìŠ¤ ì‹¤ì „ ì ìš© í•µì‹¬ ë‚´ìš©ì…ë‹ˆë‹¤.\n{st.session_state['ai_summary_result']}"
                            full_text += "\n\nì¦ê±°ìš´ ë…ì„œ í† ë¡  ë˜ì„¸ìš”."
                            summarized_text = summarize_for_tts(full_text)
                            tts_audio = text_to_speech(summarized_text)
                            if tts_audio:
                                st.session_state['tts_audio'] = tts_audio
                                # ë°±ì—…ë„ í•¨ê»˜ ì €ì¥
                                st.session_state['tts_audio_backup'] = tts_audio
                                # ì˜êµ¬ ë°±ì—…ë„ í•¨ê»˜ ì €ì¥
                                st.session_state['tts_audio_permanent_backup'] = tts_audio
                        except Exception as e:
                            st.error(f"ìŒì„± ìƒì„± ì¤‘ ì˜¤ë¥˜: {str(e)}")
                if st.session_state['tts_audio']:
                    st.markdown(st.session_state['tts_audio'], unsafe_allow_html=True)
            else:
                st.info("ë“±ë¡ëœ ìš”ì•½ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
        with subtab2:
            st.subheader("ì ìš© íŒŒì¼ ê²€ìƒ‰/AI ìš”ì•½/ìŒì„± ìƒì„±")
            applications = get_materials("application")
            next_topic = st.text_input("ë‹¤ìŒ í† ë¡  ì£¼ì œ", placeholder="ë‹¤ìŒ ë…ì„œ í† ë¡ ì˜ ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”", key="next_topic_tts")
            if applications:
                application_options = [f"{a['book_title']} - {a['file_name']} ({a['created_at'].strftime('%Y-%m-%d')})" for a in applications]
                selected_idx = st.selectbox("ì ìš© íŒŒì¼ ì„ íƒ (ìµœì‹ ìˆœ)", range(len(application_options)), format_func=lambda i: application_options[i], key="app_selectbox")
                selected_application = applications[selected_idx]
                st.write(f"### {selected_application['file_name']}")
                st.markdown(format_bullet_points(selected_application['content']))
                st.write(f"*ë“±ë¡ì¼: {selected_application['created_at'].strftime('%Y-%m-%d')}*")
                extra_prompt_app = st.text_area("AI í”„ë¡¬í”„íŠ¸ì— ì¶”ê°€ë¡œ ì°¸ê³ í•  ë‚´ìš©(ì„ íƒ)", key="app_extra_prompt", placeholder="íŠ¹ì • ê´€ì , ê°•ì¡°ì , ì¶”ê°€ ì§€ì‹œì‚¬í•­ ë“± ììœ ë¡­ê²Œ ì…ë ¥í•˜ì„¸ìš”.", height=80)
                if st.button("AI ìš”ì•½", key="app_ai_summary"):
                    with st.spinner("AIê°€ ì ìš© íŒŒì¼ì„ ìš”ì•½ ì¤‘ì…ë‹ˆë‹¤..."):
                        try:
                            ai_app_summary = ai_summarize_application_summary(selected_application['content'], st.session_state.selected_model, extra_prompt_app)
                            st.session_state['ai_app_summary_result'] = ai_app_summary
                            # ë°±ì—…ë„ í•¨ê»˜ ì €ì¥
                            st.session_state['ai_app_summary_result_backup'] = ai_app_summary
                            # ì˜êµ¬ ë°±ì—…ë„ í•¨ê»˜ ì €ì¥
                            st.session_state['ai_app_summary_result_permanent_backup'] = ai_app_summary
                        except Exception as e:
                            st.error(f"AI ìš”ì•½ ì¤‘ ì˜¤ë¥˜: {str(e)}")
                if st.session_state['ai_app_summary_result']:
                    st.markdown("### ì ìš© íŒŒì¼ ìš”ì•½ ë° ì´í‰ (AI)")
                    st.markdown(st.session_state['ai_app_summary_result'])
                if st.button("ìŒì„± ìƒì„±", key="app_tts"):
                    with st.spinner("ìŒì„±ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤..."):
                        try:
                            opening_ment = "ì¦ê±°ìš´ ë…ì„œí† ë¡  ë˜ì…¨ëŠ”ì§€ìš”. ì´ë²ˆ ë…ì„œí† ë¡ ì˜ ì ìš© íŒŒì¼ì— ëŒ€í•œ AI ìš”ì•½ê³¼ ì´í‰ì„ í•´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤."
                            closing_ment = f"ë‹¤ìŒ ì‹œê°„ì—ëŠ” {next_topic if next_topic else 'ë‹¤ìŒ ì£¼ì œ'}ì— ëŒ€í•œ ë…ì„œ í† ë¡ ì„ ì§„í–‰í•  ì˜ˆì •ì…ë‹ˆë‹¤."
                            tts_text = f"{opening_ment}\n" + (st.session_state.get('ai_app_summary_result') or '') + f"\n{closing_ment}"
                            summarized_text = summarize_for_tts(tts_text)
                            tts_app_audio = text_to_speech(summarized_text)
                            if tts_app_audio:
                                st.session_state['tts_app_audio'] = tts_app_audio
                                # ë°±ì—…ë„ í•¨ê»˜ ì €ì¥
                                st.session_state['tts_app_audio_backup'] = tts_app_audio
                                # ì˜êµ¬ ë°±ì—…ë„ í•¨ê»˜ ì €ì¥
                                st.session_state['tts_app_audio_permanent_backup'] = tts_app_audio
                        except Exception as e:
                            st.error(f"ìŒì„± ìƒì„± ì¤‘ ì˜¤ë¥˜: {str(e)}")
                if st.session_state['tts_app_audio']:
                    st.markdown(st.session_state['tts_app_audio'], unsafe_allow_html=True)
            else:
                st.info("ë“±ë¡ëœ ì ìš© íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
        
        with subtab3:
            st.subheader("ìš°í™” ìƒì„±/ìŒì„± ìƒì„±")
            summaries = get_materials("summary")
            if summaries:
                summary_options = [f"{s['book_title']} - {s['file_name']} ({s['created_at'].strftime('%Y-%m-%d')})" for s in summaries]
                selected_idx = st.selectbox("ìš”ì•½ íŒŒì¼ ì„ íƒ (ìµœì‹ ìˆœ)", range(len(summary_options)), format_func=lambda i: summary_options[i], key="fable_summary_selectbox")
                selected_summary = summaries[selected_idx]
                
                # ìš°í™” ìŠ¤íƒ€ì¼ ì„ íƒ
                fable_types = ["ì´ì†ìš°í™”", "íƒˆë¬´ë“œ", "ì„±ê²½ì´ì•¼ê¸°", "4ëŒ€ ì„±ì¸ ëŒ€í™”(ì˜ˆìˆ˜ë‹˜, ë¶€ì²˜ë‹˜, ê³µìë‹˜, ì†Œí¬ë¼í…ŒìŠ¤ë‹˜)", "ì¥ì ì´ì•¼ê¸°", "ë…¸ìì˜ ë„ë•ê²½", "ì‚¼êµ­ì§€ì˜ ì œê°ˆëŸ‰", "ì´ˆí•œì§€ì˜ ì¥ëŸ‰", "ì£¼ì—­", "ì œìë°±ê°€"]
                selected_fable_type = st.selectbox("ìš°í™” ìŠ¤íƒ€ì¼ ì„ íƒ", fable_types, key="fable_type_select")
                
                # ì˜¤í”„ë‹ ë©˜íŠ¸ì™€ ë‹¤ìŒ í† ë¡  ì£¼ì œ ì…ë ¥ë€
                col1, col2 = st.columns(2)
                with col1:
                    opening_ment_custom = st.text_area("ì˜¤í”„ë‹ ë©˜íŠ¸ (ì„ íƒ)", key="fable_opening_ment", 
                                                     value="ì¦ê±°ìš´ ë…ì„œí† ë¡  ë˜ì…¨ëŠ”ì§€ìš”. ì´ë²ˆ ë…ì„œí† ë¡  ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ í•œ ìš°í™”ë¥¼ ë“¤ë ¤ë“œë¦¬ê² ìŠµë‹ˆë‹¤.", 
                                                     height=80)
                with col2:
                    next_topic_fable = st.text_input("ë‹¤ìŒ í† ë¡  ì£¼ì œ", placeholder="ë‹¤ìŒ ë…ì„œ í† ë¡ ì˜ ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”", key="next_topic_fable")
                
                st.write(f"### {selected_summary['file_name']}")
                st.markdown(format_bullet_points(selected_summary['content']))
                st.write(f"*ë“±ë¡ì¼: {selected_summary['created_at'].strftime('%Y-%m-%d')}*")
                
                extra_prompt_fable = st.text_area("AI í”„ë¡¬í”„íŠ¸ì— ì¶”ê°€ë¡œ ì°¸ê³ í•  ë‚´ìš©(ì„ íƒ)", key="fable_extra_prompt", placeholder="íŠ¹ì • ê´€ì , ê°•ì¡°ì , ì¶”ê°€ ì§€ì‹œì‚¬í•­ ë“± ììœ ë¡­ê²Œ ì…ë ¥í•˜ì„¸ìš”.", height=80)
                
                if st.button("AI ìš°í™” ìƒì„±", key="fable_ai_generate"):
                    with st.spinner(f"AIê°€ {selected_fable_type} ìŠ¤íƒ€ì¼ì˜ ìš°í™”ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤..."):
                        try:
                            ai_fable = ai_generate_fable(selected_summary['content'], selected_fable_type, st.session_state.selected_model, extra_prompt_fable)
                            st.session_state['ai_fable_result'] = ai_fable
                            # ë°±ì—…ë„ í•¨ê»˜ ì €ì¥
                            st.session_state['ai_fable_result_backup'] = ai_fable
                            # ì˜êµ¬ ë°±ì—…ë„ í•¨ê»˜ ì €ì¥
                            st.session_state['ai_fable_result_permanent_backup'] = ai_fable
                        except Exception as e:
                            st.error(f"AI ìš°í™” ìƒì„± ì¤‘ ì˜¤ë¥˜: {str(e)}")
                
                if st.session_state['ai_fable_result']:
                    st.markdown("### ìƒì„±ëœ ìš°í™”")
                    st.markdown(st.session_state['ai_fable_result'])
                
                if st.button("ìŒì„± ìƒì„±", key="fable_tts"):
                    if not st.session_state.get('ai_fable_result'):
                        st.warning("ë¨¼ì € AI ìš°í™”ë¥¼ ìƒì„±í•´ ì£¼ì„¸ìš”.")
                    else:
                        with st.spinner("ìŒì„±ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤..."):
                            try:
                                # ì˜¤í”„ë‹ ë©˜íŠ¸ + ìš°í™” + í´ë¡œì§• ë©˜íŠ¸ ì¡°í•©
                                tts_parts = []
                                if opening_ment_custom and opening_ment_custom.strip():
                                    tts_parts.append(opening_ment_custom.strip())
                                
                                if st.session_state.get('ai_fable_result'):
                                    tts_parts.append(st.session_state['ai_fable_result'])
                                
                                # ë‹¤ìŒ í† ë¡  ì£¼ì œ ê¸°ë°˜ í´ë¡œì§• ë©˜íŠ¸ ìƒì„±
                                if next_topic_fable and next_topic_fable.strip():
                                    closing_ment = f"ë‹¤ìŒ ì‹œê°„ì—ëŠ” {next_topic_fable.strip()}ì— ëŒ€í•œ ë…ì„œ í† ë¡ ì„ ì§„í–‰í•  ì˜ˆì •ì…ë‹ˆë‹¤."
                                    tts_parts.append(closing_ment)
                                
                                tts_text = "\n".join(tts_parts)
                                summarized_text = summarize_for_tts(tts_text, max_length=4000)  # 1ë¶„ 30ì´ˆ ë¶„ëŸ‰ìœ¼ë¡œ ê¸¸ì´ ì¡°ì •
                                tts_fable_audio = text_to_speech_fable(summarized_text, selected_fable_type)
                                if tts_fable_audio:
                                    st.session_state['tts_fable_audio'] = tts_fable_audio
                                    # ë°±ì—…ë„ í•¨ê»˜ ì €ì¥
                                    st.session_state['tts_fable_audio_backup'] = tts_fable_audio
                                    # ì˜êµ¬ ë°±ì—…ë„ í•¨ê»˜ ì €ì¥
                                    st.session_state['tts_fable_audio_permanent_backup'] = tts_fable_audio
                            except Exception as e:
                                st.error(f"ìŒì„± ìƒì„± ì¤‘ ì˜¤ë¥˜: {str(e)}")
                
                if st.session_state['tts_fable_audio']:
                    st.markdown(st.session_state['tts_fable_audio'], unsafe_allow_html=True)
            else:
                st.info("ë“±ë¡ëœ ìš”ì•½ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")

    with tab_order:
        discussion_order_tab()

def format_bullet_points(text):
    lines = text.split('\n')
    formatted = []
    for line in lines:
        # ì œëª©(ì„¹ì…˜) ê°•ì¡°: êµµê²Œ ì²˜ë¦¬
        if line.strip().startswith('#') or line.strip().startswith('**') or (line.strip() and not line.strip().startswith('â€¢') and not line.strip().startswith('-')):
            formatted.append(f"**{line.strip().replace('#','').strip()}**")
        # bullet point
        elif 'â€¢' in line:
            parts = line.split('â€¢')
            new_line = parts[0]
            for part in parts[1:]:
                if part.strip():
                    new_line += '\nâ€¢ ' + part.strip()
            formatted.append(new_line)
        else:
            formatted.append(line)
    # ë¹ˆ ì¤„ ì¶”ê°€ë¡œ ê°€ë…ì„± í–¥ìƒ
    return '\n\n'.join([l for l in formatted if l.strip()])

def ai_summarize_keypoints(text, model_name, extra_prompt=None):
    summary_instruction = (
        "ì•„ë˜ í…ìŠ¤íŠ¸ì—ì„œ ì‹¤ì œ ë¹„ì¦ˆë‹ˆìŠ¤ ì—…ë¬´ í™˜ê²½ì— ë°”ë¡œ ì ìš©í•  ìˆ˜ ìˆëŠ” ì‹¤ì „ í•µì‹¬ ë‚´ìš© 1~2ê°€ì§€ë§Œ, ê° í•­ëª©ë‹¹ 100ì ì´ë‚´ì˜ bullet point(â€¢)ë¡œ ìš”ì•½í•´ ì£¼ì„¸ìš”. "
        "ê° í•­ëª©ì€ '~í•¨' í˜•íƒœì˜ í•œê¸€ë¡œ ì‘ì„±í•˜ê³ , ì¡´ëŒ“ë§ì€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”. "
        "ë¶ˆí•„ìš”í•œ ì„¤ëª… ì—†ì´, ì‹¤ë¬´ì—ì„œ ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì´ê³  ì‹¤ì§ˆì ì¸ ì‹¤ì²œ/ì ìš© ë°©ì•ˆë§Œ 1~2ê°œ bullet pointë¡œ ì œì‹œí•´ ì£¼ì„¸ìš”."
    )
    if model_name.startswith('claude'):
        client = ChatAnthropic(model=model_name, api_key=os.getenv('ANTHROPIC_API_KEY'), temperature=0.3, max_tokens=400)
        prompt = f"""
{summary_instruction}
---
{text}
"""
        if extra_prompt and extra_prompt.strip():
            prompt += f"\n[ì°¸ê³  ë‚´ìš©]\n{extra_prompt.strip()}\n"
        response = client.invoke([
            {"role": "system", "content": "ë‹¹ì‹ ì€ ë¹„ì¦ˆë‹ˆìŠ¤ ì‹¤ì „ ì ìš© ìš”ì•½ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. í•­ìƒ ì‹¤ì œ ì—…ë¬´ì— ë°”ë¡œ ì ìš©í•  ìˆ˜ ìˆëŠ” ì‹¤ì²œ/ì ìš© ë°©ì•ˆë§Œ 1~2ê°œ, ê° í•­ëª©ë‹¹ 100ì ì´ë‚´ë¡œ bullet pointë¡œ '~í•¨' í˜•íƒœì˜ ê°„ê²°ì²´ë¡œ ì‘ì„±í•©ë‹ˆë‹¤. ì¡´ëŒ“ë§ì€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¶ˆí•„ìš”í•œ ì„¤ëª…ì€ ì œì™¸í•©ë‹ˆë‹¤."},
            {"role": "user", "content": prompt}
        ])
        return response.content if hasattr(response, 'content') else str(response)
    else:
        # OpenAI API í‚¤ ê²€ì¦
        openai_key = os.getenv('OPENAI_API_KEY')
        if not openai_key or openai_key.strip() == '' or openai_key == 'NA':
            raise ValueError(f"OpenAI API í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. í˜„ì¬ ê°’: {openai_key}")
        
        try:
            client = OpenAI(api_key=openai_key)
            prompt = f"""
{summary_instruction}
---
{text}
"""
            if extra_prompt and extra_prompt.strip():
                prompt += f"\n[ì°¸ê³  ë‚´ìš©]\n{extra_prompt.strip()}\n"
            response = client.chat.completions.create(
                model=model_name,
                messages=[
                    {"role": "system", "content": "ë‹¹ì‹ ì€ ë¹„ì¦ˆë‹ˆìŠ¤ ì‹¤ì „ ì ìš© ìš”ì•½ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. í•­ìƒ ì‹¤ì œ ì—…ë¬´ì— ë°”ë¡œ ì ìš©í•  ìˆ˜ ìˆëŠ” ì‹¤ì²œ/ì ìš© ë°©ì•ˆë§Œ 1~2ê°œ, ê° í•­ëª©ë‹¹ 100ì ì´ë‚´ë¡œ bullet pointë¡œ '~í•¨' í˜•íƒœì˜ ê°„ê²°ì²´ë¡œ ì‘ì„±í•©ë‹ˆë‹¤. ì¡´ëŒ“ë§ì€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¶ˆí•„ìš”í•œ ì„¤ëª…ì€ ì œì™¸í•©ë‹ˆë‹¤."},
                    {"role": "user", "content": prompt}
                ],
                max_tokens=400,
                temperature=0.3
            )
            return response.choices[0].message.content
        except Exception as e:
            st.error(f"OpenAI API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜: {str(e)}")
            st.error(f"API í‚¤ ìƒíƒœ: {openai_key[:10] if openai_key else 'None'}... (ê¸¸ì´: {len(openai_key) if openai_key else 0})")
            raise e

def ai_summarize_application_summary(text, model_name, extra_prompt=None):
    prompt = (
        "ì•„ë˜ ì ìš© íŒŒì¼ì˜ í•µì‹¬ ë‚´ìš©ì„ ë” ìƒì„¸í•˜ê²Œ ìš”ì•½í•´ ì£¼ì„¸ìš”. ì´ì–´ì„œ, ì´í‰ì˜ ì œëª©ì€ ë°˜ë“œì‹œ 'íˆ¬ëª…í•˜ê³  ì§„ì‹¤í•œ ì¡°ì§ ë¬¸í™”'ë¡œ í•˜ê³ , ê·¸ ì•„ë˜ì—ëŠ” í˜‘ì—…í•˜ëŠ” ì¡°ì§ ë¬¸í™” ë§Œë“¤ê¸° ê´€ì ì—ì„œ ì ìš© íŒŒì¼ì— ëŒ€í•œ ì´í‰ì„ 5ì¤„ ì´ë‚´ë¡œ ê°„ê²°í•˜ê²Œ ì‘ì„±í•´ ì£¼ì„¸ìš”. ì „ì²´ ë¶„ëŸ‰ì€ ì•½ 2ë¶„ ë¶„ëŸ‰(ìš”ì•½ì€ ìƒì„¸í•˜ê²Œ, ì´í‰ì€ ê°„ê²°í•˜ê²Œ)ìœ¼ë¡œ í•´ ì£¼ì„¸ìš”. í•„ìš”ì‹œ bullet pointë¥¼ í™œìš©í•´ë„ ì¢‹ìŠµë‹ˆë‹¤."
    )
    if model_name.startswith('claude'):
        client = ChatAnthropic(model=model_name, api_key=os.getenv('ANTHROPIC_API_KEY'), temperature=0.3, max_tokens=4096)
        prompt_full = f"{prompt}\n---\n{text}"
        if extra_prompt and extra_prompt.strip():
            prompt_full += f"\n[ì°¸ê³  ë‚´ìš©]\n{extra_prompt.strip()}\n"
        response = client.invoke([
            {"role": "system", "content": "ë‹¹ì‹ ì€ ë¹„ì¦ˆë‹ˆìŠ¤ ìš”ì•½ ë° í‰ê°€ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì ìš© íŒŒì¼ì˜ í•µì‹¬ì„ ë” ìƒì„¸í•˜ê²Œ ìš”ì•½í•˜ê³ , ì´í‰ì˜ ì œëª©ì€ ë°˜ë“œì‹œ 'íˆ¬ëª…í•˜ê³  ì§„ì‹¤í•œ ì¡°ì§ ë¬¸í™”'ë¡œ í•˜ë©°, ê·¸ ì•„ë˜ì—ëŠ” í˜‘ì—…í•˜ëŠ” ì¡°ì§ ë¬¸í™” ë§Œë“¤ê¸° ê´€ì ì—ì„œ 5ì¤„ ì´ë‚´ë¡œ ê°„ê²°í•œ ì´í‰ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”."},
            {"role": "user", "content": prompt_full}
        ])
        return response.content if hasattr(response, 'content') else str(response)
    else:
        # OpenAI API í‚¤ ê²€ì¦
        openai_key = os.getenv('OPENAI_API_KEY')
        if not openai_key or openai_key.strip() == '' or openai_key == 'NA':
            raise ValueError(f"OpenAI API í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. í˜„ì¬ ê°’: {openai_key}")
        
        try:
            client = OpenAI(api_key=openai_key)
            prompt_full = f"{prompt}\n---\n{text}"
            if extra_prompt and extra_prompt.strip():
                prompt_full += f"\n[ì°¸ê³  ë‚´ìš©]\n{extra_prompt.strip()}\n"
            response = client.chat.completions.create(
                model=model_name,
                messages=[
                    {"role": "system", "content": "ë‹¹ì‹ ì€ ë¹„ì¦ˆë‹ˆìŠ¤ ìš”ì•½ ë° í‰ê°€ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì ìš© íŒŒì¼ì˜ í•µì‹¬ì„ ë” ìƒì„¸í•˜ê²Œ ìš”ì•½í•˜ê³ , ì´í‰ì˜ ì œëª©ì€ ë°˜ë“œì‹œ 'íˆ¬ëª…í•˜ê³  ì§„ì‹¤í•œ ì¡°ì§ ë¬¸í™”'ë¡œ í•˜ë©°, ê·¸ ì•„ë˜ì—ëŠ” í˜‘ì—…í•˜ëŠ” ì¡°ì§ ë¬¸í™” ë§Œë“¤ê¸° ê´€ì ì—ì„œ 5ì¤„ ì´ë‚´ë¡œ ê°„ê²°í•œ ì´í‰ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”."},
                    {"role": "user", "content": prompt_full}
                ],
                max_tokens=4096,
                temperature=0.3
            )
            return response.choices[0].message.content
        except Exception as e:
            st.error(f"OpenAI API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜: {str(e)}")
            st.error(f"API í‚¤ ìƒíƒœ: {openai_key[:10] if openai_key else 'None'}... (ê¸¸ì´: {len(openai_key) if openai_key else 0})")
            raise e

def is_pi_number_exists(pi_number):
    conn = connect_to_db()
    cursor = conn.cursor()
    cursor.execute("SELECT COUNT(*) FROM proforma_invoices WHERE pi_number = %s", (pi_number,))
    exists = cursor.fetchone()[0] > 0
    cursor.close()
    conn.close()
    return exists

if __name__ == "__main__":
    # íƒ€ì´ë¨¸ ì¢…ë£Œ ìŒì„± ë©”ì‹œì§€ ì¤€ë¹„ (ì•± ì‹œì‘ ì‹œ í•œ ë²ˆë§Œ)
    if 'order_end_audio' not in st.session_state:
        try:
            from openai import OpenAI
            import base64, os
            
            # OpenAI API í‚¤ ê²€ì¦
            openai_key = os.getenv('OPENAI_API_KEY')
            if openai_key and openai_key.strip() != '' and openai_key != 'NA':
                tts_text = "í† ë¡  ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. í† ë¡ ì„ ë§ˆë¬´ë¦¬í•´ ì£¼ì„¸ìš”. í† ë¡ ì„ ë§ˆë¬´ë¦¬í•´ ì£¼ì„¸ìš”. í† ë¡ ì„ ë§ˆë¬´ë¦¬í•´ ì£¼ì„¸ìš”."
                client = OpenAI(api_key=openai_key)
                response = client.audio.speech.create(
                    model="tts-1",
                    voice="nova",
                    input=tts_text,
                    speed=0.9
                )
                audio_data = response.content
                audio_base64 = base64.b64encode(audio_data).decode('utf-8')
                st.session_state['order_end_audio'] = audio_base64
            else:
                print(f"[WARNING] OpenAI API í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ íƒ€ì´ë¨¸ ì¢…ë£Œ ìŒì„±ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í‚¤ ìƒíƒœ: {openai_key}")
                st.session_state['order_end_audio'] = ''
        except Exception as e:
            print(f"[ERROR] íƒ€ì´ë¨¸ ì¢…ë£Œ ìŒì„± ìƒì„± ì¤‘ ì˜¤ë¥˜: {str(e)}")
            st.session_state['order_end_audio'] = ''
    
    # í•µì‹¬ ë³´í˜¸ëœ ìƒíƒœë“¤ì˜ ì¶”ê°€ ë°±ì—… (ì•± ì „ì²´ ì‹¤í–‰ ì¤‘ ìœ ì§€)
    protected_session_keys = ['ai_summary_result', 'tts_audio', 'ai_app_summary_result', 'tts_app_audio', 'ai_fable_result', 'tts_fable_audio']
    for key in protected_session_keys:
        # ì˜êµ¬ ë°±ì—… ìƒì„± (ì•± ì „ì²´ ì‹¤í–‰ ì¤‘ ìœ ì§€)
        if key in st.session_state and st.session_state[key] is not None:
            st.session_state[f"{key}_permanent_backup"] = st.session_state[key]
        # ì˜êµ¬ ë°±ì—…ì—ì„œ ë³µì› (ê°’ì´ Noneì´ ë˜ì—ˆì„ ë•Œ)
        elif f"{key}_permanent_backup" in st.session_state and st.session_state[f"{key}_permanent_backup"] is not None:
            st.session_state[key] = st.session_state[f"{key}_permanent_backup"]
    
    main() 

