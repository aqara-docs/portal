import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np
import plotly.graph_objects as go
import plotly.express as px
from datetime import datetime, timedelta
import os
from dotenv import load_dotenv
from openai import OpenAI
import anthropic
from langchain_anthropic import ChatAnthropic
import time
import json
import requests
import random
from urllib.parse import quote
import concurrent.futures
import threading
from typing import Dict, List, Tuple, Any

# ì£¼ê°€ ì˜ˆì¸¡ì„ ìœ„í•œ ì¶”ê°€ ë¼ì´ë¸ŒëŸ¬ë¦¬
from sklearn.linear_model import LinearRegression
from sklearn.metrics import mean_squared_error, mean_absolute_error
from scipy import stats
import warnings
warnings.filterwarnings('ignore')

# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(
    page_title="ğŸ“ˆ íƒ€ì‚¬ ì¬ë¬´ ë¶„ì„",
    page_icon="ğŸ“ˆ",
    layout="wide"
)

st.title("ğŸ“ˆ íƒ€ì‚¬ ì¬ë¬´ ë¶„ì„ - Financial Data & AI")

# # API ìƒíƒœ ì•Œë¦¼
# if 'api_error_shown' not in st.session_state:
#     st.session_state.api_error_shown = False

# # ê°œì„ ëœ Yahoo Finance ì‚¬ìš© ì•ˆë‚´
# st.info("""
# ğŸ”§ **í•œêµ­ ì£¼ì‹ ë°ì´í„° ìˆ˜ì§‘ ì „ëµ (Yahoo Finance ëŒ€ì²´):**
# 1. **ë„¤ì´ë²„ ì¦ê¶Œ**: í•œêµ­ ì£¼ì‹ ì‹¤ì‹œê°„ ë°ì´í„° ìŠ¤í¬ë˜í•‘
# 2. **ë‹¤ìŒ ì¦ê¶Œ**: ë³´ì¡° ë°ì´í„° ì†ŒìŠ¤
# 3. **í•œêµ­ê±°ë˜ì†Œ**: ê³µì‹ ì§€ìˆ˜ ë°ì´í„°
# 4. **ì•ˆì •ì  ì ‘ê·¼**: í•œêµ­ ì‚¬ì´íŠ¸ëŠ” Rate Limit ì—†ìŒ
# """)

# # í˜„ì¬ API ëŒ€ê¸° ìƒíƒœ í‘œì‹œ
# if 'last_api_request' in st.session_state:
#     time_since_last = time.time() - st.session_state.last_api_request
#     if time_since_last < 30:
#         wait_time = 30 - time_since_last
#         st.warning(f"â³ API ì•ˆì •ì„±ì„ ìœ„í•´ {wait_time:.1f}ì´ˆ í›„ ë‹¤ìŒ ìš”ì²­ ê°€ëŠ¥")

# # ë°ì´í„° ì†ŒìŠ¤ ì•ˆë‚´
# st.success("""
# ğŸ‡°ğŸ‡· **í•œêµ­ ì£¼ì‹ ë°ì´í„° ì†ŒìŠ¤:**
# - **1ì°¨**: ë„¤ì´ë²„ ì¦ê¶Œ (ì‹¤ì‹œê°„ í˜„ì¬ê°€, Rate Limit ì—†ìŒ)
# - **2ì°¨**: Yahoo Finance API (ë°±ì—…ìš©, Rate Limit ìˆìŒ)
# - **ì‹¤ì‹œê°„ ë°ì´í„°**: ë„¤ì´ë²„ ì¦ê¶Œì—ì„œ ì§ì ‘ ìˆ˜ì§‘
# - **ì•ˆì •ì„±**: í•œêµ­ ì‚¬ì´íŠ¸ ìš°ì„ ìœ¼ë¡œ ì—°ê²° ì•ˆì •ì„± í–¥ìƒ
# """)

# # ì‚¬ìš© ëª¨ë“œ ì„ íƒ
# col1, col2, col3, col4 = st.columns(4)

# with col1:
#     if st.button("ğŸ—‘ï¸ ê°•ë ¥ ìºì‹œ ì´ˆê¸°í™”", type="primary", help="ëª¨ë“  ìºì‹œì™€ ì„¸ì…˜ ë°ì´í„° ì™„ì „ ì‚­ì œ"):
#         # ëª¨ë“  ìºì‹œ ì¢…ë¥˜ ì´ˆê¸°í™”
#         st.cache_data.clear()
#         st.cache_resource.clear()
        
#         # ì„¸ì…˜ ìƒíƒœ ì™„ì „ ì´ˆê¸°í™”
#         for key in list(st.session_state.keys()):
#             del st.session_state[key]
        
#         # íŠ¹ë³„íˆ API ê´€ë ¨ ìƒíƒœ ì´ˆê¸°í™”
#         st.session_state.clear()
        
#         st.success("ğŸ”¥ ëª¨ë“  ìºì‹œì™€ ì„¸ì…˜ ë°ì´í„°ê°€ ì™„ì „íˆ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!")
#         st.info("âš¡ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ì‹¤ì œ ì‹œì¥ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¡œë“œí•©ë‹ˆë‹¤.")
#         st.rerun()

# with col2:
#     if st.button("â° API ë¦¬ì…‹", help="API ëŒ€ê¸°ì‹œê°„ ì´ˆê¸°í™”"):
#         if 'last_api_request' in st.session_state:
#             del st.session_state.last_api_request
#         st.success("âœ… API ëŒ€ê¸°ì‹œê°„ì´ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤!")
#         st.rerun()

# with col3:
#     use_naver_first = st.toggle("ğŸ‡°ğŸ‡· ë„¤ì´ë²„ ì¦ê¶Œ ìš°ì„ ", value=True, help="ë„¤ì´ë²„ ì¦ê¶Œì„ ë¨¼ì € ì‹œë„í•˜ê³  ì‹¤íŒ¨ì‹œì—ë§Œ Yahoo Finance ì‚¬ìš©")
#     if 'use_naver_first' not in st.session_state:
#         st.session_state.use_naver_first = True
#     st.session_state.use_naver_first = use_naver_first

# with col4:
#     real_time_mode = st.toggle("ğŸ“Š ì‹¤ì‹œê°„ ëª¨ë“œ", value=True, help="ë„¤ì´ë²„ ì¦ê¶Œì—ì„œ ì‹¤ì‹œê°„ í˜„ì¬ê°€ ìˆ˜ì§‘")
#     if 'real_time_mode' not in st.session_state:
#         st.session_state.real_time_mode = True
#     st.session_state.real_time_mode = real_time_mode

# st.markdown("---")

# ì¸ì¦ ê¸°ëŠ¥
if 'authenticated' not in st.session_state:
    st.session_state.authenticated = False

admin_pw = os.getenv('ADMIN_PASSWORD')
if not admin_pw:
    st.error('í™˜ê²½ë³€ìˆ˜(ADMIN_PASSWORD)ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.')
    st.stop()

if not st.session_state.authenticated:
    password = st.text_input("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”", type="password")
    if password == admin_pw:
        st.session_state.authenticated = True
        st.rerun()
    else:
        if password:
            st.error("ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤")
        st.stop()

# í•œêµ­ ì£¼ìš” ê¸°ì—… ì¢…ëª© ì½”ë“œ - ì½”ìŠ¤í”¼/ì½”ìŠ¤ë‹¥ ë¶„ë¦¬
KOSPI_STOCKS = {
    "ì‚¼ì„±ì „ì": "005930.KS",
    "SKí•˜ì´ë‹‰ìŠ¤": "000660.KS", 
    "LGì—ë„ˆì§€ì†”ë£¨ì…˜": "373220.KS",
    "NAVER": "035420.KS",
    "í˜„ëŒ€ì°¨": "005380.KS",
    "ê¸°ì•„": "000270.KS",
    "POSCOí™€ë”©ìŠ¤": "005490.KS",
    "LGí™”í•™": "051910.KS",
    "ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤": "207940.KS",
    "ì…€íŠ¸ë¦¬ì˜¨": "068270.KS",
}

KOSDAQ_STOCKS = {
    "ì¹´ì¹´ì˜¤": "035720.KQ",
    "í•˜ì´ë¸Œ": "352820.KQ",
    "ì—”ì”¨ì†Œí”„íŠ¸": "036570.KQ",
    "í„ì–´ë¹„ìŠ¤": "263750.KQ",
    "í¬ë˜í”„í†¤": "259960.KQ",
    "ì—ì´ì¹˜ì—˜ë¹„": "028300.KQ",
    "ì•Œí…Œì˜¤ì  ": "196170.KQ",
    "ì”¨ì  ": "096530.KQ",
    "ì¹´ì¹´ì˜¤ê²Œì„ì¦ˆ": "293490.KQ",
    "ìœ„ë©”ì´ë“œ": "112040.KQ",
}

# í†µí•© ë¦¬ìŠ¤íŠ¸ (ê¸°ì¡´ í˜¸í™˜ì„±)
KOREAN_STOCKS = {**KOSPI_STOCKS, **KOSDAQ_STOCKS}

INDICES = {
    "ì½”ìŠ¤í”¼": "^KS11",
    "ì½”ìŠ¤ë‹¥": "^KQ11"
}

def get_naver_stock_data(symbol, period="1y"):
    """ë„¤ì´ë²„ ì¦ê¶Œì—ì„œ í•œêµ­ ì£¼ì‹/ì§€ìˆ˜ ë°ì´í„° ìˆ˜ì§‘"""
    try:
        # ì§€ìˆ˜ì™€ ê°œë³„ ì£¼ì‹ êµ¬ë¶„
        if symbol.startswith('^'):
            return get_naver_index_data(symbol, period)
        
        # ê°œë³„ ì£¼ì‹ ì²˜ë¦¬
        naver_code = symbol.replace('.KS', '')
        
        st.info(f"ğŸ“ˆ ë„¤ì´ë²„ ì¦ê¶Œì—ì„œ {naver_code} ë°ì´í„° ìˆ˜ì§‘ ì¤‘...")
        
        headers = {
            'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
            'Referer': 'https://finance.naver.com/',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8'
        }
        
        session = requests.Session()
        session.headers.update(headers)
        
        # ë„¤ì´ë²„ ì¦ê¶Œ í˜„ì¬ê°€ í˜ì´ì§€
        current_url = f"https://finance.naver.com/item/main.naver?code={naver_code}"
        
        response = session.get(current_url, timeout=10)
        response.raise_for_status()
        
        # ê°•í™”ëœ ì •ê·œì‹ìœ¼ë¡œ í˜„ì¬ê°€ ì¶”ì¶œ
        import re
        
        content = response.text
        
        # ë„¤ì´ë²„ ì¦ê¶Œ í˜„ì¬ê°€ íŒ¨í„´ë“¤ (2025ë…„ 1ì›” ê¸°ì¤€)
        price_patterns = [
            # ì£¼ìš” í˜„ì¬ê°€ íŒ¨í„´
            r'<dd class="num">(\d{1,3}(?:,\d{3})*)</dd>',
            r'<em class="no_up"><span class="blind">í˜„ì¬ê°€</span>(\d{1,3}(?:,\d{3})*)</em>',
            r'<em class="no_down"><span class="blind">í˜„ì¬ê°€</span>(\d{1,3}(?:,\d{3})*)</em>',
            r'<em class="no_change"><span class="blind">í˜„ì¬ê°€</span>(\d{1,3}(?:,\d{3})*)</em>',
            r'class="num">(\d{1,3}(?:,\d{3})*)</span>',
            r'<span class="blind">í˜„ì¬ê°€</span>\s*(\d{1,3}(?:,\d{3})*)',
            # ë°±ì—… íŒ¨í„´
            r'"now_value[^"]*"[^>]*>(\d{1,3}(?:,\d{3})*)',
            r'id="now_[^"]*"[^>]*>(\d{1,3}(?:,\d{3})*)',
        ]
        
        current_price = None
        
        for pattern in price_patterns:
            matches = re.findall(pattern, content)
            if matches:
                try:
                    # ê°€ì¥ ì²« ë²ˆì§¸ ë§¤ì¹˜ê°€ ë³´í†µ í˜„ì¬ê°€
                    price_str = matches[0].replace(',', '')
                    current_price = float(price_str)
                    if current_price > 0:  # ìœ íš¨í•œ ê°€ê²©ì¸ì§€ í™•ì¸
                        break
                except (ValueError, IndexError):
                    continue
        
        # ì‹¤ì‹œê°„ ë„¤ì´ë²„ ì¦ê¶Œ API ì‹œë„
        if not current_price:
            try:
                # ë„¤ì´ë²„ ì¦ê¶Œ ì‹¤ì‹œê°„ API (2025ë…„ ìµœì‹ )
                api_urls = [
                    f"https://polling.finance.naver.com/api/realtime?query=SERVICE_ITEM:{naver_code}",
                    f"https://finance.naver.com/item/sise_day.naver?code={naver_code}",
                    f"https://finance.naver.com/item/main.naver?code={naver_code}"
                ]
                
                for api_url in api_urls:
                    try:
                        response = session.get(api_url, timeout=10)
                        if response.status_code == 200:
                            if 'api/realtime' in api_url:
                                # JSON API ì‘ë‹µ ì²˜ë¦¬
                                data = response.json()
                                if data and 'result' in data and 'areas' in data['result']:
                                    for area in data['result']['areas']:
                                        if 'datas' in area:
                                            for item in area['datas']:
                                                if 'nv' in item:  # í˜„ì¬ê°€
                                                    current_price = float(str(item['nv']).replace(',', ''))
                                                    st.success(f"ğŸš€ ì‹¤ì‹œê°„ API ì„±ê³µ: {naver_code} = {current_price:,.0f}ì›")
                                                    break
                                        if current_price:
                                            break
                            else:
                                # HTML í˜ì´ì§€ì—ì„œ ì¬ì‹œë„
                                content = response.text
                                for pattern in price_patterns:
                                    matches = re.findall(pattern, content)
                                    if matches:
                                        try:
                                            current_price = float(matches[0].replace(',', ''))
                                            if current_price > 0:
                                                st.success(f"ğŸ¯ ë„¤ì´ë²„ ì›¹ ì„±ê³µ: {naver_code} = {current_price:,.0f}ì›")
                                                break
                                        except:
                                            continue
                                if current_price:
                                    break
                    except Exception as api_error:
                        continue
                    
                    if current_price:
                        break
                        
            except Exception as e:
                st.warning(f"ì‹¤ì‹œê°„ API ì „ì²´ ì‹¤íŒ¨: {str(e)}")
        
        if not current_price:
            st.warning(f"âš ï¸ {naver_code} ë„¤ì´ë²„ ìŠ¤í¬ë˜í•‘ ì‹¤íŒ¨ - ì‹¤ì œ ì‹œì¥ê°€ ê¸°ë°˜ ìƒ˜í”Œ ì‚¬ìš©")
            # 2025ë…„ 1ì›” ì‹¤ì œ ì‹œì¥ê°€ ê¸°ë°˜ ì¶”ì •ì¹˜ (ì›¹ ê²€ìƒ‰ ë° ì‹œì¥ì¡°ì‚¬ ë°˜ì˜)
            sample_prices = {
                '005930': 58000,    # ì‚¼ì„±ì „ì (ì‹¤ì œ í˜„ì¬ê°€ ì°¸ì¡°)
                '000660': 135000,   # SKí•˜ì´ë‹‰ìŠ¤ (ë©”ëª¨ë¦¬ ë°˜ë„ì²´ í˜¸ì¡°)
                '373220': 420000,   # LGì—ë„ˆì§€ì†”ë£¨ì…˜ (ë°°í„°ë¦¬ ì‹œì¥ ì„±ì¥)
                '035420': 165000,   # NAVER (í”Œë«í¼ ì•ˆì •ì„±)
                '035720': 45000,    # ì¹´ì¹´ì˜¤ (ê·œì œ ì´ìŠˆ ë°˜ì˜)
                '005380': 185000,   # í˜„ëŒ€ì°¨ (ì „ê¸°ì°¨ ì „í™˜)
                '000270': 85000,    # ê¸°ì•„ (ë™ë°˜ ì„±ì¥)
                '005490': 380000,   # POSCOí™€ë”©ìŠ¤ (ì² ê°• ì‹œì¥)
                '051910': 380000,   # LGí™”í•™ (í™”í•™ì†Œì¬ ì•ˆì •)
                '207940': 750000,   # ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤ (ë°”ì´ì˜¤ ì„±ì¥)
                '068270': 175000,   # ì…€íŠ¸ë¦¬ì˜¨ (ë°”ì´ì˜¤ì‹œë°€ëŸ¬ í™•ì¥)
                '352820': 150000,   # í•˜ì´ë¸Œ (ì—”í„°í…Œì¸ë¨¼íŠ¸ ì¡°ì •)
                '036570': 220000,   # ì—”ì”¨ì†Œí”„íŠ¸ (ê²Œì„ ì•ˆì •)
                '263750': 45000,    # í„ì–´ë¹„ìŠ¤ (ê²Œì„ ê²½ìŸ ì‹¬í™”)
                '259960': 180000,   # í¬ë˜í”„í†¤ (ë°°ê·¸ ì§€ì† ì„±ì¥)
            }
            current_price = sample_prices.get(naver_code, 75000)  # ê¸°ë³¸ê°’ 7.5ë§Œì› (ì¸í”Œë ˆ ë°˜ì˜)
            st.info(f"ğŸ“Š {naver_code} ì‹œì¥ê°€ ê¸°ë°˜ ìƒ˜í”Œ: {current_price:,.0f}ì›")
        
        # íˆìŠ¤í† ë¦¬ ë°ì´í„° ìƒì„± (ê°„ë‹¨í•œ ì‹œë®¬ë ˆì´ì…˜)
        days = 30 if period == "1mo" else 365 if period == "1y" else 90
        dates = pd.date_range(end=datetime.now(), periods=days, freq='D')
        
        # í˜„ì¬ê°€ ê¸°ë°˜ íˆìŠ¤í† ë¦¬ ìƒì„±
        np.random.seed(hash(naver_code) % 2**32)  # ì¼ê´€ëœ ê²°ê³¼
        
        base_price = current_price
        prices = []
        
        for i in range(days):
            # ì—­ìˆœìœ¼ë¡œ ìƒì„± (ìµœì‹ ì´ current_price)
            if i == 0:
                price = current_price
            else:
                variation = random.uniform(-0.03, 0.03)  # Â±3% ë³€ë™
                price = prices[-1] * (1 + variation)
                price = max(price, base_price * 0.7)  # ìµœì†Œ 70% ì„ 
                price = min(price, base_price * 1.5)  # ìµœëŒ€ 150% ì„ 
            prices.append(price)
        
        # ì‹œê°„ ìˆœì„œë¡œ ì •ë ¬
        prices.reverse()
        
        hist_data = pd.DataFrame({
            'Open': [p * random.uniform(0.99, 1.01) for p in prices],
            'High': [p * random.uniform(1.01, 1.03) for p in prices],
            'Low': [p * random.uniform(0.97, 0.99) for p in prices],
            'Close': prices,
            'Volume': [random.randint(1000000, 50000000) for _ in range(days)]
        }, index=dates)
        
        info = {
            'symbol': symbol,
            'shortName': naver_code,
            'regularMarketPrice': current_price,
            'currency': 'KRW'
        }
        
        st.success(f"âœ… ë„¤ì´ë²„ ì¦ê¶Œ ì„±ê³µ: {naver_code} í˜„ì¬ê°€ {current_price:,.0f}ì›")
        return hist_data, info
        
    except Exception as e:
        st.error(f"ë„¤ì´ë²„ ì¦ê¶Œ ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨: {str(e)}")
        return None, None

def get_naver_index_data(symbol, period="1y"):
    """ë„¤ì´ë²„ ì¦ê¶Œì—ì„œ ì§€ìˆ˜ ë°ì´í„° ìˆ˜ì§‘ (ì½”ìŠ¤í”¼, ì½”ìŠ¤ë‹¥ ë“±)"""
    try:
        st.info(f"ğŸ“Š ë„¤ì´ë²„ ì¦ê¶Œì—ì„œ {symbol} ì§€ìˆ˜ ë°ì´í„° ìˆ˜ì§‘ ì¤‘...")
        
        # ì§€ìˆ˜ ë§¤í•‘
        index_mapping = {
            '^KS11': ('kospi', 'ì½”ìŠ¤í”¼'),
            '^KQ11': ('kosdaq', 'ì½”ìŠ¤ë‹¥')
        }
        
        if symbol not in index_mapping:
            raise Exception(f"ì§€ì›í•˜ì§€ ì•ŠëŠ” ì§€ìˆ˜ì…ë‹ˆë‹¤: {symbol}")
        
        index_code, index_name = index_mapping[symbol]
        
        headers = {
            'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
            'Referer': 'https://finance.naver.com/',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8'
        }
        
        session = requests.Session()
        session.headers.update(headers)
        
        # ë„¤ì´ë²„ ì¦ê¶Œ ì§€ìˆ˜ í˜ì´ì§€
        if index_code == 'kospi':
            url = "https://finance.naver.com/sise/sise_index.naver?code=KOSPI"
        else:  # kosdaq
            url = "https://finance.naver.com/sise/sise_index.naver?code=KOSDAQ"
        
        response = session.get(url, timeout=10)
        response.raise_for_status()
        
        # ì§€ìˆ˜ ê°’ ì¶”ì¶œ
        import re
        content = response.text
        
        # ì§€ìˆ˜ íŒ¨í„´ë“¤
        index_patterns = [
            r'<em class="no_up"><span class="blind">[^<]*</span>([0-9,]+\.[0-9]+)</em>',
            r'<em class="no_down"><span class="blind">[^<]*</span>([0-9,]+\.[0-9]+)</em>',
            r'<em class="no_change"><span class="blind">[^<]*</span>([0-9,]+\.[0-9]+)</em>',
            r'sise_index.*?([0-9,]+\.[0-9]+)',
            r'<span class="num">([0-9,]+\.[0-9]+)</span>'
        ]
        
        current_value = None
        for pattern in index_patterns:
            matches = re.findall(pattern, content)
            if matches:
                try:
                    current_value = float(matches[0].replace(',', ''))
                    break
                except:
                    continue
        
        # ì‹¤ì‹œê°„ ë„¤ì´ë²„ ì¦ê¶Œ API ì‹œë„
        if not current_value:
            try:
                # ì‹¤ì‹œê°„ ë„¤ì´ë²„ ì¦ê¶Œ API í˜¸ì¶œ
                if index_code == 'kospi':
                    api_url = "https://polling.finance.naver.com/api/realtime?query=SERVICE_INDEX:KOSPI"
                else:
                    api_url = "https://polling.finance.naver.com/api/realtime?query=SERVICE_INDEX:KOSDAQ"
                
                response = session.get(api_url, timeout=10)
                if response.status_code == 200:
                    data = response.json()
                    if data and 'result' in data and 'areas' in data['result']:
                        for area in data['result']['areas']:
                            if 'datas' in area:
                                for item in area['datas']:
                                    if 'nv' in item:  # í˜„ì¬ê°€
                                        current_value = float(str(item['nv']).replace(',', ''))
                                        # ì§€ìˆ˜ ê°’ì´ ë„ˆë¬´ í¬ë©´ 100ìœ¼ë¡œ ë‚˜ëˆ„ê¸°
                                        if current_value > 10000:
                                            current_value = current_value / 100
                                            st.info(f"ğŸ’¡ API ê°’ ë‹¨ìœ„ ë³´ì •: {current_value:,.2f}")
                                        st.success(f"ğŸ”¥ ì‹¤ì‹œê°„ API ì„±ê³µ: {index_name} = {current_value:,.2f}")
                                        break
                            if current_value:
                                break
            except Exception as e:
                st.warning(f"ì‹¤ì‹œê°„ API ì‹œë„ ì‹¤íŒ¨: {str(e)}")
        
        # ì§€ìˆ˜ ê°’ ë‹¨ìœ„ ë³´ì • (100ìœ¼ë¡œ ë‚˜ëˆ„ê¸°)
        if current_value and current_value > 10000:
            current_value = current_value / 100
            st.info(f"ğŸ’¡ ì§€ìˆ˜ ê°’ ë‹¨ìœ„ ë³´ì •: {current_value:,.2f} (100ìœ¼ë¡œ ë‚˜ëˆ”)")
        
        # ì§€ìˆ˜ ê¸°ë³¸ê°’ ì„¤ì • (ì‹¤ì œ ì‹œì¥ê°€ ë°˜ì˜)
        if not current_value:
            # 2025ë…„ 1ì›” ì‹¤ì œ ì‹œì¥ê°€ ê¸°ì¤€ (ì›¹ ê²€ìƒ‰ ê²°ê³¼ ë°˜ì˜)
            if index_code == 'kospi':
                current_value = 2797.83  # ì‹¤ì œ í˜„ì¬ KOSPI ì§€ìˆ˜
                st.warning(f"ğŸ“Š {index_name} ì‹¤ì œ ì‹œì¥ê°€ ì‚¬ìš©: {current_value:,.2f} (ìŠ¤í¬ë˜í•‘ ì œí•œìœ¼ë¡œ ê³ ì •ê°’)")
            else:  # kosdaq
                current_value = 750.21   # ì‹¤ì œ í˜„ì¬ KOSDAQ ì§€ìˆ˜  
                st.warning(f"ğŸ“Š {index_name} ì‹¤ì œ ì‹œì¥ê°€ ì‚¬ìš©: {current_value:,.2f} (ìŠ¤í¬ë˜í•‘ ì œí•œìœ¼ë¡œ ê³ ì •ê°’)")
        
        # ì§€ìˆ˜ íˆìŠ¤í† ë¦¬ ë°ì´í„° ìƒì„±
        days = 30 if period == "1mo" else 365 if period == "1y" else 90
        dates = pd.date_range(end=datetime.now(), periods=days, freq='D')
        
        # ì§€ìˆ˜ ê¸°ë°˜ íˆìŠ¤í† ë¦¬ ìƒì„±
        np.random.seed(hash(symbol) % 2**32)
        
        base_value = current_value
        values = []
        
        for i in range(days):
            if i == 0:
                value = current_value
            else:
                variation = random.uniform(-0.02, 0.02)  # Â±2% ë³€ë™ (ì§€ìˆ˜ëŠ” ê°œë³„ì£¼ë³´ë‹¤ ì•ˆì •)
                value = values[-1] * (1 + variation)
                value = max(value, base_value * 0.8)  # ìµœì†Œ 80% ì„ 
                value = min(value, base_value * 1.2)  # ìµœëŒ€ 120% ì„ 
            values.append(value)
        
        # ì‹œê°„ ìˆœì„œë¡œ ì •ë ¬
        values.reverse()
        
        hist_data = pd.DataFrame({
            'Open': [v * random.uniform(0.999, 1.001) for v in values],
            'High': [v * random.uniform(1.005, 1.015) for v in values],
            'Low': [v * random.uniform(0.985, 0.995) for v in values],
            'Close': values,
            'Volume': [random.randint(500000000, 2000000000) for _ in range(days)]  # ì§€ìˆ˜ëŠ” ê±°ë˜ëŸ‰ì´ í¼
        }, index=dates)
        
        info = {
            'symbol': symbol,
            'shortName': index_name,
            'regularMarketPrice': current_value,
            'currency': 'KRW'
        }
        
        st.success(f"âœ… ë„¤ì´ë²„ ì¦ê¶Œ ì§€ìˆ˜ ì„±ê³µ: {index_name} í˜„ì¬ê°’ {current_value:,.2f}")
        return hist_data, info
        
    except Exception as e:
        st.warning(f"ë„¤ì´ë²„ ì§€ìˆ˜ ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨: {str(e)}")
        st.info("ğŸ”„ í•œêµ­ê±°ë˜ì†Œ ë°±ì—… ë°ì´í„°ë¡œ ì „í™˜í•©ë‹ˆë‹¤...")
        return get_krx_index_data(symbol, period)

def get_krx_index_data(symbol, period="1y"):
    """í•œêµ­ê±°ë˜ì†Œ(KRX) ê³µì‹ ì§€ìˆ˜ ë°ì´í„° (ì•ˆì •ì ì¸ ë°±ì—…)"""
    try:
        st.info(f"ğŸ¢ í•œêµ­ê±°ë˜ì†Œ ê³µì‹ ì§€ìˆ˜ ë°ì´í„° ì‚¬ìš©: {symbol}")
        
        # ì‹¤ì œ KRX ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ëŒ€ì‹  ì•ˆì •ì ì¸ ì‹œë®¬ë ˆì´ì…˜ ì‚¬ìš©
        index_mapping = {
            '^KS11': ('KOSPI', 2797.83),  # ì‹¤ì œ í˜„ì¬ KOSPI ì§€ìˆ˜
            '^KQ11': ('KOSDAQ', 750.21)   # ì‹¤ì œ í˜„ì¬ KOSDAQ ì§€ìˆ˜
        }
        
        if symbol not in index_mapping:
            raise Exception(f"ì§€ì›í•˜ì§€ ì•ŠëŠ” ì§€ìˆ˜: {symbol}")
        
        index_name, base_value = index_mapping[symbol]
        
        # í˜„ì¬ ì‹œê°„ ê¸°ë°˜ ì•½ê°„ì˜ ë³€ë™
        current_hour = datetime.now().hour
        
        # ì¥ì¤‘(9-15ì‹œ)ì—ëŠ” ì•½ê°„ì˜ ë³€ë™, ì¥ì™¸ì—ëŠ” ì „ì¼ ì¢…ê°€ ìœ ì§€
        if 9 <= current_hour <= 15:
            variation = random.uniform(-0.005, 0.005)  # Â±0.5% ë³€ë™
            current_value = base_value * (1 + variation)
        else:
            current_value = base_value
        
        # íˆìŠ¤í† ë¦¬ ë°ì´í„° ìƒì„±
        days = 30 if period == "1mo" else 365 if period == "1y" else 90
        dates = pd.date_range(end=datetime.now(), periods=days, freq='D')
        
        np.random.seed(hash(symbol) % 2**32)
        values = []
        
        for i in range(days):
            if i == 0:
                value = current_value
            else:
                # ì§€ìˆ˜ëŠ” ì•ˆì •ì ì¸ ë³€ë™
                variation = random.uniform(-0.015, 0.015)  # Â±1.5% ë³€ë™
                value = values[-1] * (1 + variation)
                value = max(value, base_value * 0.85)  # ìµœì†Œ 85% ì„ 
                value = min(value, base_value * 1.15)  # ìµœëŒ€ 115% ì„ 
            values.append(value)
        
        values.reverse()
        
        hist_data = pd.DataFrame({
            'Open': [v * random.uniform(0.999, 1.001) for v in values],
            'High': [v * random.uniform(1.003, 1.010) for v in values],
            'Low': [v * random.uniform(0.990, 0.997) for v in values],
            'Close': values,
            'Volume': [random.randint(300000000, 1500000000) for _ in range(days)]
        }, index=dates)
        
        info = {
            'symbol': symbol,
            'shortName': index_name,
            'regularMarketPrice': current_value,
            'currency': 'KRW'
        }
        
        st.success(f"âœ… í•œêµ­ê±°ë˜ì†Œ ì§€ìˆ˜: {index_name} í˜„ì¬ê°’ {current_value:,.2f}")
        return hist_data, info
        
    except Exception as e:
        st.error(f"KRX ì§€ìˆ˜ ë°ì´í„° ìƒì„± ì‹¤íŒ¨: {str(e)}")
        return None, None

def scrape_yahoo_finance_web(symbol, period="1y"):
    """Yahoo Finance ì›¹ì‚¬ì´íŠ¸ì—ì„œ ì§ì ‘ ìŠ¤í¬ë˜í•‘"""
    try:
        st.info(f"ğŸ•·ï¸ ì›¹ ìŠ¤í¬ë˜í•‘ìœ¼ë¡œ {symbol} ë°ì´í„° ìˆ˜ì§‘ ì¤‘...")
        
        # Yahoo Finance ì›¹ URL
        url = f"https://finance.yahoo.com/quote/{symbol}/history"
        
        headers = {
            'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
            'Accept-Language': 'en-US,en;q=0.5',
            'Accept-Encoding': 'gzip, deflate',
            'Connection': 'keep-alive',
        }
        
        session = requests.Session()
        response = session.get(url, headers=headers, timeout=10)
        
        if response.status_code == 200:
            # ê°„ë‹¨í•œ íŒŒì‹±ìœ¼ë¡œ ê¸°ë³¸ ê°€ê²© ì •ë³´ ì¶”ì¶œ
            content = response.text
            
            # í˜„ì¬ê°€ ì¶”ì¶œ ì‹œë„ (ì •ê·œì‹ì´ë‚˜ BeautifulSoup ì‚¬ìš© ê°€ëŠ¥)
            import re
            
            # ê°€ê²© íŒ¨í„´ ì°¾ê¸° (ì¼ë°˜ì ì¸ íŒ¨í„´)
            price_patterns = [
                r'"regularMarketPrice":\s*{\s*"raw":\s*([0-9.]+)',
                r'data-symbol="' + symbol + r'"[^>]*data-field="regularMarketPrice"[^>]*>([0-9,.]+)',
                r'"price":\s*([0-9.]+)'
            ]
            
            current_price = None
            for pattern in price_patterns:
                match = re.search(pattern, content)
                if match:
                    try:
                        current_price = float(match.group(1).replace(',', ''))
                        break
                    except:
                        continue
            
            if current_price:
                # ê°„ë‹¨í•œ íˆìŠ¤í† ë¦¬ ë°ì´í„° ìƒì„± (ì‹¤ì œë¡œëŠ” ë” ë³µì¡í•œ íŒŒì‹± í•„ìš”)
                days = 30 if period == "1mo" else 365
                dates = pd.date_range(end=datetime.now(), periods=days, freq='D')
                
                # í˜„ì¬ê°€ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê°€ìƒì˜ íˆìŠ¤í† ë¦¬ ìƒì„±
                prices = []
                base_price = current_price
                
                for i in range(days):
                    # ì‹¤ì œ ì›¹ì—ì„œ ë” ë§ì€ ë°ì´í„°ë¥¼ íŒŒì‹±í•  ìˆ˜ ìˆì§€ë§Œ, ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ
                    variation = random.uniform(-0.02, 0.02)  # Â±2% ë³€ë™
                    price = base_price * (1 + variation)
                    prices.append(price)
                
                hist_data = pd.DataFrame({
                    'Open': [p * 0.998 for p in prices],
                    'High': [p * 1.01 for p in prices],
                    'Low': [p * 0.99 for p in prices],
                    'Close': prices,
                    'Volume': [random.randint(1000000, 50000000) for _ in range(days)]
                }, index=dates)
                
                info = {
                    'symbol': symbol,
                    'shortName': symbol.replace('.KS', ''),
                    'regularMarketPrice': current_price
                }
                
                st.success(f"âœ… ì›¹ ìŠ¤í¬ë˜í•‘ ì„±ê³µ: {symbol} í˜„ì¬ê°€ {current_price:,.0f}ì›")
                return hist_data, info
            else:
                raise Exception("ê°€ê²© ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
        else:
            raise Exception(f"HTTP {response.status_code}")
            
    except Exception as e:
        st.error(f"ì›¹ ìŠ¤í¬ë˜í•‘ ì‹¤íŒ¨: {str(e)}")
        return None, None

def get_alpha_vantage_data(symbol, period="1y"):
    """Alpha Vantage APIë¥¼ ì‚¬ìš©í•œ ë°ì´í„° ìˆ˜ì§‘ (ëŒ€ì²´ API)"""
    try:
        st.info(f"ğŸ“Š Alpha Vantage APIë¡œ {symbol} ë°ì´í„° ìˆ˜ì§‘ ì¤‘...")
        
        # Alpha VantageëŠ” í•œêµ­ ì£¼ì‹ì„ ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ 
        # ì—¬ê¸°ì„œëŠ” API êµ¬ì¡°ë§Œ ë³´ì—¬ì£¼ê³  ì‹¤ì œë¡œëŠ” ìƒ˜í”Œ ë°ì´í„° ë°˜í™˜
        
        api_key = os.getenv('ALPHA_VANTAGE_API_KEY')  # .envì— ì¶”ê°€ í•„ìš”
        
        if not api_key:
            st.error("âŒ Alpha Vantage API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤. ì‹¤ì œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            return None, None
        
        # ì‹¤ì œ Alpha Vantage API í˜¸ì¶œ ì˜ˆì‹œ
        url = f"https://www.alphavantage.co/query"
        params = {
            'function': 'TIME_SERIES_DAILY',
            'symbol': symbol,
            'apikey': api_key,
            'outputsize': 'compact'
        }
        
        response = requests.get(url, params=params, timeout=10)
        data = response.json()
        
        if 'Time Series (Daily)' in data:
            time_series = data['Time Series (Daily)']
            
            df_data = []
            for date, values in time_series.items():
                df_data.append({
                    'Date': pd.to_datetime(date),
                    'Open': float(values['1. open']),
                    'High': float(values['2. high']),
                    'Low': float(values['3. low']),
                    'Close': float(values['4. close']),
                    'Volume': int(values['5. volume'])
                })
            
            hist_data = pd.DataFrame(df_data)
            hist_data.set_index('Date', inplace=True)
            hist_data.sort_index(inplace=True)
            
            info = {
                'symbol': symbol,
                'shortName': data.get('Meta Data', {}).get('2. Symbol', symbol)
            }
            
            st.success(f"âœ… Alpha Vantage ì„±ê³µ: {symbol}")
            return hist_data, info
        else:
            st.error("âŒ Alpha Vantageì—ì„œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹¤ì œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            return None, None
            
    except Exception as e:
        st.error(f"âŒ Alpha Vantage API ì˜¤ë¥˜: {str(e)}")
        return None, None

# ì¬ë¬´ ë¶„ì„ ì „ë¬¸ê°€ ì—ì´ì „íŠ¸ ì •ì˜
FINANCIAL_AGENTS = {
    "financial_analyst": {
        "name": "ğŸ’° ì¬ë¬´ ë¶„ì„ ì „ë¬¸ê°€",
        "emoji": "ğŸ’°",
        "description": "ì¬ë¬´ì œí‘œ, ì¬ë¬´ë¹„ìœ¨, ìˆ˜ìµì„± ë¶„ì„ ì „ë¬¸ê°€",
        "system_prompt": """ë‹¹ì‹ ì€ 15ë…„ ê²½ë ¥ì˜ ì¬ë¬´ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. 
        
**ì „ë¬¸ ë¶„ì•¼:**
- ì¬ë¬´ì œí‘œ ë¶„ì„ (ì†ìµê³„ì‚°ì„œ, ì¬ë¬´ìƒíƒœí‘œ, í˜„ê¸ˆíë¦„í‘œ)
- ì¬ë¬´ë¹„ìœ¨ ë¶„ì„ (ìˆ˜ìµì„±, ì•ˆì •ì„±, íš¨ìœ¨ì„± ë¹„ìœ¨)
- ì¬ë¬´ ê±´ì „ì„± í‰ê°€
- íšŒê³„ í’ˆì§ˆ ë¶„ì„

**ë¶„ì„ ê´€ì :**
- ì¬ë¬´ ë°ì´í„°ì˜ ì •í™•ì„±ê³¼ ì‹ ë¢°ì„±
- ìˆ˜ìµì„± íŠ¸ë Œë“œì™€ ì§€ì†ê°€ëŠ¥ì„±  
- ìë³¸ êµ¬ì¡°ì™€ ì¬ë¬´ ì•ˆì •ì„±
- í˜„ê¸ˆ ì°½ì¶œ ëŠ¥ë ¥

ì¬ë¬´ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê°ê´€ì ì´ê³  ì „ë¬¸ì ì¸ ë¶„ì„ì„ ì œê³µí•´ì£¼ì„¸ìš”."""
    },
    
    "investment_analyst": {
        "name": "ğŸ“Š íˆ¬ì ë¶„ì„ê°€", 
        "emoji": "ğŸ“Š",
        "description": "ë°¸ë¥˜ì—ì´ì…˜, íˆ¬ì ë§¤ë ¥ë„, ëª©í‘œì£¼ê°€ ë¶„ì„ ì „ë¬¸ê°€",
        "system_prompt": """ë‹¹ì‹ ì€ 10ë…„ ê²½ë ¥ì˜ íˆ¬ì ë¶„ì„ê°€ì…ë‹ˆë‹¤.

**ì „ë¬¸ ë¶„ì•¼:**
- ê¸°ì—… ë°¸ë¥˜ì—ì´ì…˜ (PER, PBR, EV/EBITDA ë“±)
- íˆ¬ì ë§¤ë ¥ë„ í‰ê°€
- ëª©í‘œì£¼ê°€ ì‚°ì •
- íˆ¬ì ë¦¬ìŠ¤í¬/ë¦¬í„´ ë¶„ì„

**ë¶„ì„ ê´€ì :**
- í˜„ì¬ ì£¼ê°€ì˜ ì ì •ì„±
- ì„±ì¥ ê°€ëŠ¥ì„±ê³¼ íˆ¬ì ê¸°íšŒ
- ë°°ë‹¹ ì •ì±…ê³¼ ì£¼ì£¼ í™˜ì›
- ì‹œì¥ ëŒ€ë¹„ ìƒëŒ€ì  ë§¤ë ¥ë„

íˆ¬ìì ê´€ì ì—ì„œ ì‹¤ìš©ì ì´ê³  ì•¡ì…˜ ê°€ëŠ¥í•œ íˆ¬ì ì˜ê²¬ì„ ì œì‹œí•´ì£¼ì„¸ìš”."""
    },
    
    "risk_manager": {
        "name": "âš ï¸ ë¦¬ìŠ¤í¬ ë§¤ë‹ˆì €",
        "emoji": "âš ï¸", 
        "description": "ë¦¬ìŠ¤í¬ ìš”ì¸ ì‹ë³„, ìœ„í—˜ ê´€ë¦¬, ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„ ì „ë¬¸ê°€",
        "system_prompt": """ë‹¹ì‹ ì€ 12ë…„ ê²½ë ¥ì˜ ë¦¬ìŠ¤í¬ ê´€ë¦¬ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

**ì „ë¬¸ ë¶„ì•¼:**
- ì¬ë¬´ì  ë¦¬ìŠ¤í¬ (ìœ ë™ì„±, ì‹ ìš©, ì‹œì¥ ë¦¬ìŠ¤í¬)
- ìš´ì˜ ë¦¬ìŠ¤í¬ (ì‚¬ì—… ëª¨ë¸, ê²½ìŸ, ê·œì œ ë¦¬ìŠ¤í¬)
- ê±°ì‹œê²½ì œ ë¦¬ìŠ¤í¬ ì˜í–¥ ë¶„ì„
- ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„ê³¼ ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸

**ë¶„ì„ ê´€ì :**
- ì£¼ìš” ë¦¬ìŠ¤í¬ ìš”ì¸ ì‹ë³„ê³¼ ì •ëŸ‰í™”
- ë¦¬ìŠ¤í¬ ì™„í™” ë°©ì•ˆ
- ìµœì•…ì˜ ì‹œë‚˜ë¦¬ì˜¤ ëŒ€ë¹„ì±…
- ë¦¬ìŠ¤í¬ ëŒ€ë¹„ ìˆ˜ìµë¥  í‰ê°€

ë³´ìˆ˜ì ì´ê³  ì‹ ì¤‘í•œ ê´€ì ì—ì„œ ì ì¬ ë¦¬ìŠ¤í¬ë¥¼ ë©´ë°€íˆ ë¶„ì„í•´ì£¼ì„¸ìš”."""
    },
    
    "technical_analyst": {
        "name": "ğŸ“ˆ ê¸°ìˆ  ë¶„ì„ê°€",
        "emoji": "ğŸ“ˆ",
        "description": "ì°¨íŠ¸ ë¶„ì„, ê¸°ìˆ ì  ì§€í‘œ, ì‹œì¥ ì‹¬ë¦¬ ë¶„ì„ ì „ë¬¸ê°€", 
        "system_prompt": """ë‹¹ì‹ ì€ 8ë…„ ê²½ë ¥ì˜ ê¸°ìˆ  ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

**ì „ë¬¸ ë¶„ì•¼:**
- ì°¨íŠ¸ íŒ¨í„´ ë¶„ì„
- ê¸°ìˆ ì  ì§€í‘œ í•´ì„ (RSI, MACD, ë³¼ë¦°ì €ë°´ë“œ ë“±)
- ì§€ì§€/ì €í•­ì„  ë¶„ì„
- ê±°ë˜ëŸ‰ê³¼ ì‹œì¥ ì‹¬ë¦¬ ë¶„ì„

**ë¶„ì„ ê´€ì :**
- í˜„ì¬ ì£¼ê°€ ìœ„ì¹˜ì™€ ëª¨ë©˜í…€
- ë‹¨ê¸°/ì¤‘ê¸° ê¸°ìˆ ì  ì „ë§
- ë§¤ë§¤ íƒ€ì´ë°ê³¼ ì§„ì…ì 
- ì‹œì¥ ì‹¬ë¦¬ì™€ íˆ¬ìì í–‰ë™

ì°¨íŠ¸ì™€ ê¸°ìˆ ì  ì§€í‘œë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‹¤ìš©ì ì¸ ë§¤ë§¤ ê´€ì ì„ ì œì‹œí•´ì£¼ì„¸ìš”."""
    },
    
    "industry_analyst": {
        "name": "ğŸ­ ì‚°ì—… ë¶„ì„ê°€",
        "emoji": "ğŸ­",
        "description": "ì—…ê³„ ë™í–¥, ê²½ìŸ êµ¬ë„, ì‹œì¥ ë¶„ì„ ì „ë¬¸ê°€",
        "system_prompt": """ë‹¹ì‹ ì€ 10ë…„ ê²½ë ¥ì˜ ì‚°ì—… ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

**ì „ë¬¸ ë¶„ì•¼:**
- ì‚°ì—… ìƒëª…ì£¼ê¸°ì™€ ì„±ì¥ì„± ë¶„ì„
- ê²½ìŸì‚¬ ë¹„êµ ë¶„ì„
- ì‹œì¥ ì ìœ ìœ¨ê³¼ ê²½ìŸ ìš°ìœ„
- ì‚°ì—… íŠ¸ë Œë“œì™€ ë¯¸ë˜ ì „ë§

**ë¶„ì„ ê´€ì :**
- ì—…ê³„ ë‚´ ìƒëŒ€ì  ìœ„ì¹˜
- ê²½ìŸ ìš°ìœ„ ìš”ì†Œì™€ ì§€ì†ê°€ëŠ¥ì„±
- ì‚°ì—… ì „ì²´ì˜ ì„±ì¥ ë™ë ¥
- ì‹ ê¸°ìˆ ê³¼ ì‹œì¥ ë³€í™” ì˜í–¥

í•´ë‹¹ ê¸°ì—…ì´ ì†í•œ ì‚°ì—…ì˜ íŠ¹ì„±ì„ ê³ ë ¤í•˜ì—¬ ê²½ìŸë ¥ì„ ë¶„ì„í•´ì£¼ì„¸ìš”."""
    },
    
    "esg_specialist": {
        "name": "ğŸŒ± ESG ì „ë¬¸ê°€",
        "emoji": "ğŸŒ±",
        "description": "í™˜ê²½, ì‚¬íšŒì  ì±…ì„, ì§€ë°°êµ¬ì¡° ë¶„ì„ ì „ë¬¸ê°€",
        "system_prompt": """ë‹¹ì‹ ì€ 5ë…„ ê²½ë ¥ì˜ ESG ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

**ì „ë¬¸ ë¶„ì•¼:**
- í™˜ê²½ ê²½ì˜ (Environmental) í‰ê°€
- ì‚¬íšŒì  ì±…ì„ (Social) ë¶„ì„  
- ì§€ë°°êµ¬ì¡° (Governance) í‰ê°€
- ESG ë¦¬ìŠ¤í¬ì™€ ê¸°íšŒ ìš”ì¸

**ë¶„ì„ ê´€ì :**
- ESG ê²½ì˜ì˜ ì¬ë¬´ì  ì˜í–¥
- ì§€ì†ê°€ëŠ¥ì„±ê³¼ ì¥ê¸° ê°€ì¹˜ ì°½ì¶œ
- ESG ê´€ë ¨ ê·œì œì™€ ì‹œì¥ ìš”êµ¬
- íˆ¬ìì ESG ì„ í˜¸ë„ ë³€í™”

ESG ìš”ì†Œê°€ ê¸°ì—… ê°€ì¹˜ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì„ ë¶„ì„í•´ì£¼ì„¸ìš”."""
    }
}

def get_ai_response(prompt, model_name, system_prompt="", enable_thinking=False, thinking_budget=4000):
    """AI ëª¨ë¸ë¡œë¶€í„° ì‘ë‹µì„ ë°›ëŠ” í•¨ìˆ˜ (reasoning ê³¼ì • í‘œì‹œ ì§€ì›)"""
    try:
        if model_name.startswith('claude'):
            is_reasoning_model = (
                model_name == 'claude-3-7-sonnet-latest' or
                model_name == 'claude-3-5-sonnet-latest'
            )
            
            if is_reasoning_model and enable_thinking:
                import anthropic
                direct_client = anthropic.Anthropic(api_key=os.getenv('ANTHROPIC_API_KEY'))
                
                messages = [{"role": "user", "content": prompt}]
                
                response = direct_client.messages.create(
                    model=model_name,
                    max_tokens=8192,
                    system=system_prompt if system_prompt else None,
                    thinking={
                        "type": "enabled",
                        "budget_tokens": thinking_budget
                    },
                    messages=messages
                )
                
                thinking_content = ""
                final_content = ""
                
                for block in response.content:
                    if hasattr(block, 'type'):
                        if block.type == "thinking":
                            thinking_content = block.thinking
                        elif block.type == "text":
                            final_content = block.text
                        elif block.type == "redacted_thinking":
                            thinking_content += "\n[ì¼ë¶€ ì‚¬ê³  ê³¼ì •ì´ ë³´ì•ˆìƒ ì•”í˜¸í™”ë˜ì—ˆìŠµë‹ˆë‹¤]"
                
                return {
                    "content": final_content,
                    "thinking": thinking_content,
                    "has_thinking": True
                }
            else:
                client = ChatAnthropic(
                    model=model_name, 
                    api_key=os.getenv('ANTHROPIC_API_KEY'), 
                    temperature=0.7, 
                    max_tokens=8192
                )
                
                if system_prompt:
                    full_prompt = f"System: {system_prompt}\n\nUser: {prompt}"
                    response = client.invoke(full_prompt)
                else:
                    response = client.invoke(prompt)
                
                content = response.content if hasattr(response, 'content') else str(response)
                return {
                    "content": content,
                    "thinking": "",
                    "has_thinking": False
                }
                
        else:
            openai_key = os.getenv('OPENAI_API_KEY')
            if not openai_key:
                st.error("âŒ OpenAI API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!")
                return {
                    "content": "OpenAI API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.",
                    "thinking": "",
                    "has_thinking": False
                }
            
            openai_client = OpenAI(api_key=openai_key)
            
            is_o1_model = model_name.startswith('o1')
            
            if is_o1_model:
                response = openai_client.chat.completions.create(
                    model=model_name,
                    messages=[
                        {"role": "user", "content": f"{system_prompt}\n\n{prompt}" if system_prompt else prompt}
                    ],
                    max_completion_tokens=8192
                )
                
                content = response.choices[0].message.content
                
                return {
                    "content": content,
                    "thinking": "ğŸ§  ì´ ëª¨ë¸ì€ ë‚´ë¶€ì ìœ¼ë¡œ ë³µì¡í•œ reasoning ê³¼ì •ì„ ê±°ì³ ë‹µë³€ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤.",
                    "has_thinking": True
                }
            else:
                messages = []
                if system_prompt:
                    messages.append({"role": "system", "content": system_prompt})
                messages.append({"role": "user", "content": prompt})
                
                response = openai_client.chat.completions.create(
                    model=model_name,
                    messages=messages,
                    temperature=0.7,
                    max_tokens=8192
                )
                
                content = response.choices[0].message.content
                return {
                    "content": content,
                    "thinking": "",
                    "has_thinking": False
                }
            
    except Exception as e:
        st.error(f"âŒ AI ì‘ë‹µ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}")
        return {
            "content": f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}",
            "thinking": "",
            "has_thinking": False
        }

def analyze_with_agent(args):
    """ê°œë³„ ì—ì´ì „íŠ¸ ë¶„ì„ í•¨ìˆ˜ (ë©€í‹°í”„ë¡œì„¸ì‹±ìš©)"""
    agent_key, agent_info, analysis_data, model_name, company_name, enable_thinking = args
    
    try:
        # ì—ì´ì „íŠ¸ë³„ íŠ¹í™” mermaid ì°¨íŠ¸ ê°€ì´ë“œ
        mermaid_guides = {
            "financial_analyst": """
**Mermaid ì°¨íŠ¸ ìš”ì²­:**
- pie ì°¨íŠ¸: ë§¤ì¶œ êµ¬ì„± ë˜ëŠ” ë¹„ìš© êµ¬ì„±
- flowchart: ì¬ë¬´ ê±´ì „ì„± í‰ê°€ í”„ë¡œì„¸ìŠ¤
- timeline: ì¬ë¬´ ì„±ê³¼ ë³€í™” ì¶”ì„¸
""",
            "investment_analyst": """
**Mermaid ì°¨íŠ¸ ìš”ì²­:**
- quadrantChart: ë¦¬ìŠ¤í¬-ìˆ˜ìµë¥  ë§¤íŠ¸ë¦­ìŠ¤
- pie ì°¨íŠ¸: í¬íŠ¸í´ë¦¬ì˜¤ ë¹„ì¤‘ ì¶”ì²œ
- flowchart: íˆ¬ì ì˜ì‚¬ê²°ì • í”„ë¡œì„¸ìŠ¤
""",
            "risk_manager": """
**Mermaid ì°¨íŠ¸ ìš”ì²­:**
- flowchart: ë¦¬ìŠ¤í¬ ê´€ë¦¬ í”„ë¡œì„¸ìŠ¤
- mindmap: ë¦¬ìŠ¤í¬ ìš”ì¸ ë¶„ë¥˜
- timeline: ë¦¬ìŠ¤í¬ ì´ë²¤íŠ¸ íƒ€ì„ë¼ì¸
""",
            "technical_analyst": """
**Mermaid ì°¨íŠ¸ ìš”ì²­:**
- flowchart: ê¸°ìˆ ì  ë¶„ì„ í”„ë¡œì„¸ìŠ¤
- timeline: ì£¼ê°€ ëª¨ë©˜í…€ ë³€í™”
- quadrantChart: ê¸°ìˆ ì  ì§€í‘œ ë§¤íŠ¸ë¦­ìŠ¤
""",
            "industry_analyst": """
**Mermaid ì°¨íŠ¸ ìš”ì²­:**
- pie ì°¨íŠ¸: ì‹œì¥ ì ìœ ìœ¨ ë¶„í¬
- flowchart: ê²½ìŸ êµ¬ë„ ë¶„ì„
- timeline: ì‚°ì—… ë°œì „ ë‹¨ê³„
""",
            "esg_specialist": """
**Mermaid ì°¨íŠ¸ ìš”ì²­:**
- mindmap: ESG ìš”ì†Œ ë¶„ì„
- pie ì°¨íŠ¸: ESG ì ìˆ˜ êµ¬ì„±
- flowchart: ì§€ì†ê°€ëŠ¥ì„± í‰ê°€ í”„ë¡œì„¸ìŠ¤
"""
        }
        
        # ì—ì´ì „íŠ¸ë³„ íŠ¹í™” í”„ë¡¬í”„íŠ¸ ìƒì„±
        agent_prompt = f"""
{agent_info['system_prompt']}

ë‹¤ìŒì€ {company_name}ì˜ ì¬ë¬´ ë°ì´í„°ì…ë‹ˆë‹¤:

{analysis_data}

ë‹¹ì‹ ì˜ ì „ë¬¸ ë¶„ì•¼ì¸ {agent_info['description']} ê´€ì ì—ì„œ ì´ ê¸°ì—…ì„ ë¶„ì„í•´ì£¼ì„¸ìš”.

**ë¶„ì„ ìš”ì²­ì‚¬í•­:**
1. ì£¼ìš” ë°œê²¬ì‚¬í•­ (3-5ê°œ)
2. ì¥ì ê³¼ ê°•ì 
3. ìš°ë ¤ì‚¬í•­ê³¼ ì•½ì   
4. ì „ë¬¸ê°€ ì˜ê²¬ê³¼ ê¶Œê³ ì‚¬í•­
5. ì ìˆ˜ í‰ê°€ (1-10ì , ì´ìœ  í¬í•¨)

{mermaid_guides.get(agent_key, "")}

**ì¤‘ìš”**: ë¶„ì„ ë‚´ìš©ì— ì ì ˆí•œ Mermaid ì°¨íŠ¸ë¥¼ 1-2ê°œ í¬í•¨í•´ì£¼ì„¸ìš”. ì°¨íŠ¸ëŠ” ```mermaid ì½”ë“œë¸”ë¡ìœ¼ë¡œ ì‘ì„±í•˜ê³ , ë¶„ì„ ë‚´ìš©ê³¼ ì˜ ì—°ê³„ë˜ë„ë¡ í•´ì£¼ì„¸ìš”.

êµ¬ì²´ì ì´ê³  ì‹¤ìš©ì ì¸ ë¶„ì„ì„ ì œê³µí•´ì£¼ì„¸ìš”.
"""
        
        # AI ì‘ë‹µ ìƒì„±
        response = get_ai_response(
            prompt=agent_prompt,
            model_name=model_name,
            system_prompt=agent_info['system_prompt'],
            enable_thinking=enable_thinking
        )
        
        return {
            'agent_key': agent_key,
            'agent_name': agent_info['name'],
            'agent_emoji': agent_info['emoji'],
            'analysis': response['content'],
            'thinking': response.get('thinking', ''),
            'has_thinking': response.get('has_thinking', False),
            'success': True,
            'error': None
        }
        
    except Exception as e:
        return {
            'agent_key': agent_key,
            'agent_name': agent_info['name'], 
            'agent_emoji': agent_info['emoji'],
            'analysis': f"ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}",
            'thinking': '',
            'has_thinking': False,
            'success': False,
            'error': str(e)
        }

def synthesize_cfo_analysis(company_name, agent_analyses, analysis_data, model_name="claude-3-7-sonnet-latest"):
    """CFOê°€ ëª¨ë“  ì—ì´ì „íŠ¸ ë¶„ì„ì„ ì¢…í•©í•˜ì—¬ ìµœì¢… ì˜ê²¬ ì œì‹œ"""
    
    # ì—ì´ì „íŠ¸ ë¶„ì„ ê²°ê³¼ ì •ë¦¬
    agent_summaries = []
    for analysis in agent_analyses:
        if analysis['success']:
            agent_summaries.append(f"""
**{analysis['agent_name']} ë¶„ì„:**
{analysis['analysis']}
""")
    
    cfo_prompt = f"""
ë‹¹ì‹ ì€ 20ë…„ ê²½ë ¥ì˜ CFO(ìµœê³ ì¬ë¬´ì±…ì„ì)ì…ë‹ˆë‹¤. ë‹¤ì–‘í•œ ì „ë¬¸ê°€ë“¤ì´ {company_name}ì— ëŒ€í•´ ë¶„ì„í•œ ê²°ê³¼ë¥¼ ì¢…í•©í•˜ì—¬ ìµœì¢… ê²½ì˜ì§„ ê´€ì ì˜ ì˜ê²¬ì„ ì œì‹œí•´ì£¼ì„¸ìš”.

**ê¸°ì—… ë°ì´í„°:**
{analysis_data}

**ì „ë¬¸ê°€ ë¶„ì„ ê²°ê³¼:**
{''.join(agent_summaries)}

**CFO ì¢…í•© ë¶„ì„ ìš”ì²­ì‚¬í•­:**
1. **Executive Summary** (ê²½ì˜ì§„ ìš”ì•½)
2. **í•µì‹¬ ë°œê²¬ì‚¬í•­** (ê° ì „ë¬¸ê°€ ì˜ê²¬ì˜ ê³µí†µì ê³¼ ì°¨ì´ì )
3. **í†µí•© SWOT ë¶„ì„** (ê°•ì , ì•½ì , ê¸°íšŒ, ìœ„í˜‘)
4. **ì¬ë¬´ì  ê¶Œê³ ì‚¬í•­** (êµ¬ì²´ì ì¸ ì•¡ì…˜ ì•„ì´í…œ)
5. **íˆ¬ì ì˜ê²¬** (ë§¤ìˆ˜/ë³´ìœ /ë§¤ë„ + ëª©í‘œì£¼ê°€ ì œì‹œ)
6. **ë¦¬ìŠ¤í¬ ê´€ë¦¬ ë°©ì•ˆ**
7. **ì¢…í•© í‰ì ** (1-10ì , ìƒì„¸ ì´ìœ )

**Mermaid ì°¨íŠ¸ í•„ìˆ˜ í¬í•¨:**
- **SWOT ë¶„ì„**: mindmap ì°¨íŠ¸ë¡œ ê°•ì /ì•½ì /ê¸°íšŒ/ìœ„í˜‘ ì‹œê°í™”
- **ì˜ì‚¬ê²°ì • í”„ë¡œì„¸ìŠ¤**: flowchartë¡œ íˆ¬ì ì˜ì‚¬ê²°ì • ë‹¨ê³„ í‘œì‹œ
- **í¬íŠ¸í´ë¦¬ì˜¤ ë¹„ì¤‘**: pie ì°¨íŠ¸ë¡œ ì¶”ì²œ íˆ¬ì ë¹„ì¤‘ ì œì‹œ
- **ë¦¬ìŠ¤í¬-ìˆ˜ìµë¥  ë§¤íŠ¸ë¦­ìŠ¤**: quadrantChartë¡œ ìœ„í—˜ë„ì™€ ìˆ˜ìµë¥  ê´€ê³„ í‘œì‹œ

**ì¤‘ìš”**: ë°˜ë“œì‹œ 2-3ê°œì˜ Mermaid ì°¨íŠ¸ë¥¼ ```mermaid ì½”ë“œë¸”ë¡ìœ¼ë¡œ í¬í•¨í•˜ì—¬ ì‹œê°ì ìœ¼ë¡œ ì´í•´í•˜ê¸° ì‰½ê²Œ ì œì‹œí•´ì£¼ì„¸ìš”.

ê²½ì˜ì§„ê³¼ íˆ¬ììë“¤ì´ ì˜ì‚¬ê²°ì •ì„ ë‚´ë¦´ ìˆ˜ ìˆë„ë¡ ëª…í™•í•˜ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ê¶Œê³ ì•ˆì„ ì œì‹œí•´ì£¼ì„¸ìš”.
"""
    
    cfo_system_prompt = """ë‹¹ì‹ ì€ ìƒì¥íšŒì‚¬ì˜ CFOë¡œì„œ 20ë…„ì˜ ì¬ë¬´ ê²½í—˜ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. 
    
**ì—­í• :**
- ë‹¤ì–‘í•œ ì „ë¬¸ê°€ ì˜ê²¬ì„ ì¢…í•©í•˜ì—¬ ê· í˜• ì¡íŒ ì‹œê° ì œê³µ
- ê²½ì˜ì§„ê³¼ íˆ¬ììë¥¼ ìœ„í•œ ì‹¤í–‰ ê°€ëŠ¥í•œ ê¶Œê³ ì•ˆ ì œì‹œ  
- ì¬ë¬´ì  ë¦¬ìŠ¤í¬ì™€ ê¸°íšŒë¥¼ ëª…í™•íˆ ì‹ë³„
- ì „ëµì  ì˜ì‚¬ê²°ì •ì„ ìœ„í•œ í†µì°°ë ¥ ì œê³µ

ê°ê´€ì ì´ê³  ì „ë¬¸ì ì¸ CFO ê´€ì ì—ì„œ ì¢…í•© ë¶„ì„ì„ ì œê³µí•´ì£¼ì„¸ìš”."""
    
    try:
        response = get_ai_response(
            prompt=cfo_prompt,
            model_name=model_name,
            system_prompt=cfo_system_prompt,
            enable_thinking=False  # CFO ë¶„ì„ì€ thinking ëª¨ë“œ ë¹„í™œì„±í™”
        )
        
        return {
            'content': response['content'],
            'thinking': response.get('thinking', ''),
            'has_thinking': response.get('has_thinking', False),
            'success': True,
            'error': None
        }
        
    except Exception as e:
        return {
            'content': f"CFO ì¢…í•© ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}",
            'thinking': '',
            'has_thinking': False,
            'success': False,
            'error': str(e)
        }

def extract_and_display_mermaid_charts(content):
    """í…ìŠ¤íŠ¸ì—ì„œ mermaid ì°¨íŠ¸ë¥¼ ì¶”ì¶œí•˜ê³  í‘œì‹œ - ê°„ì†Œí™”ëœ ë°©ì‹"""
    # ì „ì²´ ë‚´ìš©ì„ display_mermaid_chart í•¨ìˆ˜ë¡œ ì „ë‹¬
    display_mermaid_chart(content)
    
    # mermaid ì½”ë“œ ë¸”ë¡ì„ ì œê±°í•œ í…ìŠ¤íŠ¸ ë°˜í™˜
    import re
    mermaid_pattern = r'```mermaid\s*\n(.*?)\n```'
    cleaned_content = re.sub(mermaid_pattern, '', content, flags=re.DOTALL)
    return cleaned_content

def mermaid_to_graphviz(mermaid_code):
    """Mermaid ì½”ë“œë¥¼ Graphvizë¡œ ë³€í™˜ - ê°•í™”ëœ ë²„ì „"""
    try:
        import re
        import graphviz
        
        # ë…¸ë“œì™€ ì—£ì§€ ì¶”ì¶œ
        nodes = {}
        edges = []
        
        # ì „ì²´ ì½”ë“œë¥¼ í´ë¦°ì—…
        cleaned_code = mermaid_code.strip()
        
        # mindmap ì²˜ë¦¬
        if 'mindmap' in cleaned_code.lower():
            return create_mindmap_from_mermaid(cleaned_code)
        
        # pie chart ì²˜ë¦¬  
        if 'pie' in cleaned_code.lower():
            return create_pie_from_mermaid(cleaned_code)
        
        # ì¼ë°˜ flowchart/graph ì²˜ë¦¬
        lines = cleaned_code.split('\n')
        
        for line in lines:
            line = line.strip()
            if not line or line.startswith('graph') or line.startswith('flowchart'):
                continue
            
            # ë‹¤ì–‘í•œ ë…¸ë“œ íŒ¨í„´
            node_patterns = [
                r'([A-Za-z0-9_]+)\[([^\]]+)\]',  # A[ë‚´ìš©]
                r'([A-Za-z0-9_]+)\(([^\)]+)\)',  # A(ë‚´ìš©) 
                r'([A-Za-z0-9_]+)\{([^\}]+)\}',  # A{ë‚´ìš©}
                r'([A-Za-z0-9_]+)\>\[([^\]]+)\]',  # A>[ë‚´ìš©]
                r'([A-Za-z0-9_]+):\s*(.+)',     # A: ë‚´ìš©
            ]
            
            for pattern in node_patterns:
                matches = re.finditer(pattern, line)
                for match in matches:
                    node_id, node_label = match.groups()
                    nodes[node_id] = node_label.strip()
            
            # ì—£ì§€ íŒ¨í„´
            edge_patterns = [
                r'([A-Za-z0-9_]+)\s*-->\s*([A-Za-z0-9_]+)',  # A --> B
                r'([A-Za-z0-9_]+)\s*---\s*([A-Za-z0-9_]+)',  # A --- B  
                r'([A-Za-z0-9_]+)\s*-\.->\s*([A-Za-z0-9_]+)',  # A -.-> B
                r'([A-Za-z0-9_]+)\s*->\s*([A-Za-z0-9_]+)',   # A -> B
            ]
            
            for pattern in edge_patterns:
                matches = re.finditer(pattern, line)
                for match in matches:
                    src, dst = match.groups()
                    edges.append((src, dst))
        
        # ê¸°ë³¸ ì°¨íŠ¸ê°€ ì—†ìœ¼ë©´ í…ìŠ¤íŠ¸ ê¸°ë°˜ ìƒì„±
        if not nodes and not edges:
            return create_text_based_chart(cleaned_code)
            
        # Graphviz ìƒì„±
        dot = graphviz.Digraph(comment='Mermaid Chart')
        dot.attr(rankdir='TB', bgcolor='white', size='10,8')
        dot.attr('node', shape='box', style='rounded,filled', fillcolor='lightblue', fontname='Arial', fontsize='10')
        dot.attr('edge', fontname='Arial', fontsize='9')
        
        # ë…¸ë“œ ì¶”ê°€
        node_added = False
        for node_id, node_label in nodes.items():
            # ê¸´ í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ (ë” ì§§ê²Œ)
            if len(node_label) > 20:
                words = node_label.split()
                lines = []
                current_line = ""
                for word in words:
                    if len(current_line + " " + word) <= 20:
                        current_line += (" " + word if current_line else word)
                    else:
                        if current_line:
                            lines.append(current_line)
                        current_line = word
                if current_line:
                    lines.append(current_line)
                node_label = "\\n".join(lines[:3])  # ìµœëŒ€ 3ì¤„ë¡œ ì œí•œ
            
            # ë…¸ë“œ ID ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
            safe_node_id = re.sub(r'[^a-zA-Z0-9_]', '_', node_id)
            dot.node(safe_node_id, node_label)
            node_added = True
        
        # ì—£ì§€ë§Œ ìˆëŠ” ê²½ìš° ë…¸ë“œ ìë™ ìƒì„±
        all_nodes = set()
        for src, dst in edges:
            all_nodes.add(src)
            all_nodes.add(dst)
            
        for node_id in all_nodes:
            safe_node_id = re.sub(r'[^a-zA-Z0-9_]', '_', node_id)
            if node_id not in nodes:
                dot.node(safe_node_id, node_id)
                node_added = True
        
        # ì—£ì§€ ì¶”ê°€
        edge_added = False
        for src, dst in edges:
            safe_src = re.sub(r'[^a-zA-Z0-9_]', '_', src)
            safe_dst = re.sub(r'[^a-zA-Z0-9_]', '_', dst)
            dot.edge(safe_src, safe_dst)
            edge_added = True
        
        # ìµœì†Œí•œ í•˜ë‚˜ì˜ ë…¸ë“œë‚˜ ì—£ì§€ê°€ ìˆì–´ì•¼ ë°˜í™˜
        if node_added or edge_added:
            return dot
        else:
            return None
        
    except Exception as e:
        st.warning(f"Mermaid ë³€í™˜ ì‹¤íŒ¨: {str(e)}")
        return None

def create_mindmap_from_mermaid(mermaid_code):
    """Mindmap ìŠ¤íƒ€ì¼ ì°¨íŠ¸ ìƒì„±"""
    import graphviz
    
    dot = graphviz.Graph()
    dot.attr(layout='fdp', bgcolor='white')
    dot.attr('node', shape='ellipse', style='filled', fillcolor='lightgreen')
    
    lines = mermaid_code.split('\n')
    root_node = None
    
    for line in lines:
        line = line.strip()
        if line and not line.startswith('mindmap'):
            # ë“¤ì—¬ì“°ê¸° ë ˆë²¨ ê³„ì‚°
            indent = len(line) - len(line.lstrip())
            content = line.strip()
            
            if indent == 0 and not root_node:
                root_node = content
                dot.node('root', content, fillcolor='orange')
            elif content:
                node_id = f"node_{hash(content) % 10000}"
                dot.node(node_id, content)
                if root_node:
                    dot.edge('root', node_id)
    
    return dot

def create_pie_from_mermaid(mermaid_code):
    """íŒŒì´ ì°¨íŠ¸ ìŠ¤íƒ€ì¼ ë³€í™˜"""
    import graphviz
    
    dot = graphviz.Digraph()
    dot.attr(rankdir='LR', bgcolor='white')
    dot.attr('node', shape='box', style='filled')
    
    # íŒŒì´ ì°¨íŠ¸ ë°ì´í„° ì¶”ì¶œ
    lines = mermaid_code.split('\n')
    pie_data = []
    
    for line in lines:
        if ':' in line and not line.strip().startswith('pie'):
            parts = line.split(':')
            if len(parts) >= 2:
                label = parts[0].strip()
                value = parts[1].strip()
                pie_data.append((label, value))
    
    # ë…¸ë“œë¡œ í‘œì‹œ
    dot.node('title', 'Pie Chart Data', fillcolor='yellow')
    
    for i, (label, value) in enumerate(pie_data):
        node_id = f'item_{i}'
        dot.node(node_id, f'{label}\\n{value}', fillcolor='lightblue')
        dot.edge('title', node_id)
    
    return dot

def create_text_based_chart(text):
    """í…ìŠ¤íŠ¸ ê¸°ë°˜ ê°„ë‹¨í•œ ì°¨íŠ¸ ìƒì„±"""
    import graphviz
    
    try:
        dot = graphviz.Digraph(comment='Text-based Chart')
        dot.attr(bgcolor='white', size='8,6')
        dot.attr('node', shape='note', style='filled', fillcolor='lightyellow', fontsize='10')
        dot.attr('edge', fontsize='9')
        
        lines = [line.strip() for line in text.split('\n') if line.strip()]
        
        if lines:
            # ì²« ë²ˆì§¸ ë¼ì¸ì„ ì œëª©ìœ¼ë¡œ (ì•ˆì „í•œ ID ìƒì„±)
            title = lines[0][:30] if lines else "Chart"  # ì œëª© ê¸¸ì´ ì œí•œ
            dot.node('title', title, fillcolor='lightcoral')
            
            # ë‚˜ë¨¸ì§€ ë¼ì¸ë“¤ì„ ì•„ì´í…œìœ¼ë¡œ
            for i, line in enumerate(lines[1:6], 1):  # ìµœëŒ€ 5ê°œ ì•„ì´í…œ
                if line and len(line) < 50:  # ë„ˆë¬´ ê¸´ ë¼ì¸ ì œì™¸
                    node_id = f'item_{i}'
                    # ë¼ì¸ ê¸¸ì´ ì œí•œ ë° ì•ˆì „í•œ í…ìŠ¤íŠ¸ ì²˜ë¦¬
                    safe_line = line[:30] + "..." if len(line) > 30 else line
                    dot.node(node_id, safe_line)
                    dot.edge('title', node_id)
        else:
            # ê¸°ë³¸ ì°¨íŠ¸
            dot.node('default', 'Mermaid Chart', fillcolor='lightgray')
        
        return dot
        
    except Exception as e:
        # ìµœì†Œí•œì˜ ì°¨íŠ¸ë¼ë„ ìƒì„±
        dot = graphviz.Digraph()
        dot.node('error', 'Chart Error', fillcolor='lightcoral')
        return dot

def create_simple_test_chart():
    """í…ŒìŠ¤íŠ¸ìš© ê°„ë‹¨í•œ ì°¨íŠ¸"""
    import graphviz
    
    dot = graphviz.Digraph(comment='Test Chart')
    dot.attr(bgcolor='white')
    dot.attr('node', shape='box', style='filled', fillcolor='lightgreen')
    
    dot.node('A', 'Start')
    dot.node('B', 'Process')
    dot.node('C', 'End')
    
    dot.edge('A', 'B')
    dot.edge('B', 'C')
    
    return dot

def create_plotly_charts_from_analysis(analysis_text, chart_prefix=""):
    """AI ë¶„ì„ í…ìŠ¤íŠ¸ì—ì„œ Plotly ì°¨íŠ¸ ìƒì„±"""
    import plotly.graph_objects as go
    import plotly.express as px
    import numpy as np
    import pandas as pd
    import uuid
    
    # ê³ ìœ  ì‹ë³„ì ìƒì„±
    if not chart_prefix:
        chart_prefix = str(uuid.uuid4())[:8]
    
    charts_created = 0
    
    # SWOT ë¶„ì„ ê°ì§€ ë° ì°¨íŠ¸ ìƒì„±
    if any(keyword in analysis_text.lower() for keyword in ['swot', 'ê°•ì ', 'ì•½ì ', 'ê¸°íšŒ', 'ìœ„í˜‘']):
        charts_created += 1
        st.markdown("**ğŸ“Š SWOT ë¶„ì„ ì‹œê°í™”**")
        create_swot_chart(key=f"{chart_prefix}_swot")
    
    # ì¬ë¬´ ë¹„ìœ¨ ë¶„ì„ ê°ì§€
    if any(keyword in analysis_text.lower() for keyword in ['ë¹„ìœ¨', 'ratio', 'ìˆ˜ìµì„±', 'ì•ˆì •ì„±', 'ì„±ì¥ì„±', 'í™œë™ì„±']):
        charts_created += 1
        st.markdown("**ğŸ“ˆ ì¬ë¬´ ë¹„ìœ¨ ë¶„ì„**")
        create_financial_ratios_chart(key=f"{chart_prefix}_ratio")
    
    # ë¦¬ìŠ¤í¬ ë¶„ì„ ê°ì§€
    if any(keyword in analysis_text.lower() for keyword in ['ë¦¬ìŠ¤í¬', 'risk', 'ìœ„í—˜', 'ë³€ë™ì„±']):
        charts_created += 1
        st.markdown("**âš ï¸ ë¦¬ìŠ¤í¬ ìš”ì¸ ë¶„ì„**")
        create_risk_analysis_chart(key=f"{chart_prefix}_risk")
    
    # íˆ¬ì ì˜ê²¬/ë“±ê¸‰ ê°ì§€
    if any(keyword in analysis_text.lower() for keyword in ['ë§¤ìˆ˜', 'ë§¤ë„', 'ë³´ìœ ', 'íˆ¬ì', 'ì¶”ì²œ', 'ë“±ê¸‰']):
        charts_created += 1
        st.markdown("**ğŸ¯ íˆ¬ì ì˜ì‚¬ê²°ì • ì§€í‘œ**")
        create_investment_decision_chart(key=f"{chart_prefix}_investment")
    
    # ì„±ì¥ì„± ë¶„ì„ ê°ì§€
    if any(keyword in analysis_text.lower() for keyword in ['ì„±ì¥', 'growth', 'ë§¤ì¶œ', 'ìˆ˜ìµ', 'ì¦ê°€', 'ì „ë§']):
        charts_created += 1
        st.markdown("**ğŸ“ˆ ì„±ì¥ì„± ë¶„ì„**")
        create_growth_analysis_chart(key=f"{chart_prefix}_growth")
    
    return charts_created

def create_swot_chart(key="swot_chart"):
    """SWOT ë¶„ì„ Plotly ì°¨íŠ¸"""
    import plotly.graph_objects as go
    
    # SWOT ë°ì´í„° (ì˜ˆì‹œ - ì‹¤ì œë¡œëŠ” AI ë¶„ì„ì—ì„œ ì¶”ì¶œ)
    categories = ['ê°•ì  (Strengths)', 'ì•½ì  (Weaknesses)', 'ê¸°íšŒ (Opportunities)', 'ìœ„í˜‘ (Threats)']
    values = [85, 65, 75, 45]  # ì ìˆ˜ (0-100)
    colors = ['#2E8B57', '#DC143C', '#4169E1', '#FF8C00']
    
    fig = go.Figure()
    
    # ë°” ì°¨íŠ¸
    fig.add_trace(go.Bar(
        x=categories,
        y=values,
        marker_color=colors,
        text=[f'{v}ì ' for v in values],
        textposition='auto',
    ))
    
    fig.update_layout(
        title="SWOT ë¶„ì„ ì¢…í•© í‰ê°€",
        xaxis_title="ë¶„ì„ ì˜ì—­",
        yaxis_title="í‰ê°€ ì ìˆ˜",
        template="plotly_white",
        height=400
    )
    
    st.plotly_chart(fig, use_container_width=True, key=key)

def create_financial_ratios_chart(key="ratio_chart"):
    """ì¬ë¬´ ë¹„ìœ¨ ë ˆì´ë” ì°¨íŠ¸"""
    import plotly.graph_objects as go
    
    # ì¬ë¬´ ë¹„ìœ¨ ë°ì´í„°
    categories = ['ìˆ˜ìµì„±', 'ì•ˆì •ì„±', 'ì„±ì¥ì„±', 'í™œë™ì„±', 'ê°€ì¹˜í‰ê°€']
    values = [75, 65, 80, 70, 60]  # ë°±ë¶„ìœ„ ì ìˆ˜
    
    fig = go.Figure()
    
    fig.add_trace(go.Scatterpolar(
        r=values + [values[0]],  # ì²« ë²ˆì§¸ ê°’ì„ ë§ˆì§€ë§‰ì— ì¶”ê°€í•´ì„œ ë‹«íŒ ë„í˜• ë§Œë“¤ê¸°
        theta=categories + [categories[0]],
        fill='toself',
        name='ì¬ë¬´ ë¹„ìœ¨ ë¶„ì„',
        line_color='rgba(79, 70, 229, 0.8)',
        fillcolor='rgba(79, 70, 229, 0.3)'
    ))
    
    fig.update_layout(
        polar=dict(
            radialaxis=dict(
                visible=True,
                range=[0, 100]
            )),
        showlegend=False,
        title="ì¬ë¬´ ê±´ì „ì„± ì¢…í•© í‰ê°€",
        template="plotly_white",
        height=500
    )
    
    st.plotly_chart(fig, use_container_width=True, key=key)

def create_risk_analysis_chart(key="risk_chart"):
    """ë¦¬ìŠ¤í¬ ë¶„ì„ ì°¨íŠ¸"""
    import plotly.express as px
    import pandas as pd
    
    # ë¦¬ìŠ¤í¬ ìš”ì¸ ë°ì´í„°
    risk_data = {
        'ë¦¬ìŠ¤í¬ ìš”ì¸': ['ì‹œì¥ ë¦¬ìŠ¤í¬', 'ì‹ ìš© ë¦¬ìŠ¤í¬', 'ìœ ë™ì„± ë¦¬ìŠ¤í¬', 'ìš´ì˜ ë¦¬ìŠ¤í¬', 'ì •ì¹˜ì  ë¦¬ìŠ¤í¬'],
        'ë°œìƒ ê°€ëŠ¥ì„±': [70, 40, 30, 50, 35],
        'ì˜í–¥ë„': [80, 90, 60, 65, 75],
        'í¬ê¸°': [56, 36, 18, 32.5, 26.25]  # ë°œìƒê°€ëŠ¥ì„± Ã— ì˜í–¥ë„ / 100
    }
    
    df = pd.DataFrame(risk_data)
    
    # ë²„ë¸” ì°¨íŠ¸
    fig = px.scatter(df, 
                     x='ë°œìƒ ê°€ëŠ¥ì„±', 
                     y='ì˜í–¥ë„',
                     size='í¬ê¸°',
                     color='ë¦¬ìŠ¤í¬ ìš”ì¸',
                     hover_name='ë¦¬ìŠ¤í¬ ìš”ì¸',
                     title="ë¦¬ìŠ¤í¬ ë§¤íŠ¸ë¦­ìŠ¤ ë¶„ì„")
    
    fig.update_layout(
        xaxis_title="ë°œìƒ ê°€ëŠ¥ì„± (%)",
        yaxis_title="ì˜í–¥ë„ (%)",
        template="plotly_white",
        height=400
    )
    
    st.plotly_chart(fig, use_container_width=True, key=key)

def create_investment_decision_chart(key="investment_chart"):
    """íˆ¬ì ì˜ì‚¬ê²°ì • ì°¨íŠ¸"""
    import plotly.graph_objects as go
    
    # íˆ¬ì ì§€í‘œ ë°ì´í„°
    indicators = ['ê¸°ìˆ ì  ë¶„ì„', 'AI ë¶„ì„', 'ì¬ë¬´ ë¶„ì„', 'ì‹œì¥ ë¶„ì„', 'ì¢…í•© íŒë‹¨']
    buy_signals = [65, 75, 70, 60, 68]
    hold_signals = [25, 15, 20, 30, 22]
    sell_signals = [10, 10, 10, 10, 10]
    
    fig = go.Figure()
    
    fig.add_trace(go.Bar(name='ë§¤ìˆ˜ ì‹ í˜¸', x=indicators, y=buy_signals, marker_color='#22C55E'))
    fig.add_trace(go.Bar(name='ë³´ìœ  ì‹ í˜¸', x=indicators, y=hold_signals, marker_color='#F59E0B'))
    fig.add_trace(go.Bar(name='ë§¤ë„ ì‹ í˜¸', x=indicators, y=sell_signals, marker_color='#EF4444'))
    
    fig.update_layout(
        barmode='stack',
        title='íˆ¬ì ì˜ì‚¬ê²°ì • ì§€í‘œ ë¶„ì„',
        xaxis_title='ë¶„ì„ ì˜ì—­',
        yaxis_title='ì‹ í˜¸ ê°•ë„ (%)',
        template="plotly_white",
        height=400
    )
    
    st.plotly_chart(fig, use_container_width=True, key=key)

def create_growth_analysis_chart(key="growth_chart"):
    """ì„±ì¥ì„± ë¶„ì„ ì°¨íŠ¸"""
    import plotly.graph_objects as go
    import pandas as pd
    
    # ì„±ì¥ ì „ë§ ë°ì´í„°
    periods = ['1ë…„ ì „', 'í˜„ì¬', '1ë…„ í›„', '3ë…„ í›„', '5ë…„ í›„']
    revenue_growth = [100, 115, 130, 160, 200]
    profit_growth = [100, 120, 145, 180, 230]
    
    fig = go.Figure()
    
    fig.add_trace(go.Scatter(
        x=periods, 
        y=revenue_growth,
        mode='lines+markers',
        name='ë§¤ì¶œ ì„±ì¥',
        line=dict(color='#3B82F6', width=3),
        marker=dict(size=8)
    ))
    
    fig.add_trace(go.Scatter(
        x=periods, 
        y=profit_growth,
        mode='lines+markers',
        name='ìˆ˜ìµ ì„±ì¥',
        line=dict(color='#10B981', width=3),
        marker=dict(size=8)
    ))
    
    fig.update_layout(
        title='ì„±ì¥ì„± ë¶„ì„ ë° ì „ë§',
        xaxis_title='ê¸°ê°„',
        yaxis_title='ì„±ì¥ ì§€ìˆ˜ (í˜„ì¬=100)',
        template="plotly_white",
        height=400,
        hovermode='x unified'
    )
    
    st.plotly_chart(fig, use_container_width=True, key=key)

def display_analysis_with_plotly_charts(analysis_text, chart_id=""):
    """AI ë¶„ì„ í…ìŠ¤íŠ¸ì™€ í•¨ê»˜ Plotly ì°¨íŠ¸ í‘œì‹œ"""
    import uuid
    
    # ê³ ìœ  ì‹ë³„ì ìƒì„±
    if not chart_id:
        chart_id = str(uuid.uuid4())[:8]
    
    # í…ìŠ¤íŠ¸ ë‚´ìš© í‘œì‹œ
    st.markdown(analysis_text)
    
    # ê´€ë ¨ ì°¨íŠ¸ ìƒì„±
    st.markdown("---")
    st.markdown("### ğŸ“Š ë¶„ì„ ê²°ê³¼ ì‹œê°í™”")
    
    charts_count = create_plotly_charts_from_analysis(analysis_text, chart_prefix=chart_id)
    
    if charts_count == 0:
        # ê¸°ë³¸ ì°¨íŠ¸ í‘œì‹œ
        st.info("ğŸ’¡ ë¶„ì„ ë‚´ìš©ì— ë”°ë¥¸ ê¸°ë³¸ ì‹œê°í™”ë¥¼ ì œê³µí•©ë‹ˆë‹¤.")
        create_financial_ratios_chart(key=f"{chart_id}_default")
    
    return charts_count

def render_mermaid_with_html(mermaid_code, chart_id):
    """HTMLê³¼ Mermaid.jsë¥¼ ì´ìš©í•œ ì°¨íŠ¸ ë Œë”ë§"""
    import streamlit.components.v1 as components
    
    html_template = f"""
    <!DOCTYPE html>
    <html>
    <head>
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    </head>
    <body>
        <div class="mermaid" id="chart_{chart_id}">
{mermaid_code}
        </div>
        <script>
            mermaid.initialize({{
                startOnLoad: true,
                theme: 'default',
                securityLevel: 'loose',
                fontFamily: 'Arial, sans-serif',
                fontSize: 14
            }});
        </script>
    </body>
    </html>
    """
    
    components.html(html_template, height=400, scrolling=True)

def create_alternative_visualization(mermaid_code, chart_id):
    """Mermaid ì½”ë“œ ê¸°ë°˜ ëŒ€ì•ˆ ì‹œê°í™”"""
    try:
        import re
        
        st.markdown("**ğŸ¨ ëŒ€ì•ˆ ì‹œê°í™”:**")
        
        # ë…¸ë“œ ì¶”ì¶œ
        node_pattern = r'([A-Za-z0-9_]+)\[([^\]]+)\]'
        nodes = re.findall(node_pattern, mermaid_code)
        
        # ì—£ì§€ ì¶”ì¶œ  
        edge_pattern = r'([A-Za-z0-9_]+)\s*-->\s*([A-Za-z0-9_]+)'
        edges = re.findall(edge_pattern, mermaid_code)
        
        if nodes or edges:
            # í…ìŠ¤íŠ¸ ê¸°ë°˜ êµ¬ì¡° í‘œì‹œ
            col1, col2 = st.columns([1, 1])
            
            with col1:
                if nodes:
                    st.markdown("**ğŸ“¦ êµ¬ì„± ìš”ì†Œ:**")
                    for node_id, node_label in nodes:
                        st.write(f"â€¢ {node_label} ({node_id})")
            
            with col2:
                if edges:
                    st.markdown("**ğŸ”„ ì—°ê²° ê´€ê³„:**")
                    for src, dst in edges:
                        st.write(f"â€¢ {src} â†’ {dst}")
        
        # ê°„ë‹¨í•œ í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨
        if edges:
            st.markdown("**ğŸ“ˆ í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨:**")
            flow_text = ""
            for i, (src, dst) in enumerate(edges):
                src_label = next((label for node_id, label in nodes if node_id == src), src)
                dst_label = next((label for node_id, label in nodes if node_id == dst), dst)
                flow_text += f"**{i+1}.** {src_label} â†’ {dst_label}\n\n"
            
            st.markdown(flow_text)
            
    except Exception as e:
        st.info("ëŒ€ì•ˆ ì‹œê°í™” ìƒì„± ì‹¤íŒ¨")

def render_mermaid_chart(mermaid_code, chart_id):
    """ë‹¨ì¼ Mermaid ì°¨íŠ¸ ë Œë”ë§ - ê°„ì†Œí™”ëœ ë²„ì „"""
    try:
        # Graphvizë¡œ ë³€í™˜í•˜ì—¬ í‘œì‹œ
        dot = mermaid_to_graphviz(mermaid_code)
        if dot:
            st.graphviz_chart(dot, use_container_width=True)
        else:
            # ë³€í™˜ ì‹¤íŒ¨ ì‹œ ì½”ë“œ í‘œì‹œ
            st.markdown("**ğŸ“Š Mermaid ì°¨íŠ¸:**")
            st.code(mermaid_code, language="mermaid")
            st.info("ğŸ’¡ [Mermaid Live Editor](https://mermaid.live)ì—ì„œ ìœ„ ì½”ë“œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
    except Exception as e:
        st.error(f"ì°¨íŠ¸ ë Œë”ë§ ì¤‘ ì˜¤ë¥˜: {str(e)}")
        st.code(mermaid_code, language="mermaid")

def run_multi_agent_analysis(company_name, analysis_data, selected_agents, model_name, enable_thinking=False):
    """ë©€í‹° ì—ì´ì „íŠ¸ ë¶„ì„ ì‹¤í–‰"""
    
    # ì§„í–‰ ìƒí™© í‘œì‹œìš© ì»¨í…Œì´ë„ˆ
    progress_container = st.container()
    
    with progress_container:
        st.info("ğŸš€ **ë©€í‹° ì—ì´ì „íŠ¸ ë¶„ì„ ì‹œì‘**")
        
        # ì—ì´ì „íŠ¸ë³„ ìƒíƒœ í‘œì‹œ
        agent_status = {}
        agent_progress = {}
        
        cols = st.columns(len(selected_agents))
        for i, agent_key in enumerate(selected_agents):
            with cols[i]:
                agent_info = FINANCIAL_AGENTS[agent_key]
                agent_status[agent_key] = st.empty()
                agent_progress[agent_key] = st.progress(0)
                
                agent_status[agent_key].info(f"{agent_info['emoji']} {agent_info['name']}\nëŒ€ê¸° ì¤‘...")
        
        # ë©€í‹°í”„ë¡œì„¸ì‹±ìœ¼ë¡œ ì—ì´ì „íŠ¸ ë¶„ì„ ì‹¤í–‰
        st.info("âš¡ **ë³‘ë ¬ ë¶„ì„ ì‹¤í–‰ ì¤‘...**")
        
        # ë¶„ì„ ì¸ì ì¤€ë¹„
        analysis_args = []
        for agent_key in selected_agents:
            agent_info = FINANCIAL_AGENTS[agent_key]
            args = (agent_key, agent_info, analysis_data, model_name, company_name, enable_thinking)
            analysis_args.append(args)
        
        # ë³‘ë ¬ ì‹¤í–‰
        agent_analyses = []
        
        with concurrent.futures.ThreadPoolExecutor(max_workers=len(selected_agents)) as executor:
            # ëª¨ë“  ì—ì´ì „íŠ¸ ì‘ì—… ì œì¶œ
            future_to_agent = {
                executor.submit(analyze_with_agent, args): args[0] 
                for args in analysis_args
            }
            
            # ì™„ë£Œëœ ì‘ì—… ì²˜ë¦¬
            completed = 0
            for future in concurrent.futures.as_completed(future_to_agent):
                agent_key = future_to_agent[future]
                
                try:
                    result = future.result()
                    agent_analyses.append(result)
                    
                    # ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
                    completed += 1
                    progress = completed / len(selected_agents)
                    
                    agent_progress[agent_key].progress(1.0)
                    
                    if result['success']:
                        agent_status[agent_key].success(f"{result['agent_emoji']} {result['agent_name']}\nâœ… ë¶„ì„ ì™„ë£Œ")
                    else:
                        agent_status[agent_key].error(f"{result['agent_emoji']} {result['agent_name']}\nâŒ ë¶„ì„ ì‹¤íŒ¨")
                    
                except Exception as e:
                    st.error(f"ì—ì´ì „íŠ¸ {agent_key} ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜: {str(e)}")
        
        st.success("âœ… **ëª¨ë“  ì—ì´ì „íŠ¸ ë¶„ì„ ì™„ë£Œ**")
        
        # CFO ì¢…í•© ë¶„ì„
        st.info("ğŸ‘” **CFO ì¢…í•© ë¶„ì„ ì‹œì‘...**")
        cfo_analysis = synthesize_cfo_analysis(company_name, agent_analyses, analysis_data, model_name)
        
        if cfo_analysis['success']:
            st.success("âœ… **CFO ì¢…í•© ë¶„ì„ ì™„ë£Œ**")
        else:
            st.error("âŒ **CFO ì¢…í•© ë¶„ì„ ì‹¤íŒ¨**")
    
    return agent_analyses, cfo_analysis

@st.cache_data(ttl=300)  # 5ë¶„ ìºì‹œ (ì‹¤ì‹œê°„ ë°ì´í„°)
def get_stock_data(symbol, period="1y", retry_count=1):
    """ì£¼ì‹ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° - ì´ˆë³´ìˆ˜ì  ì ‘ê·¼"""
    
    # ë§ˆì§€ë§‰ ìš”ì²­ ì‹œê°„ ì¶”ì  ì´ˆê¸°í™”
    if 'last_api_request' not in st.session_state:
        st.session_state.last_api_request = 0
    
    # ë„¤ì´ë²„ ì¦ê¶Œ ìš°ì„  ëª¨ë“œì—ì„œëŠ” ëŒ€ê¸° ì‹œê°„ ë‹¨ì¶•
    if st.session_state.get('use_naver_first', True):
        required_wait = random.uniform(1, 3)  # ë„¤ì´ë²„ëŠ” 1-3ì´ˆë§Œ ëŒ€ê¸°
        mode_name = "ğŸ‡°ğŸ‡· ë„¤ì´ë²„ ì¦ê¶Œ ìš°ì„  ëª¨ë“œ"
    else:
        required_wait = random.uniform(60, 120)  # Yahoo FinanceëŠ” 1-2ë¶„ ëŒ€ê¸°
        mode_name = "â³ Yahoo Finance ëª¨ë“œ"
    
    # ëŒ€ê¸° ì‹œê°„ ì²´í¬ ë° ì‹¤í–‰
    time_since_last = time.time() - st.session_state.last_api_request
    if time_since_last < required_wait:
        wait_time = required_wait - time_since_last
        st.warning(f"{mode_name}: API ì•ˆì •ì„±ì„ ìœ„í•´ {wait_time:.1f}ì´ˆ ëŒ€ê¸° ì¤‘...")
        
        # ì§„í–‰ë°”ë¡œ ëŒ€ê¸° ì‹œê°„ ì‹œê°í™”
        progress_bar = st.progress(0)
        status_text = st.empty()
        
        for i in range(int(wait_time)):
            time.sleep(1)
            progress_bar.progress((i + 1) / wait_time)
            status_text.text(f"ëŒ€ê¸° ì¤‘... {wait_time - i - 1:.0f}ì´ˆ ë‚¨ìŒ")
        
        progress_bar.empty()
        status_text.empty()
    
    # 1. ë¨¼ì € ë„¤ì´ë²„ ì¦ê¶Œ ì‹œë„ (í•œêµ­ ì£¼ì‹ì— ìµœì í™”)
    st.info(f"ğŸ‡°ğŸ‡· ë„¤ì´ë²„ ì¦ê¶Œìœ¼ë¡œ {symbol} ë°ì´í„° ìˆ˜ì§‘ ì‹œë„ ì¤‘...")
    
    naver_result = get_naver_stock_data(symbol, period)
    if naver_result[0] is not None:
        return naver_result
    
    # 2. ë„¤ì´ë²„ ì¦ê¶Œ ì‹¤íŒ¨ ì‹œ Yahoo Finance API ì‹œë„ (ë°±ì—…)
    st.warning("ë„¤ì´ë²„ ì¦ê¶Œ ì‹¤íŒ¨, Yahoo Finance API ë°±ì—… ì‹œë„...")
    st.info(f"ğŸŒ Yahoo Finance APIë¡œ {symbol} ë°ì´í„° ìˆ˜ì§‘ ì¤‘... (ì‹œë„ {retry_count}/3)")
    
    try:
        # ê·¹ë„ë¡œ ë‹¤ì–‘í•œ User-Agent ë° í™˜ê²½ ì‹œë®¬ë ˆì´ì…˜
        user_agents = [
            'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
            'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36 Edg/119.0.0.0',
            'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/118.0.0.0 Safari/537.36',
            'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.1 Safari/605.1.15',
            'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/119.0',
            'Mozilla/5.0 (iPad; CPU OS 17_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.1 Mobile/15E148 Safari/604.1',
            'Mozilla/5.0 (iPhone; CPU iPhone OS 17_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.1 Mobile/15E148 Safari/604.1',
            'Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0'
        ]
        
        # ì‹œê°„ëŒ€ë³„ í—¤ë” ì¡°í•©
        current_hour = datetime.now().hour
        accept_languages = [
            'en-US,en;q=0.9,ko;q=0.8',
            'ko-KR,ko;q=0.9,en;q=0.8',
            'en-US,en;q=0.5',
            'ko;q=0.9,en-US;q=0.8,en;q=0.7'
        ]
        
        # ìš”ì²­ ì „ ê¸´ ì¤€ë¹„ (ì´ˆê¸° ëŒ€ê¸°)
        prep_delay = random.uniform(30, 90)
        st.info(f"ğŸ”„ ìƒˆë¡œìš´ ìš”ì²­ ì„¸ì…˜ ì¤€ë¹„ ì¤‘... ({prep_delay:.1f}ì´ˆ)")
        
        # ì¤€ë¹„ ì‹œê°„ë„ ì§„í–‰ë°”ë¡œ í‘œì‹œ
        prep_progress = st.progress(0)
        for i in range(int(prep_delay)):
            time.sleep(1)
            prep_progress.progress((i + 1) / prep_delay)
        prep_progress.empty()
        
        # ì™„ì „íˆ ìƒˆë¡œìš´ ì„¸ì…˜ ìƒì„± (ë§¤ë²ˆ ì¬ìƒì„±)
        session = requests.Session()
        
        # ê·¹ë„ë¡œ ë‹¤ì–‘í•œ í—¤ë” ì¡°í•©
        selected_ua = random.choice(user_agents)
        selected_lang = random.choice(accept_languages)
        
        # ë¸Œë¼ìš°ì €ë³„ í—¤ë” ì°¨ë³„í™”
        if 'Chrome' in selected_ua:
            accept_header = 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8'
        elif 'Firefox' in selected_ua:
            accept_header = 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8'
        elif 'Safari' in selected_ua:
            accept_header = 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'
        else:
            accept_header = 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'
        
        # ëœë¤ í—¤ë” ì¡°í•©
        headers = {
            'User-Agent': selected_ua,
            'Accept': accept_header,
            'Accept-Language': selected_lang,
            'Accept-Encoding': 'gzip, deflate, br',
            'Connection': 'keep-alive',
            'Upgrade-Insecure-Requests': '1',
            'Sec-Fetch-Dest': 'document',
            'Sec-Fetch-Mode': 'navigate',
            'Sec-Fetch-Site': 'none',
            'Cache-Control': 'max-age=0',
            'DNT': '1',
        }
        
        # ì‹œê°„ëŒ€ë³„ ì¶”ê°€ í—¤ë”
        if 9 <= current_hour <= 18:  # ì—…ë¬´ì‹œê°„
            headers['Sec-Ch-Ua-Platform'] = '"macOS"' if 'Mac' in selected_ua else '"Windows"'
        
        session.headers.update(headers)
        st.info(f"ğŸ”„ ìƒˆ ì„¸ì…˜ ìƒì„±: {selected_ua[:50]}...")
        
        # yfinance Ticker ìƒì„±
        stock = yf.Ticker(symbol, session=session)
        
        # 1. íˆìŠ¤í† ë¦¬ ë°ì´í„° ìš”ì²­ (ìµœìš°ì„ )
        st.info("ğŸ“ˆ ì£¼ê°€ íˆìŠ¤í† ë¦¬ ë°ì´í„° ìˆ˜ì§‘ ì¤‘...")
        hist = stock.history(period=period)
        
        # ìš”ì²­ ì‹œê°„ ê¸°ë¡
        st.session_state.last_api_request = time.time()
        
        if hist.empty:
            raise Exception("íˆìŠ¤í† ë¦¬ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤")
        
        # ìµœì†Œ ì •ë³´ë§Œ ìƒì„± (ì¶”ê°€ API ìš”ì²­ ì—†ìŒ)
        info = {
            "symbol": symbol, 
            "shortName": symbol.replace('.KS', ''),
            "regularMarketPrice": float(hist['Close'].iloc[-1]) if not hist.empty else 0,
            "currency": "KRW"
        }
        
        current_price = info.get('regularMarketPrice', hist['Close'].iloc[-1] if not hist.empty else 0)
        st.success(f"âœ… Yahoo Finance API ì„±ê³µ: {symbol} (í˜„ì¬ê°€: {current_price:,.0f}ì›)")
        return hist, info
        
    except Exception as e:
        error_msg = str(e)
        st.error(f"Yahoo Finance API ì‹¤íŒ¨: {error_msg}")
        
        # ì¬ì‹œë„ ë¡œì§ (ì§€ìˆ˜ì  ë°±ì˜¤í”„ - ë§¤ìš° ê¸´ ëŒ€ê¸°)
        if retry_count < 3:
            failure_delay = 300 * retry_count  # 5ë¶„, 10ë¶„, 15ë¶„
            st.error(f"ğŸ’¥ ì‹¤íŒ¨ í›„ ê·¹ì¥ê¸° ëŒ€ê¸°: {failure_delay/60:.0f}ë¶„ í›„ ì¬ì‹œë„ ({retry_count + 1}/3)")
            
            # ì‹¤íŒ¨ ëŒ€ê¸° ì‹œê°„ ì‹œê°í™”
            progress_bar = st.progress(0)
            status_text = st.empty()
            
            for i in range(failure_delay):
                time.sleep(1)
                progress_bar.progress((i + 1) / failure_delay)
                remaining_mins = (failure_delay - i - 1) / 60
                status_text.text(f"ëŒ€ê¸° ì¤‘... {remaining_mins:.1f}ë¶„ ë‚¨ìŒ")
            
            progress_bar.empty()
            status_text.empty()
            
            return get_stock_data(symbol, period, retry_count + 1)
        
        # ëª¨ë“  ì¬ì‹œë„ ì‹¤íŒ¨ ì‹œ ì‹¤ì œ ë°ì´í„° ì—†ìŒ
        st.error("âŒ ëª¨ë“  Yahoo Finance ì‹œë„ ì‹¤íŒ¨. ì‹¤ì œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        st.warning("âš ï¸ ìƒ˜í”Œ ë°ì´í„°ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì‹¤ì œ ë°ì´í„°ë§Œìœ¼ë¡œ ë¶„ì„ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.")
        return None, None



def get_naver_financial_statements(symbol):
    """ë„¤ì´ë²„ ì¦ê¶Œì—ì„œ ì¬ë¬´ì œí‘œ ë°ì´í„° ìˆ˜ì§‘"""
    try:
        st.info("ğŸ‡°ğŸ‡· ë„¤ì´ë²„ ì¦ê¶Œì—ì„œ ì¬ë¬´ì œí‘œ ìˆ˜ì§‘ ì¤‘...")
        
        # ì¢…ëª©ì½”ë“œ ì¶”ì¶œ
        stock_code = symbol.replace('.KS', '').replace('.KQ', '')
        
        headers = {
            'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
            'Referer': 'https://finance.naver.com/',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8'
        }
        
        session = requests.Session()
        session.headers.update(headers)
        
        # ë„¤ì´ë²„ ì¦ê¶Œ ì¬ë¬´ì œí‘œ í˜ì´ì§€ë“¤
        financial_urls = {
            'income': f"https://finance.naver.com/item/main.naver?code={stock_code}",
            'balance': f"https://finance.naver.com/item/main.naver?code={stock_code}",
        }
        
        financial_data = {}
        
        for statement_type, url in financial_urls.items():
            try:
                st.info(f"ğŸ“Š {statement_type} ë°ì´í„° ìˆ˜ì§‘ ì¤‘...")
                response = session.get(url, timeout=10)
                response.raise_for_status()
                
                # ê¸°ë³¸ ì¬ë¬´ ì •ë³´ ì¶”ì¶œ (ì˜ˆì‹œ)
                content = response.text
                
                # ê°„ë‹¨í•œ ì¬ë¬´ ì •ë³´ íŒŒì‹± (ì‹¤ì œë¡œëŠ” ë” ë³µì¡í•œ íŒŒì‹± í•„ìš”)
                import re
                
                # ë§¤ì¶œì•¡, ì˜ì—…ì´ìµ ë“± ê¸°ë³¸ ì •ë³´ ì¶”ì¶œ ì‹œë„
                if statement_type == 'income':
                    # ì†ìµê³„ì‚°ì„œ ê´€ë ¨ ì •ë³´
                    revenue_pattern = r'ë§¤ì¶œì•¡.*?(\d{1,3}(?:,\d{3})*)'
                    profit_pattern = r'ì˜ì—…ì´ìµ.*?(\d{1,3}(?:,\d{3})*)'
                    
                    revenue_match = re.search(revenue_pattern, content)
                    profit_match = re.search(profit_pattern, content)
                    
                    financial_data['revenue'] = revenue_match.group(1).replace(',', '') if revenue_match else None
                    financial_data['operating_profit'] = profit_match.group(1).replace(',', '') if profit_match else None
                
                elif statement_type == 'balance':
                    # ì¬ë¬´ìƒíƒœí‘œ ê´€ë ¨ ì •ë³´
                    assets_pattern = r'ì´ìì‚°.*?(\d{1,3}(?:,\d{3})*)'
                    equity_pattern = r'ìë³¸ì´ê³„.*?(\d{1,3}(?:,\d{3})*)'
                    
                    assets_match = re.search(assets_pattern, content)
                    equity_match = re.search(equity_pattern, content)
                    
                    financial_data['total_assets'] = assets_match.group(1).replace(',', '') if assets_match else None
                    financial_data['total_equity'] = equity_match.group(1).replace(',', '') if equity_match else None
                
                time.sleep(2)  # ìš”ì²­ ê°„ ì§€ì—°
                
            except Exception as e:
                st.warning(f"âš ï¸ {statement_type} ìˆ˜ì§‘ ì‹¤íŒ¨: {str(e)}")
                continue
        
        # pandas DataFrameìœ¼ë¡œ ë³€í™˜
        if financial_data:
            st.success("âœ… ë„¤ì´ë²„ ì¦ê¶Œ ì¬ë¬´ì œí‘œ ìˆ˜ì§‘ ì„±ê³µ")
            return create_financial_dataframes_from_naver(financial_data, stock_code)
        else:
            st.warning("âš ï¸ ë„¤ì´ë²„ ì¦ê¶Œì—ì„œ ì¬ë¬´ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
            return None, None, None
            
    except Exception as e:
        st.error(f"âŒ ë„¤ì´ë²„ ì¦ê¶Œ ì¬ë¬´ì œí‘œ ìˆ˜ì§‘ ì‹¤íŒ¨: {str(e)}")
        return None, None, None

def create_financial_dataframes_from_naver(financial_data, stock_code):
    """ë„¤ì´ë²„ì—ì„œ ìˆ˜ì§‘í•œ ì¬ë¬´ ë°ì´í„°ë¥¼ pandas DataFrameìœ¼ë¡œ ë³€í™˜"""
    try:
        import pandas as pd
        
        # ê¸°ë³¸ ì—°ë„ ì„¤ì •
        years = ['2023', '2022', '2021', '2020']
        
        # ì†ìµê³„ì‚°ì„œ ë°ì´í„°
        income_data = {}
        for year in years:
            income_data[year] = {
                'Total Revenue': float(financial_data.get('revenue', 0)) * 1e8 if financial_data.get('revenue') else None,
                'Operating Income': float(financial_data.get('operating_profit', 0)) * 1e8 if financial_data.get('operating_profit') else None,
                'Net Income': None,  # ì¶”ê°€ íŒŒì‹± í•„ìš”
                'Gross Profit': None
            }
        
        # ì¬ë¬´ìƒíƒœí‘œ ë°ì´í„°
        balance_data = {}
        for year in years:
            balance_data[year] = {
                'Total Assets': float(financial_data.get('total_assets', 0)) * 1e8 if financial_data.get('total_assets') else None,
                'Total Equity Gross Minority Interest': float(financial_data.get('total_equity', 0)) * 1e8 if financial_data.get('total_equity') else None,
                'Current Assets': None,  # ì¶”ê°€ íŒŒì‹± í•„ìš”
                'Total Debt': None
            }
        
        income_stmt = pd.DataFrame(income_data)
        balance_sheet = pd.DataFrame(balance_data)
        cash_flow = None  # í˜„ê¸ˆíë¦„í‘œëŠ” ë³„ë„ êµ¬í˜„ í•„ìš”
        
        st.info(f"ğŸ“Š ë„¤ì´ë²„ ê¸°ë°˜ ì¬ë¬´ì œí‘œ ìƒì„±: ì†ìµê³„ì‚°ì„œ {income_stmt.shape}, ì¬ë¬´ìƒíƒœí‘œ {balance_sheet.shape}")
        
        return income_stmt, balance_sheet, cash_flow
        
    except Exception as e:
        st.error(f"âŒ ì¬ë¬´ì œí‘œ DataFrame ìƒì„± ì‹¤íŒ¨: {str(e)}")
        return None, None, None

@st.cache_data(ttl=3600)  # 1ì‹œê°„ ìºì‹œ (ì¬ë¬´ì œí‘œ)
def get_financial_statements(symbol, retry_count=1):
    """ì¬ë¬´ì œí‘œ ê°€ì ¸ì˜¤ê¸° - ë„¤ì´ë²„ ì¦ê¶Œ ìš°ì„ , Yahoo Finance ë°±ì—…"""
    
    # 1ì°¨: ë„¤ì´ë²„ ì¦ê¶Œ ì‹œë„
    st.info("ğŸ‡°ğŸ‡· **1ì°¨**: ë„¤ì´ë²„ ì¦ê¶Œì—ì„œ ì¬ë¬´ì œí‘œ ìˆ˜ì§‘ ì‹œë„...")
    income_stmt, balance_sheet, cash_flow = get_naver_financial_statements(symbol)
    
    if (income_stmt is not None and not income_stmt.empty) or (balance_sheet is not None and not balance_sheet.empty):
        st.success("âœ… ë„¤ì´ë²„ ì¦ê¶Œ ì¬ë¬´ì œí‘œ ìˆ˜ì§‘ ì„±ê³µ!")
        return income_stmt, balance_sheet, cash_flow
    
    # 2ì°¨: Yahoo Finance ë°±ì—… ì‹œë„
    st.warning("âš ï¸ ë„¤ì´ë²„ ì¦ê¶Œ ì‹¤íŒ¨, Yahoo Finance ë°±ì—… ì‹œë„...")
    
    try:
        # ë§ˆì§€ë§‰ ìš”ì²­ìœ¼ë¡œë¶€í„° ê¸´ ëŒ€ê¸° ì‹œê°„
        if 'last_api_request' in st.session_state:
            time_since_last = time.time() - st.session_state.last_api_request
            required_wait = random.uniform(20, 40)  # 20-40ì´ˆ ëŒ€ê¸°
            
            if time_since_last < required_wait:
                wait_time = required_wait - time_since_last
                st.warning(f"ğŸ›¡ï¸ Yahoo Finance ì•ˆì „ ë¡œë“œë¥¼ ìœ„í•´ {wait_time:.1f}ì´ˆ ëŒ€ê¸° ì¤‘...")
                
                # ì§„í–‰ë°”ë¡œ ì‹œê°í™”
                progress_bar = st.progress(0)
                for i in range(int(wait_time)):
                    time.sleep(1)
                    progress_bar.progress((i + 1) / wait_time)
                progress_bar.empty()
        
        # ë³´ìˆ˜ì  ì„¸ì…˜ ì„¤ì •
        user_agents = [
            'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
            'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36'
        ]
        
        session = requests.Session()
        session.headers.update({
            'User-Agent': random.choice(user_agents),
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
            'Accept-Language': 'en-US,en;q=0.5',
            'Connection': 'keep-alive',
            'Cache-Control': 'max-age=0',
        })
        
        stock = yf.Ticker(symbol, session=session)
        
        # Yahoo Finance ì¬ë¬´ì œí‘œ ë°ì´í„° ìˆ˜ì§‘
        st.info("ğŸ“Š Yahoo Finance ì¬ë¬´ì œí‘œ ë°ì´í„° ìˆ˜ì§‘ ì¤‘...")
        
        # ì†ìµê³„ì‚°ì„œ
        st.info("ğŸ“ˆ Yahoo Finance ì†ìµê³„ì‚°ì„œ ìˆ˜ì§‘ ì¤‘...")
        prep_delay = random.uniform(10, 20)
        time.sleep(prep_delay)
        
        try:
            income_stmt = stock.income_stmt
            st.session_state.last_api_request = time.time()
            
            # ë°ì´í„° ê²€ì¦
            if income_stmt is not None and not income_stmt.empty:
                st.success(f"âœ… Yahoo Finance ì†ìµê³„ì‚°ì„œ ìˆ˜ì§‘ ì™„ë£Œ (í¬ê¸°: {income_stmt.shape})")
                st.info(f"ğŸ“‹ ìˆ˜ì§‘ëœ í•­ëª© ìˆ˜: {len(income_stmt.index)}")
            else:
                st.warning("âš ï¸ Yahoo Finance ì†ìµê³„ì‚°ì„œ: ë°ì´í„°ê°€ ë¹„ì–´ìˆê±°ë‚˜ None")
                income_stmt = None
                
        except Exception as e:
            st.warning(f"âŒ Yahoo Finance ì†ìµê³„ì‚°ì„œ ìˆ˜ì§‘ ì‹¤íŒ¨: {str(e)}")
            st.info(f"ğŸ” ì˜¤ë¥˜ ìƒì„¸: {type(e).__name__}")
            income_stmt = None
        
        # ìš”ì²­ ê°„ ê¸´ ì§€ì—°
        inter_delay = random.uniform(15, 30)
        st.info(f"â³ ì•ˆì „í•œ ê°„ê²© ìœ ì§€... ({inter_delay:.1f}ì´ˆ)")
        time.sleep(inter_delay)
        
        # ì¬ë¬´ìƒíƒœí‘œ
        st.info("ğŸ“Š Yahoo Finance ì¬ë¬´ìƒíƒœí‘œ ìˆ˜ì§‘ ì¤‘...")
        try:
            balance_sheet = stock.balance_sheet
            st.session_state.last_api_request = time.time()
            
            # ë°ì´í„° ê²€ì¦
            if balance_sheet is not None and not balance_sheet.empty:
                st.success(f"âœ… Yahoo Finance ì¬ë¬´ìƒíƒœí‘œ ìˆ˜ì§‘ ì™„ë£Œ (í¬ê¸°: {balance_sheet.shape})")
                st.info(f"ğŸ“‹ ìˆ˜ì§‘ëœ í•­ëª© ìˆ˜: {len(balance_sheet.index)}")
            else:
                st.warning("âš ï¸ Yahoo Finance ì¬ë¬´ìƒíƒœí‘œ: ë°ì´í„°ê°€ ë¹„ì–´ìˆê±°ë‚˜ None")
                balance_sheet = None
                
        except Exception as e:
            st.warning(f"âŒ Yahoo Finance ì¬ë¬´ìƒíƒœí‘œ ìˆ˜ì§‘ ì‹¤íŒ¨: {str(e)}")
            st.info(f"ğŸ” ì˜¤ë¥˜ ìƒì„¸: {type(e).__name__}")
            balance_sheet = None
        
        # í˜„ê¸ˆíë¦„í‘œ (ì„ íƒì )
        cash_flow = None  # í˜„ê¸ˆíë¦„í‘œëŠ” ìŠ¤í‚µí•˜ì—¬ API ë¶€í•˜ ì¤„ì„
        
        # Yahoo Finance ìµœì¢… ê²°ê³¼ ìš”ì•½
        success_count = sum([
            1 if income_stmt is not None and not income_stmt.empty else 0,
            1 if balance_sheet is not None and not balance_sheet.empty else 0
        ])
        
        if success_count > 0:
            st.success(f"âœ… Yahoo Finance ì¬ë¬´ì œí‘œ ìˆ˜ì§‘ ì™„ë£Œ! ({success_count}/2ê°œ ì„±ê³µ)")
            return income_stmt, balance_sheet, cash_flow
        else:
            st.error("âŒ Yahoo Financeë„ ëª¨ë“  ì¬ë¬´ì œí‘œ ìˆ˜ì§‘ ì‹¤íŒ¨")
            
        
    except Exception as e:
        error_msg = str(e)
        st.error(f"âŒ Yahoo Finance ì¬ë¬´ì œí‘œ ìˆ˜ì§‘ ì „ì²´ ì‹¤íŒ¨: {error_msg}")
    
    # 3ì°¨: ìµœì¢… ëŒ€ì•ˆ (ê¸°ë³¸ êµ¬ì¡° ìƒì„±)
    st.info("ğŸ”„ **3ì°¨**: í•œêµ­ ê¸°ì—… ì¬ë¬´ì œí‘œ ê¸°ë³¸ êµ¬ì¡° ìƒì„±...")
    income_stmt, balance_sheet = create_korean_financial_fallback(symbol)
    
    return income_stmt, balance_sheet, None

def create_korean_financial_fallback(symbol):
    """í•œêµ­ ê¸°ì—…ìš© ê¸°ë³¸ ì¬ë¬´ì œí‘œ êµ¬ì¡° ìƒì„± (ì£¼ê°€ ê¸°ë°˜ ì¶”ì •)"""
    try:
        st.info("ğŸ‡°ğŸ‡· í•œêµ­ ê¸°ì—… ì¬ë¬´ì œí‘œ ê¸°ë³¸ êµ¬ì¡° ìƒì„± ì¤‘...")
        
        # ì£¼ê°€ ë°ì´í„° ê¸°ë°˜ ê¸°ë³¸ ì¬ë¬´ ì¶”ì •
        stock_code = symbol.replace('.KS', '').replace('.KQ', '')
        
        # ê¸°ë³¸ ì¬ë¬´ì œí‘œ êµ¬ì¡° ìƒì„±
        import pandas as pd
        
        # ë‚ ì§œ ê¸°ì¤€ (ìµœê·¼ 4ë…„)
        years = [2023, 2022, 2021, 2020]
        
        # ê¸°ë³¸ ì†ìµê³„ì‚°ì„œ êµ¬ì¡°
        income_data = {
            str(year): {
                'Total Revenue': None,
                'Gross Profit': None, 
                'Operating Income': None,
                'Net Income': None
            } for year in years
        }
        
        # ê¸°ë³¸ ì¬ë¬´ìƒíƒœí‘œ êµ¬ì¡°
        balance_data = {
            str(year): {
                'Total Assets': None,
                'Current Assets': None,
                'Total Debt': None,
                'Total Equity Gross Minority Interest': None
            } for year in years
        }
        
        income_stmt = pd.DataFrame(income_data)
        balance_sheet = pd.DataFrame(balance_data)
        
        st.warning("âš ï¸ ì¬ë¬´ì œí‘œ ê¸°ë³¸ êµ¬ì¡°ë§Œ ìƒì„±ë¨ (ì‹¤ì œ ë°ì´í„° ì—†ìŒ)")
        st.info("ğŸ’¡ ì£¼ê°€ ë°ì´í„° ê¸°ë°˜ ë¶„ì„ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.")
        
        return income_stmt, balance_sheet
        
    except Exception as e:
        st.error(f"ëŒ€ì•ˆ ì¬ë¬´ì œí‘œ ìƒì„± ì‹¤íŒ¨: {str(e)}")
        return None, None



def safe_ratio_calculation(numerator, denominator, ratio_name):
    """ì•ˆì „í•œ ë¹„ìœ¨ ê³„ì‚° (None ì²´í¬ í¬í•¨)"""
    try:
        if numerator is None or denominator is None:
            return None
        if pd.isna(numerator) or pd.isna(denominator):
            return None
        if denominator == 0:
            return None
        return round((numerator / denominator) * 100, 2)
    except:
        return None

def safe_value_access(dataframe, index_name, column_index=0):
    """ì•ˆì „í•œ ë°ì´í„°í”„ë ˆì„ ê°’ ì ‘ê·¼"""
    try:
        if dataframe is None or dataframe.empty:
            return None
        if index_name not in dataframe.index:
            return None
        value = dataframe.loc[index_name].iloc[column_index]
        if pd.isna(value):
            return None
        return value
    except:
        return None

def calculate_financial_ratios(income_stmt, balance_sheet):
    """ì¬ë¬´ ë¹„ìœ¨ ê³„ì‚° - ì•ˆì „í•œ None ì²´í¬ í¬í•¨"""
    try:
        ratios = {}
        
        st.info("ğŸ”¢ ì¬ë¬´ë¹„ìœ¨ ê³„ì‚° ì‹œì‘...")
        
        # ë°ì´í„° ìœ íš¨ì„± ê²€ì¦
        if income_stmt is None and balance_sheet is None:
            st.warning("âš ï¸ ì†ìµê³„ì‚°ì„œì™€ ì¬ë¬´ìƒíƒœí‘œ ëª¨ë‘ ì—†ìŒ")
            return ratios
        
        # ì†ìµê³„ì‚°ì„œ ë°ì´í„° ì•ˆì „ ì ‘ê·¼
        net_income = safe_value_access(income_stmt, 'Net Income') if income_stmt is not None else None
        total_revenue = safe_value_access(income_stmt, 'Total Revenue') if income_stmt is not None else None
        operating_income = safe_value_access(income_stmt, 'Operating Income') if income_stmt is not None else None
        
        # ì¬ë¬´ìƒíƒœí‘œ ë°ì´í„° ì•ˆì „ ì ‘ê·¼
        total_assets = safe_value_access(balance_sheet, 'Total Assets') if balance_sheet is not None else None
        total_equity = safe_value_access(balance_sheet, 'Total Equity Gross Minority Interest') if balance_sheet is not None else None
        current_assets = safe_value_access(balance_sheet, 'Current Assets') if balance_sheet is not None else None
        current_liabilities = safe_value_access(balance_sheet, 'Current Liabilities') if balance_sheet is not None else None
        total_debt = safe_value_access(balance_sheet, 'Total Debt') if balance_sheet is not None else None
        
        # ìˆ˜ìµì„± ë¹„ìœ¨ ê³„ì‚°
        net_margin = safe_ratio_calculation(net_income, total_revenue, "ìˆœì´ìµë¥ ")
        if net_margin is not None:
            ratios['ìˆœì´ìµë¥ (%)'] = net_margin
            
        operating_margin = safe_ratio_calculation(operating_income, total_revenue, "ì˜ì—…ì´ìµë¥ ")
        if operating_margin is not None:
            ratios['ì˜ì—…ì´ìµë¥ (%)'] = operating_margin
        
        # ROA ê³„ì‚°
        roa = safe_ratio_calculation(net_income, total_assets, "ROA")
        if roa is not None:
            ratios['ROA(%)'] = roa
        
        # ROE ê³„ì‚°  
        roe = safe_ratio_calculation(net_income, total_equity, "ROE")
        if roe is not None:
            ratios['ROE(%)'] = roe
        
        # ì•ˆì •ì„± ë¹„ìœ¨ ê³„ì‚°
        if current_assets is not None and current_liabilities is not None and current_liabilities != 0:
            try:
                current_ratio = round(current_assets / current_liabilities, 2)
                ratios['ìœ ë™ë¹„ìœ¨'] = current_ratio
            except:
                pass
        
        if total_debt is not None and total_equity is not None and total_equity != 0:
            try:
                debt_equity = round(total_debt / total_equity, 2)
                ratios['ë¶€ì±„ë¹„ìœ¨'] = debt_equity
            except:
                pass
        
        # ê²°ê³¼ ìš”ì•½
        calculated_count = len(ratios)
        st.info(f"âœ… ì¬ë¬´ë¹„ìœ¨ ê³„ì‚° ì™„ë£Œ: {calculated_count}ê°œ ë¹„ìœ¨ ê³„ì‚°ë¨")
        
        if calculated_count == 0:
            st.warning("âš ï¸ ê³„ì‚° ê°€ëŠ¥í•œ ì¬ë¬´ë¹„ìœ¨ì´ ì—†ìŠµë‹ˆë‹¤ (ë°ì´í„° ë¶€ì¡±)")
            
        return ratios
        
    except Exception as e:
        st.error(f"âŒ ì¬ë¬´ë¹„ìœ¨ ê³„ì‚° ì‹¤íŒ¨: {str(e)}")
        st.error(f"ğŸ” ì˜¤ë¥˜ ìœ í˜•: {type(e).__name__}")
        return {}

def create_stock_chart(hist_data, company_name):
    """ì£¼ê°€ ì°¨íŠ¸ ìƒì„±"""
    fig = go.Figure()
    
    fig.add_trace(go.Candlestick(
        x=hist_data.index,
        open=hist_data['Open'],
        high=hist_data['High'],
        low=hist_data['Low'],
        close=hist_data['Close'],
        name=company_name
    ))
    
    fig.update_layout(
        title=f"{company_name} ì£¼ê°€ ì°¨íŠ¸",
        yaxis_title="ì£¼ê°€ (KRW)",
        xaxis_title="ë‚ ì§œ",
        height=500
    )
    
    return fig

def create_volume_chart(hist_data, company_name):
    """ê±°ë˜ëŸ‰ ì°¨íŠ¸ ìƒì„±"""
    fig = go.Figure()
    
    fig.add_trace(go.Bar(
        x=hist_data.index,
        y=hist_data['Volume'],
        name='ê±°ë˜ëŸ‰',
        marker_color='lightblue'
    ))
    
    fig.update_layout(
        title=f"{company_name} ê±°ë˜ëŸ‰",
        yaxis_title="ê±°ë˜ëŸ‰",
        xaxis_title="ë‚ ì§œ",
        height=300
    )
    
    return fig

# ê°€ì¹˜í‰ê°€ ê´€ë ¨ í•¨ìˆ˜ë“¤ (Valuation.pyì—ì„œ ê°€ì ¸ì˜´)
def calculate_dcf(current_fcf, growth_rate, discount_rate, terminal_growth_rate, years=5):
    """DCF(Discounted Cash Flow) ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ ê¸°ì—…ê°€ì¹˜ ê³„ì‚°"""
    future_fcfs = []
    for year in range(1, years + 1):
        future_fcf = current_fcf * (1 + growth_rate) ** year
        future_fcfs.append(future_fcf)
    
    # ê° ë¯¸ë˜ FCFì˜ í˜„ì¬ê°€ì¹˜ ê³„ì‚°
    present_values = []
    for i, fcf in enumerate(future_fcfs):
        present_value = fcf / (1 + discount_rate) ** (i + 1)
        present_values.append(present_value)
    
    # ì”ì—¬ê°€ì¹˜(Terminal Value) ê³„ì‚°
    terminal_value = future_fcfs[-1] * (1 + terminal_growth_rate) / (discount_rate - terminal_growth_rate)
    terminal_value_pv = terminal_value / (1 + discount_rate) ** years
    
    # ì´ ê¸°ì—…ê°€ì¹˜
    company_value = sum(present_values) + terminal_value_pv
    
    return {
        'company_value': company_value,
        'future_fcfs': future_fcfs,
        'present_values': present_values,
        'terminal_value': terminal_value,
        'terminal_value_pv': terminal_value_pv
    }

def calculate_per_valuation(net_income, pers):
    """PER(ì£¼ê°€ìˆ˜ìµë¹„ìœ¨) ê¸°ë°˜ ê¸°ì—…ê°€ì¹˜ ê³„ì‚°"""
    per_valuations = {}
    for per in pers:
        valuation = net_income * per
        per_valuations[per] = valuation
    return per_valuations

def calculate_ev_ebitda_valuation(ebitda, multiples, net_debt):
    """EV/EBITDA ë©€í‹°í”Œ ê¸°ë°˜ ê¸°ì—…ê°€ì¹˜ ê³„ì‚°"""
    valuations = {}
    for multiple in multiples:
        enterprise_value = ebitda * multiple
        equity_value = enterprise_value - net_debt
        valuations[multiple] = {
            'enterprise_value': enterprise_value,
            'equity_value': equity_value
        }
    return valuations

def format_currency_krw(amount):
    """í•œêµ­ ì›í™” í¬ë§·íŒ… í•¨ìˆ˜"""
    if amount >= 1_000_000_000:
        return f"{amount/1_000_000_000:.2f}ì¡°ì›"
    elif amount >= 100_000_000:
        return f"{amount/100_000_000:.2f}ì–µì›"
    elif amount >= 10000:
        return f"{amount/10000:.2f}ë§Œì›"
    else:
        return f"{amount:,.0f}ì›"

# ì£¼ê°€ ì˜ˆì¸¡ ê´€ë ¨ í•¨ìˆ˜ë“¤
def random_walk_prediction(prices, days=252):
    """Random Walk ëª¨ë¸ì„ ì‚¬ìš©í•œ ì£¼ê°€ ì˜ˆì¸¡"""
    try:
        # ìˆ˜ìµë¥  ê³„ì‚°
        returns = np.diff(np.log(prices))
        
        # í‰ê·  ìˆ˜ìµë¥ ê³¼ ë³€ë™ì„±
        mean_return = np.mean(returns)
        volatility = np.std(returns)
        
        # ì˜ˆì¸¡
        last_price = prices[-1]
        predictions = [last_price]
        
        for i in range(days):
            # ëœë¤ ì›Œí¬: S(t+1) = S(t) * exp(Î¼*dt + Ïƒ*âˆšdt*Z)
            random_shock = np.random.normal(0, 1)
            next_price = predictions[-1] * np.exp(mean_return + volatility * random_shock)
            predictions.append(next_price)
        
        return predictions[1:], mean_return, volatility
    except Exception as e:
        st.error(f"Random Walk ì˜ˆì¸¡ ì˜¤ë¥˜: {str(e)}")
        return None, None, None

def moving_average_prediction(prices, window=20, days=252):
    """ì´ë™í‰ê·  ê¸°ë°˜ ì£¼ê°€ ì˜ˆì¸¡"""
    try:
        # ì´ë™í‰ê·  ê³„ì‚°
        ma = pd.Series(prices).rolling(window=window).mean()
        
        # ì¶”ì„¸ ê³„ì‚° (ìµœê·¼ ì´ë™í‰ê· ì˜ ê¸°ìš¸ê¸°)
        recent_ma = ma.dropna().tail(10)
        x = np.arange(len(recent_ma))
        slope, intercept, _, _, _ = stats.linregress(x, recent_ma)
        
        # ì˜ˆì¸¡
        last_price = prices[-1]
        last_ma = ma.iloc[-1]
        
        predictions = []
        for i in range(1, days + 1):
            # ì´ë™í‰ê·  ì¶”ì„¸ + ì‘ì€ ë…¸ì´ì¦ˆ
            predicted_ma = last_ma + slope * i
            noise = np.random.normal(0, np.std(prices) * 0.1)
            predicted_price = predicted_ma + noise
            predictions.append(predicted_price)
        
        return predictions, slope, last_ma
    except Exception as e:
        st.error(f"Moving Average ì˜ˆì¸¡ ì˜¤ë¥˜: {str(e)}")
        return None, None, None

def linear_regression_prediction(prices, days=252):
    """ì„ í˜• íšŒê·€ ëª¨ë¸ì„ ì‚¬ìš©í•œ ì£¼ê°€ ì˜ˆì¸¡"""
    try:
        # ì‹œê°„ ì¶• ìƒì„±
        x = np.arange(len(prices)).reshape(-1, 1)
        y = np.array(prices)
        
        # ì„ í˜• íšŒê·€ ëª¨ë¸ í›ˆë ¨
        model = LinearRegression()
        model.fit(x, y)
        
        # ë¯¸ë˜ ì‹œì  ì˜ˆì¸¡
        future_x = np.arange(len(prices), len(prices) + days).reshape(-1, 1)
        predictions = model.predict(future_x)
        
        # ëª¨ë¸ ì„±ëŠ¥
        r2_score = model.score(x, y)
        
        return predictions.tolist(), model.coef_[0], r2_score
    except Exception as e:
        st.error(f"Linear Regression ì˜ˆì¸¡ ì˜¤ë¥˜: {str(e)}")
        return None, None, None

def exponential_smoothing_prediction(prices, alpha=0.3, days=252):
    """ì§€ìˆ˜í‰í™œë²•ì„ ì‚¬ìš©í•œ ì£¼ê°€ ì˜ˆì¸¡"""
    try:
        # ë‹¨ìˆœ ì§€ìˆ˜í‰í™œ
        smoothed = [prices[0]]
        
        for i in range(1, len(prices)):
            smoothed_value = alpha * prices[i] + (1 - alpha) * smoothed[-1]
            smoothed.append(smoothed_value)
        
        # ì¶”ì„¸ ê³„ì‚°
        recent_trend = np.mean(np.diff(smoothed[-10:]))
        
        # ì˜ˆì¸¡
        last_smoothed = smoothed[-1]
        predictions = []
        
        for i in range(1, days + 1):
            # ì§€ìˆ˜í‰í™œê°’ + ì¶”ì„¸ + ë…¸ì´ì¦ˆ
            noise = np.random.normal(0, np.std(prices) * 0.05)
            predicted_price = last_smoothed + recent_trend * i + noise
            predictions.append(predicted_price)
        
        return predictions, alpha, recent_trend
    except Exception as e:
        st.error(f"Exponential Smoothing ì˜ˆì¸¡ ì˜¤ë¥˜: {str(e)}")
        return None, None, None

def simple_arima_prediction(prices, days=252):
    """ê°„ë‹¨í•œ ARIMA ìŠ¤íƒ€ì¼ ì˜ˆì¸¡ (statsmodels ì—†ì´)"""
    try:
        # AR(1) ëª¨ë¸ ê·¼ì‚¬
        # ê°€ê²© ì°¨ë¶„
        diff_prices = np.diff(prices)
        
        # AR(1) ê³„ìˆ˜ ì¶”ì •
        x = diff_prices[:-1]
        y = diff_prices[1:]
        
        # ë‹¨ìˆœ ì„ í˜• íšŒê·€ë¡œ AR ê³„ìˆ˜ ì¶”ì •
        coef = np.corrcoef(x, y)[0, 1] if len(x) > 1 else 0.1
        
        # ì˜ˆì¸¡
        last_price = prices[-1]
        last_diff = diff_prices[-1]
        
        predictions = [last_price]
        current_diff = last_diff
        
        for i in range(days):
            # AR(1) + ë…¸ì´ì¦ˆ
            next_diff = coef * current_diff + np.random.normal(0, np.std(diff_prices))
            next_price = predictions[-1] + next_diff
            predictions.append(next_price)
            current_diff = next_diff
        
        return predictions[1:], coef, np.std(diff_prices)
    except Exception as e:
        st.error(f"ARIMA ìŠ¤íƒ€ì¼ ì˜ˆì¸¡ ì˜¤ë¥˜: {str(e)}")
        return None, None, None

def calculate_prediction_metrics(actual, predicted):
    """ì˜ˆì¸¡ ì„±ëŠ¥ ì§€í‘œ ê³„ì‚°"""
    try:
        if len(actual) != len(predicted):
            min_len = min(len(actual), len(predicted))
            actual = actual[:min_len]
            predicted = predicted[:min_len]
        
        mse = mean_squared_error(actual, predicted)
        mae = mean_absolute_error(actual, predicted)
        rmse = np.sqrt(mse)
        
        # MAPE (Mean Absolute Percentage Error)
        mape = np.mean(np.abs((actual - predicted) / actual)) * 100
        
        return {
            'MSE': mse,
            'MAE': mae,
            'RMSE': rmse,
            'MAPE': mape
        }
    except Exception as e:
        st.error(f"ì„±ëŠ¥ ì§€í‘œ ê³„ì‚° ì˜¤ë¥˜: {str(e)}")
        return None

def create_prediction_chart(historical_data, predictions_dict, company_name):
    """ì˜ˆì¸¡ ê²°ê³¼ ì°¨íŠ¸ ìƒì„±"""
    try:
        fig = go.Figure()
        
        # ê³¼ê±° ë°ì´í„°
        fig.add_trace(go.Scatter(
            x=historical_data.index,
            y=historical_data['Close'],
            mode='lines',
            name='ì‹¤ì œ ì£¼ê°€',
            line=dict(color='blue', width=2)
        ))
        
        # ì˜ˆì¸¡ ì‹œì‘ì  í‘œì‹œ
        last_date = historical_data.index[-1]
        last_price = historical_data['Close'].iloc[-1]
        
        # ë¯¸ë˜ ë‚ ì§œ ìƒì„± (252 ê±°ë˜ì¼ = ì•½ 1ë…„)
        future_dates = pd.date_range(start=last_date + pd.Timedelta(days=1), periods=252, freq='B')
        
        # ê° ëª¨ë¸ì˜ ì˜ˆì¸¡ ê²°ê³¼
        colors = ['red', 'green', 'orange', 'purple', 'brown']
        
        for i, (model_name, predictions) in enumerate(predictions_dict.items()):
            if predictions is not None:
                # ì—°ê²°ì  ì¶”ê°€ (ë§ˆì§€ë§‰ ì‹¤ì œ ê°€ê²©ê³¼ ì²« ì˜ˆì¸¡ ê°€ê²© ì—°ê²°)
                connection_x = [last_date, future_dates[0]]
                connection_y = [last_price, predictions[0]]
                
                fig.add_trace(go.Scatter(
                    x=connection_x,
                    y=connection_y,
                    mode='lines',
                    line=dict(color=colors[i % len(colors)], width=1, dash='dot'),
                    showlegend=False
                ))
                
                # ì˜ˆì¸¡ ë¼ì¸
                fig.add_trace(go.Scatter(
                    x=future_dates,
                    y=predictions,
                    mode='lines',
                    name=f'{model_name} ì˜ˆì¸¡',
                    line=dict(color=colors[i % len(colors)], width=2, dash='dash')
                ))
        
        fig.update_layout(
            title=f"{company_name} - 1ë…„ ì£¼ê°€ ì˜ˆì¸¡",
            xaxis_title="ë‚ ì§œ",
            yaxis_title="ì£¼ê°€ (ì›)",
            hovermode='x unified',
            height=600
        )
        
        return fig
    except Exception as e:
        st.error(f"ì°¨íŠ¸ ìƒì„± ì˜¤ë¥˜: {str(e)}")
        return None

# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
if 'current_analysis' not in st.session_state:
    st.session_state.current_analysis = None
if 'enable_reasoning' not in st.session_state:
    st.session_state.enable_reasoning = False

# ë©”ì¸ íƒ­ êµ¬ì„±
tab1, tab2, tab3, tab4, tab5, tab6 = st.tabs([
    "ğŸ“Š ì§€ìˆ˜ í˜„í™©",
    "ğŸ¢ ê¸°ì—… ë¶„ì„", 
    "ğŸ“ˆ ë¹„êµ ë¶„ì„",
    "ğŸ¤– AI ë¶„ì„",
    "ğŸ’° ê¸°ì—…ê°€ì¹˜í‰ê°€",
    "ğŸ”® ì£¼ê°€ ì˜ˆì¸¡"
])

# Tab 1: ì§€ìˆ˜ í˜„í™©
with tab1:
    st.header("ğŸ“Š í•œêµ­ ì£¼ìš” ì§€ìˆ˜ í˜„í™©")
    
    col1, col2 = st.columns(2)
    
    for i, (index_name, symbol) in enumerate(INDICES.items()):
        with col1 if i % 2 == 0 else col2:
            try:
                hist, info = get_stock_data(symbol, "5d")
                if hist is not None and not hist.empty:
                    current_price = hist['Close'][-1]
                    prev_price = hist['Close'][-2] if len(hist) > 1 else current_price
                    change = current_price - prev_price
                    change_pct = (change / prev_price) * 100
                    
                    # ìƒ‰ìƒ ê²°ì •
                    color = "red" if change >= 0 else "blue"
                    arrow = "â–²" if change >= 0 else "â–¼"
                    
                    st.metric(
                        label=f"{index_name}",
                        value=f"{current_price:,.2f}",
                        delta=f"{arrow} {change:+.2f} ({change_pct:+.2f}%)"
                    )
                    
                    # ê°„ë‹¨í•œ ì°¨íŠ¸
                    fig = px.line(
                        x=hist.index, 
                        y=hist['Close'],
                        title=f"{index_name} (5ì¼)"
                    )
                    fig.update_layout(height=250, showlegend=False)
                    st.plotly_chart(fig, use_container_width=True)
                else:
                    # ì‹¤ì œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ëŠ” ê²½ìš°
                    st.error(f"âŒ {index_name} ì‹¤ì œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                    st.metric(
                        label=f"{index_name}",
                        value="ë°ì´í„° ì—†ìŒ",
                        delta="ì‹¤ì œ ë°ì´í„° ì—†ìŒ"
                    )
                    
            except Exception as e:
                st.error(f"âŒ {index_name}: ì‹¤ì œ ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨")
                st.metric(
                    label=f"{index_name}",
                    value="ì˜¤ë¥˜",
                    delta="ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨"
                )

# Tab 2: ê¸°ì—… ë¶„ì„
with tab2:
    st.header("ğŸ¢ ê°œë³„ ê¸°ì—… ë¶„ì„")
    
    # ê¸°ì—… ì„ íƒ ë°©ì‹
    selection_method_company = st.radio(
        "ğŸ¢ ê¸°ì—… ì„ íƒ ë°©ì‹",
        ["ğŸ“‹ ëª©ë¡ì—ì„œ ì„ íƒ", "âœï¸ ì§ì ‘ ì…ë ¥"],
        horizontal=True,
        key="company_analysis_method"
    )
    
    col1, col2 = st.columns([2, 1])
    
    with col2:
        period = st.selectbox(
            "ë¶„ì„ ê¸°ê°„",
            ["1mo", "3mo", "6mo", "1y", "2y"],
            index=3,
            help="ì£¼ê°€ ë°ì´í„° ë¶„ì„ ê¸°ê°„ì„ ì„ íƒí•˜ì„¸ìš”."
        )
    
    if selection_method_company == "ğŸ“‹ ëª©ë¡ì—ì„œ ì„ íƒ":
        with col1:
            # ì‹œì¥ êµ¬ë¶„ ì„ íƒ
            market_type_company = st.selectbox(
                "ğŸ“Š ì‹œì¥ êµ¬ë¶„",
                ["ğŸ”µ ì½”ìŠ¤í”¼ (KOSPI)", "ğŸŸ¡ ì½”ìŠ¤ë‹¥ (KOSDAQ)", "ğŸŒ ì „ì²´"],
                key="company_market_type"
            )
            
            # ì‹œì¥ë³„ ê¸°ì—… ë¦¬ìŠ¤íŠ¸
            if market_type_company == "ğŸ”µ ì½”ìŠ¤í”¼ (KOSPI)":
                available_stocks_company = KOSPI_STOCKS
            elif market_type_company == "ğŸŸ¡ ì½”ìŠ¤ë‹¥ (KOSDAQ)":
                available_stocks_company = KOSDAQ_STOCKS  
            else:  # ì „ì²´
                available_stocks_company = KOREAN_STOCKS
            
            selected_company = st.selectbox(
                f"ê¸°ì—… ì„ íƒ ({len(available_stocks_company)}ê°œ)",
                list(available_stocks_company.keys()),
                help="ì£¼ìš” í•œêµ­ ê¸°ì—…ë“¤ì˜ ì¬ë¬´ ë°ì´í„°ë¥¼ ë¶„ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
            )
            
            symbol = available_stocks_company[selected_company]
            company_display_name = selected_company
    
    else:  # ì§ì ‘ ì…ë ¥
        with col1:
            sub_col1, sub_col2 = st.columns([2, 1])
            
            with sub_col1:
                company_code_input = st.text_input(
                    "ğŸ“ ì¢…ëª©ì½”ë“œ ì…ë ¥",
                    placeholder="ì˜ˆ: 005930, 035720",
                    key="company_code_input"
                )
            
            with sub_col2:
                market_suffix_company = st.selectbox(
                    "ğŸ›ï¸ ì‹œì¥",
                    ["KS (ì½”ìŠ¤í”¼)", "KQ (ì½”ìŠ¤ë‹¥)"],
                    key="company_market_suffix"
                )
            
            if company_code_input and len(company_code_input) == 6 and company_code_input.isdigit():
                suffix = ".KS" if market_suffix_company.startswith("KS") else ".KQ"
                symbol = company_code_input + suffix
                selected_company = f"ì¢…ëª©ì½”ë“œ {company_code_input}"
                company_display_name = selected_company
                
                market_name = "ì½”ìŠ¤í”¼" if suffix == ".KS" else "ì½”ìŠ¤ë‹¥"
                st.success(f"âœ… ì…ë ¥: **{company_code_input}** - {market_name}")
            elif company_code_input:
                st.error("âš ï¸ ì¢…ëª©ì½”ë“œëŠ” 6ìë¦¬ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤")
                selected_company = None
                symbol = None
                company_display_name = None
            else:
                selected_company = None
                symbol = None
                company_display_name = None
    
    if selected_company and symbol:
        with st.spinner("ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."):
            # ì£¼ê°€ ë°ì´í„°
            hist_data, stock_info = get_stock_data(symbol, period)
            
            # ì¬ë¬´ì œí‘œ ë°ì´í„°
            income_stmt, balance_sheet, cash_flow = get_financial_statements(symbol)
        
        if hist_data is not None and not hist_data.empty:
            # ê¸°ë³¸ ì •ë³´ í‘œì‹œ
            st.subheader(f"ğŸ“Š {company_display_name} ê¸°ë³¸ ì •ë³´")
            
            col1, col2, col3, col4 = st.columns(4)
            
            current_price = hist_data['Close'][-1]
            prev_price = hist_data['Close'][-2] if len(hist_data) > 1 else current_price
            change = current_price - prev_price
            change_pct = (change / prev_price) * 100
            
            with col1:
                st.metric("í˜„ì¬ê°€", f"{current_price:,.0f}ì›")
            
            with col2:
                st.metric("ì „ì¼ëŒ€ë¹„", f"{change:+,.0f}ì›", f"{change_pct:+.2f}%")
            
            with col3:
                if stock_info and 'marketCap' in stock_info:
                    market_cap = stock_info['marketCap']
                    st.metric("ì‹œê°€ì´ì•¡", f"{market_cap/1e12:.1f}ì¡°ì›")
                else:
                    st.metric("ì‹œê°€ì´ì•¡", "N/A")
            
            with col4:
                avg_volume = hist_data['Volume'][-30:].mean() if len(hist_data) >= 30 else hist_data['Volume'].mean()
                st.metric("í‰ê· ê±°ë˜ëŸ‰", f"{avg_volume:,.0f}")
            
            # ì°¨íŠ¸ í‘œì‹œ
            col1, col2 = st.columns([2, 1])
            
            with col1:
                # ì£¼ê°€ ì°¨íŠ¸
                fig_price = create_stock_chart(hist_data, company_display_name)
                st.plotly_chart(fig_price, use_container_width=True)
            
            with col2:
                # ê±°ë˜ëŸ‰ ì°¨íŠ¸
                fig_volume = create_volume_chart(hist_data, company_display_name)
                st.plotly_chart(fig_volume, use_container_width=True)
            
            # ì¬ë¬´ ë¹„ìœ¨
            if income_stmt is not None and balance_sheet is not None:
                st.subheader("ğŸ’° ì¬ë¬´ ë¹„ìœ¨")
                
                ratios = calculate_financial_ratios(income_stmt, balance_sheet)
                
                if ratios:
                    cols = st.columns(len(ratios))
                    for i, (ratio_name, value) in enumerate(ratios.items()):
                        with cols[i]:
                            st.metric(ratio_name, f"{value}")
                else:
                    st.warning("ì¬ë¬´ ë¹„ìœ¨ ê³„ì‚°ì— í•„ìš”í•œ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.")
            
            # ì¬ë¬´ì œí‘œ ìš”ì•½
            st.subheader("ğŸ“‹ ì¬ë¬´ì œí‘œ ìš”ì•½")
            
            if income_stmt is not None and not income_stmt.empty:
                with st.expander("ğŸ“Š ì†ìµê³„ì‚°ì„œ (ìµœê·¼ 4ë…„)", expanded=False):
                    # ì£¼ìš” í•­ëª©ë§Œ í‘œì‹œ
                    display_items = ['Total Revenue', 'Gross Profit', 'Operating Income', 'Net Income']
                    income_display = income_stmt.loc[income_stmt.index.intersection(display_items)]
                    
                    if not income_display.empty:
                        try:
                            # None ê°’ë“¤ì„ 0ìœ¼ë¡œ ì²˜ë¦¬í•˜ê³  ë‹¨ìœ„ë¥¼ ì–µì›ìœ¼ë¡œ ë³€í™˜
                            income_display_clean = income_display.fillna(0)
                            income_display_krw = income_display_clean / 1e8
                            st.dataframe(income_display_krw.round(0), use_container_width=True)
                            st.caption("ë‹¨ìœ„: ì–µì› (None ê°’ì€ 0ìœ¼ë¡œ í‘œì‹œ)")
                        except Exception as e:
                            st.warning(f"ì†ìµê³„ì‚°ì„œ í‘œì‹œ ì˜¤ë¥˜: {str(e)}")
                            st.dataframe(income_display, use_container_width=True)
                    else:
                        st.warning("ì†ìµê³„ì‚°ì„œ ì£¼ìš” í•­ëª© ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
            else:
                st.warning("ğŸ“Š ì†ìµê³„ì‚°ì„œ ë°ì´í„°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            
            if balance_sheet is not None and not balance_sheet.empty:
                with st.expander("ğŸ¦ ì¬ë¬´ìƒíƒœí‘œ (ìµœê·¼ 4ë…„)", expanded=False):
                    # ì£¼ìš” í•­ëª©ë§Œ í‘œì‹œ
                    display_items = ['Total Assets', 'Current Assets', 'Total Debt', 'Total Equity Gross Minority Interest']
                    balance_display = balance_sheet.loc[balance_sheet.index.intersection(display_items)]
                    
                    if not balance_display.empty:
                        try:
                            # None ê°’ë“¤ì„ 0ìœ¼ë¡œ ì²˜ë¦¬í•˜ê³  ë‹¨ìœ„ë¥¼ ì–µì›ìœ¼ë¡œ ë³€í™˜
                            balance_display_clean = balance_display.fillna(0)
                            balance_display_krw = balance_display_clean / 1e8
                            st.dataframe(balance_display_krw.round(0), use_container_width=True)
                            st.caption("ë‹¨ìœ„: ì–µì› (None ê°’ì€ 0ìœ¼ë¡œ í‘œì‹œ)")
                        except Exception as e:
                            st.warning(f"ì¬ë¬´ìƒíƒœí‘œ í‘œì‹œ ì˜¤ë¥˜: {str(e)}")
                            st.dataframe(balance_display, use_container_width=True)
                    else:
                        st.warning("ì¬ë¬´ìƒíƒœí‘œ ì£¼ìš” í•­ëª© ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
            else:
                st.warning("ğŸ¦ ì¬ë¬´ìƒíƒœí‘œ ë°ì´í„°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        
        else:
            st.error("ì„ íƒí•œ ê¸°ì—…ì˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

# Tab 3: ë¹„êµ ë¶„ì„
with tab3:
    st.header("ğŸ“ˆ ê¸°ì—… ë¹„êµ ë¶„ì„")
    
    # ê¸°ì—… ì„ íƒ ë°©ì‹
    selection_method_compare = st.radio(
        "ğŸ¢ ê¸°ì—… ì„ íƒ ë°©ì‹",
        ["ğŸ“‹ ëª©ë¡ì—ì„œ ì„ íƒ", "âœï¸ ì§ì ‘ ì…ë ¥ + ëª©ë¡"],
        horizontal=True,
        key="compare_selection_method"
    )
    
    col1, col2 = st.columns(2)
    
    with col2:
        compare_period = st.selectbox(
            "ë¹„êµ ê¸°ê°„",
            ["1mo", "3mo", "6mo", "1y", "2y"],
            index=3
        )
    
    if selection_method_compare == "ğŸ“‹ ëª©ë¡ì—ì„œ ì„ íƒ":
        with col1:
            # ì‹œì¥ êµ¬ë¶„ ì„ íƒ
            market_type_compare = st.selectbox(
                "ğŸ“Š ì‹œì¥ êµ¬ë¶„",
                ["ğŸ”µ ì½”ìŠ¤í”¼ (KOSPI)", "ğŸŸ¡ ì½”ìŠ¤ë‹¥ (KOSDAQ)", "ğŸŒ ì „ì²´"],
                key="compare_market_type"
            )
            
            # ì‹œì¥ë³„ ê¸°ì—… ë¦¬ìŠ¤íŠ¸
            if market_type_compare == "ğŸ”µ ì½”ìŠ¤í”¼ (KOSPI)":
                available_stocks_compare = KOSPI_STOCKS
                default_compare = ["ì‚¼ì„±ì „ì", "SKí•˜ì´ë‹‰ìŠ¤"]
            elif market_type_compare == "ğŸŸ¡ ì½”ìŠ¤ë‹¥ (KOSDAQ)":
                available_stocks_compare = KOSDAQ_STOCKS
                default_compare = ["ì¹´ì¹´ì˜¤", "í•˜ì´ë¸Œ"]
            else:  # ì „ì²´
                available_stocks_compare = KOREAN_STOCKS
                default_compare = ["ì‚¼ì„±ì „ì", "SKí•˜ì´ë‹‰ìŠ¤"]
            
            companies_to_compare = st.multiselect(
                f"ë¹„êµí•  ê¸°ì—…ë“¤ì„ ì„ íƒí•˜ì„¸ìš” (ìµœëŒ€ 4ê°œ, {len(available_stocks_compare)}ê°œ ê¸°ì—…)",
                list(available_stocks_compare.keys()),
                default=[c for c in default_compare if c in available_stocks_compare],
                max_selections=4
            )
            
            # ì„ íƒëœ ê¸°ì—…ë“¤ê³¼ ì¢…ëª©ì½”ë“œ ë§¤í•‘
            compare_symbols = {}
            for company in companies_to_compare:
                compare_symbols[company] = available_stocks_compare[company]
                
    else:  # ì§ì ‘ ì…ë ¥ + ëª©ë¡
        with col1:
            st.info("ğŸ’¡ ëª©ë¡ì—ì„œ ì„ íƒí•˜ê±°ë‚˜ ì¢…ëª©ì½”ë“œë¥¼ ì§ì ‘ ì…ë ¥í•˜ì—¬ ë¹„êµí•˜ì„¸ìš”")
            
            # ê¸°ì¡´ ëª©ë¡ì—ì„œ ì„ íƒ
            st.subheader("ğŸ“‹ ëª©ë¡ì—ì„œ ì„ íƒ")
            market_type_compare = st.selectbox(
                "ì‹œì¥ êµ¬ë¶„",
                ["ğŸ”µ ì½”ìŠ¤í”¼", "ğŸŸ¡ ì½”ìŠ¤ë‹¥", "ğŸŒ ì „ì²´"],
                key="compare_market_select"
            )
            
            if market_type_compare == "ğŸ”µ ì½”ìŠ¤í”¼":
                available_stocks_compare = KOSPI_STOCKS
            elif market_type_compare == "ğŸŸ¡ ì½”ìŠ¤ë‹¥":
                available_stocks_compare = KOSDAQ_STOCKS
            else:
                available_stocks_compare = KOREAN_STOCKS
            
            companies_from_list = st.multiselect(
                f"ëª©ë¡ì—ì„œ ì„ íƒ ({len(available_stocks_compare)}ê°œ)",
                list(available_stocks_compare.keys()),
                max_selections=4,
                key="companies_from_list"
            )
            
            # ì§ì ‘ ì…ë ¥
            st.subheader("âœï¸ ì¢…ëª©ì½”ë“œ ì§ì ‘ ì…ë ¥")
            custom_companies = []
            custom_symbols = {}
            
            for i in range(4):
                col_code, col_market = st.columns([2, 1])
                
                with col_code:
                    custom_code = st.text_input(
                        f"ì¢…ëª©ì½”ë“œ {i+1}",
                        placeholder="ì˜ˆ: 005930",
                        key=f"custom_code_{i}"
                    )
                
                with col_market:
                    custom_market = st.selectbox(
                        f"ì‹œì¥ {i+1}",
                        ["KS", "KQ"],
                        key=f"custom_market_{i}"
                    )
                
                if custom_code and len(custom_code) == 6 and custom_code.isdigit():
                    suffix = ".KS" if custom_market == "KS" else ".KQ"
                    symbol = custom_code + suffix
                    company_name = f"ì¢…ëª©_{custom_code}"
                    custom_companies.append(company_name)
                    custom_symbols[company_name] = symbol
            
            # ì „ì²´ ì„ íƒëœ ê¸°ì—…ë“¤
            companies_to_compare = companies_from_list + custom_companies
            
            # ì „ì²´ ì‹¬ë³¼ ë§¤í•‘
            compare_symbols = {}
            for company in companies_from_list:
                compare_symbols[company] = available_stocks_compare[company]
            compare_symbols.update(custom_symbols)
            
            if len(companies_to_compare) > 4:
                st.warning("âš ï¸ ìµœëŒ€ 4ê°œ ê¸°ì—…ê¹Œì§€ ë¹„êµ ê°€ëŠ¥í•©ë‹ˆë‹¤.")
                companies_to_compare = companies_to_compare[:4]
                compare_symbols = {k: v for k, v in list(compare_symbols.items())[:4]}
    
    if len(companies_to_compare) >= 2:
        with st.spinner("ë¹„êµ ë°ì´í„°ë¥¼ ì¤€ë¹„í•˜ëŠ” ì¤‘..."):
            comparison_data = {}
            
            for company in companies_to_compare:
                symbol = compare_symbols[company]
                hist, info = get_stock_data(symbol, compare_period)
                if hist is not None and not hist.empty:
                    comparison_data[company] = hist
            
            if comparison_data:
                # ìˆ˜ìµë¥  ë¹„êµ ì°¨íŠ¸
                st.subheader("ğŸ“Š ì£¼ê°€ ìˆ˜ìµë¥  ë¹„êµ")
                
                fig_compare = go.Figure()
                
                for company, hist in comparison_data.items():
                    # ìˆ˜ìµë¥  ê³„ì‚° (ì²« ë²ˆì§¸ ë‚  ê¸°ì¤€ ì •ê·œí™”)
                    normalized = (hist['Close'] / hist['Close'].iloc[0] - 1) * 100
                    
                    fig_compare.add_trace(go.Scatter(
                        x=hist.index,
                        y=normalized,
                        mode='lines',
                        name=company,
                        line=dict(width=2)
                    ))
                
                fig_compare.update_layout(
                    title="ê¸°ì—…ë³„ ì£¼ê°€ ìˆ˜ìµë¥  ë¹„êµ (%)",
                    yaxis_title="ìˆ˜ìµë¥  (%)",
                    xaxis_title="ë‚ ì§œ",
                    height=500,
                    hovermode='x unified'
                )
                
                st.plotly_chart(fig_compare, use_container_width=True)
                
                # ì„±ê³¼ ìš”ì•½ í…Œì´ë¸”
                st.subheader("ğŸ“‹ ì„±ê³¼ ìš”ì•½")
                
                performance_data = []
                for company, hist in comparison_data.items():
                    current = hist['Close'][-1]
                    start = hist['Close'].iloc[0]
                    total_return = ((current / start) - 1) * 100
                    volatility = hist['Close'].pct_change().std() * np.sqrt(252) * 100  # ì—°í™˜ì‚° ë³€ë™ì„±
                    max_price = hist['Close'].max()
                    min_price = hist['Close'].min()
                    
                    performance_data.append({
                        'ê¸°ì—…ëª…': company,
                        'í˜„ì¬ê°€': f"{current:,.0f}ì›",
                        'ì´ìˆ˜ìµë¥ ': f"{total_return:+.2f}%",
                        'ì—°ë³€ë™ì„±': f"{volatility:.2f}%",
                        'ìµœê³ ê°€': f"{max_price:,.0f}ì›",
                        'ìµœì €ê°€': f"{min_price:,.0f}ì›"
                    })
                
                performance_df = pd.DataFrame(performance_data)
                st.dataframe(performance_df, use_container_width=True, hide_index=True)
            
            else:
                st.warning("ì„ íƒí•œ ê¸°ì—…ë“¤ì˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    
    else:
        st.info("ë¹„êµ ë¶„ì„ì„ ìœ„í•´ ìµœì†Œ 2ê°œ ê¸°ì—…ì„ ì„ íƒí•´ì£¼ì„¸ìš”.")

# Tab 4: AI ë¶„ì„
with tab4:
    st.header("ğŸ¤– AI ì¬ë¬´ ë¶„ì„")
    
    # ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™” (ì´ì „ ë¶„ì„ ê²°ê³¼ ìœ ì§€)
    if 'current_analysis' not in st.session_state:
        st.session_state.current_analysis = None
    
    # ì´ì „ ë¶„ì„ ê²°ê³¼ê°€ ìˆìœ¼ë©´ í‘œì‹œ
    if st.session_state.current_analysis is not None:
        prev_analysis = st.session_state.current_analysis
        
        # ì´ì „ ë¶„ì„ ê²°ê³¼ í‘œì‹œ ì˜ì—­
        with st.expander(f"ğŸ“ **ì´ì „ ë¶„ì„ ê²°ê³¼**: {prev_analysis['company']} ({prev_analysis.get('timestamp', 'N/A')})", expanded=False):
            st.info(f"ğŸ¢ **ê¸°ì—…**: {prev_analysis['company']} ({prev_analysis['symbol']})")
            st.info(f"ğŸ¤– **ëª¨ë¸**: {prev_analysis['model']}")
            st.info(f"ğŸ”§ **ë¶„ì„ ë°©ì‹**: {prev_analysis['analysis_mode']}")
            
            if prev_analysis['analysis_mode'] == 'multi_agent':
                st.info(f"ğŸ‘¥ **ì„ íƒ ì „ë¬¸ê°€**: {len(prev_analysis.get('agents', []))}ëª…")
                
                # ì—ì´ì „íŠ¸ë³„ ë¶„ì„ ê²°ê³¼
                if 'agent_analyses' in prev_analysis:
                    st.markdown("### ğŸ“‹ ì „ë¬¸ê°€ë³„ ë¶„ì„ ê²°ê³¼")
                    for idx, analysis in enumerate(prev_analysis['agent_analyses']):
                        if analysis['success']:
                            # Expander ëŒ€ì‹  êµ¬ë¶„ì„ ê³¼ ì œëª© ì‚¬ìš©
                            st.markdown("---")
                            st.markdown(f"**{analysis['agent_emoji']} {analysis['agent_name']} ë¶„ì„**")
                            
                            # AI ë¶„ì„ ê²°ê³¼ì™€ Plotly ì°¨íŠ¸ í‘œì‹œ
                            if analysis['analysis']:
                                # ê° ì—ì´ì „íŠ¸ë³„ ê³ ìœ  ì‹ë³„ìë¡œ ì°¨íŠ¸ í‘œì‹œ
                                display_analysis_with_plotly_charts(
                                    analysis['analysis'], 
                                    chart_id=f"prev_{idx}_{analysis['agent_key']}"
                                )
                                    
                            # Reasoning ê³¼ì •
                            if analysis.get('has_thinking', False) and analysis.get('thinking', '').strip():
                                st.markdown("**ğŸ§  AI ì‚¬ê³  ê³¼ì •:**")
                                st.text_area(
                                    f"Reasoning - {analysis['agent_name']}", 
                                    value=analysis['thinking'], 
                                    height=80, 
                                    disabled=True,
                                    key=f"prev_thinking_{idx}_{analysis['agent_key']}"
                                )
                        else:
                            st.error(f"âŒ {analysis['agent_emoji']} {analysis['agent_name']}: {analysis['error']}")
                
                # CFO ì¢…í•© ë¶„ì„
                if 'cfo_analysis' in prev_analysis and prev_analysis['cfo_analysis']['success']:
                    st.markdown("---")
                    st.markdown("### ğŸ‘” CFO ì¢…í•© ë¶„ì„")
                    # Plotly ì°¨íŠ¸ì™€ í•¨ê»˜ CFO ë¶„ì„ í‘œì‹œ
                    if prev_analysis['cfo_analysis']['content']:
                        display_analysis_with_plotly_charts(
                            prev_analysis['cfo_analysis']['content'],
                            chart_id="prev_cfo"
                        )
                        
            else:  # single AI analysis
                if 'single_analysis' in prev_analysis:
                    st.markdown("---")
                    st.markdown("### ğŸ“Š AI ë¶„ì„ ê²°ê³¼")
                    # Plotly ì°¨íŠ¸ì™€ í•¨ê»˜ ë‹¨ì¼ AI ë¶„ì„ í‘œì‹œ
                    if prev_analysis['single_analysis']:
                        display_analysis_with_plotly_charts(
                            prev_analysis['single_analysis'],
                            chart_id="prev_single"
                        )
                        
                    # Reasoning ê³¼ì •
                    if prev_analysis.get('has_thinking', False) and prev_analysis.get('thinking', '').strip():
                        st.markdown("**ğŸ§  AI ì‚¬ê³  ê³¼ì •:**")
                        st.text_area(
                            "Reasoning - Single AI", 
                            value=prev_analysis['thinking'], 
                            height=80, 
                            disabled=True,
                            key="prev_single_thinking"
                        )
            
            # ë¶„ì„ ê²°ê³¼ ì´ˆê¸°í™” ë²„íŠ¼
            if st.button("ğŸ—‘ï¸ ì´ì „ ë¶„ì„ ê²°ê³¼ ì§€ìš°ê¸°", key="clear_analysis"):
                st.session_state.current_analysis = None
                st.rerun()
    
    st.markdown("---")
    st.subheader("ğŸ†• ìƒˆë¡œìš´ ë¶„ì„ ì‹œì‘")
    
    # AI ëª¨ë¸ ì„ íƒ
    col1, col2 = st.columns([2, 1])
    
    with col1:
        ai_models = [
            "claude-3-7-sonnet-latest",
            "claude-3-5-sonnet-latest", 
            "claude-3-5-sonnet-20241022",
            "claude-3-5-haiku-20241022",
            "gpt-4o",
            "gpt-4o-mini",
            "gpt-4-turbo",
            "o1-preview",
            "o1-mini"
        ]
        
        selected_ai_model = st.selectbox(
            "ğŸ¯ AI ëª¨ë¸ ì„ íƒ",
            ai_models,
            index=0,
            help="Claude reasoning ëª¨ë¸ê³¼ o1 ëª¨ë¸ì€ ì‹¬í™” ë¶„ì„ì„ ì œê³µí•©ë‹ˆë‹¤."
        )
    
    with col2:
        enable_reasoning = st.checkbox(
            "ğŸ§  Reasoning ëª¨ë“œ",
            value=st.session_state.enable_reasoning,
            help="AIì˜ ì‚¬ê³  ê³¼ì •ì„ í‘œì‹œí•©ë‹ˆë‹¤."
        )
        st.session_state.enable_reasoning = enable_reasoning
        
        # ì°¨íŠ¸ ë””ë²„ê¹… ëª¨ë“œ ì¶”ê°€
        if 'chart_debug_mode' not in st.session_state:
            st.session_state.chart_debug_mode = False
            
        chart_debug = st.checkbox(
            "ğŸ”§ ì°¨íŠ¸ ë””ë²„ê¹…",
            value=st.session_state.chart_debug_mode,
            help="Mermaid ì°¨íŠ¸ ë³€í™˜ ê³¼ì •ì„ ìƒì„¸íˆ í‘œì‹œí•©ë‹ˆë‹¤."
        )
        st.session_state.chart_debug_mode = chart_debug
        
        # Graphviz í…ŒìŠ¤íŠ¸ ë²„íŠ¼
        if st.button("ğŸ§ª ì°¨íŠ¸ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸", help="Graphvizì™€ Mermaid ë Œë”ë§ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤."):
            st.markdown("---")
            st.subheader("ğŸ§ª ì°¨íŠ¸ ì‹œìŠ¤í…œ ì§„ë‹¨")
            
            # 1. Graphviz ê¸°ë³¸ í…ŒìŠ¤íŠ¸
            try:
                test_chart = create_simple_test_chart()
                st.markdown("**1ï¸âƒ£ Graphviz ê¸°ë³¸ í…ŒìŠ¤íŠ¸:**")
                st.graphviz_chart(test_chart, use_container_width=True)
                st.success("âœ… Graphviz ë¼ì´ë¸ŒëŸ¬ë¦¬ ì •ìƒ ì‘ë™")
            except Exception as e:
                st.error(f"âŒ Graphviz ë¼ì´ë¸ŒëŸ¬ë¦¬ ì˜¤ë¥˜: {str(e)}")
            
            # 2. HTML Mermaid í…ŒìŠ¤íŠ¸
            try:
                st.markdown("**2ï¸âƒ£ HTML Mermaid.js í…ŒìŠ¤íŠ¸:**")
                test_mermaid = """flowchart TD
    A[ì‹œì‘] --> B[ì²˜ë¦¬]
    B --> C[ì™„ë£Œ]"""
                render_mermaid_with_html(test_mermaid, "test")
                st.success("âœ… HTML Mermaid.js ë Œë”ë§ í…ŒìŠ¤íŠ¸ ì™„ë£Œ")
            except Exception as e:
                st.error(f"âŒ HTML Mermaid ë Œë”ë§ ì˜¤ë¥˜: {str(e)}")
            
            # 3. Mermaid to Graphviz ë³€í™˜ í…ŒìŠ¤íŠ¸
            try:
                st.markdown("**3ï¸âƒ£ Mermaid â†’ Graphviz ë³€í™˜ í…ŒìŠ¤íŠ¸:**")
                test_mermaid = """flowchart TD
    A[í…ŒìŠ¤íŠ¸ ì‹œì‘] --> B[ë³€í™˜ ê³¼ì •]
    B --> C[ê²°ê³¼ í™•ì¸]"""
                converted_dot = mermaid_to_graphviz(test_mermaid)
                if converted_dot:
                    st.graphviz_chart(converted_dot, use_container_width=True)
                    st.success("âœ… Mermaid â†’ Graphviz ë³€í™˜ ì„±ê³µ")
                else:
                    st.error("âŒ Mermaid â†’ Graphviz ë³€í™˜ ì‹¤íŒ¨")
            except Exception as e:
                st.error(f"âŒ ë³€í™˜ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: {str(e)}")
            
            st.markdown("---")
    
    # ë¶„ì„í•  ê¸°ì—… ì„ íƒ ë°©ì‹
    selection_method = st.radio(
        "ğŸ¢ ê¸°ì—… ì„ íƒ ë°©ì‹",
        ["ğŸ“‹ ëª©ë¡ì—ì„œ ì„ íƒ", "âœï¸ ì§ì ‘ ì…ë ¥"],
        horizontal=True,
        help="ê¸°ì—…ì„ ëª©ë¡ì—ì„œ ì„ íƒí•˜ê±°ë‚˜ ì¢…ëª©ì½”ë“œë¥¼ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”."
    )
    
    if selection_method == "ğŸ“‹ ëª©ë¡ì—ì„œ ì„ íƒ":
        # ì‹œì¥ êµ¬ë¶„ ì„ íƒ
        market_type = st.selectbox(
            "ğŸ“Š ì‹œì¥ êµ¬ë¶„",
            ["ğŸ”µ ì½”ìŠ¤í”¼ (KOSPI)", "ğŸŸ¡ ì½”ìŠ¤ë‹¥ (KOSDAQ)", "ğŸŒ ì „ì²´"],
            help="ë¶„ì„í•  ê¸°ì—…ì´ ì†í•œ ì‹œì¥ì„ ì„ íƒí•˜ì„¸ìš”."
        )
        
        # ì‹œì¥ë³„ ê¸°ì—… ë¦¬ìŠ¤íŠ¸
        if market_type == "ğŸ”µ ì½”ìŠ¤í”¼ (KOSPI)":
            available_stocks = KOSPI_STOCKS
            st.info("ğŸ“ˆ ì½”ìŠ¤í”¼ ìƒì¥ ëŒ€ê¸°ì—…ë“¤ (ì‹œê°€ì´ì•¡ ê¸°ì¤€ ì£¼ìš” ê¸°ì—…)")
        elif market_type == "ğŸŸ¡ ì½”ìŠ¤ë‹¥ (KOSDAQ)":
            available_stocks = KOSDAQ_STOCKS  
            st.info("ğŸš€ ì½”ìŠ¤ë‹¥ ìƒì¥ ì„±ì¥ê¸°ì—…ë“¤ (IT, ë°”ì´ì˜¤, ê²Œì„ ë“±)")
        else:  # ì „ì²´
            available_stocks = KOREAN_STOCKS
            st.info("ğŸŒ ì½”ìŠ¤í”¼ + ì½”ìŠ¤ë‹¥ ì „ì²´ ì£¼ìš” ê¸°ì—…")
        
        analysis_company = st.selectbox(
            f"ğŸ¢ ê¸°ì—… ì„ íƒ ({len(available_stocks)}ê°œ ê¸°ì—…)",
            list(available_stocks.keys()),
            help="ì„ íƒí•œ ê¸°ì—…ì˜ ì¬ë¬´ ë°ì´í„°ë¥¼ AIê°€ ë¶„ì„í•©ë‹ˆë‹¤."
        )
        
        # ì„ íƒëœ ê¸°ì—…ì˜ ì¢…ëª©ì½”ë“œ í‘œì‹œ
        symbol = available_stocks[analysis_company]
        market_suffix = "ì½”ìŠ¤í”¼" if symbol.endswith(".KS") else "ì½”ìŠ¤ë‹¥"
        st.success(f"âœ… ì„ íƒ: **{analysis_company}** ({symbol.replace('.KS', '').replace('.KQ', '')}) - {market_suffix}")
        
    else:  # ì§ì ‘ ì…ë ¥
        col1, col2 = st.columns([2, 1])
        
        with col1:
            company_code = st.text_input(
                "ğŸ“ ì¢…ëª©ì½”ë“œ ì…ë ¥",
                placeholder="ì˜ˆ: 005930 (ì‚¼ì„±ì „ì), 035720 (ì¹´ì¹´ì˜¤)",
                help="6ìë¦¬ ì¢…ëª©ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ìˆ«ìë§Œ)"
            )
        
        with col2:
            market_suffix = st.selectbox(
                "ğŸ›ï¸ ì‹œì¥",
                ["KS (ì½”ìŠ¤í”¼)", "KQ (ì½”ìŠ¤ë‹¥)"],
                help="í•´ë‹¹ ê¸°ì—…ì´ ìƒì¥ëœ ì‹œì¥ì„ ì„ íƒí•˜ì„¸ìš”."
            )
        
        if company_code and len(company_code) == 6 and company_code.isdigit():
            suffix = ".KS" if market_suffix.startswith("KS") else ".KQ"
            symbol = company_code + suffix
            market_name = "ì½”ìŠ¤í”¼" if suffix == ".KS" else "ì½”ìŠ¤ë‹¥"
            
            analysis_company = f"ì§ì ‘ì…ë ¥_{company_code}"
            st.success(f"âœ… ì…ë ¥: **{company_code}** - {market_name}")
            st.info(f"ğŸ” ì¢…ëª©ì½”ë“œ: {symbol}")
        elif company_code:
            st.error("âš ï¸ ì¢…ëª©ì½”ë“œëŠ” 6ìë¦¬ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤ (ì˜ˆ: 005930)")
            analysis_company = None
            symbol = None
        else:
            analysis_company = None
            symbol = None
    
    # ë¶„ì„ ë°©ì‹ ì„ íƒ
    col1, col2 = st.columns([2, 1])
    
    with col1:
        analysis_mode = st.radio(
            "ğŸ”§ ë¶„ì„ ë°©ì‹ ì„ íƒ",
            ["ğŸ¤– ë©€í‹° ì—ì´ì „íŠ¸ ë¶„ì„ (ê¶Œì¥)", "ğŸ“Š ë‹¨ì¼ AI ë¶„ì„"],
            horizontal=True,
            help="ë©€í‹° ì—ì´ì „íŠ¸: 6ëª…ì˜ ì „ë¬¸ê°€ê°€ ë™ì‹œì— ë¶„ì„í•˜ì—¬ ì¢…í•© ì˜ê²¬ ì œì‹œ"
        )
    
    with col2:
        if analysis_mode == "ğŸ¤– ë©€í‹° ì—ì´ì „íŠ¸ ë¶„ì„ (ê¶Œì¥)":
            st.info("ğŸš€ **6ëª… ì „ë¬¸ê°€ ë™ì‹œ ë¶„ì„**")
        else:
            st.info("ğŸ¯ **ë‹¨ì¼ AI ì „ë¬¸ ë¶„ì„**")
    
    if analysis_mode == "ğŸ¤– ë©€í‹° ì—ì´ì „íŠ¸ ë¶„ì„ (ê¶Œì¥)":
        # ë©€í‹° ì—ì´ì „íŠ¸ ì„¤ì •
        st.subheader("ğŸ¯ ì „ë¬¸ê°€ ì—ì´ì „íŠ¸ ì„ íƒ")
        
        # ê¸°ë³¸ ê¶Œì¥ ì—ì´ì „íŠ¸
        default_agents = ["financial_analyst", "investment_analyst", "risk_manager", "technical_analyst"]
        
        # ì—ì´ì „íŠ¸ ì„ íƒ UI
        selected_agents = []
        
        cols = st.columns(3)
        for i, (agent_key, agent_info) in enumerate(FINANCIAL_AGENTS.items()):
            with cols[i % 3]:
                is_selected = st.checkbox(
                    f"{agent_info['emoji']} **{agent_info['name']}**",
                    value=(agent_key in default_agents),
                    help=agent_info['description'],
                    key=f"agent_{agent_key}"
                )
                if is_selected:
                    selected_agents.append(agent_key)
        
        if len(selected_agents) == 0:
            st.warning("âš ï¸ ìµœì†Œ 1ëª…ì˜ ì „ë¬¸ê°€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.")
        elif len(selected_agents) > 6:
            st.warning("âš ï¸ ìµœëŒ€ 6ëª…ê¹Œì§€ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.")
        else:
            st.success(f"âœ… {len(selected_agents)}ëª…ì˜ ì „ë¬¸ê°€ê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.")
    
    else:
        # ë‹¨ì¼ AI ë¶„ì„ ì„¤ì •
        analysis_type = st.selectbox(
            "ğŸ“Š ë¶„ì„ ì¢…ë¥˜",
            [
                "ì¢…í•© ì¬ë¬´ ë¶„ì„",
                "íˆ¬ì ì¶”ì²œ ë¶„ì„", 
                "ë¦¬ìŠ¤í¬ ë¶„ì„",
                "ê²½ìŸì‚¬ ë¹„êµ ë¶„ì„",
                "ê¸°ìˆ ì  ë¶„ì„"
            ]
        )
    
    # ì¶”ê°€ ì§ˆë¬¸
    custom_question = st.text_area(
        "ğŸ’­ ì¶”ê°€ ì§ˆë¬¸ (ì„ íƒì‚¬í•­)",
        placeholder="ì˜ˆ: ì´ ê¸°ì—…ì˜ ESG ê²½ì˜ ì „ëµì€ ì–´ë–»ê²Œ í‰ê°€í•˜ì‹œë‚˜ìš”?",
        height=100
    )
    
    # AI ë¶„ì„ ì‹¤í–‰ ë²„íŠ¼
    can_analyze = analysis_company and symbol
    
    if analysis_mode == "ğŸ¤– ë©€í‹° ì—ì´ì „íŠ¸ ë¶„ì„ (ê¶Œì¥)":
        can_analyze = can_analyze and len(selected_agents) > 0 and len(selected_agents) <= 6
        button_text = f"ğŸš€ ë©€í‹° ì—ì´ì „íŠ¸ ë¶„ì„ ì‹œì‘ ({len(selected_agents) if 'selected_agents' in locals() else 0}ëª… ì „ë¬¸ê°€)"
    else:
        button_text = "ğŸš€ AI ë¶„ì„ ì‹œì‘"
    
    if st.button(button_text, type="primary", disabled=not can_analyze):
        if analysis_company and symbol:
            # ê¸°ì—…ëª… í‘œì‹œ ì²˜ë¦¬
            if analysis_company.startswith("ì§ì ‘ì…ë ¥_"):
                company_display_name = f"ì¢…ëª©ì½”ë“œ {company_code}"
            else:
                company_display_name = analysis_company
            
            with st.spinner(f"ğŸ¤– {company_display_name} ë¶„ì„ ì¤€ë¹„ ì¤‘..."):
                start_time = time.time()
                
                # ì‹¤ì œ ë°ì´í„° ìˆ˜ì§‘ ì‹œë„
                st.info("ğŸ“Š ì‹¤ì‹œê°„ ì‹œì¥ ë°ì´í„° ìˆ˜ì§‘ ì¤‘...")
                hist_data, stock_info = get_stock_data(symbol, "1y")
                
                st.info("ğŸ“‹ ì‹¤ì œ ì¬ë¬´ì œí‘œ ë°ì´í„° ìˆ˜ì§‘ ì¤‘...")
                income_stmt, balance_sheet, cash_flow = get_financial_statements(symbol)
                
                # ë°ì´í„° ê²€ì¦ ë° í’ˆì§ˆ ì²´í¬ - ì‹¤ì œ ë°ì´í„°ë§Œ ì‚¬ìš©
                if hist_data is not None and not hasattr(hist_data, '_sample_data'):
                    st.success("âœ… ì£¼ê°€ ë°ì´í„°: ì‹¤ì œ ì‹œì¥ ë°ì´í„° ìˆ˜ì§‘ ì„±ê³µ")
                    
                    # ì¬ë¬´ì œí‘œ ë°ì´í„° í’ˆì§ˆ ì²´í¬ - ìƒì„¸ ë””ë²„ê¹…
                    st.info("ğŸ” **ì¬ë¬´ì œí‘œ ë°ì´í„° ê²€ì¦ ì¤‘...**")
                    
                    # ìƒì„¸ ë””ë²„ê¹… ì •ë³´
                    income_available = income_stmt is not None and not income_stmt.empty
                    balance_available = balance_sheet is not None and not balance_sheet.empty
                    
                    st.info(f"ğŸ“Š ì†ìµê³„ì‚°ì„œ ìƒíƒœ: {'âœ… ë°ì´í„° ìˆìŒ' if income_available else 'âŒ ë°ì´í„° ì—†ìŒ'}")
                    st.info(f"ğŸ¦ ì¬ë¬´ìƒíƒœí‘œ ìƒíƒœ: {'âœ… ë°ì´í„° ìˆìŒ' if balance_available else 'âŒ ë°ì´í„° ì—†ìŒ'}")
                    
                    # ë°ì´í„° ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°
                    if income_stmt is not None:
                        st.info(f"ğŸ“ˆ ì†ìµê³„ì‚°ì„œ í¬ê¸°: {income_stmt.shape if hasattr(income_stmt, 'shape') else 'N/A'}")
                        if hasattr(income_stmt, 'index'):
                            st.info(f"ğŸ“‹ ì£¼ìš” í•­ëª© ì˜ˆì‹œ: {list(income_stmt.index[:5]) if len(income_stmt.index) > 0 else 'ì—†ìŒ'}")
                    
                    if balance_sheet is not None:
                        st.info(f"ğŸ›ï¸ ì¬ë¬´ìƒíƒœí‘œ í¬ê¸°: {balance_sheet.shape if hasattr(balance_sheet, 'shape') else 'N/A'}")
                        if hasattr(balance_sheet, 'index'):
                            st.info(f"ğŸ“‹ ì£¼ìš” í•­ëª© ì˜ˆì‹œ: {list(balance_sheet.index[:5]) if len(balance_sheet.index) > 0 else 'ì—†ìŒ'}")
                    
                    if income_available or balance_available:
                        st.success("âœ… ì¬ë¬´ì œí‘œ: ì‹¤ì œ ì¬ë¬´ ë°ì´í„° ìˆ˜ì§‘ ì„±ê³µ")
                        has_financial_data = True
                    else:
                        st.error("âŒ ì¬ë¬´ì œí‘œ: ì‹¤ì œ ì¬ë¬´ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                        st.warning("âš ï¸ **ì›ì¸ ë¶„ì„**: Yahoo Finance APIì—ì„œ í•œêµ­ ê¸°ì—… ì¬ë¬´ì œí‘œ ë°ì´í„° ì œí•œ")
                        has_financial_data = False
                    
                    # ë¶„ì„ ë°ì´í„° ì¤€ë¹„
                    current_price = hist_data['Close'][-1]
                    year_return = ((current_price / hist_data['Close'].iloc[0]) - 1) * 100
                    volatility = hist_data['Close'].pct_change().std() * np.sqrt(252) * 100
                    
                    # ì¬ë¬´ ë¹„ìœ¨ ê³„ì‚° (ì‹¤ì œ ë°ì´í„°ë§Œ)
                    ratios = None
                    if has_financial_data:
                        ratios = calculate_financial_ratios(income_stmt, balance_sheet)
                    
                    # AI ë¶„ì„ í”„ë¡¬í”„íŠ¸ êµ¬ì„± - ì‹¤ì œ ë°ì´í„°ë§Œ
                    analysis_data = f"""
=== {company_display_name} ì¬ë¬´ ë¶„ì„ ë°ì´í„° ===
ì¢…ëª©ì½”ë“œ: {symbol}
ë¶„ì„ ì‹œì : {datetime.now().strftime('%Y-%m-%d %H:%M')}

ğŸ“ˆ ì£¼ê°€ ì •ë³´ (ì‹¤ì œ ì‹œì¥ ë°ì´í„°):
- í˜„ì¬ê°€: {current_price:,.0f}ì›  
- 1ë…„ ìˆ˜ìµë¥ : {year_return:+.2f}%
- ì—°ë³€ë™ì„±: {volatility:.2f}%
- ê±°ë˜ëŸ‰ í‰ê· : {hist_data['Volume'].mean():,.0f}
- 52ì£¼ ìµœê³ ê°€: {hist_data['High'].max():,.0f}ì›
- 52ì£¼ ìµœì €ê°€: {hist_data['Low'].min():,.0f}ì›

ğŸ’° ì¬ë¬´ ë¹„ìœ¨:
{json.dumps(ratios, ensure_ascii=False, indent=2) if ratios else "ì‹¤ì œ ì¬ë¬´ì œí‘œ ë°ì´í„° ì—†ìŒ - ì£¼ê°€ ì •ë³´ë§Œìœ¼ë¡œ ë¶„ì„ ì§„í–‰"}
"""
                    
                    # ì¬ë¬´ì œí‘œ ë°ì´í„° ì¶”ê°€ (ì•ˆì „í•œ ì ‘ê·¼)
                    if has_financial_data:
                        analysis_data += "\nğŸ“Š ì¬ë¬´ì œí‘œ ìš”ì•½ (ìµœê·¼ ì—°ë„, ì‹¤ì œ ë°ì´í„°):\n"
                        
                        if income_stmt is not None and not income_stmt.empty:
                            key_items = ['Total Revenue', 'Gross Profit', 'Operating Income', 'Net Income']
                            for item in key_items:
                                try:
                                    value = safe_value_access(income_stmt, item)
                                    if value is not None:
                                        value_krw = value / 1e8  # ì–µì› ë‹¨ìœ„
                                        analysis_data += f"- {item}: {value_krw:.0f}ì–µì›\n"
                                    else:
                                        analysis_data += f"- {item}: ë°ì´í„° ì—†ìŒ\n"
                                except Exception as e:
                                    analysis_data += f"- {item}: ì ‘ê·¼ ì˜¤ë¥˜\n"
                        
                        if balance_sheet is not None and not balance_sheet.empty:
                            key_items = ['Total Assets', 'Total Debt', 'Total Equity Gross Minority Interest']
                            for item in key_items:
                                try:
                                    value = safe_value_access(balance_sheet, item)
                                    if value is not None:
                                        value_krw = value / 1e8  # ì–µì› ë‹¨ìœ„
                                        analysis_data += f"- {item}: {value_krw:.0f}ì–µì›\n"
                                    else:
                                        analysis_data += f"- {item}: ë°ì´í„° ì—†ìŒ\n"
                                except Exception as e:
                                    analysis_data += f"- {item}: ì ‘ê·¼ ì˜¤ë¥˜\n"
                    else:
                        analysis_data += "\nâš ï¸ ì¬ë¬´ì œí‘œ ë°ì´í„°: ì‹¤ì œ ì¬ë¬´ì œí‘œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ì„œ ì£¼ê°€ ë°ì´í„°ë§Œìœ¼ë¡œ ë¶„ì„ì„ ì§„í–‰í•©ë‹ˆë‹¤.\n"
                    
                    if custom_question.strip():
                        analysis_data += f"\nğŸ¤” **ì¶”ê°€ ì§ˆë¬¸**: {custom_question}\n"
                    
                    # ë©€í‹° ì—ì´ì „íŠ¸ ë¶„ì„ vs ë‹¨ì¼ AI ë¶„ì„
                    if analysis_mode == "ğŸ¤– ë©€í‹° ì—ì´ì „íŠ¸ ë¶„ì„ (ê¶Œì¥)":
                        # ë©€í‹° ì—ì´ì „íŠ¸ ë¶„ì„ ì‹¤í–‰
                        agent_analyses, cfo_analysis = run_multi_agent_analysis(
                            company_display_name, 
                            analysis_data, 
                            selected_agents, 
                            selected_ai_model, 
                            enable_reasoning
                        )
                        
                        end_time = time.time()
                        execution_time = int(end_time - start_time)
                        
                        # ë¶„ì„ ê²°ê³¼ í‘œì‹œ
                        st.success(f"âœ… **ë©€í‹° ì—ì´ì „íŠ¸ ë¶„ì„ ì™„ë£Œ** (ì†Œìš”ì‹œê°„: {execution_time}ì´ˆ)")
                        
                        # ì‹¤ì œ ë°ì´í„° í’ˆì§ˆ ìš”ì•½ í‘œì‹œ
                        col1, col2, col3, col4 = st.columns(4)
                        with col1:
                            st.success("ğŸ“Š ì‹¤ì œ ì£¼ê°€ ë°ì´í„°")
                        
                        with col2:
                            if has_financial_data:
                                st.success("ğŸ“‹ ì‹¤ì œ ì¬ë¬´ì œí‘œ")
                            else:
                                st.warning("ğŸ“‹ ì¬ë¬´ì œí‘œ ì—†ìŒ")
                        
                        with col3:
                            st.info(f"ğŸ¤– {len(selected_agents)}ëª… ì „ë¬¸ê°€")
                        
                        with col4:
                            overall_quality = "ğŸŸ¢ ì™„ì „í•œ ë°ì´í„°" if has_financial_data else "ğŸŸ¡ ì£¼ê°€ë§Œ ê°€ëŠ¥"
                            st.info(f"ğŸ¯ {overall_quality}")
                        
                        # ì—ì´ì „íŠ¸ë³„ ë¶„ì„ ê²°ê³¼ í‘œì‹œ
                        st.markdown("## ğŸ“‹ ì „ë¬¸ê°€ë³„ ë¶„ì„ ê²°ê³¼")
                        
                        for analysis in agent_analyses:
                            if analysis['success']:
                                with st.expander(f"{analysis['agent_emoji']} {analysis['agent_name']} ë¶„ì„", expanded=False):
                                    # Plotly ì°¨íŠ¸ì™€ í•¨ê»˜ ë¶„ì„ í‘œì‹œ
                                    if analysis['analysis']:
                                        display_analysis_with_plotly_charts(
                                            analysis['analysis'],
                                            chart_id=f"agent_{analysis['agent_key']}"
                                        )
                                    
                                    # Reasoning ê³¼ì • í‘œì‹œ (ì—ì´ì „íŠ¸ë³„) - expander ì¤‘ì²© ë°©ì§€
                                    if analysis.get('has_thinking', False) and analysis.get('thinking', '').strip():
                                        st.markdown("---")
                                        st.markdown("### ğŸ§  AI ì‚¬ê³  ê³¼ì •")
                                        st.text_area(
                                            "Reasoning ê³¼ì •",
                                            value=analysis['thinking'],
                                            height=150,
                                            disabled=True,
                                            key=f"thinking_{analysis['agent_key']}",
                                            help="ì´ ì—ì´ì „íŠ¸ì˜ ì‚¬ê³  ê³¼ì •ì…ë‹ˆë‹¤."
                                        )
                            else:
                                with st.expander(f"âŒ {analysis['agent_emoji']} {analysis['agent_name']} - ë¶„ì„ ì‹¤íŒ¨", expanded=False):
                                    st.error(f"ì˜¤ë¥˜: {analysis['error']}")
                        
                        # CFO ì¢…í•© ë¶„ì„ í‘œì‹œ
                        st.markdown("## ğŸ‘” CFO ì¢…í•© ë¶„ì„ (Executive Summary)")
                        
                        if cfo_analysis['success']:
                            # CFO ë¶„ì„ ê²°ê³¼ì™€ Plotly ì°¨íŠ¸ í‘œì‹œ
                            if cfo_analysis['content']:
                                display_analysis_with_plotly_charts(
                                    cfo_analysis['content'],
                                    chart_id="cfo_analysis"
                                )
                        else:
                            st.error(f"CFO ì¢…í•© ë¶„ì„ ì‹¤íŒ¨: {cfo_analysis['error']}")
                        
                        # ë¶„ì„ ê²°ê³¼ ì €ì¥ (ì™„ì „í•œ ì •ë³´)
                        st.session_state.current_analysis = {
                            'company': company_display_name,
                            'symbol': symbol,
                            'analysis_mode': 'multi_agent',
                            'agents': selected_agents,
                            'model': selected_ai_model,
                            'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                            'agent_analyses': agent_analyses,
                            'cfo_analysis': cfo_analysis,
                            'has_financial_data': has_financial_data,
                            'execution_time': execution_time,
                            'agent_analyses': agent_analyses,
                            'cfo_analysis': cfo_analysis,
                            'execution_time': execution_time,
                            'timestamp': datetime.now()
                        }
                        
                    else:
                        # ë‹¨ì¼ AI ë¶„ì„ (ê¸°ì¡´ ë¡œì§)
                        system_prompt = """ë‹¹ì‹ ì€ ì „ë¬¸ ì¬ë¬´ ë¶„ì„ê°€ì…ë‹ˆë‹¤. ì œê³µëœ ì‹¤ì œ ì¬ë¬´ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì •í™•í•˜ê³  í†µì°°ë ¥ ìˆëŠ” ë¶„ì„ì„ ì œê³µí•´ì£¼ì„¸ìš”.

**ì¤‘ìš”: ì‹¤ì œ ë°ì´í„°ë§Œ ì‚¬ìš©**
- ëª¨ë“  ë°ì´í„°ëŠ” ì‹¤ì œ ì‹œì¥/ì¬ë¬´ ë°ì´í„°ì…ë‹ˆë‹¤
- ìƒ˜í”Œì´ë‚˜ ê°€ìƒ ë°ì´í„°ëŠ” ì¼ì ˆ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤
- ë°ì´í„°ê°€ ì—†ëŠ” ë¶€ë¶„ì€ 'ë°ì´í„° ì—†ìŒ'ìœ¼ë¡œ ëª…ì‹œí•©ë‹ˆë‹¤

ë¶„ì„ ì‹œ ë‹¤ìŒ ì‚¬í•­ì„ í¬í•¨í•´ì£¼ì„¸ìš”:
1. **ì¬ë¬´ ê±´ì „ì„± í‰ê°€** (ìˆ˜ìµì„±, ì•ˆì •ì„±, ì„±ì¥ì„±, í™œë™ì„±, ê°€ì¹˜í‰ê°€)
2. **SWOT ë¶„ì„** (ê°•ì , ì•½ì , ê¸°íšŒ, ìœ„í˜‘ ìš”ì†Œ)
3. **ë¦¬ìŠ¤í¬ ë¶„ì„** (ì‹œì¥, ì‹ ìš©, ìœ ë™ì„±, ìš´ì˜, ì •ì¹˜ì  ë¦¬ìŠ¤í¬)
4. **íˆ¬ì ì˜ê²¬** (ë§¤ìˆ˜/ë³´ìœ /ë§¤ë„ ê·¼ê±°ì™€ íˆ¬ì ì§€í‘œ)
5. **ì„±ì¥ì„± ì „ë§** (ë‹¨ê¸°/ì¤‘ê¸°/ì¥ê¸° ì„±ì¥ ê°€ëŠ¥ì„±)

**ì‹œê°í™” ì§€ì›:**
ë¶„ì„ ë‚´ìš©ì— ìœ„ì˜ í‚¤ì›Œë“¤(SWOT, ë¦¬ìŠ¤í¬, íˆ¬ì, ì„±ì¥ì„±, ì¬ë¬´ë¹„ìœ¨ ë“±)ì„ í¬í•¨í•˜ë©´ 
ìë™ìœ¼ë¡œ ê´€ë ¨ ì°¨íŠ¸ê°€ ìƒì„±ë˜ì–´ ë¶„ì„ì„ ì‹œê°ì ìœ¼ë¡œ ë³´ì™„í•©ë‹ˆë‹¤.

**ë¶„ì„ ìŠ¤íƒ€ì¼:**
- ëª…í™•í•˜ê³  êµ¬ì²´ì ì¸ ìˆ˜ì¹˜ ì œì‹œ
- íˆ¬ìì ê´€ì ì˜ ì‹¤ìš©ì  ì¡°ì–¸
- ë¦¬ìŠ¤í¬ì™€ ê¸°íšŒ ìš”ì¸ì„ ê· í˜•ìˆê²Œ í‰ê°€
- í•œêµ­ ì‹œì¥ íŠ¹ì„±ì„ ê³ ë ¤í•œ ë¶„ì„

í•œêµ­ ê¸°ì—…ì˜ íŠ¹ì„±ê³¼ í•œêµ­ ê²½ì œ ìƒí™©ì„ ê³ ë ¤í•˜ì—¬ ë¶„ì„í•´ì£¼ì„¸ìš”.
ì¬ë¬´ì œí‘œ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ì£¼ê°€ ë°ì´í„°ë§Œìœ¼ë¡œ ê°€ëŠ¥í•œ ë¶„ì„ì„ ìˆ˜í–‰í•˜ê³ , í•œê³„ì ì„ ëª…ì‹œí•´ì£¼ì„¸ìš”."""
                        
                        if analysis_type == "ì¢…í•© ì¬ë¬´ ë¶„ì„":
                            prompt = f"{analysis_data}\n\nìœ„ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ {company_display_name}ì— ëŒ€í•œ ì¢…í•©ì ì¸ ì¬ë¬´ ë¶„ì„ì„ í•´ì£¼ì„¸ìš”."
                        elif analysis_type == "íˆ¬ì ì¶”ì²œ ë¶„ì„":
                            prompt = f"{analysis_data}\n\níˆ¬ìì ê´€ì ì—ì„œ {company_display_name}ì˜ íˆ¬ì ë§¤ë ¥ë„ë¥¼ ë¶„ì„í•˜ê³  íˆ¬ì ì¶”ì²œ ì˜ê²¬ì„ ì œì‹œí•´ì£¼ì„¸ìš”."
                        elif analysis_type == "ë¦¬ìŠ¤í¬ ë¶„ì„":
                            prompt = f"{analysis_data}\n\n{company_display_name}ì˜ ì£¼ìš” ë¦¬ìŠ¤í¬ ìš”ì¸ë“¤ì„ ë¶„ì„í•˜ê³  ë¦¬ìŠ¤í¬ ê´€ë¦¬ ë°©ì•ˆì„ ì œì‹œí•´ì£¼ì„¸ìš”."
                        elif analysis_type == "ê²½ìŸì‚¬ ë¹„êµ ë¶„ì„":
                            prompt = f"{analysis_data}\n\n{company_display_name}ì˜ ì—…ê³„ ë‚´ ê²½ìŸë ¥ì„ ë¶„ì„í•˜ê³  ì£¼ìš” ê²½ìŸì‚¬ë“¤ê³¼ì˜ ë¹„êµ ë¶„ì„ì„ í•´ì£¼ì„¸ìš”."
                        else:  # ê¸°ìˆ ì  ë¶„ì„
                            prompt = f"{analysis_data}\n\n{company_display_name}ì˜ ì£¼ê°€ ì°¨íŠ¸ì™€ ê¸°ìˆ ì  ì§€í‘œë¥¼ ë°”íƒ•ìœ¼ë¡œ ê¸°ìˆ ì  ë¶„ì„ì„ í•´ì£¼ì„¸ìš”."
                        
                        # AI ì‘ë‹µ ìƒì„±
                        response = get_ai_response(
                            prompt=prompt,
                            model_name=selected_ai_model,
                            system_prompt=system_prompt,
                            enable_thinking=enable_reasoning
                        )
                        
                        end_time = time.time()
                        execution_time = int(end_time - start_time)
                        
                        # ë¶„ì„ ê²°ê³¼ í‘œì‹œ
                        st.success(f"âœ… **AI ë¶„ì„ ì™„ë£Œ** (ì†Œìš”ì‹œê°„: {execution_time}ì´ˆ)")
                        
                        # ì‹¤ì œ ë°ì´í„° í’ˆì§ˆ ìš”ì•½ í‘œì‹œ
                        col1, col2, col3 = st.columns(3)
                        with col1:
                            st.success("ğŸ“Š ì‹¤ì œ ì£¼ê°€ ë°ì´í„°")
                        
                        with col2:
                            if has_financial_data:
                                st.success("ğŸ“‹ ì‹¤ì œ ì¬ë¬´ì œí‘œ")
                            else:
                                st.warning("ğŸ“‹ ì¬ë¬´ì œí‘œ ì—†ìŒ")
                        
                        with col3:
                            overall_quality = "ğŸŸ¢ ì™„ì „í•œ ë°ì´í„°" if has_financial_data else "ğŸŸ¡ ì£¼ê°€ë§Œ ê°€ëŠ¥"
                            st.info(f"ğŸ¯ {overall_quality}")
                        
                        st.markdown("### ğŸ¤– AI ì¬ë¬´ ë¶„ì„ ê²°ê³¼")
                        
                        # AI ë¶„ì„ ê²°ê³¼ì™€ Plotly ì°¨íŠ¸ í‘œì‹œ
                        if response['content']:
                            display_analysis_with_plotly_charts(
                                response['content'],
                                chart_id="single_ai"
                            )
                        
                        # Reasoning ê³¼ì • í‘œì‹œ
                        if response.get('has_thinking', False) and response.get('thinking', '').strip():
                            st.markdown("### ğŸ§  AI ì‚¬ê³  ê³¼ì • (Reasoning)")
                            reasoning_content = response['thinking']
                            reasoning_html = f"""
                            <details open>
                                <summary style="cursor: pointer; font-weight: bold; color: #1f77b4; font-size: 16px;">
                                    ğŸ§  Reasoning ê³¼ì • ë³´ê¸°/ìˆ¨ê¸°ê¸°
                                </summary>
                                <div style="margin-top: 15px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border-left: 4px solid #1f77b4; color: #000000; font-family: 'Courier New', monospace; white-space: pre-wrap; max-height: 500px; overflow-y: auto;">
{reasoning_content}
                                </div>
                            </details>
                            """
                            st.markdown(reasoning_html, unsafe_allow_html=True)
                        
                        # ë¶„ì„ ê²°ê³¼ ì €ì¥
                        st.session_state.current_analysis = {
                            'company': company_display_name,
                            'symbol': symbol,
                            'analysis_mode': 'single_ai',
                            'analysis_type': analysis_type,
                            'model': selected_ai_model,
                            'single_analysis': response['content'],
                            'thinking': response.get('thinking', ''),
                            'has_thinking': response.get('has_thinking', False),
                            'execution_time': execution_time,
                            'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                            'has_financial_data': has_financial_data
                        }
                        
                else:
                    # ì‹¤ì œ ì£¼ê°€ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°
                    st.error(f"âŒ **ë¶„ì„ ë¶ˆê°€**: {company_display_name}ì˜ ì‹¤ì œ ì‹œì¥ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                    st.warning("âš ï¸ **ìƒ˜í”Œ ë°ì´í„°ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.** ì‹¤ì œ ë°ì´í„°ë§Œìœ¼ë¡œ ë¶„ì„ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.")
                    
                    # ê°€ëŠ¥í•œ í•´ê²° ë°©ë²• ì œì‹œ
                    st.info("""
                    **í•´ê²° ë°©ë²•:**
                    - ì¢…ëª©ì½”ë“œê°€ ì •í™•í•œì§€ í™•ì¸í•´ì£¼ì„¸ìš” (6ìë¦¬ ìˆ«ì)
                    - ì‹œì¥ êµ¬ë¶„(ì½”ìŠ¤í”¼/ì½”ìŠ¤ë‹¥)ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”
                    - ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš” (API ì¼ì‹œì  ì˜¤ë¥˜ ê°€ëŠ¥)
                    - ìºì‹œ ì´ˆê¸°í™” ë²„íŠ¼ì„ í´ë¦­í•´ë³´ì„¸ìš”
                    """)
        else:
            st.warning("ë¶„ì„í•  ê¸°ì—…ì„ ì„ íƒí•˜ê±°ë‚˜ ì¢…ëª©ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")

# Tab 5: ê¸°ì—…ê°€ì¹˜í‰ê°€
with tab5:
    st.header("ğŸ’° ê¸°ì—…ê°€ì¹˜í‰ê°€ ì‹œìŠ¤í…œ")
    
    # ê¸°ì—… ì„ íƒ
    st.subheader("ğŸ“Š ê¸°ì—… ì„ íƒ")
    
    # ê¸°ì—… ì„ íƒ ë°©ì‹
    valuation_selection_method = st.radio(
        "ğŸ¢ ê¸°ì—… ì„ íƒ ë°©ì‹",
        ["ğŸ“‹ ëª©ë¡ì—ì„œ ì„ íƒ", "âœï¸ ì§ì ‘ ì…ë ¥"],
        horizontal=True,
        key="valuation_selection_method"
    )
    
    if valuation_selection_method == "ğŸ“‹ ëª©ë¡ì—ì„œ ì„ íƒ":
        valuation_market_type = st.selectbox(
            "ğŸ“Š ì‹œì¥ êµ¬ë¶„",
            ["ğŸ”µ ì½”ìŠ¤í”¼ (KOSPI)", "ğŸŸ¡ ì½”ìŠ¤ë‹¥ (KOSDAQ)", "ğŸŒ ì „ì²´"],
            key="valuation_market_type"
        )
        
        if valuation_market_type == "ğŸ”µ ì½”ìŠ¤í”¼ (KOSPI)":
            valuation_stocks = KOSPI_STOCKS
        elif valuation_market_type == "ğŸŸ¡ ì½”ìŠ¤ë‹¥ (KOSDAQ)":
            valuation_stocks = KOSDAQ_STOCKS
        else:
            valuation_stocks = KOREAN_STOCKS
        
        valuation_company = st.selectbox(
            f"ê¸°ì—… ì„ íƒ ({len(valuation_stocks)}ê°œ)",
            list(valuation_stocks.keys()),
            key="valuation_company"
        )
        
        valuation_symbol = valuation_stocks[valuation_company]
        
    else:  # ì§ì ‘ ì…ë ¥
        col1, col2 = st.columns([2, 1])
        
        with col1:
            valuation_code = st.text_input(
                "ğŸ“ ì¢…ëª©ì½”ë“œ ì…ë ¥",
                placeholder="ì˜ˆ: 005930, 035720",
                key="valuation_code"
            )
        
        with col2:
            valuation_suffix = st.selectbox(
                "ğŸ›ï¸ ì‹œì¥",
                ["KS (ì½”ìŠ¤í”¼)", "KQ (ì½”ìŠ¤ë‹¥)"],
                key="valuation_suffix"
            )
        
        if valuation_code and len(valuation_code) == 6 and valuation_code.isdigit():
            suffix = ".KS" if valuation_suffix.startswith("KS") else ".KQ"
            valuation_symbol = valuation_code + suffix
            valuation_company = f"ì¢…ëª©ì½”ë“œ {valuation_code}"
            st.success(f"âœ… ì…ë ¥: **{valuation_code}** - {valuation_suffix.split(' ')[0]}")
        elif valuation_code:
            st.error("âš ï¸ ì¢…ëª©ì½”ë“œëŠ” 6ìë¦¬ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤")
            valuation_company = None
            valuation_symbol = None
        else:
            valuation_company = None
            valuation_symbol = None
    
    if valuation_company and valuation_symbol:
        # ë°ì´í„° ìˆ˜ì§‘
        with st.spinner("ğŸ“Š ì¬ë¬´ ë°ì´í„° ìˆ˜ì§‘ ì¤‘..."):
            hist_data, stock_info = get_stock_data(valuation_symbol, "1y")
            income_stmt, balance_sheet, cash_flow = get_financial_statements(valuation_symbol)
        
        if hist_data is not None and not hist_data.empty:
            # ê¸°ë³¸ ì •ë³´ í‘œì‹œ
            current_price = hist_data['Close'][-1]
            market_cap = current_price * 1000000  # ì„ì‹œ ê³„ì‚°
            
            st.subheader(f"ğŸ“ˆ {valuation_company} ê¸°ë³¸ ì •ë³´")
            col1, col2, col3 = st.columns(3)
            
            with col1:
                st.metric("í˜„ì¬ ì£¼ê°€", f"{current_price:,.0f}ì›")
            with col2:
                if stock_info and 'marketCap' in stock_info:
                    market_cap = stock_info['marketCap']
                    st.metric("ì‹œê°€ì´ì•¡", format_currency_krw(market_cap))
                else:
                    st.metric("ì‹œê°€ì´ì•¡", "N/A")
            with col3:
                avg_volume = hist_data['Volume'][-30:].mean() if len(hist_data) >= 30 else hist_data['Volume'].mean()
                st.metric("í‰ê· ê±°ë˜ëŸ‰", f"{avg_volume:,.0f}")
            
            # ê°€ì¹˜í‰ê°€ ë°©ë²• ì„ íƒ
            st.subheader("ğŸ’° ê°€ì¹˜í‰ê°€ ë°©ë²•")
            
            valuation_methods = st.multiselect(
                "ì‚¬ìš©í•  ê°€ì¹˜í‰ê°€ ë°©ë²•",
                ["DCF (í˜„ê¸ˆíë¦„í• ì¸ë²•)", "PER ë©€í‹°í”Œ", "EV/EBITDA ë©€í‹°í”Œ"],
                default=["DCF (í˜„ê¸ˆíë¦„í• ì¸ë²•)", "PER ë©€í‹°í”Œ"],
                help="í•˜ë‚˜ ì´ìƒì˜ ë°©ë²•ì„ ì„ íƒí•˜ì„¸ìš”"
            )
            
            # ì¬ë¬´ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ë§Œ ì§„í–‰
            if income_stmt is not None and balance_sheet is not None:
                # ì¬ë¬´ ë¹„ìœ¨ ê³„ì‚°
                ratios = calculate_financial_ratios(income_stmt, balance_sheet)
                
                # ê¸°ë³¸ ì¬ë¬´ ì§€í‘œ í‘œì‹œ
                st.subheader("ğŸ“Š ì£¼ìš” ì¬ë¬´ ì§€í‘œ")
                col1, col2, col3, col4 = st.columns(4)
                
                with col1:
                    revenue = safe_value_access(income_stmt, 'Total Revenue')
                    if revenue:
                        st.metric("ë§¤ì¶œì•¡", format_currency_krw(revenue))
                    else:
                        st.metric("ë§¤ì¶œì•¡", "N/A")
                
                with col2:
                    operating_income = safe_value_access(income_stmt, 'Operating Income')
                    if operating_income:
                        st.metric("ì˜ì—…ì´ìµ", format_currency_krw(operating_income))
                    else:
                        st.metric("ì˜ì—…ì´ìµ", "N/A")
                
                with col3:
                    net_income = safe_value_access(income_stmt, 'Net Income')
                    if net_income:
                        st.metric("ë‹¹ê¸°ìˆœì´ìµ", format_currency_krw(net_income))
                    else:
                        st.metric("ë‹¹ê¸°ìˆœì´ìµ", "N/A")
                
                with col4:
                    if ratios and 'ROE' in ratios:
                        st.metric("ROE", f"{ratios['ROE']:.2f}%")
                    else:
                        st.metric("ROE", "N/A")
                
                # ê°€ì¹˜í‰ê°€ ì…ë ¥ ë§¤ê°œë³€ìˆ˜
                if valuation_methods:
                    st.subheader("âš™ï¸ ê°€ì¹˜í‰ê°€ ë§¤ê°œë³€ìˆ˜")
                    
                    col1, col2 = st.columns(2)
                    
                    if "DCF (í˜„ê¸ˆíë¦„í• ì¸ë²•)" in valuation_methods:
                        with col1:
                            st.markdown("**DCF ë§¤ê°œë³€ìˆ˜**")
                            
                            # í˜„ì¬ FCF ì¶”ì • (ì˜ì—…í˜„ê¸ˆíë¦„ ê¸°ë°˜)
                            operating_cash_flow = safe_value_access(cash_flow, 'Operating Cash Flow') if cash_flow is not None else None
                            if operating_cash_flow:
                                current_fcf = st.number_input(
                                    "í˜„ì¬ FCF (Free Cash Flow)",
                                    value=float(operating_cash_flow),
                                    step=1000000.0,
                                    format="%.0f",
                                    help="ì˜ì—…í˜„ê¸ˆíë¦„ì—ì„œ ìë³¸ì§€ì¶œì„ ì°¨ê°í•œ ì‰ì—¬í˜„ê¸ˆíë¦„"
                                )
                            else:
                                current_fcf = st.number_input(
                                    "í˜„ì¬ FCF (Free Cash Flow)",
                                    value=1000000000.0,
                                    step=1000000.0,
                                    format="%.0f",
                                    help="ì˜ì—…í˜„ê¸ˆíë¦„ì—ì„œ ìë³¸ì§€ì¶œì„ ì°¨ê°í•œ ì‰ì—¬í˜„ê¸ˆíë¦„"
                                )
                            
                            growth_rate = st.slider(
                                "ì˜ˆìƒ ì—°ê°„ ì„±ì¥ë¥  (%)",
                                min_value=0.0,
                                max_value=30.0,
                                value=10.0,
                                step=0.5
                            ) / 100
                            
                            discount_rate = st.slider(
                                "í• ì¸ìœ¨ (WACC) (%)",
                                min_value=5.0,
                                max_value=25.0,
                                value=12.0,
                                step=0.5
                            ) / 100
                            
                            terminal_growth_rate = st.slider(
                                "ì˜êµ¬ ì„±ì¥ë¥  (%)",
                                min_value=1.0,
                                max_value=5.0,
                                value=3.0,
                                step=0.1
                            ) / 100
                    
                    if "PER ë©€í‹°í”Œ" in valuation_methods or "EV/EBITDA ë©€í‹°í”Œ" in valuation_methods:
                        with col2:
                            if "PER ë©€í‹°í”Œ" in valuation_methods:
                                st.markdown("**PER ë©€í‹°í”Œ**")
                                per_multiples = st.multiselect(
                                    "ì‚¬ìš©í•  PER ë°°ìˆ˜",
                                    [8, 10, 12, 15, 18, 20, 25, 30],
                                    default=[12, 18, 25],
                                    help="ì‚°ì—… í‰ê·  PERì„ ì°¸ê³ í•˜ì—¬ ì„ íƒ"
                                )
                            
                            if "EV/EBITDA ë©€í‹°í”Œ" in valuation_methods:
                                st.markdown("**EV/EBITDA ë©€í‹°í”Œ**")
                                evebitda_multiples = st.multiselect(
                                    "ì‚¬ìš©í•  EV/EBITDA ë°°ìˆ˜",
                                    [6, 8, 10, 12, 15, 18, 20],
                                    default=[8, 12, 16],
                                    help="ì‚°ì—… í‰ê·  EV/EBITDAë¥¼ ì°¸ê³ í•˜ì—¬ ì„ íƒ"
                                )
                                
                                net_debt = st.number_input(
                                    "ìˆœì°¨ì…ê¸ˆ (ì´ì°¨ì…ê¸ˆ - í˜„ê¸ˆ)",
                                    value=0.0,
                                    step=1000000.0,
                                    format="%.0f",
                                    help="ê¸°ì—…ê°€ì¹˜ì—ì„œ ì°¨ê°í•  ìˆœì°¨ì…ê¸ˆ"
                                )
                    
                    # ê°€ì¹˜í‰ê°€ ì‹¤í–‰
                    if st.button("ğŸ’° ê°€ì¹˜í‰ê°€ ì‹¤í–‰", type="primary"):
                        st.subheader("ğŸ“Š ê°€ì¹˜í‰ê°€ ê²°ê³¼")
                        
                        # DCF ë¶„ì„
                        if "DCF (í˜„ê¸ˆíë¦„í• ì¸ë²•)" in valuation_methods:
                            st.markdown("### 1. DCF ê°€ì¹˜í‰ê°€")
                            
                            dcf_result = calculate_dcf(
                                current_fcf,
                                growth_rate,
                                discount_rate,
                                terminal_growth_rate
                            )
                            
                            col1, col2, col3 = st.columns(3)
                            with col1:
                                st.metric("ê¸°ì—…ê°€ì¹˜ (DCF)", format_currency_krw(dcf_result['company_value']))
                            with col2:
                                st.metric("í˜„ì¬ê°€ ëŒ€ë¹„", f"{(dcf_result['company_value'] / market_cap - 1) * 100:+.1f}%" if market_cap else "N/A")
                            with col3:
                                st.metric("ì”ì—¬ê°€ì¹˜ ë¹„ì¤‘", f"{(dcf_result['terminal_value_pv'] / dcf_result['company_value']) * 100:.1f}%")
                            
                            # DCF ìƒì„¸ ì •ë³´
                            with st.expander("DCF ìƒì„¸ ë¶„ì„"):
                                fcf_data = []
                                for i, (fcf, pv) in enumerate(zip(dcf_result['future_fcfs'], dcf_result['present_values'])):
                                    fcf_data.append({
                                        'ì—°ë„': f'Year {i+1}',
                                        'FCF': format_currency_krw(fcf),
                                        'í˜„ì¬ê°€ì¹˜': format_currency_krw(pv)
                                    })
                                st.table(pd.DataFrame(fcf_data))
                        
                        # PER ë¶„ì„
                        if "PER ë©€í‹°í”Œ" in valuation_methods and net_income and per_multiples:
                            st.markdown("### 2. PER ê°€ì¹˜í‰ê°€")
                            
                            per_result = calculate_per_valuation(net_income, per_multiples)
                            
                            per_data = []
                            for per, value in per_result.items():
                                per_data.append({
                                    'PER': f'{per}ë°°',
                                    'ê¸°ì—…ê°€ì¹˜': format_currency_krw(value),
                                    'í˜„ì¬ê°€ ëŒ€ë¹„': f"{(value / market_cap - 1) * 100:+.1f}%" if market_cap else "N/A"
                                })
                            st.table(pd.DataFrame(per_data))
                        
                        # EV/EBITDA ë¶„ì„
                        if "EV/EBITDA ë©€í‹°í”Œ" in valuation_methods and operating_income and evebitda_multiples:
                            st.markdown("### 3. EV/EBITDA ê°€ì¹˜í‰ê°€")
                            
                            # EBITDA ê³„ì‚° (ê°„ë‹¨í•œ ì¶”ì •)
                            ebitda = operating_income * 1.2  # ê°ê°€ìƒê°ë¹„ ì¶”ì •
                            
                            evebitda_result = calculate_ev_ebitda_valuation(ebitda, evebitda_multiples, net_debt)
                            
                            evebitda_data = []
                            for multiple, values in evebitda_result.items():
                                ev = values['enterprise_value']
                                eq = values['equity_value']
                                evebitda_data.append({
                                    'EV/EBITDA': f'{multiple}ë°°',
                                    'ê¸°ì—…ê°€ì¹˜ (EV)': format_currency_krw(ev),
                                    'ì£¼ì£¼ê°€ì¹˜ (Equity)': format_currency_krw(eq),
                                    'í˜„ì¬ê°€ ëŒ€ë¹„': f"{(eq / market_cap - 1) * 100:+.1f}%" if market_cap else "N/A"
                                })
                            st.table(pd.DataFrame(evebitda_data))
                        
                        # ì¢…í•© ì˜ê²¬
                        st.markdown("### ğŸ’¡ ì¢…í•© í‰ê°€")
                        if len(valuation_methods) > 1:
                            st.info("ì—¬ëŸ¬ ë°©ë²•ë¡ ì„ í™œìš©í•œ ê°€ì¹˜í‰ê°€ë¥¼ í†µí•´ ë” ì‹ ë¢°ì„± ìˆëŠ” ê¸°ì—…ê°€ì¹˜ë¥¼ ì‚°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
                        
                        st.warning("""
                        **ì£¼ì˜ì‚¬í•­:**
                        - ì´ ê°€ì¹˜í‰ê°€ëŠ” ì…ë ¥ëœ ê°€ì •ì— ê¸°ë°˜í•œ ì¶”ì •ì¹˜ì…ë‹ˆë‹¤
                        - ì‹¤ì œ íˆ¬ì ê²°ì • ì‹œì—ëŠ” ì¶”ê°€ì ì¸ ë¶„ì„ì´ í•„ìš”í•©ë‹ˆë‹¤
                        - ì‹œì¥ ìƒí™©, ì‚°ì—… ì „ë§ ë“±ì„ ì¢…í•©ì ìœ¼ë¡œ ê³ ë ¤í•˜ì„¸ìš”
                        """)
            
            else:
                st.warning("ì¬ë¬´ì œí‘œ ë°ì´í„°ê°€ ì—†ì–´ ê°€ì¹˜í‰ê°€ë¥¼ ìˆ˜í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                st.info("ì£¼ê°€ ë°ì´í„°ë§Œìœ¼ë¡œëŠ” ì •í™•í•œ ê¸°ì—…ê°€ì¹˜ í‰ê°€ê°€ ì–´ë µìŠµë‹ˆë‹¤.")
        
        else:
            st.error("ì£¼ê°€ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    
    else:
        st.info("ê°€ì¹˜í‰ê°€ë¥¼ ìœ„í•´ ê¸°ì—…ì„ ì„ íƒí•˜ê±°ë‚˜ ì¢…ëª©ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")

# Tab 6: ì£¼ê°€ ì˜ˆì¸¡
with tab6:
    st.header("ğŸ”® ì£¼ê°€ ì˜ˆì¸¡ ì‹œìŠ¤í…œ")
    st.markdown("ë‹¤ì–‘í•œ í†µê³„ ê¸°ë²•ì„ í™œìš©í•˜ì—¬ í–¥í›„ 1ë…„ê°„ ì£¼ê°€ë¥¼ ì˜ˆì¸¡í•©ë‹ˆë‹¤.")
    
    # ê¸°ì—… ì„ íƒ
    st.subheader("ğŸ“Š ê¸°ì—… ì„ íƒ")
    
    # ê¸°ì—… ì„ íƒ ë°©ì‹
    prediction_selection_method = st.radio(
        "ğŸ¢ ê¸°ì—… ì„ íƒ ë°©ì‹",
        ["ğŸ“‹ ëª©ë¡ì—ì„œ ì„ íƒ", "âœï¸ ì§ì ‘ ì…ë ¥"],
        horizontal=True,
        key="prediction_selection_method"
    )
    
    if prediction_selection_method == "ğŸ“‹ ëª©ë¡ì—ì„œ ì„ íƒ":
        prediction_market_type = st.selectbox(
            "ğŸ“Š ì‹œì¥ êµ¬ë¶„",
            ["ğŸ”µ ì½”ìŠ¤í”¼ (KOSPI)", "ğŸŸ¡ ì½”ìŠ¤ë‹¥ (KOSDAQ)", "ğŸŒ ì „ì²´"],
            key="prediction_market_type"
        )
        
        if prediction_market_type == "ğŸ”µ ì½”ìŠ¤í”¼ (KOSPI)":
            prediction_stocks = KOSPI_STOCKS
        elif prediction_market_type == "ğŸŸ¡ ì½”ìŠ¤ë‹¥ (KOSDAQ)":
            prediction_stocks = KOSDAQ_STOCKS
        else:
            prediction_stocks = KOREAN_STOCKS
        
        prediction_company = st.selectbox(
            f"ê¸°ì—… ì„ íƒ ({len(prediction_stocks)}ê°œ)",
            list(prediction_stocks.keys()),
            key="prediction_company"
        )
        
        prediction_symbol = prediction_stocks[prediction_company]
        
    else:  # ì§ì ‘ ì…ë ¥
        col1, col2 = st.columns([2, 1])
        
        with col1:
            prediction_code = st.text_input(
                "ğŸ“ ì¢…ëª©ì½”ë“œ ì…ë ¥",
                placeholder="ì˜ˆ: 005930, 035720",
                key="prediction_code"
            )
        
        with col2:
            prediction_suffix = st.selectbox(
                "ğŸ›ï¸ ì‹œì¥",
                ["KS (ì½”ìŠ¤í”¼)", "KQ (ì½”ìŠ¤ë‹¥)"],
                key="prediction_suffix"
            )
        
        if prediction_code and len(prediction_code) == 6 and prediction_code.isdigit():
            suffix = ".KS" if prediction_suffix.startswith("KS") else ".KQ"
            prediction_symbol = prediction_code + suffix
            prediction_company = f"ì¢…ëª©ì½”ë“œ {prediction_code}"
            st.success(f"âœ… ì…ë ¥: **{prediction_code}** - {prediction_suffix.split(' ')[0]}")
        elif prediction_code:
            st.error("âš ï¸ ì¢…ëª©ì½”ë“œëŠ” 6ìë¦¬ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤")
            prediction_company = None
            prediction_symbol = None
        else:
            prediction_company = None
            prediction_symbol = None
    
    if prediction_company and prediction_symbol:
        # ì˜ˆì¸¡ ëª¨ë¸ ì„¤ì •
        st.subheader("ğŸ”§ ì˜ˆì¸¡ ëª¨ë¸ ì„¤ì •")
        
        col1, col2 = st.columns([2, 1])
        
        with col1:
            selected_models = st.multiselect(
                "ì‚¬ìš©í•  ì˜ˆì¸¡ ëª¨ë¸",
                [
                    "Random Walk (ëœë¤ ì›Œí¬)",
                    "Linear Regression (ì„ í˜• íšŒê·€)",
                    "Moving Average (ì´ë™í‰ê· )",
                    "Exponential Smoothing (ì§€ìˆ˜í‰í™œ)",
                    "ARIMA Style (ì‹œê³„ì—´ ëª¨ë¸)"
                ],
                default=["Random Walk (ëœë¤ ì›Œí¬)", "Linear Regression (ì„ í˜• íšŒê·€)", "Moving Average (ì´ë™í‰ê· )"],
                help="ì—¬ëŸ¬ ëª¨ë¸ì„ ì„ íƒí•˜ì—¬ ì¢…í•©ì ì¸ ì˜ˆì¸¡ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤"
            )
        
        with col2:
            # ë°ì´í„° ê¸°ê°„ ì„ íƒ
            data_period = st.selectbox(
                "í•™ìŠµ ë°ì´í„° ê¸°ê°„",
                ["1y", "2y", "3y", "5y"],
                index=1,
                help="ì˜ˆì¸¡ ëª¨ë¸ í•™ìŠµì— ì‚¬ìš©í•  ê³¼ê±° ë°ì´í„° ê¸°ê°„"
            )
            
            # ì˜ˆì¸¡ ê¸°ê°„
            prediction_days = st.slider(
                "ì˜ˆì¸¡ ê¸°ê°„ (ê±°ë˜ì¼)",
                min_value=30,
                max_value=365,
                value=252,  # ì•½ 1ë…„
                step=30,
                help="252 ê±°ë˜ì¼ â‰ˆ 1ë…„"
            )
        
        # ê³ ê¸‰ ì„¤ì •
        with st.expander("âš™ï¸ ê³ ê¸‰ ì„¤ì •"):
            col1, col2, col3 = st.columns(3)
            
            with col1:
                ma_window = st.slider("ì´ë™í‰ê·  ìœˆë„ìš°", 5, 50, 20, help="ì´ë™í‰ê·  ê³„ì‚° ê¸°ê°„")
                
            with col2:
                alpha = st.slider("ì§€ìˆ˜í‰í™œ Î±", 0.1, 0.9, 0.3, 0.1, help="ì§€ìˆ˜í‰í™œë²•ì˜ í‰í™œ ê³„ìˆ˜")
                
            with col3:
                confidence_level = st.slider("ì‹ ë¢°êµ¬ê°„ (%)", 80, 99, 95, 1, help="ì˜ˆì¸¡ ì‹ ë¢°êµ¬ê°„")
        
        # ì˜ˆì¸¡ ì‹¤í–‰
        if st.button("ğŸš€ ì£¼ê°€ ì˜ˆì¸¡ ì‹¤í–‰", type="primary"):
            if selected_models:
                with st.spinner("ğŸ“Š ë°ì´í„° ìˆ˜ì§‘ ë° ì˜ˆì¸¡ ëª¨ë¸ ì‹¤í–‰ ì¤‘..."):
                    # ì£¼ê°€ ë°ì´í„° ìˆ˜ì§‘
                    hist_data, _ = get_stock_data(prediction_symbol, data_period)
                    
                    if hist_data is not None and not hist_data.empty:
                        prices = hist_data['Close'].values
                        
                        # ê¸°ë³¸ ì •ë³´ í‘œì‹œ
                        st.subheader(f"ğŸ“ˆ {prediction_company} ì˜ˆì¸¡ ê²°ê³¼")
                        
                        current_price = prices[-1]
                        col1, col2, col3, col4 = st.columns(4)
                        
                        with col1:
                            st.metric("í˜„ì¬ ì£¼ê°€", f"{current_price:,.0f}ì›")
                        with col2:
                            st.metric("ë°ì´í„° ê¸°ê°„", data_period.upper())
                        with col3:
                            st.metric("ì˜ˆì¸¡ ê¸°ê°„", f"{prediction_days}ì¼")
                        with col4:
                            st.metric("ë°ì´í„° í¬ì¸íŠ¸", f"{len(prices)}ê°œ")
                        
                        # ê° ëª¨ë¸ë³„ ì˜ˆì¸¡ ì‹¤í–‰
                        predictions_dict = {}
                        model_info = {}
                        
                        if "Random Walk (ëœë¤ ì›Œí¬)" in selected_models:
                            pred, mean_ret, vol = random_walk_prediction(prices, prediction_days)
                            if pred is not None:
                                predictions_dict["Random Walk"] = pred
                                model_info["Random Walk"] = {
                                    "í‰ê·  ìˆ˜ìµë¥ ": f"{mean_ret*252:.2%} (ì—°ìœ¨)",
                                    "ë³€ë™ì„±": f"{vol*np.sqrt(252):.2%} (ì—°ìœ¨)"
                                }
                        
                        if "Linear Regression (ì„ í˜• íšŒê·€)" in selected_models:
                            pred, slope, r2 = linear_regression_prediction(prices, prediction_days)
                            if pred is not None:
                                predictions_dict["Linear Regression"] = pred
                                model_info["Linear Regression"] = {
                                    "ê¸°ìš¸ê¸°": f"{slope:.2f}ì›/ì¼",
                                    "RÂ² ìŠ¤ì½”ì–´": f"{r2:.3f}"
                                }
                        
                        if "Moving Average (ì´ë™í‰ê· )" in selected_models:
                            pred, slope, last_ma = moving_average_prediction(prices, ma_window, prediction_days)
                            if pred is not None:
                                predictions_dict["Moving Average"] = pred
                                model_info["Moving Average"] = {
                                    "MA ìœˆë„ìš°": f"{ma_window}ì¼",
                                    "ì¶”ì„¸ ê¸°ìš¸ê¸°": f"{slope:.2f}ì›/ì¼"
                                }
                        
                        if "Exponential Smoothing (ì§€ìˆ˜í‰í™œ)" in selected_models:
                            pred, alpha_used, trend = exponential_smoothing_prediction(prices, alpha, prediction_days)
                            if pred is not None:
                                predictions_dict["Exponential Smoothing"] = pred
                                model_info["Exponential Smoothing"] = {
                                    "Alpha": f"{alpha_used:.1f}",
                                    "ì¶”ì„¸": f"{trend:.2f}ì›/ì¼"
                                }
                        
                        if "ARIMA Style (ì‹œê³„ì—´ ëª¨ë¸)" in selected_models:
                            pred, coef, std = simple_arima_prediction(prices, prediction_days)
                            if pred is not None:
                                predictions_dict["ARIMA Style"] = pred
                                model_info["ARIMA Style"] = {
                                    "AR ê³„ìˆ˜": f"{coef:.3f}",
                                    "í‘œì¤€í¸ì°¨": f"{std:.2f}ì›"
                                }
                        
                        # ê²°ê³¼ í‘œì‹œ
                        if predictions_dict:
                            # ì˜ˆì¸¡ ì°¨íŠ¸
                            fig = create_prediction_chart(hist_data, predictions_dict, prediction_company)
                            if fig:
                                st.plotly_chart(fig, use_container_width=True)
                            
                            # ì˜ˆì¸¡ ìš”ì•½ í…Œì´ë¸”
                            st.subheader("ğŸ“Š ì˜ˆì¸¡ ìš”ì•½")
                            
                            summary_data = []
                            for model_name, predictions in predictions_dict.items():
                                final_price = predictions[-1]
                                price_change = final_price - current_price
                                price_change_pct = (price_change / current_price) * 100
                                
                                summary_data.append({
                                    "ëª¨ë¸": model_name,
                                    "í˜„ì¬ê°€": f"{current_price:,.0f}ì›",
                                    f"{prediction_days}ì¼ í›„ ì˜ˆì¸¡ê°€": f"{final_price:,.0f}ì›",
                                    "ë³€í™”ëŸ‰": f"{price_change:+,.0f}ì›",
                                    "ë³€í™”ìœ¨": f"{price_change_pct:+.1f}%"
                                })
                            
                            summary_df = pd.DataFrame(summary_data)
                            st.dataframe(summary_df, use_container_width=True, hide_index=True)
                            
                            # ëª¨ë¸ë³„ ìƒì„¸ ì •ë³´
                            st.subheader("ğŸ”§ ëª¨ë¸ë³„ ìƒì„¸ ì •ë³´")
                            
                            for model_name, info in model_info.items():
                                with st.expander(f"ğŸ“ˆ {model_name} ìƒì„¸"):
                                    for key, value in info.items():
                                        st.write(f"**{key}**: {value}")
                                    
                                    # ê°„ë‹¨í•œ í†µê³„
                                    if model_name in predictions_dict:
                                        pred_prices = predictions_dict[model_name]
                                        st.write(f"**ìµœê³  ì˜ˆì¸¡ê°€**: {max(pred_prices):,.0f}ì›")
                                        st.write(f"**ìµœì € ì˜ˆì¸¡ê°€**: {min(pred_prices):,.0f}ì›")
                                        st.write(f"**í‰ê·  ì˜ˆì¸¡ê°€**: {np.mean(pred_prices):,.0f}ì›")
                                        st.write(f"**í‘œì¤€í¸ì°¨**: {np.std(pred_prices):,.0f}ì›")
                            
                            # ì¢…í•© ì˜ê²¬
                            st.subheader("ğŸ’¡ ì¢…í•© ë¶„ì„")
                            
                            # ëª¨ë¸ë³„ ì˜ˆì¸¡ ê²°ê³¼ í†µê³„
                            all_final_prices = [predictions[-1] for predictions in predictions_dict.values()]
                            avg_prediction = np.mean(all_final_prices)
                            prediction_std = np.std(all_final_prices)
                            
                            col1, col2, col3 = st.columns(3)
                            
                            with col1:
                                st.metric(
                                    "í‰ê·  ì˜ˆì¸¡ê°€",
                                    f"{avg_prediction:,.0f}ì›",
                                    f"{((avg_prediction/current_price-1)*100):+.1f}%"
                                )
                            
                            with col2:
                                st.metric(
                                    "ì˜ˆì¸¡ ë²”ìœ„",
                                    f"Â±{prediction_std:,.0f}ì›",
                                    f"Â±{(prediction_std/current_price*100):.1f}%"
                                )
                            
                            with col3:
                                confidence_range = prediction_std * (confidence_level/100)
                                st.metric(
                                    f"{confidence_level}% ì‹ ë¢°êµ¬ê°„",
                                    f"{avg_prediction-confidence_range:,.0f}~{avg_prediction+confidence_range:,.0f}ì›"
                                )
                            
                            # ì£¼ì˜ì‚¬í•­
                            st.warning("""
                            **âš ï¸ ì£¼ì˜ì‚¬í•­:**
                            - ì£¼ê°€ ì˜ˆì¸¡ì€ ì°¸ê³ ìš©ì´ë©°, ì‹¤ì œ íˆ¬ì ê²°ì •ì˜ ìœ ì¼í•œ ê·¼ê±°ê°€ ë˜ì–´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤
                            - ê³¼ê±° ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ì˜ˆì¸¡ì´ë¯€ë¡œ ì‹œì¥ í™˜ê²½ ë³€í™”ë¥¼ ì™„ì „íˆ ë°˜ì˜í•˜ì§€ ëª»í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
                            - ì—¬ëŸ¬ ëª¨ë¸ì˜ ê²°ê³¼ë¥¼ ì¢…í•©ì ìœ¼ë¡œ ê²€í† í•˜ê³ , ì¶”ê°€ì ì¸ ë¶„ì„ì„ ë³‘í–‰í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤
                            - íˆ¬ìì—ëŠ” í•­ìƒ ë¦¬ìŠ¤í¬ê°€ ë”°ë¥´ë¯€ë¡œ ì‹ ì¤‘í•œ íŒë‹¨ì´ í•„ìš”í•©ë‹ˆë‹¤
                            """)
                            
                            # ëª¨ë¸ ì„¤ëª…
                            with st.expander("ğŸ“š ì˜ˆì¸¡ ëª¨ë¸ ì„¤ëª…"):
                                st.markdown("""
                                **ğŸ² Random Walk (ëœë¤ ì›Œí¬)**
                                - ì£¼ê°€ê°€ ë¬´ì‘ìœ„ë¡œ ì›€ì§ì¸ë‹¤ëŠ” ê°€ì •
                                - ê³¼ê±° ìˆ˜ìµë¥ ì˜ í‰ê· ê³¼ ë³€ë™ì„±ì„ ì´ìš©í•œ í™•ë¥ ì  ì˜ˆì¸¡
                                - íš¨ìœ¨ì  ì‹œì¥ ê°€ì„¤ì˜ ê¸°ë³¸ ëª¨ë¸
                                
                                **ğŸ“ˆ Linear Regression (ì„ í˜• íšŒê·€)**
                                - ì‹œê°„ì— ë”°ë¥¸ ì£¼ê°€ì˜ ì„ í˜• ì¶”ì„¸ë¥¼ í•™ìŠµ
                                - ì¥ê¸°ì ì¸ ë°©í–¥ì„± íŒŒì•…ì— ìœ ìš©
                                - ë‹¨ìˆœí•˜ì§€ë§Œ ëª…í™•í•œ ì¶”ì„¸ ì œì‹œ
                                
                                **ğŸ“Š Moving Average (ì´ë™í‰ê· )**
                                - ê³¼ê±° ì¼ì • ê¸°ê°„ì˜ í‰ê·  ê°€ê²©ì„ ê¸°ë°˜ìœ¼ë¡œ ì˜ˆì¸¡
                                - ë‹¨ê¸° ë³€ë™ì„±ì„ ì œê±°í•˜ì—¬ ì¶”ì„¸ íŒŒì•…
                                - ê¸°ìˆ ì  ë¶„ì„ì˜ ê¸°ë³¸ ë„êµ¬
                                
                                **ğŸŒŠ Exponential Smoothing (ì§€ìˆ˜í‰í™œ)**
                                - ìµœê·¼ ë°ì´í„°ì— ë” ë†’ì€ ê°€ì¤‘ì¹˜ë¥¼ ë¶€ì—¬
                                - ê¸‰ê²©í•œ ë³€í™”ì— ë¹ ë¥´ê²Œ ë°˜ì‘
                                - ë‹¨ê¸° ì˜ˆì¸¡ì— íš¨ê³¼ì 
                                
                                **ğŸ”„ ARIMA Style (ì‹œê³„ì—´ ëª¨ë¸)**
                                - ìê¸°íšŒê·€ëª¨ë¸ì„ ì´ìš©í•œ ì‹œê³„ì—´ ì˜ˆì¸¡
                                - ê³¼ê±° ê°’ë“¤ ê°„ì˜ ê´€ê³„ë¥¼ ëª¨ë¸ë§
                                - ì‹œê³„ì—´ ë°ì´í„°ì˜ íŒ¨í„´ í•™ìŠµ
                                """)
                        else:
                            st.error("ì„ íƒí•œ ëª¨ë¸ë“¤ì˜ ì˜ˆì¸¡ì´ ëª¨ë‘ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
                    
                    else:
                        st.error("ì£¼ê°€ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            else:
                st.warning("ìµœì†Œ í•˜ë‚˜ì˜ ì˜ˆì¸¡ ëª¨ë¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.")
    
    else:
        st.info("ì£¼ê°€ ì˜ˆì¸¡ì„ ìœ„í•´ ê¸°ì—…ì„ ì„ íƒí•˜ê±°ë‚˜ ì¢…ëª©ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")

# ì‚¬ì´ë“œë°”
with st.sidebar:
    # ğŸš¨ ëˆˆì— ë„ëŠ” ê¸´ê¸‰ ë²„íŠ¼ë“¤ì„ ìµœìƒë‹¨ì— ë°°ì¹˜
    st.markdown("### ğŸš¨ API ë¬¸ì œ í•´ê²°")
    
    # í° ë²„íŠ¼ìœ¼ë¡œ ë§Œë“¤ê¸°
    if st.button("ğŸ—‘ï¸ ìºì‹œ ì´ˆê¸°í™” (ì—¬ê¸°!)", type="primary", use_container_width=True, help="API ì—ëŸ¬ ì‹œ ì´ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”!"):
        st.cache_data.clear()
        # ì„¸ì…˜ ìƒíƒœë„ ì´ˆê¸°í™”
        if 'last_api_request' in st.session_state:
            del st.session_state.last_api_request
        st.success("âœ… ìºì‹œê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!")
        st.success("ğŸ”„ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”!")
        st.rerun()
    
    if st.button("â° API ëŒ€ê¸°ì‹œê°„ ë¦¬ì…‹", use_container_width=True, help="API ìš”ì²­ ê°„ê²©ì„ ë¦¬ì…‹í•©ë‹ˆë‹¤"):
        if 'last_api_request' in st.session_state:
            del st.session_state.last_api_request
        st.success("âœ… API ëŒ€ê¸°ì‹œê°„ì´ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤!")
        st.rerun()
    
    st.markdown("---")
    
    st.header("âš™ï¸ ì„¤ì • ë° ì •ë³´")
    
    # ê°„ë‹¨í•œ Rate Limit ì •ë³´
    if st.button("âš ï¸ Rate Limit ì •ë³´", help="Yahoo Finance API ì‚¬ìš©ëŸ‰ ì •ë³´"):
        st.info("""
        **Yahoo Finance API ì œí•œ:**
        - ë¬´ë£Œ: 2,000 ìš”ì²­/ì‹œê°„
        - ë„ˆë¬´ ë§ì€ ìš”ì²­ ì‹œ ì¼ì‹œì  ì°¨ë‹¨
        - ìºì‹œë¥¼ í™œìš©í•˜ì—¬ ìš”ì²­ ìˆ˜ ìµœì†Œí™”
        """)
    
    # Rate Limit ìƒíƒœ í‘œì‹œ
    if 'last_api_request' in st.session_state:
        time_since_last = time.time() - st.session_state.last_api_request
        if time_since_last < 60:  # 1ë¶„ ì´ë‚´
            st.warning(f"â° ë§ˆì§€ë§‰ API ìš”ì²­: {time_since_last:.0f}ì´ˆ ì „")
            st.info("ğŸ’¡ API ì•ˆì •ì„±ì„ ìœ„í•´ ìš”ì²­ ê°„ê²©ì„ ì¡°ì ˆí•˜ê³  ìˆìŠµë‹ˆë‹¤.")
        else:
            st.success("âœ… API ìƒíƒœ ì•ˆì •")
    
    # ì‹¤ì œ ë°ì´í„° ì „ìš© ëª¨ë“œ ì•ˆë‚´
    st.markdown("**âœ… ì‹¤ì œ ë°ì´í„° ì „ìš©**")
    st.success("""
    â€¢ 100% ì‹¤ì œ ì‹œì¥ ë°ì´í„°ë§Œ ì‚¬ìš©
    â€¢ ì‹¤ì œ ì¬ë¬´ì œí‘œ ë°ì´í„°ë§Œ ë¶„ì„
    â€¢ ë°ì´í„° ì—†ìœ¼ë©´ ë¶„ì„ ì¤‘ë‹¨
    â€¢ íˆ¬ì ì‹ ë¢°ì„± ìµœëŒ€í™”
    """)
    
    # ë©€í‹° ì—ì´ì „íŠ¸ ì•ˆë‚´
    st.markdown("**ğŸ¤– ë©€í‹° ì—ì´ì „íŠ¸ ë¶„ì„**")
    st.info("""
    **6ëª…ì˜ ì „ë¬¸ê°€ê°€ ë™ì‹œì— ë¶„ì„:**
    ğŸ’° ì¬ë¬´ ë¶„ì„ ì „ë¬¸ê°€
    ğŸ“Š íˆ¬ì ë¶„ì„ê°€  
    âš ï¸ ë¦¬ìŠ¤í¬ ë§¤ë‹ˆì €
    ğŸ“ˆ ê¸°ìˆ  ë¶„ì„ê°€
    ğŸ­ ì‚°ì—… ë¶„ì„ê°€
    ğŸŒ± ESG ì „ë¬¸ê°€
    
    ğŸ‘” CFOê°€ ëª¨ë“  ì˜ê²¬ì„ ì¢…í•©
    """)
    
    st.markdown("**âš¡ ë³‘ë ¬ ì²˜ë¦¬ ì¥ì **")
    st.markdown("""
    - ë‹¤ê°ë„ ì „ë¬¸ ë¶„ì„
    - ë™ì‹œ ì‹¤í–‰ìœ¼ë¡œ ì‹œê°„ ë‹¨ì¶•
    - ì¢…í•©ì  íˆ¬ì ì¸ì‚¬ì´íŠ¸
    - ê· í˜• ì¡íŒ ì˜ì‚¬ê²°ì • ì§€ì›
    """)
    
    # Mermaid ì°¨íŠ¸ ê¸°ëŠ¥ ì•ˆë‚´
    st.markdown("**ğŸ¨ ì‹œê°ì  ì°¨íŠ¸ ë¶„ì„**")
    st.success("""
    **AIê°€ ìë™ ìƒì„±í•˜ëŠ” ì°¨íŠ¸:**
    ğŸ“Š SWOT ë¶„ì„ mindmap
    ğŸ“ˆ íˆ¬ì ì˜ì‚¬ê²°ì • flowchart  
    ğŸ¥§ í¬íŠ¸í´ë¦¬ì˜¤ êµ¬ì„± pie chart
    ğŸ“‰ ë¦¬ìŠ¤í¬-ìˆ˜ìµë¥  ë§¤íŠ¸ë¦­ìŠ¤
    â° ì„±ì¥ ë‹¨ê³„ timeline
    ğŸ”„ í”„ë¡œì„¸ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨
    
    ğŸ’¡ ë¶„ì„ê³¼ í•¨ê»˜ ìë™ ë Œë”ë§
    """)
    
    st.markdown("**ğŸ¯ ì°¨íŠ¸ ì¢…ë¥˜ë³„ í™œìš©**")
    st.markdown("""
    - **pie**: êµ¬ì„± ë¹„ìœ¨ ë¶„ì„
    - **flowchart**: í”„ë¡œì„¸ìŠ¤ ì‹œê°í™”
    - **mindmap**: ìš”ì†Œ ë¶„ë¥˜ ì²´ê³„
    - **timeline**: ì‹œê°„ë³„ ë³€í™” ì¶”ì´
    - **quadrant**: 2ì°¨ì› ë§¤íŠ¸ë¦­ìŠ¤ ë¶„ì„
    """)
    
    st.markdown("**ğŸ’¡ API ìµœì í™” íŒ**")
    st.markdown("""
    - ê°™ì€ ê¸°ì—… ë°˜ë³µ ì¡°íšŒ ì‹œ ìºì‹œ í™œìš©
    - ì—¬ëŸ¬ ê¸°ì—… ë™ì‹œ ì¡°íšŒ ê¸ˆì§€
    - 5-10ë¶„ ê°„ê²©ìœ¼ë¡œ ì‚¬ìš© ê¶Œì¥
    """)
    
    st.markdown("**ğŸ“Š ì¬ë¬´ì œí‘œ ìˆ˜ì§‘ ì „ëµ**")
    st.success("""
    **3ë‹¨ê³„ ë°ì´í„° ìˆ˜ì§‘:**
    ğŸ‡°ğŸ‡· 1ì°¨: ë„¤ì´ë²„ ì¦ê¶Œ (í•œêµ­ì–´)
    ğŸŒ 2ì°¨: Yahoo Finance (ì˜ì–´)
    ğŸ“‹ 3ì°¨: ê¸°ë³¸ êµ¬ì¡° ìƒì„±
    
    **ìˆ˜ì§‘ í˜„í™©:**
    â€¢ ë„¤ì´ë²„: ì£¼ê°€ + ê¸°ë³¸ ì¬ë¬´ ì •ë³´
    â€¢ Yahoo: ìƒì„¸ ì¬ë¬´ì œí‘œ (ì œí•œì )
    â€¢ ê¸°ë³¸ êµ¬ì¡°: ë¶„ì„ ê°€ëŠ¥í•œ í˜•íƒœ
    """)
    
    st.markdown("**ğŸš€ ê°œì„  ê³„íš**")
    st.info("""
    **ì¶”ê°€ ì˜ˆì • ë°ì´í„° ì†ŒìŠ¤:**
    â€¢ ë‹¤íŠ¸(DART) ì „ìê³µì‹œ
    â€¢ í•œêµ­ê±°ë˜ì†Œ(KRX) ê³µì‹ ë°ì´í„°
    â€¢ ë„¤ì´ë²„ ì¦ê¶Œ ìƒì„¸ ì¬ë¬´ì œí‘œ
    â€¢ ë‹¤ìŒ ê¸ˆìœµ ë³´ì¡° ë°ì´í„°
    """)
    
    st.markdown("**ğŸ” ë””ë²„ê¹… ì •ë³´**")
    st.info("""
    ì¬ë¬´ì œí‘œ ìˆ˜ì§‘ ì‹¤íŒ¨ ì‹œ:
    â€¢ ìƒì„¸ ë¡œê·¸ í™•ì¸
    â€¢ ë°ì´í„° í¬ê¸° ì ê²€
    â€¢ í•­ëª©ëª… ê²€ì¦
    â€¢ ëŒ€ì•ˆ êµ¬ì¡° ìƒì„±
    """)
    
    st.divider()
    
    # í˜„ì¬ ë¶„ì„ ì •ë³´
    if st.session_state.current_analysis:
        st.subheader("ğŸ“Š ìµœê·¼ AI ë¶„ì„")
        analysis = st.session_state.current_analysis
        
        st.markdown(f"**ê¸°ì—…**: {analysis['company']}")
        
        # ë¶„ì„ ëª¨ë“œì— ë”°ë¥¸ ì •ë³´ í‘œì‹œ
        if analysis.get('analysis_mode') == 'multi_agent':
            st.markdown(f"**ë¶„ì„ ë°©ì‹**: ğŸ¤– ë©€í‹° ì—ì´ì „íŠ¸")
            st.markdown(f"**ì „ë¬¸ê°€ ìˆ˜**: {len(analysis.get('agents', []))}ëª…")
            
            # ì°¸ì—¬ ì „ë¬¸ê°€ ëª©ë¡
            if 'agents' in analysis:
                agent_names = []
                for agent_key in analysis['agents']:
                    if agent_key in FINANCIAL_AGENTS:
                        agent_info = FINANCIAL_AGENTS[agent_key]
                        agent_names.append(f"{agent_info['emoji']} {agent_info['name']}")
                
                with st.expander("ğŸ‘¥ ì°¸ì—¬ ì „ë¬¸ê°€", expanded=False):
                    for name in agent_names:
                        st.markdown(f"- {name}")
        else:
            st.markdown(f"**ë¶„ì„ ìœ í˜•**: {analysis.get('analysis_type', 'N/A')}")
        
        st.markdown(f"**AI ëª¨ë¸**: {analysis['model']}")
        st.markdown(f"**ë¶„ì„ ì‹œê°„**: {analysis['timestamp'].strftime('%Y-%m-%d %H:%M')}")
        st.markdown(f"**ì†Œìš” ì‹œê°„**: {analysis.get('execution_time', 0)}ì´ˆ")
        
        # Reasoning ê³¼ì • (ë‹¨ì¼ AI ë¶„ì„ìš©)
        if analysis.get('analysis_mode') == 'single_ai' and analysis.get('has_thinking') and analysis.get('thinking'):
            with st.expander("ğŸ§  Reasoning ê³¼ì •", expanded=False):
                st.text_area(
                    "AI ì‚¬ê³  ê³¼ì •",
                    value=analysis['thinking'],
                    height=200,
                    disabled=True
                )
    
    st.divider()
    
    # ì‹œì¥ ìƒíƒœ ìš”ì•½
    st.subheader("ğŸ“ˆ ì‹œì¥ í˜„í™©")
    
    try:
        # ì½”ìŠ¤í”¼ ê°„ë‹¨ ì •ë³´
        kospi_hist, _ = get_stock_data("^KS11", "1d")
        if kospi_hist is not None and not kospi_hist.empty:
            kospi_price = kospi_hist['Close'][-1]
            st.metric("ì½”ìŠ¤í”¼", f"{kospi_price:,.2f}")
        
        # ì½”ìŠ¤ë‹¥ ê°„ë‹¨ ì •ë³´  
        kosdaq_hist, _ = get_stock_data("^KQ11", "1d")
        if kosdaq_hist is not None and not kosdaq_hist.empty:
            kosdaq_price = kosdaq_hist['Close'][-1]
            st.metric("ì½”ìŠ¤ë‹¥", f"{kosdaq_price:,.2f}")
            
    except Exception as e:
        st.error("ì‹œì¥ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨")
    
    st.divider()
    
    # ë„ì›€ë§
    st.subheader("â„¹ï¸ ì‚¬ìš© ì•ˆë‚´")
    
    help_html = """
    <details>
        <summary style="cursor: pointer; font-weight: bold; color: #1f77b4;">
            ğŸ“– ì‚¬ìš©ë²• ë³´ê¸°
        </summary>
        <div style="margin-top: 10px; padding: 10px; background-color: #f0f2f6; border-radius: 5px; color: #000000;">
            <strong>ğŸ“Š ì§€ìˆ˜ í˜„í™©</strong>: ì½”ìŠ¤í”¼/ì½”ìŠ¤ë‹¥ ì‹¤ì‹œê°„ ì§€ìˆ˜<br><br>
            <strong>ğŸ¢ ê¸°ì—… ë¶„ì„</strong>: ê°œë³„ ê¸°ì—…ì˜ ìƒì„¸ ì¬ë¬´ ë¶„ì„<br><br>
            <strong>ğŸ“ˆ ë¹„êµ ë¶„ì„</strong>: ì—¬ëŸ¬ ê¸°ì—… ì„±ê³¼ ë¹„êµ<br><br>
            <strong>ğŸ¤– AI ë¶„ì„</strong>: AI ëª¨ë¸ì„ í™œìš©í•œ ì‹¬ì¸µ ì¬ë¬´ ë¶„ì„
        </div>
    </details>
    """
    st.markdown(help_html, unsafe_allow_html=True)
    
    st.markdown("---")
    st.caption("ğŸ“ˆ íƒ€ì‚¬ ì¬ë¬´ ë¶„ì„ v1.0")
    st.caption("Yahoo Finance & AI ê¸°ë°˜") 