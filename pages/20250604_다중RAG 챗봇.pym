import streamlit as st
import os
from datetime import datetime
import time
import random
from dotenv import load_dotenv
from openai import OpenAI
import anthropic
from langchain_anthropic import ChatAnthropic
import json
import asyncio
import threading
from concurrent.futures import ThreadPoolExecutor, as_completed

# RAG ê´€ë ¨ import ì¶”ê°€
import mysql.connector
import pandas as pd
from sqlalchemy import create_engine
import requests
from bs4 import BeautifulSoup
from urllib.parse import urljoin, urlparse
from urllib.robotparser import RobotFileParser
import nltk
import logging
from pathlib import Path
import hashlib

# ë²¡í„° ë°ì´í„°ë² ì´ìŠ¤ ê´€ë ¨ import
from langchain.embeddings import OpenAIEmbeddings
from langchain.vectorstores.faiss import FAISS
from langchain.text_splitter import CharacterTextSplitter
from langchain.document_loaders import UnstructuredFileLoader
from langchain.schema import Document

# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(
    page_title="ğŸ¤– ë‹¤ì¤‘ RAG ê¸°ë°˜ ì±—ë´‡ ğŸ—„ï¸",
    page_icon="ğŸ¤–",
    layout="wide"
)

st.title("ğŸ¤– ë‹¤ì¤‘ RAG ê¸°ë°˜ ì±—ë´‡ ğŸ—„ï¸")
# ì¸ì¦ ê¸°ëŠ¥ (ê°„ë‹¨í•œ ë¹„ë°€ë²ˆí˜¸ ë³´í˜¸)
if 'authenticated' not in st.session_state:
    st.session_state.authenticated = False
admin_pw = os.getenv('ADMIN_PASSWORD')
if not admin_pw:
    st.error('í™˜ê²½ë³€ìˆ˜(ADMIN_PASSWORD)ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. .env íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.')
    st.stop()
if not st.session_state.authenticated:
    password = st.text_input("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”", type="password")
    if password == admin_pw:
        st.session_state.authenticated = True
        st.rerun()
    else:
        if password:
            st.error("ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤")
        st.stop()

st.markdown("RAG ê¸°ë°˜ AI ì–´ì‹œìŠ¤í„´íŠ¸ - MySQL DB, ì›¹ì‚¬ì´íŠ¸, ë¬¸ì„œ ë¶„ì„ ì§€ì›")

# í‘œì¤€í™”ëœ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í•¨ìˆ˜
def connect_to_db():
    """ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°"""
    try:
        conn = mysql.connector.connect(
            host=os.getenv('SQL_HOST'),
            user=os.getenv('SQL_USER'),
            password=os.getenv('SQL_PASSWORD'),
            database=os.getenv('SQL_DATABASE_NEWBIZ'),
            charset='utf8mb4',
            collation='utf8mb4_unicode_ci'
        )
        return conn
    except mysql.connector.Error as err:
        st.error(f"ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì˜¤ë¥˜: {err}")
        return None

def create_rag_agent_tables():
    """RAG ì—ì´ì „íŠ¸ìš© í…Œì´ë¸” ìƒì„±"""
    try:
        connection = connect_to_db()
        if not connection:
            return False
        
        cursor = connection.cursor()
        
        # 1. ë©”ì¸ ëŒ€í™” ì„¸ì…˜ í…Œì´ë¸”
        rag_conversations_table = """
        CREATE TABLE IF NOT EXISTS rag_conversations (
            id INT AUTO_INCREMENT PRIMARY KEY,
            session_title VARCHAR(255) NOT NULL COMMENT 'ëŒ€í™” ì„¸ì…˜ ì œëª©',
            user_query TEXT NOT NULL COMMENT 'ì‚¬ìš©ì ì§ˆë¬¸',
            assistant_response LONGTEXT COMMENT 'AI ì‘ë‹µ',
            model_name VARCHAR(100) NOT NULL COMMENT 'ì‚¬ìš©ëœ AI ëª¨ë¸',
            has_reasoning BOOLEAN DEFAULT FALSE COMMENT 'reasoning í¬í•¨ ì—¬ë¶€',
            reasoning_content LONGTEXT COMMENT 'reasoning ê³¼ì •',
            rag_sources_used INT DEFAULT 0 COMMENT 'ì‚¬ìš©ëœ RAG ì†ŒìŠ¤ ìˆ˜',
            execution_time_seconds INT COMMENT 'ì‘ë‹µ ìƒì„± ì‹œê°„(ì´ˆ)',
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            tags VARCHAR(500) COMMENT 'ê²€ìƒ‰ìš© íƒœê·¸',
            notes TEXT COMMENT 'ì¶”ê°€ ë©”ëª¨',
            INDEX idx_created_at (created_at),
            INDEX idx_model_name (model_name),
            INDEX idx_has_reasoning (has_reasoning),
            FULLTEXT idx_search (session_title, user_query, tags, notes)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='RAG ì—ì´ì „íŠ¸ ëŒ€í™” ì„¸ì…˜';
        """
        cursor.execute(rag_conversations_table)
        
        # 2. RAG ì†ŒìŠ¤ ì •ë³´ í…Œì´ë¸”
        rag_sources_table = """
        CREATE TABLE IF NOT EXISTS rag_conversation_sources (
            id INT AUTO_INCREMENT PRIMARY KEY,
            conversation_id INT NOT NULL COMMENT 'ëŒ€í™” ì„¸ì…˜ ID',
            source_type ENUM('mysql', 'website', 'files') NOT NULL COMMENT 'RAG ì†ŒìŠ¤ íƒ€ì…',
            source_name VARCHAR(255) NOT NULL COMMENT 'ì†ŒìŠ¤ ì´ë¦„',
            source_description TEXT COMMENT 'ì†ŒìŠ¤ ì„¤ëª…',
            source_details JSON COMMENT 'ì†ŒìŠ¤ ìƒì„¸ ì •ë³´',
            data_size INT COMMENT 'ë°ì´í„° í¬ê¸°',
            content_preview TEXT COMMENT 'ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°',
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (conversation_id) REFERENCES rag_conversations(id) ON DELETE CASCADE,
            INDEX idx_conversation_id (conversation_id),
            INDEX idx_source_type (source_type),
            INDEX idx_source_name (source_name)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='RAG ì†ŒìŠ¤ ì •ë³´';
        """
        cursor.execute(rag_sources_table)
        
        connection.commit()
        cursor.close()
        connection.close()
        return True
        
    except Exception as e:
        st.error(f"í…Œì´ë¸” ìƒì„± ì˜¤ë¥˜: {str(e)}")
        return False

def get_mysql_tables():
    """MySQL í…Œì´ë¸” ëª©ë¡ ì¡°íšŒ"""
    try:
        connection = connect_to_db()
        if not connection:
            return []
        
        cursor = connection.cursor()
        cursor.execute("SHOW TABLES")
        tables = [table[0] for table in cursor.fetchall()]
        
        cursor.close()
        connection.close()
        return tables
    except Exception as e:
        st.error(f"í…Œì´ë¸” ì¡°íšŒ ì˜¤ë¥˜: {str(e)}")
        return []

def load_mysql_data(selected_tables):
    """ì„ íƒëœ MySQL í…Œì´ë¸” ë°ì´í„° ë¡œë“œ"""
    mysql_data = {}
    
    try:
        connection = connect_to_db()
        if not connection:
            return mysql_data
        
        for table in selected_tables:
            try:
                query = f"SELECT * FROM {table} LIMIT 1000"
                df = pd.read_sql(query, connection)
                mysql_data[table] = df
                st.success(f"âœ… {table} í…Œì´ë¸” ë¡œë“œ ì™„ë£Œ ({len(df)}í–‰)")
            except Exception as e:
                st.error(f"âŒ {table} í…Œì´ë¸” ë¡œë“œ ì‹¤íŒ¨: {str(e)}")
        
        connection.close()
        return mysql_data
        
    except Exception as e:
        st.error(f"MySQL ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: {str(e)}")
        return mysql_data

def scrape_website_simple(url, max_pages=5):
    """ê°„ë‹¨í•œ ì›¹ì‚¬ì´íŠ¸ ìŠ¤í¬ë˜í•‘ - ê°œì„ ëœ ë²„ì „"""
    try:
        if not url.startswith(('http://', 'https://')):
            url = 'https://' + url
        
        visited_urls = set()
        scraped_data = []
        urls_to_visit = [url]
        
        session = requests.Session()
        session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        })
        
        successfully_scraped = 0  # ì‹¤ì œë¡œ ìŠ¤í¬ë˜í•‘ëœ í˜ì´ì§€ ìˆ˜
        
        while urls_to_visit and successfully_scraped < max_pages:
            current_url = urls_to_visit.pop(0)
            
            if current_url in visited_urls:
                continue
                
            try:
                response = session.get(current_url, timeout=10)
                response.raise_for_status()
                
                visited_urls.add(current_url)
                
                soup = BeautifulSoup(response.content, 'html.parser')
                
                # í˜ì´ì§€ ì œëª© ì¶”ì¶œ
                title = soup.find('title')
                title_text = title.get_text().strip() if title else f"í˜ì´ì§€ {successfully_scraped + 1}"
                
                # ë¶ˆí•„ìš”í•œ íƒœê·¸ ì œê±°
                for script in soup(["script", "style", "nav", "header", "footer"]):
                    script.decompose()
                
                # ë³¸ë¬¸ í…ìŠ¤íŠ¸ ì¶”ì¶œ
                text = soup.get_text()
                lines = (line.strip() for line in text.splitlines())
                chunks = (phrase.strip() for line in lines for phrase in line.split("  "))
                content = ' '.join(chunk for chunk in chunks if chunk)
                
                # ì½˜í…ì¸ ê°€ ìˆìœ¼ë©´ ì¶”ê°€ (ê¸¸ì´ ì œí•œ ì™„í™”)
                if len(content) > 50:  # 50ìë¡œ ê¸°ì¤€ ë‚®ì¶¤
                    scraped_data.append({
                        'url': current_url,
                        'title': title_text,
                        'content': content[:2000]  # ì²˜ìŒ 2000ìë§Œ
                    })
                    
                    successfully_scraped += 1
                    st.success(f"âœ… í˜ì´ì§€ {successfully_scraped}/{max_pages} ìŠ¤í¬ë˜í•‘ ì™„ë£Œ: {title_text}")
                
                # ë” ë§ì€ ë§í¬ ì°¾ê¸° (ì œí•œ ì™„í™”)
                base_domain = urlparse(url).netloc
                
                # ë§í¬ íƒìƒ‰ì„ ë” ì ê·¹ì ìœ¼ë¡œ
                for link in soup.find_all("a", href=True)[:20]:  # 20ê°œë¡œ ì¦ê°€
                    absolute_link = urljoin(current_url, link['href'])
                    parsed_link = urlparse(absolute_link)
                    
                    # ì¡°ê±´ ì™„í™”: ê°™ì€ ë„ë©”ì¸ + ê¸°ë³¸ì ì¸ í•„í„°ë§
                    if (parsed_link.netloc == base_domain and 
                        absolute_link not in visited_urls and 
                        absolute_link not in urls_to_visit and
                        not any(x in absolute_link.lower() for x in ['#', 'javascript:', 'mailto:', 'tel:']) and
                        len(urls_to_visit) < 50):  # ëŒ€ê¸° í í¬ê¸° ì œí•œ
                        urls_to_visit.append(absolute_link)
                
                time.sleep(0.5)  # ì§€ì—°ì‹œê°„ ë‹¨ì¶• (1ì´ˆ â†’ 0.5ì´ˆ)
                
            except Exception as e:
                st.warning(f"âš ï¸ í˜ì´ì§€ í¬ë¡¤ë§ ì‹¤íŒ¨ ({current_url}): {str(e)}")
                continue
        
        # ê²°ê³¼ ë©”ì‹œì§€ ê°œì„ 
        if scraped_data:
            if successfully_scraped == max_pages:
                st.success(f"ğŸ‰ ëª©í‘œ ë‹¬ì„±! {successfully_scraped}ê°œ í˜ì´ì§€ í¬ë¡¤ë§ ì™„ë£Œ!")
            else:
                st.info(f"ğŸ“„ {successfully_scraped}ê°œ í˜ì´ì§€ í¬ë¡¤ë§ ì™„ë£Œ (ëª©í‘œ: {max_pages}ê°œ)")
                if successfully_scraped < max_pages:
                    st.warning(f"ğŸ’¡ {max_pages - successfully_scraped}ê°œ í˜ì´ì§€ ë¶€ì¡± - ì‚¬ì´íŠ¸ì— ì¶”ê°€ ë§í¬ê°€ ë¶€ì¡±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
        else:
            st.error("âŒ í¬ë¡¤ë§ëœ í˜ì´ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.")
        
        return scraped_data
        
    except Exception as e:
        st.error(f"âŒ ì›¹ì‚¬ì´íŠ¸ ìŠ¤í¬ë˜í•‘ ì‹¤íŒ¨: {str(e)}")
        return []

def process_files(files):
    """ì—…ë¡œë“œëœ íŒŒì¼ ì²˜ë¦¬"""
    files_data = []
    
    for file in files:
        try:
            if file.type == "text/plain":
                content = str(file.read(), "utf-8")
            elif file.type == "application/pdf":
                # PDF ì²˜ë¦¬ (ê°„ë‹¨í•œ ì˜ˆì‹œ)
                content = "PDF íŒŒì¼ - ì „ë¬¸ ì²˜ë¦¬ í•„ìš”"
            else:
                content = str(file.read(), "utf-8", errors='ignore')
            
            files_data.append({
                'name': file.name,
                'size': len(content),
                'content': content
            })
            
            st.success(f"âœ… íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ: {file.name}")
            
        except Exception as e:
            st.error(f"âŒ íŒŒì¼ ì²˜ë¦¬ ì‹¤íŒ¨ ({file.name}): {str(e)}")
    
    return files_data

def create_rag_context(mysql_data=None, website_data=None, files_data=None):
    """RAG ì»¨í…ìŠ¤íŠ¸ ìƒì„±"""
    context_parts = []
    rag_sources_used = []
    
    # MySQL ë°ì´í„° ì»¨í…ìŠ¤íŠ¸
    if mysql_data:
        mysql_context = "=== MySQL ë°ì´í„°ë² ì´ìŠ¤ ì •ë³´ ===\n"
        mysql_tables = []
        total_mysql_rows = 0
        
        for table_name, df in mysql_data.items():
            mysql_context += f"\n[{table_name}] í…Œì´ë¸”:\n"
            mysql_context += f"- í–‰ ìˆ˜: {len(df):,}ê°œ\n"
            mysql_context += f"- ì»¬ëŸ¼: {', '.join(df.columns.tolist())}\n"
            
            mysql_tables.append(table_name)
            total_mysql_rows += len(df)
            
            # ìƒ˜í”Œ ë°ì´í„° (ìƒìœ„ 3í–‰)
            if len(df) > 0:
                mysql_context += "- ìƒ˜í”Œ ë°ì´í„°:\n"
                mysql_context += df.head(3).to_string(index=False)
                mysql_context += "\n"
        
        context_parts.append(mysql_context)
        rag_sources_used.append({
            'type': 'mysql',
            'name': 'MySQL ë°ì´í„°ë² ì´ìŠ¤',
            'details': f"{len(mysql_tables)}ê°œ í…Œì´ë¸” ({total_mysql_rows:,}í–‰)",
            'tables': mysql_tables
        })
    
    # ì›¹ì‚¬ì´íŠ¸ ë°ì´í„° ì»¨í…ìŠ¤íŠ¸
    if website_data:
        website_context = "=== ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ì •ë³´ ===\n"
        website_urls = []
        
        for i, page_data in enumerate(website_data[:3]):  # ìƒìœ„ 3ê°œ í˜ì´ì§€ë§Œ
            website_context += f"\n[í˜ì´ì§€ {i+1}] {page_data['title']}\n"
            website_context += f"URL: {page_data['url']}\n"
            website_context += f"ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°: {page_data['content'][:500]}...\n"
            website_urls.append({
                'title': page_data['title'],
                'url': page_data['url']
            })
        
        context_parts.append(website_context)
        rag_sources_used.append({
            'type': 'website',
            'name': 'ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§',
            'details': f"{len(website_data)}ê°œ í˜ì´ì§€",
            'urls': website_urls
        })
    
    # íŒŒì¼ ë°ì´í„° ì»¨í…ìŠ¤íŠ¸
    if files_data:
        files_context = "=== ì—…ë¡œë“œëœ ë¬¸ì„œ ì •ë³´ ===\n"
        file_list = []
        total_file_size = 0
        
        for file_data in files_data:
            files_context += f"\n[ë¬¸ì„œ] {file_data['name']}\n"
            files_context += f"í¬ê¸°: {file_data['size']:,}ì\n"
            files_context += f"ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°: {file_data['content'][:500]}...\n"
            
            file_list.append(file_data['name'])
            total_file_size += file_data['size']
        
        context_parts.append(files_context)
        rag_sources_used.append({
            'type': 'files',
            'name': 'ì—…ë¡œë“œ ë¬¸ì„œ',
            'details': f"{len(file_list)}ê°œ íŒŒì¼ ({total_file_size:,}ì)",
            'files': file_list
        })
    
    context_text = "\n\n".join(context_parts)
    return context_text, rag_sources_used

def get_ai_response(prompt, model_name, system_prompt="", enable_thinking=False, thinking_budget=4000):
    """AI ëª¨ë¸ë¡œë¶€í„° ì‘ë‹µì„ ë°›ëŠ” í•¨ìˆ˜ (reasoning ê³¼ì • í‘œì‹œ ì§€ì›)"""
    try:
        if model_name.startswith('claude'):
            # Reasoning ëª¨ë¸ì¸ì§€ í™•ì¸
            is_reasoning_model = (
                model_name.startswith('claude-opus-4') or 
                model_name.startswith('claude-sonnet-4') or 
                model_name.startswith('claude-3-7') or
                model_name == 'claude-3-5-sonnet-latest'
            )
            
            if is_reasoning_model and enable_thinking:
                # Extended Thinking ì‚¬ìš© (ì§ì ‘ Anthropic í´ë¼ì´ì–¸íŠ¸ ì‚¬ìš©)
                import anthropic
                direct_client = anthropic.Anthropic(api_key=os.getenv('ANTHROPIC_API_KEY'))
                
                # ë©”ì‹œì§€ êµ¬ì„± (systemì€ ë³„ë„ íŒŒë¼ë¯¸í„°ë¡œ)
                messages = [{"role": "user", "content": prompt}]
                
                response = direct_client.messages.create(
                    model=model_name,
                    max_tokens=8192,
                    system=system_prompt if system_prompt else None,
                    thinking={
                        "type": "enabled",
                        "budget_tokens": thinking_budget
                    },
                    messages=messages
                )
                
                # thinkingê³¼ text ë¸”ë¡ ë¶„ë¦¬
                thinking_content = ""
                final_content = ""
                
                for block in response.content:
                    if hasattr(block, 'type'):
                        if block.type == "thinking":
                            thinking_content = block.thinking
                        elif block.type == "text":
                            final_content = block.text
                        elif block.type == "redacted_thinking":
                            thinking_content += "\n[ì¼ë¶€ ì‚¬ê³  ê³¼ì •ì´ ë³´ì•ˆìƒ ì•”í˜¸í™”ë˜ì—ˆìŠµë‹ˆë‹¤]"
                
                return {
                    "content": final_content,
                    "thinking": thinking_content,
                    "has_thinking": True
                }
            else:
                # ì¼ë°˜ ëª¨ë“œ (LangChain ì‚¬ìš©)
                from langchain_anthropic import ChatAnthropic
                client = ChatAnthropic(
                    model=model_name, 
                    api_key=os.getenv('ANTHROPIC_API_KEY'), 
                    temperature=0.7, 
                    max_tokens=8192
                )
                
                # LangChainì—ì„œëŠ” ì‹œìŠ¤í…œ ë©”ì‹œì§€ë¥¼ ë”°ë¡œ ì„¤ì •
                if system_prompt:
                    # ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ê°€ ìˆìœ¼ë©´ í”„ë¡¬í”„íŠ¸ì— í¬í•¨
                    full_prompt = f"System: {system_prompt}\n\nUser: {prompt}"
                    response = client.invoke(full_prompt)
                else:
                    response = client.invoke(prompt)
                
                content = response.content if hasattr(response, 'content') else str(response)
                return {
                    "content": content,
                    "thinking": "",
                    "has_thinking": False
                }
                
        else:
            # OpenAI ëª¨ë¸ë“¤
            openai_key = os.getenv('OPENAI_API_KEY')
            if not openai_key:
                st.error("âŒ OpenAI API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!")
                return {
                    "content": "OpenAI API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.",
                    "thinking": "",
                    "has_thinking": False
                }
            
            from openai import OpenAI
            openai_client = OpenAI(api_key=openai_key)
            
            # o1 reasoning ëª¨ë¸ì¸ì§€ í™•ì¸
            is_o1_model = model_name.startswith('o1')
            
            if is_o1_model:
                # o1 ëª¨ë¸ì€ system message ì§€ì›í•˜ì§€ ì•ŠìŒ
                response = openai_client.chat.completions.create(
                    model=model_name,
                    messages=[
                        {"role": "user", "content": f"{system_prompt}\n\n{prompt}" if system_prompt else prompt}
                    ],
                    max_completion_tokens=8192
                )
                
                content = response.choices[0].message.content
                
                return {
                    "content": content,
                    "thinking": "ğŸ§  ì´ ëª¨ë¸ì€ ë‚´ë¶€ì ìœ¼ë¡œ ë³µì¡í•œ reasoning ê³¼ì •ì„ ê±°ì³ ë‹µë³€ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤.",
                    "has_thinking": True
                }
            else:
                # ì¼ë°˜ OpenAI ëª¨ë¸
                messages = []
                if system_prompt:
                    messages.append({"role": "system", "content": system_prompt})
                messages.append({"role": "user", "content": prompt})
                
                response = openai_client.chat.completions.create(
                    model=model_name,
                    messages=messages,
                    temperature=0.7,
                    max_tokens=8192
                )
                
                content = response.choices[0].message.content
                return {
                    "content": content,
                    "thinking": "",
                    "has_thinking": False
                }
            
    except Exception as e:
        st.error(f"âŒ AI ì‘ë‹µ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}")
        return {
            "content": f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}",
            "thinking": "",
            "has_thinking": False
        }

def display_reasoning_process(thinking_content, model_name):
    """Reasoning ê³¼ì •ì„ UIì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜"""
    if not thinking_content:
        return
    
    with st.expander("ğŸ§  AIê°€ ì–´ë–»ê²Œ ìƒê°í–ˆëŠ”ì§€ ì‚´í´ë³´ì„¸ìš”", expanded=False):
        st.markdown("### ğŸ’­ AIê°€ ì–´ë–»ê²Œ ìƒê°í–ˆëŠ”ì§€ ì‚´í´ë³´ì„¸ìš”")
        
        # ëª¨ë¸ë³„ ì„¤ëª…
        if model_name.startswith('claude-opus-4'):
            st.info("ğŸ”¥ **Claude 4 Opus**: ìµœê³  ìˆ˜ì¤€ì˜ reasoning ê³¼ì •ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.")
        elif model_name.startswith('claude-sonnet-4'):
            st.info("ğŸ§  **Claude 4 Sonnet**: ê³ ê¸‰ reasoning ê³¼ì •ì„ ë‹¨ê³„ë³„ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤.")
        elif model_name.startswith('claude-3-7'):
            st.info("âœ¨ **Claude 3.7 Sonnet**: Extended Thinkingìœ¼ë¡œ ì‹¬ì¸µ ë¶„ì„ ê³¼ì •ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.")
        elif model_name.startswith('o1'):
            st.info("ğŸ¤– **OpenAI o1**: ë‚´ë¶€ reasoning ê³¼ì •ì„ ê±°ì³ ë‹µë³€ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤.")
        
        # ì‚¬ê³  ê³¼ì • í‘œì‹œ
        st.markdown("**ğŸ” ì‚¬ê³  ê³¼ì •:**")
        
        # ê¸´ thinking ë‚´ìš©ì„ ë‹¨ê³„ë³„ë¡œ ë‚˜ëˆ„ì–´ í‘œì‹œ
        if len(thinking_content) > 1000:
            # ê¸´ ë‚´ìš©ì˜ ê²½ìš° ì ‘ì„ ìˆ˜ ìˆê²Œ ë§Œë“¤ê¸°
            with st.expander("ì „ì²´ ì‚¬ê³  ê³¼ì • ë³´ê¸°", expanded=False):
                st.text_area(
                    "ìƒì„¸í•œ ì‚¬ê³  ê³¼ì •",
                    value=thinking_content,
                    height=300,
                    disabled=True
                )
            
            # ìš”ì•½ëœ ì²« ë¶€ë¶„ë§Œ ë¯¸ë¦¬ë³´ê¸°ë¡œ í‘œì‹œ
            preview = thinking_content[:500] + "..." if len(thinking_content) > 500 else thinking_content
            st.markdown(f"```\n{preview}\n```")
        else:
            st.markdown(f"```\n{thinking_content}\n```")

def save_conversation(user_query, assistant_response, model_name, rag_sources_used, reasoning_content="", session_title=None, tags=None, notes=None):
    """ëŒ€í™” ë‚´ìš©ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥"""
    try:
        connection = connect_to_db()
        if not connection:
            return None
        
        cursor = connection.cursor()
        
        # ê¸°ë³¸ ì œëª© ìƒì„±
        if not session_title:
            session_title = user_query[:50] + "..." if len(user_query) > 50 else user_query
        
        # ë©”ì¸ ëŒ€í™” ë ˆì½”ë“œ ì‚½ì…
        cursor.execute("""
            INSERT INTO rag_conversations 
            (session_title, user_query, assistant_response, model_name, has_reasoning, reasoning_content, rag_sources_used, tags, notes)
            VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s)
        """, (
            session_title,
            user_query,
            assistant_response,
            model_name,
            bool(reasoning_content),
            reasoning_content,
            len(rag_sources_used),
            tags,
            notes
        ))
        
        conversation_id = cursor.lastrowid
        
        # RAG ì†ŒìŠ¤ ì •ë³´ ì €ì¥
        for source in rag_sources_used:
            cursor.execute("""
                INSERT INTO rag_conversation_sources 
                (conversation_id, source_type, source_name, source_description, source_details)
                VALUES (%s, %s, %s, %s, %s)
            """, (
                conversation_id,
                source['type'],
                source['name'],
                source['details'],
                json.dumps(source)
            ))
        
        connection.commit()
        cursor.close()
        connection.close()
        
        return conversation_id
        
    except Exception as e:
        st.error(f"ëŒ€í™” ì €ì¥ ì˜¤ë¥˜: {str(e)}")
        return None

def get_conversations(search_term=None, model_name=None, limit=50):
    """ì €ì¥ëœ ëŒ€í™” ëª©ë¡ ì¡°íšŒ"""
    try:
        connection = connect_to_db()
        if not connection:
            return []
        
        cursor = connection.cursor()
        
        query = """
            SELECT id, session_title, user_query, model_name, has_reasoning, 
                   rag_sources_used, created_at, tags, notes
            FROM rag_conversations
            WHERE 1=1
        """
        params = []
        
        if search_term:
            query += " AND (session_title LIKE %s OR user_query LIKE %s OR tags LIKE %s)"
            search_pattern = f"%{search_term}%"
            params.extend([search_pattern, search_pattern, search_pattern])
        
        if model_name:
            query += " AND model_name = %s"
            params.append(model_name)
        
        query += " ORDER BY created_at DESC LIMIT %s"
        params.append(limit)
        
        cursor.execute(query, params)
        conversations = cursor.fetchall()
        
        cursor.close()
        connection.close()
        
        return conversations
        
    except Exception as e:
        st.error(f"ëŒ€í™” ì¡°íšŒ ì˜¤ë¥˜: {str(e)}")
        return []

def get_conversation_detail(conversation_id):
    """íŠ¹ì • ëŒ€í™”ì˜ ìƒì„¸ ì •ë³´ ì¡°íšŒ"""
    try:
        connection = connect_to_db()
        if not connection:
            return None
        
        cursor = connection.cursor()
        
        # ë©”ì¸ ëŒ€í™” ì •ë³´ ì¡°íšŒ
        cursor.execute("""
            SELECT * FROM rag_conversations WHERE id = %s
        """, (conversation_id,))
        
        conversation = cursor.fetchone()
        if not conversation:
            return None
        
        # RAG ì†ŒìŠ¤ ì •ë³´ ì¡°íšŒ
        cursor.execute("""
            SELECT * FROM rag_conversation_sources WHERE conversation_id = %s
        """, (conversation_id,))
        
        sources = cursor.fetchall()
        
        cursor.close()
        connection.close()
        
        return {
            'conversation': conversation,
            'sources': sources
        }
        
    except Exception as e:
        st.error(f"ëŒ€í™” ìƒì„¸ ì¡°íšŒ ì˜¤ë¥˜: {str(e)}")
        return None

def delete_rag_conversation(conversation_id):
    """RAG ëŒ€í™” ê¸°ë¡ ì‚­ì œ (CASCADEë¡œ ê´€ë ¨ ë°ì´í„° ëª¨ë‘ ì‚­ì œ)"""
    try:
        connection = connect_to_db()
        if not connection:
            return False
        
        cursor = connection.cursor()
        
        # ë©”ì¸ ëŒ€í™” ì‚­ì œ (CASCADEë¡œ ê´€ë ¨ í…Œì´ë¸”ë„ ìë™ ì‚­ì œ)
        sql = "DELETE FROM rag_conversations WHERE id = %s"
        cursor.execute(sql, (conversation_id,))
        
        deleted_rows = cursor.rowcount
        connection.commit()
        cursor.close()
        connection.close()
        
        return deleted_rows > 0
        
    except Exception as e:
        st.error(f"ëŒ€í™” ì‚­ì œ ì¤‘ ì˜¤ë¥˜: {str(e)}")
        return False

def update_rag_conversation(conversation_id, session_title=None, tags=None, notes=None):
    """RAG ëŒ€í™” ê¸°ë¡ ì—…ë°ì´íŠ¸ (ì œëª©, íƒœê·¸, ë©”ëª¨)"""
    try:
        connection = connect_to_db()
        if not connection:
            return False
        
        cursor = connection.cursor()
        
        update_fields = []
        params = []
        
        if session_title is not None:
            update_fields.append("session_title = %s")
            params.append(session_title)
        
        if tags is not None:
            update_fields.append("tags = %s")
            params.append(tags)
        
        if notes is not None:
            update_fields.append("notes = %s")
            params.append(notes)
        
        if not update_fields:
            return False
        
        # updated_at í•„ë“œë„ í•¨ê»˜ ì—…ë°ì´íŠ¸
        update_fields.append("updated_at = NOW()")
        
        sql = f"UPDATE rag_conversations SET {', '.join(update_fields)} WHERE id = %s"
        params.append(conversation_id)
        
        cursor.execute(sql, params)
        updated_rows = cursor.rowcount
        
        connection.commit()
        cursor.close()
        connection.close()
        
        return updated_rows > 0
        
    except Exception as e:
        st.error(f"ëŒ€í™” ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜: {str(e)}")
        return False

# í…Œì´ë¸” ìë™ ìƒì„±
create_rag_agent_tables()

# AI ëª¨ë¸ ì„¤ì • ë° ë³€ìˆ˜ ì •ì˜ (ì‚¬ì´ë“œë°”ë³´ë‹¤ ë¨¼ì € ì •ì˜)
available_models = []
reasoning_models = []  # reasoning ê°€ëŠ¥í•œ ëª¨ë¸ ì¶”ì 

has_anthropic_key = os.environ.get('ANTHROPIC_API_KEY') is not None
if has_anthropic_key:
    claude_models = [
        'claude-3-7-sonnet-latest',
        'claude-3-5-sonnet-latest',
        'claude-3-opus-latest',
    ]
    available_models.extend(claude_models)
    # Claude 3.7ê³¼ 3.5-sonnet-latestëŠ” reasoning ì§€ì›
    reasoning_models.extend(['claude-3-7-sonnet-latest', 'claude-3-5-sonnet-latest'])

has_openai_key = os.environ.get('OPENAI_API_KEY') is not None
if has_openai_key:
    openai_models = ['gpt-4o', 'gpt-4o-mini', 'o1-preview', 'o1-mini']
    available_models.extend(openai_models)
    # o1 ëª¨ë¸ë“¤ì€ reasoning ì§€ì›
    reasoning_models.extend(['o1-preview', 'o1-mini'])

if not available_models:
    available_models = ['claude-3-7-sonnet-latest']  # ê¸°ë³¸ê°’
    reasoning_models = ['claude-3-7-sonnet-latest']

# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
if 'mysql_data' not in st.session_state:
    st.session_state.mysql_data = None
if 'website_data' not in st.session_state:
    st.session_state.website_data = None
if 'files_data' not in st.session_state:
    st.session_state.files_data = None
if 'sidebar_selected_model' not in st.session_state:
    st.session_state.sidebar_selected_model = available_models[0]
if 'enable_sidebar_reasoning' not in st.session_state:
    st.session_state.enable_sidebar_reasoning = True if available_models[0] in reasoning_models else False

# ë©”ì¸ ì¸í„°í˜ì´ìŠ¤
tab1, tab2, tab3 = st.tabs(["ğŸ¤– RAG ì±„íŒ…", "ğŸ“Š RAG ì†ŒìŠ¤ ìƒíƒœ ë° ê´€ë¦¬", "ğŸ“ ëŒ€í™” ê¸°ë¡"])

with tab1:
    st.header("ğŸ¤– RAG ê¸°ë°˜ AI ì±„íŒ…")
    
    # í˜„ì¬ ì„¤ì • ìƒíƒœ í‘œì‹œ (ê°œì„ ëœ ë²„ì „)
    col1, col2 = st.columns([2, 1])
    
    with col1:
        if st.session_state.enable_sidebar_reasoning:
            st.success(f"ğŸ§  **{st.session_state.sidebar_selected_model}** | âœ¨ **Reasoning í™œì„±í™”ë¨**")
        else:
            st.info(f"ğŸ¤– **{st.session_state.sidebar_selected_model}** | âšª **Reasoning ë¹„í™œì„±í™”ë¨**")
    
    with col2:
        if st.session_state.enable_sidebar_reasoning:
            st.markdown("**ğŸ” ì‚¬ê³  ê³¼ì • í‘œì‹œ ì˜ˆì •**")
        else:
            st.markdown("**âš¡ ë¹ ë¥¸ ì‘ë‹µ ëª¨ë“œ**")
    
    # RAG ì»¨í…ìŠ¤íŠ¸ ìš”ì•½ í‘œì‹œ
    if st.session_state.mysql_data or st.session_state.website_data or st.session_state.files_data:
        st.success("ğŸ“š RAG ì»¨í…ìŠ¤íŠ¸ í™œì„±í™”ë¨")
        
        col1, col2, col3 = st.columns(3)
        with col1:
            if st.session_state.mysql_data:
                st.metric("MySQL í…Œì´ë¸”", len(st.session_state.mysql_data))
        with col2:
            if st.session_state.website_data:
                st.metric("ì›¹í˜ì´ì§€", len(st.session_state.website_data))
        with col3:
            if st.session_state.files_data:
                st.metric("ë¬¸ì„œ íŒŒì¼", len(st.session_state.files_data))
    else:
        st.warning("âš ï¸ RAG ì†ŒìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. ì‚¬ì´ë“œë°”ì—ì„œ ë°ì´í„°ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.")
        
        # ë””ë²„ê·¸ ì •ë³´ ì¶”ê°€
        with st.expander("ğŸ” ë””ë²„ê·¸ ì •ë³´", expanded=False):
            st.write("**ì„¸ì…˜ ìƒíƒœ í™•ì¸:**")
            st.write(f"- MySQL ë°ì´í„°: {st.session_state.mysql_data is not None} ({type(st.session_state.mysql_data)})")
            st.write(f"- ì›¹ì‚¬ì´íŠ¸ ë°ì´í„°: {st.session_state.website_data is not None} ({type(st.session_state.website_data)})")
            st.write(f"- íŒŒì¼ ë°ì´í„°: {st.session_state.files_data is not None} ({type(st.session_state.files_data)})")
            
            if st.session_state.website_data:
                st.write(f"- ì›¹ì‚¬ì´íŠ¸ ë°ì´í„° ê¸¸ì´: {len(st.session_state.website_data)}")
                st.write(f"- ì›¹ì‚¬ì´íŠ¸ ë°ì´í„° ë‚´ìš©: {st.session_state.website_data}")
            
            if st.button("ğŸ”„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨", key="debug_refresh"):
                st.rerun()
    
    # ì§ˆë¬¸ ì…ë ¥
    user_query = st.text_area("ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”:", height=100, placeholder="RAG ë°ì´í„°ë¥¼ í™œìš©í•œ ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”...")
    
    # ì§ˆë¬¸í•˜ê¸° ë²„íŠ¼ë§Œ ì»¬ëŸ¼ì— ë°°ì¹˜
    col1, col2 = st.columns([1, 4])
    with col1:
        submit_button = st.button("ğŸ’¬ ì§ˆë¬¸í•˜ê¸°", type="primary")
    with col2:
        st.empty()  # ì˜¤ë¥¸ìª½ ê³µê°„ì€ ë¹„ì›Œë‘ 
    
    # AI ì‘ë‹µ ì²˜ë¦¬ëŠ” ì „ì²´ í™”ë©´ í­ ì‚¬ìš©
    if submit_button:
        if user_query.strip():
            # Reasoning ëª¨ë¸ì¼ ë•Œ íŠ¹ë³„í•œ ìŠ¤í”¼ë„ˆ ë©”ì‹œì§€
            if st.session_state.enable_sidebar_reasoning:
                spinner_message = f"ğŸ§  {st.session_state.sidebar_selected_model}ê°€ ë‹¨ê³„ë³„ë¡œ ì‚¬ê³ í•˜ê³  ìˆìŠµë‹ˆë‹¤..."
            else:
                spinner_message = "AIê°€ ìƒê° ì¤‘ì…ë‹ˆë‹¤..."
            
            with st.spinner(spinner_message):
                start_time = time.time()
                
                # RAG ì»¨í…ìŠ¤íŠ¸ ìƒì„±
                rag_context, rag_sources_used = create_rag_context(
                    mysql_data=st.session_state.mysql_data,
                    website_data=st.session_state.website_data,
                    files_data=st.session_state.files_data
                )
                
                # ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ êµ¬ì„±
                system_prompt = """
ë‹¹ì‹ ì€ RAG(Retrieval-Augmented Generation) ê¸°ë°˜ AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.
ì œê³µëœ ì»¨í…ìŠ¤íŠ¸ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì •í™•í•˜ê³  ìœ ìš©í•œ ë‹µë³€ì„ ì œê³µí•´ì£¼ì„¸ìš”.

ë‹µë³€ ì‹œ ë‹¤ìŒì„ ê³ ë ¤í•´ì£¼ì„¸ìš”:
1. ì œê³µëœ ë°ì´í„°ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì°¸ì¡°í•˜ì—¬ ë‹µë³€
2. ë°ì´í„°ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ëŠ” ì •ë³´ëŠ” ëª…í™•íˆ êµ¬ë¶„
3. ì‹¤í–‰ ê°€ëŠ¥í•œ ì œì•ˆê³¼ ì¸ì‚¬ì´íŠ¸ í¬í•¨
4. í•„ìš”ì‹œ ë°ì´í„°ì˜ í•œê³„ì ë„ ì–¸ê¸‰
"""
                
                # í”„ë¡¬í”„íŠ¸ êµ¬ì„±
                if rag_context.strip():
                    full_prompt = f"""
ë‹¤ìŒ ì»¨í…ìŠ¤íŠ¸ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì§ˆë¬¸ì— ë‹µë³€í•´ì£¼ì„¸ìš”:

{rag_context}

ì§ˆë¬¸: {user_query}
"""
                else:
                    full_prompt = f"""
ì§ˆë¬¸: {user_query}

ì£¼ì˜: í˜„ì¬ RAG ì»¨í…ìŠ¤íŠ¸ê°€ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì¼ë°˜ì ì¸ ì§€ì‹ì„ ë°”íƒ•ìœ¼ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”.
"""
                
                # Reasoning ì§„í–‰ ìƒíƒœ í‘œì‹œ
                if st.session_state.enable_sidebar_reasoning:
                    progress_placeholder = st.empty()
                    progress_placeholder.info("ğŸ§  AIê°€ ë‹¨ê³„ë³„ ì‚¬ê³ ë¥¼ ì§„í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.")
                
                # AI ì‘ë‹µ ìƒì„± (ì‚¬ì´ë“œë°” ì„¤ì •ê°’ ì‚¬ìš©)
                response = get_ai_response(
                    prompt=full_prompt,
                    model_name=st.session_state.sidebar_selected_model,
                    system_prompt=system_prompt,
                    enable_thinking=st.session_state.enable_sidebar_reasoning
                )
                
                # ì§„í–‰ ìƒíƒœ ì œê±°
                if st.session_state.enable_sidebar_reasoning:
                    progress_placeholder.empty()
                
                execution_time = time.time() - start_time
            
            # ì‘ë‹µ í‘œì‹œ (ì „ì²´ í™”ë©´ í­ ì‚¬ìš©)
            st.markdown("### ğŸ¤– AI ì‘ë‹µ")
            st.markdown(response["content"])
            
            # Reasoning ê³¼ì • í‘œì‹œ (ê°œì„ ëœ ë²„ì „)
            if response.get("has_thinking") and response.get("thinking"):
                # Reasoningì´ ì‹¤ì œë¡œ ì‘ë™í–ˆìŒì„ ê°•ì¡°
                st.success("âœ… Reasoning ê³¼ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
                
                # í™•ì¥ëœ Reasoning í‘œì‹œ
                with st.expander("ğŸ§  AIì˜ ë‹¨ê³„ë³„ ì‚¬ê³  ê³¼ì • ë³´ê¸°", expanded=True):
                    
                    # ëª¨ë¸ë³„ Reasoning íŠ¹ì§• ì„¤ëª…
                    if st.session_state.sidebar_selected_model.startswith('claude-3-7'):
                        st.info("ğŸ”¥ **Claude 3.7 Extended Thinking**: ì´ ëª¨ë¸ì€ ë³µì¡í•œ ë¬¸ì œë¥¼ ì—¬ëŸ¬ ë‹¨ê³„ë¡œ ë‚˜ëˆ„ì–´ ì‹¬ì¸µì ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.")
                    elif st.session_state.sidebar_selected_model == 'claude-3-5-sonnet-latest':
                        st.info("âš¡ **Claude 3.5 Reasoning**: íš¨ìœ¨ì ì´ë©´ì„œë„ ì •í™•í•œ ë‹¨ê³„ë³„ ì‚¬ê³  ê³¼ì •ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.")
                    elif st.session_state.sidebar_selected_model.startswith('o1'):
                        st.info("ğŸ¤– **OpenAI o1 Reasoning**: ê³ ë„ë¡œ ìµœì í™”ëœ ë‚´ë¶€ ì¶”ë¡  ê³¼ì •ì„ ê±°ì³ ë‹µë³€ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤.")
                    
                    st.markdown("---")
                    
                    # Reasoning ë‚´ìš© í‘œì‹œ
                    reasoning_content = response["thinking"]
                    
                    # ê¸´ thinking ë‚´ìš©ì„ ë‹¨ê³„ë³„ë¡œ ë‚˜ëˆ„ì–´ í‘œì‹œ
                    if len(reasoning_content) > 1000:
                        # ë¯¸ë¦¬ë³´ê¸°ì™€ ì „ì²´ ë‚´ìš©ì„ ë¶„ë¦¬
                        col1, col2 = st.columns([1, 1])
                        
                        with col1:
                            st.markdown("**ğŸ” ì‚¬ê³  ê³¼ì • ë¯¸ë¦¬ë³´ê¸° (ì²˜ìŒ 500ì):**")
                            preview = reasoning_content[:500] + "..."
                            st.markdown(f"```\n{preview}\n```")
                        
                        with col2:
                            st.markdown("**ğŸ“Š Reasoning í†µê³„:**")
                            st.metric("ì´ ì‚¬ê³  ê¸¸ì´", f"{len(reasoning_content):,}ì")
                            st.metric("ì˜ˆìƒ ì½ê¸° ì‹œê°„", f"{len(reasoning_content)//200:.1f}ë¶„")
                        
                        # ì „ì²´ ë‚´ìš©ì„ ì ‘ì„ ìˆ˜ ìˆê²Œ ë§Œë“¤ê¸°
                        show_full_reasoning = st.checkbox(
                            f"ğŸ“– ì „ì²´ ì‚¬ê³  ê³¼ì • ë³´ê¸° ({len(reasoning_content):,}ì)",
                            key=f"show_reasoning_{conv[0]}"
                        )
                        
                        if show_full_reasoning:
                            st.text_area(
                                "ìƒì„¸í•œ ì‚¬ê³  ê³¼ì •",
                                value=reasoning_content,
                                height=400,
                                disabled=True,
                                key=f"reasoning_{conv[0]}"
                            )
                    else:
                        st.markdown("**ğŸ” ì‚¬ê³  ê³¼ì •:**")
                        st.text(reasoning_content)
                
                # Reasoning í’ˆì§ˆ í‰ê°€
                st.markdown("---")
                st.markdown("**ğŸ’¡ ì´ Reasoning ê³¼ì •ì˜ íŠ¹ì§•:**")
                
                reasoning_length = len(reasoning_content)
                if reasoning_length > 2000:
                    st.success("ğŸ”¥ **ì‹¬ì¸µ ë¶„ì„**: ë§¤ìš° ìƒì„¸í•œ ì‚¬ê³  ê³¼ì •ì„ ê±°ì³¤ìŠµë‹ˆë‹¤.")
                elif reasoning_length > 1000:
                    st.info("ğŸ“ **ì¤‘ê°„ ë¶„ì„**: ì ì ˆí•œ ìˆ˜ì¤€ì˜ ì‚¬ê³  ê³¼ì •ì„ ê±°ì³¤ìŠµë‹ˆë‹¤.")
                else:
                    st.warning("âš¡ **ê°„ë‹¨ ë¶„ì„**: ë¹ ë¥¸ ì‚¬ê³  ê³¼ì •ì„ ê±°ì³¤ìŠµë‹ˆë‹¤.")
                
            elif st.session_state.enable_sidebar_reasoning:
                # Reasoningì´ í™œì„±í™”ë˜ì—ˆì§€ë§Œ ë‚´ìš©ì´ ì—†ëŠ” ê²½ìš°
                st.warning("âš ï¸ Reasoningì´ í™œì„±í™”ë˜ì—ˆì§€ë§Œ ì‚¬ê³  ê³¼ì •ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì—ˆìŠµë‹ˆë‹¤.")
                st.info("ğŸ’¡ ì´ëŠ” ì¼ì‹œì ì¸ ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”.")
            
            # RAG ì†ŒìŠ¤ ì •ë³´ í‘œì‹œ
            if rag_sources_used:
                with st.expander("ğŸ“š ì‚¬ìš©ëœ RAG ì†ŒìŠ¤", expanded=False):
                    for source in rag_sources_used:
                        st.write(f"**{source['type'].upper()}**: {source['name']} - {source['details']}")
            
            # ì‹¤í–‰ ì‹œê°„ í‘œì‹œ (Reasoning ì—¬ë¶€ì— ë”°ë¼ ë‹¤ë¥¸ ë©”ì‹œì§€)
            if st.session_state.enable_sidebar_reasoning:
                st.caption(f"ğŸ§  Reasoning í¬í•¨ ì‘ë‹µ ìƒì„± ì‹œê°„: {execution_time:.2f}ì´ˆ")
            else:
                st.caption(f"â±ï¸ ì‘ë‹µ ìƒì„± ì‹œê°„: {execution_time:.2f}ì´ˆ")
            
            # ëŒ€í™” ì €ì¥
            conversation_id = save_conversation(
                user_query=user_query,
                assistant_response=response["content"],
                model_name=st.session_state.sidebar_selected_model,
                rag_sources_used=rag_sources_used,
                reasoning_content=response.get("thinking", "")
            )
            
            if conversation_id:
                st.success(f"âœ… ëŒ€í™”ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ (ID: {conversation_id})")
        else:
            st.warning("ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")

with tab2:
    st.header("ğŸ“Š RAG ì†ŒìŠ¤ ìƒíƒœ ë° ê´€ë¦¬")
    
    # ì „ì²´ RAG ì†ŒìŠ¤ ìƒíƒœ ìš”ì•½
    st.subheader("ğŸ“‹ í˜„ì¬ RAG ì†ŒìŠ¤ ìƒíƒœ")
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.markdown("### ğŸ—„ï¸ MySQL ë°ì´í„°ë² ì´ìŠ¤")
        if st.session_state.mysql_data:
            st.success("âœ… í™œì„±í™”ë¨")
            total_rows = sum(len(df) for df in st.session_state.mysql_data.values())
            st.metric("í…Œì´ë¸” ìˆ˜", len(st.session_state.mysql_data))
            st.metric("ì´ ë°ì´í„° í–‰", f"{total_rows:,}")
            
            # í…Œì´ë¸”ë³„ ìƒì„¸ ì •ë³´
            with st.expander("í…Œì´ë¸” ìƒì„¸ ì •ë³´"):
                for table_name, df in st.session_state.mysql_data.items():
                    st.write(f"**{table_name}**: {len(df):,}í–‰, {len(df.columns)}ê°œ ì»¬ëŸ¼")
                    st.write(f"ì»¬ëŸ¼: {', '.join(df.columns.tolist()[:5])}{'...' if len(df.columns) > 5 else ''}")
        else:
            st.warning("âŒ ë¹„í™œì„±í™”")
            st.info("ì‚¬ì´ë“œë°”ì—ì„œ MySQL ì„¤ì •ì„ ì§„í–‰í•˜ì„¸ìš”.")
    
    with col2:
        st.markdown("### ğŸŒ ì›¹ì‚¬ì´íŠ¸ ë°ì´í„°")
        if st.session_state.website_data:
            st.success("âœ… í™œì„±í™”ë¨")
            st.metric("í˜ì´ì§€ ìˆ˜", len(st.session_state.website_data))
            
            # ì›¹ì‚¬ì´íŠ¸ ìƒì„¸ ì •ë³´
            with st.expander("í˜ì´ì§€ ìƒì„¸ ì •ë³´"):
                for i, page in enumerate(st.session_state.website_data):
                    st.write(f"**í˜ì´ì§€ {i+1}**: {page['title'][:50]}...")
                    st.write(f"URL: {page['url']}")
                    st.write(f"ì½˜í…ì¸  ê¸¸ì´: {len(page['content']):,}ì")
        else:
            st.warning("âŒ ë¹„í™œì„±í™”")
            st.info("ì‚¬ì´ë“œë°”ì—ì„œ ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ì„ ì§„í–‰í•˜ì„¸ìš”.")
    
    with col3:
        st.markdown("### ğŸ“„ ë¬¸ì„œ íŒŒì¼")
        if st.session_state.files_data:
            st.success("âœ… í™œì„±í™”ë¨")
            total_size = sum(f['size'] for f in st.session_state.files_data)
            st.metric("íŒŒì¼ ìˆ˜", len(st.session_state.files_data))
            st.metric("ì´ í¬ê¸°", f"{total_size:,}ì")
            
            # íŒŒì¼ ìƒì„¸ ì •ë³´
            with st.expander("íŒŒì¼ ìƒì„¸ ì •ë³´"):
                for file_data in st.session_state.files_data:
                    st.write(f"**{file_data['name']}**: {file_data['size']:,}ì")
        else:
            st.warning("âŒ ë¹„í™œì„±í™”")
            st.info("ì‚¬ì´ë“œë°”ì—ì„œ íŒŒì¼ ì—…ë¡œë“œë¥¼ ì§„í–‰í•˜ì„¸ìš”.")
    
    st.divider()
    
    # RAG ì»¨í…ìŠ¤íŠ¸ ë¯¸ë¦¬ë³´ê¸°
    if st.session_state.mysql_data or st.session_state.website_data or st.session_state.files_data:
        st.subheader("ğŸ” RAG ì»¨í…ìŠ¤íŠ¸ ë¯¸ë¦¬ë³´ê¸°")
        
        if st.button("ğŸ“ ì „ì²´ RAG ì»¨í…ìŠ¤íŠ¸ ìƒì„± ë° ë¯¸ë¦¬ë³´ê¸°"):
            with st.spinner("RAG ì»¨í…ìŠ¤íŠ¸ ìƒì„± ì¤‘..."):
                rag_context, rag_sources = create_rag_context(
                    mysql_data=st.session_state.mysql_data,
                    website_data=st.session_state.website_data,
                    files_data=st.session_state.files_data
                )
                
                st.markdown("**ğŸ“Š RAG ì†ŒìŠ¤ ìš”ì•½:**")
                for source in rag_sources:
                    st.write(f"- **{source['type'].upper()}**: {source['name']} ({source['details']})")
                
                st.markdown("**ğŸ“„ RAG ì»¨í…ìŠ¤íŠ¸ ë‚´ìš© (ì²˜ìŒ 1000ì):**")
                preview_text = rag_context[:1000] + "..." if len(rag_context) > 1000 else rag_context
                st.text_area("RAG ì»¨í…ìŠ¤íŠ¸", value=preview_text, height=200, disabled=True)
                
                st.info(f"ğŸ’¡ ì „ì²´ ì»¨í…ìŠ¤íŠ¸ í¬ê¸°: {len(rag_context):,}ì")
    
    st.divider()
    
    # ë¹ ë¥¸ ê´€ë¦¬ ë„êµ¬
    st.subheader("ğŸ”§ ë¹ ë¥¸ ê´€ë¦¬ ë„êµ¬")
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        if st.button("ğŸ”„ ëª¨ë“  RAG ì†ŒìŠ¤ ìƒˆë¡œê³ ì¹¨", help="í˜„ì¬ ì„¤ì •ìœ¼ë¡œ ëª¨ë“  RAG ì†ŒìŠ¤ë¥¼ ë‹¤ì‹œ ë¡œë“œí•©ë‹ˆë‹¤"):
            st.info("ì‚¬ì´ë“œë°”ì—ì„œ ê° ì†ŒìŠ¤ë³„ë¡œ ë‹¤ì‹œ ë¡œë“œí•´ì£¼ì„¸ìš”.")
    
    with col2:
        if st.button("ğŸ“Š RAG ì„±ëŠ¥ í†µê³„", help="RAG ì‚¬ìš© í†µê³„ë¥¼ í™•ì¸í•©ë‹ˆë‹¤"):
            # ê°„ë‹¨í•œ í†µê³„ í‘œì‹œ
            total_sources = 0
            total_data_size = 0
            
            if st.session_state.mysql_data:
                total_sources += 1
                total_data_size += sum(len(df) for df in st.session_state.mysql_data.values())
            
            if st.session_state.website_data:
                total_sources += 1
                total_data_size += len(st.session_state.website_data)
            
            if st.session_state.files_data:
                total_sources += 1
                total_data_size += sum(f['size'] for f in st.session_state.files_data)
            
            st.success(f"ğŸ“ˆ í™œì„± ì†ŒìŠ¤: {total_sources}ê°œ | ì´ ë°ì´í„° í¬ê¸°: {total_data_size:,}")
    
    with col3:
        if st.button("ğŸ—‘ï¸ ì „ì²´ ì´ˆê¸°í™”", type="secondary", help="ëª¨ë“  RAG ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤"):
            if st.button("âš ï¸ ì •ë§ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", key="confirm_reset"):
                st.session_state.mysql_data = None
                st.session_state.website_data = None  
                st.session_state.files_data = None
                if 'available_tables' in st.session_state:
                    del st.session_state.available_tables
                st.success("âœ… ëª¨ë“  RAG ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.")
                st.rerun()
    
    # ì‚¬ìš© ê°€ì´ë“œ
    st.divider()
    st.subheader("ğŸ’¡ RAG ì†ŒìŠ¤ ì„¤ì • ê°€ì´ë“œ")
    
    with st.expander("ğŸ“– ìì„¸í•œ ì‚¬ìš©ë²•", expanded=False):
        st.markdown("""
        ### ğŸ—„ï¸ MySQL ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
        1. ì‚¬ì´ë“œë°”ì˜ "MySQL ë°ì´í„°ë² ì´ìŠ¤" ì„¹ì…˜ í´ë¦­
        2. "DB ì—°ê²° í…ŒìŠ¤íŠ¸"ë¡œ ì—°ê²° í™•ì¸
        3. "í…Œì´ë¸” ëª©ë¡ ì¡°íšŒ"ë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ í…Œì´ë¸” í™•ì¸
        4. ì›í•˜ëŠ” í…Œì´ë¸” ì„ íƒ í›„ "ì„ íƒëœ í…Œì´ë¸” ë¡œë“œ" í´ë¦­
        
        ### ğŸŒ ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ì„¤ì •
        1. ì‚¬ì´ë“œë°”ì˜ "ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§" ì„¹ì…˜ í´ë¦­
        2. í¬ë¡¤ë§í•  ì›¹ì‚¬ì´íŠ¸ URL ì…ë ¥
        3. ìµœëŒ€ í˜ì´ì§€ ìˆ˜ ì„¤ì • (1-10)
        4. "ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ì‹œì‘" í´ë¦­
        
        ### ğŸ“„ ë¬¸ì„œ íŒŒì¼ ì—…ë¡œë“œ
        1. ì‚¬ì´ë“œë°”ì˜ "ë¬¸ì„œ íŒŒì¼" ì„¹ì…˜ í´ë¦­
        2. TXT, PDF, DOCX, MD íŒŒì¼ ì„ íƒ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)
        3. "íŒŒì¼ ì²˜ë¦¬" í´ë¦­í•˜ì—¬ ë‚´ìš© ë¶„ì„
        
        ### ğŸ’¡ íŒ
        - ì—¬ëŸ¬ RAG ì†ŒìŠ¤ë¥¼ ì¡°í•©í•˜ë©´ ë” í’ë¶€í•œ ë‹µë³€ì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤
        - ë„ˆë¬´ ë§ì€ ë°ì´í„°ë¥¼ ë¡œë“œí•˜ë©´ ì‘ë‹µ ì†ë„ê°€ ëŠë ¤ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤
        - RAG ì»¨í…ìŠ¤íŠ¸ ë¯¸ë¦¬ë³´ê¸°ë¡œ ë°ì´í„° í’ˆì§ˆì„ í™•ì¸í•´ë³´ì„¸ìš”
        """)
    
    # í˜„ì¬ ì„¤ì • ìš”ì•½
    if not (st.session_state.mysql_data or st.session_state.website_data or st.session_state.files_data):
        st.warning("âš ï¸ í˜„ì¬ í™œì„±í™”ëœ RAG ì†ŒìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. ì‚¬ì´ë“œë°”ì—ì„œ ë°ì´í„°ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.")
        st.info("ğŸ’¡ RAG ì†ŒìŠ¤ë¥¼ ì¶”ê°€í•˜ë©´ AIê°€ í•´ë‹¹ ë°ì´í„°ë¥¼ ì°¸ì¡°í•˜ì—¬ ë” ì •í™•í•˜ê³  ë§ì¶¤í˜• ë‹µë³€ì„ ì œê³µí•©ë‹ˆë‹¤.")

with tab3:
    st.header("ğŸ“ ëŒ€í™” ê¸°ë¡ ê´€ë¦¬")
    
    # ìƒˆë¡œìš´ ê¸°ëŠ¥ ì•ˆë‚´
    st.info("ğŸ’¡ **ìƒˆë¡œìš´ ê¸°ëŠ¥**: ì´ì œ ê° ëŒ€í™” ê¸°ë¡ì„ í¸ì§‘í•˜ê±°ë‚˜ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤! âœï¸í¸ì§‘ ë²„íŠ¼ìœ¼ë¡œ ì œëª©, íƒœê·¸, ë©”ëª¨ë¥¼ ìˆ˜ì •í•˜ê³ , ğŸ—‘ï¸ì‚­ì œ ë²„íŠ¼ìœ¼ë¡œ ë¶ˆí•„ìš”í•œ ê¸°ë¡ì„ ì œê±°í•˜ì„¸ìš”.")
    
    # ê²€ìƒ‰ í•„í„°
    col1, col2, col3 = st.columns([2, 1, 1])
    
    with col1:
        search_term = st.text_input("ğŸ” ê²€ìƒ‰ì–´:", placeholder="ì œëª©, ì§ˆë¬¸, íƒœê·¸ë¡œ ê²€ìƒ‰...")
    
    with col2:
        model_filter = st.selectbox("ëª¨ë¸ í•„í„°:", ["ì „ì²´"] + available_models)
        model_filter = None if model_filter == "ì „ì²´" else model_filter
    
    with col3:
        # Reasoning í•„í„° ì¶”ê°€
        reasoning_filter = st.selectbox("Reasoning í•„í„°:", ["ì „ì²´", "Reasoning ìˆìŒ", "Reasoning ì—†ìŒ"])
        limit = st.selectbox("í‘œì‹œ ê°œìˆ˜:", [20, 50, 100], index=1)
    
    # ëŒ€í™” ëª©ë¡ ì¡°íšŒ
    conversations = get_conversations(
        search_term=search_term if search_term else None,
        model_name=model_filter,
        limit=limit
    )
    
    # ë¹ ë¥¸ í•„í„° ì ìš©
    if 'quick_filter' in st.session_state:
        if st.session_state.quick_filter == "recent_10":
            conversations = conversations[:10]
            st.info("ğŸ” ìµœê·¼ 10ê°œ ëŒ€í™”ë§Œ í‘œì‹œ ì¤‘ì…ë‹ˆë‹¤.")
        elif st.session_state.quick_filter == "reasoning_only":
            conversations = [conv for conv in conversations if conv[4]]  # has_reasoning = True
            st.info("ğŸ§  Reasoning ëŒ€í™”ë§Œ í‘œì‹œ ì¤‘ì…ë‹ˆë‹¤.")
    
    # Reasoning í•„í„° ì ìš©
    if reasoning_filter != "ì „ì²´":
        if reasoning_filter == "Reasoning ìˆìŒ":
            conversations = [conv for conv in conversations if conv[4]]  # has_reasoning = True
        else:
            conversations = [conv for conv in conversations if not conv[4]]  # has_reasoning = False
    
    if conversations:
        st.write(f"ğŸ“‹ ì´ {len(conversations)}ê°œì˜ ëŒ€í™” ê¸°ë¡")
        
        for conv in conversations:
            # ì œëª©ì— ë” ìì„¸í•œ ì •ë³´ í‘œì‹œ
            reasoning_emoji = " ğŸ§ ğŸ’­" if conv[4] else ""
            model_emoji = "ğŸ”¥" if conv[3].startswith('claude-3-7') else "âš¡" if conv[3] == 'claude-3-5-sonnet-latest' else "ğŸ¤–" if conv[3].startswith('o1') else "ğŸ¤–"
            
            with st.expander(
                f"{model_emoji} **{conv[3]}** | {conv[1]} | {conv[6].strftime('%Y-%m-%d %H:%M')}{reasoning_emoji}", 
                expanded=False
            ):
                col1, col2 = st.columns([3, 1])
                
                with col1:
                    st.write("**ì§ˆë¬¸:**")
                    st.write(conv[2][:200] + "..." if len(conv[2]) > 200 else conv[2])
                    
                    if conv[8]:  # notes
                        st.write("**ë©”ëª¨:**", conv[8])
                    
                    if conv[7]:  # tags
                        st.write("**íƒœê·¸:**", conv[7])
                
                with col2:
                    st.metric("RAG ì†ŒìŠ¤", conv[5])
                    
                    # Reasoning ìƒíƒœë¥¼ ë” ëª…í™•í•˜ê²Œ í‘œì‹œ
                    if conv[4]:  # has_reasoning
                        if conv[3] in reasoning_models:
                            st.success("ğŸ§  Reasoning ì™„ë£Œ")
                        else:
                            st.info("ğŸ¤– ì¶”ë¡  ê³¼ì • í¬í•¨")
                    else:
                        st.info("âš¡ ì¼ë°˜ ì‘ë‹µ")
                    
                    # í¸ì§‘ ë° ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
                    button_col1, button_col2, button_col3 = st.columns(3)
                    
                    with button_col1:
                        if st.button(f"âœï¸ í¸ì§‘", key=f"edit_{conv[0]}"):
                            st.session_state[f"show_edit_{conv[0]}"] = True
                            st.rerun()
                    
                    with button_col2:
                        if st.button(f"ìì„¸íˆ ë³´ê¸°", key=f"detail_{conv[0]}"):
                            detail = get_conversation_detail(conv[0])
                            if detail:
                                st.session_state[f"show_detail_{conv[0]}"] = True
                                st.rerun()
                    
                    with button_col3:
                        # ì‚­ì œ ë²„íŠ¼ (í™•ì¸ ìƒíƒœê°€ ì•„ë‹ ë•Œë§Œ í‘œì‹œ)
                        delete_key = f"delete_confirm_{conv[0]}"
                        if delete_key not in st.session_state or not st.session_state[delete_key]:
                            if st.button("ğŸ—‘ï¸ ì‚­ì œ", key=f"delete_{conv[0]}", help="ì´ ëŒ€í™”ë¥¼ ì˜êµ¬ ì‚­ì œí•©ë‹ˆë‹¤"):
                                st.session_state[delete_key] = True
                                st.rerun()
                
                # ì‚­ì œ í™•ì¸ UI (ì»¬ëŸ¼ ë°–ì—ì„œ í‘œì‹œ)
                delete_key = f"delete_confirm_{conv[0]}"
                if delete_key in st.session_state and st.session_state[delete_key]:
                    st.warning("âš ï¸ ì •ë§ë¡œ ì´ ëŒ€í™”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                    delete_confirm_col1, delete_confirm_col2 = st.columns(2)
                    with delete_confirm_col1:
                        if st.button("âœ… í™•ì¸", key=f"confirm_delete_{conv[0]}", type="primary"):
                            if delete_rag_conversation(conv[0]):
                                st.success("âœ… ëŒ€í™”ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.")
                                # ê´€ë ¨ ì„¸ì…˜ ìƒíƒœ ì •ë¦¬
                                if delete_key in st.session_state:
                                    del st.session_state[delete_key]
                                if f"show_detail_{conv[0]}" in st.session_state:
                                    del st.session_state[f"show_detail_{conv[0]}"]
                                if f"show_edit_{conv[0]}" in st.session_state:
                                    del st.session_state[f"show_edit_{conv[0]}"]
                                st.rerun()
                            else:
                                st.error("âŒ ì‚­ì œ ì‹¤íŒ¨")
                                del st.session_state[delete_key]
                    with delete_confirm_col2:
                        if st.button("âŒ ì·¨ì†Œ", key=f"cancel_delete_{conv[0]}", type="secondary"):
                            del st.session_state[delete_key]
                            st.rerun()
                
                # í¸ì§‘ í¼ í‘œì‹œ
                if st.session_state.get(f"show_edit_{conv[0]}", False):
                    st.markdown("---")
                    st.markdown("### âœï¸ ëŒ€í™” ì •ë³´ í¸ì§‘")
                    
                    edit_col1, edit_col2 = st.columns(2)
                    
                    with edit_col1:
                        new_title = st.text_input(
                            "ìƒˆ ì œëª©", 
                            value=conv[1], 
                            key=f"edit_title_{conv[0]}"
                        )
                        new_tags = st.text_input(
                            "ìƒˆ íƒœê·¸", 
                            value=conv[7] if conv[7] else '', 
                            key=f"edit_tags_{conv[0]}",
                            help="ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ì—¬ ì—¬ëŸ¬ íƒœê·¸ ì…ë ¥ ê°€ëŠ¥"
                        )
                    
                    with edit_col2:
                        new_notes = st.text_area(
                            "ìƒˆ ë©”ëª¨", 
                            value=conv[8] if conv[8] else '', 
                            height=100, 
                            key=f"edit_notes_{conv[0]}"
                        )
                    
                    # í¸ì§‘ ë²„íŠ¼ë“¤ (ì»¬ëŸ¼ ë°–ì—ì„œ í‘œì‹œ)
                    edit_button_col1, edit_button_col2 = st.columns(2)
                    
                    with edit_button_col1:
                        if st.button("ğŸ’¾ ì €ì¥", key=f"save_edit_{conv[0]}", type="primary"):
                            if update_rag_conversation(
                                conv[0],
                                session_title=new_title,
                                tags=new_tags,
                                notes=new_notes
                            ):
                                st.success("âœ… ëŒ€í™” ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.")
                                del st.session_state[f"show_edit_{conv[0]}"]
                                st.rerun()
                            else:
                                st.error("âŒ ìˆ˜ì • ì‹¤íŒ¨")
                    
                    with edit_button_col2:
                        if st.button("âŒ ì·¨ì†Œ", key=f"cancel_edit_{conv[0]}", type="secondary"):
                            del st.session_state[f"show_edit_{conv[0]}"]
                            st.rerun()
                
                # ìƒì„¸ ì •ë³´ í‘œì‹œ
                if st.session_state.get(f"show_detail_{conv[0]}", False):
                    st.markdown("---")
                    detail = get_conversation_detail(conv[0])
                    if detail:
                        st.write("**AI ì‘ë‹µ:**")
                        st.markdown(detail['conversation'][3])  # assistant_response
                        
                        # Reasoning ë‚´ìš© í‘œì‹œ (ê°œì„ ëœ ë²„ì „ - expander ì¤‘ì²© ì œê±°)
                        if detail['conversation'][5]:  # reasoning_content
                            reasoning_content = detail['conversation'][5]
                            
                            # reasoning_contentì˜ ë°ì´í„° íƒ€ì… ì•ˆì „ ì²˜ë¦¬
                            if reasoning_content is not None:
                                # ì •ìˆ˜ë‚˜ ë‹¤ë¥¸ íƒ€ì…ì„ ë¬¸ìì—´ë¡œ ë³€í™˜
                                reasoning_content = str(reasoning_content)
                                
                                # ë¹ˆ ë¬¸ìì—´ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ í‘œì‹œ
                                if reasoning_content.strip():
                                    # ëª¨ë¸ë³„ Reasoning ì„¤ëª…
                                    model_name = detail['conversation'][4]  # model_name
                                    
                                    st.markdown("---")
                                    st.markdown("### ğŸ§  AIì˜ ì‚¬ê³  ê³¼ì •")
                                    
                                    if model_name.startswith('claude-3-7'):
                                        st.info("ğŸ”¥ **Claude 3.7 Extended Thinking** ì‚¬ê³  ê³¼ì •")
                                    elif model_name == 'claude-3-5-sonnet-latest':
                                        st.info("âš¡ **Claude 3.5 Reasoning** ì‚¬ê³  ê³¼ì •")
                                    elif model_name.startswith('o1'):
                                        st.info("ğŸ¤– **OpenAI o1 Reasoning** ì‚¬ê³  ê³¼ì •")
                                    else:
                                        st.info("ğŸ§  **AI ì‚¬ê³  ê³¼ì •**")
                                    
                                    # Reasoning ê¸¸ì´ì— ë”°ë¥¸ í‘œì‹œ ë°©ì‹
                                    if len(reasoning_content) > 1000:
                                        st.markdown(f"**ğŸ“Š ì‚¬ê³  ê³¼ì • í†µê³„**: {len(reasoning_content):,}ì")
                                        
                                        # ì ‘ê¸°/í¼ì¹˜ê¸° ë²„íŠ¼ìœ¼ë¡œ ëŒ€ì²´
                                        show_full_reasoning = st.checkbox(
                                            f"ì „ì²´ ì‚¬ê³  ê³¼ì • ë³´ê¸° ({len(reasoning_content):,}ì)",
                                            key=f"show_reasoning_{conv[0]}"
                                        )
                                        
                                        if show_full_reasoning:
                                            st.text_area(
                                                "ìƒì„¸í•œ ì‚¬ê³  ê³¼ì •",
                                                value=reasoning_content,
                                                height=400,
                                                disabled=True,
                                                key=f"reasoning_{conv[0]}"
                                            )
                                        else:
                                            # ë¯¸ë¦¬ë³´ê¸°ë§Œ í‘œì‹œ
                                            preview = reasoning_content[:300] + "..."
                                            st.markdown(f"```\n{preview}\n```")
                                    else:
                                        st.markdown("**ğŸ” ì‚¬ê³  ê³¼ì •:**")
                                        st.text(reasoning_content)
                        
                        if detail['sources']:
                            st.markdown("---")
                            st.markdown("### ğŸ“š ì‚¬ìš©ëœ RAG ì†ŒìŠ¤")
                            for source in detail['sources']:
                                st.write(f"**{source[2]}** ({source[3]}): {source[4]}")
                    
                    if st.button(f"ë‹«ê¸°", key=f"close_{conv[0]}"):
                        st.session_state[f"show_detail_{conv[0]}"] = False
                        st.rerun()
    else:
        st.info("ì €ì¥ëœ ëŒ€í™” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.")
        
    # ëŒ€í™” ê¸°ë¡ í†µê³„ (ê°œì„ ëœ ë²„ì „)
    st.divider()
    st.subheader("ğŸ“Š ëŒ€í™” ê¸°ë¡ í†µê³„")
    
    if conversations:
        # ê¸°ë³¸ í†µê³„
        model_counts = {}
        reasoning_count = 0
        total_rag_sources = 0
        reasoning_models_used = set()
        
        for conv in conversations:
            model_name = conv[3]
            if model_name in model_counts:
                model_counts[model_name] += 1
            else:
                model_counts[model_name] = 1
                
            if conv[4]:  # has_reasoning
                reasoning_count += 1
                if model_name in reasoning_models:
                    reasoning_models_used.add(model_name)
                
            total_rag_sources += conv[5]  # rag_sources_used
        
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            st.metric("ì´ ëŒ€í™” ìˆ˜", len(conversations))
            
        with col2:
            reasoning_percentage = reasoning_count/len(conversations)*100 if conversations else 0
            st.metric("Reasoning ì‚¬ìš©", f"{reasoning_count}íšŒ", f"{reasoning_percentage:.1f}%")
            
        with col3:
            avg_rag_sources = total_rag_sources / len(conversations) if conversations else 0
            st.metric("í‰ê·  RAG ì†ŒìŠ¤", f"{avg_rag_sources:.1f}ê°œ")
        
        with col4:
            st.metric("Reasoning ëª¨ë¸", f"{len(reasoning_models_used)}ì¢…ë¥˜")
        
        # ëª¨ë¸ë³„ ì‚¬ìš© í˜„í™© (ê°œì„ ëœ ë²„ì „)
        if model_counts:
            st.markdown("**ğŸ§  ëª¨ë¸ë³„ ì‚¬ìš© í˜„í™©:**")
            
            for model, count in sorted(model_counts.items(), key=lambda x: x[1], reverse=True):
                percentage = count / len(conversations) * 100
                
                # ëª¨ë¸ë³„ ì´ëª¨ì§€ ë° íŠ¹ì§•
                if model.startswith('claude-3-7'):
                    model_emoji = "ğŸ”¥"
                    model_feature = "(Extended Thinking)"
                elif model == 'claude-3-5-sonnet-latest':
                    model_emoji = "âš¡"
                    model_feature = "(Fast Reasoning)"
                elif model.startswith('o1'):
                    model_emoji = "ğŸ¤–"
                    model_feature = "(Advanced Reasoning)"
                else:
                    model_emoji = "ğŸ¤–"
                    model_feature = ""
                
                st.write(f"{model_emoji} **{model}** {model_feature}: {count}íšŒ ({percentage:.1f}%)")
        
        # Reasoning í’ˆì§ˆ ë¶„ì„
        if reasoning_count > 0:
            st.markdown("---")
            st.markdown("**ğŸ§  Reasoning í’ˆì§ˆ ë¶„ì„:**")
            
            reasoning_success_rate = reasoning_count / len(conversations) * 100
            
            if reasoning_success_rate > 50:
                st.success(f"âœ… ë†’ì€ Reasoning í™œìš©ë„: {reasoning_success_rate:.1f}%")
            elif reasoning_success_rate > 25:
                st.info(f"ğŸ“ ë³´í†µ Reasoning í™œìš©ë„: {reasoning_success_rate:.1f}%")
            else:
                st.warning(f"âš¡ ë‚®ì€ Reasoning í™œìš©ë„: {reasoning_success_rate:.1f}%")
            
            st.write(f"ğŸ’¡ **ì¶”ì²œ**: Reasoning ì§€ì› ëª¨ë¸({', '.join(reasoning_models)})ì„ í™œìš©í•˜ë©´ ë” ìƒì„¸í•œ ë¶„ì„ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
    
    else:
        st.info("ğŸ“Š ëŒ€í™” ê¸°ë¡ì´ ì—†ì–´ í†µê³„ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    # ê´€ë¦¬ ê¸°ëŠ¥ ì•ˆë‚´ ì¶”ê°€
    st.markdown("---")
    st.markdown("### ğŸ”§ ëŒ€í™” ê¸°ë¡ ê´€ë¦¬ ê¸°ëŠ¥")
    
    with st.expander("ğŸ“– ì‚¬ìš© ê°€ì´ë“œ", expanded=False):
        st.markdown("""
        ### âœï¸ í¸ì§‘ ê¸°ëŠ¥
        - **ì œëª© ìˆ˜ì •**: ëŒ€í™” ì„¸ì…˜ì˜ ì œëª©ì„ ë” ëª…í™•í•˜ê²Œ ë³€ê²½
        - **íƒœê·¸ ì¶”ê°€**: ê²€ìƒ‰ê³¼ ë¶„ë¥˜ë¥¼ ìœ„í•œ íƒœê·¸ ì„¤ì • (ì‰¼í‘œë¡œ êµ¬ë¶„)
        - **ë©”ëª¨ ì‘ì„±**: ëŒ€í™”ì— ëŒ€í•œ ì¶”ê°€ ì„¤ëª…ì´ë‚˜ ë…¸íŠ¸ ê¸°ë¡
        
        ### ğŸ—‘ï¸ ì‚­ì œ ê¸°ëŠ¥
        - **ì•ˆì „í•œ ì‚­ì œ**: ì‚­ì œ ì „ í™•ì¸ ê³¼ì •ì„ ê±°ì³ ì‹¤ìˆ˜ ë°©ì§€
        - **ì™„ì „ ì‚­ì œ**: ëŒ€í™” ë‚´ìš©ê³¼ ê´€ë ¨ RAG ì†ŒìŠ¤ ì •ë³´ê¹Œì§€ ëª¨ë‘ ì‚­ì œ
        - **ë³µêµ¬ ë¶ˆê°€**: ì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìœ¼ë‹ˆ ì‹ ì¤‘í•˜ê²Œ ì„ íƒ
        
        ### ğŸ’¡ í™œìš© íŒ
        - **íƒœê·¸ í™œìš©**: 'business', 'research', 'personal' ë“±ìœ¼ë¡œ ë¶„ë¥˜
        - **ì œëª© ìµœì í™”**: ë‚˜ì¤‘ì— ì°¾ê¸° ì‰¬ìš´ ëª…í™•í•œ ì œëª©ìœ¼ë¡œ ë³€ê²½
        - **ë©”ëª¨ í™œìš©**: ëŒ€í™”ì˜ ëª©ì ì´ë‚˜ ê²°ê³¼ ìš”ì•½ì„ ë©”ëª¨ë¡œ ê¸°ë¡
        - **ì •ê¸° ì •ë¦¬**: ë¶ˆí•„ìš”í•œ í…ŒìŠ¤íŠ¸ ëŒ€í™”ëŠ” ì •ê¸°ì ìœ¼ë¡œ ì‚­ì œ
        """)
    
    # ë¹ ë¥¸ ê´€ë¦¬ ë„êµ¬
    st.markdown("### âš™ï¸ ë¹ ë¥¸ ê´€ë¦¬ ë„êµ¬")
    
    quick_manage_col1, quick_manage_col2, quick_manage_col3 = st.columns(3)
    
    with quick_manage_col1:
        if st.button("ğŸ” ìµœê·¼ ëŒ€í™” 10ê°œ ë³´ê¸°", help="ê°€ì¥ ìµœê·¼ 10ê°œì˜ ëŒ€í™” ê¸°ë¡ì„ í‘œì‹œí•©ë‹ˆë‹¤"):
            st.session_state.quick_filter = "recent_10"
            st.rerun()
    
    with quick_manage_col2:
        if st.button("ğŸ§  Reasoning ëŒ€í™”ë§Œ ë³´ê¸°", help="Reasoning ê³¼ì •ì´ í¬í•¨ëœ ëŒ€í™”ë§Œ í‘œì‹œí•©ë‹ˆë‹¤"):
            st.session_state.quick_filter = "reasoning_only"
            st.rerun()
    
    with quick_manage_col3:
        if st.button("ğŸ”„ í•„í„° ì´ˆê¸°í™”", help="ëª¨ë“  í•„í„°ë¥¼ ì´ˆê¸°í™”í•˜ê³  ì „ì²´ ëŒ€í™”ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤"):
            if 'quick_filter' in st.session_state:
                del st.session_state.quick_filter
            st.rerun()

# ì‚¬ì´ë“œë°”
st.sidebar.header("ğŸ¤– ë©€í‹° RAG ì—ì´ì „íŠ¸")

# ëª¨ë¸ ì„ íƒ
st.sidebar.markdown("### ğŸ§  AI ëª¨ë¸ ì„ íƒ")

# ì‚¬ì´ë“œë°”ì—ì„œ ëª¨ë¸ ì„ íƒ (ì„¸ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸)
selected_model = st.sidebar.selectbox(
    'ëª¨ë¸ ì„ íƒ',
    options=available_models,
    index=available_models.index(st.session_state.sidebar_selected_model) if st.session_state.sidebar_selected_model in available_models else 0,
    help='ClaudeëŠ” ANTHROPIC_API_KEY, OpenAIëŠ” OPENAI_API_KEY í•„ìš”'
)

# ì„ íƒëœ ëª¨ë¸ì´ ë³€ê²½ë˜ë©´ ì„¸ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
if selected_model != st.session_state.sidebar_selected_model:
    st.session_state.sidebar_selected_model = selected_model
    st.rerun()

# í˜„ì¬ ì„ íƒëœ ëª¨ë¸ë¡œ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
sidebar_selected_model = st.session_state.sidebar_selected_model
is_reasoning_capable = sidebar_selected_model in reasoning_models

if is_reasoning_capable:
    st.sidebar.success(f"ğŸ§  **{sidebar_selected_model}**ëŠ” ê³ ê¸‰ Reasoningì„ ì§€ì›í•©ë‹ˆë‹¤!")
    enable_reasoning = st.sidebar.checkbox(
        "ğŸ§  Reasoning í™œì„±í™”", 
        value=st.session_state.get('enable_sidebar_reasoning', True), 
        key="sidebar_reasoning",
        help="ì´ ëª¨ë¸ì€ ì‚¬ê³  ê³¼ì •ì„ ë‹¨ê³„ë³„ë¡œ ë³´ì—¬ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
    )
    
    # ì„¸ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
    st.session_state.enable_sidebar_reasoning = enable_reasoning
    enable_sidebar_reasoning = enable_reasoning
    
    if enable_sidebar_reasoning:
        st.sidebar.info("âœ¨ Reasoningì´ í™œì„±í™”ë˜ì–´ AIì˜ ì‚¬ê³  ê³¼ì •ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
        
        # Reasoning ëª¨ë¸ë³„ íŠ¹ì§• ì„¤ëª…
        if sidebar_selected_model.startswith('claude-3-7'):
            st.sidebar.markdown("ğŸ”¥ **Claude 3.7**: Extended Thinkingìœ¼ë¡œ ì‹¬ì¸µ ë¶„ì„")
        elif sidebar_selected_model == 'claude-3-5-sonnet-latest':
            st.sidebar.markdown("âš¡ **Claude 3.5**: ë¹ ë¥´ê³  íš¨ìœ¨ì ì¸ reasoning")
        elif sidebar_selected_model.startswith('o1'):
            st.sidebar.markdown("ğŸ¤– **OpenAI o1**: ê³ ë„ë¡œ ìµœì í™”ëœ reasoning")
    else:
        st.sidebar.warning("Reasoningì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.")
else:
    st.sidebar.warning(f"âš ï¸ **{sidebar_selected_model}**ëŠ” Reasoningì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
    enable_reasoning = st.sidebar.checkbox(
        "ğŸ§  Reasoning í™œì„±í™”", 
        value=False, 
        disabled=True,
        key="sidebar_reasoning",
        help="ì´ ëª¨ë¸ì€ Reasoningì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
    )
    st.session_state.enable_sidebar_reasoning = False
    enable_sidebar_reasoning = False

st.sidebar.markdown("---")

# RAG ë°ì´í„° ì†ŒìŠ¤ ì„¤ì •
st.sidebar.markdown("### ğŸ” RAG ë°ì´í„° ì†ŒìŠ¤ ì„¤ì •")
st.sidebar.info("ğŸ’¡ RAG ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ë©´ ë” ì •í™•í•˜ê³  êµ¬ì²´ì ì¸ ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤!")

# í˜„ì¬ í™œì„± RAG ì†ŒìŠ¤ í‘œì‹œ
rag_source_count = 0
if st.session_state.mysql_data:
    rag_source_count += 1
if st.session_state.website_data:
    rag_source_count += 1
if st.session_state.files_data:
    rag_source_count += 1

if rag_source_count > 0:
    st.sidebar.success(f"âœ… í™œì„± RAG ì†ŒìŠ¤: {rag_source_count}ê°œ")
else:
    st.sidebar.warning("âŒ í™œì„± RAG ì†ŒìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ì—ì„œ ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.")

# MySQL ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
with st.sidebar.expander("ğŸ—„ï¸ MySQL ë°ì´í„°ë² ì´ìŠ¤", expanded=True):
    if st.sidebar.button("ğŸ” DB ì—°ê²° í…ŒìŠ¤íŠ¸", key="sidebar_mysql_test"):
        connection = connect_to_db()
        if connection:
            connection.close()
            st.sidebar.success("âœ… DB ì—°ê²° ì„±ê³µ")
        else:
            st.sidebar.error("âŒ DB ì—°ê²° ì‹¤íŒ¨")
    
    if st.sidebar.button("ğŸ“‹ í…Œì´ë¸” ëª©ë¡ ì¡°íšŒ", key="sidebar_mysql_tables"):
        tables = get_mysql_tables()
        if tables:
            st.session_state.available_tables = tables
            # ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë“  í…Œì´ë¸” ìë™ ì„ íƒì´ í™œì„±í™”ëœ ìƒíƒœë¡œ ì„¤ì •
            if 'auto_select_all_tables' not in st.session_state:
                st.session_state.auto_select_all_tables = True
            st.sidebar.success(f"âœ… {len(tables)}ê°œ í…Œì´ë¸” ë°œê²¬")
        else:
            st.sidebar.error("âŒ í…Œì´ë¸” ì¡°íšŒ ì‹¤íŒ¨")
    
    # í…Œì´ë¸” ì„ íƒ
    if 'available_tables' in st.session_state:
        # ëª¨ë“  í…Œì´ë¸” ìë™ ì„ íƒ ì˜µì…˜
        auto_select = st.sidebar.checkbox(
            "ğŸ”„ ëª¨ë“  í…Œì´ë¸” ìë™ ì„ íƒ", 
            value=st.session_state.get('auto_select_all_tables', True),
            help="ì²´í¬í•˜ë©´ ëª¨ë“  í…Œì´ë¸”ì´ ìë™ìœ¼ë¡œ ì„ íƒë©ë‹ˆë‹¤. í•´ì œí•˜ë©´ ìˆ˜ë™ìœ¼ë¡œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
            key="auto_select_checkbox"
        )
        
        # ì²´í¬ë°•ìŠ¤ ìƒíƒœë¥¼ ì„¸ì…˜ì— ì €ì¥
        st.session_state.auto_select_all_tables = auto_select
        
        # ìë™ ì„ íƒì´ í™œì„±í™”ë˜ë©´ ëª¨ë“  í…Œì´ë¸” ì„ íƒ, ì•„ë‹ˆë©´ ê¸°ì¡´ ì„ íƒê°’ ìœ ì§€
        if auto_select:
            default_selection = st.session_state.available_tables
        else:
            # ìˆ˜ë™ ëª¨ë“œì—ì„œëŠ” ê¸°ì¡´ ì„ íƒê°’ ìœ ì§€ (ì—†ìœ¼ë©´ ë¹ˆ ë¦¬ìŠ¤íŠ¸)
            default_selection = st.session_state.get('manual_selected_tables', [])
        
        selected_tables = st.sidebar.multiselect(
            "ë¶„ì„í•  í…Œì´ë¸” ì„ íƒ",
            st.session_state.available_tables,
            default=default_selection,
            help="ë„ˆë¬´ ë§ì€ í…Œì´ë¸”ì„ ì„ íƒí•˜ë©´ ì„±ëŠ¥ì´ ì €í•˜ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
            key="sidebar_mysql_table_select",
            disabled=auto_select  # ìë™ ì„ íƒ ëª¨ë“œì—ì„œëŠ” ë¹„í™œì„±í™”
        )
        
        # ìˆ˜ë™ ì„ íƒ ëª¨ë“œì¼ ë•Œ ì„ íƒê°’ ì €ì¥
        if not auto_select:
            st.session_state.manual_selected_tables = selected_tables
        
        # ì„ íƒëœ í…Œì´ë¸” ìˆ˜ í‘œì‹œ
        if selected_tables:
            if auto_select:
                st.sidebar.info(f"ğŸ”„ ìë™ ì„ íƒë¨: {len(selected_tables)}ê°œ í…Œì´ë¸”")
            else:
                st.sidebar.info(f"âœ‹ ìˆ˜ë™ ì„ íƒë¨: {len(selected_tables)}ê°œ í…Œì´ë¸”")
        else:
            if not auto_select:
                st.sidebar.warning("âš ï¸ í…Œì´ë¸”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.")
        
        if st.sidebar.button("ğŸ“¥ ì„ íƒëœ í…Œì´ë¸” ë¡œë“œ", key="sidebar_mysql_load") and selected_tables:
            with st.sidebar:
                with st.spinner("MySQL ë°ì´í„° ë¡œë”© ì¤‘..."):
                    st.session_state.mysql_data = load_mysql_data(selected_tables)
                    if st.session_state.mysql_data:
                        total_rows = sum(len(df) for df in st.session_state.mysql_data.values())
                        st.sidebar.success(f"âœ… {len(selected_tables)}ê°œ í…Œì´ë¸” ë¡œë“œ ì™„ë£Œ! (ì´ {total_rows:,}í–‰)")
                        st.rerun()  # í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì¶”ê°€

# ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ì„¤ì •
with st.sidebar.expander("ğŸŒ ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§", expanded=True):
    website_url = st.sidebar.text_input(
        "ì›¹ì‚¬ì´íŠ¸ URL", 
        placeholder="https://example.com", 
        key="sidebar_website_url"
    )
    max_pages = st.sidebar.slider("ìµœëŒ€ í˜ì´ì§€ ìˆ˜", 1, 10, 5, key="sidebar_website_pages")
    
    if st.sidebar.button("ğŸ•·ï¸ ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ì‹œì‘", key="sidebar_website_crawl") and website_url:
        with st.sidebar:
            with st.spinner("ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ì¤‘..."):
                scraped_data = scrape_website_simple(website_url, max_pages)
                if scraped_data:
                    st.session_state.website_data = scraped_data
                    st.sidebar.success(f"âœ… {len(scraped_data)}ê°œ í˜ì´ì§€ í¬ë¡¤ë§ ì™„ë£Œ!")
                    st.rerun()  # í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì¶”ê°€
                else:
                    st.sidebar.error("âŒ í¬ë¡¤ë§ ì‹¤íŒ¨")

# íŒŒì¼ ì—…ë¡œë“œ ì„¤ì •
with st.sidebar.expander("ğŸ“„ ë¬¸ì„œ íŒŒì¼", expanded=True):
    files = st.sidebar.file_uploader(
        "íŒŒì¼ ì—…ë¡œë“œ",
        type=['txt', 'pdf', 'docx', 'md'],
        accept_multiple_files=True,
        help="ì—¬ëŸ¬ íŒŒì¼ì„ ë™ì‹œì— ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
        key="sidebar_file_upload"
    )
    
    if files and st.sidebar.button("ğŸ“ íŒŒì¼ ì²˜ë¦¬", key="sidebar_file_process"):
        with st.sidebar:
            with st.spinner("íŒŒì¼ ì²˜ë¦¬ ì¤‘..."):
                processed_files = process_files(files)
                if processed_files:
                    st.session_state.files_data = processed_files
                    total_size = sum(f['size'] for f in processed_files)
                    st.sidebar.success(f"âœ… {len(processed_files)}ê°œ íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ! (ì´ {total_size:,}ì)")
                    st.rerun()  # í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì¶”ê°€

st.sidebar.markdown("---")

# RAG ë°ì´í„° ìš”ì•½ í‘œì‹œ
if st.session_state.mysql_data or st.session_state.website_data or st.session_state.files_data:
    st.sidebar.markdown("### ğŸ“‹ ë¡œë“œëœ ë°ì´í„° ìš”ì•½")
    
    if st.session_state.mysql_data:
        total_mysql_rows = sum(len(df) for df in st.session_state.mysql_data.values())
        st.sidebar.write(f"ğŸ—„ï¸ MySQL: {len(st.session_state.mysql_data)}ê°œ í…Œì´ë¸” ({total_mysql_rows:,}í–‰)")
    
    if st.session_state.website_data:
        total_pages = len(st.session_state.website_data)
        st.sidebar.write(f"ğŸŒ ì›¹ì‚¬ì´íŠ¸: {total_pages}ê°œ í˜ì´ì§€")
    
    if st.session_state.files_data:
        total_files = len(st.session_state.files_data)
        total_chars = sum(f['size'] for f in st.session_state.files_data)
        st.sidebar.write(f"ğŸ“„ íŒŒì¼: {total_files}ê°œ ë¬¸ì„œ ({total_chars:,}ì)")

# RAG ì†ŒìŠ¤ ê´€ë¦¬ ë²„íŠ¼ë“¤
if st.session_state.mysql_data or st.session_state.website_data or st.session_state.files_data:
    st.sidebar.markdown("### ğŸ”§ ë°ì´í„° ê´€ë¦¬")
    
    if st.sidebar.button("ğŸ—‘ï¸ ëª¨ë“  RAG ë°ì´í„° ì´ˆê¸°í™”", key="sidebar_rag_reset"):
        st.session_state.mysql_data = None
        st.session_state.website_data = None
        st.session_state.files_data = None
        if 'available_tables' in st.session_state:
            del st.session_state.available_tables
        st.sidebar.success("âœ… RAG ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.")
        st.rerun()

st.sidebar.markdown("---")

# ì£¼ìš” ê¸°ëŠ¥ ì•ˆë‚´
st.sidebar.markdown("""
### ì£¼ìš” ê¸°ëŠ¥
- ğŸ—„ï¸ MySQL ë°ì´í„°ë² ì´ìŠ¤ RAG
- ğŸŒ ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ RAG  
- ğŸ“ ë¬¸ì„œ íŒŒì¼ RAG
- ğŸ§  AI Reasoning ê³¼ì • í‘œì‹œ
- ğŸ’¾ ëŒ€í™” ê¸°ë¡ ì €ì¥/ê´€ë¦¬

### ì§€ì› ëª¨ë¸
""")

# ë™ì ìœ¼ë¡œ ëª¨ë¸ ì •ë³´ í‘œì‹œ
if has_anthropic_key:
    st.sidebar.markdown("**Claude ëª¨ë¸:**")
    st.sidebar.markdown("- ğŸ”¥ **Claude 3.7 Sonnet** (Extended Thinking)")
    st.sidebar.markdown("- âš¡ **Claude 3.5 Sonnet** (Fast Reasoning)")  
    st.sidebar.markdown("- ğŸ¤– **Claude 3 Opus** (ì¼ë°˜ ëª¨ë¸)")

if has_openai_key:
    st.sidebar.markdown("**OpenAI ëª¨ë¸:**")
    st.sidebar.markdown("- ğŸ¤– **o1-preview** (Advanced Reasoning)")
    st.sidebar.markdown("- ğŸ¤– **o1-mini** (Efficient Reasoning)")
    st.sidebar.markdown("- ğŸ¤– **GPT-4o** (ì¼ë°˜ ëª¨ë¸)")
    st.sidebar.markdown("- âš¡ **GPT-4o-mini** (ë¹ ë¥¸ ëª¨ë¸)")

st.sidebar.markdown("""
### ğŸ§  Reasoning ì§€ì› ëª¨ë¸
""")

# Reasoning ì§€ì› ëª¨ë¸ ê°•ì¡° í‘œì‹œ
reasoning_info = ""
if 'claude-3-7-sonnet-latest' in available_models:
    reasoning_info += "âœ¨ **Claude 3.7**: ê°€ì¥ ìƒì„¸í•œ ì‚¬ê³  ê³¼ì •\n"
if 'claude-3-5-sonnet-latest' in available_models:
    reasoning_info += "âš¡ **Claude 3.5**: ë¹ ë¥´ê³  íš¨ìœ¨ì ì¸ reasoning\n"
if 'o1-preview' in available_models:
    reasoning_info += "ğŸ§  **o1-preview**: ê³ ë„ë¡œ ìµœì í™”ëœ ì¶”ë¡ \n"
if 'o1-mini' in available_models:
    reasoning_info += "ğŸ¤– **o1-mini**: íš¨ìœ¨ì ì¸ reasoning\n"

if reasoning_info:
    st.sidebar.markdown(reasoning_info)
else:
    st.sidebar.warning("âš ï¸ Reasoning ì§€ì› ëª¨ë¸ì´ ì—†ìŠµë‹ˆë‹¤.")

st.sidebar.markdown("""
### ì‚¬ìš©ë²•
1. **RAG ì†ŒìŠ¤ ì„¤ì •**: ì¢Œì¸¡ì—ì„œ ë°ì´í„° ë¡œë“œ
2. **ëª¨ë¸ ì„ íƒ**: AI ëª¨ë¸ê³¼ Reasoning ì˜µì…˜ ì„ íƒ
3. **ì§ˆë¬¸í•˜ê¸°**: RAG ê¸°ë°˜ìœ¼ë¡œ ì§ˆë¬¸í•˜ê³  ë‹µë³€ ë°›ê¸°
4. **ê¸°ë¡ ê´€ë¦¬**: ëŒ€í™” ë‚´ìš© ì €ì¥/ê²€ìƒ‰/ê´€ë¦¬

### ğŸ’¡ Reasoning íŒ
- ë³µì¡í•œ ì§ˆë¬¸ì¼ìˆ˜ë¡ Reasoning íš¨ê³¼ ì¦ëŒ€
- Reasoning ê³¼ì •ì„ í†µí•´ AI ì‚¬ê³  ê³¼ì • í•™ìŠµ ê°€ëŠ¥
- ëª¨ë¸ë³„ë¡œ ë‹¤ë¥¸ ìŠ¤íƒ€ì¼ì˜ reasoning ì œê³µ
""")

st.sidebar.divider()
st.sidebar.markdown("**ğŸ“Š í˜„ì¬ ìƒíƒœ**")
st.sidebar.metric("MySQL", "âœ…" if st.session_state.mysql_data else "âŒ")
st.sidebar.metric("ì›¹ì‚¬ì´íŠ¸", "âœ…" if st.session_state.website_data else "âŒ") 
st.sidebar.metric("íŒŒì¼", "âœ…" if st.session_state.files_data else "âŒ") 