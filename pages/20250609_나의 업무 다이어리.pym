import streamlit as st
import mysql.connector
import pandas as pd
import os
from dotenv import load_dotenv
from datetime import datetime, date
import base64
import io
from PIL import Image
import json
import tempfile

load_dotenv()

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(
    page_title="ë‚˜ì˜ ì—…ë¬´ ë‹¤ì´ëŸ¬ë¦¬",
    page_icon="ğŸ“…",
    layout="wide"
)

st.title("ğŸ“… ë‚˜ì˜ ì—…ë¬´ ë‹¤ì´ì–´ë¦¬")

# ì¸ì¦ ê¸°ëŠ¥ (ê°„ë‹¨í•œ ë¹„ë°€ë²ˆí˜¸ ë³´í˜¸)
if 'authenticated' not in st.session_state:
    st.session_state.authenticated = False

admin_pw = os.getenv('ADMIN_PASSWORD')
if not admin_pw:
    st.error('í™˜ê²½ë³€ìˆ˜(ADMIN_PASSWORD)ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. .env íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.')
    st.stop()

if not st.session_state.authenticated:
    password = st.text_input("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”", type="password")
    if password == admin_pw:
        st.session_state.authenticated = True
        st.rerun()
    else:
        if password:  # ë¹„ë°€ë²ˆí˜¸ê°€ ì…ë ¥ëœ ê²½ìš°ì—ë§Œ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
            st.error("ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤")
        st.stop()

def connect_to_db():
    """ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°"""
    try:
        conn = mysql.connector.connect(
            host=os.getenv('SQL_HOST'),
            user=os.getenv('SQL_USER'),
            password=os.getenv('SQL_PASSWORD'),
            database=os.getenv('SQL_DATABASE_NEWBIZ'),
            charset='utf8mb4',
            collation='utf8mb4_unicode_ci'
        )
        return conn
    except mysql.connector.Error as err:
        st.error(f"ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì˜¤ë¥˜: {err}")
        return None

def get_diary_by_date_and_author(work_date, author):
    """íŠ¹ì • ë‚ ì§œì™€ ì‘ì„±ìì˜ ì—…ë¬´ì¼ì§€ ì¡°íšŒ"""
    try:
        conn = connect_to_db()
        if not conn:
            return None
        
        cursor = conn.cursor()
        
        cursor.execute("""
            SELECT diary_id, author, work_date, po_content, customs_content, 
                   inventory_content, partner_content, other_content, created_at, updated_at
            FROM work_diary 
            WHERE work_date = %s AND author = %s
            ORDER BY created_at DESC
            LIMIT 1
        """, (work_date, author))
        
        result = cursor.fetchone()
        cursor.close()
        conn.close()
        
        if result:
            return {
                'diary_id': result[0],
                'author': result[1],
                'work_date': result[2],
                'po_content': result[3] or '',
                'customs_content': result[4] or '',
                'inventory_content': result[5] or '',
                'partner_content': result[6] or '',
                'other_content': result[7] or '',
                'created_at': result[8],
                'updated_at': result[9]
            }
        return None
        
    except mysql.connector.Error as err:
        st.error(f"ì—…ë¬´ì¼ì§€ ì¡°íšŒ ì˜¤ë¥˜: {err}")
        return None

def save_work_diary(diary_data, diary_id=None):
    """ì—…ë¬´ì¼ì§€ ì €ì¥ (ìƒˆë¡œ ìƒì„± ë˜ëŠ” ì—…ë°ì´íŠ¸)"""
    try:
        conn = connect_to_db()
        if not conn:
            return None
        
        cursor = conn.cursor()
        
        if diary_id:
            # ê¸°ì¡´ ë°ì´í„° ì—…ë°ì´íŠ¸
            cursor.execute("""
                UPDATE work_diary 
                SET author = %s, work_date = %s, po_content = %s, customs_content = %s, 
                    inventory_content = %s, partner_content = %s, other_content = %s
                WHERE diary_id = %s
            """, (
                diary_data['author'],
                diary_data['work_date'],
                diary_data['po_content'],
                diary_data['customs_content'],
                diary_data['inventory_content'],
                diary_data['partner_content'],
                diary_data['other_content'],
                diary_id
            ))
            result_id = diary_id
        else:
            # ìƒˆ ë°ì´í„° ìƒì„±
            cursor.execute("""
                INSERT INTO work_diary 
                (author, work_date, po_content, customs_content, inventory_content, partner_content, other_content)
                VALUES (%s, %s, %s, %s, %s, %s, %s)
            """, (
                diary_data['author'],
                diary_data['work_date'],
                diary_data['po_content'],
                diary_data['customs_content'],
                diary_data['inventory_content'],
                diary_data['partner_content'],
                diary_data['other_content']
            ))
            result_id = cursor.lastrowid
        
        conn.commit()
        cursor.close()
        conn.close()
        
        return result_id
        
    except mysql.connector.Error as err:
        st.error(f"ì—…ë¬´ì¼ì§€ ì €ì¥ ì˜¤ë¥˜: {err}")
        return None

def save_work_diary_file(diary_id, work_type, file_data):
    """ì—…ë¬´ì¼ì§€ íŒŒì¼ ì €ì¥"""
    try:
        conn = connect_to_db()
        if not conn:
            return False
        
        cursor = conn.cursor()
        
        # íŒŒì¼ ë‚´ìš©ì„ ë°”ì´ë„ˆë¦¬ë¡œ ì½ê¸°
        file_content = file_data.read()
        file_data.seek(0)  # íŒŒì¼ í¬ì¸í„° ë¦¬ì…‹
        
        cursor.execute("""
            INSERT INTO work_diary_files 
            (diary_id, work_type, filename, file_type, file_content, file_size)
            VALUES (%s, %s, %s, %s, %s, %s)
        """, (
            diary_id,
            work_type,
            file_data.name,
            file_data.type if hasattr(file_data, 'type') else 'unknown',
            file_content,
            len(file_content)
        ))
        
        conn.commit()
        cursor.close()
        conn.close()
        
        return True
        
    except mysql.connector.Error as err:
        st.error(f"íŒŒì¼ ì €ì¥ ì˜¤ë¥˜: {err}")
        return False

def get_work_diaries(search_author=None, search_date=None, search_content=None):
    """ì—…ë¬´ì¼ì§€ ì¡°íšŒ"""
    try:
        conn = connect_to_db()
        if not conn:
            return pd.DataFrame()
        
        cursor = conn.cursor()
        
        query = "SELECT * FROM work_diary WHERE 1=1"
        params = []
        
        if search_author:
            query += " AND author LIKE %s"
            params.append(f"%{search_author}%")
        
        if search_date:
            query += " AND work_date = %s"
            params.append(search_date)
        
        if search_content:
            query += """ AND (
                po_content LIKE %s OR 
                customs_content LIKE %s OR 
                inventory_content LIKE %s OR 
                partner_content LIKE %s OR 
                other_content LIKE %s
            )"""
            search_param = f"%{search_content}%"
            params.extend([search_param] * 5)
        
        query += " ORDER BY work_date DESC, created_at DESC"
        
        cursor.execute(query, params)
        data = cursor.fetchall()
        
        columns = ['diary_id', 'author', 'work_date', 'po_content', 'customs_content', 
                  'inventory_content', 'partner_content', 'other_content', 'created_at', 'updated_at']
        
        cursor.close()
        conn.close()
        
        return pd.DataFrame(data, columns=columns)
        
    except mysql.connector.Error as err:
        st.error(f"ì—…ë¬´ì¼ì§€ ì¡°íšŒ ì˜¤ë¥˜: {err}")
        return pd.DataFrame()

def get_work_diary_files(diary_id):
    """íŠ¹ì • ì—…ë¬´ì¼ì§€ì˜ íŒŒì¼ ëª©ë¡ ì¡°íšŒ"""
    try:
        conn = connect_to_db()
        if not conn:
            return pd.DataFrame()
        
        cursor = conn.cursor()
        
        cursor.execute("""
            SELECT file_id, work_type, filename, file_type, file_size, uploaded_at
            FROM work_diary_files 
            WHERE diary_id = %s
            ORDER BY work_type, uploaded_at
        """, (diary_id,))
        
        data = cursor.fetchall()
        columns = ['file_id', 'work_type', 'filename', 'file_type', 'file_size', 'uploaded_at']
        
        cursor.close()
        conn.close()
        
        return pd.DataFrame(data, columns=columns)
        
    except mysql.connector.Error as err:
        st.error(f"íŒŒì¼ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜: {err}")
        return pd.DataFrame()

def get_file_binary_data(file_id):
    """íŒŒì¼ ë°”ì´ë„ˆë¦¬ ë°ì´í„° ì¡°íšŒ"""
    try:
        conn = connect_to_db()
        if not conn:
            return None
        
        cursor = conn.cursor()
        
        cursor.execute("""
            SELECT filename, file_type, file_content
            FROM work_diary_files 
            WHERE file_id = %s
        """, (file_id,))
        
        result = cursor.fetchone()
        cursor.close()
        conn.close()
        
        if result:
            return {
                'filename': result[0],
                'file_type': result[1],
                'binary_data': result[2]
            }
        return None
        
    except mysql.connector.Error as err:
        st.error(f"íŒŒì¼ ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜: {err}")
        return None

def display_file_preview(file_data, file_type, filename):
    """íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ - í”„ë¡œì íŠ¸ ë¦¬ë·°ì™€ ë™ì¼í•œ ë°©ì‹"""
    try:
        file_type_lower = file_type.lower()
        # íŒŒì¼ í™•ì¥ì ì¶”ì¶œ
        file_extension = filename.lower().split('.')[-1] if '.' in filename else ''
        
        # ì´ë¯¸ì§€ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°
        if (file_type_lower in ['jpg', 'jpeg', 'png', 'gif'] or 'image' in file_type_lower or 
            file_extension in ['jpg', 'jpeg', 'png', 'gif']):
            if file_data.get('binary_data'):
                st.image(
                    file_data['binary_data'],
                    caption=f"ğŸ–¼ï¸ {filename}",
                    use_column_width=True
                )
                return True
            else:
                st.info("ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                return False
        
        # PDF íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° (iframe ì‚¬ìš©)
        elif file_type_lower == 'pdf' or 'pdf' in file_type_lower or file_extension == 'pdf':
            if file_data.get('binary_data'):
                # PDFë¥¼ base64ë¡œ ì¸ì½”ë”©í•˜ì—¬ iframeì— í‘œì‹œ
                pdf_base64 = base64.b64encode(file_data['binary_data']).decode('utf-8')
                pdf_display = f"""
                <iframe src="data:application/pdf;base64,{pdf_base64}" 
                        width="100%" height="600px" type="application/pdf">
                    <p>PDFë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. 
                    <a href="data:application/pdf;base64,{pdf_base64}" target="_blank">
                    ì—¬ê¸°ë¥¼ í´ë¦­í•˜ì—¬ ìƒˆ íƒ­ì—ì„œ ì—´ì–´ë³´ì„¸ìš”.</a></p>
                </iframe>
                """
                st.markdown(pdf_display, unsafe_allow_html=True)
                return True
            else:
                st.info("PDF ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                return False
        
        # Excel íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°
        elif (file_type_lower in ['xlsx', 'xls'] or 'excel' in file_type_lower or 'spreadsheet' in file_type_lower or
              file_extension in ['xlsx', 'xls']):
            if file_data.get('binary_data'):
                try:
                    # ë°”ì´ë„ˆë¦¬ ë°ì´í„°ë¥¼ ì„ì‹œ íŒŒì¼ë¡œ ì €ì¥í•˜ì—¬ pandasë¡œ ì½ê¸°
                    with tempfile.NamedTemporaryFile(suffix=f'.{file_type_lower}', delete=False) as tmp_file:
                        tmp_file.write(file_data['binary_data'])
                        tmp_file_path = tmp_file.name
                    
                    # Excel íŒŒì¼ ì½ê¸°
                    df = pd.read_excel(tmp_file_path)
                    
                    # ì„ì‹œ íŒŒì¼ ì‚­ì œ
                    os.unlink(tmp_file_path)
                    
                    st.subheader(f"ğŸ“Š Excel íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°: {filename}")
                    st.dataframe(df, use_container_width=True)
                    
                    # ê¸°ë³¸ í†µê³„ ì •ë³´
                    col1, col2, col3 = st.columns(3)
                    with col1:
                        st.metric("í–‰ ìˆ˜", len(df))
                    with col2:
                        st.metric("ì—´ ìˆ˜", len(df.columns))
                    with col3:
                        st.metric("ë°ì´í„° íƒ€ì…", len(df.dtypes.unique()))
                    
                    return True
                except Exception as e:
                    st.error(f"Excel íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
                    return False
            else:
                st.info("Excel ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                return False
        
        # CSV íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°
        elif file_type_lower == 'csv' or 'csv' in file_type_lower or file_extension == 'csv':
            if file_data.get('binary_data'):
                try:
                    # CSV ë°ì´í„°ë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜
                    csv_content = file_data['binary_data'].decode('utf-8')
                    
                    # StringIOë¥¼ ì‚¬ìš©í•˜ì—¬ pandasë¡œ ì½ê¸°
                    from io import StringIO
                    df = pd.read_csv(StringIO(csv_content))
                    
                    st.subheader(f"ğŸ“ˆ CSV íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°: {filename}")
                    st.dataframe(df, use_container_width=True)
                    
                    # ê¸°ë³¸ í†µê³„ ì •ë³´
                    col1, col2, col3 = st.columns(3)
                    with col1:
                        st.metric("í–‰ ìˆ˜", len(df))
                    with col2:
                        st.metric("ì—´ ìˆ˜", len(df.columns))
                    with col3:
                        st.metric("ë°ì´í„° íƒ€ì…", len(df.dtypes.unique()))
                    
                    return True
                except Exception as e:
                    st.error(f"CSV íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
                    return False
            else:
                st.info("CSV ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                return False
        
        # JSON íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°
        elif file_type_lower == 'json' or 'json' in file_type_lower or file_extension == 'json':
            if file_data.get('binary_data'):
                try:
                    json_content = file_data['binary_data'].decode('utf-8')
                    json_data = json.loads(json_content)
                    
                    st.subheader(f"ğŸ“‹ JSON íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°: {filename}")
                    st.json(json_data)
                    return True
                except Exception as e:
                    st.error(f"JSON íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
                    return False
            else:
                st.info("JSON ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                return False
        
        # í…ìŠ¤íŠ¸ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° (TXT, MD, XML, HTML ë“±)
        elif (file_type_lower in ['txt', 'md', 'xml', 'html', 'markdown'] or 
              'text' in file_type_lower or 'html' in file_type_lower or 'xml' in file_type_lower or
              file_extension in ['txt', 'md', 'markdown', 'xml', 'html']):
            if file_data.get('binary_data'):
                try:
                    text_content = file_data['binary_data'].decode('utf-8')
                    
                    st.subheader(f"ğŸ“„ í…ìŠ¤íŠ¸ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°: {filename}")
                    
                    if file_type_lower == 'md' or file_extension in ['md', 'markdown']:
                        # Markdown íŒŒì¼ì€ ë Œë”ë§í•˜ì—¬ í‘œì‹œ
                        st.markdown(text_content)
                    elif file_type_lower == 'html' or file_extension == 'html':
                        # HTML íŒŒì¼ì€ ì½”ë“œë¡œ í‘œì‹œ (ë³´ì•ˆìƒ ë Œë”ë§í•˜ì§€ ì•ŠìŒ)
                        st.code(text_content, language='html')
                    elif file_type_lower == 'xml' or file_extension == 'xml':
                        # XML íŒŒì¼ì€ ì½”ë“œë¡œ í‘œì‹œ
                        st.code(text_content, language='xml')
                    else:
                        # ì¼ë°˜ í…ìŠ¤íŠ¸
                        st.text_area(
                            "íŒŒì¼ ë‚´ìš©",
                            value=text_content,
                            height=400,
                            disabled=True
                        )
                    
                    return True
                except Exception as e:
                    st.error(f"í…ìŠ¤íŠ¸ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
                    return False
            else:
                st.info("í…ìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                return False
        
        # ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹
        else:
            st.info(f"ğŸ“ {file_type.upper()} íŒŒì¼ì€ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
            st.caption("ë‹¤ìš´ë¡œë“œí•˜ì—¬ í•´ë‹¹ í”„ë¡œê·¸ë¨ì—ì„œ ì—´ì–´ë³´ì„¸ìš”.")
            return False
            
    except Exception as e:
        st.error(f"íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
        return False

def get_work_diary_by_id(diary_id):
    """íŠ¹ì • ì—…ë¬´ì¼ì§€ ì¡°íšŒ"""
    try:
        conn = connect_to_db()
        if not conn:
            return None
        
        cursor = conn.cursor()
        
        cursor.execute("""
            SELECT diary_id, author, work_date, po_content, customs_content, 
                   inventory_content, partner_content, other_content, created_at, updated_at
            FROM work_diary 
            WHERE diary_id = %s
        """, (diary_id,))
        
        result = cursor.fetchone()
        cursor.close()
        conn.close()
        
        if result:
            return {
                'diary_id': result[0],
                'author': result[1],
                'work_date': result[2],
                'po_content': result[3],
                'customs_content': result[4],
                'inventory_content': result[5],
                'partner_content': result[6],
                'other_content': result[7],
                'created_at': result[8],
                'updated_at': result[9]
            }
        return None
        
    except mysql.connector.Error as err:
        st.error(f"ì—…ë¬´ì¼ì§€ ì¡°íšŒ ì˜¤ë¥˜: {err}")
        return None

def update_work_diary(diary_id, diary_data):
    """ì—…ë¬´ì¼ì§€ ìˆ˜ì •"""
    try:
        conn = connect_to_db()
        if not conn:
            return False
        
        cursor = conn.cursor()
        
        cursor.execute("""
            UPDATE work_diary 
            SET author = %s, work_date = %s, po_content = %s, customs_content = %s, 
                inventory_content = %s, partner_content = %s, other_content = %s
            WHERE diary_id = %s
        """, (
            diary_data['author'],
            diary_data['work_date'],
            diary_data['po_content'],
            diary_data['customs_content'],
            diary_data['inventory_content'],
            diary_data['partner_content'],
            diary_data['other_content'],
            diary_id
        ))
        
        conn.commit()
        cursor.close()
        conn.close()
        
        return True
        
    except mysql.connector.Error as err:
        st.error(f"ì—…ë¬´ì¼ì§€ ìˆ˜ì • ì˜¤ë¥˜: {err}")
        return False

def delete_work_diary(diary_id):
    """ì—…ë¬´ì¼ì§€ ì‚­ì œ (íŒŒì¼ë„ í•¨ê»˜ ì‚­ì œë¨ - CASCADE)"""
    try:
        conn = connect_to_db()
        if not conn:
            return False
        
        cursor = conn.cursor()
        
        cursor.execute("DELETE FROM work_diary WHERE diary_id = %s", (diary_id,))
        
        conn.commit()
        cursor.close()
        conn.close()
        
        return True
        
    except mysql.connector.Error as err:
        st.error(f"ì—…ë¬´ì¼ì§€ ì‚­ì œ ì˜¤ë¥˜: {err}")
        return False

def delete_work_diary_file(file_id):
    """ì—…ë¬´ì¼ì§€ íŒŒì¼ ì‚­ì œ"""
    try:
        conn = connect_to_db()
        if not conn:
            return False
        
        cursor = conn.cursor()
        
        cursor.execute("DELETE FROM work_diary_files WHERE file_id = %s", (file_id,))
        
        conn.commit()
        cursor.close()
        conn.close()
        
        return True
        
    except mysql.connector.Error as err:
        st.error(f"íŒŒì¼ ì‚­ì œ ì˜¤ë¥˜: {err}")
        return False

def main():
    # DB í…Œì´ë¸” ì¡´ì¬ í™•ì¸
    conn = connect_to_db()
    if not conn:
        st.error("ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return
    
    cursor = conn.cursor()
    try:
        # ì—…ë¬´ì¼ì§€ í…Œì´ë¸” ì¡´ì¬ í™•ì¸
        cursor.execute("SHOW TABLES LIKE 'work_diary'")
        if not cursor.fetchone():
            st.error("âš ï¸ ì—…ë¬´ì¼ì§€ í…Œì´ë¸”ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. 'ğŸ’¾ DBìƒì„±' í˜ì´ì§€ì—ì„œ 'ì—…ë¬´ì¼ì§€ í…Œì´ë¸” ìƒì„±'ì„ ë¨¼ì € ì‹¤í–‰í•´ì£¼ì„¸ìš”.")
            return
    except mysql.connector.Error as err:
        st.error(f"í…Œì´ë¸” í™•ì¸ ì¤‘ ì˜¤ë¥˜: {err}")
        return
    finally:
        cursor.close()
        conn.close()
    
    # íƒ­ ìƒì„±
    tab1, tab2 = st.tabs(["ğŸ“ ì—…ë¬´ì¼ì§€ ì‘ì„±", "ğŸ“‹ ì—…ë¬´ì¼ì§€ ì¡°íšŒ/ìˆ˜ì •"])
    
    with tab1:
        st.header("ì—…ë¬´ì¼ì§€ ì‘ì„±")
        
        col1, col2 = st.columns([2, 1])
        
        with col1:
            author = st.text_input("ì‘ì„±ì", value="ì´ìƒí˜„", help="ì—…ë¬´ì¼ì§€ ì‘ì„±ìë¥¼ ì…ë ¥í•˜ì„¸ìš”")
        
        with col2:
            work_date = st.date_input("ì—…ë¬´ ë‚ ì§œ", value=date.today(), help="ì—…ë¬´ ìˆ˜í–‰ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”")
        
        # ë‚ ì§œì™€ ì‘ì„±ìê°€ ë³€ê²½ë˜ì—ˆì„ ë•Œ ê¸°ì¡´ ë°ì´í„° ì¡°íšŒ
        if 'last_check_date' not in st.session_state or 'last_check_author' not in st.session_state:
            st.session_state.last_check_date = work_date
            st.session_state.last_check_author = author
            st.session_state.existing_diary = None
        
        # ë‚ ì§œë‚˜ ì‘ì„±ìê°€ ë³€ê²½ë˜ì—ˆì„ ë•Œ
        if (st.session_state.last_check_date != work_date or 
            st.session_state.last_check_author != author):
            
            st.session_state.last_check_date = work_date
            st.session_state.last_check_author = author
            
            # ê¸°ì¡´ ë°ì´í„° ì¡°íšŒ
            existing_diary = get_diary_by_date_and_author(work_date, author)
            st.session_state.existing_diary = existing_diary
            
            if existing_diary:
                st.success(f"ğŸ“… {work_date}ì— ì‘ì„±ëœ {author}ë‹˜ì˜ ì—…ë¬´ì¼ì§€ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. (ìˆ˜ì • ëª¨ë“œ)")
                st.info(f"ğŸ•’ ì‘ì„±ì¼: {existing_diary['created_at']} | ìˆ˜ì •ì¼: {existing_diary['updated_at']}")
        
        st.markdown("---")
        
        # ì—…ë¬´ ìœ í˜•ë³„ ì…ë ¥ ì„¹ì…˜
        work_types = {
            "PO": {"label": "ğŸ›’ PO (Purchase Order)", "key": "po"},
            "í†µê´€": {"label": "ğŸ›ƒ í†µê´€", "key": "customs"},
            "ì¬ê³  ê´€ë¦¬": {"label": "ğŸ“¦ ì¬ê³  ê´€ë¦¬", "key": "inventory"},
            "íŒŒíŠ¸ë„ˆ ê´€ë¦¬": {"label": "ğŸ¤ íŒŒíŠ¸ë„ˆ ê´€ë¦¬", "key": "partner"},
            "ê¸°íƒ€": {"label": "ğŸ“Œ ê¸°íƒ€", "key": "other"}
        }
        
        diary_content = {}
        uploaded_files = {}
        
        for work_type, info in work_types.items():
            st.subheader(info["label"])
            
            # ê¸°ì¡´ ë°ì´í„°ê°€ ìˆìœ¼ë©´ valueë¡œ ì„¤ì •
            content_key = f"{info['key']}_content"
            existing_content = ""
            if st.session_state.existing_diary:
                existing_content = st.session_state.existing_diary[content_key]
            
            # í…ìŠ¤íŠ¸ ì…ë ¥
            diary_content[content_key] = st.text_area(
                f"{work_type} ì—…ë¬´ ë‚´ìš©",
                value=existing_content,
                height=150,
                key=f"content_{info['key']}",
                help=f"{work_type} ê´€ë ¨ ì—…ë¬´ ë‚´ìš©ì„ ìƒì„¸íˆ ì‘ì„±í•´ì£¼ì„¸ìš”"
            )
            
            # íŒŒì¼ ì—…ë¡œë“œ
            files = st.file_uploader(
                f"{work_type} ê´€ë ¨ íŒŒì¼ ì²¨ë¶€",
                accept_multiple_files=True,
                type=['pdf', 'md', 'txt', 'jpg', 'jpeg', 'png', 'csv', 'xlsx', 'xls', 'json', 'html', 'xml'],
                key=f"files_{info['key']}",
                help="PDF, ë§ˆí¬ë‹¤ìš´, í…ìŠ¤íŠ¸, ì´ë¯¸ì§€, Excel, CSV, JSON ë“± ë‹¤ì–‘í•œ íŒŒì¼ì„ ì²¨ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤"
            )
            
            if files:
                uploaded_files[work_type] = files
                st.success(f"{len(files)}ê°œ íŒŒì¼ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.")
            
            # ê¸°ì¡´ íŒŒì¼ì´ ìˆìœ¼ë©´ í‘œì‹œ
            if st.session_state.existing_diary:
                existing_files = get_work_diary_files(st.session_state.existing_diary['diary_id'])
                work_type_files = existing_files[existing_files['work_type'] == work_type]
                
                if not work_type_files.empty:
                    st.markdown(f"**ğŸ“ ê¸°ì¡´ ì²¨ë¶€ íŒŒì¼ ({len(work_type_files)}ê°œ):**")
                    for _, file_row in work_type_files.iterrows():
                        st.caption(f"â€¢ {file_row['filename']} ({file_row['file_size']:,} bytes)")
            
            st.markdown("---")
        
        # ì €ì¥ ë²„íŠ¼
        button_text = "ğŸ’¾ ì—…ë¬´ì¼ì§€ ìˆ˜ì •" if st.session_state.existing_diary else "ğŸ“ ì—…ë¬´ì¼ì§€ ì €ì¥"
        
        if st.button(button_text, type="primary", use_container_width=True):
            if not author.strip():
                st.error("ì‘ì„±ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
                return
            
            # ë‚´ìš©ì´ í•˜ë‚˜ë¼ë„ ìˆëŠ”ì§€ í™•ì¸
            has_content = any(content.strip() for content in diary_content.values()) or uploaded_files
            
            if not has_content:
                st.error("ì—…ë¬´ ë‚´ìš©ì„ í•˜ë‚˜ ì´ìƒ ì…ë ¥í•˜ê±°ë‚˜ íŒŒì¼ì„ ì²¨ë¶€í•´ì£¼ì„¸ìš”.")
                return
            
            # ì—…ë¬´ì¼ì§€ ì €ì¥/ìˆ˜ì •
            diary_data = {
                'author': author,
                'work_date': work_date,
                **diary_content
            }
            
            existing_diary_id = st.session_state.existing_diary['diary_id'] if st.session_state.existing_diary else None
            diary_id = save_work_diary(diary_data, existing_diary_id)
            
            if diary_id:
                if existing_diary_id:
                    st.success("âœ… ì—…ë¬´ì¼ì§€ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!")
                else:
                    st.success("âœ… ì—…ë¬´ì¼ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!")
                
                # íŒŒì¼ ì €ì¥
                total_files = 0
                saved_files = 0
                
                for work_type, files in uploaded_files.items():
                    for file in files:
                        total_files += 1
                        if save_work_diary_file(diary_id, work_type, file):
                            saved_files += 1
                
                if total_files > 0:
                    if saved_files == total_files:
                        st.success(f"âœ… {saved_files}ê°œ íŒŒì¼ì´ ëª¨ë‘ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!")
                    else:
                        st.warning(f"âš ï¸ {total_files}ê°œ ì¤‘ {saved_files}ê°œ íŒŒì¼ë§Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
                
                # ìƒíƒœ ì´ˆê¸°í™” (ë‹¤ìŒì— ë‹¤ì‹œ ë¡œë“œí•˜ê¸° ìœ„í•´)
                st.session_state.existing_diary = None
                st.session_state.last_check_date = None
                st.session_state.last_check_author = None
                
                # ì„±ê³µ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ì„ ìœ„í•œ ë¹ˆ ì»¨í…Œì´ë„ˆ
                st.balloons()
                
            else:
                st.error("âŒ ì—…ë¬´ì¼ì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
    
    with tab2:
        st.header("ì—…ë¬´ì¼ì§€ ì¡°íšŒ ë° ìˆ˜ì •")
        
        # ê²€ìƒ‰ í•„í„°
        st.subheader("ğŸ” ê²€ìƒ‰ í•„í„°")
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            search_author = st.text_input("ì‘ì„±ì ê²€ìƒ‰", help="ì‘ì„±ì ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰")
        
        with col2:
            search_date = st.date_input("ë‚ ì§œ ê²€ìƒ‰", value=None, help="íŠ¹ì • ë‚ ì§œë¡œ ê²€ìƒ‰")
        
        with col3:
            search_content = st.text_input("ë‚´ìš© ê²€ìƒ‰", help="ì—…ë¬´ ë‚´ìš©ì—ì„œ í‚¤ì›Œë“œ ê²€ìƒ‰")
        
        # ê²€ìƒ‰ ì‹¤í–‰
        if st.button("ğŸ” ê²€ìƒ‰", type="secondary"):
            st.session_state.search_executed = True
        
        # ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
        if 'search_executed' not in st.session_state:
            st.session_state.search_executed = True
        
        if st.session_state.search_executed:
            diaries_df = get_work_diaries(search_author, search_date, search_content)
            
            if not diaries_df.empty:
                st.subheader(f"ğŸ“‹ ê²€ìƒ‰ ê²°ê³¼ ({len(diaries_df)}ê±´)")
                
                # ì—…ë¬´ì¼ì§€ ëª©ë¡ í‘œì‹œ
                for index, row in diaries_df.iterrows():
                    with st.expander(f"ğŸ“… {row['work_date']} - {row['author']} (ID: {row['diary_id']})"):
                        
                        # ìˆ˜ì • ëª¨ë“œ ì²´í¬ë°•ìŠ¤
                        edit_mode = st.checkbox(f"ìˆ˜ì • ëª¨ë“œ", key=f"edit_{row['diary_id']}")
                        
                        if edit_mode:
                            # ìˆ˜ì • ê°€ëŠ¥í•œ í¼
                            st.markdown("### âœï¸ ìˆ˜ì •í•˜ê¸°")
                            
                            edit_author = st.text_input("ì‘ì„±ì", value=row['author'], key=f"edit_author_{row['diary_id']}")
                            edit_date = st.date_input("ì—…ë¬´ ë‚ ì§œ", value=row['work_date'], key=f"edit_date_{row['diary_id']}")
                            
                            edit_content = {}
                            uploaded_files_edit = {}
                            
                            for work_type, info in work_types.items():
                                st.subheader(f"{info['label']} ìˆ˜ì •")
                                
                                content_key = f"{info['key']}_content"
                                current_content = row[content_key] if row[content_key] else ""
                                edit_content[content_key] = st.text_area(
                                    f"{work_type} ì—…ë¬´ ë‚´ìš©",
                                    value=current_content,
                                    height=100,
                                    key=f"edit_{content_key}_{row['diary_id']}"
                                )
                                
                                # íŒŒì¼ ì—…ë¡œë“œ (ìˆ˜ì • ëª¨ë“œ)
                                edit_files = st.file_uploader(
                                    f"{work_type} ê´€ë ¨ íŒŒì¼ ì¶”ê°€",
                                    accept_multiple_files=True,
                                    type=['pdf', 'md', 'txt', 'jpg', 'jpeg', 'png', 'csv', 'xlsx', 'xls', 'json'],
                                    key=f"edit_files_{info['key']}_{row['diary_id']}",
                                    help="ìƒˆë¡œìš´ íŒŒì¼ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤"
                                )
                                
                                if edit_files:
                                    uploaded_files_edit[work_type] = edit_files
                                    st.success(f"{len(edit_files)}ê°œ ìƒˆ íŒŒì¼ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.")
                                
                                # ê¸°ì¡´ íŒŒì¼ í‘œì‹œ
                                existing_files_edit = get_work_diary_files(row['diary_id'])
                                work_type_files_edit = existing_files_edit[existing_files_edit['work_type'] == work_type]
                                
                                if not work_type_files_edit.empty:
                                    st.markdown(f"**ğŸ“ ê¸°ì¡´ ì²¨ë¶€ íŒŒì¼ ({len(work_type_files_edit)}ê°œ):**")
                                    for _, file_row_edit in work_type_files_edit.iterrows():
                                        col_file_edit1, col_file_edit2 = st.columns([4, 1])
                                        
                                        with col_file_edit1:
                                            st.caption(f"â€¢ {file_row_edit['filename']} ({file_row_edit['file_size']:,} bytes)")
                                        
                                        with col_file_edit2:
                                            if st.button("ğŸ—‘ï¸", key=f"del_edit_file_{file_row_edit['file_id']}", help="íŒŒì¼ ì‚­ì œ"):
                                                if delete_work_diary_file(file_row_edit['file_id']):
                                                    st.success("íŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.")
                                                    st.rerun()
                                                else:
                                                    st.error("íŒŒì¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
                                
                                st.markdown("---")
                            
                            col_save, col_delete = st.columns(2)
                            
                            with col_save:
                                if st.button("ğŸ’¾ ìˆ˜ì • ì €ì¥", key=f"save_{row['diary_id']}", type="primary"):
                                    edit_data = {
                                        'author': edit_author,
                                        'work_date': edit_date,
                                        **edit_content
                                    }
                                    
                                    if update_work_diary(row['diary_id'], edit_data):
                                        # ìƒˆ íŒŒì¼ë“¤ ì €ì¥
                                        total_new_files = 0
                                        saved_new_files = 0
                                        
                                        for work_type, files in uploaded_files_edit.items():
                                            for file in files:
                                                total_new_files += 1
                                                if save_work_diary_file(row['diary_id'], work_type, file):
                                                    saved_new_files += 1
                                        
                                        if total_new_files > 0:
                                            if saved_new_files == total_new_files:
                                                st.success(f"âœ… ì—…ë¬´ì¼ì§€ê°€ ìˆ˜ì •ë˜ì—ˆê³ , {saved_new_files}ê°œ ìƒˆ íŒŒì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!")
                                            else:
                                                st.warning(f"âœ… ì—…ë¬´ì¼ì§€ëŠ” ìˆ˜ì •ë˜ì—ˆì§€ë§Œ, {total_new_files}ê°œ ì¤‘ {saved_new_files}ê°œ íŒŒì¼ë§Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
                                        else:
                                            st.success("âœ… ì—…ë¬´ì¼ì§€ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!")
                                        
                                        st.rerun()
                                    else:
                                        st.error("âŒ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
                            
                            with col_delete:
                                if st.button("ğŸ—‘ï¸ ì‚­ì œ", key=f"delete_{row['diary_id']}", type="secondary"):
                                    if delete_work_diary(row['diary_id']):
                                        st.success("âœ… ì—…ë¬´ì¼ì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!")
                                        st.rerun()
                                    else:
                                        st.error("âŒ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
                        
                        else:
                            # ì½ê¸° ì „ìš© ëª¨ë“œ
                            st.markdown(f"**ì‘ì„±ì¼:** {row['created_at']}")
                            if row['updated_at'] != row['created_at']:
                                st.markdown(f"**ìˆ˜ì •ì¼:** {row['updated_at']}")
                            
                            # ì—…ë¬´ ë‚´ìš© í‘œì‹œ
                            for work_type, info in work_types.items():
                                content_key = f"{info['key']}_content"
                                if row[content_key]:
                                    st.markdown(f"**{info['label']}**")
                                    st.text_area(
                                        "",
                                        value=row[content_key],
                                        height=100,
                                        disabled=True,
                                        key=f"view_{content_key}_{row['diary_id']}"
                                    )
                        
                        # ì²¨ë¶€ íŒŒì¼ í‘œì‹œ
                        files_df = get_work_diary_files(row['diary_id'])
                        
                        if not files_df.empty:
                            st.markdown("### ğŸ“ ì²¨ë¶€ íŒŒì¼")
                            
                            for file_index, file_row in files_df.iterrows():
                                col_file1, col_file2, col_file3 = st.columns([3, 1, 1])
                                
                                with col_file1:
                                    st.write(f"**{file_row['work_type']}** - {file_row['filename']}")
                                    st.caption(f"í¬ê¸°: {file_row['file_size']:,} bytes | ì—…ë¡œë“œ: {file_row['uploaded_at']}")
                                
                                with col_file2:
                                    # ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
                                    file_data = get_file_binary_data(file_row['file_id'])
                                    if file_data:
                                        st.download_button(
                                            "ğŸ’¾ ë‹¤ìš´ë¡œë“œ",
                                            data=file_data['binary_data'],
                                            file_name=file_data['filename'],
                                            key=f"download_{file_row['file_id']}"
                                        )
                                
                                with col_file3:
                                    # ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼ (í† ê¸€ ë°©ì‹)
                                    if st.button("ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°", key=f"preview_{file_row['file_id']}", help="íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°"):
                                        st.session_state[f"show_preview_{file_row['file_id']}"] = not st.session_state.get(f"show_preview_{file_row['file_id']}", False)
                                
                                # íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
                                if st.session_state.get(f"show_preview_{file_row['file_id']}", False):
                                    st.subheader("ğŸ“– íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°")
                                    
                                    # ì›ë³¸ íŒŒì¼ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                                    file_binary = get_file_binary_data(file_row['file_id'])
                                    
                                    if file_binary:
                                        # ë””ë²„ê¹… ì •ë³´ í‘œì‹œ (íŒŒì¼ íƒ€ì… í™•ì¸ìš©)
                                        st.caption(f"ğŸ” íŒŒì¼ ì •ë³´: íƒ€ì…={file_binary['file_type']}, ì´ë¦„={file_binary['filename']}")
                                        
                                        # íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° í•¨ìˆ˜ í˜¸ì¶œ
                                        preview_success = display_file_preview(file_binary, file_binary['file_type'], file_binary['filename'])
                                        
                                        # ë¯¸ë¦¬ë³´ê¸°ê°€ ì‹¤íŒ¨í•˜ê±°ë‚˜ ì§€ì›í•˜ì§€ ì•ŠëŠ” í˜•ì‹ì¸ ê²½ìš° ê¸°ë³¸ ì •ë³´ í‘œì‹œ
                                        if not preview_success:
                                            st.info(f"íŒŒì¼ í˜•ì‹: {file_binary['file_type']}")
                                            st.info(f"íŒŒì¼ í¬ê¸°: {file_row['file_size']:,} bytes")
                                    else:
                                        st.error("íŒŒì¼ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                                    
                                    # ë¯¸ë¦¬ë³´ê¸° ìˆ¨ê¸°ê¸° ë²„íŠ¼
                                    if st.button("ğŸ™ˆ ë¯¸ë¦¬ë³´ê¸° ìˆ¨ê¸°ê¸°", key=f"hide_preview_{file_row['file_id']}"):
                                        st.session_state[f"show_preview_{file_row['file_id']}"] = False
                                        st.rerun()
                
            else:
                st.info("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.")

if __name__ == "__main__":
    main() 