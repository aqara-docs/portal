import streamlit as st
import os
from datetime import datetime
import time
import random
from dotenv import load_dotenv
from openai import OpenAI
import anthropic
from langchain_anthropic import ChatAnthropic
import json
import asyncio
import threading
from concurrent.futures import ThreadPoolExecutor, as_completed

# RAG ê´€ë ¨ import ì¶”ê°€
import mysql.connector
import pandas as pd
from sqlalchemy import create_engine
import requests
from bs4 import BeautifulSoup
from urllib.parse import urljoin, urlparse
from urllib.robotparser import RobotFileParser
import nltk
import logging
from pathlib import Path
import hashlib

# ë²¡í„° ë°ì´í„°ë² ì´ìŠ¤ ê´€ë ¨ import
from langchain.embeddings import OpenAIEmbeddings
from langchain.vectorstores.faiss import FAISS
from langchain.text_splitter import CharacterTextSplitter
from langchain.document_loaders import UnstructuredFileLoader
from langchain.schema import Document

# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

# í‘œì¤€í™”ëœ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í•¨ìˆ˜
def connect_to_db():
    """ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°"""
    try:
        conn = mysql.connector.connect(
            host=os.getenv('SQL_HOST'),
            user=os.getenv('SQL_USER'),
            password=os.getenv('SQL_PASSWORD'),
            database=os.getenv('SQL_DATABASE_NEWBIZ'),
            charset='utf8mb4',
            collation='utf8mb4_unicode_ci'
        )
        return conn
    except mysql.connector.Error as err:
        st.error(f"ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì˜¤ë¥˜: {err}")
        return None

# ë¡œê¹… ì„¤ì •
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# NLTK ì„¤ì •
try:
    nltk.download('punkt', quiet=True)
except:
    pass

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(
    page_title="ğŸ¢ ê°€ìƒíšŒì‚¬ C-Level ë©€í‹°ì—ì´ì „íŠ¸ + RAG",
    page_icon="ğŸ¢",
    layout="wide"
)

# ìŠ¤íƒ€ì¼ë§
st.markdown("""
<style>
.persona-card {
    background: linear-gradient(145deg, #f0f2f6, #ffffff);
    border-radius: 15px;
    padding: 20px;
    margin: 10px 0;
    box-shadow: 5px 5px 15px #d1d9e6, -5px -5px 15px #ffffff;
    border-left: 5px solid #0066cc;
}

.persona-header {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
}

.persona-emoji {
    font-size: 2.5rem;
    margin-right: 15px;
}

.persona-title {
    color: #0066cc;
    font-size: 1.3rem;
    font-weight: bold;
    margin: 0;
}

.persona-subtitle {
    color: #666;
    font-size: 0.9rem;
    margin: 0;
}

.result-container {
    background: linear-gradient(145deg, #f8f9fa, #ffffff);
    border-radius: 12px;
    padding: 20px;
    margin: 15px 0;
    border-left: 4px solid #28a745;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.result-container h4 {
    color: #28a745;
    margin: 0;
    font-size: 1.1rem;
}

.ceo-final {
    background: linear-gradient(145deg, #fff3cd, #ffeaa7);
    border-left: 4px solid #f39c12;
    border-radius: 15px;
    padding: 20px;
    margin: 20px 0;
    box-shadow: 0 4px 15px rgba(243, 156, 18, 0.2);
}

.progress-indicator {
    background: linear-gradient(145deg, #0066cc, #0052a3);
    color: white;
    text-align: center;
    padding: 15px 20px;
    border-radius: 12px;
    margin: 15px 0;
    box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);
    border: none;
}

.progress-indicator strong {
    font-size: 1.1rem;
    font-weight: 600;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
}

.progress-section {
    background: #f8f9fa;
    border-radius: 15px;
    padding: 25px;
    margin: 20px 0;
    border: 2px solid #e9ecef;
}

.progress-section h2 {
    color: #0066cc;
    text-align: center;
    margin-bottom: 20px;
    font-size: 1.5rem;
}

.analysis-complete {
    background: linear-gradient(145deg, #d4edda, #c3e6cb);
    border: 2px solid #28a745;
    border-radius: 12px;
    padding: 15px;
    margin: 10px 0;
    text-align: center;
}

.analysis-complete h4 {
    color: #155724;
    margin: 0;
    font-size: 1.1rem;
}

.ceo-synthesis {
    background: linear-gradient(145deg, #ffeaa7, #fdcb6e);
    border: 2px solid #f39c12;
    border-radius: 12px;
    padding: 20px;
    margin: 15px 0;
    text-align: center;
}

.ceo-synthesis strong {
    color: #8e5b00;
    font-size: 1.2rem;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
}

.main-title {
    text-align: center;
    color: #0066cc;
    margin-bottom: 10px;
}

.main-subtitle {
    text-align: center;
    color: #666;
    font-size: 1.1rem;
    margin-bottom: 30px;
}
</style>
""", unsafe_allow_html=True)

# C-Level í˜ë¥´ì†Œë‚˜ ì •ì˜
PERSONAS = {
    "CTO": {
        "name": "Chief Technology Officer",
        "emoji": "ğŸ’»",
        "role": "ê¸°ìˆ  ì „ëµ ë° í˜ì‹  ì±…ì„ì",
        "expertise": "ê¸°ìˆ  ì•„í‚¤í…ì²˜, ê°œë°œ ì „ëµ, í˜ì‹ , ë””ì§€í„¸ ì „í™˜",
        "perspective": "ê¸°ìˆ ì  íƒ€ë‹¹ì„±, êµ¬í˜„ ê°€ëŠ¥ì„±, ê¸°ìˆ  íŠ¸ë Œë“œ, ë³´ì•ˆ, í™•ì¥ì„±ì„ ì¤‘ì‹¬ìœ¼ë¡œ ë¶„ì„",
        "system_prompt": """ë‹¹ì‹ ì€ 15ë…„ ì´ìƒì˜ ê²½í—˜ì„ ê°€ì§„ ì„¸ê³„ì  ìˆ˜ì¤€ì˜ CTO(Chief Technology Officer)ì…ë‹ˆë‹¤.

ã€ì „ë¬¸ ì˜ì—­ã€‘
- ì—”í„°í”„ë¼ì´ì¦ˆ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ì„¤ê³„ ë° ìµœì í™”
- í´ë¼ìš°ë“œ ë„¤ì´í‹°ë¸Œ, ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤, DevOps/MLOps ì „ëµ
- AI/ML, ë¸”ë¡ì²´ì¸, IoT ë“± ìµœì‹  ê¸°ìˆ  ë„ì… ë° í™œìš©
- ì‚¬ì´ë²„ë³´ì•ˆ, ë°ì´í„° ê±°ë²„ë„ŒìŠ¤, ê·œì • ì¤€ìˆ˜
- ê¸°ìˆ íŒ€ ì¡°ì§ ê´€ë¦¬ ë° ê°œë°œ ë¬¸í™” í˜ì‹ 
- ê¸°ìˆ  íˆ¬ì ROI ë¶„ì„ ë° ìš°ì„ ìˆœìœ„ ì„¤ì •

ã€ë¶„ì„ ìŠ¤íƒ€ì¼ã€‘
1. ê¸°ìˆ ì  íƒ€ë‹¹ì„±ì„ ìˆ˜ì¹˜ì™€ êµ¬ì²´ì  ê·¼ê±°ë¡œ ì…ì¦
2. êµ¬í˜„ ë‹¨ê³„ë³„ ì„¸ë¶€ ê³„íšê³¼ ë¦¬ì†ŒìŠ¤ ìš”êµ¬ì‚¬í•­ ëª…ì‹œ
3. ê¸°ìˆ  ë¦¬ìŠ¤í¬ì™€ ëŒ€ì•ˆ ì†”ë£¨ì…˜ì„ ë‹¤ê°ë„ë¡œ ê²€í† 
4. í™•ì¥ì„±ê³¼ ìœ ì§€ë³´ìˆ˜ì„±ì„ ê³ ë ¤í•œ ì¥ê¸°ì  ê´€ì  ì œì‹œ
5. ë¹„ìš© íš¨ìœ¨ì„±ê³¼ ì„±ëŠ¥ ìµœì í™” ë°©ì•ˆ êµ¬ì²´í™”
6. ìµœì‹  ê¸°ìˆ  íŠ¸ë Œë“œì™€ ì—…ê³„ ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤ ì ìš©

ã€ë¦¬í¬íŠ¸ ìš”êµ¬ì‚¬í•­ã€‘
- ê¸°ìˆ  ì†”ë£¨ì…˜ì€ ë°˜ë“œì‹œ êµ¬ì²´ì ì¸ ë„êµ¬/í”„ë ˆì„ì›Œí¬ ëª…ì‹œ
- êµ¬í˜„ ì¼ì •, ì¸ë ¥, ì˜ˆì‚°ì„ í¬í•¨í•œ ìƒì„¸ ì‹¤í–‰ ê³„íš ì œê³µ
- ê¸°ìˆ ì  ìœ„í—˜ ìš”ì†Œì™€ ì™„í™” ì „ëµì„ ì„¸ë¶€ì ìœ¼ë¡œ ë¶„ì„
- ì„±ëŠ¥ ì§€í‘œ(KPI)ì™€ ëª¨ë‹ˆí„°ë§ ë°©ì•ˆì„ ëª…í™•íˆ ì œì‹œ
- ë‹¤ë¥¸ ë¶€ì„œì™€ì˜ ê¸°ìˆ ì  ì—°ë™ ë°©ì•ˆì„ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…"""
    },
    "CSO_Strategy": {
        "name": "Chief Strategy Officer",
        "emoji": "ğŸ¯",
        "role": "ì „ëµ ê¸°íš ë° ì‚¬ì—… ê°œë°œ ì±…ì„ì",
        "expertise": "ì‚¬ì—… ì „ëµ, ì‹œì¥ ë¶„ì„, ê²½ìŸ ë¶„ì„, ì„±ì¥ ì „ëµ",
        "perspective": "ì‹œì¥ ê¸°íšŒ, ê²½ìŸ ìš°ìœ„, ì„±ì¥ ì ì¬ë ¥, ë¦¬ìŠ¤í¬ ë¶„ì„ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì „ëµì  ê´€ì  ì œì‹œ",
        "system_prompt": """ë‹¹ì‹ ì€ ê¸€ë¡œë²Œ ì»¨ì„¤íŒ… ê²½í—˜ê³¼ ë‹¤ì–‘í•œ ì‚°ì—… ì „ë¬¸ì„±ì„ ë³´ìœ í•œ ìµœê³  ìˆ˜ì¤€ì˜ CSO(Chief Strategy Officer)ì…ë‹ˆë‹¤.

ã€ì „ë¬¸ ì˜ì—­ã€‘
- ì‹œì¥ ë™í–¥ ë¶„ì„ ë° ê¸°íšŒ ë°œêµ´ (TAM, SAM, SOM ë¶„ì„)
- ê²½ìŸì‚¬ ë¶„ì„ ë° í¬ì§€ì…”ë‹ ì „ëµ ìˆ˜ë¦½
- ì‚¬ì—… ëª¨ë¸ í˜ì‹  ë° ìˆ˜ìµ ë‹¤ê°í™” ë°©ì•ˆ
- M&A, íŒŒíŠ¸ë„ˆì‹­, ì „ëµì  ì œíœ´ ê¸°íš
- ESG ê²½ì˜ ë° ì§€ì†ê°€ëŠ¥ì„± ì „ëµ
- ê¸€ë¡œë²Œ ì‹œì¥ ì§„ì¶œ ë° í˜„ì§€í™” ì „ëµ

ã€ë¶„ì„ ìŠ¤íƒ€ì¼ã€‘
1. ì •ëŸ‰ì  ì‹œì¥ ë°ì´í„°ì™€ ì •ì„±ì  íŠ¸ë Œë“œ ë¶„ì„ì„ ì¢…í•©
2. 3-5ë…„ ì¤‘ì¥ê¸° ì‹œë‚˜ë¦¬ì˜¤ ê¸°ë°˜ ì „ëµ ë¡œë“œë§µ ì œì‹œ
3. ê²½ìŸ ìš°ìœ„ í™•ë³´ë¥¼ ìœ„í•œ ì°¨ë³„í™” ì „ëµ êµ¬ì²´í™”
4. ë¦¬ìŠ¤í¬ ë§¤íŠ¸ë¦­ìŠ¤ì™€ ëŒ€ì‘ ì‹œë‚˜ë¦¬ì˜¤ ë‹¤ê°ë„ ê²€í† 
5. ì¬ë¬´ì  ì„íŒ©íŠ¸ì™€ ì „ëµì  ê°€ì¹˜ë¥¼ ê· í˜• ìˆê²Œ í‰ê°€
6. ì‹¤í–‰ ê°€ëŠ¥ì„±ê³¼ ì¡°ì§ ì—­ëŸ‰ì„ ê³ ë ¤í•œ ìš°ì„ ìˆœìœ„ ì„¤ì •

ã€ë¦¬í¬íŠ¸ ìš”êµ¬ì‚¬í•­ã€‘
- ì‹œì¥ í¬ê¸°, ì„±ì¥ë¥ , ê³ ê° ì„¸ê·¸ë¨¼íŠ¸ë¥¼ ìˆ˜ì¹˜ë¡œ ì •ëŸ‰í™”
- ê²½ìŸì‚¬ ëŒ€ë¹„ ìš°ìœ„/ì—´ìœ„ ìš”ì†Œë¥¼ ë§¤íŠ¸ë¦­ìŠ¤ë¡œ ë¹„êµ ë¶„ì„
- ì „ëµì  ì˜µì…˜ë³„ ROI, NPV, Payback Period ì‚°ì¶œ
- ë¦¬ìŠ¤í¬ ìš”ì¸ë³„ ë°œìƒ í™•ë¥ ê³¼ ì„íŒ©íŠ¸ í¬ê¸°ë¥¼ ì •ëŸ‰í™”
- ë‹¨ê³„ë³„ ë§ˆì¼ìŠ¤í†¤ê³¼ ì„±ê³¼ ì§€í‘œ(KPI)ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ì •
- ì¡°ì§ ì—­ëŸ‰ Gapê³¼ ë³´ì™„ ë°©ì•ˆì„ ìƒì„¸íˆ ì œì‹œ"""
    },
    "CMO": {
        "name": "Chief Marketing Officer",
        "emoji": "ğŸ“¢",
        "role": "ë§ˆì¼€íŒ… ë° ë¸Œëœë“œ ì „ëµ ì±…ì„ì",
        "expertise": "ë¸Œëœë“œ ì „ëµ, ê³ ê° ê²½í—˜, ë””ì§€í„¸ ë§ˆì¼€íŒ…, ì‹œì¥ ì¡°ì‚¬",
        "perspective": "ê³ ê° ë‹ˆì¦ˆ, ë¸Œëœë“œ í¬ì§€ì…”ë‹, ë§ˆì¼€íŒ… ì±„ë„, ê³ ê° ê²½í—˜ì„ ì¤‘ì‹¬ìœ¼ë¡œ ë¶„ì„",
        "system_prompt": """ë‹¹ì‹ ì€ ë””ì§€í„¸ ë§ˆì¼€íŒ…ê³¼ ë¸Œëœë“œ ì „ëµ ë¶„ì•¼ì˜ ì„¸ê³„ì  ì „ë¬¸ê°€ì¸ CMO(Chief Marketing Officer)ì…ë‹ˆë‹¤.

ã€ì „ë¬¸ ì˜ì—­ã€‘
- ë¸Œëœë“œ í¬ì§€ì…”ë‹ ë° ì•„ì´ë´í‹°í‹° êµ¬ì¶• ì „ëµ
- ì˜´ë‹ˆì±„ë„ ê³ ê° ì—¬ì • ì„¤ê³„ ë° ìµœì í™”
- ë””ì§€í„¸ ë§ˆì¼€íŒ… (SEO/SEM, SNS, ì½˜í…ì¸ , ì¸í”Œë£¨ì–¸ì„œ)
- ë§ˆì¼€íŒ… ìë™í™” ë° ê°œì¸í™” ìº í˜ì¸ êµ¬ì¶•
- ê³ ê° ë°ì´í„° ë¶„ì„ ë° ì„¸ê·¸ë©˜í…Œì´ì…˜ ì „ëµ
- ë§ˆì¼€íŒ… ROI ì¸¡ì • ë° í¼í¬ë¨¼ìŠ¤ ìµœì í™”

ã€ë¶„ì„ ìŠ¤íƒ€ì¼ã€‘
1. ê³ ê° í˜ë¥´ì†Œë‚˜ë³„ ë‹ˆì¦ˆì™€ í–‰ë™ íŒ¨í„´ì„ ë°ì´í„°ë¡œ ë¶„ì„
2. ë¸Œëœë“œ ì¸ì§€ë„, ì„ í˜¸ë„, ì¶©ì„±ë„ ì§€í‘œë¥¼ ì •ëŸ‰í™”
3. ë§ˆì¼€íŒ… í¼ë„ë³„ ì „í™˜ìœ¨ê³¼ ê°œì„  í¬ì¸íŠ¸ êµ¬ì²´í™”
4. ì±„ë„ë³„ ROAS, CAC, LTV ë“± í•µì‹¬ ì§€í‘œ ì‚°ì¶œ
5. ê²½ìŸì‚¬ ë§ˆì¼€íŒ… ì „ëµ ë²¤ì¹˜ë§ˆí‚¹ ë° ì°¨ë³„í™” ë°©ì•ˆ ì œì‹œ
6. ì°½ì˜ì  ì•„ì´ë””ì–´ì™€ ë°ì´í„° ê¸°ë°˜ ì ‘ê·¼ë²•ì˜ ê· í˜•

ã€ë¦¬í¬íŠ¸ ìš”êµ¬ì‚¬í•­ã€‘
- íƒ€ê²Ÿ ê³ ê° ì„¸ê·¸ë¨¼íŠ¸ë³„ í¬ê¸°ì™€ íŠ¹ì„±ì„ êµ¬ì²´ì ìœ¼ë¡œ ë¶„ì„
- ë¸Œëœë“œ í¬ì§€ì…”ë‹ ë§µê³¼ ê²½ìŸì‚¬ ëŒ€ë¹„ ì°¨ë³„í™” í¬ì¸íŠ¸ ì‹œê°í™”
- ë§ˆì¼€íŒ… ì±„ë„ë³„ ì˜ˆì‚° ë°°ë¶„ê³¼ ê¸°ëŒ€ ì„±ê³¼ë¥¼ ì •ëŸ‰í™”
- ìº í˜ì¸ë³„ KPI ëª©í‘œì¹˜ì™€ ì¸¡ì • ë°©ë²•ì„ ëª…í™•íˆ ì„¤ì •
- ê³ ê° ìƒì• ê°€ì¹˜(CLV) í–¥ìƒì„ ìœ„í•œ êµ¬ì²´ì  ì•¡ì…˜ í”Œëœ ì œì‹œ
- ë¸Œëœë“œ ê°€ì¹˜ ì¦ëŒ€ë¥¼ ìœ„í•œ ì¥ê¸°ì  ë§ˆì¼€íŒ… ë¡œë“œë§µ ìˆ˜ë¦½"""
    },
    "CFO": {
        "name": "Chief Financial Officer",
        "emoji": "ğŸ’°",
        "role": "ì¬ë¬´ ì „ëµ ë° ë¦¬ìŠ¤í¬ ê´€ë¦¬ ì±…ì„ì",
        "expertise": "ì¬ë¬´ ë¶„ì„, íˆ¬ì í‰ê°€, ë¦¬ìŠ¤í¬ ê´€ë¦¬, ìˆ˜ìµì„± ë¶„ì„",
        "perspective": "ì¬ë¬´ì  íƒ€ë‹¹ì„±, íˆ¬ì ìˆ˜ìµë¥ , ë¹„ìš© íš¨ìœ¨ì„±, ë¦¬ìŠ¤í¬ ê´€ë¦¬ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ë¶„ì„",
        "system_prompt": """ë‹¹ì‹ ì€ ê¸€ë¡œë²Œ ê¸°ì—…ì˜ ì¬ë¬´ ì „ëµì„ ì´ëŒì–´ì˜¨ ìµœê³  ìˆ˜ì¤€ì˜ CFO(Chief Financial Officer)ì…ë‹ˆë‹¤.

ã€ì „ë¬¸ ì˜ì—­ã€‘
- ì¬ë¬´ì œí‘œ ë¶„ì„ ë° ì¬ë¬´ ëª¨ë¸ë§ (DCF, LBO, ë¯¼ê°ë„ ë¶„ì„)
- íˆ¬ì ì˜ì‚¬ê²°ì • ë° ìë³¸ ë°°ë¶„ ìµœì í™”
- ë¦¬ìŠ¤í¬ ê´€ë¦¬ ë° ë‚´ë¶€í†µì œ ì‹œìŠ¤í…œ êµ¬ì¶•
- ìê¸ˆ ì¡°ë‹¬ ì „ëµ (ì£¼ì‹, ì±„ê¶Œ, ì€í–‰ ëŒ€ì¶œ, ëŒ€ì•ˆ ê¸ˆìœµ)
- ì„¸ë¬´ ìµœì í™” ë° ê·œì • ì¤€ìˆ˜ ê´€ë¦¬
- M&A ì¬ë¬´ ì‹¤ì‚¬ ë° í†µí•© í›„ ì‹œë„ˆì§€ ì°½ì¶œ

ã€ë¶„ì„ ìŠ¤íƒ€ì¼ã€‘
1. ì¬ë¬´ ì§€í‘œë¥¼ ë‹¤ê°ë„ë¡œ ë¶„ì„í•˜ì—¬ í˜„í™©ì„ ì •í™•íˆ ì§„ë‹¨
2. NPV, IRR, ROIC ë“±ì„ í™œìš©í•œ íˆ¬ì íƒ€ë‹¹ì„± ì •ëŸ‰ í‰ê°€
3. ì‹œë‚˜ë¦¬ì˜¤ë³„ ì¬ë¬´ ì˜í–¥ë„ì™€ ë¯¼ê°ë„ ë¶„ì„ ìˆ˜í–‰
4. í˜„ê¸ˆíë¦„ ì˜ˆì¸¡ê³¼ ìœ ë™ì„± ë¦¬ìŠ¤í¬ ê´€ë¦¬ ë°©ì•ˆ ì œì‹œ
5. ë¹„ìš© êµ¬ì¡° ìµœì í™”ì™€ ìˆ˜ìµì„± ê°œì„  ë°©ì•ˆ ë„ì¶œ
6. ì£¼ì£¼ê°€ì¹˜ ê·¹ëŒ€í™”ë¥¼ ìœ„í•œ ì¬ë¬´ ì „ëµ ìˆ˜ë¦½

ã€ë¦¬í¬íŠ¸ ìš”êµ¬ì‚¬í•­ã€‘
- ì£¼ìš” ì¬ë¬´ ë¹„ìœ¨ê³¼ ì—…ê³„ ë²¤ì¹˜ë§ˆí¬ ë¹„êµ ë¶„ì„ ì œì‹œ
- íˆ¬ìì•ˆë³„ ì¬ë¬´ì  ìˆ˜ìµë¥ ê³¼ íšŒìˆ˜ ê¸°ê°„ì„ ì •í™•íˆ ê³„ì‚°
- ë¦¬ìŠ¤í¬ ìš”ì¸ë³„ ì¬ë¬´ì  ì„íŒ©íŠ¸ë¥¼ ì •ëŸ‰í™”í•˜ì—¬ ë¶„ì„
- í˜„ê¸ˆíë¦„ ì˜ˆì¸¡ê³¼ ìê¸ˆ ì¡°ë‹¬ ê³„íšì„ êµ¬ì²´ì ìœ¼ë¡œ ìˆ˜ë¦½
- ë¹„ìš© ì ˆê° ëª©í‘œì™€ ì‹¤í–‰ ë°©ì•ˆì„ ì„¸ë¶€ì ìœ¼ë¡œ ì œì‹œ
- ì£¼ì£¼ ë° ì´í•´ê´€ê³„ì ëŒ€ìƒ ì¬ë¬´ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ì „ëµ í¬í•¨"""
    },
    "CSO_Sales": {
        "name": "Chief Sales Officer",
        "emoji": "ğŸ¤",
        "role": "ì˜ì—… ì „ëµ ë° ê³ ê° ê´€ê³„ ì±…ì„ì",
        "expertise": "ì˜ì—… ì „ëµ, ê³ ê° ê´€ê³„ ê´€ë¦¬, ì‹œì¥ ê°œë°œ, íŒŒíŠ¸ë„ˆì‹­",
        "perspective": "ì˜ì—… íš¨ìœ¨ì„±, ê³ ê° ë§Œì¡±ë„, ì‹œì¥ í™•ëŒ€, ìˆ˜ìµ ì°½ì¶œì„ ì¤‘ì‹¬ìœ¼ë¡œ ë¶„ì„",
        "system_prompt": """ë‹¹ì‹ ì€ B2B/B2C ì˜ì—… ì „ëµê³¼ ê³ ê° ê´€ê³„ ê´€ë¦¬ ë¶„ì•¼ì˜ ìµœê³  ì „ë¬¸ê°€ì¸ CSO(Chief Sales Officer)ì…ë‹ˆë‹¤.

ã€ì „ë¬¸ ì˜ì—­ã€‘
- ì„¸ì¼ì¦ˆ í”„ë¡œì„¸ìŠ¤ ìµœì í™” ë° ì˜ì—… ìƒì‚°ì„± í–¥ìƒ
- CRM ì‹œìŠ¤í…œ êµ¬ì¶• ë° ê³ ê° ë°ì´í„° ë¶„ì„ í™œìš©
- ì˜ì—…íŒ€ ì¡°ì§ ì„¤ê³„ ë° ì„±ê³¼ ê´€ë¦¬ ì²´ê³„ êµ¬ì¶•
- ì£¼ìš” ê³ ê°(Key Account) ê´€ë¦¬ ë° ê´€ê³„ ì‹¬í™” ì „ëµ
- íŒŒíŠ¸ë„ˆ ì±„ë„ ê°œë°œ ë° í˜‘ë ¥ ê´€ê³„ ê°•í™”
- ì˜ì—… ì˜ˆì¸¡ ì •í™•ë„ í–¥ìƒ ë° íŒŒì´í”„ë¼ì¸ ê´€ë¦¬

ã€ë¶„ì„ ìŠ¤íƒ€ì¼ã€‘
1. ì˜ì—… í¼ë„ë³„ ì „í™˜ìœ¨ê³¼ ë³‘ëª© êµ¬ê°„ì„ ë°ì´í„°ë¡œ ë¶„ì„
2. ê³ ê°ë³„/ì œí’ˆë³„ ìˆ˜ìµì„±ê³¼ ì„±ì¥ ê°€ëŠ¥ì„±ì„ ì •ëŸ‰ í‰ê°€
3. ì˜ì—… ì‚¬ì´í´ ë‹¨ì¶•ê³¼ ì„±ì•½ë¥  í–¥ìƒ ë°©ì•ˆì„ êµ¬ì²´í™”
4. ì˜ì—…íŒ€ ì—­ëŸ‰ê³¼ ì‹œì¥ ì»¤ë²„ë¦¬ì§€ë¥¼ ë§¤íŠ¸ë¦­ìŠ¤ë¡œ ë¶„ì„
5. ê²½ìŸì‚¬ ì˜ì—… ì „ëµ ë²¤ì¹˜ë§ˆí‚¹ ë° ì°¨ë³„í™” í¬ì¸íŠ¸ ë„ì¶œ
6. ë‹¨ê¸° ì„±ê³¼ì™€ ì¥ê¸° ê´€ê³„ êµ¬ì¶•ì˜ ê· í˜•ì  ëª¨ìƒ‰

ã€ë¦¬í¬íŠ¸ ìš”êµ¬ì‚¬í•­ã€‘
- ì‹œì¥ë³„/ì œí’ˆë³„ ì˜ì—… ê¸°íšŒ í¬ê¸°ì™€ ìš°ì„ ìˆœìœ„ë¥¼ ì •ëŸ‰í™”
- ì˜ì—…íŒ€ ì„±ê³¼ ì§€í‘œ(KPI)ì™€ ê°œì„  ëª©í‘œì¹˜ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ì •
- ê³ ê°ë³„ ë§¤ì¶œ ê¸°ì—¬ë„ì™€ ì„±ì¥ ì ì¬ë ¥ì„ ë§¤íŠ¸ë¦­ìŠ¤ë¡œ ë¶„ì„
- ì˜ì—… í”„ë¡œì„¸ìŠ¤ ê°œì„ ì•ˆê³¼ ê¸°ëŒ€ íš¨ê³¼ë¥¼ ë‹¨ê³„ë³„ë¡œ ì œì‹œ
- íŒŒíŠ¸ë„ˆ ì±„ë„ ì „ëµê³¼ ìˆ˜ìµ ë¶„ë°° ëª¨ë¸ì„ ìƒì„¸íˆ ì„¤ê³„
- ê³ ê° ë§Œì¡±ë„ í–¥ìƒê³¼ ì¶©ì„±ë„ ì œê³ ë¥¼ ìœ„í•œ ì•¡ì…˜ í”Œëœ ìˆ˜ë¦½"""
    },
    "CIO": {
        "name": "Chief Information Officer",
        "emoji": "ğŸ”",
        "role": "ì •ë³´ì‹œìŠ¤í…œ ë° ë°ì´í„° ì „ëµ ì±…ì„ì",
        "expertise": "ì •ë³´ì‹œìŠ¤í…œ, ë°ì´í„° ê´€ë¦¬, IT ê±°ë²„ë„ŒìŠ¤, ë””ì§€í„¸ ì¸í”„ë¼",
        "perspective": "ì‹œìŠ¤í…œ íš¨ìœ¨ì„±, ë°ì´í„° í™œìš©, ë³´ì•ˆ, IT ê±°ë²„ë„ŒìŠ¤ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ë¶„ì„",
        "system_prompt": """ë‹¹ì‹ ì€ ë””ì§€í„¸ ì „í™˜ê³¼ ì •ë³´ ì „ëµ ë¶„ì•¼ì˜ ì„¸ê³„ì  ì „ë¬¸ê°€ì¸ CIO(Chief Information Officer)ì…ë‹ˆë‹¤.

ã€ì „ë¬¸ ì˜ì—­ã€‘
- ì—”í„°í”„ë¼ì´ì¦ˆ IT ì•„í‚¤í…ì²˜ ì„¤ê³„ ë° ê±°ë²„ë„ŒìŠ¤ êµ¬ì¶•
- ë°ì´í„° ë ˆì´í¬/ì›¨ì–´í•˜ìš°ìŠ¤ êµ¬ì¶• ë° ë¶„ì„ í”Œë«í¼ ìš´ì˜
- ì •ë³´ë³´ì•ˆ ì „ëµ ìˆ˜ë¦½ ë° ì»´í”Œë¼ì´ì–¸ìŠ¤ ê´€ë¦¬
- IT ì„œë¹„ìŠ¤ ê´€ë¦¬(ITSM) ë° ìš´ì˜ íš¨ìœ¨ì„± ìµœì í™”
- ë””ì§€í„¸ ì›Œí¬í”Œë ˆì´ìŠ¤ êµ¬ì¶• ë° ì—…ë¬´ ìë™í™”
- IT ì˜ˆì‚° ê´€ë¦¬ ë° ROI ì¸¡ì • ì²´ê³„ êµ¬ì¶•

ã€ë¶„ì„ ìŠ¤íƒ€ì¼ã€‘
1. IT ì¸í”„ë¼ í˜„í™©ê³¼ ì„±ëŠ¥ ì§€í‘œë¥¼ ì •ëŸ‰ì ìœ¼ë¡œ ë¶„ì„
2. ë°ì´í„° í’ˆì§ˆê³¼ í™œìš©ë„ë¥¼ ì¸¡ì •í•˜ì—¬ ê°œì„  ë°©ì•ˆ ë„ì¶œ
3. ë³´ì•ˆ ìœ„í˜‘ê³¼ ì·¨ì•½ì ì„ ì²´ê³„ì ìœ¼ë¡œ í‰ê°€í•˜ê³  ëŒ€ì‘ì±… ìˆ˜ë¦½
4. IT íˆ¬ì ëŒ€ë¹„ ë¹„ì¦ˆë‹ˆìŠ¤ ê°€ì¹˜ ì°½ì¶œ íš¨ê³¼ë¥¼ ì •ëŸ‰í™”
5. ì‹œìŠ¤í…œ ê°„ ì—°ë™ì„±ê³¼ í™•ì¥ì„±ì„ ì•„í‚¤í…ì²˜ ê´€ì ì—ì„œ ê²€í† 
6. ì‚¬ìš©ì ê²½í—˜ê³¼ ì—…ë¬´ íš¨ìœ¨ì„± ê°œì„  íš¨ê³¼ë¥¼ ì¸¡ì •

ã€ë¦¬í¬íŠ¸ ìš”êµ¬ì‚¬í•­ã€‘
- IT ì‹œìŠ¤í…œë³„ ì„±ëŠ¥ ì§€í‘œì™€ ê°œì„  ëª©í‘œë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ì •
- ë°ì´í„° ê±°ë²„ë„ŒìŠ¤ ì²´ê³„ì™€ í’ˆì§ˆ ê´€ë¦¬ ë°©ì•ˆì„ ìƒì„¸íˆ ì œì‹œ
- ë³´ì•ˆ ë¦¬ìŠ¤í¬ ë§¤íŠ¸ë¦­ìŠ¤ì™€ ëŒ€ì‘ ìš°ì„ ìˆœìœ„ë¥¼ ëª…í™•íˆ ë¶„ì„
- IT íˆ¬ì ê³„íšê³¼ ê¸°ëŒ€ íš¨ê³¼ë¥¼ ë¹„ìš©-í¸ìµ ê´€ì ì—ì„œ í‰ê°€
- ì‹œìŠ¤í…œ í†µí•© ë° ì—…ê·¸ë ˆì´ë“œ ë¡œë“œë§µì„ ë‹¨ê³„ë³„ë¡œ ìˆ˜ë¦½
- ì¡°ì§ì˜ ë””ì§€í„¸ ì„±ìˆ™ë„ì™€ í–¥í›„ ë°œì „ ë°©í–¥ì„ ì œì‹œ"""
    }
}

# CEO í˜ë¥´ì†Œë‚˜ (ì‚¬ìš©ì)
CEO_PERSONA = {
    "name": "Chief Executive Officer",
    "emoji": "ğŸ‘‘",
    "role": "ìµœê³ ê²½ì˜ì (ì‚¬ìš©ì í˜ë¥´ì†Œë‚˜)",
    "expertise": "ì¢…í•©ì  ê²½ì˜ íŒë‹¨, ì˜ì‚¬ê²°ì •, ë¦¬ë”ì‹­, ë¹„ì „ ì œì‹œ",
    "perspective": "ì „ì²´ì  ê´€ì ì—ì„œ ì¢…í•© ë¶„ì„í•˜ê³  ìµœì¢… ì˜ì‚¬ê²°ì • ì§€ì›",
    "system_prompt": """ë‹¹ì‹ ì€ 20ë…„ ì´ìƒì˜ ê¸€ë¡œë²Œ ê¸°ì—… ê²½ì˜ ê²½í—˜ì„ ê°€ì§„ ì„¸ê³„ ìµœê³  ìˆ˜ì¤€ì˜ CEO(Chief Executive Officer)ì…ë‹ˆë‹¤.

ã€ì „ë¬¸ ì˜ì—­ã€‘
- ì „ì‚¬ ì „ëµ ìˆ˜ë¦½ ë° ì‹¤í–‰ ë¦¬ë”ì‹­
- ì´í•´ê´€ê³„ì ê´€ë¦¬ ë° ê¸°ì—… ê±°ë²„ë„ŒìŠ¤
- ì¡°ì§ ë³€í™” ê´€ë¦¬ ë° ë¬¸í™” í˜ì‹ 
- ìœ„ê¸° ê´€ë¦¬ ë° ë¦¬ìŠ¤í¬ ëŒ€ì‘ ì „ëµ
- ESG ê²½ì˜ ë° ì§€ì†ê°€ëŠ¥ì„± ë¦¬ë”ì‹­
- ê¸€ë¡œë²Œ ì‹œì¥ í™•ì¥ ë° M&A ì „ëµ

ã€ë¶„ì„ ìŠ¤íƒ€ì¼ã€‘
1. ê° C-Level ì„ì›ì§„ì˜ ì „ë¬¸ ë¶„ì„ì„ í†µí•©ì ìœ¼ë¡œ ê²€í† 
2. ì „ëµì  ìš°ì„ ìˆœìœ„ì™€ ì‹¤í–‰ ê°€ëŠ¥ì„±ì„ ê· í˜• ìˆê²Œ í‰ê°€
3. ë‹¨ê¸° ì„±ê³¼ì™€ ì¥ê¸° ë¹„ì „ì˜ ì¡°í™”ë¡œìš´ ë°©í–¥ì„± ì œì‹œ
4. ì´í•´ê´€ê³„ìë³„ ì˜í–¥ë„ì™€ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ì „ëµ ìˆ˜ë¦½
5. ì¡°ì§ ì—­ëŸ‰ê³¼ ìì› ì œì•½ì„ ê³ ë ¤í•œ í˜„ì‹¤ì  ì‹¤í–‰ ê³„íš
6. ì§€ì† ê°€ëŠ¥í•œ ì„±ì¥ê³¼ ì‚¬íšŒì  ê°€ì¹˜ ì°½ì¶œì˜ ê· í˜•ì  ëª¨ìƒ‰

ã€ìµœê³  ìˆ˜ì¤€ì˜ CEO ì¢…í•© ë¦¬í¬íŠ¸ ìš”êµ¬ì‚¬í•­ã€‘
- ê° ì„ì›ì§„ ë¶„ì„ì˜ í•µì‹¬ì„ ì²´ê³„ì ìœ¼ë¡œ í†µí•©í•˜ì—¬ ì œì‹œ
- ì „ëµì  ì˜ì‚¬ê²°ì •ì„ ìœ„í•œ ëª…í™•í•œ ìš°ì„ ìˆœìœ„ì™€ ê·¼ê±° ì œì‹œ
- ë‹¨ê³„ë³„ ì‹¤í–‰ ë¡œë“œë§µê³¼ ì±…ì„ ì£¼ì²´ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ì •
- ì„±ê³µ ì§€í‘œ(KPI)ì™€ ëª¨ë‹ˆí„°ë§ ì²´ê³„ë¥¼ ìƒì„¸íˆ ìˆ˜ë¦½
- ë¦¬ìŠ¤í¬ ì‹œë‚˜ë¦¬ì˜¤ì™€ ëŒ€ì‘ ì „ëµì„ ì¢…í•©ì ìœ¼ë¡œ ë¶„ì„
- ì¡°ì§ êµ¬ì„±ì›ê³¼ ì´í•´ê´€ê³„ìë¥¼ ìœ„í•œ ëª…í™•í•œ ë¹„ì „ê³¼ ë©”ì‹œì§€ ì œì‹œ
- ê²½ì˜ì§„ ì˜ì‚¬ê²°ì •ì„ ìœ„í•œ êµ¬ì²´ì ì¸ Action Itemsì™€ Timeline ì œê³µ
- íˆ¬ìì, ì„ì§ì›, ê³ ê°ì—ê²Œ ì „ë‹¬í•  í•µì‹¬ ë©”ì‹œì§€ í¬í•¨"""
}

# RAG ë°ì´í„° ì†ŒìŠ¤ ì„¤ì •
RAG_SOURCES = {
    "mysql": {
        "name": "MySQL ë°ì´í„°ë² ì´ìŠ¤",
        "emoji": "ğŸ—„ï¸",
        "description": "íšŒì‚¬ ë°ì´í„°ë² ì´ìŠ¤ì˜ ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ë¶„ì„ì— í™œìš©"
    },
    "website": {
        "name": "ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§",
        "emoji": "ğŸŒ", 
        "description": "ê´€ë ¨ ì›¹ì‚¬ì´íŠ¸ì˜ ìµœì‹  ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ì—¬ ë¶„ì„"
    },
    "files": {
        "name": "ë¬¸ì„œ íŒŒì¼",
        "emoji": "ğŸ“„",
        "description": "ì—…ë¡œë“œëœ ë¬¸ì„œë“¤ì˜ ë‚´ìš©ì„ ë¶„ì„ì— ë°˜ì˜"
    }
}

# ì§€ì›ë˜ëŠ” íŒŒì¼ í˜•ì‹
SUPPORTED_FILE_TYPES = {
    "txt": {"max_size_mb": 10, "description": "í…ìŠ¤íŠ¸ íŒŒì¼"},
    "md": {"max_size_mb": 10, "description": "ë§ˆí¬ë‹¤ìš´ íŒŒì¼"},
    "pdf": {"max_size_mb": 50, "description": "PDF ë¬¸ì„œ"},
    "docx": {"max_size_mb": 50, "description": "Word ë¬¸ì„œ"},
    "csv": {"max_size_mb": 20, "description": "CSV íŒŒì¼"},
    "json": {"max_size_mb": 20, "description": "JSON íŒŒì¼"}
}

# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
if 'messages' not in st.session_state:
    st.session_state.messages = []

if 'current_analysis' not in st.session_state:
    st.session_state.current_analysis = {}

if 'analysis_complete' not in st.session_state:
    st.session_state.analysis_complete = False

if 'selected_model' not in st.session_state:
    st.session_state.selected_model = 'claude-3-7-sonnet-latest'

# RAG ê´€ë ¨ ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
if 'rag_sources' not in st.session_state:
    st.session_state.rag_sources = []

if 'mysql_data' not in st.session_state:
    st.session_state.mysql_data = {}

if 'website_data' not in st.session_state:
    st.session_state.website_data = {}

if 'files_data' not in st.session_state:
    st.session_state.files_data = {}

# ==================== RAG ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ ====================

def validate_file(file):
    """íŒŒì¼ ìœ íš¨ì„± ê²€ì‚¬"""
    errors = []
    file_ext = file.name.split('.')[-1].lower()
    if file_ext not in SUPPORTED_FILE_TYPES:
        errors.append(f"ì§€ì›ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹: {file_ext}")
        return errors
    
    file_size_mb = file.size / (1024 * 1024)
    max_size = SUPPORTED_FILE_TYPES[file_ext]["max_size_mb"]
    if file_size_mb > max_size:
        errors.append(f"íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤: {file_size_mb:.1f}MB (ìµœëŒ€: {max_size}MB)")
    
    return errors

def test_mysql_connection():
    """MySQL ì—°ê²° í…ŒìŠ¤íŠ¸"""
    try:
        # í™˜ê²½ë³€ìˆ˜ í™•ì¸
        required_vars = ['SQL_USER', 'SQL_PASSWORD', 'SQL_HOST', 'SQL_DATABASE_NEWBIZ']
        if not all([os.getenv(var) for var in required_vars]):
            return False, "í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
        
        # í‘œì¤€í™”ëœ ì—°ê²° í•¨ìˆ˜ ì‚¬ìš©
        connection = connect_to_db()
        if connection and connection.is_connected():
            connection.close()
            return True, "ì—°ê²° ì„±ê³µ"
        else:
            return False, "ì—°ê²° ì‹¤íŒ¨"
    except Exception as e:
        return False, str(e)

def get_mysql_tables():
    """MySQL í…Œì´ë¸” ëª©ë¡ ê°€ì ¸ì˜¤ê¸°"""
    try:
        # í‘œì¤€í™”ëœ ì—°ê²° í•¨ìˆ˜ ì‚¬ìš©
        connection = connect_to_db()
        if not connection:
            return [], {}
        
        cursor = connection.cursor()
        cursor.execute("SHOW TABLES")
        tables = [table[0] for table in cursor.fetchall()]
        
        # í…Œì´ë¸” ì •ë³´ ìˆ˜ì§‘
        table_info = {}
        for table in tables:
            cursor.execute(f"SELECT COUNT(*) FROM {table}")
            row_count = cursor.fetchone()[0]
            cursor.execute(f"DESCRIBE {table}")
            columns = cursor.fetchall()
            table_info[table] = {
                'rows': row_count,
                'columns': len(columns),
                'column_details': [(col[0], col[1]) for col in columns]
            }
        
        connection.close()
        return tables, table_info
    except Exception as e:
        logger.error(f"MySQL í…Œì´ë¸” ì¡°íšŒ ì˜¤ë¥˜: {e}")
        return [], {}

def load_mysql_data(selected_tables):
    """ì„ íƒëœ MySQL í…Œì´ë¸” ë°ì´í„° ë¡œë“œ"""
    try:
        # í‘œì¤€í™”ëœ ì—°ê²° í•¨ìˆ˜ ì‚¬ìš©
        connection = connect_to_db()
        if not connection:
            return {}
        
        data_frames = {}
        for table in selected_tables:
            query = f"SELECT * FROM {table} LIMIT 1000"  # ì„±ëŠ¥ì„ ìœ„í•´ ì œí•œ
            df = pd.read_sql(query, connection)
            data_frames[table] = df
        
        connection.close()
        return data_frames
    except Exception as e:
        logger.error(f"MySQL ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: {e}")
        return {}

def scrape_website_simple(url, max_pages=5):
    """ê°„ë‹¨í•œ ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§"""
    try:
        if not url.startswith(('http://', 'https://')):
            url = 'https://' + url
        
        visited_urls = set()
        texts = []
        urls_to_visit = [url]
        
        session = requests.Session()
        session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        })
        
        page_count = 0
        while urls_to_visit and page_count < max_pages:
            current_url = urls_to_visit.pop(0)
            
            if current_url in visited_urls:
                continue
                
            try:
                response = session.get(current_url, timeout=10)
                response.raise_for_status()
                
                visited_urls.add(current_url)
                page_count += 1
                
                soup = BeautifulSoup(response.content, "html.parser")
                
                # ë¶ˆí•„ìš”í•œ íƒœê·¸ ì œê±°
                for tag in soup(["script", "style", "nav", "header", "footer"]):
                    tag.decompose()
                
                page_text = soup.get_text(separator="\n", strip=True)
                lines = [line.strip() for line in page_text.split('\n') if line.strip()]
                cleaned_text = '\n'.join(lines)
                
                if len(cleaned_text) > 200:
                    page_title = soup.title.string.strip() if soup.title and soup.title.string else 'No Title'
                    texts.append({
                        'content': cleaned_text,
                        'url': current_url,
                        'title': page_title
                    })
                
                # ìƒˆë¡œìš´ ë§í¬ ì°¾ê¸° (ê°™ì€ ë„ë©”ì¸ë§Œ)
                base_domain = urlparse(url).netloc
                if page_count < max_pages:
                    for link in soup.find_all("a", href=True)[:10]:
                        absolute_link = urljoin(current_url, link['href'])
                        parsed_link = urlparse(absolute_link)
                        
                        if (parsed_link.netloc == base_domain and 
                            absolute_link not in visited_urls and 
                            absolute_link not in urls_to_visit):
                            urls_to_visit.append(absolute_link)
                
                time.sleep(1)  # ì§€ì—°ì‹œê°„
                
            except Exception as e:
                logger.error(f"í˜ì´ì§€ í¬ë¡¤ë§ ì˜¤ë¥˜ {current_url}: {e}")
                continue
        
        return texts
        
    except Exception as e:
        logger.error(f"ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ì˜¤ë¥˜: {e}")
        return []

def process_files(files):
    """ì—…ë¡œë“œëœ íŒŒì¼ë“¤ ì²˜ë¦¬"""
    processed_files = []
    
    for file in files:
        try:
            # íŒŒì¼ ì €ì¥
            file_path = f"./temp_uploads/{file.name}"
            os.makedirs("./temp_uploads", exist_ok=True)
            
            with open(file_path, "wb") as f:
                f.write(file.read())
            
            # íŒŒì¼ ë‚´ìš© ì½ê¸°
            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    content = f.read()
            except UnicodeDecodeError:
                with open(file_path, 'r', encoding='latin-1') as f:
                    content = f.read()
            
            processed_files.append({
                'name': file.name,
                'content': content,
                'size': len(content)
            })
            
            # ì„ì‹œ íŒŒì¼ ì‚­ì œ
            os.remove(file_path)
            
        except Exception as e:
            logger.error(f"íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜ {file.name}: {e}")
            continue
    
    return processed_files

def create_rag_context():
    """RAG ì»¨í…ìŠ¤íŠ¸ ìƒì„±"""
    context_parts = []
    
    # MySQL ë°ì´í„° ì»¨í…ìŠ¤íŠ¸
    if st.session_state.mysql_data:
        mysql_context = "=== MySQL ë°ì´í„°ë² ì´ìŠ¤ ì •ë³´ ===\n"
        for table_name, df in st.session_state.mysql_data.items():
            mysql_context += f"\n[{table_name}] í…Œì´ë¸”:\n"
            mysql_context += f"- í–‰ ìˆ˜: {len(df):,}ê°œ\n"
            mysql_context += f"- ì»¬ëŸ¼: {', '.join(df.columns.tolist())}\n"
            
            # ìƒ˜í”Œ ë°ì´í„° (ìƒìœ„ 3í–‰)
            if len(df) > 0:
                mysql_context += "- ìƒ˜í”Œ ë°ì´í„°:\n"
                mysql_context += df.head(3).to_string(index=False)
                mysql_context += "\n"
        
        context_parts.append(mysql_context)
    
    # ì›¹ì‚¬ì´íŠ¸ ë°ì´í„° ì»¨í…ìŠ¤íŠ¸
    if st.session_state.website_data:
        website_context = "=== ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ì •ë³´ ===\n"
        for i, page_data in enumerate(st.session_state.website_data[:3]):  # ìƒìœ„ 3ê°œ í˜ì´ì§€ë§Œ
            website_context += f"\n[í˜ì´ì§€ {i+1}] {page_data['title']}\n"
            website_context += f"URL: {page_data['url']}\n"
            website_context += f"ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°: {page_data['content'][:500]}...\n"
        
        context_parts.append(website_context)
    
    # íŒŒì¼ ë°ì´í„° ì»¨í…ìŠ¤íŠ¸
    if st.session_state.files_data:
        files_context = "=== ì—…ë¡œë“œëœ ë¬¸ì„œ ì •ë³´ ===\n"
        for file_data in st.session_state.files_data:
            files_context += f"\n[ë¬¸ì„œ] {file_data['name']}\n"
            files_context += f"í¬ê¸°: {file_data['size']:,}ì\n"
            files_context += f"ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°: {file_data['content'][:500]}...\n"
        
        context_parts.append(files_context)
    
    return "\n\n".join(context_parts)

# AI ë¶„ì„ í•¨ìˆ˜
def get_ai_response(prompt, model_name, system_prompt=""):
    """AI ëª¨ë¸ë¡œë¶€í„° ì‘ë‹µì„ ë°›ëŠ” í•¨ìˆ˜"""
    try:
        if model_name.startswith('claude'):
            client = ChatAnthropic(
                model=model_name, 
                api_key=os.getenv('ANTHROPIC_API_KEY'), 
                temperature=0.7, 
                max_tokens=8192
            )
            response = client.invoke([
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": prompt}
            ])
            return response.content if hasattr(response, 'content') else str(response)
        else:
            openai_key = os.getenv('OPENAI_API_KEY')
            if not openai_key or openai_key.strip() == '' or openai_key == 'NA':
                raise ValueError("OpenAI API í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.")
            
            client = OpenAI(api_key=openai_key)
            response = client.chat.completions.create(
                model=model_name,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": prompt}
                ],
                max_tokens=8192,
                temperature=0.7
            )
            return response.choices[0].message.content
    except Exception as e:
        st.error(f"AI ì‘ë‹µ ì¤‘ ì˜¤ë¥˜: {str(e)}")
        return None

# C-Level í˜ë¥´ì†Œë‚˜ë³„ ë¶„ì„ ë‹¨ê³„ ì •ì˜
PERSONA_ANALYSIS_STAGES = {
    "CTO": [
        {"progress": 15, "message": "ê¸°ìˆ  ìš”êµ¬ì‚¬í•­ ë¶„ì„ ì¤‘..."},
        {"progress": 30, "message": "ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ê²€í†  ì¤‘..."},
        {"progress": 45, "message": "ê¸°ìˆ  íŠ¸ë Œë“œ ì¡°ì‚¬ ì¤‘..."},
        {"progress": 60, "message": "êµ¬í˜„ ê°€ëŠ¥ì„± í‰ê°€ ì¤‘..."},
        {"progress": 75, "message": "ë³´ì•ˆ ë° í™•ì¥ì„± ê²€í†  ì¤‘..."},
        {"progress": 90, "message": "ê¸°ìˆ  ì†”ë£¨ì…˜ ìˆ˜ë¦½ ì¤‘..."},
        {"progress": 100, "message": "ê¸°ìˆ  ë¶„ì„ ì™„ë£Œ!"}
    ],
    "CSO_Strategy": [
        {"progress": 12, "message": "ì‹œì¥ í™˜ê²½ ë¶„ì„ ì¤‘..."},
        {"progress": 28, "message": "ê²½ìŸì‚¬ í˜„í™© ì¡°ì‚¬ ì¤‘..."},
        {"progress": 42, "message": "ì„±ì¥ ê¸°íšŒ íƒìƒ‰ ì¤‘..."},
        {"progress": 58, "message": "ì „ëµì  ìœ„í—˜ í‰ê°€ ì¤‘..."},
        {"progress": 72, "message": "ì‚¬ì—… ëª¨ë¸ ê²€í†  ì¤‘..."},
        {"progress": 88, "message": "ì „ëµ ë°©í–¥ ìˆ˜ë¦½ ì¤‘..."},
        {"progress": 100, "message": "ì „ëµ ë¶„ì„ ì™„ë£Œ!"}
    ],
    "CMO": [
        {"progress": 18, "message": "ê³ ê° ë‹ˆì¦ˆ ë¶„ì„ ì¤‘..."},
        {"progress": 32, "message": "ë¸Œëœë“œ í¬ì§€ì…”ë‹ ê²€í†  ì¤‘..."},
        {"progress": 48, "message": "ë§ˆì¼€íŒ… ì±„ë„ ì¡°ì‚¬ ì¤‘..."},
        {"progress": 62, "message": "ê³ ê° ê²½í—˜ ì„¤ê³„ ì¤‘..."},
        {"progress": 78, "message": "ìº í˜ì¸ ì „ëµ ìˆ˜ë¦½ ì¤‘..."},
        {"progress": 92, "message": "ë§ˆì¼€íŒ… í”Œëœ ì™„ì„± ì¤‘..."},
        {"progress": 100, "message": "ë§ˆì¼€íŒ… ë¶„ì„ ì™„ë£Œ!"}
    ],
    "CFO": [
        {"progress": 10, "message": "ì¬ë¬´ ë°ì´í„° ìˆ˜ì§‘ ì¤‘..."},
        {"progress": 25, "message": "íˆ¬ì ìˆ˜ìµë¥  ê³„ì‚° ì¤‘..."},
        {"progress": 40, "message": "ë¦¬ìŠ¤í¬ ìš”ì¸ ë¶„ì„ ì¤‘..."},
        {"progress": 55, "message": "ë¹„ìš© êµ¬ì¡° ê²€í†  ì¤‘..."},
        {"progress": 70, "message": "ìˆ˜ìµì„± ëª¨ë¸ë§ ì¤‘..."},
        {"progress": 85, "message": "ì¬ë¬´ ì „ëµ ìˆ˜ë¦½ ì¤‘..."},
        {"progress": 100, "message": "ì¬ë¬´ ë¶„ì„ ì™„ë£Œ!"}
    ],
    "CSO_Sales": [
        {"progress": 16, "message": "ì‹œì¥ ê·œëª¨ ì¡°ì‚¬ ì¤‘..."},
        {"progress": 34, "message": "ê³ ê° ì„¸ê·¸ë¨¼íŠ¸ ë¶„ì„ ì¤‘..."},
        {"progress": 50, "message": "ì˜ì—… ì±„ë„ í‰ê°€ ì¤‘..."},
        {"progress": 66, "message": "íŒŒíŠ¸ë„ˆì‹­ ê¸°íšŒ íƒìƒ‰ ì¤‘..."},
        {"progress": 80, "message": "ì˜ì—… ì „ëµ ì„¤ê³„ ì¤‘..."},
        {"progress": 94, "message": "ì‹¤í–‰ ê³„íš ìˆ˜ë¦½ ì¤‘..."},
        {"progress": 100, "message": "ì˜ì—… ë¶„ì„ ì™„ë£Œ!"}
    ],
    "CIO": [
        {"progress": 14, "message": "ì‹œìŠ¤í…œ í˜„í™© ë¶„ì„ ì¤‘..."},
        {"progress": 29, "message": "ë°ì´í„° êµ¬ì¡° ê²€í†  ì¤‘..."},
        {"progress": 44, "message": "ë³´ì•ˆ ìš”êµ¬ì‚¬í•­ í‰ê°€ ì¤‘..."},
        {"progress": 59, "message": "IT ê±°ë²„ë„ŒìŠ¤ ì„¤ê³„ ì¤‘..."},
        {"progress": 74, "message": "ì¸í”„ë¼ ìµœì í™” ê³„íš ì¤‘..."},
        {"progress": 89, "message": "ì •ë³´ì „ëµ ìˆ˜ë¦½ ì¤‘..."},
        {"progress": 100, "message": "ì •ë³´ì‹œìŠ¤í…œ ë¶„ì„ ì™„ë£Œ!"}
    ]
}

# AI ë¶„ì„ í•¨ìˆ˜ (ê¸°ë³¸ ë²„ì „ - RAG ì—†ìŒ)
def analyze_with_persona_simple(user_query, persona_key, persona_info, custom_prompt="", model_name="claude-3-7-sonnet-latest"):
    """íŠ¹ì • í˜ë¥´ì†Œë‚˜ë¡œ ë¶„ì„ ìˆ˜í–‰ (RAG ì—†ëŠ” ê¸°ë³¸ ë²„ì „)"""
    # ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ êµ¬ì„±
    analysis_prompt = f"""
ë‹¤ìŒ ì£¼ì œ/ì§ˆë¬¸ì— ëŒ€í•´ {persona_info['role']} ê´€ì ì—ì„œ ì „ë¬¸ì ìœ¼ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”:

ã€ì£¼ì œ/ì§ˆë¬¸ã€‘
{user_query}

ã€ë¶„ì„ ìš”êµ¬ì‚¬í•­ã€‘
- {persona_info['perspective']}
- êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ì œì•ˆ í¬í•¨
- ë³¸ì¸ì˜ ì „ë¬¸ ë¶„ì•¼ì— íŠ¹í™”ëœ ì¸ì‚¬ì´íŠ¸ ì œê³µ
- ë‹¤ë¥¸ ë¶€ì„œì™€ì˜ í˜‘ì—… ë°©ì•ˆ ê³ ë ¤

"""
    
    # ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ê°€ ìˆë‹¤ë©´ ì¶”ê°€
    if custom_prompt and custom_prompt.strip():
        analysis_prompt += f"""
ã€ì¶”ê°€ ë¶„ì„ ìš”ì²­ì‚¬í•­ã€‘
{custom_prompt.strip()}

"""
    
    analysis_prompt += """
ã€ì‘ë‹µ í˜•ì‹ã€‘
## í•µì‹¬ ë¶„ì„
(2-3ì¤„ë¡œ í•µì‹¬ í¬ì¸íŠ¸ ìš”ì•½)

## ìƒì„¸ ë¶„ì„
(ì „ë¬¸ ë¶„ì•¼ ê´€ì ì—ì„œ ìƒì„¸í•œ ë¶„ì„)

## ì‹¤í–‰ ì œì•ˆ
(êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ì•¡ì…˜ ì•„ì´í…œë“¤)

## ë‹¤ë¥¸ ë¶€ì„œ í˜‘ì—… ë°©ì•ˆ
(ë‹¤ë¥¸ C-levelê³¼ì˜ í˜‘ì—…ì´ í•„ìš”í•œ ë¶€ë¶„)

## ë¦¬ìŠ¤í¬ ë° ê³ ë ¤ì‚¬í•­
(ì£¼ì˜í•´ì•¼ í•  ì ë“¤)
"""
    
    return get_ai_response(analysis_prompt, model_name, persona_info['system_prompt'])

    
    return get_ai_response(analysis_prompt, model_name, persona_info['system_prompt'])

def analyze_persona_concurrent_rag(args):
    """RAG ê¸°ëŠ¥ì´ í¬í•¨ëœ ThreadPoolExecutor ë˜í¼ í•¨ìˆ˜"""
    user_query, persona_key, persona_info, custom_prompt, model_name = args
    try:
        # RAG ì»¨í…ìŠ¤íŠ¸ ì•ˆì „í•˜ê²Œ ìƒì„±
        try:
            rag_context = create_rag_context()
        except Exception as e:
            rag_context = ""
        
        # RAG ì»¨í…ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ ë” í’ë¶€í•œ ë¶„ì„
        analysis_prompt = f"""
ë‹¤ìŒ ì£¼ì œ/ì§ˆë¬¸ì— ëŒ€í•´ {persona_info['role']} ê´€ì ì—ì„œ ìµœê³  ìˆ˜ì¤€ì˜ ì „ë¬¸ì  ë¶„ì„ì„ ìˆ˜í–‰í•´ì£¼ì„¸ìš”:

ã€ë¶„ì„ ëŒ€ìƒã€‘
{user_query}

"""

        # RAG ì»¨í…ìŠ¤íŠ¸ ì¶”ê°€ (ìˆëŠ” ê²½ìš°)
        if rag_context:
            analysis_prompt += f"""
ã€ì‹¤ì œ ë°ì´í„° ê¸°ë°˜ ë¶„ì„ã€‘
{rag_context}

ìœ„ ì‹¤ì œ ë°ì´í„°ë¥¼ ë°˜ë“œì‹œ í™œìš©í•˜ì—¬ êµ¬ì²´ì ì´ê³  ì •ëŸ‰ì ì¸ ë¶„ì„ì„ ì œê³µí•´ì£¼ì„¸ìš”.

"""

        analysis_prompt += f"""
ã€ì „ë¬¸ê°€ ìˆ˜ì¤€ ë¶„ì„ ìš”êµ¬ì‚¬í•­ã€‘
- {persona_info['perspective']}
- ì—…ê³„ ìµœê³  ìˆ˜ì¤€ì˜ ìƒì„¸í•˜ê³  ê¹Šì´ ìˆëŠ” ì „ë¬¸ ë¶„ì„ ì œê³µ
- êµ¬ì²´ì ì¸ ìˆ˜ì¹˜, ì§€í‘œ, ë°ì´í„°ë¥¼ í¬í•¨í•œ ì •ëŸ‰ì  ë¶„ì„
- ë‹¨ê³„ë³„ ì‹¤í–‰ ê³„íšê³¼ íƒ€ì„ë¼ì¸ì„ í¬í•¨í•œ ì‹¤í–‰ ê°€ëŠ¥í•œ ì œì•ˆ
- ë¦¬ìŠ¤í¬ ìš”ì¸ê³¼ ì™„í™” ì „ëµì„ êµ¬ì²´ì ìœ¼ë¡œ ë¶„ì„
- ì„±ê³¼ ì¸¡ì • ì§€í‘œ(KPI)ì™€ ëª¨ë‹ˆí„°ë§ ë°©ì•ˆ ëª…ì‹œ
- ë‹¤ë¥¸ ë¶€ì„œì™€ì˜ êµ¬ì²´ì  í˜‘ì—… ë°©ì•ˆê³¼ ì—­í•  ë¶„ë‹´
- ì˜ˆìƒ ë¹„ìš©, ë¦¬ì†ŒìŠ¤, ê¸°ê°„ì„ í¬í•¨í•œ ìƒì„¸í•œ ì‹¤í–‰ ê³„íš
{'- ì œê³µëœ ì‹¤ì œ ë°ì´í„°ë¥¼ ë°˜ë“œì‹œ ë¶„ì„ì— í™œìš©í•˜ê³  ì¸ì‚¬ì´íŠ¸ ë„ì¶œ' if rag_context else '- ì—…ê³„ ìµœì‹  ë™í–¥ê³¼ ê¸€ë¡œë²Œ ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤ ì ìš©'}

"""
        
        # ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ê°€ ìˆë‹¤ë©´ ì¶”ê°€
        if custom_prompt and custom_prompt.strip():
            analysis_prompt += f"""
ã€íŠ¹ë³„ ìš”ì²­ì‚¬í•­ã€‘
{custom_prompt.strip()}

"""
        
        analysis_prompt += f"""
ã€ìµœê³  ìˆ˜ì¤€ì˜ ë¦¬í¬íŠ¸ í˜•ì‹ (ë°˜ë“œì‹œ ì¤€ìˆ˜)ã€‘

## ğŸ¯ í•µì‹¬ ìš”ì•½ ë° ê²°ë¡ 
(3-4ì¤„ë¡œ í•µì‹¬ í¬ì¸íŠ¸ì™€ ìµœì¢… ê¶Œê³ ì‚¬í•­ì„ ê°„ê²°í•˜ê²Œ ìš”ì•½)

## ğŸ“Š í˜„í™© ë¶„ì„ ë° ì§„ë‹¨
(í˜„ì¬ ìƒí™©ì— ëŒ€í•œ ì •ëŸ‰ì  ë¶„ì„ê³¼ ë¬¸ì œì /ê¸°íšŒ ìš”ì¸ ì§„ë‹¨)
{'### ë°ì´í„° ê¸°ë°˜ í•µì‹¬ ì¸ì‚¬ì´íŠ¸' if rag_context else '### ì—…ê³„ ë™í–¥ ë° í™˜ê²½ ë¶„ì„'}
{('- ì œê³µëœ ë°ì´í„°ì—ì„œ ë°œê²¬í•œ ì£¼ìš” íŒ¨í„´ê³¼ ì¸ì‚¬ì´íŠ¸' if rag_context else '- ìµœì‹  ì—…ê³„ ë™í–¥ê³¼ ì‹œì¥ í™˜ê²½ ë¶„ì„')}

## ğŸ” ì „ë¬¸ ë¶„ì•¼ ì‹¬í™” ë¶„ì„
(ì „ë¬¸ ì˜ì—­ë³„ ìƒì„¸ ë¶„ì„ê³¼ ê¸°ìˆ ì /ì „ëµì  ê²€í† )
### í•µì‹¬ ì´ìŠˆ ë° ê³¼ì œ
- ì£¼ìš” ì´ìŠˆë³„ ìš°ì„ ìˆœìœ„ì™€ ì˜í–¥ë„ ë¶„ì„
### ê²½ìŸ í™˜ê²½ ë° í¬ì§€ì…”ë‹
- ê²½ìŸì‚¬ ëŒ€ë¹„ ìš°ìœ„/ì—´ìœ„ ìš”ì†Œ ë¶„ì„

## ğŸ’¡ ì „ëµì  ê¶Œê³ ì‚¬í•­ ë° ì†”ë£¨ì…˜
### ë‹¨ê¸° ì‹¤í–‰ ë°©ì•ˆ (3-6ê°œì›”)
- êµ¬ì²´ì  ì•¡ì…˜ ì•„ì´í…œê³¼ ë‹´ë‹¹ ë¶€ì„œ
- ì˜ˆìƒ ë¹„ìš©ê³¼ ë¦¬ì†ŒìŠ¤ ìš”êµ¬ì‚¬í•­
### ì¤‘ì¥ê¸° ì „ëµ (6ê°œì›”-2ë…„)
- ì „ëµì  ë¡œë“œë§µê³¼ ë‹¨ê³„ë³„ ëª©í‘œ

## ğŸ“ˆ ì‹¤í–‰ ê³„íš ë° ì„±ê³¼ ì§€í‘œ
### ìƒì„¸ ì‹¤í–‰ ë¡œë“œë§µ
- ë‹¨ê³„ë³„ ë§ˆì¼ìŠ¤í†¤ê³¼ íƒ€ì„ë¼ì¸
- ê° ë‹¨ê³„ë³„ ì„±ê³µ ê¸°ì¤€ê³¼ ì²´í¬í¬ì¸íŠ¸
### KPI ë° ì„±ê³¼ ì¸¡ì •
- ì •ëŸ‰ì  ì„±ê³¼ ì§€í‘œì™€ ëª©í‘œì¹˜
- ëª¨ë‹ˆí„°ë§ ë°©ë²•ê³¼ ë³´ê³  ì²´ê³„

## ğŸ¤ ë¶€ì„œê°„ í˜‘ì—… ì „ëµ
### ë‹¤ë¥¸ C-Levelê³¼ì˜ í˜‘ì—… ë°©ì•ˆ
- êµ¬ì²´ì  í˜‘ì—… ë‚´ìš©ê³¼ ì—­í•  ë¶„ë‹´
- í˜‘ì—… ì¼ì •ê³¼ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ê³„íš
### ì¡°ì§ ë‚´ ì‹¤í–‰ ì²´ê³„
- ì‹¤í–‰ ì¡°ì§ êµ¬ì„±ê³¼ ì±…ì„ í• ë‹¹

## âš ï¸ ë¦¬ìŠ¤í¬ ê´€ë¦¬ ë° ëŒ€ì‘ ì „ëµ
### ì£¼ìš” ë¦¬ìŠ¤í¬ ìš”ì¸
- ë¦¬ìŠ¤í¬ë³„ ë°œìƒ í™•ë¥ ê³¼ ì„íŒ©íŠ¸ ë¶„ì„
- ë¦¬ìŠ¤í¬ ë§¤íŠ¸ë¦­ìŠ¤ì™€ ìš°ì„ ìˆœìœ„
### ëŒ€ì‘ ë° ì™„í™” ì „ëµ
- ë¦¬ìŠ¤í¬ë³„ ëŒ€ì‘ ë°©ì•ˆê³¼ ë¹„ìƒ ê³„íš
- ì¡°ê¸° ê²½ë³´ ì‹œìŠ¤í…œê³¼ ëŒ€ì‘ ì²´ê³„

## ğŸ’° íˆ¬ì ë° ìì› ê³„íš
### ì˜ˆì‚° ë° íˆ¬ì ê³„íš
- ë‹¨ê³„ë³„ ì˜ˆì‚° ì†Œìš”ì™€ íˆ¬ì ìš°ì„ ìˆœìœ„
- ROI ë° íšŒìˆ˜ ê¸°ê°„ ì˜ˆì¸¡
### ì¸ë ¥ ë° ìì› ìš”êµ¬ì‚¬í•­
- í•„ìš” ì¸ë ¥ê³¼ ìŠ¤í‚¬ì…‹
- ì™¸ë¶€ ìì› í™œìš© ë°©ì•ˆ

## ğŸ”® ë¯¸ë˜ ì „ë§ ë° ì‹œì‚¬ì 
### ì¥ê¸°ì  ì˜í–¥ ë° ê¸°íšŒ
- 3-5ë…„ í›„ ì˜ˆìƒë˜ëŠ” ë³€í™”ì™€ ê¸°íšŒ
### ì§€ì†ì  ëª¨ë‹ˆí„°ë§ í¬ì¸íŠ¸
- ì§€ì†ì ìœ¼ë¡œ ê´€ì°°í•´ì•¼ í•  í•µì‹¬ ì§€í‘œ

ë°˜ë“œì‹œ ìœ„ í˜•ì‹ì„ ì¤€ìˆ˜í•˜ì—¬ ê° ì„¹ì…˜ì„ ìƒì„¸í•˜ê³  êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”. 
ëª¨ë“  ì œì•ˆì€ ì‹¤í–‰ ê°€ëŠ¥í•˜ê³  ì¸¡ì • ê°€ëŠ¥í•œ ìˆ˜ì¤€ìœ¼ë¡œ êµ¬ì²´í™”í•´ì£¼ì„¸ìš”."""
        
        result = get_ai_response(analysis_prompt, model_name, persona_info['system_prompt'])
        
        if result is None:
            return persona_key, f"AI ì‘ë‹µì´ Noneì…ë‹ˆë‹¤. API í‚¤ë‚˜ ëª¨ë¸ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.", False
        return persona_key, result, True
    except Exception as e:
        import traceback
        error_details = traceback.format_exc()
        return persona_key, f"ì˜¤ë¥˜ ë°œìƒ: {str(e)}\nìƒì„¸: {error_details}", False

def synthesize_ceo_analysis_simple(user_query, persona_analyses, model_name="claude-3-7-sonnet-latest"):
    """CEO ê´€ì ì—ì„œ ëª¨ë“  ë¶„ì„ì„ ì¢…í•© (RAG ì—†ëŠ” ê¸°ë³¸ ë²„ì „)"""
    synthesis_prompt = f"""
ë‹¤ìŒì€ ìš°ë¦¬ íšŒì‚¬ C-level ì„ì›ì§„ë“¤ì´ ë¶„ì„í•œ ë‚´ìš©ì…ë‹ˆë‹¤. 
CEOë¡œì„œ ì´ë“¤ì˜ ë¶„ì„ì„ ì¢…í•©í•˜ì—¬ ìµœì¢… ì˜ì‚¬ê²°ì •ì„ ìœ„í•œ í†µí•© ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

ã€ì›ë˜ ì£¼ì œ/ì§ˆë¬¸ã€‘
{user_query}

ã€ê° ì„ì›ì§„ ë¶„ì„ ê²°ê³¼ã€‘
"""
    
    for persona_key, analysis in persona_analyses.items():
        if analysis and analysis.get('result'):
            persona_info = PERSONAS[persona_key]
            synthesis_prompt += f"""
--- {persona_info['emoji']} {persona_info['name']} ë¶„ì„ ---
{analysis['result']}

"""
    
    synthesis_prompt += """
ã€CEO ì¢…í•© ë¶„ì„ ìš”êµ¬ì‚¬í•­ã€‘
- ê° ì„ì›ì§„ì˜ ê´€ì ì„ ê· í˜•ìˆê²Œ ê³ ë ¤
- ì „ì‚¬ì  ê´€ì ì—ì„œì˜ ìš°ì„ ìˆœìœ„ ì„¤ì •
- ì‹¤í˜„ ê°€ëŠ¥í•œ í†µí•© ì‹¤í–‰ ê³„íš ìˆ˜ë¦½
- ë¦¬ìŠ¤í¬ì™€ ê¸°íšŒ ìš”ì¸ì˜ ì¢…í•©ì  í‰ê°€
- ëª…í™•í•œ ì˜ì‚¬ê²°ì • ë°©í–¥ ì œì‹œ

ã€ì‘ë‹µ í˜•ì‹ã€‘
## ğŸ¯ í•µì‹¬ ê²°ë¡  ë° ì˜ì‚¬ê²°ì •
(CEOë¡œì„œì˜ ìµœì¢… íŒë‹¨ê³¼ ê²°ì •ì‚¬í•­)

## ğŸ“Š ì„ì›ì§„ ë¶„ì„ ì¢…í•©
(ê° ì„ì›ì§„ ì˜ê²¬ì˜ í•µì‹¬ í¬ì¸íŠ¸ë“¤)

## ğŸš€ í†µí•© ì‹¤í–‰ ê³„íš
(ë‹¨ê³„ë³„ ì‹¤í–‰ ë°©ì•ˆ)

## âš–ï¸ ë¦¬ìŠ¤í¬ vs ê¸°íšŒ
(ì¢…í•©ì  ë¦¬ìŠ¤í¬-ê¸°íšŒ ë¶„ì„)

## ğŸ“ˆ ì„±ê³µ ì§€í‘œ ë° ëª¨ë‹ˆí„°ë§
(ì„±ê³¼ ì¸¡ì • ë°©ë²•)

## ğŸ’¡ CEO ìµœì¢… ë©”ì‹œì§€
(ì¡°ì§ì— ì „ë‹¬í•  í•µì‹¬ ë©”ì‹œì§€)
"""
    
    return get_ai_response(synthesis_prompt, model_name, CEO_PERSONA['system_prompt'])

def synthesize_ceo_analysis_rag(user_query, persona_analyses, model_name="claude-3-7-sonnet-latest"):
    """RAG ì»¨í…ìŠ¤íŠ¸ë¥¼ í¬í•¨í•œ CEO ì¢…í•© ë¶„ì„"""
    
    # RAG ì»¨í…ìŠ¤íŠ¸ ìƒì„±
    rag_context = create_rag_context()
    
    synthesis_prompt = f"""
ë‹¤ìŒì€ ìš°ë¦¬ íšŒì‚¬ì˜ ëª¨ë“  C-Level ì„ì›ì§„ë“¤ì´ ìˆ˜í–‰í•œ ìµœê³  ìˆ˜ì¤€ì˜ ì „ë¬¸ ë¶„ì„ì…ë‹ˆë‹¤. 
ë‹¹ì‹ ì€ ì„¸ê³„ì  CEOë¡œì„œ ì´ë“¤ì˜ ë¶„ì„ì„ í†µí•©í•˜ì—¬ ì´ì‚¬íšŒì™€ ì£¼ì£¼ë¥¼ ìœ„í•œ ìµœê³  ìˆ˜ì¤€ì˜ ê²½ì˜ì§„ ì˜ì‚¬ê²°ì • ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

ã€ê²½ì˜ì§„ ì˜ì‚¬ê²°ì • ëŒ€ìƒã€‘
{user_query}

"""

    # RAG ì»¨í…ìŠ¤íŠ¸ ì¶”ê°€
    if rag_context:
        synthesis_prompt += f"""
ã€ì‹¤ì œ íšŒì‚¬ ë°ì´í„° ê¸°ë°˜ ë¶„ì„ã€‘
{rag_context}

ìœ„ ì‹¤ì œ ë°ì´í„°ë¥¼ ë°˜ë“œì‹œ ê²½ì˜ ì˜ì‚¬ê²°ì •ì— ë°˜ì˜í•˜ê³ , ë°ì´í„° ê¸°ë°˜ ì¸ì‚¬ì´íŠ¸ë¥¼ ë„ì¶œí•˜ì—¬ ì£¼ì£¼ê°€ì¹˜ ê·¹ëŒ€í™” ë°©ì•ˆì„ ì œì‹œí•´ì£¼ì„¸ìš”.

"""

    synthesis_prompt += """
ã€ê° C-Level ì„ì›ì§„ì˜ ì „ë¬¸ ë¶„ì„ ê²°ê³¼ã€‘
"""
    
    for persona_key, analysis in persona_analyses.items():
        if analysis and analysis.get('result'):
            persona_info = PERSONAS[persona_key]
            synthesis_prompt += f"""
==================== {persona_info['emoji']} {persona_info['name']} ì „ë¬¸ ë¶„ì„ ====================
{analysis['result']}

"""
    
    synthesis_prompt += f"""
ã€ì„¸ê³„ ìµœê³  ìˆ˜ì¤€ì˜ CEO í†µí•© ì˜ì‚¬ê²°ì • ë³´ê³ ì„œ ìš”êµ¬ì‚¬í•­ã€‘
- ê° C-Level ì„ì›ì§„ì˜ ì „ë¬¸ ë¶„ì„ì„ ì²´ê³„ì ìœ¼ë¡œ í†µí•©í•˜ê³  ê²€í† 
- {'ì‹¤ì œ íšŒì‚¬ ë°ì´í„°ë¥¼ ì ê·¹ í™œìš©í•œ ë°ì´í„° ê¸°ë°˜ ì˜ì‚¬ê²°ì •' if rag_context else 'ì—…ê³„ ìµœê³  ìˆ˜ì¤€ì˜ ê²½ì˜ íŒë‹¨ ê¸°ì¤€ ì ìš©'}
- ì „ì‚¬ì  ê´€ì ì—ì„œì˜ ì „ëµì  ìš°ì„ ìˆœìœ„ ì„¤ì •ê³¼ ìì› ë°°ë¶„ ìµœì í™”
- ì´í•´ê´€ê³„ì(ì£¼ì£¼, ì„ì§ì›, ê³ ê°, ì‚¬íšŒ)ë¥¼ ê³ ë ¤í•œ ê· í˜• ì¡íŒ ê²½ì˜ ë°©í–¥ ì œì‹œ
- ë‹¨ê¸° ì‹¤í–‰ë ¥ê³¼ ì¥ê¸° ì§€ì†ê°€ëŠ¥ì„±ì„ ëª¨ë‘ ê³ ë ¤í•œ í†µí•© ì‹¤í–‰ ê³„íš
- ê²½ì˜ ë¦¬ìŠ¤í¬ì™€ ê¸°íšŒ ìš”ì¸ì˜ ì¢…í•©ì  í‰ê°€ ë° ëŒ€ì‘ ì „ëµ
- ëª…í™•í•˜ê³  ê²°ë‹¨ë ¥ ìˆëŠ” CEO ì˜ì‚¬ê²°ì •ê³¼ ì‹¤í–‰ ì§€ì‹œì‚¬í•­

ã€ìµœê³  ìˆ˜ì¤€ì˜ CEO ê²½ì˜ì§„ ë³´ê³ ì„œ í˜•ì‹ (ë°˜ë“œì‹œ ì¤€ìˆ˜)ã€‘

## ğŸ‘‘ CEO í•µì‹¬ ì˜ì‚¬ê²°ì • ë° ê²½ì˜ ë°©í–¥
### ìµœì¢… ê²½ì˜ ê²°ì •ì‚¬í•­
(CEOë¡œì„œì˜ ëª…í™•í•˜ê³  ê²°ë‹¨ë ¥ ìˆëŠ” ì˜ì‚¬ê²°ì •ê³¼ í•µì‹¬ ì¶”ì§„ ë°©í–¥)
### ì „ëµì  ìš°ì„ ìˆœìœ„ ë° ìì› ë°°ë¶„
(ì „ì‚¬ ì°¨ì›ì˜ ìš°ì„ ìˆœìœ„ ì„¤ì •ê³¼ ì¸ì /ì¬ë¬´ì  ìì› ë°°ë¶„ ì›ì¹™)

## ğŸ“ˆ ë°ì´í„° ê¸°ë°˜ ê²½ì˜ í˜„í™© ì§„ë‹¨
{'### ì‹¤ì œ ë°ì´í„°ì—ì„œ ë„ì¶œí•œ í•µì‹¬ ê²½ì˜ ì¸ì‚¬ì´íŠ¸' if rag_context else '### ì‹œì¥ í™˜ê²½ ë° ê²½ìŸ í¬ì§€ì…˜ ë¶„ì„'}
{('- íšŒì‚¬ ë°ì´í„° ë¶„ì„ì„ í†µí•œ ì£¼ìš” ë°œê²¬ì‚¬í•­ê³¼ ê²½ì˜ ì‹œì‚¬ì ' if rag_context else '- ì—…ê³„ ë™í–¥ê³¼ ê²½ìŸ í™˜ê²½ ë¶„ì„ì„ í†µí•œ í¬ì§€ì…”ë‹ ì „ëµ')}
### í˜„ì¬ ê²½ì˜ ì„±ê³¼ ë° ê³¼ì œ ì§„ë‹¨
- ê° ë¶€ë¬¸ë³„ ì„±ê³¼ í‰ê°€ì™€ ê°œì„  í•„ìš” ì˜ì—­ ì‹ë³„
- ì¡°ì§ ì—­ëŸ‰ê³¼ ê²½ìŸ ìš°ìœ„ ìš”ì†Œ ë¶„ì„

## ğŸ¯ ì„ì›ì§„ ë¶„ì„ í†µí•© ë° ì „ëµì  ì‹œë„ˆì§€
### CTO ê¸°ìˆ ì „ëµê³¼ ë””ì§€í„¸ ì „í™˜ ë°©í–¥
- ê¸°ìˆ  íˆ¬ì ìš°ì„ ìˆœìœ„ì™€ ë””ì§€í„¸ í˜ì‹  ë¡œë“œë§µ
### CSO ì „ëµê¸°íšê³¼ ì‚¬ì—… í¬íŠ¸í´ë¦¬ì˜¤ ìµœì í™”
- í•µì‹¬ ì‚¬ì—… ì§‘ì¤‘ ì „ëµê³¼ ì‹ ê·œ ì„±ì¥ ë™ë ¥ í™•ë³´
### CMO ë§ˆì¼€íŒ…ì „ëµê³¼ ê³ ê°ê°€ì¹˜ ì°½ì¶œ
- ë¸Œëœë“œ ê°•í™” ì „ëµê³¼ ê³ ê° ê²½í—˜ í˜ì‹  ë°©ì•ˆ
### CFO ì¬ë¬´ì „ëµê³¼ ì£¼ì£¼ê°€ì¹˜ ê·¹ëŒ€í™”
- ì¬ë¬´ ê±´ì „ì„± ê°•í™”ì™€ ìˆ˜ìµì„± ê°œì„  ë°©ì•ˆ
### CSO ì˜ì—…ì „ëµê³¼ ì‹œì¥ í™•ëŒ€
- ë§¤ì¶œ ì„±ì¥ ì „ëµê³¼ ì‹ ì‹œì¥ ì§„ì¶œ ë°©ì•ˆ
### CIO ì •ë³´ì „ëµê³¼ ë°ì´í„° í™œìš© ê³ ë„í™”
- IT ì¸í”„ë¼ ìµœì í™”ì™€ ë°ì´í„° ê¸°ë°˜ ì˜ì‚¬ê²°ì • ì²´ê³„ êµ¬ì¶•

## ğŸš€ í†µí•© ì‹¤í–‰ ì „ëµ ë° ë¡œë“œë§µ
### Phase 1: ì¦‰ì‹œ ì‹¤í–‰ ê³¼ì œ (1-3ê°œì›”)
- ê¸´ê¸‰ì„±ê³¼ ì¤‘ìš”ì„±ì´ ë†’ì€ ìµœìš°ì„  ê³¼ì œ
- ê° ë¶€ë¬¸ë³„ ì¦‰ì‹œ ì‹¤í–‰ ì§€ì‹œì‚¬í•­ê³¼ ì±…ì„ì ì§€ì •
### Phase 2: ë‹¨ê¸° ì „ëµ ê³¼ì œ (3-12ê°œì›”)
- ì„±ê³¼ ì°½ì¶œì„ ìœ„í•œ í•µì‹¬ ì „ëµ ê³¼ì œ
- ë¶€ë¬¸ê°„ í˜‘ì—… í”„ë¡œì íŠ¸ì™€ ì‹œë„ˆì§€ ì°½ì¶œ ë°©ì•ˆ
### Phase 3: ì¤‘ì¥ê¸° í˜ì‹  ê³¼ì œ (1-3ë…„)
- ì§€ì† ê°€ëŠ¥í•œ ì„±ì¥ì„ ìœ„í•œ í˜ì‹  ê³¼ì œ
- ì¡°ì§ ì—­ëŸ‰ ê°•í™”ì™€ ë¯¸ë˜ ê²½ìŸë ¥ í™•ë³´ ë°©ì•ˆ

## ğŸ’° íˆ¬ì ìš°ì„ ìˆœìœ„ ë° ì˜ˆì‚° ë°°ë¶„ ì „ëµ
### ì „ëµì  íˆ¬ì ìš°ì„ ìˆœìœ„
- ì„±ì¥ ë™ë ¥ í™•ë³´ë¥¼ ìœ„í•œ í•µì‹¬ íˆ¬ì ì˜ì—­
- íˆ¬ìë³„ ê¸°ëŒ€ íš¨ê³¼ì™€ ROI ë¶„ì„
### ì˜ˆì‚° ë°°ë¶„ ë° ìì› ìµœì í™”
- ë¶€ë¬¸ë³„ ì˜ˆì‚° ë°°ë¶„ ì›ì¹™ê³¼ ì„±ê³¼ ì—°ë™ ì²´ê³„
- ë¹„ìš© ìµœì í™”ì™€ íš¨ìœ¨ì„± ê°œì„  ë°©ì•ˆ

## âš–ï¸ í†µí•© ë¦¬ìŠ¤í¬ ê´€ë¦¬ ë° ê¸°íšŒ í™œìš© ì „ëµ
### ì „ì‚¬ ì°¨ì›ì˜ ì£¼ìš” ë¦¬ìŠ¤í¬ ìš”ì¸
- ê° ë¶€ë¬¸ë³„ ë¦¬ìŠ¤í¬ë¥¼ í†µí•©í•œ ì „ì‚¬ ë¦¬ìŠ¤í¬ ë§¤íŠ¸ë¦­ìŠ¤
- ë¦¬ìŠ¤í¬ë³„ ëŒ€ì‘ ìš°ì„ ìˆœìœ„ì™€ ì™„í™” ì „ëµ
### ì „ëµì  ê¸°íšŒ í¬ì°© ë° í™œìš© ë°©ì•ˆ
- ì‹œì¥ ê¸°íšŒì™€ ë‚´ë¶€ ì—­ëŸ‰ì„ ì—°ê³„í•œ ì„±ì¥ ê¸°íšŒ ì‹ë³„
- ê¸°íšŒ í™œìš©ì„ ìœ„í•œ ì¡°ì§ ì—­ëŸ‰ ê°•í™” ë°©ì•ˆ

## ğŸ“Š í†µí•© ì„±ê³¼ ê´€ë¦¬ ë° ëª¨ë‹ˆí„°ë§ ì²´ê³„
### ì „ì‚¬ KPI ë° ì„±ê³¼ ì§€í‘œ ì²´ê³„
- ê· í˜•ì„±ê³¼í‘œ(BSC) ê¸°ë°˜ í†µí•© ì„±ê³¼ ê´€ë¦¬ ì²´ê³„
- ë¶€ë¬¸ë³„ ì„±ê³¼ ì§€í‘œì™€ ì „ì‚¬ ëª©í‘œ ì—°ê³„ ë°©ì•ˆ
### CEO ì§ì† ëª¨ë‹ˆí„°ë§ ë° ë³´ê³  ì²´ê³„
- ì›”ë³„/ë¶„ê¸°ë³„ í•µì‹¬ ì§€í‘œ ëª¨ë‹ˆí„°ë§ ì²´ê³„
- ì´ìŠˆ ë°œìƒ ì‹œ ì‹ ì† ëŒ€ì‘ì„ ìœ„í•œ ì—ìŠ¤ì»¬ë ˆì´ì…˜ ì²´ê³„

## ğŸŒŸ ì¡°ì§ ë¬¸í™” í˜ì‹  ë° ë¦¬ë”ì‹­ ì „ëµ
### ê³ ì„±ê³¼ ì¡°ì§ ë¬¸í™” êµ¬ì¶•
- í˜ì‹ ì ì´ê³  í˜‘ë ¥ì ì¸ ì¡°ì§ ë¬¸í™” ì¡°ì„± ë°©ì•ˆ
- ì„ì§ì› ëª°ì…ë„ ì œê³ ì™€ ì¸ì¬ ìœ ì§€ ì „ëµ
### ì°¨ì„¸ëŒ€ ë¦¬ë”ì‹­ ê°œë°œ
- ë¯¸ë˜ ë¦¬ë” ìœ¡ì„±ê³¼ ìŠ¹ê³„ ê³„íš
- ì¡°ì§ í•™ìŠµ ëŠ¥ë ¥ ê°•í™” ë°©ì•ˆ

## ğŸŒ ì´í•´ê´€ê³„ì ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ë° ESG ê²½ì˜
### ì£¼ì£¼ ë° íˆ¬ìì ê´€ê³„ ê´€ë¦¬
- ì£¼ì£¼ê°€ì¹˜ ì œê³ ë¥¼ ìœ„í•œ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ì „ëµ
- IR í™œë™ ê°•í™”ì™€ íˆ¬ëª… ê²½ì˜ ì‹¤ì²œ ë°©ì•ˆ
### ESG ê²½ì˜ ë° ì§€ì†ê°€ëŠ¥ì„± ì „ëµ
- í™˜ê²½, ì‚¬íšŒ, ê±°ë²„ë„ŒìŠ¤ ì°¨ì›ì˜ ì±…ì„ ê²½ì˜ ì‹¤ì²œ
- ì§€ì†ê°€ëŠ¥í•œ ì„±ì¥ì„ ìœ„í•œ ESG í†µí•© ì „ëµ

## ğŸ¯ CEO ìµœì¢… ì‹¤í–‰ ì§€ì‹œì‚¬í•­
### ê° C-Level ì„ì›ì§„ì— ëŒ€í•œ êµ¬ì²´ì  ì§€ì‹œì‚¬í•­
- ì„ì›ë³„ í•µì‹¬ ë¯¸ì…˜ê³¼ ì„±ê³¼ ëª©í‘œ ì„¤ì •
- ìƒí˜¸ í˜‘ì—… ê³¼ì œì™€ ì±…ì„ ë¶„ë‹´ ëª…í™•í™”
### ì „ì‚¬ ì°¨ì›ì˜ ë³€í™” ê´€ë¦¬ ë°©í–¥
- ì¡°ì§ ë³€í™” ì¶”ì§„ ì²´ê³„ì™€ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ê³„íš
- êµ¬ì„±ì› ì°¸ì—¬ ìœ ë„ì™€ ë³€í™” ì €í•­ ìµœì†Œí™” ë°©ì•ˆ

ë°˜ë“œì‹œ ìœ„ í˜•ì‹ì„ ì¤€ìˆ˜í•˜ì—¬ ì„¸ê³„ ìµœê³  ìˆ˜ì¤€ì˜ CEO ê²½ì˜ì§„ ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.
ëª¨ë“  ì˜ì‚¬ê²°ì •ì€ êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•˜ë©°, ì£¼ì£¼ê°€ì¹˜ ê·¹ëŒ€í™”ë¥¼ ì§€í–¥í•´ì•¼ í•©ë‹ˆë‹¤."""
    
    return get_ai_response(synthesis_prompt, model_name, CEO_PERSONA['system_prompt'])

def run_concurrent_analysis_with_progress_rag(user_query, persona_prompts, persona_status, persona_progress, model_name="claude-3-7-sonnet-latest"):
    """RAG ê¸°ëŠ¥ì´ í¬í•¨ëœ ë™ì‹œ ë¶„ì„ ì‹¤í–‰"""
    
    # ë¶„ì„ ì‘ì—… ì¤€ë¹„
    tasks = []
    for persona_key, persona_info in PERSONAS.items():
        custom_prompt = persona_prompts.get(persona_key, "")
        tasks.append((user_query, persona_key, persona_info, custom_prompt, model_name))
    
    # ê° í˜ë¥´ì†Œë‚˜ë³„ ì§„í–‰ ìƒíƒœ ì¶”ì 
    persona_stages = {}
    for persona_key in PERSONAS.keys():
        persona_stages[persona_key] = {
            'current_stage': 0,
            'last_update': time.time(),
            'stage_duration': random.uniform(2.0, 4.0)
        }
    
    # ì§„í–‰ë¥  ì• ë‹ˆë©”ì´ì…˜ í•¨ìˆ˜
    def animate_progress():
        while True:
            current_time = time.time()
            
            all_completed = True
            for persona_key, persona_info in PERSONAS.items():
                if persona_key not in st.session_state.get('completed_personas', set()):
                    all_completed = False
                    
                    stages = PERSONA_ANALYSIS_STAGES[persona_key]
                    stage_info = persona_stages[persona_key]
                    
                    if stage_info['current_stage'] < len(stages):
                        current_stage = stages[stage_info['current_stage']]
                        
                        elapsed_since_update = current_time - stage_info['last_update']
                        
                        if elapsed_since_update >= stage_info['stage_duration']:
                            stage_info['current_stage'] += 1
                            stage_info['last_update'] = current_time
                            stage_info['stage_duration'] = random.uniform(1.5, 3.5)
                            
                            if stage_info['current_stage'] < len(stages):
                                new_stage = stages[stage_info['current_stage']]
                                
                                if persona_progress[persona_key] is not None:
                                    persona_progress[persona_key].progress(new_stage['progress'])
                                
                                persona_status[persona_key].markdown(f"""
                                <div class="progress-indicator">
                                    <strong>ğŸš€ {persona_info['emoji']} {persona_info['name']}</strong><br>
                                    <span style="font-size: 0.9rem;">{new_stage['message']} ({new_stage['progress']}%)</span>
                                </div>
                                """, unsafe_allow_html=True)
                        else:
                            if stage_info['current_stage'] > 0:
                                prev_progress = stages[stage_info['current_stage'] - 1]['progress']
                                curr_progress = current_stage['progress']
                                
                                stage_progress = min(elapsed_since_update / stage_info['stage_duration'], 1.0)
                                interpolated_progress = prev_progress + (curr_progress - prev_progress) * stage_progress
                                
                                if persona_progress[persona_key] is not None:
                                    persona_progress[persona_key].progress(int(interpolated_progress))
                                
                                persona_status[persona_key].markdown(f"""
                                <div class="progress-indicator">
                                    <strong>ğŸš€ {persona_info['emoji']} {persona_info['name']}</strong><br>
                                    <span style="font-size: 0.9rem;">{current_stage['message']} ({int(interpolated_progress)}%)</span>
                                </div>
                                """, unsafe_allow_html=True)
            
            if all_completed:
                break
                
            time.sleep(0.3)
    
    st.session_state['completed_personas'] = set()
    
    progress_thread = threading.Thread(target=animate_progress)
    progress_thread.daemon = True
    progress_thread.start()
    
    # ThreadPoolExecutorë¡œ ë™ì‹œ ì‹¤í–‰ (RAG ë²„ì „ ì‚¬ìš©)
    results = {}
    with ThreadPoolExecutor(max_workers=len(PERSONAS)) as executor:
        future_to_persona = {
            executor.submit(analyze_persona_concurrent_rag, task): task[1] 
            for task in tasks
        }
        
        for future in as_completed(future_to_persona):
            persona_key = future_to_persona[future]
            try:
                persona_key, result, success = future.result()
                results[persona_key] = {
                    'result': result,
                    'success': success,
                    'completed': True,
                    'timestamp': datetime.now().isoformat()
                }
                
                st.session_state['completed_personas'].add(persona_key)
                
                if persona_progress[persona_key] is not None:
                    persona_progress[persona_key].progress(100)
                
                persona_info = PERSONAS[persona_key]
                if success:
                    completion_message = PERSONA_ANALYSIS_STAGES[persona_key][-1]['message']
                    persona_status[persona_key].markdown(f"""
                    <div class="analysis-complete">
                        <h4>ğŸ‰ {persona_info['emoji']} {persona_info['name']}</h4>
                        <p style="margin: 5px 0; font-size: 0.9rem; color: #155724;">
                            {completion_message}<br>
                            ì™„ë£Œ ì‹œê°„: {datetime.fromisoformat(results[persona_key]['timestamp']).strftime('%H:%M:%S')}
                        </p>
                    </div>
                    """, unsafe_allow_html=True)
                else:
                    persona_status[persona_key].markdown(f"""
                    <div style="background: #f8d7da; border: 2px solid #dc3545; border-radius: 12px; padding: 15px; margin: 10px 0; text-align: center;">
                        <h4 style="color: #721c24; margin: 0;">âŒ {persona_info['emoji']} {persona_info['name']} ë¶„ì„ ì˜¤ë¥˜</h4>
                        <p style="margin: 5px 0; font-size: 0.9rem; color: #721c24;">
                            ì˜¤ë¥˜ ì‹œê°„: {datetime.fromisoformat(results[persona_key]['timestamp']).strftime('%H:%M:%S')}
                        </p>
                    </div>
                    """, unsafe_allow_html=True)
                    
            except Exception as e:
                import traceback
                error_details = traceback.format_exc()
                results[persona_key] = {
                    'result': f"ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {str(e)}\nìƒì„¸: {error_details}",
                    'success': False,
                    'completed': True,
                    'timestamp': datetime.now().isoformat()
                }
                st.session_state['completed_personas'].add(persona_key)
    
    return results

# ==================== ì‚¬ì´ë“œë°” ì„¤ì • ====================

# ì‚¬ì´ë“œë°” ì„¤ì •
st.sidebar.title("ğŸ¢ C-Level ë©€í‹°ì—ì´ì „íŠ¸ ì„¤ì •")

# ëª¨ë¸ ì„ íƒ
available_models = []
has_anthropic_key = os.environ.get('ANTHROPIC_API_KEY') is not None
if has_anthropic_key:
    available_models.extend([
        'claude-3-7-sonnet-latest',
        'claude-3-5-sonnet-latest',
        'claude-3-5-haiku-latest',
    ])
has_openai_key = os.environ.get('OPENAI_API_KEY') is not None
if has_openai_key:
    available_models.extend(['gpt-4o', 'gpt-4o-mini'])

if not available_models:
    st.sidebar.error("API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
    available_models = ['claude-3-7-sonnet-latest']  # ê¸°ë³¸ê°’

selected_model = st.sidebar.selectbox(
    'ğŸ§  AI ëª¨ë¸ ì„ íƒ',
    options=available_models,
    index=available_models.index(st.session_state.selected_model) if st.session_state.selected_model in available_models else 0,
    help='ClaudeëŠ” ANTHROPIC_API_KEY, OpenAIëŠ” OPENAI_API_KEY í•„ìš”'
)

if selected_model != st.session_state.selected_model:
    st.session_state.selected_model = selected_model

st.sidebar.markdown("---")

# RAG ë°ì´í„° ì†ŒìŠ¤ ì„¤ì •
st.sidebar.markdown("### ğŸ” RAG ë°ì´í„° ì†ŒìŠ¤ ì„¤ì •")
st.sidebar.markdown("**ğŸ“Š ë¶„ì„ì— ì‚¬ìš©í•  ì¶”ê°€ ë°ì´í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”**")
st.sidebar.info("ğŸ’¡ RAG ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ë©´ ë” ì •í™•í•˜ê³  êµ¬ì²´ì ì¸ ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤!")

# í˜„ì¬ í™œì„± RAG ì†ŒìŠ¤ í‘œì‹œ
if st.session_state.rag_sources:
    # ì•ˆì „í•œ ë°©ì‹ìœ¼ë¡œ RAG ì†ŒìŠ¤ ìƒíƒœ í‘œì‹œ
    rag_names = []
    for source in st.session_state.rag_sources:
        if source in RAG_SOURCES:
            rag_names.append(f"{RAG_SOURCES[source]['emoji']} {RAG_SOURCES[source]['name']}")
    if rag_names:
        rag_status = "âœ… " + ", ".join(rag_names)
        st.sidebar.success(f"í™œì„± RAG ì†ŒìŠ¤: {rag_status}")
else:
    st.sidebar.warning("âŒ í™œì„± RAG ì†ŒìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ì—ì„œ ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.")

# MySQL ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
with st.sidebar.expander("ğŸ—„ï¸ MySQL ë°ì´í„°ë² ì´ìŠ¤", expanded=True):
    if st.sidebar.button("ğŸ” DB ì—°ê²° í…ŒìŠ¤íŠ¸", key="mysql_test"):
        success, message = test_mysql_connection()
        if success:
            st.sidebar.success(f"âœ… {message}")
        else:
            st.sidebar.error(f"âŒ {message}")
    
    if st.sidebar.button("ğŸ“‹ í…Œì´ë¸” ëª©ë¡ ì¡°íšŒ", key="mysql_tables"):
        tables, table_info = get_mysql_tables()
        if tables:
            st.session_state.available_tables = tables
            st.session_state.table_info = table_info
            st.sidebar.success(f"âœ… {len(tables)}ê°œ í…Œì´ë¸” ë°œê²¬")
        else:
            st.sidebar.error("âŒ í…Œì´ë¸” ì¡°íšŒ ì‹¤íŒ¨")
    
    # í…Œì´ë¸” ì„ íƒ
    if 'available_tables' in st.session_state:
        selected_tables = st.sidebar.multiselect(
            "ë¶„ì„í•  í…Œì´ë¸” ì„ íƒ",
            st.session_state.available_tables,
            help="ë„ˆë¬´ ë§ì€ í…Œì´ë¸”ì„ ì„ íƒí•˜ë©´ ì„±ëŠ¥ì´ ì €í•˜ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
            key="mysql_table_select"
        )
        
        if st.sidebar.button("ğŸ“¥ ì„ íƒëœ í…Œì´ë¸” ë¡œë“œ", key="mysql_load") and selected_tables:
            with st.sidebar:
                with st.spinner("MySQL ë°ì´í„° ë¡œë”© ì¤‘..."):
                    data_frames = load_mysql_data(selected_tables)
                    if data_frames:
                        st.session_state.mysql_data = data_frames
                        if 'mysql' not in st.session_state.rag_sources:
                            st.session_state.rag_sources.append('mysql')
                        total_rows = sum(len(df) for df in data_frames.values())
                        st.sidebar.success(f"âœ… {len(selected_tables)}ê°œ í…Œì´ë¸” ë¡œë“œ ì™„ë£Œ! (ì´ {total_rows:,}í–‰)")

# ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ì„¤ì •
with st.sidebar.expander("ğŸŒ ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§", expanded=True):
    website_url = st.sidebar.text_input("ì›¹ì‚¬ì´íŠ¸ URL", placeholder="https://example.com", key="website_url")
    max_pages = st.sidebar.slider("ìµœëŒ€ í˜ì´ì§€ ìˆ˜", 1, 10, 5, key="website_pages")
    
    if st.sidebar.button("ğŸ•·ï¸ ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ì‹œì‘", key="website_crawl") and website_url:
        with st.sidebar:
            with st.spinner("ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ì¤‘..."):
                scraped_data = scrape_website_simple(website_url, max_pages)
                if scraped_data:
                    st.session_state.website_data = scraped_data
                    if 'website' not in st.session_state.rag_sources:
                        st.session_state.rag_sources.append('website')
                    st.sidebar.success(f"âœ… {len(scraped_data)}ê°œ í˜ì´ì§€ í¬ë¡¤ë§ ì™„ë£Œ!")
                else:
                    st.sidebar.error("âŒ í¬ë¡¤ë§ ì‹¤íŒ¨")

# íŒŒì¼ ì—…ë¡œë“œ ì„¤ì •
with st.sidebar.expander("ğŸ“„ ë¬¸ì„œ íŒŒì¼", expanded=True):
    files = st.sidebar.file_uploader(
        "íŒŒì¼ ì—…ë¡œë“œ",
        type=list(SUPPORTED_FILE_TYPES.keys()),
        accept_multiple_files=True,
        help="ì—¬ëŸ¬ íŒŒì¼ì„ ë™ì‹œì— ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
        key="file_upload"
    )
    
    if files:
        valid_files = []
        for file in files:
            errors = validate_file(file)
            if not errors:
                valid_files.append(file)
            else:
                for error in errors:
                    st.sidebar.error(f"âŒ {file.name}: {error}")
        
        if valid_files and st.sidebar.button("ğŸ“ íŒŒì¼ ì²˜ë¦¬", key="file_process"):
            with st.sidebar:
                with st.spinner("íŒŒì¼ ì²˜ë¦¬ ì¤‘..."):
                    processed_files = process_files(valid_files)
                    if processed_files:
                        st.session_state.files_data = processed_files
                        if 'files' not in st.session_state.rag_sources:
                            st.session_state.rag_sources.append('files')
                        total_size = sum(f['size'] for f in processed_files)
                        st.sidebar.success(f"âœ… {len(processed_files)}ê°œ íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ! (ì´ {total_size:,}ì)")

# RAG ì†ŒìŠ¤ í˜„í™© í‘œì‹œ
if st.session_state.rag_sources:
    st.sidebar.markdown("### ğŸ“Š í™œì„± RAG ì†ŒìŠ¤")
    for source in st.session_state.rag_sources:
        if source in RAG_SOURCES:
            source_info = RAG_SOURCES[source]
            st.sidebar.markdown(f"âœ… {source_info['emoji']} {source_info['name']}")

st.sidebar.markdown("---")

# ë¶„ì„ í˜„í™© í‘œì‹œ
st.sidebar.subheader("ğŸ“Š ë¶„ì„ í˜„í™©")
if st.session_state.current_analysis:
    completed = len([k for k, v in st.session_state.current_analysis.items() if v.get('completed', False)])
    total = len(PERSONAS)
    st.sidebar.progress(completed / total)
    st.sidebar.write(f"ì§„í–‰ë¥ : {completed}/{total}")

# RAG ë°ì´í„° ìš”ì•½ í‘œì‹œ
if st.session_state.rag_sources:
    st.sidebar.markdown("### ğŸ“‹ ë¡œë“œëœ ë°ì´í„° ìš”ì•½")
    
    if 'mysql' in st.session_state.rag_sources and st.session_state.mysql_data:
        total_mysql_rows = sum(len(df) for df in st.session_state.mysql_data.values())
        st.sidebar.write(f"ğŸ—„ï¸ MySQL: {len(st.session_state.mysql_data)}ê°œ í…Œì´ë¸” ({total_mysql_rows:,}í–‰)")
    
    if 'website' in st.session_state.rag_sources and st.session_state.website_data:
        total_pages = len(st.session_state.website_data)
        st.sidebar.write(f"ğŸŒ ì›¹ì‚¬ì´íŠ¸: {total_pages}ê°œ í˜ì´ì§€")
    
    if 'files' in st.session_state.rag_sources and st.session_state.files_data:
        total_files = len(st.session_state.files_data)
        total_chars = sum(f['size'] for f in st.session_state.files_data)
        st.sidebar.write(f"ğŸ“„ íŒŒì¼: {total_files}ê°œ ë¬¸ì„œ ({total_chars:,}ì)")

# RAG ì†ŒìŠ¤ ê´€ë¦¬ ë²„íŠ¼ë“¤
if st.session_state.rag_sources:
    st.sidebar.markdown("### ğŸ”§ ë°ì´í„° ê´€ë¦¬")
    
    if st.sidebar.button("ğŸ—‘ï¸ ëª¨ë“  RAG ë°ì´í„° ì´ˆê¸°í™”", key="rag_reset"):
        st.session_state.rag_sources = []
        st.session_state.mysql_data = {}
        st.session_state.website_data = {}
        st.session_state.files_data = {}
        if 'available_tables' in st.session_state:
            del st.session_state.available_tables
        if 'table_info' in st.session_state:
            del st.session_state.table_info
        st.rerun()

st.sidebar.markdown("---")

# í˜ë¥´ì†Œë‚˜ë³„ ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ ì„¤ì •
st.sidebar.subheader("ğŸ­ í˜ë¥´ì†Œë‚˜ë³„ ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸")
st.sidebar.markdown("*ê° ì„ì›ì§„ì—ê²Œ íŠ¹ë³„í•œ ì§€ì‹œì‚¬í•­ì´ ìˆë‹¤ë©´ ì…ë ¥í•˜ì„¸ìš”*")

persona_prompts = {}
for persona_key, persona_info in PERSONAS.items():
    with st.sidebar.expander(f"{persona_info['emoji']} {persona_info['name']}"):
        st.markdown(f"**ì—­í• **: {persona_info['role']}")
        st.markdown(f"**ì „ë¬¸ë¶„ì•¼**: {persona_info['expertise']}")
        
        prompt_key = f"custom_prompt_{persona_key}"
        if prompt_key not in st.session_state:
            st.session_state[prompt_key] = ""
        
        persona_prompts[persona_key] = st.text_area(
            f"ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸",
            value=st.session_state[prompt_key],
            key=prompt_key,
            height=100,
            placeholder=f"{persona_info['name']}ì—ê²Œ íŠ¹ë³„íˆ ë¶„ì„í•´ë‹¬ë¼ê³  ìš”ì²­í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...",
            help=f"{persona_info['perspective']}"
        )

# ==================== ë©”ì¸ ì¸í„°í˜ì´ìŠ¤ ====================

st.markdown('<h1 class="main-title">ğŸ¢ ê°€ìƒíšŒì‚¬ C-Level ë©€í‹°ì—ì´ì „íŠ¸ + RAG</h1>', unsafe_allow_html=True)
st.markdown('<p class="main-subtitle"><strong>ë‹¹ì‹ ì€ CEOì…ë‹ˆë‹¤. C-level ì„ì›ì§„ë“¤ì´ ë‹¤ì–‘í•œ ë°ì´í„°ë¥¼ í™œìš©í•˜ì—¬ í˜‘ë ¥ ë¶„ì„í•˜ê³ , ìµœì¢… ì¢…í•© ë³´ê³ ì„œë¥¼ ì œê³µí•©ë‹ˆë‹¤.</strong></p>', unsafe_allow_html=True)

# í˜„ì¬ ì„¤ì • ì •ë³´ í‘œì‹œ
st.markdown("### âš™ï¸ í˜„ì¬ ì‹œìŠ¤í…œ ì„¤ì •")
col1, col2, col3 = st.columns([2, 2, 1])
with col1:
    st.markdown(f"**ğŸ§  AI ëª¨ë¸**: `{selected_model}`")
    
    # API í‚¤ ìƒíƒœ í™•ì¸
    if selected_model.startswith('claude'):
        api_key = os.getenv('ANTHROPIC_API_KEY')
        if api_key and len(api_key) > 10:
            st.markdown(f"**ğŸ”‘ Anthropic API**: âœ… ì„¤ì •ë¨ (`{api_key[:8]}...`)")
        else:
            st.markdown("**ğŸ”‘ Anthropic API**: âŒ ì„¤ì •ë˜ì§€ ì•ŠìŒ")
    else:
        api_key = os.getenv('OPENAI_API_KEY')
        if api_key and len(api_key) > 10:
            st.markdown(f"**ğŸ”‘ OpenAI API**: âœ… ì„¤ì •ë¨ (`{api_key[:8]}...`)")
        else:
            st.markdown("**ğŸ”‘ OpenAI API**: âŒ ì„¤ì •ë˜ì§€ ì•ŠìŒ")
            
with col2:
    if st.session_state.rag_sources:
        # ì•ˆì „í•œ ë°©ì‹ìœ¼ë¡œ RAG ì†ŒìŠ¤ ì´ëª¨ì§€ ìƒì„±
        rag_emojis = []
        for source in st.session_state.rag_sources:
            if source in RAG_SOURCES:
                rag_emojis.append(RAG_SOURCES[source]['emoji'])
        rag_emoji = "".join(rag_emojis)
        st.markdown(f"**ğŸ” RAG ì†ŒìŠ¤**: {rag_emoji} `{len(st.session_state.rag_sources)}ê°œ í™œì„±`")
    else:
        st.markdown("**ğŸ” RAG ì†ŒìŠ¤**: âš ï¸ `ì—†ìŒ (ì‚¬ì´ë“œë°”ì—ì„œ ì„¤ì •)`")
with col3:
    if st.button("ğŸ”„ ì´ˆê¸°í™”", help="ëª¨ë“  ë¶„ì„ ê²°ê³¼ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤"):
        st.session_state.current_analysis = {}
        st.session_state.analysis_complete = False
        st.rerun()

# API í‚¤ í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ì¶”ê°€
if st.button("ğŸ§ª AI ëª¨ë¸ ì—°ê²° í…ŒìŠ¤íŠ¸", help="ì„ íƒëœ AI ëª¨ë¸ê³¼ì˜ ì—°ê²°ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤"):
    try:
        test_response = get_ai_response("ì•ˆë…•í•˜ì„¸ìš”. ê°„ë‹¨í•œ ì¸ì‚¬ë§ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”.", selected_model, "ë‹¹ì‹ ì€ ë„ì›€ì´ ë˜ëŠ” AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.")
        if test_response:
            st.success(f"âœ… AI ëª¨ë¸ ì—°ê²° ì„±ê³µ!\nì‘ë‹µ: {test_response[:100]}...")
        else:
            st.error("âŒ AI ëª¨ë¸ ì‘ë‹µì´ Noneì…ë‹ˆë‹¤. API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")
    except Exception as e:
        st.error(f"âŒ AI ëª¨ë¸ ì—°ê²° ì‹¤íŒ¨: {str(e)}")

st.markdown("---")

# RAG ì„¤ì • ê°€ì´ë“œ
if not st.session_state.rag_sources:
    st.info("ğŸ’¡ **ë” ì •í™•í•œ ë¶„ì„ì„ ìœ„í•´ ì‚¬ì´ë“œë°”ì—ì„œ RAG ë°ì´í„° ì†ŒìŠ¤ë¥¼ ì„¤ì •í•´ë³´ì„¸ìš”!**\n"
           "- ğŸ—„ï¸ **MySQL**: íšŒì‚¬ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°\n"
           "- ğŸŒ **ì›¹ì‚¬ì´íŠ¸**: ì‹œì¥ ë™í–¥ ë° ê²½ìŸì‚¬ ì •ë³´ ìˆ˜ì§‘\n"
           "- ğŸ“„ **ë¬¸ì„œ**: ë³´ê³ ì„œ, ê³„íšì„œ ë“± ê´€ë ¨ ë¬¸ì„œ ì—…ë¡œë“œ")

# ì„ì›ì§„ ì†Œê°œ
st.markdown("## ğŸ‘¥ C-Level ì„ì›ì§„")
cols = st.columns(3)
for i, (persona_key, persona_info) in enumerate(PERSONAS.items()):
    with cols[i % 3]:
        st.markdown(f"""
        <div class="persona-card">
            <div class="persona-header">
                <div class="persona-emoji">{persona_info['emoji']}</div>
                <div>
                    <div class="persona-title">{persona_info['name']}</div>
                    <div class="persona-subtitle">{persona_info['role']}</div>
                </div>
            </div>
            <div style="font-size: 0.85rem; color: #666;">
                {persona_info['expertise']}
            </div>
        </div>
        """, unsafe_allow_html=True)

st.markdown("---")

# ë©”ì¸ ì…ë ¥
user_query = st.text_area(
    "ğŸ“ CEOë‹˜, ì–´ë–¤ ì£¼ì œì— ëŒ€í•´ C-level ì„ì›ì§„ë“¤ì˜ ë¶„ì„ì´ í•„ìš”í•˜ì‹ ê°€ìš”?",
    height=120,
    placeholder="ì˜ˆ: ìƒˆë¡œìš´ AI ì„œë¹„ìŠ¤ ë¡ ì¹­ ì „ëµì— ëŒ€í•´ ë¶„ì„í•´ì£¼ì„¸ìš”...\nì˜ˆ: ë””ì§€í„¸ ì „í™˜ì„ ìœ„í•œ íˆ¬ì ê³„íšì„ ê²€í† í•´ì£¼ì„¸ìš”...\nì˜ˆ: í•´ì™¸ ì‹œì¥ ì§„ì¶œ ë°©ì•ˆì„ ë¶„ì„í•´ì£¼ì„¸ìš”..."
)

# ë¶„ì„ ë²„íŠ¼ (í…ŒìŠ¤íŠ¸ìš© ìµœì†Œí•œ ë²„ì „)
if st.button("ğŸš€ C-Level ì„ì›ì§„ ë¶„ì„ ì‹œì‘", type="primary", use_container_width=True):
    if not user_query.strip():
        st.warning("ë¶„ì„í•  ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
    else:
        st.session_state.current_analysis = {}
        st.session_state.analysis_complete = False
        
        # ì§„í–‰ ìƒí™© í‘œì‹œ
        progress_container = st.container()
        
        with progress_container:
            # RAG ë°ì´í„° í™œìš© ìƒíƒœ í‘œì‹œ
            rag_status_container = st.container()
            with rag_status_container:
                if st.session_state.rag_sources:
                    st.success(f"ğŸ” **RAG ë°ì´í„° í™œìš© ë¶„ì„**: {len(st.session_state.rag_sources)}ê°œì˜ ë°ì´í„° ì†ŒìŠ¤ê°€ ë¶„ì„ì— í¬í•¨ë©ë‹ˆë‹¤!")
                    
                    # ê° RAG ì†ŒìŠ¤ë³„ ìƒì„¸ ì •ë³´
                    rag_details = []
                    if 'mysql' in st.session_state.rag_sources and st.session_state.mysql_data:
                        total_mysql_rows = sum(len(df) for df in st.session_state.mysql_data.values())
                        rag_details.append(f"ğŸ—„ï¸ MySQL: {len(st.session_state.mysql_data)}ê°œ í…Œì´ë¸” ({total_mysql_rows:,}í–‰)")
                    
                    if 'website' in st.session_state.rag_sources and st.session_state.website_data:
                        rag_details.append(f"ğŸŒ ì›¹ì‚¬ì´íŠ¸: {len(st.session_state.website_data)}ê°œ í˜ì´ì§€")
                    
                    if 'files' in st.session_state.rag_sources and st.session_state.files_data:
                        total_chars = sum(f['size'] for f in st.session_state.files_data)
                        rag_details.append(f"ğŸ“„ íŒŒì¼: {len(st.session_state.files_data)}ê°œ ë¬¸ì„œ ({total_chars:,}ì)")
                    
                    if rag_details:
                        st.info(" | ".join(rag_details))
                else:
                    st.warning("âš ï¸ **ê¸°ë³¸ ë¶„ì„ ëª¨ë“œ**: RAG ë°ì´í„°ê°€ ì—†ì–´ ì¼ë°˜ì ì¸ ì „ë¬¸ ì§€ì‹ì„ ë°”íƒ•ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.")
            
            st.markdown("""
            <div class="progress-section">
                <h2>ğŸš€ C-Level ì„ì›ì§„ ë™ì‹œ ë¶„ì„ ì‹œì‘!</h2>
                <p style="text-align: center; color: #666; margin-top: 10px;">
                    ëª¨ë“  ì„ì›ì§„ì´ ë™ì‹œì— ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤...
                </p>
            </div>
            """, unsafe_allow_html=True)
            
            # ëª¨ë“  í˜ë¥´ì†Œë‚˜ì— ëŒ€í•´ "ë¶„ì„ ì‹œì‘" ìƒíƒœ í‘œì‹œ
            persona_status = {}
            persona_progress = {}
            for persona_key, persona_info in PERSONAS.items():
                persona_status[persona_key] = st.empty()
                
                # ì²« ë²ˆì§¸ ë‹¨ê³„ë¡œ ì´ˆê¸° ìƒíƒœ í‘œì‹œ
                first_stage = PERSONA_ANALYSIS_STAGES[persona_key][0]
                persona_status[persona_key].markdown(f"""
                <div class="progress-indicator">
                    <strong>ğŸš€ {persona_info['emoji']} {persona_info['name']}</strong><br>
                    <span style="font-size: 0.9rem;">{first_stage['message']} (0%)</span>
                </div>
                """, unsafe_allow_html=True)
                
                # ì§„í–‰ë¥  ë°” ì¶”ê°€
                persona_progress[persona_key] = st.progress(0)
                st.markdown(f"<div style='margin-bottom: 20px;'></div>", unsafe_allow_html=True)
            
            # ë™ì‹œ ë¶„ì„ ì‹¤í–‰
            with st.spinner("ğŸ”¥ ëª¨ë“  C-Level ì„ì›ì§„ì´ ë™ì‹œì— ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤..."):
                # ì‹¤ì œ ë™ì‹œ ë¶„ì„ ìˆ˜í–‰
                analysis_results = run_concurrent_analysis_with_progress_rag(user_query, persona_prompts, persona_status, persona_progress, selected_model)
                
                # ê²°ê³¼ë¥¼ ì„¸ì…˜ì— ì €ì¥
                for persona_key, result_data in analysis_results.items():
                    st.session_state.current_analysis[persona_key] = result_data
                
                # ë¶„ì„ ê²°ê³¼ í‘œì‹œ (expanderë¡œ)
                st.markdown("### ğŸ“‹ ìƒì„¸ ë¶„ì„ ê²°ê³¼")
                for persona_key, result_data in analysis_results.items():
                    persona_info = PERSONAS[persona_key]
                    
                    if result_data['success']:
                        with st.expander(f"ğŸ“‹ {persona_info['emoji']} {persona_info['name']} ìƒì„¸ ë¶„ì„ ê²°ê³¼", expanded=True):
                            st.markdown(result_data['result'])
                    else:
                        with st.expander(f"âŒ {persona_info['emoji']} {persona_info['name']} ì˜¤ë¥˜ ìƒì„¸", expanded=True):
                            st.error(f"ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {result_data['result']}")
            
            # ì„±ê³µí•œ ë¶„ì„ë§Œ CEO ì¢…í•© ë¶„ì„ì— ì‚¬ìš©
            successful_analyses = {
                k: v for k, v in st.session_state.current_analysis.items() 
                if v.get('success', False)
            }
            
            if successful_analyses:
                # CEO ì¢…í•© ë¶„ì„
                st.markdown("---")
                
                # RAG ìƒíƒœì— ë”°ë¥¸ CEO ë¶„ì„ ë©”ì‹œì§€
                if st.session_state.rag_sources:
                    st.markdown("""
                    <div class="ceo-synthesis">
                        <strong>ğŸ‘‘ CEO ìµœì¢… ì¢…í•© ë¶„ì„ ì¤‘... (RAG ë°ì´í„° í¬í•¨)</strong>
                        <p style="margin: 10px 0; font-size: 0.9rem;">
                            ëª¨ë“  ì„ì›ì§„ì˜ ë¶„ì„ ê²°ê³¼ì™€ RAG ë°ì´í„°ë¥¼ ì¢…í•©í•˜ì—¬ ìµœì¢… ì˜ì‚¬ê²°ì •ì„ ìˆ˜ë¦½í•©ë‹ˆë‹¤
                        </p>
                    </div>
                    """, unsafe_allow_html=True)
                else:
                    st.markdown("""
                    <div class="ceo-synthesis">
                        <strong>ğŸ‘‘ CEO ìµœì¢… ì¢…í•© ë¶„ì„ ì¤‘... (ê¸°ë³¸ ë¶„ì„)</strong>
                        <p style="margin: 10px 0; font-size: 0.9rem;">
                            ëª¨ë“  ì„ì›ì§„ì˜ ë¶„ì„ ê²°ê³¼ë¥¼ ì¢…í•©í•˜ì—¬ ìµœì¢… ì˜ì‚¬ê²°ì •ì„ ìˆ˜ë¦½í•©ë‹ˆë‹¤
                        </p>
                    </div>
                    """, unsafe_allow_html=True)
                
                with st.spinner("CEO ìµœì¢… ì¢…í•© ë¶„ì„ ì¤‘..."):
                    ceo_synthesis = synthesize_ceo_analysis_rag(user_query, successful_analyses, selected_model)
                    
                    if ceo_synthesis:
                        st.session_state.current_analysis['CEO'] = {
                            'result': ceo_synthesis,
                            'completed': True,
                            'timestamp': datetime.now().isoformat()
                        }
                        st.session_state.analysis_complete = True
            else:
                st.error("âŒ ëª¨ë“  ì„ì›ì§„ ë¶„ì„ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.")
        
        # ì§„í–‰ ìƒí™© í‘œì‹œ ì œê±°
        progress_container.empty()
        
        if st.session_state.analysis_complete:
            st.balloons()
            st.success("ğŸ‰ ë™ì‹œ ë¶„ì„ì´ ëª¨ë‘ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")

# ë¶„ì„ ê²°ê³¼ í‘œì‹œ
if st.session_state.analysis_complete and 'CEO' in st.session_state.current_analysis:
    st.markdown("---")
    st.markdown("## ğŸ‘‘ CEO ìµœì¢… ì¢…í•© ë³´ê³ ì„œ")
    
    st.markdown(f"""
    <div class="ceo-final">
        <h3>ğŸ‘‘ CEO ìµœì¢… ì˜ì‚¬ê²°ì • ë³´ê³ ì„œ</h3>
        <p><strong>ë¶„ì„ ì™„ë£Œ ì‹œê°„:</strong> {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</p>
    </div>
    """, unsafe_allow_html=True)
    
    st.markdown(st.session_state.current_analysis['CEO']['result'])
    
    # ê°œë³„ ì„ì›ì§„ ë¶„ì„ ê²°ê³¼ (ì ‘ì„ ìˆ˜ ìˆëŠ” í˜•íƒœ)
    st.markdown("## ğŸ“‹ ê°œë³„ ì„ì›ì§„ ë¶„ì„ ê²°ê³¼")
    
    for persona_key, persona_info in PERSONAS.items():
        if persona_key in st.session_state.current_analysis:
            analysis_data = st.session_state.current_analysis[persona_key]
            with st.expander(f"{persona_info['emoji']} {persona_info['name']} ìƒì„¸ ë¶„ì„"):
                st.markdown(f"**ë¶„ì„ ì‹œê°„:** {analysis_data['timestamp']}")
                st.markdown("---")
                st.markdown(analysis_data['result'])

# í‘¸í„°
st.markdown("---")

# ì‚¬ìš©ë²• ì•ˆë‚´
with st.expander("ğŸ’¡ ì‚¬ìš©ë²• ì•ˆë‚´"):
    st.markdown("""
    ### ğŸ¢ C-Level ë©€í‹°ì—ì´ì „íŠ¸ + RAG ì‹œìŠ¤í…œ ì‚¬ìš©ë²•
    
    #### ğŸš€ ê¸°ë³¸ ì‚¬ìš© ë‹¨ê³„
    1. **ëª¨ë¸ ì„ íƒ**: ì‚¬ì´ë“œë°”ì—ì„œ ì‚¬ìš©í•  AI ëª¨ë¸ì„ ì„ íƒí•˜ì„¸ìš” (Claude/ChatGPT)
    2. **RAG ë°ì´í„° ì¤€ë¹„**: ë¶„ì„ì— í™œìš©í•  ì¶”ê°€ ë°ì´í„°ë¥¼ ì„¤ì •í•˜ì„¸ìš”
       - ğŸ—„ï¸ **MySQL ë°ì´í„°ë² ì´ìŠ¤**: íšŒì‚¬ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ë° í…Œì´ë¸” ì„ íƒ
       - ğŸŒ **ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§**: ê´€ë ¨ ì›¹ì‚¬ì´íŠ¸ì˜ ìµœì‹  ì •ë³´ ìˆ˜ì§‘
       - ğŸ“„ **ë¬¸ì„œ íŒŒì¼**: ë³´ê³ ì„œ, ê³„íšì„œ ë“± ê´€ë ¨ ë¬¸ì„œ ì—…ë¡œë“œ
    3. **ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸**: ê° ì„ì›ì§„ì—ê²Œ íŠ¹ë³„í•œ ë¶„ì„ì„ ìš”ì²­í•˜ê³  ì‹¶ë‹¤ë©´ ì„¤ì •í•˜ì„¸ìš”
    4. **ì£¼ì œ ì…ë ¥**: ë©”ì¸ ì°½ì—ì„œ ë¶„ì„í•˜ê³  ì‹¶ì€ ì£¼ì œë‚˜ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”
    5. **ë™ì‹œ ë¶„ì„**: ëª¨ë“  C-Level ì„ì›ì§„ì´ **ì‹¤ì œë¡œ ë™ì‹œì—** RAG ë°ì´í„°ë¥¼ í™œìš©í•˜ì—¬ ë¶„ì„í•©ë‹ˆë‹¤ ğŸš€
    6. **CEO ì¢…í•©**: ëª¨ë“  ë¶„ì„ì´ ëë‚˜ë©´ CEO(ë‹¹ì‹ )ê°€ ìµœì¢… ì¢…í•© ì˜ì‚¬ê²°ì •ì„ ì œì‹œí•©ë‹ˆë‹¤
    
    #### ğŸ­ í˜ë¥´ì†Œë‚˜ë³„ íŠ¹ì§•
    - **ğŸ’» CTO**: ê¸°ìˆ ì  íƒ€ë‹¹ì„±ê³¼ êµ¬í˜„ ë°©ì•ˆ, ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜
    - **ğŸ¯ CSO(ì „ëµ)**: ì‹œì¥ ë¶„ì„ê³¼ ì„±ì¥ ì „ëµ, ê²½ìŸ ë¶„ì„
    - **ğŸ“¢ CMO**: ë§ˆì¼€íŒ…ê³¼ ê³ ê° ê²½í—˜, ë¸Œëœë“œ ì „ëµ
    - **ğŸ’° CFO**: ì¬ë¬´ì  íƒ€ë‹¹ì„±ê³¼ ë¦¬ìŠ¤í¬, íˆ¬ì ë¶„ì„
    - **ğŸ¤ CSO(ì˜ì—…)**: ì˜ì—… ì „ëµê³¼ ê³ ê° ê´€ê³„, ì‹œì¥ ê°œë°œ
    - **ğŸ” CIO**: ì •ë³´ì‹œìŠ¤í…œê³¼ ë°ì´í„° ì „ëµ, IT ê±°ë²„ë„ŒìŠ¤
    - **ğŸ‘‘ CEO**: ìµœì¢… ì¢…í•© ì˜ì‚¬ê²°ì • ë° í†µí•© ì‹¤í–‰ ê³„íš
    
    #### ğŸ” RAG ë°ì´í„° ì†ŒìŠ¤ë³„ í™œìš©ë²•
    
    **ğŸ—„ï¸ MySQL ë°ì´í„°ë² ì´ìŠ¤**
    - íšŒì‚¬ì˜ ì‹¤ì‹œê°„ ìš´ì˜ ë°ì´í„°ë¥¼ ë¶„ì„ì— í™œìš©
    - ê³ ê° ë°ì´í„°, ë§¤ì¶œ ë°ì´í„°, ì¬ê³  í˜„í™© ë“±
    - ì˜ˆì‹œ: "ì§€ë‚œ ë¶„ê¸° ë§¤ì¶œ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë§ˆì¼€íŒ… ì „ëµì„ ìˆ˜ë¦½í•´ì£¼ì„¸ìš”"
    
    **ğŸŒ ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§**
    - ê²½ìŸì‚¬ ì›¹ì‚¬ì´íŠ¸, ì—…ê³„ ë‰´ìŠ¤, ì‹œì¥ ë™í–¥ íŒŒì•…
    - ìµœì‹  íŠ¸ë Œë“œì™€ ì‹œì¥ ì •ë³´ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°˜ì˜
    - ì˜ˆì‹œ: "ê²½ìŸì‚¬ ì›¹ì‚¬ì´íŠ¸ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìš°ë¦¬ì˜ ì°¨ë³„í™” ì „ëµì„ ì œì•ˆí•´ì£¼ì„¸ìš”"
    
    **ğŸ“„ ë¬¸ì„œ íŒŒì¼**
    - ê¸°ì¡´ ë³´ê³ ì„œ, ê³„íšì„œ, ì‹œì¥ ì¡°ì‚¬ ìë£Œ ë“±
    - ê³¼ê±° ë°ì´í„°ì™€ ë¶„ì„ ê²°ê³¼ë¥¼ í˜„ì¬ ë¶„ì„ì— í™œìš©
    - ì˜ˆì‹œ: "ì‘ë…„ ì‚¬ì—… ê³„íšì„œë¥¼ ì°¸ê³ í•˜ì—¬ ì˜¬í•´ ì „ëµì„ ìˆ˜ì •í•´ì£¼ì„¸ìš”"
    
    #### âš¡ ë™ì‹œ ì²˜ë¦¬ì˜ ì¥ì 
    - **ì†ë„**: ìˆœì°¨ ì²˜ë¦¬ ëŒ€ë¹„ **6ë°° ë¹ ë¥¸** ë¶„ì„ ì†ë„
    - **íš¨ìœ¨ì„±**: ëª¨ë“  ì„ì›ì§„ì´ **ì‹¤ì œë¡œ ë™ì‹œì—** ì‘ì—…
    - **ë°ì´í„° í™œìš©**: RAGë¥¼ í†µí•´ **ì‹¤ì œ ë°ì´í„° ê¸°ë°˜** ë¶„ì„
    - **ì‹¤ì‹œê°„**: ì™„ë£Œë˜ëŠ” ìˆœì„œëŒ€ë¡œ **ì¦‰ì‹œ ê²°ê³¼ í™•ì¸**
    - **ê²¬ê³ ì„±**: ì¼ë¶€ ë¶„ì„ì´ ì‹¤íŒ¨í•´ë„ ë‚˜ë¨¸ì§€ëŠ” ì •ìƒ ì§„í–‰
    
    #### ğŸ’¡ íš¨ê³¼ì ì¸ í™œìš© íŒ
    
    **ì£¼ì œ ì„¤ì •**
    - êµ¬ì²´ì ì´ê³  ëª…í™•í•œ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”
    - ì˜ˆ: "ì‹ ì œí’ˆ ì¶œì‹œë¥¼ ìœ„í•œ ì¢…í•© ì „ëµ" â†’ "AI ê¸°ë°˜ ì±—ë´‡ ì„œë¹„ìŠ¤ ì¶œì‹œë¥¼ ìœ„í•œ ë§ˆì¼€íŒ…, ê¸°ìˆ , ì¬ë¬´ ì „ëµ"
    
    **RAG ë°ì´í„° ì¡°í•©**
    - ì—¬ëŸ¬ ë°ì´í„° ì†ŒìŠ¤ë¥¼ ì¡°í•©í•˜ë©´ ë” í’ë¶€í•œ ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤
    - MySQL(ë‚´ë¶€ ë°ì´í„°) + ì›¹ì‚¬ì´íŠ¸(ì™¸ë¶€ ì •ë³´) + ë¬¸ì„œ(ê³¼ê±° ìë£Œ) ì¡°í•© ì¶”ì²œ
    
    **ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ í™œìš©**
    - ê° ì„ì›ì§„ì˜ ì „ë¬¸ ë¶„ì•¼ì— ë§ëŠ” êµ¬ì²´ì ì¸ ìš”ì²­ì„ ì¶”ê°€í•˜ì„¸ìš”
    - ì˜ˆ: CFOì—ê²Œ "ROI ê³„ì‚°ê³¼ í•¨ê»˜ 3ë…„ ì¬ë¬´ ì „ë§ í¬í•¨", CTOì—ê²Œ "ê¸°ìˆ  êµ¬í˜„ ì¼ì •ê³¼ ë¦¬ì†ŒìŠ¤ ìš”êµ¬ì‚¬í•­ í¬í•¨"
    """)

st.markdown("""
<div style="text-align: center; color: #666; font-size: 0.9rem;">
    ğŸ¢ ê°€ìƒíšŒì‚¬ C-Level ë©€í‹°ì—ì´ì „íŠ¸ + RAG ì‹œìŠ¤í…œ | Powered by Claude & ChatGPT<br>
    ğŸ” RAG: MySQL Database + Website Crawling + Document Analysis
</div>
""", unsafe_allow_html=True) 