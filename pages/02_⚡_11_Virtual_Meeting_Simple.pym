import streamlit as st
from openai import OpenAI
import time
from datetime import datetime
import os
from typing import List, Dict
import uuid
from dotenv import load_dotenv
import pandas as pd
import json

load_dotenv()

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(
    page_title="Virtual Meeting Simple - AI ê°€ìƒ íšŒì˜",
    page_icon="ğŸ­",
    layout="wide"
)

class Persona:
    def __init__(self, name: str, role: str, personality: str, expertise: str, is_moderator: bool = False):
        self.id = str(uuid.uuid4())
        self.name = name
        self.role = role
        self.personality = personality
        self.expertise = expertise
        self.is_moderator = is_moderator
        self.prompt = self._generate_prompt()
    
    def _generate_prompt(self) -> str:
        if self.is_moderator:
            return f"""ë‹¹ì‹ ì€ {self.name}ì…ë‹ˆë‹¤. ì „ë¬¸ì ì¸ íšŒì˜ ì‚¬íšŒìë¡œì„œ í† ë¡ ì„ ì´ëŒì–´ê°€ì„¸ìš”.
            - ì°¸ê°€ìë“¤ì˜ ì˜ê²¬ì„ ì¡°ìœ¨í•˜ê³  ì •ë¦¬í•©ë‹ˆë‹¤
            - ì£¼ì œì—ì„œ ë²—ì–´ë‚˜ì§€ ì•Šë„ë¡ ì•ˆë‚´í•©ë‹ˆë‹¤
            - ê±´ì„¤ì ì¸ í† ë¡  ë¶„ìœ„ê¸°ë¥¼ ì¡°ì„±í•©ë‹ˆë‹¤
            ë§í•˜ëŠ” ìŠ¤íƒ€ì¼: ì •ì¤‘í•˜ê³  ëª…í™•í•˜ë©° ê°„ê²°í•©ë‹ˆë‹¤."""
        
        return f"""ë‹¹ì‹ ì€ {self.name}ì…ë‹ˆë‹¤.
        ì—­í• : {self.role}
        ì „ë¬¸ë¶„ì•¼: {self.expertise}
        ì„±ê²©: {self.personality}
        
        íšŒì˜ì—ì„œ ë‹¹ì‹ ì˜ ì „ë¬¸ì„±ì„ ë°”íƒ•ìœ¼ë¡œ ê±´ì„¤ì ì¸ ì˜ê²¬ì„ ì œì‹œí•˜ì„¸ìš”.
        2-3ë¬¸ì¥ìœ¼ë¡œ ê°„ê²°í•˜ê²Œ ë‹µë³€í•˜ì„¸ìš”."""

class Message:
    def __init__(self, persona_name: str, content: str, is_human: bool = False):
        self.timestamp = datetime.now()
        self.persona_name = persona_name
        self.content = content
        self.is_human = is_human

class VirtualMeeting:
    def __init__(self):
        self.personas: List[Persona] = []
        self.messages: List[Message] = []
        self.topic = ""
        self.is_active = False
        self.current_speaker_index = 0
        self.round_count = 0
        self.max_rounds = 5
        self.file_content = ""
    
    def add_persona(self, persona: Persona) -> bool:
        if len(self.personas) < 10:
            self.personas.append(persona)
            return True
        return False
    
    def get_moderator(self) -> Persona:
        for p in self.personas:
            if p.is_moderator:
                return p
        return None
    
    def get_non_moderator_personas(self) -> List[Persona]:
        return [p for p in self.personas if not p.is_moderator]
    
    def add_message(self, persona_name: str, content: str, is_human: bool = False):
        message = Message(persona_name, content, is_human)
        self.messages.append(message)
    
    def get_next_speaker(self) -> Persona:
        non_mods = self.get_non_moderator_personas()
        if not non_mods:
            return None
        return non_mods[self.current_speaker_index % len(non_mods)]
    
    def advance_speaker(self):
        non_mods = self.get_non_moderator_personas()
        if non_mods:
            self.current_speaker_index += 1
            if self.current_speaker_index % len(non_mods) == 0:
                self.round_count += 1

def initialize_session():
    if 'meeting' not in st.session_state:
        st.session_state.meeting = VirtualMeeting()
        
        # ê¸°ë³¸ ì‚¬íšŒì ì¶”ê°€
        moderator = Persona(
            name="ì‚¬íšŒì ê¹€ì§„í–‰",
            role="íšŒì˜ ì‚¬íšŒì",
            personality="ì°¨ë¶„í•˜ê³  ê³µì •í•œ ì„±ê²©",
            expertise="íšŒì˜ ì§„í–‰, í† ë¡  ì¡°ìœ¨",
            is_moderator=True
        )
        st.session_state.meeting.add_persona(moderator)

def extract_text_from_uploaded_file(uploaded_file) -> str:
    try:
        if uploaded_file.type == "text/plain":
            return str(uploaded_file.read(), "utf-8")
        elif uploaded_file.type == "text/csv":
            df = pd.read_csv(uploaded_file)
            return df.to_string()
        else:
            return "ì´ íŒŒì¼ í˜•ì‹ì€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
    except Exception as e:
        return f"íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: {str(e)}"

def generate_ai_response(persona: Persona, conversation_history: str, topic: str, file_context: str) -> str:
    try:
        # OpenAI API í‚¤ ê²€ì¦
        openai_key = os.getenv('OPENAI_API_KEY')
        if not openai_key or openai_key.strip() == '' or openai_key == 'NA':
            raise ValueError("OpenAI API í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. .env íŒŒì¼ì—ì„œ OPENAI_API_KEYë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")
        
        client = OpenAI(api_key=openai_key)
        
        context_prompt = f"""
        {persona.prompt}
        
        íšŒì˜ ì£¼ì œ: {topic}
        
        ì°¸ê³  ìë£Œ: {file_context[:1000] if file_context else "ì—†ìŒ"}
        
        ì§€ê¸ˆê¹Œì§€ì˜ ëŒ€í™”:
        {conversation_history}
        
        ìœ„ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ë‹¹ì‹ ì˜ ì „ë¬¸ì„±ì— ë§ëŠ” ì˜ê²¬ì„ 2-3ë¬¸ì¥ìœ¼ë¡œ ì œì‹œí•˜ì„¸ìš”.
        """
        
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": context_prompt},
                {"role": "user", "content": "íšŒì˜ì— ì°¸ì—¬í•˜ì—¬ ì˜ê²¬ì„ ë§ì”€í•´ì£¼ì„¸ìš”."}
            ],
            max_tokens=200,
            temperature=0.7
        )
        
        return response.choices[0].message.content.strip()
    except Exception as e:
        return f"[ì‘ë‹µ ìƒì„± ì˜¤ë¥˜: {str(e)}]"

def format_conversation_history(messages: List[Message], last_n: int = 8) -> str:
    recent = messages[-last_n:] if len(messages) > last_n else messages
    history = ""
    for msg in recent:
        history += f"{msg.persona_name}: {msg.content}\n"
    return history

def main():
    st.title("ğŸ­ Virtual Meeting Simple - AI ê°€ìƒ íšŒì˜")
    
    initialize_session()
    meeting = st.session_state.meeting
    
    # ìƒë‹¨ ì„¤ì • ì˜ì—­
    col1, col2, col3 = st.columns([2, 1, 1])
    
    with col1:
        meeting.topic = st.text_input(
            "ğŸ“‹ íšŒì˜ ì£¼ì œ",
            value=meeting.topic,
            placeholder="ì˜ˆ: ì‹ ì œí’ˆ ë§ˆì¼€íŒ… ì „ëµ íšŒì˜"
        )
    
    with col2:
        meeting.max_rounds = st.number_input("ìµœëŒ€ ë¼ìš´ë“œ", min_value=3, max_value=15, value=meeting.max_rounds)
    
    with col3:
        if not meeting.is_active:
            if st.button("ğŸš€ íšŒì˜ ì‹œì‘", type="primary"):
                if meeting.topic and len(meeting.personas) > 1:
                    meeting.is_active = True
                    meeting.round_count = 0
                    meeting.current_speaker_index = 0
                    # ì‚¬íšŒì ì¸ì‚¬ë§
                    moderator = meeting.get_moderator()
                    if moderator:
                        meeting.add_message(
                            moderator.name, 
                            f"ì•ˆë…•í•˜ì„¸ìš”. '{meeting.topic}'ì— ëŒ€í•´ ë…¼ì˜í•˜ê² ìŠµë‹ˆë‹¤. í™œë°œí•œ ì°¸ì—¬ ë¶€íƒë“œë¦½ë‹ˆë‹¤."
                        )
                    st.success("íšŒì˜ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!")
                    st.rerun()
                else:
                    st.error("ì£¼ì œ ì…ë ¥ê³¼ ìµœì†Œ 2ëª…ì˜ ì°¸ê°€ìê°€ í•„ìš”í•©ë‹ˆë‹¤.")
        else:
            if st.button("â¹ï¸ íšŒì˜ ì¢…ë£Œ"):
                meeting.is_active = False
                st.success("íšŒì˜ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")
                st.rerun()
    
    st.divider()
    
    # ë©”ì¸ íƒ­ë“¤
    tab1, tab2, tab3, tab4 = st.tabs(["ğŸ‘¥ ì°¸ê°€ì ê´€ë¦¬", "ğŸ’¬ ì‹¤ì‹œê°„ íšŒì˜", "ğŸ“Š í˜„í™©", "ğŸ“ íšŒì˜ë¡"])
    
    with tab1:
        st.subheader("ğŸ‘¥ ì°¸ê°€ì ê´€ë¦¬")
        
        # í”„ë¦¬ì…‹ ì°¸ê°€ìë“¤
        preset_personas = [
            {"name": "CEO ë°•ì„±ê³µ", "role": "ìµœê³ ê²½ì˜ì", "personality": "ë¹„ì „ ì œì‹œ, ë¦¬ë”ì‹­", "expertise": "ê²½ì˜ ì „ëµ, ì˜ì‚¬ê²°ì •"},
            {"name": "CTO ì´ê¸°ìˆ ", "role": "ê¸°ìˆ ì±…ì„ì", "personality": "ë…¼ë¦¬ì , ë¶„ì„ì ", "expertise": "ê¸°ìˆ  ê°œë°œ, í˜ì‹ "},
            {"name": "CMO ê¹€ë§ˆì¼€íŒ…", "role": "ë§ˆì¼€íŒ…ì±…ì„ì", "personality": "ì°½ì˜ì , ì†Œí†µ ì¤‘ì‹œ", "expertise": "ë§ˆì¼€íŒ…, ë¸Œëœë”©"},
            {"name": "CFO ì •ì¬ë¬´", "role": "ì¬ë¬´ì±…ì„ì", "personality": "ì‹ ì¤‘, ì •í™•ì„± ì¤‘ì‹œ", "expertise": "ì¬ë¬´ ë¶„ì„, ì˜ˆì‚° ê´€ë¦¬"},
        ]
        
        st.write("**í”„ë¦¬ì…‹ ì°¸ê°€ì ì¶”ê°€:**")
        selected_preset = st.selectbox(
            "ì„ íƒí•˜ì„¸ìš”:",
            options=range(len(preset_personas)),
            format_func=lambda x: f"{preset_personas[x]['name']} ({preset_personas[x]['role']})",
            index=None,
            placeholder="í”„ë¦¬ì…‹ ì„ íƒ..."
        )
        
        if selected_preset is not None:
            if st.button("â• í”„ë¦¬ì…‹ ì¶”ê°€"):
                preset = preset_personas[selected_preset]
                new_persona = Persona(
                    name=preset['name'],
                    role=preset['role'],
                    personality=preset['personality'],
                    expertise=preset['expertise']
                )
                if meeting.add_persona(new_persona):
                    st.success(f"{preset['name']} ì¶”ê°€ì™„ë£Œ!")
                    st.rerun()
                else:
                    st.error("ìµœëŒ€ 10ëª…ê¹Œì§€ë§Œ ì¶”ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.")
        
        st.divider()
        
        # ì»¤ìŠ¤í…€ ì°¸ê°€ì ì¶”ê°€
        st.write("**ì»¤ìŠ¤í…€ ì°¸ê°€ì ì¶”ê°€:**")
        with st.form("add_custom_persona"):
            col1, col2 = st.columns(2)
            with col1:
                name = st.text_input("ì´ë¦„", placeholder="ì˜ˆ: ê¹€ì „ë¬¸")
                role = st.text_input("ì—­í• ", placeholder="ì˜ˆ: ë°ì´í„° ë¶„ì„ê°€")
            with col2:
                personality = st.text_input("ì„±ê²©", placeholder="ì˜ˆ: ë…¼ë¦¬ì , ë°ì´í„° ì¤‘ì‹¬")
                expertise = st.text_input("ì „ë¬¸ë¶„ì•¼", placeholder="ì˜ˆ: ë°ì´í„° ë¶„ì„, í†µê³„")
            
            if st.form_submit_button("ì°¸ê°€ì ì¶”ê°€"):
                if name and role:
                    new_persona = Persona(name, role, personality, expertise)
                    if meeting.add_persona(new_persona):
                        st.success(f"{name} ì¶”ê°€ ì™„ë£Œ!")
                        st.rerun()
                    else:
                        st.error("ìµœëŒ€ 10ëª…ê¹Œì§€ë§Œ ì¶”ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.")
                else:
                    st.error("ì´ë¦„ê³¼ ì—­í• ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.")
        
        # í˜„ì¬ ì°¸ê°€ì ëª©ë¡
        st.subheader("í˜„ì¬ ì°¸ê°€ì ëª©ë¡")
        for i, persona in enumerate(meeting.personas):
            col1, col2 = st.columns([4, 1])
            with col1:
                icon = "ğŸ¯" if persona.is_moderator else "ğŸ­"
                st.write(f"{icon} **{persona.name}** ({persona.role})")
                st.caption(f"ì „ë¬¸ë¶„ì•¼: {persona.expertise} | ì„±ê²©: {persona.personality}")
            with col2:
                if not persona.is_moderator:
                    if st.button("ğŸ—‘ï¸", key=f"delete_{i}", help="ì‚­ì œ"):
                        meeting.personas.remove(persona)
                        st.success("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.")
                        st.rerun()
    
    with tab2:
        st.subheader("ğŸ’¬ ì‹¤ì‹œê°„ íšŒì˜")
        
        if not meeting.is_active:
            st.info("íšŒì˜ë¥¼ ì‹œì‘í•˜ë ¤ë©´ ìƒë‹¨ì˜ 'íšŒì˜ ì‹œì‘' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.")
        else:
            # ì§„í–‰ ìƒí™©
            col1, col2, col3, col4 = st.columns(4)
            with col1:
                st.metric("ğŸ”„ í˜„ì¬ ë¼ìš´ë“œ", f"{meeting.round_count + 1}")
            with col2:
                st.metric("ğŸ¤ ë‹¤ìŒ ë°œì–¸ì", meeting.get_next_speaker().name if meeting.get_next_speaker() else "ì—†ìŒ")
            with col3:
                st.metric("ğŸ’¬ ì´ ë©”ì‹œì§€", len(meeting.messages))
            with col4:
                remaining_rounds = meeting.max_rounds - meeting.round_count
                st.metric("â³ ë‚¨ì€ ë¼ìš´ë“œ", max(0, remaining_rounds))
            
            # ì‚¬íšŒì ê°œì…
            moderator = meeting.get_moderator()
            if moderator:
                st.subheader("ğŸ¯ ì‚¬íšŒì ê°œì…")
                with st.form("moderator_input"):
                    human_input = st.text_area(
                        f"{moderator.name}ë¡œì„œ ë°œì–¸:",
                        placeholder="ì˜ˆ: ì§€ê¸ˆê¹Œì§€ì˜ ì˜ê²¬ì„ ì •ë¦¬í•˜ë©´...",
                        height=80
                    )
                    if st.form_submit_button("ğŸ’¬ ë°œì–¸"):
                        if human_input:
                            meeting.add_message(moderator.name, human_input, is_human=True)
                            st.success("ë°œì–¸ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!")
                            st.rerun()
            
            # ëŒ€í™” ì§„í–‰
            st.subheader("ğŸ—£ï¸ ëŒ€í™” ì§„í–‰")
            
            col1, col2 = st.columns(2)
            with col1:
                if st.button("â¡ï¸ ë‹¤ìŒ ë°œì–¸", type="primary"):
                    if meeting.round_count < meeting.max_rounds:
                        current_speaker = meeting.get_next_speaker()
                        if current_speaker:
                            with st.spinner("AIê°€ ìƒê° ì¤‘..."):
                                conversation_history = format_conversation_history(meeting.messages)
                                response = generate_ai_response(
                                    current_speaker,
                                    conversation_history,
                                    meeting.topic,
                                    meeting.file_content
                                )
                                meeting.add_message(current_speaker.name, response)
                                meeting.advance_speaker()
                                st.rerun()
                    else:
                        st.info("íšŒì˜ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")
            
            with col2:
                if st.button("â­ï¸ ë¼ìš´ë“œ ìŠ¤í‚µ"):
                    meeting.round_count += 1
                    st.info("ë¼ìš´ë“œë¥¼ ìŠ¤í‚µí–ˆìŠµë‹ˆë‹¤.")
                    st.rerun()
        
        # ëŒ€í™” ë‚´ìš© í‘œì‹œ
        if meeting.messages:
            st.subheader("ğŸ’­ ëŒ€í™” ë‚´ìš©")
            for message in meeting.messages:
                with st.chat_message("human" if message.is_human else "assistant"):
                    col1, col2 = st.columns([4, 1])
                    with col1:
                        st.write(f"**{message.persona_name}**")
                        st.write(message.content)
                    with col2:
                        st.caption(message.timestamp.strftime("%H:%M:%S"))
                        if message.is_human:
                            st.caption("ğŸ‘¤ ì¸ê°„")
    
    with tab3:
        st.subheader("ğŸ“Š íšŒì˜ í˜„í™©")
        
        if meeting.messages:
            # ë°œì–¸ í†µê³„
            speaker_counts = {}
            for msg in meeting.messages:
                speaker_counts[msg.persona_name] = speaker_counts.get(msg.persona_name, 0) + 1
            
            if speaker_counts:
                df = pd.DataFrame(list(speaker_counts.items()), columns=['ë°œì–¸ì', 'ë°œì–¸ìˆ˜'])
                st.bar_chart(df.set_index('ë°œì–¸ì'))
            
            # ìµœê·¼ í™œë™
            st.subheader("ğŸ• ìµœê·¼ í™œë™")
            recent_messages = meeting.messages[-5:]
            for msg in reversed(recent_messages):
                st.write(f"**{msg.timestamp.strftime('%H:%M:%S')}** - {msg.persona_name}: {msg.content[:50]}...")
        else:
            st.info("ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.")
    
    with tab4:
        st.subheader("ğŸ“ íšŒì˜ë¡")
        
        # íŒŒì¼ ì—…ë¡œë“œ
        uploaded_files = st.file_uploader(
            "ì°¸ê³  ìë£Œ ì—…ë¡œë“œ (ì„ íƒì‚¬í•­)",
            type=['txt', 'csv'],
            accept_multiple_files=True
        )
        
        if uploaded_files:
            if st.button("ğŸ“„ íŒŒì¼ ì²˜ë¦¬"):
                combined_content = ""
                for file in uploaded_files:
                    content = extract_text_from_uploaded_file(file)
                    combined_content += f"\n--- {file.name} ---\n{content}\n"
                
                meeting.file_content = combined_content
                st.success(f"{len(uploaded_files)}ê°œ íŒŒì¼ì´ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤!")
        
        if meeting.messages:
            # íšŒì˜ë¡ ìƒì„±
            meeting_log = f"""# íšŒì˜ë¡

## íšŒì˜ ì •ë³´
- **ì£¼ì œ**: {meeting.topic}
- **ì°¸ê°€ì**: {', '.join([p.name for p in meeting.personas])}
- **ì´ ë¼ìš´ë“œ**: {meeting.round_count}
- **ì´ ë©”ì‹œì§€**: {len(meeting.messages)}

## ëŒ€í™” ë‚´ìš©

"""
            for msg in meeting.messages:
                meeting_log += f"**{msg.timestamp.strftime('%H:%M:%S')} - {msg.persona_name}**\n"
                meeting_log += f"{msg.content}\n\n"
            
            # ë‹¤ìš´ë¡œë“œ
            st.download_button(
                "ğŸ“¥ íšŒì˜ë¡ ë‹¤ìš´ë¡œë“œ",
                data=meeting_log,
                file_name=f"meeting_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md",
                mime="text/markdown"
            )
            
            # ë¯¸ë¦¬ë³´ê¸°
            st.markdown("### íšŒì˜ë¡ ë¯¸ë¦¬ë³´ê¸°")
            st.markdown(meeting_log)
        else:
            st.info("ì•„ì§ íšŒì˜ë¡ì´ ì—†ìŠµë‹ˆë‹¤.")

if __name__ == "__main__":
    main() 