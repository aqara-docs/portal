import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from datetime import datetime
import os
from dotenv import load_dotenv
from openai import OpenAI
import anthropic
import json
import base64
import requests
import graphviz
import plotly.express as px
import plotly.graph_objects as go
import plotly.figure_factory as ff
import mysql.connector
import concurrent.futures
import time
import re
from urllib.parse import urlparse, urljoin
from bs4 import BeautifulSoup
import requests
from PIL import Image
import io
import hashlib

# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(
    page_title="ğŸ”µ ë¸”ë£¨ì˜¤ì…˜ ì „ëµ ERRC ë¶„ì„",
    page_icon="ğŸ”µ",
    layout="wide"
)
st.title("ğŸ”µ ë¸”ë£¨ì˜¤ì…˜ ì „ëµ ERRC ë¶„ì„ ì‹œìŠ¤í…œ")

# ì¸ì¦ ê¸°ëŠ¥
if 'authenticated' not in st.session_state:
    st.session_state.authenticated = False

admin_pw = os.getenv('ADMIN_PASSWORD')
if not admin_pw:
    st.error('í™˜ê²½ë³€ìˆ˜(ADMIN_PASSWORD)ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.')
    st.stop()

if not st.session_state.authenticated:
    password = st.text_input("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”", type="password")
    if password == admin_pw:
        st.session_state.authenticated = True
        st.rerun()
    else:
        if password:
            st.error("ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤")
        st.stop()

# API í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
openai = OpenAI(api_key=os.getenv('OPENAI_API_KEY'))
anthropic_client = anthropic.Anthropic(api_key=os.getenv('ANTHROPIC_API_KEY'))

# MySQL Database configuration
db_config = {
    'user': os.getenv('SQL_USER'),
    'password': os.getenv('SQL_PASSWORD'),
    'host': os.getenv('SQL_HOST'),
    'database': os.getenv('SQL_DATABASE_NEWBIZ'),
    'charset': 'utf8mb4',
    'collation': 'utf8mb4_general_ci'
}

# === Perplexity API ê´€ë ¨ í•¨ìˆ˜ë“¤ ===
def clean_api_key(api_key):
    """API í‚¤ ì •ë¦¬"""
    if not api_key:
        return None
    return api_key.strip().strip("'").strip('"').strip()

def verify_perplexity_api_key(api_key):
    try:
        if not api_key or not api_key.strip():
            return False
        api_key = api_key.strip()
        if not api_key.startswith('pplx-'):
            return False
        if len(api_key) < 25:
            return False
        from openai import OpenAI
        client = OpenAI(api_key=api_key, base_url="https://api.perplexity.ai")
        messages = [
            {"role": "system", "content": "You are a helpful assistant."},
            {"role": "user", "content": "Hello"}
        ]
        try:
            response = client.chat.completions.create(
                model="sonar-pro",
                messages=messages,
                max_tokens=10,
                temperature=0.1
            )
            return True
        except Exception as e:
            if "authentication" in str(e).lower() or "unauthorized" in str(e).lower():
                return False
            return True
    except Exception:
        return False

def search_with_perplexity(query, api_key, model="sonar-pro", max_results=10):
    """Perplexity APIë¥¼ ì‚¬ìš©í•œ ê²€ìƒ‰ (OpenAI í˜¸í™˜ í´ë¼ì´ì–¸íŠ¸ ì‚¬ìš©)"""
    try:
        from openai import OpenAI
        client = OpenAI(api_key=api_key, base_url="https://api.perplexity.ai")
        messages = [
            {
                'role': 'system',
                'content': 'ë‹¹ì‹ ì€ ì „ë¬¸ì ì¸ ë¹„ì¦ˆë‹ˆìŠ¤ ë¶„ì„ê°€ì…ë‹ˆë‹¤. ì£¼ì–´ì§„ íšŒì‚¬ë‚˜ ê¸°ì—…ì— ëŒ€í•´ ì •í™•í•˜ê³  ìƒì„¸í•œ ì •ë³´ë¥¼ ì œê³µí•´ì£¼ì„¸ìš”.'
            },
            {
                'role': 'user',
                'content': f"{query}ì— ëŒ€í•´ ë‹¤ìŒ ì •ë³´ë¥¼ ìƒì„¸íˆ ì¡°ì‚¬í•´ì£¼ì„¸ìš”:\n\n1. íšŒì‚¬ ê°œìš” ë° ì£¼ìš” ì‚¬ì—…\n2. í•µì‹¬ ì œí’ˆ/ì„œë¹„ìŠ¤\n3. ë¹„ì¦ˆë‹ˆìŠ¤ ëª¨ë¸\n4. ì‹œì¥ í¬ì§€ì…”ë‹\n5. ê²½ìŸ ìš°ìœ„\n6. ìµœê·¼ ë™í–¥ ë° ì „ëµ\n7. ì¬ë¬´ ì„±ê³¼ (ê°€ëŠ¥í•œ ê²½ìš°)\n8. ì¡°ì§ êµ¬ì¡° ë° ë¬¸í™”\n9. ê³ ê° ëŒ€ìƒ\n10. íŒŒíŠ¸ë„ˆì‹­ ë° í˜‘ë ¥ ê´€ê³„"
            }
        ]
        
        # ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ë“¤
        test_models = ["sonar-pro", "sonar-small-online"]
        
        # ê° ëª¨ë¸ë¡œ ì‹œë„
        for model in test_models:
            try:
                response = client.chat.completions.create(
                    model=model,
                    messages=messages,
                    max_tokens=4000,
                    temperature=0.3,
                    top_p=0.9
                )
                return {
                    'content': response.choices[0].message.content,
                    'success': True,
                    'error': None
                }
            except Exception as e:
                error_msg = str(e)
                
                if "Invalid model" in error_msg or "model not found" in error_msg.lower():
                    continue  # ë‹¤ìŒ ëª¨ë¸ ì‹œë„
                elif "authentication" in error_msg.lower() or "unauthorized" in error_msg.lower():
                    return {
                        'content': f"API í‚¤ ì¸ì¦ ì‹¤íŒ¨: {error_msg}",
                        'success': False,
                        'error': f"API í‚¤ ì¸ì¦ ì‹¤íŒ¨: {error_msg}"
                    }
                elif "rate limit" in error_msg.lower() or "quota" in error_msg.lower():
                    return {
                        'content': f"API ìš”ì²­ í•œë„ ì´ˆê³¼: {error_msg}",
                        'success': False,
                        'error': f"API ìš”ì²­ í•œë„ ì´ˆê³¼: {error_msg}"
                    }
                else:
                    continue  # ë‹¤ë¥¸ ì˜¤ë¥˜ëŠ” ë‹¤ìŒ ëª¨ë¸ ì‹œë„
        
        # ëª¨ë“  ëª¨ë¸ì—ì„œ ì‹¤íŒ¨í•œ ê²½ìš°
        return {
            'content': "ëª¨ë“  Perplexity ëª¨ë¸ì—ì„œ ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",
            'success': False,
            'error': "ëª¨ë“  Perplexity ëª¨ë¸ì—ì„œ ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
        }
        
    except Exception as e:
        return {
            'content': f"Perplexity ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜: {str(e)}",
            'success': False,
            'error': str(e)
        }

def search_competitors_with_perplexity(company_name, industry, api_key, model="sonar-pro"):
    """ê²½ìŸì‚¬ ê²€ìƒ‰ (OpenAI í˜¸í™˜ í´ë¼ì´ì–¸íŠ¸ ì‚¬ìš©)"""
    try:
        query = f"{company_name}ì™€ ê°™ì€ {industry} ì‚°ì—…ì—ì„œ ì£¼ìš” ê²½ìŸì‚¬ 2ê°œë¥¼ ì°¾ì•„ì„œ ê°ê°ì˜ ìƒì„¸ ì •ë³´ë¥¼ ì œê³µí•´ì£¼ì„¸ìš”. ê° ê²½ìŸì‚¬ì— ëŒ€í•´ ë‹¤ìŒ ì •ë³´ë¥¼ í¬í•¨í•´ì£¼ì„¸ìš”:\n\n1. íšŒì‚¬ëª… ë° ê°œìš”\n2. ì£¼ìš” ì œí’ˆ/ì„œë¹„ìŠ¤\n3. ë¹„ì¦ˆë‹ˆìŠ¤ ëª¨ë¸\n4. ì‹œì¥ í¬ì§€ì…”ë‹\n5. ê²½ìŸ ìš°ìœ„\n6. ìµœê·¼ ì „ëµ ë™í–¥"
        return search_with_perplexity(query, api_key, model)
    except Exception as e:
        return {
            'content': f"ê²½ìŸì‚¬ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜: {str(e)}",
            'success': False,
            'error': str(e)
        }

# === ERRC ë¶„ì„ ì „ë¬¸ê°€ ì—ì´ì „íŠ¸ ===
ERRC_ANALYSIS_AGENTS = {
    "errc_analyzer": {
        "name": "ğŸ”µ ERRC ë¶„ì„ ì „ë¬¸ê°€",
        "emoji": "ğŸ”µ",
        "description": "ERRC í”„ë ˆì„ì›Œí¬ë¥¼ í™œìš©í•œ ë¸”ë£¨ì˜¤ì…˜ ì „ëµ ë¶„ì„",
        "system_prompt": """ë‹¹ì‹ ì€ 15ë…„ ê²½ë ¥ì˜ ë¸”ë£¨ì˜¤ì…˜ ì „ëµ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

**ì „ë¬¸ ë¶„ì•¼:**
- ERRC í”„ë ˆì„ì›Œí¬ ë¶„ì„
- ë¸”ë£¨ì˜¤ì…˜ ì „ëµ ìˆ˜ë¦½
- ê²½ìŸì‚¬ ë¹„êµ ë¶„ì„
- ì „ëµ ìº”ë²„ìŠ¤ ì‘ì„±

**ERRC í”„ë ˆì„ì›Œí¬:**
- E (Eliminate): ì œê±° - ë¶ˆí•„ìš”í•œ ìš”ì†Œ ì œê±°
- R (Reduce): ì¶•ì†Œ - ê³¼ë„í•œ íˆ¬ìë‚˜ í™œë™ ì¶•ì†Œ
- R (Raise): ê°•í™” - í•µì‹¬ ê°€ì¹˜ ê°•í™”
- C (Create): ì°½ì¶œ - ìƒˆë¡œìš´ ê°€ì¹˜ ì°½ì¶œ

**ë¶„ì„ ê´€ì :**
- ê¸°ì¡´ ê²½ìŸì—ì„œ ë²—ì–´ë‚˜ëŠ” ë°©ë²•
- ê³ ê° ê°€ì¹˜ ì œì•ˆ ê°œì„ 
- ë¹„ìš© êµ¬ì¡° ìµœì í™”
- ìƒˆë¡œìš´ ì‹œì¥ ê¸°íšŒ ì°½ì¶œ

íšŒì‚¬ì™€ ê²½ìŸì‚¬ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ERRC ë¶„ì„ê³¼ ë¸”ë£¨ì˜¤ì…˜ ì „ëµì„ ì œì‹œí•´ì£¼ì„¸ìš”."""
    },
    
    "strategy_canvas_creator": {
        "name": "ğŸ“Š ì „ëµ ìº”ë²„ìŠ¤ ì „ë¬¸ê°€",
        "emoji": "ğŸ“Š",
        "description": "ERRC ê¸°ë°˜ ì „ëµ ìº”ë²„ìŠ¤ ì‘ì„±",
        "system_prompt": """ë‹¹ì‹ ì€ 12ë…„ ê²½ë ¥ì˜ ì „ëµ ìº”ë²„ìŠ¤ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

**ì „ë¬¸ ë¶„ì•¼:**
- ì „ëµ ìº”ë²„ìŠ¤ ì„¤ê³„
- ê²½ìŸ ìš”ì†Œ ë¶„ì„
- ê°€ì¹˜ ê³¡ì„  ì‘ì„±
- ë¸”ë£¨ì˜¤ì…˜ ì „ëµ ì‹œê°í™”

**ì „ëµ ìº”ë²„ìŠ¤ êµ¬ì„±ìš”ì†Œ:**
- ì œê±° (Eliminate): ì–´ë–¤ ìš”ì†Œë¥¼ ì œê±°í•  ê²ƒì¸ê°€?
- ì¶•ì†Œ (Reduce): ì–´ë–¤ ìš”ì†Œë¥¼ í‘œì¤€ ì´í•˜ë¡œ ì¤„ì¼ ê²ƒì¸ê°€?
- ê°•í™” (Raise): ì–´ë–¤ ìš”ì†Œë¥¼ í‘œì¤€ ì´ìƒìœ¼ë¡œ ë†’ì¼ ê²ƒì¸ê°€?
- ì°½ì¶œ (Create): ì–´ë–¤ ìƒˆë¡œìš´ ìš”ì†Œë¥¼ ì°½ì¶œí•  ê²ƒì¸ê°€?

**ë¶„ì„ ê´€ì :**
- ê²½ìŸì‚¬ì™€ì˜ ì°¨ë³„í™” ìš”ì†Œ
- ê³ ê° ê°€ì¹˜ ì œì•ˆ ê°œì„ 
- ë¹„ìš© êµ¬ì¡° ìµœì í™”
- ìƒˆë¡œìš´ ì‹œì¥ ê¸°íšŒ

ERRC ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì „ëµ ìº”ë²„ìŠ¤ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”."""
    }
}

# === AI ì‘ë‹µ ìƒì„± í•¨ìˆ˜ ===
def get_ai_response(prompt, model_name="gpt-4o-mini", system_prompt="", enable_thinking=False):
    """AI ì‘ë‹µ ìƒì„± í•¨ìˆ˜"""
    try:
        if model_name.startswith("gpt"):
            messages = []
            if system_prompt:
                messages.append({"role": "system", "content": system_prompt})
            messages.append({"role": "user", "content": prompt})
            
            response = openai.chat.completions.create(
                model=model_name,
                messages=messages,
                temperature=0.7,
                max_tokens=4000
            )
            
            return {
                'content': response.choices[0].message.content,
                'success': True,
                'error': None
            }
            
        elif model_name.startswith("claude"):
            response = anthropic_client.messages.create(
                model=model_name,
                max_tokens=4000,
                temperature=0.7,
                system=system_prompt,
                messages=[{"role": "user", "content": prompt}]
            )
            
            return {
                'content': response.content[0].text,
                'success': True,
                'error': None
            }
            
    except Exception as e:
        return {
            'content': f"AI ì‘ë‹µ ìƒì„± ì¤‘ ì˜¤ë¥˜: {str(e)}",
            'success': False,
            'error': str(e)
        }

# === ERRC ë¶„ì„ í•¨ìˆ˜ë“¤ ===
def analyze_company_with_errc(company_info, competitors_info, model_name="gpt-4o-mini"):
    """íšŒì‚¬ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ERRC ë¶„ì„"""
    
    errc_agent = ERRC_ANALYSIS_AGENTS["errc_analyzer"]
    
    prompt = f"""
{errc_agent['system_prompt']}

ë‹¤ìŒì€ ë¶„ì„ ëŒ€ìƒ íšŒì‚¬ì™€ ê²½ìŸì‚¬ ì •ë³´ì…ë‹ˆë‹¤:

**ë¶„ì„ ëŒ€ìƒ íšŒì‚¬ ì •ë³´:**
{company_info}

**ê²½ìŸì‚¬ ì •ë³´:**
{competitors_info}

**ERRC ë¶„ì„ ìš”ì²­ì‚¬í•­:**

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:

{{
    "eliminate": [
        {{
            "element": "ì œê±°í•  ìš”ì†Œëª…",
            "reason": "ì œê±° ì´ìœ ",
            "expected_effect": "ê¸°ëŒ€ íš¨ê³¼"
        }}
    ],
    "reduce": [
        {{
            "element": "ì¶•ì†Œí•  ìš”ì†Œëª…",
            "current_level": "í˜„ì¬ ìˆ˜ì¤€",
            "target_level": "ëª©í‘œ ìˆ˜ì¤€",
            "reason": "ì¶•ì†Œ ì´ìœ "
        }}
    ],
    "raise": [
        {{
            "element": "ê°•í™”í•  ìš”ì†Œëª…",
            "current_level": "í˜„ì¬ ìˆ˜ì¤€",
            "target_level": "ëª©í‘œ ìˆ˜ì¤€",
            "reason": "ê°•í™” ì´ìœ "
        }}
    ],
    "create": [
        {{
            "element": "ì°½ì¶œí•  ìš”ì†Œëª…",
            "description": "ìš”ì†Œ ì„¤ëª…",
            "expected_impact": "ê¸°ëŒ€ ì˜í–¥"
        }}
    ],
    "strategy_summary": "ì „ì²´ ë¸”ë£¨ì˜¤ì…˜ ì „ëµ ìš”ì•½"
}}

**ë¶„ì„ ê°€ì´ë“œë¼ì¸:**

1. **E (Eliminate) - ì œê±°í•  ìš”ì†Œ**
   - í˜„ì¬ ë¶ˆí•„ìš”í•˜ê±°ë‚˜ ê³ ê° ê°€ì¹˜ì— ê¸°ì—¬í•˜ì§€ ì•ŠëŠ” ìš”ì†Œë“¤
   - ê²½ìŸì‚¬ë“¤ì´ ê³µí†µì ìœ¼ë¡œ ì œê³µí•˜ì§€ë§Œ ì‹¤ì œë¡œëŠ” ë¶ˆí•„ìš”í•œ ìš”ì†Œë“¤
   - ì œê±° ì‹œ ë¹„ìš© ì ˆê°ê³¼ íš¨ìœ¨ì„± í–¥ìƒì„ ê°€ì ¸ì˜¬ ìš”ì†Œë“¤

2. **R (Reduce) - ì¶•ì†Œí•  ìš”ì†Œ**
   - í˜„ì¬ ê³¼ë„í•˜ê²Œ íˆ¬ìë˜ê³  ìˆëŠ” ìš”ì†Œë“¤
   - ê²½ìŸì‚¬ ëŒ€ë¹„ ë¶ˆí•„ìš”í•˜ê²Œ ë†’ì€ ìˆ˜ì¤€ì˜ ìš”ì†Œë“¤
   - í‘œì¤€ ì´í•˜ë¡œ ì¤„ì—¬ë„ ê³ ê° ë§Œì¡±ì— ì˜í–¥ì´ ì ì€ ìš”ì†Œë“¤

3. **R (Raise) - ê°•í™”í•  ìš”ì†Œ**
   - ê³ ê°ì´ ê°€ì¥ ì¤‘ìš”í•˜ê²Œ ìƒê°í•˜ëŠ” í•µì‹¬ ìš”ì†Œë“¤
   - ê²½ìŸì‚¬ ëŒ€ë¹„ ì°¨ë³„í™”í•  ìˆ˜ ìˆëŠ” ìš”ì†Œë“¤
   - ê°•í™” ì‹œ ê³ ê° ë§Œì¡±ë„ì™€ ì¶©ì„±ë„ í–¥ìƒì„ ê°€ì ¸ì˜¬ ìš”ì†Œë“¤

4. **C (Create) - ì°½ì¶œí•  ìš”ì†Œ**
   - ì‹œì¥ì— ì•„ì§ ì—†ëŠ” ìƒˆë¡œìš´ ê°€ì¹˜ ì œì•ˆ
   - ê²½ìŸì‚¬ë“¤ì´ ì œê³µí•˜ì§€ ì•ŠëŠ” í˜ì‹ ì  ìš”ì†Œë“¤
   - ìƒˆë¡œìš´ ê³ ê° ì„¸ê·¸ë¨¼íŠ¸ë¥¼ ì°½ì¶œí•  ìˆ˜ ìˆëŠ” ìš”ì†Œë“¤

**ì¤‘ìš”**: 
- JSON í˜•ì‹ìœ¼ë¡œ ì •í™•íˆ ì‘ë‹µí•´ì£¼ì„¸ìš”
- ê° ìš”ì†Œë³„ë¡œ êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ë‚´ìš©ì„ í¬í•¨í•´ì£¼ì„¸ìš”
- ê²½ìŸì‚¬ ë¹„êµë¥¼ í†µí•œ ì°¨ë³„í™” ìš”ì†Œë¥¼ ëª…í™•íˆ í•´ì£¼ì„¸ìš”

ERRC í”„ë ˆì„ì›Œí¬ë¥¼ í™œìš©í•˜ì—¬ ë¸”ë£¨ì˜¤ì…˜ ì „ëµì„ ì œì‹œí•´ì£¼ì„¸ìš”.
"""
    
    try:
        response = get_ai_response(
            prompt=prompt,
            model_name=model_name,
            system_prompt=errc_agent['system_prompt'],
            enable_thinking=False
        )
        
        return {
            'content': response['content'],
            'success': response['success'],
            'error': response.get('error', None)
        }
        
    except Exception as e:
        return {
            'content': f"ERRC ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}",
            'success': False,
            'error': str(e)
        }

def create_strategy_canvas(errc_analysis, company_info, competitors_info, model_name="gpt-4o-mini"):
    """ERRC ë¶„ì„ì„ ë°”íƒ•ìœ¼ë¡œ ì „ëµ ìº”ë²„ìŠ¤ ì‘ì„±"""
    
    canvas_agent = ERRC_ANALYSIS_AGENTS["strategy_canvas_creator"]
    
    prompt = f"""
{canvas_agent['system_prompt']}

ë‹¤ìŒì€ ERRC ë¶„ì„ ê²°ê³¼ì™€ íšŒì‚¬ ì •ë³´ì…ë‹ˆë‹¤:

**ERRC ë¶„ì„ ê²°ê³¼:**
{errc_analysis}

**íšŒì‚¬ ì •ë³´:**
{company_info}

**ê²½ìŸì‚¬ ì •ë³´:**
{competitors_info}

**ì „ëµ ìº”ë²„ìŠ¤ ì‘ì„± ìš”ì²­ì‚¬í•­:**

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:

{{
    "strategy_canvas": {{
        "eliminate": ["ì œê±°í•  ìš”ì†Œ1", "ì œê±°í•  ìš”ì†Œ2"],
        "reduce": ["ì¶•ì†Œí•  ìš”ì†Œ1", "ì¶•ì†Œí•  ìš”ì†Œ2"],
        "raise": ["ê°•í™”í•  ìš”ì†Œ1", "ê°•í™”í•  ìš”ì†Œ2"],
        "create": ["ì°½ì¶œí•  ìš”ì†Œ1", "ì°½ì¶œí•  ìš”ì†Œ2"]
    }},
    "value_curve": {{
        "factors": ["ìš”ì†Œ1", "ìš”ì†Œ2", "ìš”ì†Œ3", "ìš”ì†Œ4", "ìš”ì†Œ5"],
        "current_company": [3, 5, 7, 4, 2],
        "competitor1": [4, 6, 5, 5, 3],
        "competitor2": [5, 4, 6, 3, 4],
        "target_company": [1, 3, 9, 2, 8]
    }},
    "action_plan": {{
        "short_term": ["ë‹¨ê¸° ê³„íš1", "ë‹¨ê¸° ê³„íš2"],
        "medium_term": ["ì¤‘ê¸° ê³„íš1", "ì¤‘ê¸° ê³„íš2"],
        "long_term": ["ì¥ê¸° ê³„íš1", "ì¥ê¸° ê³„íš2"]
    }},
    "summary": "ì „ëµ ìº”ë²„ìŠ¤ ìš”ì•½"
}}

**ë¶„ì„ ê°€ì´ë“œë¼ì¸:**

1. **ì „ëµ ìº”ë²„ìŠ¤ êµ¬ì„±ìš”ì†Œ ë¶„ì„**
   - ì œê±°í•  ìš”ì†Œ (Eliminate): êµ¬ì²´ì ì¸ ìš”ì†Œë“¤ê³¼ ì œê±° ê·¼ê±°
   - ì¶•ì†Œí•  ìš”ì†Œ (Reduce): ì¶•ì†Œí•  ìš”ì†Œë“¤ê³¼ ì¶•ì†Œ ìˆ˜ì¤€
   - ê°•í™”í•  ìš”ì†Œ (Raise): ê°•í™”í•  ìš”ì†Œë“¤ê³¼ ê°•í™” ìˆ˜ì¤€
   - ì°½ì¶œí•  ìš”ì†Œ (Create): ìƒˆë¡œ ì°½ì¶œí•  ìš”ì†Œë“¤ê³¼ ì°½ì¶œ ë°©ë²•

2. **ê°€ì¹˜ ê³¡ì„  ì‘ì„±**
   - í˜„ì¬ íšŒì‚¬ì˜ ê°€ì¹˜ ê³¡ì„  (1-10ì  ì²™ë„)
   - ê²½ìŸì‚¬ë“¤ì˜ ê°€ì¹˜ ê³¡ì„  (1-10ì  ì²™ë„)
   - ERRC ì ìš© í›„ ìƒˆë¡œìš´ ê°€ì¹˜ ê³¡ì„  (1-10ì  ì²™ë„)
   - ê° ìš”ì†Œë³„ ìˆ˜ì¤€ ë¹„êµ

3. **ì‹¤í–‰ ë¡œë“œë§µ**
   - ë‹¨ê¸° ì‹¤í–‰ ê³„íš (3-6ê°œì›”)
   - ì¤‘ê¸° ì‹¤í–‰ ê³„íš (6-12ê°œì›”)
   - ì¥ê¸° ì‹¤í–‰ ê³„íš (1-3ë…„)

**ì¤‘ìš”**: 
- JSON í˜•ì‹ìœ¼ë¡œ ì •í™•íˆ ì‘ë‹µí•´ì£¼ì„¸ìš”
- ê°€ì¹˜ ê³¡ì„ ì˜ ìˆ˜ì¹˜ëŠ” 1-10ì  ì²™ë„ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”
- êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ì•¡ì…˜ í”Œëœì„ ì œì‹œí•´ì£¼ì„¸ìš”

ì „ëµ ìº”ë²„ìŠ¤ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.
"""
    
    try:
        response = get_ai_response(
            prompt=prompt,
            model_name=model_name,
            system_prompt=canvas_agent['system_prompt'],
            enable_thinking=False
        )
        
        return {
            'content': response['content'],
            'success': response['success'],
            'error': response.get('error', None)
        }
        
    except Exception as e:
        return {
            'content': f"ì „ëµ ìº”ë²„ìŠ¤ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}",
            'success': False,
            'error': str(e)
        }

def evaluate_custom_errc(custom_errc, company_info, competitors_info, model_name="gpt-4o-mini"):
    """ì‘ì„±ìê°€ ì§ì ‘ ì‘ì„±í•œ ERRCì— ëŒ€í•œ AI í‰ê°€ ë° ì¡°ì–¸"""
    
    prompt = f"""
ë‹¹ì‹ ì€ 20ë…„ ê²½ë ¥ì˜ ë¸”ë£¨ì˜¤ì…˜ ì „ëµ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì‘ì„±ìê°€ ì§ì ‘ ì‘ì„±í•œ ERRC ë¶„ì„ì„ í‰ê°€í•˜ê³  ê°œì„  ì¡°ì–¸ì„ ì œê³µí•´ì£¼ì„¸ìš”.

**ì‘ì„±ìê°€ ì‘ì„±í•œ ERRC:**
{custom_errc}

**íšŒì‚¬ ì •ë³´:**
{company_info}

**ê²½ìŸì‚¬ ì •ë³´:**
{competitors_info}

**í‰ê°€ ë° ì¡°ì–¸ ìš”ì²­ì‚¬í•­:**

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:

{{
    "evaluation": {{
        "overall_score": 85,
        "strengths": ["ê°•ì 1", "ê°•ì 2", "ê°•ì 3"],
        "weaknesses": ["ê°œì„ ì 1", "ê°œì„ ì 2", "ê°œì„ ì 3"],
        "missing_elements": ["ëˆ„ë½ëœ ìš”ì†Œ1", "ëˆ„ë½ëœ ìš”ì†Œ2"]
    }},
    "improvement_suggestions": {{
        "eliminate": ["ê°œì„ ëœ ì œê±° ìš”ì†Œ1", "ê°œì„ ëœ ì œê±° ìš”ì†Œ2"],
        "reduce": ["ê°œì„ ëœ ì¶•ì†Œ ìš”ì†Œ1", "ê°œì„ ëœ ì¶•ì†Œ ìš”ì†Œ2"],
        "raise": ["ê°œì„ ëœ ê°•í™” ìš”ì†Œ1", "ê°œì„ ëœ ê°•í™” ìš”ì†Œ2"],
        "create": ["ê°œì„ ëœ ì°½ì¶œ ìš”ì†Œ1", "ê°œì„ ëœ ì°½ì¶œ ìš”ì†Œ2"]
    }},
    "strategic_advice": {{
        "immediate_actions": ["ì¦‰ì‹œ ì‹¤í–‰í•  ì•¡ì…˜1", "ì¦‰ì‹œ ì‹¤í–‰í•  ì•¡ì…˜2"],
        "long_term_vision": "ì¥ê¸° ë¹„ì „ ë° ë°©í–¥ì„±",
        "risk_considerations": ["ê³ ë ¤í•´ì•¼ í•  ë¦¬ìŠ¤í¬1", "ê³ ë ¤í•´ì•¼ í•  ë¦¬ìŠ¤í¬2"],
        "success_metrics": ["ì„±ê³µ ì§€í‘œ1", "ì„±ê³µ ì§€í‘œ2"]
    }},
    "expert_commentary": "ì „ë¬¸ê°€ ì¢…í•© í‰ê°€ ë° ì¡°ì–¸"
}}

**í‰ê°€ ê¸°ì¤€:**

1. **ì „ëµì  ì¼ê´€ì„± (30ì )**
   - ERRC ìš”ì†Œë“¤ì´ ì„œë¡œ ì¼ê´€ì„± ìˆê²Œ ì—°ê²°ë˜ì–´ ìˆëŠ”ê°€?
   - ì „ëµì  ë°©í–¥ì„±ì´ ëª…í™•í•œê°€?

2. **í˜ì‹ ì„± (25ì )**
   - ê¸°ì¡´ ê²½ìŸì—ì„œ ë²—ì–´ë‚˜ëŠ” í˜ì‹ ì  ìš”ì†Œê°€ ìˆëŠ”ê°€?
   - ìƒˆë¡œìš´ ê°€ì¹˜ ì°½ì¶œ ê°€ëŠ¥ì„±ì´ ìˆëŠ”ê°€?

3. **ì‹¤í–‰ ê°€ëŠ¥ì„± (25ì )**
   - ì œì‹œëœ ì „ëµì´ ì‹¤ì œë¡œ ì‹¤í–‰ ê°€ëŠ¥í•œê°€?
   - í•„ìš”í•œ ìì›ê³¼ ì—­ëŸ‰ì„ ê³ ë ¤í–ˆëŠ”ê°€?

4. **ê²½ìŸ ìš°ìœ„ (20ì )**
   - ê²½ìŸì‚¬ ëŒ€ë¹„ ì°¨ë³„í™” ìš”ì†Œê°€ ëª…í™•í•œê°€?
   - ì§€ì† ê°€ëŠ¥í•œ ê²½ìŸ ìš°ìœ„ë¥¼ ì°½ì¶œí•  ìˆ˜ ìˆëŠ”ê°€?

**ì¤‘ìš”**: 
- JSON í˜•ì‹ìœ¼ë¡œ ì •í™•íˆ ì‘ë‹µí•´ì£¼ì„¸ìš”
- êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ì¡°ì–¸ì„ ì œì‹œí•´ì£¼ì„¸ìš”
- ì‘ì„±ìì˜ ë…¸ë ¥ì„ ì¸ì •í•˜ë©´ì„œë„ ê°œì„ ì ì„ ëª…í™•íˆ ì§€ì í•´ì£¼ì„¸ìš”

ì‘ì„±ìì˜ ERRCë¥¼ í‰ê°€í•˜ê³  ê°œì„  ì¡°ì–¸ì„ ì œê³µí•´ì£¼ì„¸ìš”.
"""
    
    try:
        response = get_ai_response(
            prompt=prompt,
            model_name=model_name,
            system_prompt="ë‹¹ì‹ ì€ 20ë…„ ê²½ë ¥ì˜ ë¸”ë£¨ì˜¤ì…˜ ì „ëµ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.",
            enable_thinking=False
        )
        
        return {
            'content': response['content'],
            'success': response['success'],
            'error': response.get('error', None)
        }
        
    except Exception as e:
        return {
            'content': f"ERRC í‰ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}",
            'success': False,
            'error': str(e)
        }

# === ERRC ì‹œê°í™” í•¨ìˆ˜ë“¤ ===
def parse_errc_json(errc_content):
    """ERRC ë¶„ì„ ê²°ê³¼ë¥¼ JSONìœ¼ë¡œ íŒŒì‹±"""
    try:
        # JSON ë¶€ë¶„ ì¶”ì¶œ
        json_start = errc_content.find('{')
        json_end = errc_content.rfind('}') + 1
        
        if json_start != -1 and json_end != 0:
            json_str = errc_content[json_start:json_end]
            return json.loads(json_str)
        else:
            return None
    except Exception as e:
        st.error(f"ERRC JSON íŒŒì‹± ì˜¤ë¥˜: {str(e)}")
        return None

def display_errc_quadrant_table(errc_data):
    """ERRC ë¶„ì„ ê²°ê³¼ë¥¼ ì‚¬ë¶„ë©´ í…Œì´ë¸”ë¡œ í‘œì‹œ"""
    if not errc_data:
        st.error("ERRC ë°ì´í„°ë¥¼ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return
    
    # ì‚¬ë¶„ë©´ í…Œì´ë¸” ìƒì„±
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("### ğŸ”´ E (Eliminate) - ì œê±°")
        if 'eliminate' in errc_data and errc_data['eliminate']:
            eliminate_df = pd.DataFrame(errc_data['eliminate'])
            st.dataframe(eliminate_df, use_container_width=True)
        else:
            st.info("ì œê±°í•  ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.")
        
        st.markdown("### ğŸ”µ R (Raise) - ê°•í™”")
        if 'raise' in errc_data and errc_data['raise']:
            raise_df = pd.DataFrame(errc_data['raise'])
            st.dataframe(raise_df, use_container_width=True)
        else:
            st.info("ê°•í™”í•  ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.")
    
    with col2:
        st.markdown("### ğŸŸ¡ R (Reduce) - ì¶•ì†Œ")
        if 'reduce' in errc_data and errc_data['reduce']:
            reduce_df = pd.DataFrame(errc_data['reduce'])
            st.dataframe(reduce_df, use_container_width=True)
        else:
            st.info("ì¶•ì†Œí•  ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.")
        
        st.markdown("### ğŸŸ¢ C (Create) - ì°½ì¶œ")
        if 'create' in errc_data and errc_data['create']:
            create_df = pd.DataFrame(errc_data['create'])
            st.dataframe(create_df, use_container_width=True)
        else:
            st.info("ì°½ì¶œí•  ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.")
    
    # ì „ëµ ìš”ì•½
    if 'strategy_summary' in errc_data:
        st.markdown("### ğŸ“‹ ì „ëµ ìš”ì•½")
        st.info(errc_data['strategy_summary'])

def create_strategy_canvas_plotly(canvas_data):
    """ì „ëµ ìº”ë²„ìŠ¤ë¥¼ plotlyë¡œ ì‹œê°í™”"""
    if not canvas_data:
        st.error("ì „ëµ ìº”ë²„ìŠ¤ ë°ì´í„°ë¥¼ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return
    
    try:
        # ê°€ì¹˜ ê³¡ì„  ì°¨íŠ¸
        if 'value_curve' in canvas_data:
            value_curve = canvas_data['value_curve']
            
            # ë°ì´í„°í”„ë ˆì„ ìƒì„±
            df = pd.DataFrame({
                'ìš”ì†Œ': value_curve['factors'],
                'í˜„ì¬ íšŒì‚¬': value_curve['current_company'],
                'ê²½ìŸì‚¬1': value_curve['competitor1'],
                'ê²½ìŸì‚¬2': value_curve['competitor2'],
                'ëª©í‘œ íšŒì‚¬': value_curve['target_company']
            })
            
            # Plotly ë¼ì¸ ì°¨íŠ¸
            fig = go.Figure()
            
            fig.add_trace(go.Scatter(
                x=df['ìš”ì†Œ'],
                y=df['í˜„ì¬ íšŒì‚¬'],
                mode='lines+markers',
                name='í˜„ì¬ íšŒì‚¬',
                line=dict(color='blue', width=3),
                marker=dict(size=8)
            ))
            
            fig.add_trace(go.Scatter(
                x=df['ìš”ì†Œ'],
                y=df['ê²½ìŸì‚¬1'],
                mode='lines+markers',
                name='ê²½ìŸì‚¬1',
                line=dict(color='red', width=2),
                marker=dict(size=6)
            ))
            
            fig.add_trace(go.Scatter(
                x=df['ìš”ì†Œ'],
                y=df['ê²½ìŸì‚¬2'],
                mode='lines+markers',
                name='ê²½ìŸì‚¬2',
                line=dict(color='orange', width=2),
                marker=dict(size=6)
            ))
            
            fig.add_trace(go.Scatter(
                x=df['ìš”ì†Œ'],
                y=df['ëª©í‘œ íšŒì‚¬'],
                mode='lines+markers',
                name='ëª©í‘œ íšŒì‚¬ (ERRC ì ìš©)',
                line=dict(color='green', width=4, dash='dash'),
                marker=dict(size=10, symbol='star')
            ))
            
            fig.update_layout(
                title='ğŸ”µ ë¸”ë£¨ì˜¤ì…˜ ì „ëµ ê°€ì¹˜ ê³¡ì„ ',
                xaxis_title='ì „ëµ ìš”ì†Œ',
                yaxis_title='ìˆ˜ì¤€ (1-10ì )',
                yaxis=dict(range=[0, 10]),
                height=500,
                showlegend=True,
                legend=dict(
                    orientation="h",
                    yanchor="bottom",
                    y=1.02,
                    xanchor="right",
                    x=1
                )
            )
            
            st.plotly_chart(fig, use_container_width=True)
        
        # ì „ëµ ìº”ë²„ìŠ¤ êµ¬ì„±ìš”ì†Œ
        if 'strategy_canvas' in canvas_data:
            st.markdown("### ğŸ“Š ì „ëµ ìº”ë²„ìŠ¤ êµ¬ì„±ìš”ì†Œ")
            
            canvas = canvas_data['strategy_canvas']
            
            col1, col2 = st.columns(2)
            
            with col1:
                st.markdown("#### ğŸ”´ ì œê±° (Eliminate)")
                if 'eliminate' in canvas and canvas['eliminate']:
                    for i, item in enumerate(canvas['eliminate'], 1):
                        st.write(f"{i}. {item}")
                else:
                    st.info("ì œê±°í•  ìš”ì†Œ ì—†ìŒ")
                
                st.markdown("#### ğŸŸ¡ ì¶•ì†Œ (Reduce)")
                if 'reduce' in canvas and canvas['reduce']:
                    for i, item in enumerate(canvas['reduce'], 1):
                        st.write(f"{i}. {item}")
                else:
                    st.info("ì¶•ì†Œí•  ìš”ì†Œ ì—†ìŒ")
            
            with col2:
                st.markdown("#### ğŸ”µ ê°•í™” (Raise)")
                if 'raise' in canvas and canvas['raise']:
                    for i, item in enumerate(canvas['raise'], 1):
                        st.write(f"{i}. {item}")
                else:
                    st.info("ê°•í™”í•  ìš”ì†Œ ì—†ìŒ")
                
                st.markdown("#### ğŸŸ¢ ì°½ì¶œ (Create)")
                if 'create' in canvas and canvas['create']:
                    for i, item in enumerate(canvas['create'], 1):
                        st.write(f"{i}. {item}")
                else:
                    st.info("ì°½ì¶œí•  ìš”ì†Œ ì—†ìŒ")
        
        # ì•¡ì…˜ í”Œëœ
        if 'action_plan' in canvas_data:
            st.markdown("### ğŸ“… ì‹¤í–‰ ë¡œë“œë§µ")
            
            action_plan = canvas_data['action_plan']
            
            col1, col2, col3 = st.columns(3)
            
            with col1:
                st.markdown("#### ğŸš€ ë‹¨ê¸° ê³„íš (3-6ê°œì›”)")
                if 'short_term' in action_plan and action_plan['short_term']:
                    for i, plan in enumerate(action_plan['short_term'], 1):
                        st.write(f"{i}. {plan}")
                else:
                    st.info("ë‹¨ê¸° ê³„íš ì—†ìŒ")
            
            with col2:
                st.markdown("#### ğŸ“ˆ ì¤‘ê¸° ê³„íš (6-12ê°œì›”)")
                if 'medium_term' in action_plan and action_plan['medium_term']:
                    for i, plan in enumerate(action_plan['medium_term'], 1):
                        st.write(f"{i}. {plan}")
                else:
                    st.info("ì¤‘ê¸° ê³„íš ì—†ìŒ")
            
            with col3:
                st.markdown("#### ğŸ¯ ì¥ê¸° ê³„íš (1-3ë…„)")
                if 'long_term' in action_plan and action_plan['long_term']:
                    for i, plan in enumerate(action_plan['long_term'], 1):
                        st.write(f"{i}. {plan}")
                else:
                    st.info("ì¥ê¸° ê³„íš ì—†ìŒ")
        
        # ìš”ì•½
        if 'summary' in canvas_data:
            st.markdown("### ğŸ“‹ ì „ëµ ìº”ë²„ìŠ¤ ìš”ì•½")
            st.info(canvas_data['summary'])
            
    except Exception as e:
        st.error(f"ì „ëµ ìº”ë²„ìŠ¤ ì‹œê°í™” ì˜¤ë¥˜: {str(e)}")

def parse_canvas_json(canvas_content):
    """ì „ëµ ìº”ë²„ìŠ¤ ê²°ê³¼ë¥¼ JSONìœ¼ë¡œ íŒŒì‹±"""
    try:
        # JSON ë¶€ë¶„ ì¶”ì¶œ
        json_start = canvas_content.find('{')
        json_end = canvas_content.rfind('}') + 1
        
        if json_start != -1 and json_end != 0:
            json_str = canvas_content[json_start:json_end]
            return json.loads(json_str)
        else:
            return None
    except Exception as e:
        st.error(f"ì „ëµ ìº”ë²„ìŠ¤ JSON íŒŒì‹± ì˜¤ë¥˜: {str(e)}")
        return None

def parse_evaluation_json(evaluation_content):
    """ERRC í‰ê°€ ê²°ê³¼ë¥¼ JSONìœ¼ë¡œ íŒŒì‹±"""
    try:
        # JSON ë¶€ë¶„ ì¶”ì¶œ
        json_start = evaluation_content.find('{')
        json_end = evaluation_content.rfind('}') + 1
        
        if json_start != -1 and json_end != 0:
            json_str = evaluation_content[json_start:json_end]
            return json.loads(json_str)
        else:
            return None
    except Exception as e:
        st.error(f"í‰ê°€ JSON íŒŒì‹± ì˜¤ë¥˜: {str(e)}")
        return None

def display_evaluation_results(evaluation_data):
    """ERRC í‰ê°€ ê²°ê³¼ë¥¼ ì‹œê°í™”"""
    if not evaluation_data:
        st.error("í‰ê°€ ë°ì´í„°ë¥¼ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return
    
    try:
        # ì „ì²´ ì ìˆ˜
        if 'evaluation' in evaluation_data:
            eval_info = evaluation_data['evaluation']
            
            col1, col2, col3, col4 = st.columns(4)
            
            with col1:
                st.metric("ì „ì²´ ì ìˆ˜", f"{eval_info.get('overall_score', 0)}/100")
            
            with col2:
                st.metric("ì „ëµì  ì¼ê´€ì„±", "30ì  ë§Œì ")
            
            with col3:
                st.metric("í˜ì‹ ì„±", "25ì  ë§Œì ")
            
            with col4:
                st.metric("ì‹¤í–‰ ê°€ëŠ¥ì„±", "25ì  ë§Œì ")
        
        # í‰ê°€ ì„¸ë¶€ì‚¬í•­
        col1, col2 = st.columns(2)
        
        with col1:
            st.markdown("### âœ… ê°•ì ")
            if 'strengths' in eval_info and eval_info['strengths']:
                for i, strength in enumerate(eval_info['strengths'], 1):
                    st.write(f"{i}. {strength}")
            else:
                st.info("ê°•ì ì´ ì—†ìŠµë‹ˆë‹¤.")
            
            st.markdown("### âŒ ê°œì„ ì ")
            if 'weaknesses' in eval_info and eval_info['weaknesses']:
                for i, weakness in enumerate(eval_info['weaknesses'], 1):
                    st.write(f"{i}. {weakness}")
            else:
                st.info("ê°œì„ ì ì´ ì—†ìŠµë‹ˆë‹¤.")
        
        with col2:
            st.markdown("### âš ï¸ ëˆ„ë½ëœ ìš”ì†Œ")
            if 'missing_elements' in eval_info and eval_info['missing_elements']:
                for i, element in enumerate(eval_info['missing_elements'], 1):
                    st.write(f"{i}. {element}")
            else:
                st.info("ëˆ„ë½ëœ ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.")
        
        # ê°œì„  ì œì•ˆ
        if 'improvement_suggestions' in evaluation_data:
            st.markdown("### ğŸ”§ ê°œì„  ì œì•ˆ")
            improvement = evaluation_data['improvement_suggestions']
            
            col1, col2 = st.columns(2)
            
            with col1:
                st.markdown("#### ğŸ”´ ê°œì„ ëœ ì œê±° ìš”ì†Œ")
                if 'eliminate' in improvement and improvement['eliminate']:
                    for i, item in enumerate(improvement['eliminate'], 1):
                        st.write(f"{i}. {item}")
                else:
                    st.info("ê°œì„ ëœ ì œê±° ìš”ì†Œ ì—†ìŒ")
                
                st.markdown("#### ğŸ”µ ê°œì„ ëœ ê°•í™” ìš”ì†Œ")
                if 'raise' in improvement and improvement['raise']:
                    for i, item in enumerate(improvement['raise'], 1):
                        st.write(f"{i}. {item}")
                else:
                    st.info("ê°œì„ ëœ ê°•í™” ìš”ì†Œ ì—†ìŒ")
            
            with col2:
                st.markdown("#### ğŸŸ¡ ê°œì„ ëœ ì¶•ì†Œ ìš”ì†Œ")
                if 'reduce' in improvement and improvement['reduce']:
                    for i, item in enumerate(improvement['reduce'], 1):
                        st.write(f"{i}. {item}")
                else:
                    st.info("ê°œì„ ëœ ì¶•ì†Œ ìš”ì†Œ ì—†ìŒ")
                
                st.markdown("#### ğŸŸ¢ ê°œì„ ëœ ì°½ì¶œ ìš”ì†Œ")
                if 'create' in improvement and improvement['create']:
                    for i, item in enumerate(improvement['create'], 1):
                        st.write(f"{i}. {item}")
                else:
                    st.info("ê°œì„ ëœ ì°½ì¶œ ìš”ì†Œ ì—†ìŒ")
        
        # ì „ëµì  ì¡°ì–¸
        if 'strategic_advice' in evaluation_data:
            st.markdown("### ğŸ’¡ ì „ëµì  ì¡°ì–¸")
            advice = evaluation_data['strategic_advice']
            
            col1, col2 = st.columns(2)
            
            with col1:
                st.markdown("#### ğŸš€ ì¦‰ì‹œ ì‹¤í–‰ ì•¡ì…˜")
                if 'immediate_actions' in advice and advice['immediate_actions']:
                    for i, action in enumerate(advice['immediate_actions'], 1):
                        st.write(f"{i}. {action}")
                else:
                    st.info("ì¦‰ì‹œ ì‹¤í–‰ ì•¡ì…˜ ì—†ìŒ")
                
                st.markdown("#### ğŸ¯ ì¥ê¸° ë¹„ì „")
                if 'long_term_vision' in advice:
                    st.info(advice['long_term_vision'])
                else:
                    st.info("ì¥ê¸° ë¹„ì „ ì—†ìŒ")
            
            with col2:
                st.markdown("#### âš ï¸ ë¦¬ìŠ¤í¬ ê³ ë ¤ì‚¬í•­")
                if 'risk_considerations' in advice and advice['risk_considerations']:
                    for i, risk in enumerate(advice['risk_considerations'], 1):
                        st.write(f"{i}. {risk}")
                else:
                    st.info("ë¦¬ìŠ¤í¬ ê³ ë ¤ì‚¬í•­ ì—†ìŒ")
                
                st.markdown("#### ğŸ“Š ì„±ê³µ ì§€í‘œ")
                if 'success_metrics' in advice and advice['success_metrics']:
                    for i, metric in enumerate(advice['success_metrics'], 1):
                        st.write(f"{i}. {metric}")
                else:
                    st.info("ì„±ê³µ ì§€í‘œ ì—†ìŒ")
        
        # ì „ë¬¸ê°€ ì¢…í•© í‰ê°€
        if 'expert_commentary' in evaluation_data:
            st.markdown("### ğŸ‘¨â€ğŸ’¼ ì „ë¬¸ê°€ ì¢…í•© í‰ê°€")
            st.info(evaluation_data['expert_commentary'])
            
    except Exception as e:
        st.error(f"í‰ê°€ ê²°ê³¼ ì‹œê°í™” ì˜¤ë¥˜: {str(e)}")

# === ë°ì´í„°ë² ì´ìŠ¤ ê´€ë ¨ í•¨ìˆ˜ë“¤ ===
def create_errc_analysis_tables():
    """ERRC ë¶„ì„ì„ ìœ„í•œ ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸” ìƒì„±"""
    try:
        conn = mysql.connector.connect(**db_config)
        cursor = conn.cursor()

        # 1. ERRC ë¶„ì„ ê¸°ë³¸ ì •ë³´ í…Œì´ë¸”
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS errc_analyses (
                analysis_id INT AUTO_INCREMENT PRIMARY KEY,
                company_name VARCHAR(500) NOT NULL,
                industry VARCHAR(200),
                analysis_date DATETIME DEFAULT CURRENT_TIMESTAMP,
                company_info LONGTEXT,
                competitors_info LONGTEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')

        # 2. ERRC ë¶„ì„ ê²°ê³¼ í…Œì´ë¸”
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS errc_analysis_results (
                result_id INT AUTO_INCREMENT PRIMARY KEY,
                analysis_id INT,
                errc_analysis_content LONGTEXT,
                strategy_canvas_content LONGTEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (analysis_id) REFERENCES errc_analyses(analysis_id) ON DELETE CASCADE
            )
        ''')

        conn.commit()
        cursor.close()
        conn.close()
        return True

    except mysql.connector.Error as err:
        st.error(f"í…Œì´ë¸” ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {err}")
        return False

def save_errc_analysis(company_name, industry, company_info, competitors_info, errc_analysis, strategy_canvas):
    """ERRC ë¶„ì„ ê²°ê³¼ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥"""
    try:
        conn = mysql.connector.connect(**db_config)
        cursor = conn.cursor()

        # 1. ê¸°ë³¸ ì •ë³´ ì €ì¥
        cursor.execute('''
            INSERT INTO errc_analyses 
            (company_name, industry, company_info, competitors_info)
            VALUES (%s, %s, %s, %s)
        ''', (company_name, industry, company_info, competitors_info))
        
        analysis_id = cursor.lastrowid

        # 2. ë¶„ì„ ê²°ê³¼ ì €ì¥
        cursor.execute('''
            INSERT INTO errc_analysis_results
            (analysis_id, errc_analysis_content, strategy_canvas_content)
            VALUES (%s, %s, %s)
        ''', (analysis_id, errc_analysis, strategy_canvas))

        conn.commit()
        cursor.close()
        conn.close()
        return True, analysis_id

    except mysql.connector.Error as err:
        st.error(f"ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {err}")
        return False, None

def get_saved_errc_analyses():
    """ì €ì¥ëœ ERRC ë¶„ì„ ëª©ë¡ ì¡°íšŒ"""
    try:
        conn = mysql.connector.connect(**db_config)
        cursor = conn.cursor(dictionary=True)
        
        cursor.execute('''
            SELECT 
                ea.analysis_id,
                ea.company_name,
                ea.industry,
                ea.analysis_date,
                ear.errc_analysis_content,
                ear.strategy_canvas_content
            FROM errc_analyses ea
            LEFT JOIN errc_analysis_results ear ON ea.analysis_id = ear.analysis_id
            ORDER BY ea.analysis_date DESC
        ''')
        
        results = cursor.fetchall()
        return results
    except mysql.connector.Error as err:
        st.error(f"ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {err}")
        return []
    finally:
        if 'conn' in locals():
            cursor.close()
            conn.close()

def delete_errc_analysis(analysis_id):
    """ERRC ë¶„ì„ ì‚­ì œ"""
    try:
        conn = mysql.connector.connect(**db_config)
        cursor = conn.cursor()
        
        cursor.execute('DELETE FROM errc_analyses WHERE analysis_id = %s', (analysis_id,))
        deleted_rows = cursor.rowcount
        
        conn.commit()
        cursor.close()
        conn.close()
        
        if deleted_rows > 0:
            st.success(f"âœ… ë¶„ì„ ID {analysis_id} ì‚­ì œ ì™„ë£Œ")
            return True
        else:
            st.error("ì‚­ì œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
            return False
        
    except mysql.connector.Error as err:
        st.error(f"ë°ì´í„°ë² ì´ìŠ¤ ì˜¤ë¥˜: {err}")
        return False

# === ë©”ì¸ í•¨ìˆ˜ ===
def main():
    # ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸” ìƒì„±
    create_errc_analysis_tables()
    
    # íƒ­ ìƒì„±
    tab1, tab2, tab3 = st.tabs(["ğŸ” íšŒì‚¬ ì¡°ì‚¬ ê¸°ë°˜ ERRC", "âœï¸ ì§ì ‘ ERRC ì‘ì„±", "ğŸ“Š ì €ì¥ëœ ë¶„ì„ ì¡°íšŒ"])
    
    with tab1:
        st.header("ğŸ” íšŒì‚¬ ì¡°ì‚¬ ê¸°ë°˜ ERRC ë¶„ì„")
        st.info("íšŒì‚¬ ì •ë³´ë¥¼ ì…ë ¥í•˜ë©´ Perplexity APIë¥¼ í†µí•´ íšŒì‚¬ì™€ ê²½ìŸì‚¬ë¥¼ ì¡°ì‚¬í•˜ì—¬ ERRC ë¶„ì„ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.")
        
        # Perplexity API ì„¤ì •
        st.subheader("ğŸ”‘ Perplexity API ì„¤ì •")
        
        # í™˜ê²½ë³€ìˆ˜ì—ì„œ Perplexity API í‚¤ ê°€ì ¸ì˜¤ê¸°
        perplexity_api_key = os.getenv('PERPLEXITY_API_KEY')
        
        if perplexity_api_key:
            perplexity_api_key = clean_api_key(perplexity_api_key)
            if verify_perplexity_api_key(perplexity_api_key):
                st.success("âœ… Perplexity API í‚¤ê°€ ìœ íš¨í•©ë‹ˆë‹¤.")
                # íšŒì‚¬ ì •ë³´ ì…ë ¥
                st.subheader("ğŸ¢ ë¶„ì„ ëŒ€ìƒ íšŒì‚¬ ì •ë³´")
                company_name = st.text_input("íšŒì‚¬ëª…", placeholder="ì˜ˆ: ì•„ì¹´ë¼ë¼ì´í”„")
                industry = st.text_input("ì‚°ì—…êµ°", placeholder="ì˜ˆ: IoT, ì¸í…Œë¦¬ì–´, ìŠ¤ë§ˆíŠ¸í™ˆ")
                
                # ê²½ìŸì‚¬ ì…ë ¥ (ìµœëŒ€ 3ê°œ)
                st.subheader("ğŸ­ ê²½ìŸì‚¬ ì •ë³´")
                st.info("ê²½ìŸì‚¬ë¥¼ ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜, ì…ë ¥í•˜ì§€ ì•Šìœ¼ë©´ LLMì´ ìë™ìœ¼ë¡œ ì°¾ìŠµë‹ˆë‹¤.")
                
                competitor1 = st.text_input("ê²½ìŸì‚¬ 1", placeholder="ê²½ìŸì‚¬ëª… (ì„ íƒì‚¬í•­)")
                competitor2 = st.text_input("ê²½ìŸì‚¬ 2", placeholder="ê²½ìŸì‚¬ëª… (ì„ íƒì‚¬í•­)")
                competitor3 = st.text_input("ê²½ìŸì‚¬ 3", placeholder="ê²½ìŸì‚¬ëª… (ì„ íƒì‚¬í•­)")
                
                # ì…ë ¥ëœ ê²½ìŸì‚¬ ëª©ë¡
                competitors_input = [c for c in [competitor1, competitor2, competitor3] if c.strip()]
                
                if company_name and industry:
                    # ì´ë¯¸ ì¡°ì‚¬ëœ ê²°ê³¼ê°€ ìˆëŠ”ì§€ í™•ì¸
                    if ('company_result' in st.session_state and 
                        'competitors_result' in st.session_state and
                        st.session_state.get('company_name') == company_name and
                        st.session_state.get('industry') == industry):
                        
                        st.success("âœ… ì´ì „ ì¡°ì‚¬ ê²°ê³¼ê°€ ìˆìŠµë‹ˆë‹¤. ì•„ë˜ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.")
                        
                        # ì €ì¥ëœ ê²°ê³¼ ì‚¬ìš©
                        company_result = st.session_state['company_result']
                        competitors_result = st.session_state['competitors_result']
                        
                        # ì¡°ì‚¬ ê²°ê³¼ í‘œì‹œ
                        st.subheader("ğŸ“‹ ì¡°ì‚¬ ê²°ê³¼")
                        
                        col1, col2 = st.columns(2)
                        with col1:
                            with st.expander("ğŸ¢ íšŒì‚¬ ì •ë³´", expanded=True):
                                st.markdown(company_result['content'])
                        
                        with col2:
                            with st.expander("ğŸ­ ê²½ìŸì‚¬ ì •ë³´", expanded=True):
                                st.markdown(competitors_result['content'])
                        
                        # ERRC ë¶„ì„ ì‹¤í–‰
                        st.subheader("ğŸ”µ ERRC ë¶„ì„")
                        model_name = st.selectbox(
                            "ì‚¬ìš©í•  AI ëª¨ë¸",
                            ["gpt-4o-mini", "gpt-4", "claude-3-5-sonnet-20241022"],
                            index=0,
                            key="errc_model_saved_tab1"
                        )
                        
                        if st.button("ğŸ”µ ERRC ë¶„ì„ ì‹¤í–‰", type="primary", key="errc_analysis_button_saved"):
                            with st.spinner("ERRC ë¶„ì„ì„ ìˆ˜í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤..."):
                                # ERRC ë¶„ì„
                                errc_result = analyze_company_with_errc(
                                    company_result['content'],
                                    competitors_result['content'],
                                    model_name
                                )
                                
                                if errc_result['success']:
                                    st.success("âœ… ERRC ë¶„ì„ ì™„ë£Œ")
                                    
                                    # ì „ëµ ìº”ë²„ìŠ¤ ì‘ì„±
                                    with st.spinner("ì „ëµ ìº”ë²„ìŠ¤ë¥¼ ì‘ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤..."):
                                        canvas_result = create_strategy_canvas(
                                            errc_result['content'],
                                            company_result['content'],
                                            competitors_result['content'],
                                            model_name
                                        )
                                        
                                        if canvas_result['success']:
                                            st.success("âœ… ì „ëµ ìº”ë²„ìŠ¤ ì‘ì„± ì™„ë£Œ")
                                            
                                            # ERRC ë¶„ì„ ê²°ê³¼ ì‹œê°í™”
                                            st.markdown("## ğŸ”µ ERRC ë¶„ì„ ê²°ê³¼")
                                            
                                            # ERRC JSON íŒŒì‹± ë° ì‚¬ë¶„ë©´ í…Œì´ë¸” í‘œì‹œ
                                            errc_data = parse_errc_json(errc_result['content'])
                                            if errc_data:
                                                display_errc_quadrant_table(errc_data)
                                            else:
                                                st.markdown(errc_result['content'])
                                            
                                            # ì „ëµ ìº”ë²„ìŠ¤ ì‹œê°í™”
                                            st.markdown("## ğŸ“Š ì „ëµ ìº”ë²„ìŠ¤")
                                            
                                            # ì „ëµ ìº”ë²„ìŠ¤ JSON íŒŒì‹± ë° plotly ì‹œê°í™”
                                            canvas_data = parse_canvas_json(canvas_result['content'])
                                            if canvas_data:
                                                create_strategy_canvas_plotly(canvas_data)
                                            else:
                                                st.markdown(canvas_result['content'])
                                            
                                            # ê²°ê³¼ ì €ì¥
                                            analysis_date = datetime.now()
                                            save_success, analysis_id = save_errc_analysis(
                                                company_name,
                                                industry,
                                                company_result['content'],
                                                competitors_result['content'],
                                                errc_result['content'],
                                                canvas_result['content']
                                            )
                                            
                                            if save_success:
                                                st.success(f"âœ… ë¶„ì„ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (ID: {analysis_id})")
                                            else:
                                                st.warning("âš ï¸ ë¶„ì„ ê²°ê³¼ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
                                        else:
                                            st.error(f"âŒ ì „ëµ ìº”ë²„ìŠ¤ ì‘ì„± ì‹¤íŒ¨: {canvas_result['error']}")
                                else:
                                    st.error(f"âŒ ERRC ë¶„ì„ ì‹¤íŒ¨: {errc_result['error']}")
                        
                        # ìƒˆë¡œìš´ ì¡°ì‚¬ ë²„íŠ¼
                        if st.button("ğŸ”„ ìƒˆë¡œìš´ ì¡°ì‚¬ ì‹œì‘", key="new_search_button"):
                            # ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
                            if 'company_result' in st.session_state:
                                del st.session_state['company_result']
                            if 'competitors_result' in st.session_state:
                                del st.session_state['competitors_result']
                            if 'company_name' in st.session_state:
                                del st.session_state['company_name']
                            if 'industry' in st.session_state:
                                del st.session_state['industry']
                            st.rerun()
                    
                    else:
                        # ìƒˆë¡œìš´ ì¡°ì‚¬ ì‹œì‘
                        if st.button("ğŸ” íšŒì‚¬ ë° ê²½ìŸì‚¬ ì¡°ì‚¬ ì‹œì‘", type="primary", key="start_search_button"):
                            with st.spinner("íšŒì‚¬ ì •ë³´ë¥¼ ì¡°ì‚¬í•˜ê³  ìˆìŠµë‹ˆë‹¤..."):
                                # íšŒì‚¬ ì •ë³´ ì¡°ì‚¬
                                company_query = f"{company_name} íšŒì‚¬ì— ëŒ€í•œ ìƒì„¸ ì •ë³´"
                                company_result = search_with_perplexity(company_query, perplexity_api_key)
                                
                                if company_result['success']:
                                    st.success("âœ… íšŒì‚¬ ì •ë³´ ì¡°ì‚¬ ì™„ë£Œ")
                                    
                                    # ì¡°ì‚¬ ê²°ê³¼ë¥¼ ì„¸ì…˜ì— ì €ì¥
                                    st.session_state['company_result'] = company_result
                                    st.session_state['company_name'] = company_name
                                    st.session_state['industry'] = industry
                                    
                                    # ê²½ìŸì‚¬ ì¡°ì‚¬
                                    with st.spinner("ê²½ìŸì‚¬ ì •ë³´ë¥¼ ì¡°ì‚¬í•˜ê³  ìˆìŠµë‹ˆë‹¤..."):
                                        if competitors_input:
                                            # ì§ì ‘ ì…ë ¥ëœ ê²½ìŸì‚¬ ì •ë³´ ì¡°ì‚¬
                                            competitors_info = []
                                            for competitor in competitors_input:
                                                comp_result = search_with_perplexity(
                                                    f"{competitor} íšŒì‚¬ ì •ë³´", 
                                                    perplexity_api_key
                                                )
                                                if comp_result['success']:
                                                    competitors_info.append(f"**{competitor}:**\n{comp_result['content']}")
                                                else:
                                                    competitors_info.append(f"**{competitor}:** ì¡°ì‚¬ ì‹¤íŒ¨")
                                            
                                            competitors_result = {
                                                'content': '\n\n'.join(competitors_info),
                                                'success': True,
                                                'error': None
                                            }
                                        else:
                                            # LLMì´ ìë™ìœ¼ë¡œ ê²½ìŸì‚¬ ì°¾ê¸°
                                            competitors_result = search_competitors_with_perplexity(
                                                company_name, industry, perplexity_api_key
                                            )
                                        
                                        if competitors_result['success']:
                                            st.success("âœ… ê²½ìŸì‚¬ ì •ë³´ ì¡°ì‚¬ ì™„ë£Œ")
                                            
                                            # ê²½ìŸì‚¬ ê²°ê³¼ë¥¼ ì„¸ì…˜ì— ì €ì¥
                                            st.session_state['competitors_result'] = competitors_result
                                            
                                            # ì¡°ì‚¬ ê²°ê³¼ í‘œì‹œ
                                            st.subheader("ğŸ“‹ ì¡°ì‚¬ ê²°ê³¼")
                                            
                                            col1, col2 = st.columns(2)
                                            with col1:
                                                with st.expander("ğŸ¢ íšŒì‚¬ ì •ë³´", expanded=True):
                                                    st.markdown(company_result['content'])
                                            
                                            with col2:
                                                with st.expander("ğŸ­ ê²½ìŸì‚¬ ì •ë³´", expanded=True):
                                                    st.markdown(competitors_result['content'])
                                            
                                            # ERRC ë¶„ì„ ì‹¤í–‰
                                            st.subheader("ğŸ”µ ERRC ë¶„ì„")
                                            model_name = st.selectbox(
                                                "ì‚¬ìš©í•  AI ëª¨ë¸",
                                                ["gpt-4o-mini", "gpt-4", "claude-3-5-sonnet-20241022"],
                                                index=0,
                                                key="errc_model_tab1"
                                            )
                                            
                                            if st.button("ğŸ”µ ERRC ë¶„ì„ ì‹¤í–‰", type="primary", key="errc_analysis_button"):
                                                with st.spinner("ERRC ë¶„ì„ì„ ìˆ˜í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤..."):
                                                    # ERRC ë¶„ì„
                                                    errc_result = analyze_company_with_errc(
                                                        company_result['content'],
                                                        competitors_result['content'],
                                                        model_name
                                                    )
                                                    
                                                    if errc_result['success']:
                                                        st.success("âœ… ERRC ë¶„ì„ ì™„ë£Œ")
                                                        
                                                        # ì „ëµ ìº”ë²„ìŠ¤ ì‘ì„±
                                                        with st.spinner("ì „ëµ ìº”ë²„ìŠ¤ë¥¼ ì‘ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤..."):
                                                            canvas_result = create_strategy_canvas(
                                                                errc_result['content'],
                                                                company_result['content'],
                                                                competitors_result['content'],
                                                                model_name
                                                            )
                                                            
                                                            if canvas_result['success']:
                                                                st.success("âœ… ì „ëµ ìº”ë²„ìŠ¤ ì‘ì„± ì™„ë£Œ")
                                                                
                                                                # ê²°ê³¼ í‘œì‹œ
                                                                st.markdown("## ğŸ”µ ERRC ë¶„ì„ ê²°ê³¼")
                                                                st.markdown(errc_result['content'])
                                                                
                                                                st.markdown("## ğŸ“Š ì „ëµ ìº”ë²„ìŠ¤")
                                                                st.markdown(canvas_result['content'])
                                                                
                                                                # ê²°ê³¼ ì €ì¥
                                                                analysis_date = datetime.now()
                                                                save_success, analysis_id = save_errc_analysis(
                                                                    company_name,
                                                                    industry,
                                                                    company_result['content'],
                                                                    competitors_result['content'],
                                                                    errc_result['content'],
                                                                    canvas_result['content']
                                                                )
                                                                
                                                                if save_success:
                                                                    st.success(f"âœ… ë¶„ì„ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (ID: {analysis_id})")
                                                                else:
                                                                    st.warning("âš ï¸ ë¶„ì„ ê²°ê³¼ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
                                                            else:
                                                                st.error(f"âŒ ì „ëµ ìº”ë²„ìŠ¤ ì‘ì„± ì‹¤íŒ¨: {canvas_result['error']}")
                                                    else:
                                                        st.error(f"âŒ ERRC ë¶„ì„ ì‹¤íŒ¨: {errc_result['error']}")
                                        else:
                                            st.error(f"âŒ ê²½ìŸì‚¬ ì •ë³´ ì¡°ì‚¬ ì‹¤íŒ¨: {competitors_result['error']}")
                                else:
                                    st.error(f"âŒ íšŒì‚¬ ì •ë³´ ì¡°ì‚¬ ì‹¤íŒ¨: {company_result['error']}")
                else:
                    st.warning("âš ï¸ íšŒì‚¬ëª…ê³¼ ì‚°ì—…êµ°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
            else:
                st.error("âŒ Perplexity API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
                st.info("ì˜¬ë°”ë¥¸ Perplexity API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        else:
            st.error("âŒ Perplexity API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.")
    
    with tab2:
        st.header("âœï¸ ì§ì ‘ ERRC ì‘ì„±")
        st.info("ì§ì ‘ ERRCë¥¼ ì‘ì„±í•˜ê³ , í•´ë‹¹ íšŒì‚¬ì˜ ê²½ìŸì‚¬ë¥¼ ì¡°ì‚¬í•˜ì—¬ ì „ëµ ìº”ë²„ìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.")
        
        # Perplexity API ì„¤ì •
        st.subheader("ğŸ”‘ Perplexity API ì„¤ì •")
        
        # í™˜ê²½ë³€ìˆ˜ì—ì„œ Perplexity API í‚¤ ê°€ì ¸ì˜¤ê¸° (tab2ìš©)
        perplexity_api_key_tab2 = os.getenv('PERPLEXITY_API_KEY')
        
        if perplexity_api_key_tab2:
            perplexity_api_key_tab2 = clean_api_key(perplexity_api_key_tab2)
            if verify_perplexity_api_key(perplexity_api_key_tab2):
                st.success("âœ… Perplexity API í‚¤ê°€ ìœ íš¨í•©ë‹ˆë‹¤.")
                
                # íšŒì‚¬ ì •ë³´ ì…ë ¥
                st.subheader("ğŸ¢ íšŒì‚¬ ì •ë³´")
                company_name_tab2 = st.text_input("íšŒì‚¬ëª…", key="company_name_tab2", placeholder="ì˜ˆ: ì•„ì¹´ë¼ë¼ì´í”„")
                industry_tab2 = st.text_input("ì‚°ì—…êµ°", key="industry_tab2", placeholder="ì˜ˆ: IoT, ì¸í…Œë¦¬ì–´, ìŠ¤ë§ˆíŠ¸í™ˆ")
                
                # ê²½ìŸì‚¬ ì…ë ¥ (ìµœëŒ€ 3ê°œ)
                st.subheader("ğŸ­ ê²½ìŸì‚¬ ì •ë³´")
                st.info("ê²½ìŸì‚¬ë¥¼ ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜, ì…ë ¥í•˜ì§€ ì•Šìœ¼ë©´ LLMì´ ìë™ìœ¼ë¡œ ì°¾ìŠµë‹ˆë‹¤.")
                
                competitor1_tab2 = st.text_input("ê²½ìŸì‚¬ 1", key="competitor1_tab2", placeholder="ê²½ìŸì‚¬ëª… (ì„ íƒì‚¬í•­)")
                competitor2_tab2 = st.text_input("ê²½ìŸì‚¬ 2", key="competitor2_tab2", placeholder="ê²½ìŸì‚¬ëª… (ì„ íƒì‚¬í•­)")
                competitor3_tab2 = st.text_input("ê²½ìŸì‚¬ 3", key="competitor3_tab2", placeholder="ê²½ìŸì‚¬ëª… (ì„ íƒì‚¬í•­)")
                
                # ì…ë ¥ëœ ê²½ìŸì‚¬ ëª©ë¡
                competitors_input_tab2 = [c for c in [competitor1_tab2, competitor2_tab2, competitor3_tab2] if c.strip()]
                
                # ERRC ì§ì ‘ ì‘ì„±
                st.subheader("ğŸ”µ ERRC ì§ì ‘ ì‘ì„±")
                st.info("ë‹¤ìŒ í•­ëª©ë“¤ì„ ì§ì ‘ ì‘ì„±í•´ì£¼ì„¸ìš”:")
                
                eliminate_items = st.text_area(
                    "E (Eliminate) - ì œê±°í•  ìš”ì†Œë“¤",
                    placeholder="ë¶ˆí•„ìš”í•œ ìš”ì†Œë“¤ì„ í•œ ì¤„ì”© ì…ë ¥í•˜ì„¸ìš”\nì˜ˆ: ë³µì¡í•œ ì£¼ë¬¸ ì ˆì°¨\nì˜ˆ: ë¶ˆí•„ìš”í•œ ë©”ë‰´ í•­ëª©",
                    height=100
                )
                
                reduce_items = st.text_area(
                    "R (Reduce) - ì¶•ì†Œí•  ìš”ì†Œë“¤",
                    placeholder="ê³¼ë„í•œ íˆ¬ìë‚˜ í™œë™ì„ í•œ ì¤„ì”© ì…ë ¥í•˜ì„¸ìš”\nì˜ˆ: ê¸´ ë©”ë‰´íŒ\nì˜ˆ: ê³¼ë„í•œ ì œí’ˆ ì„¤ëª…",
                    height=100
                )
                
                raise_items = st.text_area(
                    "R (Raise) - ê°•í™”í•  ìš”ì†Œë“¤",
                    placeholder="í•µì‹¬ ê°€ì¹˜ë¥¼ í•œ ì¤„ì”© ì…ë ¥í•˜ì„¸ìš”\nì˜ˆ: ì‹œê·¸ë‹ˆì²˜ ë©”ë‰´ í’ˆì§ˆ\nì˜ˆ: ê³ ê° ì„œë¹„ìŠ¤",
                    height=100
                )
                
                create_items = st.text_area(
                    "C (Create) - ì°½ì¶œí•  ìš”ì†Œë“¤",
                    placeholder="ìƒˆë¡œìš´ ê°€ì¹˜ë¥¼ í•œ ì¤„ì”© ì…ë ¥í•˜ì„¸ìš”\nì˜ˆ: ë…íŠ¹í•œ ì‹œì¦Œ ë©”ë‰´\nì˜ˆ: ì…€í”„ êµìœ¡ ì˜ìƒ",
                    height=100
                )
                
                # ì¶”ê°€ ë¶„ì„
                additional_analysis = st.text_area(
                    "ì¶”ê°€ ë¶„ì„ ë° ì „ëµ",
                    placeholder="ERRC ë¶„ì„ì„ ë°”íƒ•ìœ¼ë¡œ í•œ ì¶”ê°€ì ì¸ ì „ëµì´ë‚˜ ì¸ì‚¬ì´íŠ¸ë¥¼ ì‘ì„±í•˜ì„¸ìš”",
                    height=150
                )
                
                # ìë™ ìƒì„± ì˜µì…˜
                st.markdown("### âš™ï¸ ìƒì„± ì˜µì…˜")
                use_custom_errc = st.checkbox(
                    "ì‚¬ìš©ìê°€ ì‘ì„±í•œ ERRC ì‚¬ìš© (ì²´í¬ í•´ì œ ì‹œ AIê°€ ìë™ìœ¼ë¡œ ERRC ìƒì„±)",
                    value=True,
                    key="use_custom_errc_tab2"
                )
                
                # AI ëª¨ë¸ ì„ íƒ
                model_name_tab2 = st.selectbox(
                    "ì‚¬ìš©í•  AI ëª¨ë¸",
                    ["gpt-4o-mini", "gpt-4", "claude-3-5-sonnet-20241022"],
                    index=0,
                    key="model_tab2_unique"
                )
                
                if company_name_tab2 and industry_tab2:
                    if st.button("ğŸ” ê²½ìŸì‚¬ ì¡°ì‚¬ ë° AI ì¡°ì–¸", type="primary", key="full_analysis_tab2"):
                        with st.spinner("íšŒì‚¬ ì •ë³´ë¥¼ ì¡°ì‚¬í•˜ê³  ìˆìŠµë‹ˆë‹¤..."):
                            # 1. íšŒì‚¬ ì •ë³´ ì¡°ì‚¬
                            company_query = f"{company_name_tab2} íšŒì‚¬ì— ëŒ€í•œ ìƒì„¸ ì •ë³´"
                            company_result = search_with_perplexity(company_query, perplexity_api_key_tab2)
                            
                            if company_result['success']:
                                st.success("âœ… íšŒì‚¬ ì •ë³´ ì¡°ì‚¬ ì™„ë£Œ")
                                
                                # 2. ê²½ìŸì‚¬ ì •ë³´ ì¡°ì‚¬
                                with st.spinner("ê²½ìŸì‚¬ ì •ë³´ë¥¼ ì¡°ì‚¬í•˜ê³  ìˆìŠµë‹ˆë‹¤..."):
                                    if competitors_input_tab2:
                                        # ì§ì ‘ ì…ë ¥ëœ ê²½ìŸì‚¬ ì •ë³´ ì¡°ì‚¬
                                        competitors_info_tab2 = []
                                        for competitor in competitors_input_tab2:
                                            comp_result = search_with_perplexity(
                                                f"{competitor} íšŒì‚¬ ì •ë³´", 
                                                perplexity_api_key_tab2
                                            )
                                            if comp_result['success']:
                                                competitors_info_tab2.append(f"**{competitor}:**\n{comp_result['content']}")
                                            else:
                                                competitors_info_tab2.append(f"**{competitor}:** ì¡°ì‚¬ ì‹¤íŒ¨")
                                        
                                        competitors_result = {
                                            'content': '\n\n'.join(competitors_info_tab2),
                                            'success': True,
                                            'error': None
                                        }
                                    else:
                                        # LLMì´ ìë™ìœ¼ë¡œ ê²½ìŸì‚¬ ì°¾ê¸°
                                        competitors_result = search_competitors_with_perplexity(
                                            company_name_tab2, industry_tab2, perplexity_api_key_tab2
                                        )
                                    
                                    if competitors_result['success']:
                                        st.success("âœ… ê²½ìŸì‚¬ ì •ë³´ ì¡°ì‚¬ ì™„ë£Œ")
                                        
                                        # ì¡°ì‚¬ ê²°ê³¼ í‘œì‹œ
                                        st.markdown("### ğŸ“‹ ì¡°ì‚¬ ê²°ê³¼")
                                        col1, col2 = st.columns(2)
                                        with col1:
                                            with st.expander("ğŸ¢ íšŒì‚¬ ì •ë³´", expanded=True):
                                                st.markdown(company_result['content'])
                                        with col2:
                                            with st.expander("ğŸ­ ê²½ìŸì‚¬ ì •ë³´", expanded=True):
                                                st.markdown(competitors_result['content'])
                                        
                                        # 3. ERRC ìƒì„± ë˜ëŠ” ì‚¬ìš©ì ì…ë ¥ ì‚¬ìš©
                                        if use_custom_errc and (eliminate_items or reduce_items or raise_items or create_items):
                                            # ì‚¬ìš©ìê°€ ì‘ì„±í•œ ERRC ì‚¬ìš©
                                            custom_errc = f"""
**ì§ì ‘ ì‘ì„±ëœ ERRC ë¶„ì„:**

**E (Eliminate) - ì œê±°í•  ìš”ì†Œ:**
{eliminate_items if eliminate_items else "ì œê±°í•  ìš”ì†Œ ì—†ìŒ"}

**R (Reduce) - ì¶•ì†Œí•  ìš”ì†Œ:**
{reduce_items if reduce_items else "ì¶•ì†Œí•  ìš”ì†Œ ì—†ìŒ"}

**R (Raise) - ê°•í™”í•  ìš”ì†Œ:**
{raise_items if raise_items else "ê°•í™”í•  ìš”ì†Œ ì—†ìŒ"}

**C (Create) - ì°½ì¶œí•  ìš”ì†Œ:**
{create_items if create_items else "ì°½ì¶œí•  ìš”ì†Œ ì—†ìŒ"}

**ì¶”ê°€ ë¶„ì„ ë° ì „ëµ:**
{additional_analysis if additional_analysis else "ì¶”ê°€ ë¶„ì„ ì—†ìŒ"}
"""
                                        else:
                                            # AIê°€ ìë™ìœ¼ë¡œ ERRC ìƒì„±
                                            with st.spinner("AIê°€ ERRCë¥¼ ìë™ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤..."):
                                                errc_result = analyze_company_with_errc(
                                                    company_result['content'],
                                                    competitors_result['content'],
                                                    model_name_tab2
                                                )
                                                
                                                if errc_result['success']:
                                                    st.success("âœ… AI ERRC ìƒì„± ì™„ë£Œ")
                                                    custom_errc = errc_result['content']
                                                else:
                                                    st.error(f"âŒ AI ERRC ìƒì„± ì‹¤íŒ¨: {errc_result['error']}")
                                                    custom_errc = "ERRC ìƒì„± ì‹¤íŒ¨"
                                        
                                        # 4. AI í‰ê°€ ë° ì¡°ì–¸
                                        with st.spinner("AIê°€ ERRCë¥¼ í‰ê°€í•˜ê³  ì¡°ì–¸ì„ ì œê³µí•˜ê³  ìˆìŠµë‹ˆë‹¤..."):
                                            evaluation_result = evaluate_custom_errc(
                                                custom_errc,
                                                company_result['content'],
                                                competitors_result['content'],
                                                model_name_tab2
                                            )
                                            
                                            if evaluation_result['success']:
                                                st.success("âœ… AI í‰ê°€ ë° ì¡°ì–¸ ì™„ë£Œ")
                                                
                                                # í‰ê°€ ê²°ê³¼ ì‹œê°í™”
                                                st.markdown("## ğŸ¤– AI í‰ê°€ ë° ì¡°ì–¸")
                                                evaluation_data = parse_evaluation_json(evaluation_result['content'])
                                                if evaluation_data:
                                                    display_evaluation_results(evaluation_data)
                                                else:
                                                    st.markdown(evaluation_result['content'])
                                                
                                                # 5. ì „ëµ ìº”ë²„ìŠ¤ ìƒì„±
                                                with st.spinner("ì „ëµ ìº”ë²„ìŠ¤ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤..."):
                                                    canvas_result = create_strategy_canvas(
                                                        evaluation_result['content'],  # AI í‰ê°€ ê²°ê³¼ë¥¼ ê¸°ë°˜ìœ¼ë¡œ
                                                        company_result['content'],
                                                        competitors_result['content'],
                                                        model_name_tab2
                                                    )
                                                    
                                                    if canvas_result['success']:
                                                        st.success("âœ… ì „ëµ ìº”ë²„ìŠ¤ ìƒì„± ì™„ë£Œ")
                                                        st.markdown("## ğŸ“Š ì „ëµ ìº”ë²„ìŠ¤")
                                                        
                                                        # ì „ëµ ìº”ë²„ìŠ¤ ì‹œê°í™”
                                                        canvas_data = parse_canvas_json(canvas_result['content'])
                                                        if canvas_data:
                                                            create_strategy_canvas_plotly(canvas_data)
                                                        else:
                                                            st.markdown(canvas_result['content'])
                                                    else:
                                                        st.error(f"âŒ ì „ëµ ìº”ë²„ìŠ¤ ìƒì„± ì‹¤íŒ¨: {canvas_result['error']}")
                                                
                                                # 6. ê²°ê³¼ ì €ì¥
                                                analysis_date = datetime.now()
                                                save_success, analysis_id = save_errc_analysis(
                                                    company_name_tab2,
                                                    industry_tab2,
                                                    company_result['content'],
                                                    competitors_result['content'],
                                                    evaluation_result['content'],  # AI í‰ê°€ ê²°ê³¼ ì €ì¥
                                                    canvas_result['content'] if canvas_result['success'] else "ì „ëµ ìº”ë²„ìŠ¤ ìƒì„± ì‹¤íŒ¨"
                                                )
                                                if save_success:
                                                    st.success(f"âœ… ë¶„ì„ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (ID: {analysis_id})")
                                                else:
                                                    st.warning("âš ï¸ ë¶„ì„ ê²°ê³¼ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
                                            else:
                                                st.error(f"âŒ AI í‰ê°€ ì‹¤íŒ¨: {evaluation_result['error']}")
                                        
                                        # ERRC í‘œì‹œ
                                        st.markdown("## ğŸ”µ ERRC ë¶„ì„")
                                        if use_custom_errc:
                                            st.markdown("### ì‚¬ìš©ìê°€ ì‘ì„±í•œ ERRC")
                                        else:
                                            st.markdown("### AIê°€ ìƒì„±í•œ ERRC")
                                        st.markdown(custom_errc)
                                        
                                        # ìƒˆë¡œìš´ ë¶„ì„ ì‹œì‘ ë²„íŠ¼
                                        if st.button("ğŸ”„ ìƒˆë¡œìš´ ë¶„ì„ ì‹œì‘", key="new_analysis_tab2"):
                                            st.rerun()
                                    else:
                                        st.error(f"âŒ ê²½ìŸì‚¬ ì •ë³´ ì¡°ì‚¬ ì‹¤íŒ¨: {competitors_result['error']}")
                            else:
                                st.error(f"âŒ íšŒì‚¬ ì •ë³´ ì¡°ì‚¬ ì‹¤íŒ¨: {company_result['error']}")
                else:
                    st.warning("âš ï¸ íšŒì‚¬ëª…ê³¼ ì‚°ì—…êµ°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
            else:
                st.error("âŒ Perplexity API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
        else:
            st.error("âŒ Perplexity API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.")
    
    with tab3:
        st.header("ğŸ“Š ì €ì¥ëœ ERRC ë¶„ì„ ì¡°íšŒ")
        
        # ì €ì¥ëœ ë¶„ì„ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        saved_analyses = get_saved_errc_analyses()
        
        if saved_analyses:
            for analysis in saved_analyses:
                # ìƒì„¸ë³´ê¸° ìƒíƒœë¥¼ ì„¸ì…˜ì— ì €ì¥
                if f"show_errc_detail_{analysis['analysis_id']}" not in st.session_state:
                    st.session_state[f"show_errc_detail_{analysis['analysis_id']}"] = False
                
                # ìƒì„¸ë³´ê¸°ê°€ í™œì„±í™”ëœ ê²½ìš° ì „ì²´ í™”ë©´ìœ¼ë¡œ í‘œì‹œ
                if st.session_state[f"show_errc_detail_{analysis['analysis_id']}"]:
                    # ì „ì²´ í™”ë©´ ìƒì„¸ë³´ê¸°
                    st.markdown("---")
                    st.markdown("## ğŸ“Š **ì „ì²´ í™”ë©´ ERRC ë¶„ì„**")
                    
                    # ë¶„ì„ ì •ë³´ ìš”ì•½
                    col_info1, col_info2, col_info3 = st.columns(3)
                    with col_info1:
                        st.metric("ë¶„ì„ ID", analysis['analysis_id'])
                        st.metric("íšŒì‚¬ëª…", analysis['company_name'])
                    with col_info2:
                        st.metric("ì‚°ì—…êµ°", analysis['industry'])
                        st.metric("ë¶„ì„ ë‚ ì§œ", analysis['analysis_date'].strftime('%Y-%m-%d %H:%M'))
                    with col_info3:
                        st.metric("ERRC ë¶„ì„", "âœ… ì™„ë£Œ" if analysis['errc_analysis_content'] else "âŒ ì—†ìŒ")
                        st.metric("ì „ëµ ìº”ë²„ìŠ¤", "âœ… ì™„ë£Œ" if analysis['strategy_canvas_content'] else "âŒ ì—†ìŒ")
                    
                    # íƒ­ìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ í‘œì‹œ
                    tab_errc, tab_canvas = st.tabs(["ğŸ”µ ERRC ë¶„ì„", "ğŸ“Š ì „ëµ ìº”ë²„ìŠ¤"])
                    
                    with tab_errc:
                        st.markdown("### ğŸ”µ **ERRC ë¶„ì„ ê²°ê³¼**")
                        if analysis['errc_analysis_content']:
                            # ERRC JSON íŒŒì‹± ë° ì‚¬ë¶„ë©´ í…Œì´ë¸” í‘œì‹œ
                            errc_data = parse_errc_json(analysis['errc_analysis_content'])
                            if errc_data:
                                display_errc_quadrant_table(errc_data)
                            else:
                                st.markdown(analysis['errc_analysis_content'])
                        else:
                            st.info("ERRC ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.")
                    
                    with tab_canvas:
                        st.markdown("### ğŸ“Š **ì „ëµ ìº”ë²„ìŠ¤**")
                        if analysis['strategy_canvas_content']:
                            # ì „ëµ ìº”ë²„ìŠ¤ JSON íŒŒì‹± ë° plotly ì‹œê°í™”
                            canvas_data = parse_canvas_json(analysis['strategy_canvas_content'])
                            if canvas_data:
                                create_strategy_canvas_plotly(canvas_data)
                            else:
                                st.markdown(analysis['strategy_canvas_content'])
                        else:
                            st.info("ì „ëµ ìº”ë²„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.")
                    
                    # ë‹«ê¸° ë²„íŠ¼
                    if st.button("âŒ ìƒì„¸ë³´ê¸° ë‹«ê¸°", key=f"close_errc_detail_{analysis['analysis_id']}"):
                        st.session_state[f"show_errc_detail_{analysis['analysis_id']}"] = False
                        st.rerun()
                
                else:
                    # ì¼ë°˜ ëª©ë¡ í‘œì‹œ
                    with st.expander(f"ğŸ“„ {analysis['company_name']} - {analysis['analysis_date']}", expanded=False):
                        col1, col2 = st.columns([3, 1])
                        
                        with col1:
                            st.write(f"**íšŒì‚¬ëª…:** {analysis['company_name']}")
                            st.write(f"**ì‚°ì—…êµ°:** {analysis['industry']}")
                            st.write(f"**ë¶„ì„ ë‚ ì§œ:** {analysis['analysis_date'].strftime('%Y-%m-%d %H:%M')}")
                            st.write(f"**ERRC ë¶„ì„:** {'âœ… ì™„ë£Œ' if analysis['errc_analysis_content'] else 'âŒ ì—†ìŒ'}")
                            st.write(f"**ì „ëµ ìº”ë²„ìŠ¤:** {'âœ… ì™„ë£Œ' if analysis['strategy_canvas_content'] else 'âŒ ì—†ìŒ'}")
                            
                        with col2:
                            detail_btn = st.button("ğŸ“‹ ìƒì„¸ë³´ê¸°", key=f"errc_detail_{analysis['analysis_id']}")
                            
                            if detail_btn:
                                st.session_state[f"show_errc_detail_{analysis['analysis_id']}"] = True
                                st.rerun()
                        
                        # ì‚­ì œ ê¸°ëŠ¥
                        st.markdown("### âš ï¸ ë¶„ì„ ê´€ë¦¬")
                        delete_button_key = f"delete_errc_button_{analysis['analysis_id']}"
                        
                        # ì‚­ì œ í™•ì¸ì„ ìœ„í•œ ì²´í¬ë°•ìŠ¤
                        confirm_delete = st.checkbox(f"ì‚­ì œ í™•ì¸", key=f"confirm_errc_{analysis['analysis_id']}")
                        
                        if confirm_delete:
                            if st.button("ğŸ—‘ï¸ ë¶„ì„ ì‚­ì œ", key=delete_button_key, type="primary", use_container_width=True):
                                if delete_errc_analysis(analysis['analysis_id']):
                                    st.success("âœ… ë¶„ì„ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.")
                                    st.rerun()
                                else:
                                    st.error("âŒ ë¶„ì„ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
                        else:
                            st.button("ğŸ—‘ï¸ ë¶„ì„ ì‚­ì œ", key=delete_button_key, disabled=True, use_container_width=True)
                            st.caption("ì‚­ì œí•˜ë ¤ë©´ ë¨¼ì € 'ì‚­ì œ í™•ì¸' ì²´í¬ë°•ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”.")
        else:
            st.info("ì €ì¥ëœ ERRC ë¶„ì„ì´ ì—†ìŠµë‹ˆë‹¤.")

if __name__ == "__main__":
    main() 