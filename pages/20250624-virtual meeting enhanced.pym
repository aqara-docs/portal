import streamlit as st
from openai import OpenAI
import anthropic
import time
import threading
from datetime import datetime, timedelta
import json
import os
from typing import List, Dict, Any
import uuid
from dotenv import load_dotenv
import pandas as pd
from io import StringIO
import PyPDF2
import docx
import tempfile
from dataclasses import dataclass
import asyncio
import queue
import random
import mysql.connector

load_dotenv()

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(
    page_title="Virtual Meeting Enhanced - AI ê°€ìƒ íšŒì˜",
    page_icon="ğŸ‘¥ğŸ’»",
    layout="wide"
)
st.title("ğŸ‘¥ğŸ’» Virtual Meeting Enhanced - AI ê°€ìƒ íšŒì˜")

# ì¸ì¦ ê¸°ëŠ¥ (ê°„ë‹¨í•œ ë¹„ë°€ë²ˆí˜¸ ë³´í˜¸)
if 'authenticated' not in st.session_state:
    st.session_state.authenticated = False
admin_pw = os.getenv('ADMIN_PASSWORD')
if not admin_pw:
    st.error('í™˜ê²½ë³€ìˆ˜(ADMIN_PASSWORD)ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. .env íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.')
    st.stop()
if not st.session_state.authenticated:
    password = st.text_input("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”", type="password")
    if password == admin_pw:
        st.session_state.authenticated = True
        st.rerun()
    else:
        if password:
            st.error("ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤")
        st.stop()
        
@dataclass
class Persona:
    id: str
    name: str
    role: str
    prompt: str
    personality: str
    expertise: str
    speaking_style: str
    is_moderator: bool = False
    
    def __post_init__(self):
        if not self.prompt:
            self.prompt = self.generate_default_prompt()
    
    def generate_default_prompt(self) -> str:
        return f"""ë‹¹ì‹ ì€ {self.name}ì…ë‹ˆë‹¤. 
        ì—­í• : {self.role}
        ì „ë¬¸ ë¶„ì•¼: {self.expertise}
        ì„±ê²©: {self.personality}
        ë§í•˜ëŠ” ìŠ¤íƒ€ì¼: {self.speaking_style}
        
        íšŒì˜ì—ì„œ ë‹¹ì‹ ì˜ ì „ë¬¸ì„±ì„ ë°”íƒ•ìœ¼ë¡œ ê±´ì„¤ì ì¸ ì˜ê²¬ì„ ì œì‹œí•˜ì„¸ìš”.
        ë‹¤ë¥¸ ì°¸ê°€ìë“¤ì˜ ì˜ê²¬ì„ ê²½ì²­í•˜ê³  ì¡´ì¤‘í•˜ë©°, í† ë¡ ì„ ë°œì „ì‹œí‚¤ëŠ” ë°©í–¥ìœ¼ë¡œ ì°¸ì—¬í•˜ì„¸ìš”."""

@dataclass
class Message:
    timestamp: datetime
    persona_id: str
    persona_name: str
    content: str
    is_human_input: bool = False
    is_moderator: bool = False

class VirtualMeeting:
    def __init__(self):
        self.personas: List[Persona] = []
        self.messages: List[Message] = []
        self.meeting_topic = ""
        self.meeting_duration = 30  # ë¶„
        self.start_time = None
        self.is_active = False
        self.uploaded_files_content = ""
        self.current_speaker_index = 0
        self.conversation_round = 0
        self.max_rounds = 10
        self.auto_mode = False
        self.speaking_speed = 3  # ì´ˆ
        self.last_message_time = None
        self.round_summaries: Dict[int, str] = {}  # ë¼ìš´ë“œë³„ ìš”ì•½ ì €ì¥
        self.key_insights: List[str] = []  # ì£¼ìš” ì¸ì‚¬ì´íŠ¸ ì €ì¥
        self.file_analysis: Dict[str, Any] = {}  # ì—…ë¡œë“œëœ íŒŒì¼ ë¶„ì„ ê²°ê³¼
        self.file_keywords: List[str] = []  # íŒŒì¼ì—ì„œ ì¶”ì¶œëœ í‚¤ì›Œë“œ
        self.typing_speed: float = 0.1  # íƒ€ì´í•‘ íš¨ê³¼ ì†ë„ (ì´ˆ)
        self.last_moderator_intervention: datetime = None  # ë§ˆì§€ë§‰ ì‚¬íšŒì ê°œì… ì‹œê°„
        
        # ğŸ¯ ì°½ì˜ì  ëŒ€í™” ì²´ì¸ ì‹œìŠ¤í…œ
        self.conversation_chain = []  # ëŒ€í™”ì˜ ë…¼ë¦¬ì  íë¦„ ì¶”ì 
        self.discussion_focus = ""  # í˜„ì¬ ë…¼ì˜ ì´ˆì 
        self.pending_questions = []  # í•´ê²°ë˜ì§€ ì•Šì€ ì§ˆë¬¸ë“¤
        self.agreements = []  # í•©ì˜ëœ ì‚¬í•­ë“¤
        self.disagreements = []  # ì´ê²¬ì´ ìˆëŠ” ì‚¬í•­ë“¤
        self.manual_round_control = True  # ì™„ì „ ìˆ˜ë™ ë¼ìš´ë“œ ì œì–´
        self.turn_counter = 0  # ë°œì–¸ ìˆœì„œ ì¹´ìš´í„° (ë¼ìš´ë“œì™€ ë¶„ë¦¬)
        
        # ğŸ”§ ìƒˆë¡œìš´ íšŒì˜ ì œì–´ ì†ì„±ë“¤
        self.original_max_rounds = 10  # ì‚¬ìš©ìê°€ ì„¤ì •í•œ ì›ë³¸ ìµœëŒ€ ë¼ìš´ë“œ
        self.extension_granted = False  # 1ë¼ìš´ë“œ ì—°ì¥ í—ˆê°€ ì—¬ë¶€
        self.consecutive_repetitions = 0  # ì—°ì† ë°˜ë³µ íšŸìˆ˜
        self.last_meaningful_content = []  # ì˜ë¯¸ìˆëŠ” ìµœê·¼ ë°œì–¸ë“¤
        
    def add_persona(self, persona: Persona) -> bool:
        if len(self.personas) < 10:
            self.personas.append(persona)
            return True
        return False
    
    def remove_persona(self, persona_id: str):
        self.personas = [p for p in self.personas if p.id != persona_id]
    
    def get_moderator(self) -> Persona:
        for persona in self.personas:
            if persona.is_moderator:
                return persona
        return None
    
    def get_non_moderator_personas(self) -> List[Persona]:
        return [p for p in self.personas if not p.is_moderator]
    
    def add_message(self, persona_id: str, content: str, is_human_input: bool = False) -> Message:
        persona = next((p for p in self.personas if p.id == persona_id), None)
        if persona:
            message = Message(
                timestamp=datetime.now(),
                persona_id=persona_id,
                persona_name=persona.name,
                content=content,
                is_human_input=is_human_input,
                is_moderator=persona.is_moderator
            )
            self.messages.append(message)
            self.last_message_time = datetime.now()
            return message
        return None
    
    def get_next_speaker(self) -> Persona:
        non_moderator_personas = self.get_non_moderator_personas()
        if not non_moderator_personas:
            return None
        
        current_persona = non_moderator_personas[self.current_speaker_index % len(non_moderator_personas)]
        return current_persona
    
    def advance_speaker(self):
        """ğŸ¯ ë°œì–¸ì ìˆœì„œ ì§„í–‰ ë° ë¼ìš´ë“œ ìë™ ê´€ë¦¬ (ì„¤ì •ê°’ì€ ê³ ì •)"""
        non_moderator_personas = self.get_non_moderator_personas()
        if non_moderator_personas:
            self.current_speaker_index += 1
            self.turn_counter += 1
            
            # âœ… ëª¨ë“  ì°¸ê°€ìê°€ ë°œì–¸ì„ ì™„ë£Œí•˜ë©´ ë¼ìš´ë“œ ìë™ ì¦ê°€ (ì›ë˜ëŒ€ë¡œ ë³µì›)
            if self.current_speaker_index % len(non_moderator_personas) == 0:
                self.conversation_round += 1
                # ìƒˆ ë¼ìš´ë“œ ì‹œì‘ ì‹œ ëŒ€í™” ì²´ì¸ ìƒíƒœ ì´ˆê¸°í™”
                self.discussion_focus = ""
                self.pending_questions = []
                self.consecutive_repetitions = 0
    
    def advance_round(self):
        """ğŸ¯ ë¼ìš´ë“œ ìˆ˜ë™ ì¦ê°€ - ì‚¬ìš©ìë§Œ í˜¸ì¶œ ê°€ëŠ¥"""
        self.conversation_round += 1
        # ìƒˆ ë¼ìš´ë“œ ì‹œì‘ ì‹œ ëŒ€í™” ì²´ì¸ ìƒíƒœ ì´ˆê¸°í™”
        self.discussion_focus = ""
        self.pending_questions = []
        self.consecutive_repetitions = 0
    
    def is_time_to_speak(self) -> bool:
        if not self.last_message_time:
            return True
        # total_seconds()ë¥¼ ì‚¬ìš©í•˜ì—¬ ì •í™•í•œ ì‹œê°„ ê³„ì‚°
        time_diff = (datetime.now() - self.last_message_time).total_seconds()
        return time_diff >= self.speaking_speed
    
    def should_continue(self) -> bool:
        if not self.is_active:
            return False
        
        # ğŸ¯ ì‚¬ìš©ì ì„¤ì • ìµœëŒ€ ë¼ìš´ë“œ ë„ë‹¬ ì‹œ ì²˜ë¦¬
        if self.conversation_round >= self.original_max_rounds:
            if not self.extension_granted and not self._is_conclusion_reached():
                # ë§ˆë¬´ë¦¬ê°€ ì•ˆ ë˜ì—ˆìœ¼ë©´ 1ë¼ìš´ë“œ ì—°ì¥ í—ˆê°€
                self.extension_granted = True
                self.max_rounds = self.original_max_rounds + 1
                # ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ (í•œ ë²ˆë§Œ)
                st.info(f"ğŸ”” ì„¤ì •ëœ {self.original_max_rounds}ë¼ìš´ë“œê°€ ì™„ë£Œë˜ì—ˆìœ¼ë‚˜ íšŒì˜ê°€ ë§ˆë¬´ë¦¬ë˜ì§€ ì•Šì•„ 1ë¼ìš´ë“œ ì—°ì¥í•©ë‹ˆë‹¤.")
            elif self.conversation_round >= self.max_rounds:
                # ì—°ì¥ëœ ë¼ìš´ë“œë„ ì´ˆê³¼í•˜ë©´ ê°•ì œ ì¢…ë£Œ
                self.is_active = False
                st.warning(f"â° {self.max_rounds}ë¼ìš´ë“œ ì™„ë£Œë¡œ íšŒì˜ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.")
                return False
                
        # ğŸ¯ ë°˜ë³µ ëŒ€í™” ê°ì§€ë¡œ ì¡°ê¸° ì¢…ë£Œ
        if self._detect_repetitive_conversation():
            self.is_active = False
            st.warning("ğŸ”„ ë°˜ë³µì ì¸ ëŒ€í™”ê°€ ê°ì§€ë˜ì–´ íšŒì˜ë¥¼ ì¡°ê¸° ì¢…ë£Œí•©ë‹ˆë‹¤.")
            return False
            
        # ì‹œê°„ ì œí•œ ì²´í¬
        if self.start_time:
            elapsed_time = (datetime.now() - self.start_time).total_seconds()
            if elapsed_time > (self.meeting_duration * 60):
                self.is_active = False
                return False
        
        return True
    
    def _detect_repetitive_conversation(self) -> bool:
        """ğŸ”„ ë°˜ë³µì ì¸ ëŒ€í™” ê°ì§€ - ê°•í™”ëœ ì•Œê³ ë¦¬ì¦˜"""
        if len(self.messages) < 8:  # ìµœì†Œ ë©”ì‹œì§€ ìˆ˜
            return False
        
        recent_messages = [msg for msg in self.messages[-8:] 
                          if not msg.is_moderator and not msg.is_human_input]
        
        if len(recent_messages) < 4:
            return False
        
        # 1. í‚¤ì›Œë“œ ë°˜ë³µ ê°ì§€
        repetitive_keywords = ['ê²°ë¡ ', 'ë§ˆë¬´ë¦¬', 'ì •ë¦¬', 'ê°ì‚¬', 'í•¨ê»˜', 'ìµœìƒì˜ ê²°ê³¼', 'ì§„í–‰í•˜ê¸°ë¡œ']
        keyword_counts = {}
        
        for msg in recent_messages[-6:]:  # ìµœê·¼ 6ê°œ ë©”ì‹œì§€
            content_lower = msg.content.lower()
            for keyword in repetitive_keywords:
                if keyword in content_lower:
                    keyword_counts[keyword] = keyword_counts.get(keyword, 0) + 1
        
        # ê°™ì€ í‚¤ì›Œë“œê°€ 4ë²ˆ ì´ìƒ ë°˜ë³µë˜ë©´ ë°˜ë³µìœ¼ë¡œ íŒë‹¨
        if any(count >= 4 for count in keyword_counts.values()):
            self.consecutive_repetitions += 1
            return True
        
        # 2. ë¬¸ì¥ ìœ ì‚¬ë„ ê²€ì‚¬ (ë” ì—„ê²©í•˜ê²Œ)
        def calculate_similarity(text1: str, text2: str) -> float:
            words1 = set(text1.lower().split())
            words2 = set(text2.lower().split())
            if len(words1) == 0 or len(words2) == 0:
                return 0.0
            intersection = len(words1.intersection(words2))
            union = len(words1.union(words2))
            return intersection / union if union > 0 else 0.0
        
        # ìµœê·¼ 4ê°œ ë©”ì‹œì§€ ê°„ ìœ ì‚¬ë„ ê²€ì‚¬
        similarities = []
        for i in range(len(recent_messages) - 1):
            for j in range(i + 1, len(recent_messages)):
                sim = calculate_similarity(recent_messages[i].content, recent_messages[j].content)
                similarities.append(sim)
        
        # í‰ê·  ìœ ì‚¬ë„ê°€ 60% ì´ìƒì´ë©´ ë°˜ë³µ
        if similarities and sum(similarities) / len(similarities) > 0.6:
            self.consecutive_repetitions += 1
            return True
        
        # 3. ì§§ì€ ë©”ì‹œì§€ ë°˜ë³µ (50ì ì´í•˜)
        short_messages = [msg.content for msg in recent_messages[-4:] if len(msg.content) <= 50]
        if len(short_messages) >= 3:  # ìµœê·¼ 4ê°œ ì¤‘ 3ê°œê°€ ì§§ì€ ë©”ì‹œì§€
            self.consecutive_repetitions += 1
            return True
        
        # ì—°ì† ë°˜ë³µì´ 2íšŒ ì´ìƒì´ë©´ ë°˜ë³µìœ¼ë¡œ íŒë‹¨
        return self.consecutive_repetitions >= 2
    
    def _is_conclusion_reached(self) -> bool:
        """ê²°ë¡ ì´ ì¶©ë¶„íˆ ë„ì¶œë˜ì—ˆëŠ”ì§€ í™•ì¸ - ë” ì •í™•í•œ íŒë‹¨"""
        if len(self.messages) < 6:  # ìµœì†Œ ë©”ì‹œì§€ ìˆ˜
            return False
        
        # ìµœê·¼ ë©”ì‹œì§€ë“¤ì—ì„œ ê²°ë¡  íŒ¨í„´ í™•ì¸
        recent_messages = self.messages[-8:]
        conclusion_keywords = ['ê²°ë¡ ', 'ë§ˆë¬´ë¦¬', 'ì •ë¦¬í•˜ë©´', 'ìµœì¢…ì ìœ¼ë¡œ', 'ë”°ë¼ì„œ', 'ì‹¤í–‰í•˜ê¸°ë¡œ', 'í•©ì˜']
        action_keywords = ['ì§„í–‰', 'ì‹¤í–‰', 'ì¶”ì§„', 'ê³„íš', 'ë‹¤ìŒ ë‹¨ê³„', 'ì•¡ì…˜']
        
        conclusion_count = 0
        action_count = 0
        
        for msg in recent_messages:
            if not msg.is_moderator and not msg.is_human_input:
                content_lower = msg.content.lower()
                
                conclusion_matches = sum(1 for keyword in conclusion_keywords if keyword in content_lower)
                action_matches = sum(1 for keyword in action_keywords if keyword in content_lower)
                
                if conclusion_matches >= 2:  # ê²°ë¡  í‚¤ì›Œë“œ 2ê°œ ì´ìƒ
                    conclusion_count += 1
                if action_matches >= 1:  # ì•¡ì…˜ í‚¤ì›Œë“œ 1ê°œ ì´ìƒ
                    action_count += 1
        
        # ìµœê·¼ 8ê°œ ë©”ì‹œì§€ ì¤‘ 4ê°œ ì´ìƒì´ ê²°ë¡  ë‚´ìš©ì´ê³ , 2ê°œ ì´ìƒì´ ì•¡ì…˜ ë‚´ìš©ì´ë©´ íšŒì˜ ì¢…ë£Œ
        return conclusion_count >= 4 and action_count >= 2
    
    def get_time_until_next_speak(self) -> float:
        """ë‹¤ìŒ ë°œì–¸ê¹Œì§€ ë‚¨ì€ ì‹œê°„ (ì´ˆ) ê³„ì‚°"""
        if not self.last_message_time:
            return 0.0
        elapsed = (datetime.now() - self.last_message_time).total_seconds()
        remaining = max(0.0, self.speaking_speed - elapsed)
        return remaining
        
    def generate_round_summary(self, round_number: int) -> str:
        """íŠ¹ì • ë¼ìš´ë“œì˜ ìš”ì•½ ìƒì„±"""
        if round_number in self.round_summaries:
            return self.round_summaries[round_number]
        
        # í•´ë‹¹ ë¼ìš´ë“œì˜ ë©”ì‹œì§€ë“¤ ì¶”ì¶œ
        round_messages = []
        non_moderator_count = len(self.get_non_moderator_personas())
        
        if non_moderator_count == 0:
            return ""
        
        # ë¼ìš´ë“œë³„ ë©”ì‹œì§€ ë²”ìœ„ ê³„ì‚° (ê·¼ì‚¬ì¹˜)
        start_index = (round_number - 1) * non_moderator_count
        end_index = round_number * non_moderator_count
        
        for i, msg in enumerate(self.messages):
            if not msg.is_moderator and not msg.is_human_input:
                msg_round = (i // non_moderator_count) + 1
                if msg_round == round_number:
                    round_messages.append(msg)
        
        if not round_messages:
            return ""
        
        # ìš”ì•½ ìƒì„±
        summary_parts = []
        for msg in round_messages:
            persona = next((p for p in self.personas if p.id == msg.persona_id), None)
            if persona:
                summary_parts.append(f"{persona.role} {persona.name}: {msg.content[:80]}{'...' if len(msg.content) > 80 else ''}")
        
        summary = f"ë¼ìš´ë“œ {round_number} ìš”ì•½:\n" + "\n".join(summary_parts)
        self.round_summaries[round_number] = summary
        return summary
    
    def extract_key_insights(self) -> List[str]:
        """íšŒì˜ì—ì„œ í•µì‹¬ ì¸ì‚¬ì´íŠ¸ ì¶”ì¶œ"""
        insights = []
        
        # ê¸´ ë©”ì‹œì§€ë“¤ì—ì„œ ì¸ì‚¬ì´íŠ¸ ì¶”ì¶œ (100ì ì´ìƒ)
        for msg in self.messages:
            if len(msg.content) > 100 and not msg.is_moderator:
                persona = next((p for p in self.personas if p.id == msg.persona_id), None)
                if persona:
                    insight = f"[{persona.role}] {msg.content[:150]}{'...' if len(msg.content) > 150 else ''}"
                    insights.append(insight)
        
        self.key_insights = insights[-10:]  # ìµœê·¼ 10ê°œë§Œ ìœ ì§€
        return self.key_insights
    
    def analyze_conversation_flow(self) -> Dict[str, Any]:
        """ğŸ¯ ëŒ€í™” íë¦„ ë¶„ì„ - ì°½ì˜ì  ëŒ€í™” ì²´ì¸ ì‹œìŠ¤í…œ"""
        if len(self.messages) < 2:
            return {"status": "insufficient_data"}
        
        recent_messages = self.messages[-5:]  # ìµœê·¼ 5ê°œ ë©”ì‹œì§€
        
        # 1. ë…¼ì˜ ì´ˆì  ì¶”ì¶œ
        topics = []
        for msg in recent_messages:
            if not msg.is_moderator:
                # í•µì‹¬ í‚¤ì›Œë“œ ì¶”ì¶œ (ê°„ë‹¨í•œ ë°©ì‹)
                words = msg.content.split()
                important_words = [w for w in words if len(w) > 3 and w not in ['ê²ƒì…ë‹ˆë‹¤', 'ìˆìŠµë‹ˆë‹¤', 'í•´ì•¼', 'í†µí•´']]
                topics.extend(important_words[:3])  # ë©”ì‹œì§€ë‹¹ ìµœëŒ€ 3ê°œ í‚¤ì›Œë“œ
        
        # ê°€ì¥ ìì£¼ ì–¸ê¸‰ëœ í† í”½ì„ í˜„ì¬ ì´ˆì ìœ¼ë¡œ ì„¤ì •
        if topics:
            from collections import Counter
            most_common = Counter(topics).most_common(1)
            self.discussion_focus = most_common[0][0] if most_common else ""
        
        # 2. ì§ˆë¬¸ê³¼ ë‹µë³€ ë§¤ì¹­
        questions = []
        for msg in recent_messages:
            if '?' in msg.content or 'ì–´ë–»ê²Œ' in msg.content or 'ì™œ' in msg.content:
                questions.append({
                    'speaker': msg.persona_name,
                    'question': msg.content,
                    'answered': False
                })
        
        # 3. í•©ì˜/ì´ê²¬ ë¶„ì„
        agreement_keywords = ['ë™ì˜', 'ì°¬ì„±', 'ë§ìŠµë‹ˆë‹¤', 'ì¢‹ì€', 'ì ì ˆ', 'ì •í™•']
        disagreement_keywords = ['í•˜ì§€ë§Œ', 'ê·¸ëŸ¬ë‚˜', 'ë°˜ëŒ€', 'ë¬¸ì œ', 'ìš°ë ¤', 'ë‹¤ë¥¸']
        
        for msg in recent_messages:
            content_lower = msg.content.lower()
            if any(keyword in content_lower for keyword in agreement_keywords):
                self.agreements.append(f"{msg.persona_name}: {msg.content[:50]}...")
            elif any(keyword in content_lower for keyword in disagreement_keywords):
                self.disagreements.append(f"{msg.persona_name}: {msg.content[:50]}...")
        
        # ìµœê·¼ 3ê°œë§Œ ìœ ì§€
        self.agreements = self.agreements[-3:]
        self.disagreements = self.disagreements[-3:]
        
        return {
            "status": "analyzed",
            "focus": self.discussion_focus,
            "questions": questions,
            "agreements": len(self.agreements),
            "disagreements": len(self.disagreements)
        }
    
    def get_conversation_direction(self) -> str:
        """ğŸ¯ ë‹¤ìŒ ëŒ€í™” ë°©í–¥ ì œì‹œ"""
        analysis = self.analyze_conversation_flow()
        
        if analysis["status"] == "insufficient_data":
            return "íšŒì˜ ì£¼ì œì— ëŒ€í•œ ì²« ë²ˆì§¸ ì˜ê²¬ì„ ì œì‹œí•´ì£¼ì„¸ìš”."
        
        directions = []
        
        # í•´ê²°ë˜ì§€ ì•Šì€ ì§ˆë¬¸ì´ ìˆìœ¼ë©´ ìš°ì„  ì²˜ë¦¬
        if self.pending_questions:
            directions.append(f"ë¯¸í•´ê²° ì§ˆë¬¸: {self.pending_questions[-1]}")
        
        # ì´ê²¬ì´ ë§ìœ¼ë©´ í•©ì˜ì  ì°¾ê¸°
        if len(self.disagreements) > len(self.agreements):
            directions.append("ì„œë¡œ ë‹¤ë¥¸ ì˜ê²¬ë“¤ ì‚¬ì´ì˜ ê³µí†µì ì„ ì°¾ì•„ë³´ì„¸ìš”.")
        
        # í˜„ì¬ ì´ˆì ì´ ìˆìœ¼ë©´ ì‹¬í™” ë…¼ì˜
        if self.discussion_focus:
            directions.append(f"'{self.discussion_focus}'ì— ëŒ€í•´ ë” êµ¬ì²´ì ìœ¼ë¡œ ë…¼ì˜í•´ì£¼ì„¸ìš”.")
        
        # ê¸°ë³¸ ë°©í–¥
        if not directions:
            directions.append("ì´ì „ ë°œì–¸ìì˜ ì˜ê²¬ì— ëŒ€í•œ êµ¬ì²´ì ì¸ ë°˜ì‘ì´ë‚˜ ë³´ì™„ ì˜ê²¬ì„ ì œì‹œí•´ì£¼ì„¸ìš”.")
        
        return " | ".join(directions)

    def analyze_uploaded_files(self) -> Dict[str, Any]:
        """ì—…ë¡œë“œëœ íŒŒì¼ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ í‚¤ì›Œë“œì™€ ìš”ì•½ ì¶”ì¶œ"""
        if not self.uploaded_files_content or self.file_analysis:
            return self.file_analysis
        
        try:
            # ê°„ë‹¨í•œ í‚¤ì›Œë“œ ì¶”ì¶œ (ê³µë°±ê³¼ ì¤„ë°”ê¿ˆìœ¼ë¡œ ë‹¨ì–´ ë¶„ë¦¬)
            words = self.uploaded_files_content.replace('\n', ' ').split()
            # ê¸¸ì´ê°€ 3ì ì´ìƒì¸ ë‹¨ì–´ë“¤ë§Œ ì¶”ì¶œ (í•œêµ­ì–´/ì˜ì–´ í˜¼í•© ê³ ë ¤)
            meaningful_words = [word.strip('.,!?:;"()[]{}') for word in words 
                              if len(word.strip('.,!?:;"()[]{}')) >= 3]
            
            # ë¹ˆë„ ê³„ì‚° (ê°„ë‹¨í•œ ë°©ì‹)
            word_count = {}
            for word in meaningful_words:
                word_lower = word.lower()
                word_count[word_lower] = word_count.get(word_lower, 0) + 1
            
            # ìƒìœ„ í‚¤ì›Œë“œ ì¶”ì¶œ (ë¹ˆë„ ê¸°ì¤€)
            sorted_words = sorted(word_count.items(), key=lambda x: x[1], reverse=True)
            self.file_keywords = [word for word, count in sorted_words[:20] if count > 1]
            
            # íŒŒì¼ ìš”ì•½ (ì²« ë¶€ë¶„ê³¼ ë§ˆì§€ë§‰ ë¶€ë¶„)
            content_length = len(self.uploaded_files_content)
            if content_length > 1000:
                summary = (self.uploaded_files_content[:500] + 
                          "\n...[ì¤‘ê°„ ë‚´ìš© ìƒëµ]...\n" + 
                          self.uploaded_files_content[-300:])
            else:
                summary = self.uploaded_files_content
            
            self.file_analysis = {
                'keywords': self.file_keywords,
                'summary': summary,
                'total_length': content_length,
                'word_count': len(meaningful_words),
                'sections': self._extract_file_sections()
            }
            
        except Exception as e:
            self.file_analysis = {
                'error': f"íŒŒì¼ ë¶„ì„ ì˜¤ë¥˜: {str(e)}",
                'keywords': [],
                'summary': self.uploaded_files_content[:500] + "..." if len(self.uploaded_files_content) > 500 else self.uploaded_files_content
            }
        
        return self.file_analysis
    
    def _extract_file_sections(self) -> List[Dict[str, str]]:
        """íŒŒì¼ì—ì„œ ì„¹ì…˜ë³„ë¡œ ë‚´ìš© ë¶„ë¦¬"""
        sections = []
        if not self.uploaded_files_content:
            return sections
        
        # íŒŒì¼ëª…ìœ¼ë¡œ êµ¬ë¶„ëœ ì„¹ì…˜ë“¤ ì¶”ì¶œ
        file_parts = self.uploaded_files_content.split('---')
        for i, part in enumerate(file_parts):
            if part.strip():
                lines = part.strip().split('\n')
                if len(lines) > 1:
                    # ì²« ì¤„ì´ íŒŒì¼ëª…ì¸ ê²½ìš°
                    title = lines[0].strip() if len(lines[0].strip()) < 100 else f"ì„¹ì…˜ {i+1}"
                    content = '\n'.join(lines[1:]).strip()
                    if content:
                        sections.append({
                            'title': title,
                            'content': content[:800] + "..." if len(content) > 800 else content
                        })
        
        return sections
    
    def get_relevant_file_content(self, query_keywords: List[str]) -> str:
        """ì¿¼ë¦¬ í‚¤ì›Œë“œì™€ ê´€ë ¨ëœ íŒŒì¼ ë‚´ìš© ì¶”ì¶œ (ê°„ë‹¨í•œ RAG)"""
        if not self.uploaded_files_content:
            return ""
        
        analysis = self.analyze_uploaded_files()
        
        # í‚¤ì›Œë“œ ë§¤ì¹­ì„ í†µí•œ ê´€ë ¨ ì„¹ì…˜ ì¶”ì¶œ
        relevant_sections = []
        
        for section in analysis.get('sections', []):
            content_lower = section['content'].lower()
            # ì¿¼ë¦¬ í‚¤ì›Œë“œ ì¤‘ í•˜ë‚˜ë¼ë„ í¬í•¨ëœ ì„¹ì…˜ ì¶”ì¶œ
            for keyword in query_keywords:
                if keyword.lower() in content_lower:
                    relevant_sections.append(section)
                    break
        
        if relevant_sections:
            result = "=== ê´€ë ¨ ì°¸ê³  ìë£Œ ===\n"
            for section in relevant_sections[:3]:  # ìµœëŒ€ 3ê°œ ì„¹ì…˜ë§Œ
                result += f"\nğŸ“„ {section['title']}\n{section['content']}\n"
            return result
        else:
            # ê´€ë ¨ ì„¹ì…˜ì´ ì—†ìœ¼ë©´ ì „ì²´ ìš”ì•½ ë°˜í™˜
            return f"=== ì°¸ê³  ìë£Œ ìš”ì•½ ===\n{analysis.get('summary', '')}"

def initialize_session_state():
    """ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”"""
    if 'virtual_meeting' not in st.session_state:
        st.session_state.virtual_meeting = VirtualMeeting()
    
    # ğŸ¯ ê¸°ì¡´ meeting ê°ì²´ë¥¼ ëŒ€í™” ì²´ì¸ ì‹œìŠ¤í…œìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œ
    meeting = st.session_state.virtual_meeting
    
    # ìƒˆë¡œìš´ ëŒ€í™” ì²´ì¸ ì‹œìŠ¤í…œ ì†ì„±ì´ ì—†ìœ¼ë©´ ì¶”ê°€
    if not hasattr(meeting, 'conversation_chain'):
        meeting.conversation_chain = []
        meeting.discussion_focus = ""
        meeting.pending_questions = []
        meeting.agreements = []
        meeting.disagreements = []
        meeting.manual_round_control = True
        meeting.turn_counter = len([msg for msg in meeting.messages if not msg.is_moderator and not msg.is_human_input])
    
    # ğŸ”§ ìƒˆë¡œìš´ íšŒì˜ ì œì–´ ì†ì„±ì´ ì—†ìœ¼ë©´ ì¶”ê°€
    if not hasattr(meeting, 'original_max_rounds'):
        meeting.original_max_rounds = meeting.max_rounds
    if not hasattr(meeting, 'extension_granted'):
        meeting.extension_granted = False
    if not hasattr(meeting, 'consecutive_repetitions'):
        meeting.consecutive_repetitions = 0
    if not hasattr(meeting, 'last_meaningful_content'):
        meeting.last_meaningful_content = []
    
    # ê¸°ì¡´ meeting ê°ì²´ê°€ ìƒˆë¡œìš´ ë©”ì†Œë“œë¥¼ ê°€ì§€ê³  ìˆì§€ ì•Šìœ¼ë©´ ìƒˆë¡œ ìƒì„±
    if not hasattr(meeting, '_is_conclusion_reached'):
        # ê¸°ì¡´ ë°ì´í„° ë°±ì—…
        old_meeting = meeting
        new_meeting = VirtualMeeting()
        
        # ì¤‘ìš”í•œ ë°ì´í„° ë³µì‚¬
        if hasattr(old_meeting, 'personas'):
            new_meeting.personas = old_meeting.personas
        if hasattr(old_meeting, 'messages'):
            new_meeting.messages = old_meeting.messages
        if hasattr(old_meeting, 'meeting_topic'):
            new_meeting.meeting_topic = old_meeting.meeting_topic
        if hasattr(old_meeting, 'conversation_round'):
            new_meeting.conversation_round = old_meeting.conversation_round
        if hasattr(old_meeting, 'max_rounds'):
            new_meeting.max_rounds = old_meeting.max_rounds
        if hasattr(old_meeting, 'is_active'):
            new_meeting.is_active = old_meeting.is_active
        if hasattr(old_meeting, 'start_time'):
            new_meeting.start_time = old_meeting.start_time
        if hasattr(old_meeting, 'uploaded_files_content'):
            new_meeting.uploaded_files_content = old_meeting.uploaded_files_content
        if hasattr(old_meeting, 'auto_mode'):
            new_meeting.auto_mode = old_meeting.auto_mode
        if hasattr(old_meeting, 'speaking_speed'):
            new_meeting.speaking_speed = old_meeting.speaking_speed
        if hasattr(old_meeting, 'typing_speed'):
            new_meeting.typing_speed = old_meeting.typing_speed
        
        # ğŸ¯ ëŒ€í™” ì²´ì¸ ì‹œìŠ¤í…œ ì†ì„±ë„ ë³µì‚¬
        if hasattr(old_meeting, 'conversation_chain'):
            new_meeting.conversation_chain = old_meeting.conversation_chain
            new_meeting.discussion_focus = old_meeting.discussion_focus
            new_meeting.pending_questions = old_meeting.pending_questions
            new_meeting.agreements = old_meeting.agreements
            new_meeting.disagreements = old_meeting.disagreements
            new_meeting.manual_round_control = old_meeting.manual_round_control
            new_meeting.turn_counter = old_meeting.turn_counter
        
        # ğŸ”§ ìƒˆë¡œìš´ íšŒì˜ ì œì–´ ì†ì„± ë³µì‚¬
        if hasattr(old_meeting, 'original_max_rounds'):
            new_meeting.original_max_rounds = old_meeting.original_max_rounds
        else:
            new_meeting.original_max_rounds = new_meeting.max_rounds
            
        if hasattr(old_meeting, 'extension_granted'):
            new_meeting.extension_granted = old_meeting.extension_granted
        if hasattr(old_meeting, 'consecutive_repetitions'):
            new_meeting.consecutive_repetitions = old_meeting.consecutive_repetitions
        if hasattr(old_meeting, 'last_meaningful_content'):
            new_meeting.last_meaningful_content = old_meeting.last_meaningful_content
        
        st.session_state.virtual_meeting = new_meeting
    
    # AI ëª¨ë¸ ì„ íƒ ì´ˆê¸°í™”
    if 'selected_ai_model' not in st.session_state:
        st.session_state.selected_ai_model = 'gpt-4o-mini'
        
        # ê¸°ë³¸ ì‚¬íšŒì í˜ë¥´ì†Œë‚˜ ìƒì„±
        moderator = Persona(
            id="moderator_001",
            name="ì‚¬íšŒì ê¹€ì§„í–‰",
            role="íšŒì˜ ì‚¬íšŒì",
            prompt="""ë‹¹ì‹ ì€ ì „ë¬¸ì ì¸ íšŒì˜ ì‚¬íšŒìì…ë‹ˆë‹¤. 
            íšŒì˜ì˜ íë¦„ì„ ì›í™œí•˜ê²Œ ì´ëŒê³ , ì°¸ê°€ìë“¤ì˜ ì˜ê²¬ì„ ì ì ˆíˆ ì¡°ìœ¨í•˜ë©°, 
            ì£¼ì œì—ì„œ ë²—ì–´ë‚˜ì§€ ì•Šë„ë¡ ì•ˆë‚´í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.
            ê°„ê²°í•˜ê³  ëª…í™•í•˜ê²Œ ë§í•˜ë©°, ëª¨ë“  ì°¸ê°€ìê°€ ë°œì–¸í•  ê¸°íšŒë¥¼ ê°–ë„ë¡ í•©ë‹ˆë‹¤.
            
            íšŒì˜ ì§„í–‰ ì‹œ ë‹¤ìŒê³¼ ê°™ì€ ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤:
            - íšŒì˜ ì‹œì‘ ì‹œ ì°¸ê°€ì ì†Œê°œ ë° ì£¼ì œ ì•ˆë‚´
            - ë°œì–¸ ìˆœì„œ ì¡°ì • ë° ì‹œê°„ ê´€ë¦¬
            - í† ë¡ ì´ ê²©í™”ë˜ê±°ë‚˜ ì£¼ì œì—ì„œ ë²—ì–´ë‚  ë•Œ ì¤‘ì¬
            - ì¤‘ê°„ ì •ë¦¬ ë° ê²°ë¡  ë„ì¶œ
            
            ë§í•˜ëŠ” ìŠ¤íƒ€ì¼: ì •ì¤‘í•˜ê³  ëª…í™•í•˜ë©° ê°„ê²°í•˜ê²Œ, ë•Œë¡œëŠ” ìœ ë¨¸ë¥¼ ì„ì–´ ë¶„ìœ„ê¸°ë¥¼ ë¶€ë“œëŸ½ê²Œ ë§Œë“­ë‹ˆë‹¤.""",
            personality="ì°¨ë¶„í•˜ê³  ê³µì •í•˜ë©° ì „ë¬¸ì , ì ì ˆí•œ ìœ ë¨¸ ê°ê°",
            expertise="íšŒì˜ ì§„í–‰, í† ë¡  ì¡°ìœ¨, ì˜ê²¬ ì •ë¦¬, ê°ˆë“± ì¤‘ì¬",
            speaking_style="ì •ì¤‘í•˜ê³  ëª…í™•í•˜ë©° ê°„ê²°í•œ ë§íˆ¬, ë•Œë¡œëŠ” ì¹œê·¼í•œ ë†ë‹´",
            is_moderator=True
        )
        st.session_state.virtual_meeting.add_persona(moderator)
    
    # ìë™ ëª¨ë“œ ê´€ë ¨ ì„¸ì…˜ ìƒíƒœ ì¶”ê°€
    if 'auto_mode_last_run' not in st.session_state:
        st.session_state.auto_mode_last_run = datetime.now()
    
    if 'auto_mode_running' not in st.session_state:
        st.session_state.auto_mode_running = False
    
    # ê¸°ë³¸ í˜ë¥´ì†Œë‚˜ë“¤ ì¶”ê°€ (ì˜ˆì‹œ)
    if len(st.session_state.virtual_meeting.personas) == 1:  # ì‚¬íšŒìë§Œ ìˆëŠ” ê²½ìš°
        sample_personas = [
            Persona(
                id="ceo_001",
                name="CEO ë°•ì„±ê³µ",
                role="ìµœê³ ê²½ì˜ì",
                prompt="",
                personality="ë¹„ì „ì„ ì œì‹œí•˜ê³  ë¦¬ë”ì‹­ì„ ë°œíœ˜í•˜ëŠ” ì„±ê²©",
                expertise="ì „ëµ ê²½ì˜, ì˜ì‚¬ê²°ì •, ë¦¬ë”ì‹­",
                speaking_style="í™•ì‹ ì— ì°¨ê³  ì¹´ë¦¬ìŠ¤ë§ˆ ìˆëŠ” ë§íˆ¬"
            ),
            Persona(
                id="cto_001", 
                name="CTO ì´ê¸°ìˆ ",
                role="ìµœê³ ê¸°ìˆ ì±…ì„ì",
                prompt="",
                personality="ë…¼ë¦¬ì ì´ê³  ë¶„ì„ì ì¸ ì„±ê²©",
                expertise="ê¸°ìˆ  ì „ëµ, ê°œë°œ, í˜ì‹ ",
                speaking_style="ë°ì´í„°ì™€ ê·¼ê±°ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•œ ì°¨ë¶„í•œ ë§íˆ¬"
            ),
            Persona(
                id="cmo_001",
                name="CMO ê¹€ë§ˆì¼€íŒ…",
                role="ìµœê³ ë§ˆì¼€íŒ…ì±…ì„ì", 
                prompt="",
                personality="ì°½ì˜ì ì´ê³  ì†Œí†µì„ ì¤‘ì‹œí•˜ëŠ” ì„±ê²©",
                expertise="ë§ˆì¼€íŒ… ì „ëµ, ë¸Œëœë”©, ê³ ê° ë¶„ì„",
                speaking_style="ì—´ì •ì ì´ê³  ì°½ì˜ì ì¸ ì•„ì´ë””ì–´ë¥¼ ì œì‹œí•˜ëŠ” ë§íˆ¬"
            )
        ]
        
        for persona in sample_personas:
            st.session_state.virtual_meeting.add_persona(persona)

def connect_to_db():
    """ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°"""
    try:
        conn = mysql.connector.connect(
            host=os.getenv('SQL_HOST'),
            user=os.getenv('SQL_USER'),
            password=os.getenv('SQL_PASSWORD'),
            database=os.getenv('SQL_DATABASE_NEWBIZ'),
            charset='utf8mb4',
            collation='utf8mb4_unicode_ci'
        )
        return conn
    except mysql.connector.Error as err:
        st.error(f"ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì˜¤ë¥˜: {err}")
        return None

def save_meeting_record(meeting: 'VirtualMeeting', meeting_log: str, summary: str) -> bool:
    """íšŒì˜ë¡ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥"""
    try:
        conn = connect_to_db()
        if not conn:
            return False
        
        cursor = conn.cursor()
        
        # ì°¸ê°€ì ëª©ë¡ ìƒì„±
        participants = ", ".join([p.name + "(" + p.role + ")" for p in meeting.personas])
        
        # ì‚¬ìš©ëœ AI ëª¨ë¸ ì •ë³´ ì¶”ê°€
        ai_model_used = st.session_state.get('selected_ai_model', 'gpt-4o-mini')
        
        # íšŒì˜ë¡ ì €ì¥ (action_items í•„ë“œì— AI ëª¨ë¸ ì •ë³´ ì„ì‹œ ì €ì¥)
        cursor.execute("""
            INSERT INTO meeting_records 
            (title, date, participants, full_text, summary, action_items, created_at)
            VALUES (%s, %s, %s, %s, %s, %s, %s)
        """, (
            meeting.meeting_topic,
            meeting.start_time if meeting.start_time else datetime.now(),
            participants,
            meeting_log,
            summary,
            f"AI ëª¨ë¸: {ai_model_used}",  # action_items í•„ë“œì— AI ëª¨ë¸ ì •ë³´ ì €ì¥
            datetime.now()
        ))
        
        conn.commit()
        cursor.close()
        conn.close()
        return True
        
    except mysql.connector.Error as err:
        st.error(f"íšŒì˜ë¡ ì €ì¥ ì˜¤ë¥˜: {err}")
        return False

def get_saved_meeting_records() -> List[Dict]:
    """ì €ì¥ëœ íšŒì˜ë¡ ëª©ë¡ ì¡°íšŒ"""
    try:
        conn = connect_to_db()
        if not conn:
            return []
        
        cursor = conn.cursor()
        cursor.execute("""
            SELECT meeting_id, title, date, participants, created_at
            FROM meeting_records
            ORDER BY date DESC, created_at DESC
        """)
        
        records = []
        for row in cursor.fetchall():
            records.append({
                'meeting_id': row[0],
                'title': row[1],
                'date': row[2],
                'participants': row[3],
                'created_at': row[4]
            })
        
        cursor.close()
        conn.close()
        return records
        
    except mysql.connector.Error as err:
        st.error(f"íšŒì˜ë¡ ì¡°íšŒ ì˜¤ë¥˜: {err}")
        return []

def get_meeting_record_detail(meeting_id: int) -> Dict:
    """íŠ¹ì • íšŒì˜ë¡ ìƒì„¸ ì¡°íšŒ"""
    try:
        conn = connect_to_db()
        if not conn:
            return {}
        
        cursor = conn.cursor()
        cursor.execute("""
            SELECT meeting_id, title, date, participants, full_text, summary, action_items, created_at
            FROM meeting_records
            WHERE meeting_id = %s
        """, (meeting_id,))
        
        row = cursor.fetchone()
        if row:
            record = {
                'meeting_id': row[0],
                'title': row[1],
                'date': row[2],
                'participants': row[3],
                'full_text': row[4],
                'summary': row[5],
                'action_items': row[6],
                'created_at': row[7]
            }
        else:
            record = {}
        
        cursor.close()
        conn.close()
        return record
        
    except mysql.connector.Error as err:
        st.error(f"íšŒì˜ë¡ ìƒì„¸ ì¡°íšŒ ì˜¤ë¥˜: {err}")
        return {}

def delete_meeting_record(meeting_id: int) -> bool:
    """íšŒì˜ë¡ ì‚­ì œ"""
    try:
        conn = connect_to_db()
        if not conn:
            return False
        
        cursor = conn.cursor()
        cursor.execute("DELETE FROM meeting_records WHERE meeting_id = %s", (meeting_id,))
        
        conn.commit()
        cursor.close()
        conn.close()
        return True
        
    except mysql.connector.Error as err:
        st.error(f"íšŒì˜ë¡ ì‚­ì œ ì˜¤ë¥˜: {err}")
        return False

def generate_meeting_summary(meeting_log: str, model_name: str = "gpt-4o-mini") -> str:
    """AIë¥¼ ì‚¬ìš©í•˜ì—¬ íšŒì˜ë¡ ìš”ì•½ ìƒì„±"""
    try:
        # ëª¨ë¸ì— ë”°ë¥¸ í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
        if model_name.startswith('claude'):
            # Anthropic Claude ëª¨ë¸
            anthropic_key = os.getenv('ANTHROPIC_API_KEY')
            if not anthropic_key or anthropic_key.strip() == '' or anthropic_key == 'NA':
                return "AI ìš”ì•½ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Anthropic API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
            
            client = anthropic.Anthropic(api_key=anthropic_key)
        else:
            # OpenAI ëª¨ë¸
            openai_key = os.getenv('OPENAI_API_KEY')
            if not openai_key or openai_key.strip() == '' or openai_key == 'NA':
                return "AI ìš”ì•½ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. OpenAI API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
            
            client = OpenAI(api_key=openai_key)
        
        system_prompt = """ë‹¹ì‹ ì€ íšŒì˜ë¡ ìš”ì•½ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì£¼ì–´ì§„ íšŒì˜ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”:

## ğŸ“‹ íšŒì˜ ìš”ì•½

### ğŸ¯ ì£¼ìš” ë…¼ì˜ ì‚¬í•­
- í•µì‹¬ ë…¼ì˜ í¬ì¸íŠ¸ë“¤ì„ 3-5ê°œ ì •ë„ë¡œ ì •ë¦¬

### ğŸ’¡ ì£¼ìš” ì˜ê²¬ ë° ì œì•ˆ
- ì°¸ê°€ìë³„ ì£¼ìš” ì˜ê²¬ê³¼ ì œì•ˆì‚¬í•­

### âœ… ê²°ë¡  ë° í•©ì˜ì‚¬í•­
- íšŒì˜ë¥¼ í†µí•´ ë„ì¶œëœ ê²°ë¡ ì´ë‚˜ í•©ì˜ëœ ë‚´ìš©

### ğŸ“ í–¥í›„ ì•¡ì…˜ ì•„ì´í…œ
- í›„ì† ì¡°ì¹˜ê°€ í•„ìš”í•œ ì‚¬í•­ë“¤

### ğŸ” ì¶”ê°€ ê²€í†  í•„ìš” ì‚¬í•­
- ì¶”í›„ ë…¼ì˜ê°€ í•„ìš”í•œ ì´ìŠˆë“¤

ê°„ê²°í•˜ê³  ëª…í™•í•˜ê²Œ ì‘ì„±í•˜ë˜, ì¤‘ìš”í•œ ë‚´ìš©ì€ ë¹ ëœ¨ë¦¬ì§€ ë§ê³  í¬í•¨í•´ì£¼ì„¸ìš”."""

        user_message = f"ë‹¤ìŒ íšŒì˜ ë‚´ìš©ì„ ìš”ì•½í•´ì£¼ì„¸ìš”:\n\n{meeting_log}"
        
        if model_name.startswith('claude'):
            # Claude API í˜¸ì¶œ
            response = client.messages.create(
                model=model_name,
                max_tokens=1000,
                temperature=0.3,
                system=system_prompt,
                messages=[
                    {"role": "user", "content": user_message}
                ]
            )
            return response.content[0].text.strip()
        else:
            # OpenAI API í˜¸ì¶œ
            response = client.chat.completions.create(
                model=model_name,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_message}
                ],
                max_tokens=1000,
                temperature=0.3
            )
            return response.choices[0].message.content.strip()
        
    except Exception as e:
        return f"ìš”ì•½ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"

def extract_text_from_file(uploaded_file) -> str:
    """ì—…ë¡œë“œëœ íŒŒì¼ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ"""
    try:
        file_type = uploaded_file.type
        content = ""
        
        if file_type == "text/plain":
            content = str(uploaded_file.read(), "utf-8")
        elif file_type == "application/pdf":
            pdf_reader = PyPDF2.PdfReader(uploaded_file)
            for page in pdf_reader.pages:
                content += page.extract_text()
        elif file_type == "application/vnd.openxmlformats-officedocument.wordprocessingml.document":
            doc = docx.Document(uploaded_file)
            for paragraph in doc.paragraphs:
                content += paragraph.text + "\n"
        elif file_type == "text/csv":
            df = pd.read_csv(uploaded_file)
            content = df.to_string()
        else:
            content = "ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤."
            
        return content
    except Exception as e:
        return f"íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: {str(e)}"

def generate_ai_response(persona: Persona, conversation_history: str, meeting_topic: str, file_content: str, round_number: int, enhanced_context: str = "", model_name: str = "gpt-4o-mini", total_rounds: int = 10, is_final_round: bool = False, final_round_context: str = "", conversation_direction: str = "") -> str:
    """AI ì‘ë‹µ ìƒì„± - ë¼ìš´ë“œë³„ ë§¥ë½ ìœ ì§€ ê°•í™”"""
    try:
        # ëª¨ë¸ì— ë”°ë¥¸ í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
        if model_name.startswith('claude'):
            # Anthropic Claude ëª¨ë¸
            anthropic_key = os.getenv('ANTHROPIC_API_KEY')
            if not anthropic_key or anthropic_key.strip() == '' or anthropic_key == 'NA':
                raise ValueError("Anthropic API í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. .env íŒŒì¼ì—ì„œ ANTHROPIC_API_KEYë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")
            
            client = anthropic.Anthropic(api_key=anthropic_key)
        else:
            # OpenAI ëª¨ë¸
            openai_key = os.getenv('OPENAI_API_KEY')
            if not openai_key or openai_key.strip() == '' or openai_key == 'NA':
                raise ValueError("OpenAI API í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. .env íŒŒì¼ì—ì„œ OPENAI_API_KEYë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")
            
            client = OpenAI(api_key=openai_key)
        
        # ë¼ìš´ë“œì— ë”°ë¥¸ ë§¥ë½ ì¡°ì • (ë™ì  ë‹¨ê³„ ê³„ì‚°)
        round_context = ""
        round_percentage = round_number / total_rounds
        
        # ğŸ¯ ë§ˆì§€ë§‰ ë¼ìš´ë“œ ìë™ ê°ì§€
        is_final_round = (round_number >= total_rounds)
        
        if is_final_round:
            # ë§ˆì§€ë§‰ ë¼ìš´ë“œì—ì„œëŠ” ëª¨ë“  ì°¸ê°€ìê°€ ìµœì¢… ê²°ë¡ ì„ ì œì‹œ
            round_context = f"""ğŸ ë§ˆì§€ë§‰ ë¼ìš´ë“œì…ë‹ˆë‹¤ ({round_number}/{total_rounds}ë¼ìš´ë“œ). 
            
            ì´ì œ íšŒì˜ ì „ì²´ë¥¼ ì¢…í•©í•˜ì—¬ ë‹¹ì‹ ì˜ ìµœì¢… ê²°ë¡ ì„ ì œì‹œí•  ì°¨ë¡€ì…ë‹ˆë‹¤:
            - ì „ì²´ í† ë¡ ì—ì„œ ë‚˜ì˜¨ í•µì‹¬ ë…¼ì ë“¤ì„ ì •ë¦¬í•˜ì„¸ìš”
            - ë‹¹ì‹ ì˜ ì „ë¬¸ ë¶„ì•¼ ê´€ì ì—ì„œ ìµœì¢… ì˜ê²¬ì„ ëª…í™•íˆ ì œì‹œí•˜ì„¸ìš”  
            - êµ¬ì²´ì ì¸ ì‹¤í–‰ ë°©ì•ˆì´ë‚˜ ë‹¤ìŒ ë‹¨ê³„ë¥¼ ì œì•ˆí•˜ì„¸ìš”
            - ë‹¤ë¥¸ ì°¸ê°€ìë“¤ì˜ ì˜ê²¬ì— ëŒ€í•œ ë™ì˜/ë³´ì™„ì ì„ ì–¸ê¸‰í•˜ì„¸ìš”
            
            {final_round_context}"""
        elif round_number == 1:
            round_context = "ì´ë²ˆì´ ì²« ë²ˆì§¸ ë°œì–¸ì…ë‹ˆë‹¤. ìì‹ ì„ í•œ ë¬¸ì¥ìœ¼ë¡œ ê°„ë‹¨íˆ ì†Œê°œí•œ í›„ ì£¼ì œì— ëŒ€í•œ ì˜ê²¬ì„ ì œì‹œí•˜ì„¸ìš”."
        elif round_percentage <= 0.2:  # ì´ˆê¸° 20%
            round_context = f"íšŒì˜ ì´ˆê¸° ë‹¨ê³„ì…ë‹ˆë‹¤ ({round_number}/{total_rounds}ë¼ìš´ë“œ). ë¬¸ì œ ì •ì˜ì™€ í˜„í™© íŒŒì•…ì— ì§‘ì¤‘í•˜ì—¬ ì˜ê²¬ì„ ì œì‹œí•˜ì„¸ìš”. ìê¸°ì†Œê°œë‚˜ ì¸ì‚¬ë§ì€ í•˜ì§€ ë§ˆì„¸ìš”."
        elif round_percentage <= 0.4:  # 20-40%
            round_context = f"ë¬¸ì œ íƒìƒ‰ ë‹¨ê³„ì…ë‹ˆë‹¤ ({round_number}/{total_rounds}ë¼ìš´ë“œ). ë‹¤ì–‘í•œ ê´€ì ì—ì„œ ë¬¸ì œë¥¼ ë¶„ì„í•˜ê³  ì—¬ëŸ¬ í•´ê²°ì±…ì„ ì œì‹œí•´ë³´ì„¸ìš”. ì¸ì‚¬ë§ì€ ìƒëµí•˜ì„¸ìš”."
        elif round_percentage <= 0.6:  # 40-60%
            round_context = f"í•´ê²°ì±… ê²€í†  ë‹¨ê³„ì…ë‹ˆë‹¤ ({round_number}/{total_rounds}ë¼ìš´ë“œ). ì œì‹œëœ í•´ê²°ì±…ë“¤ì„ ë¹„êµ ë¶„ì„í•˜ê³  ì¥ë‹¨ì ì„ ë…¼ì˜í•˜ì„¸ìš”. ì¸ì‚¬ë§ì€ ìƒëµí•˜ì„¸ìš”."
        elif round_percentage <= 0.8:  # 60-80%
            round_context = f"í•©ì˜ ë„ì¶œ ë‹¨ê³„ì…ë‹ˆë‹¤ ({round_number}/{total_rounds}ë¼ìš´ë“œ). ìµœì ì˜ í•´ê²°ì±…ì„ ì„ íƒí•˜ê³  êµ¬ì²´ì ì¸ ì‹¤í–‰ ë°©ì•ˆì„ ë…¼ì˜í•˜ì„¸ìš”. ì¸ì‚¬ë§ì€ ìƒëµí•˜ì„¸ìš”."
        else:  # 80-100%
            round_context = f"ê²°ë¡  ì •ë¦¬ ë‹¨ê³„ì…ë‹ˆë‹¤ ({round_number}/{total_rounds}ë¼ìš´ë“œ). ì „ì²´ ë…¼ì˜ë¥¼ ì¢…í•©í•˜ì—¬ ìµœì¢… ê²°ë¡ ê³¼ í–¥í›„ ì•¡ì…˜ í”Œëœì„ ì œì‹œí•˜ì„¸ìš”. ì¸ì‚¬ë§ì€ ìƒëµí•˜ì„¸ìš”."
        
        # ë°˜ë³µ ë°©ì§€ë¥¼ ìœ„í•œ ì¶”ê°€ ì§€ì¹¨
        repetition_warning = ""
        if is_final_round:
            repetition_warning = """
        
        âš ï¸ ë§ˆì§€ë§‰ ë¼ìš´ë“œ ì¤‘ìš” ì§€ì¹¨:
        - ì´ë²ˆì´ ë‹¹ì‹ ì˜ ë§ˆì§€ë§‰ ë°œì–¸ ê¸°íšŒì…ë‹ˆë‹¤
        - íšŒì˜ ì „ì²´ë¥¼ ì•„ìš°ë¥´ëŠ” ì¢…í•©ì ì¸ ê²°ë¡ ì„ ì œì‹œí•˜ì„¸ìš”
        - ë‹¹ì‹ ì˜ ì „ë¬¸ì„±ì„ ë°”íƒ•ìœ¼ë¡œ í•œ êµ¬ì²´ì ì¸ ì œì•ˆì„ í¬í•¨í•˜ì„¸ìš”
        - ë‹¤ë¥¸ ì°¸ê°€ìë“¤ê³¼ì˜ í•©ì˜ì ì„ ì°¾ì•„ ì–¸ê¸‰í•˜ì„¸ìš”
        - í–¥í›„ ì‹¤í–‰í•´ì•¼ í•  êµ¬ì²´ì ì¸ ì•¡ì…˜ ì•„ì´í…œì„ ì œì•ˆí•˜ì„¸ìš”
        """
        elif round_percentage > 0.8:  # ë§ˆë¬´ë¦¬ ë‹¨ê³„ì—ì„œ
            repetition_warning = """
        
        âš ï¸ ì¤‘ìš” - ë°˜ë³µ ë°©ì§€:
        - ì´ë¯¸ ê²°ë¡ ì´ ì¶©ë¶„íˆ ë…¼ì˜ë˜ì—ˆë‹¤ë©´ ìƒˆë¡œìš´ ê´€ì ì´ë‚˜ êµ¬ì²´ì ì¸ ì‹¤í–‰ ë°©ì•ˆì„ ì œì‹œí•˜ì„¸ìš”
        - ë™ì¼í•œ ë‚´ìš©ì„ ë°˜ë³µí•˜ì§€ ë§ê³ , ì´ì „ ë°œì–¸ê³¼ ì°¨ë³„í™”ëœ ì˜ê²¬ì„ ì œì‹œí•˜ì„¸ìš”
        - ë§Œì•½ ë” ì´ìƒ ìƒˆë¡œìš´ ì˜ê²¬ì´ ì—†ë‹¤ë©´ ê°„ë‹¨íˆ ë™ì˜ ì˜ì‚¬ë§Œ í‘œí˜„í•˜ì„¸ìš”
        - 'ê°ì‚¬í•©ë‹ˆë‹¤', 'í•¨ê»˜ ìµœìƒì˜ ê²°ê³¼ë¥¼' ê°™ì€ ë§ˆë¬´ë¦¬ í‘œí˜„ì„ ê³¼ë„í•˜ê²Œ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”
        """

        # ğŸ¯ ì°½ì˜ì  ëŒ€í™” ì²´ì¸ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
        conversation_guidance = ""
        if conversation_direction:
            conversation_guidance = f"\nğŸ¯ ëŒ€í™” ë°©í–¥ ê°€ì´ë“œ: {conversation_direction}\n"
        
        system_prompt = f"""ë‹¹ì‹ ì€ {persona.name}({persona.role})ì…ë‹ˆë‹¤.
        ì „ë¬¸ë¶„ì•¼: {persona.expertise}
        ë§íˆ¬: {persona.speaking_style}
        
        === ğŸ¯ ëŒ€í™” ì²´ì¸ ì‹œìŠ¤í…œ ===
        ë‹¤ìŒ ì§€ì¹¨ì„ ì—„ê²©íˆ ë”°ë¼ì£¼ì„¸ìš”:

        1. ë°”ë¡œ ì§ì „ ë°œì–¸ìì˜ ì˜ê²¬ì— êµ¬ì²´ì ìœ¼ë¡œ ë°˜ì‘í•˜ì„¸ìš” (ë™ì˜/ë°˜ë°•/ë³´ì™„)
        2. ê°™ì€ ë‚´ìš©ì„ ë°˜ë³µí•˜ì§€ ë§ê³ , ìƒˆë¡œìš´ ê´€ì ì´ë‚˜ êµ¬ì²´ì  ì‚¬ë¡€ë¥¼ ì œì‹œí•˜ì„¸ìš”
        3. ì¶”ìƒì ì¸ í‘œí˜„ë³´ë‹¤ëŠ” ì‹¤ì§ˆì ì´ê³  êµ¬ì²´ì ì¸ ë‚´ìš©ìœ¼ë¡œ ë°œì–¸í•˜ì„¸ìš”
        4. ë‹¤ë¥¸ ì°¸ê°€ìë“¤ê³¼ ì—°ê²°ë˜ëŠ” ëŒ€í™”ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”
        5. ìì‹ ë§Œì˜ ë…íŠ¹í•œ ì „ë¬¸ì„±ì„ ë°”íƒ•ìœ¼ë¡œ ì°¨ë³„í™”ëœ ì˜ê²¬ì„ ì œì‹œí•˜ì„¸ìš”

        {conversation_guidance}
        
        {round_context}
        
        í•µì‹¬ ì§€ì¹¨:
        - 150-250ì ë‚´ì™¸ë¡œ ê°„ê²°í•˜ê²Œ
        - ì´ì „ ë°œì–¸ìì˜ ë‚´ìš©ì„ êµ¬ì²´ì ìœ¼ë¡œ ì–¸ê¸‰í•˜ë©° ì‹œì‘
        - ìì‹ ë§Œì˜ ë…íŠ¹í•œ ê´€ì ì´ë‚˜ ì „ë¬¸ì„± ê¸°ë°˜ ì˜ê²¬ ì œì‹œ
        - ë‹¤ìŒ ë°œì–¸ìê°€ ë°˜ì‘í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì  í¬ì¸íŠ¸ ì œê³µ
        - ì˜ë¯¸ì—†ëŠ” ë°˜ë³µì´ë‚˜ ì¼ë°˜ì ì¸ í‘œí˜„ ê¸ˆì§€
        {repetition_warning}
        """
        
        # ê°œì„ ëœ ë§¥ë½ ì‚¬ìš© (enhanced_contextê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©)
        context_to_use = enhanced_context if enhanced_context else conversation_history
        
        user_message = f"ë§¥ë½:\n{context_to_use}\n\nì£¼ì œ: {meeting_topic}\në¼ìš´ë“œ {round_number}ì—ì„œ ë°œì–¸í•˜ì„¸ìš”."
        
        if model_name.startswith('claude'):
            # Claude API í˜¸ì¶œ
            response = client.messages.create(
                model=model_name,
                max_tokens=300,
                temperature=0.8,
                system=system_prompt,
                messages=[
                    {"role": "user", "content": user_message}
                ]
            )
            return response.content[0].text.strip()
        else:
            # OpenAI API í˜¸ì¶œ
            response = client.chat.completions.create(
                model=model_name,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_message}
                ],
                max_tokens=300,
                temperature=0.8
            )
            return response.choices[0].message.content.strip()
    except Exception as e:
        return f"[AI ì‘ë‹µ ìƒì„± ì˜¤ë¥˜: {str(e)}]"

def format_conversation_history(messages: List[Message], last_n: int = 15) -> str:
    """ëŒ€í™” íˆìŠ¤í† ë¦¬ í¬ë§·íŒ… - ê¸°ë³¸ ë²„ì „ (í•˜ìœ„ í˜¸í™˜ì„± ìœ ì§€)"""
    recent_messages = messages[-last_n:] if len(messages) > last_n else messages
    history = ""
    for msg in recent_messages:
        history += f"{msg.persona_name}: {msg.content}\n"
    return history

def get_round_based_context(messages: List[Message], current_round: int, max_context_length: int = 2000) -> str:
    """ë¼ìš´ë“œ ê¸°ë°˜ ë§¥ë½ ìƒì„± - ì „ì²´ íšŒì˜ ë§¥ë½ ìœ ì§€"""
    if not messages:
        return ""
    
    # ë¼ìš´ë“œë³„ ë©”ì‹œì§€ ê·¸ë£¹í™”
    rounds_data = {}
    moderator_messages = []
    current_round_msgs = []
    
    for msg in messages:
        if msg.is_moderator:
            moderator_messages.append(msg)
        else:
            # ë¹„ì‚¬íšŒì ë©”ì‹œì§€ë¡œ ë¼ìš´ë“œ ì¶”ì • (ê°„ë‹¨í•œ ë°©ì‹)
            estimated_round = len([m for m in messages[:messages.index(msg)+1] 
                                 if not m.is_moderator and not m.is_human_input]) // len([p for p in messages[0:1] if messages]) + 1
            
            if estimated_round not in rounds_data:
                rounds_data[estimated_round] = []
            rounds_data[estimated_round].append(msg)
    
    # ë§¥ë½ êµ¬ì„± ì „ëµ
    context_parts = []
    
    # 1. ì‚¬íšŒì ì˜¤í”„ë‹ (í•­ìƒ í¬í•¨)
    if moderator_messages:
        context_parts.append(f"[íšŒì˜ ì‹œì‘] {moderator_messages[0].persona_name}: {moderator_messages[0].content}")
    
    # 2. ì´ì „ ë¼ìš´ë“œ ìš”ì•½ (ë¼ìš´ë“œ 2 ì´ìƒì¼ ë•Œ)
    if current_round > 1:
        previous_rounds_summary = []
        for round_num in sorted(rounds_data.keys()):
            if round_num < current_round:
                round_messages = rounds_data[round_num]
                if round_messages:
                    # ê° ë¼ìš´ë“œì˜ í•µì‹¬ í¬ì¸íŠ¸ë§Œ ìš”ì•½
                    key_points = []
                    for msg in round_messages:
                        # ë©”ì‹œì§€ ê¸¸ì´ê°€ ê¸´ ê²½ìš° ìš”ì•½
                        content = msg.content[:100] + "..." if len(msg.content) > 100 else msg.content
                        key_points.append(f"{msg.persona_name}: {content}")
                    
                    previous_rounds_summary.append(f"\n[ë¼ìš´ë“œ {round_num}]\n" + "\n".join(key_points))
        
        if previous_rounds_summary:
            context_parts.append("=== ì´ì „ ë¼ìš´ë“œ ìš”ì•½ ===")
            context_parts.extend(previous_rounds_summary)
    
    # 3. ìµœê·¼ ë©”ì‹œì§€ë“¤ (í•­ìƒ í¬í•¨ - ì§ì ‘ì  ë§¥ë½)
    recent_messages = messages[-8:]  # ìµœê·¼ 8ê°œ ë©”ì‹œì§€
    if recent_messages:
        context_parts.append("\n=== ìµœê·¼ ëŒ€í™” ===")
        for msg in recent_messages:
            context_parts.append(f"{msg.persona_name}: {msg.content}")
    
    # 4. í˜„ì¬ ë¼ìš´ë“œ ì§„í–‰ ìƒí™©
    context_parts.append(f"\n=== í˜„ì¬ ìƒí™© ===")
    context_parts.append(f"í˜„ì¬ ë¼ìš´ë“œ: {current_round}")
    
    # ì „ì²´ ë§¥ë½ ì¡°í•©
    full_context = "\n".join(context_parts)
    
    # í† í° ê¸¸ì´ ì œí•œ (ëŒ€ëµì ìœ¼ë¡œ ë¬¸ì ìˆ˜ë¡œ ì œí•œ)
    if len(full_context) > max_context_length:
        # ê¸¸ì´ê°€ ì´ˆê³¼ë˜ë©´ ì´ì „ ë¼ìš´ë“œ ìš”ì•½ ë¶€ë¶„ì„ ë” ì••ì¶•
        essential_parts = []
        
        # í•„ìˆ˜ ìš”ì†Œ: ì˜¤í”„ë‹ + ìµœê·¼ ëŒ€í™” + í˜„ì¬ ìƒí™©
        if moderator_messages:
            essential_parts.append(f"[íšŒì˜ ì‹œì‘] {moderator_messages[0].persona_name}: {moderator_messages[0].content}")
        
        essential_parts.append("\n=== ìµœê·¼ ëŒ€í™” ===")
        for msg in recent_messages:
            essential_parts.append(f"{msg.persona_name}: {msg.content}")
        
        essential_parts.append(f"\n=== í˜„ì¬ ìƒí™© ===")
        essential_parts.append(f"í˜„ì¬ ë¼ìš´ë“œ: {current_round}")
        
        # ë‚¨ì€ ê³µê°„ì— ì´ì „ ë¼ìš´ë“œ í•µì‹¬ë§Œ ì¶”ê°€
        essential_context = "\n".join(essential_parts)
        remaining_space = max_context_length - len(essential_context)
        
        if remaining_space > 200 and current_round > 1:
            # ê°€ì¥ ìµœê·¼ 1-2 ë¼ìš´ë“œë§Œ ê°„ëµí•˜ê²Œ ì¶”ê°€
            recent_rounds = []
            for round_num in sorted(rounds_data.keys(), reverse=True):
                if round_num < current_round and len(recent_rounds) < 2:
                    round_messages = rounds_data[round_num][:3]  # ë¼ìš´ë“œë‹¹ ìµœëŒ€ 3ê°œ ë©”ì‹œì§€ë§Œ
                    if round_messages:
                        round_summary = f"[ë¼ìš´ë“œ {round_num}] " + "; ".join([f"{msg.persona_name}: {msg.content[:50]}..." for msg in round_messages])
                        if len(round_summary) < remaining_space:
                            recent_rounds.append(round_summary)
                            remaining_space -= len(round_summary)
            
            if recent_rounds:
                essential_parts.insert(-2, "\n=== ì£¼ìš” ë¼ìš´ë“œ ìš”ì•½ ===")
                essential_parts.insert(-2, "\n".join(reversed(recent_rounds)))
        
        full_context = "\n".join(essential_parts)
    
    return full_context

def get_comprehensive_meeting_context(meeting: 'VirtualMeeting') -> str:
    """íšŒì˜ ì „ì²´ ë§¥ë½ì„ ì¢…í•©ì ìœ¼ë¡œ ìƒì„± - ê³¼ê±° ë§¥ë½ ì´í•´ ê°œì„ """
    context_parts = []
    
    # 1. íšŒì˜ ê¸°ë³¸ ì •ë³´
    context_parts.append(f"=== íšŒì˜ ì •ë³´ ===")
    context_parts.append(f"ì£¼ì œ: {meeting.meeting_topic}")
    context_parts.append(f"í˜„ì¬ ë¼ìš´ë“œ: {meeting.conversation_round + 1}/{meeting.max_rounds}")
    
    # 2. í˜„ì¬ ë‹¨ê³„ ì •ë³´
    round_percentage = (meeting.conversation_round + 1) / meeting.max_rounds
    if round_percentage <= 0.2:
        stage = "ë¬¸ì œ ì •ì˜ ë° í˜„í™© íŒŒì•… ë‹¨ê³„"
    elif round_percentage <= 0.4:
        stage = "ë¬¸ì œ íƒìƒ‰ ë° í•´ê²°ì±… ì œì‹œ ë‹¨ê³„"
    elif round_percentage <= 0.6:
        stage = "í•´ê²°ì±… ë¹„êµ ë° ë¶„ì„ ë‹¨ê³„"
    elif round_percentage <= 0.8:
        stage = "í•©ì˜ì  ë„ì¶œ ë° êµ¬ì²´í™” ë‹¨ê³„"
    else:
        stage = "ìµœì¢… ê²°ë¡  ë° ì‹¤í–‰ ë°©ì•ˆ ì •ë¦¬ ë‹¨ê³„"
    context_parts.append(f"í† ë¡  ë‹¨ê³„: {stage}")
    
    # 3. ë¼ìš´ë“œë³„ í•µì‹¬ ìš”ì•½ (ìµœê·¼ 2-3ë¼ìš´ë“œ)
    if meeting.conversation_round > 0:
        context_parts.append(f"\n=== ì´ì „ ë¼ìš´ë“œ í•µì‹¬ ë‚´ìš© ===")
        start_round = max(1, meeting.conversation_round - 1)  # ìµœê·¼ 2ë¼ìš´ë“œ
        
        for round_num in range(start_round, meeting.conversation_round + 1):
            round_messages = []
            # í•´ë‹¹ ë¼ìš´ë“œì˜ ë©”ì‹œì§€ë“¤ ì°¾ê¸°
            non_moderator_count = len(meeting.get_non_moderator_personas())
            if non_moderator_count > 0:
                for i, msg in enumerate(meeting.messages):
                    if not msg.is_moderator and not msg.is_human_input:
                        msg_round = (i // non_moderator_count) + 1
                        if msg_round == round_num:
                            # ë©”ì‹œì§€ë¥¼ ì ë‹¹íˆ ìš”ì•½ (ì²« ë‘ ë¬¸ì¥)
                            sentences = msg.content.split('.')[:2]
                            summary = '.'.join(sentences).strip()
                            if len(summary) > 100:
                                summary = summary[:100] + "..."
                            round_messages.append(f"{msg.persona_name}: {summary}")
            
            if round_messages:
                context_parts.append(f"[ë¼ìš´ë“œ {round_num}]")
                context_parts.extend(round_messages[:4])  # ìµœëŒ€ 4ê°œ ë°œì–¸ë§Œ
    
    # 4. ìµœê·¼ ëŒ€í™” (ë” ìƒì„¸í•˜ê²Œ)
    context_parts.append(f"\n=== ìµœê·¼ ëŒ€í™” ===")
    recent_messages = meeting.messages[-8:]  # ìµœê·¼ 8ê°œë¡œ í™•ì¥
    for msg in recent_messages:
        # ë©”ì‹œì§€ë¥¼ ì ì ˆíˆ ìš”ì•½ (ì²« ë¬¸ì¥ + Î±)
        sentences = msg.content.split('.')
        if len(sentences) > 1:
            content = sentences[0] + '.' + (sentences[1][:30] + "..." if len(sentences[1]) > 30 else sentences[1])
        else:
            content = msg.content[:80] + "..." if len(msg.content) > 80 else msg.content
        
        speaker_info = ""
        persona = next((p for p in meeting.personas if p.id == msg.persona_id), None)
        if persona and not msg.is_moderator:
            speaker_info = f"[{persona.role}]"
        
        context_parts.append(f"{speaker_info} {msg.persona_name}: {content}")
    
    # 5. ì°¸ê³ ìë£Œ (ê°œì„ ëœ ì¶”ì¶œ)
    if meeting.uploaded_files_content and meeting.meeting_topic:
        context_parts.append(f"\n=== ì°¸ê³  ìë£Œ ===")
        topic_keywords = meeting.meeting_topic.lower().split()[:5]  # í‚¤ì›Œë“œ í™•ì¥
        
        # ê´€ë ¨ ë‚´ìš© ì¶”ì¶œ
        relevant_content = meeting.get_relevant_file_content(topic_keywords)
        if relevant_content and len(relevant_content) > 50:
            # ì°¸ê³ ìë£Œë¥¼ ì ì ˆí•œ ê¸¸ì´ë¡œ ìš”ì•½
            if len(relevant_content) > 400:
                relevant_content = relevant_content[:400] + "..."
            context_parts.append(relevant_content)
    
    # ì „ì²´ ë§¥ë½ ì¡°í•© ë° ì ì ˆí•œ ê¸¸ì´ ì œí•œ
    full_context = "\n".join(context_parts)
    
    # í† í° ì œí•œ (3000ì = ì•½ 750í† í°, max_tokens 300ì— ë§ê²Œ ì¡°ì •)
    max_length = 3000
    if len(full_context) > max_length:
        # ì¤‘ìš”ë„ ìˆœìœ¼ë¡œ ë‚´ìš© ìœ ì§€
        essential = []
        essential.append(f"ì£¼ì œ: {meeting.meeting_topic}")
        essential.append(f"ë¼ìš´ë“œ: {meeting.conversation_round + 1}/{meeting.max_rounds}")
        essential.append(f"ë‹¨ê³„: {stage}")
        essential.append("\nìµœê·¼ëŒ€í™”:")
        
        # ìµœê·¼ 6ê°œ ë©”ì‹œì§€ë¥¼ ì ì ˆí•œ ê¸¸ì´ë¡œ
        for msg in meeting.messages[-6:]:
            content = msg.content.split('.')[0][:50] + "..." if len(msg.content) > 50 else msg.content
            essential.append(f"{msg.persona_name}: {content}")
        
        full_context = "\n".join(essential)
        
        # ì—¬ì „íˆ ê¸¸ë©´ ë” ì¤„ì´ê¸°
        if len(full_context) > max_length:
            full_context = full_context[:max_length] + "..."
    
    return full_context

def stream_response(text: str, typing_speed: float = 0.1):
    """ìŠ¤íŠ¸ë¦¬ë° íƒ€ì´í•‘ íš¨ê³¼ - ì†ë„ ì¡°ì ˆ ê°€ëŠ¥"""
    import time
    words = text.split()
    for i, word in enumerate(words):
        if i == 0:
            yield word
        else:
            yield " " + word
        time.sleep(typing_speed)  # íƒ€ì´í•‘ ì†ë„ ì¡°ì ˆ (ì‚¬ìš©ì ì„¤ì •)

def display_message(message: Message, is_latest: bool = False):
    """ë©”ì‹œì§€ í‘œì‹œ"""
    avatar = "ğŸ¯" if message.is_moderator else "ğŸ­"
    if message.is_human_input:
        avatar = "ğŸ‘¤"
    
    with st.chat_message(
        "assistant" if not message.is_human_input else "human",
        avatar=avatar
    ):
        col1, col2 = st.columns([3, 1])
        with col1:
            st.write(f"**{message.persona_name}**")
            # ìµœì‹  ë©”ì‹œì§€ë§Œ íƒ€ì´í•‘ íš¨ê³¼ ì ìš©
            if is_latest and not message.is_human_input:
                # ì„¸ì…˜ ìƒíƒœì—ì„œ íƒ€ì´í•‘ ì†ë„ ê°€ì ¸ì˜¤ê¸°
                meeting = st.session_state.virtual_meeting
                st.write_stream(stream_response(message.content, meeting.typing_speed))
            else:
                st.write(message.content)
        with col2:
            st.caption(message.timestamp.strftime('%H:%M:%S'))
            if message.is_human_input:
                st.caption("ğŸ‘¤ ì¸ê°„ ê°œì…")

def should_moderator_intervene(meeting: VirtualMeeting) -> bool:
    """ì‚¬íšŒìê°€ ê°œì…í•´ì•¼ í•˜ëŠ” ìƒí™©ì¸ì§€ íŒë‹¨"""
    if not meeting.messages or meeting.conversation_round < 2:
        return False
    
    # ìµœê·¼ ì‚¬íšŒì ê°œì… í›„ ì¿¨ë‹¤ìš´ ì²´í¬ (ìµœì†Œ 5ê°œ ë©”ì‹œì§€ í›„ì— ë‹¤ì‹œ ê°œì… ê°€ëŠ¥)
    if meeting.last_moderator_intervention:
        messages_since_intervention = 0
        for msg in reversed(meeting.messages):
            if msg.timestamp <= meeting.last_moderator_intervention:
                break
            if not msg.is_moderator:  # ì‚¬íšŒìê°€ ì•„ë‹Œ ë©”ì‹œì§€ë§Œ ì¹´ìš´íŠ¸
                messages_since_intervention += 1
        
        if messages_since_intervention < 5:  # 5ê°œ ë©”ì‹œì§€ ë¯¸ë§Œì´ë©´ ê°œì…í•˜ì§€ ì•ŠìŒ
            return False
    
    # íŠ¹ì • ì¡°ê±´ì—ì„œ ì‚¬íšŒì ê°œì… í•„ìš”
    total_rounds = meeting.max_rounds
    current_round = meeting.conversation_round + 1
    round_percentage = current_round / total_rounds
    
    # ë‹¨ê³„ ì „í™˜ ì‹œì ì—ì„œ ì‚¬íšŒìê°€ ì •ë¦¬ (ë” ì—„ê²©í•œ ì¡°ê±´)
    stage_transitions = [0.2, 0.4, 0.6, 0.8]
    for transition in stage_transitions:
        if abs(round_percentage - transition) < 0.02:  # ì „í™˜ì ì„ ë” ì¢ê²Œ ì„¤ì • (5% -> 2%)
            # í•´ë‹¹ ë‹¨ê³„ì—ì„œ ì´ë¯¸ ê°œì…í–ˆëŠ”ì§€ ì²´í¬
            if meeting.last_moderator_intervention:
                last_intervention_round = meeting.conversation_round
                transition_round = int(total_rounds * transition)
                if abs(last_intervention_round - transition_round) <= 2:  # ì´ë¯¸ í•´ë‹¹ ë‹¨ê³„ì—ì„œ ê°œì…í–ˆìœ¼ë©´ ìŠ¤í‚µ
                    continue
            return True
    
    # ë§ˆì§€ë§‰ ë¼ìš´ë“œ ì „ì— ì‚¬íšŒìê°€ ë§ˆë¬´ë¦¬ ìœ ë„ (í•œ ë²ˆë§Œ)
    if current_round >= total_rounds - 2:
        # ë§ˆì§€ë§‰ ë‹¨ê³„ì—ì„œ ì•„ì§ ê°œì…í•˜ì§€ ì•Šì•˜ë‹¤ë©´ ê°œì…
        if not meeting.last_moderator_intervention:
            return True
        # ë§ˆì§€ë§‰ ê°œì…ì´ í˜„ì¬ ë¼ìš´ë“œë³´ë‹¤ 5ë¼ìš´ë“œ ì´ìƒ ì „ì´ë©´ ë‹¤ì‹œ ê°œì…
        messages_since_last_intervention = 0
        for msg in reversed(meeting.messages):
            if msg.timestamp <= meeting.last_moderator_intervention:
                break
            if not msg.is_moderator:
                messages_since_last_intervention += 1
        if messages_since_last_intervention >= 10:  # 10ê°œ ë©”ì‹œì§€ í›„ì— ë§ˆë¬´ë¦¬ ê°œì…
            return True
    
    return False

def generate_final_meeting_summary(meeting: VirtualMeeting, model_name: str = "gpt-4o-mini") -> str:
    """ì‚¬íšŒìê°€ íšŒì˜ ìµœì¢… ë§ˆë¬´ë¦¬ ë©”ì‹œì§€ ìƒì„±"""
    try:
        # ëª¨ë¸ì— ë”°ë¥¸ í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
        if model_name.startswith('claude'):
            anthropic_key = os.getenv('ANTHROPIC_API_KEY')
            if not anthropic_key or anthropic_key.strip() == '' or anthropic_key == 'NA':
                raise ValueError("Anthropic API í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.")
            client = anthropic.Anthropic(api_key=anthropic_key)
        else:
            openai_key = os.getenv('OPENAI_API_KEY')
            if not openai_key or openai_key.strip() == '' or openai_key == 'NA':
                raise ValueError("OpenAI API í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.")
            client = OpenAI(api_key=openai_key)
        
        # ì „ì²´ íšŒì˜ ë§¥ë½ ìƒì„±
        comprehensive_context = get_comprehensive_meeting_context(meeting)
        
        system_prompt = """ë‹¹ì‹ ì€ íšŒì˜ ì‚¬íšŒìì…ë‹ˆë‹¤. 
        
        ëª¨ë“  ì°¸ê°€ìê°€ ë§ˆì§€ë§‰ ë¼ìš´ë“œì—ì„œ ìµœì¢… ê²°ë¡ ì„ ë°œí‘œí–ˆìŠµë‹ˆë‹¤.
        ì´ì œ íšŒì˜ë¥¼ ê³µì‹ì ìœ¼ë¡œ ë§ˆë¬´ë¦¬í•  ì°¨ë¡€ì…ë‹ˆë‹¤.
        
        ë‹¤ìŒ ìš”ì†Œë“¤ì„ í¬í•¨í•˜ì—¬ íšŒì˜ë¥¼ ë§ˆë¬´ë¦¬í•˜ì„¸ìš”:
        1. ì˜¤ëŠ˜ íšŒì˜ì—ì„œ ë…¼ì˜ëœ ì£¼ìš” ë‚´ìš© ê°„ëµ ì •ë¦¬
        2. ì°¸ê°€ìë“¤ì´ ì œì‹œí•œ í•µì‹¬ ê²°ë¡ ë“¤ ìš”ì•½
        3. í•©ì˜ëœ ì‚¬í•­ì´ë‚˜ ê³µí†µëœ ì˜ê²¬ ê°•ì¡°
        4. í–¥í›„ ì‹¤í–‰í•´ì•¼ í•  ì•¡ì…˜ ì•„ì´í…œ ì •ë¦¬
        5. íšŒì˜ ì°¸ê°€ì— ëŒ€í•œ ê°ì‚¬ ì¸ì‚¬
        6. íšŒì˜ ê³µì‹ ì¢…ë£Œ ì„ ì–¸
        
        ë”°ëœ»í•˜ê³  ì „ë¬¸ì ì¸ í†¤ìœ¼ë¡œ 3-4ë¬¸ì¥ ì •ë„ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
        """
        
        user_message = f"""íšŒì˜ ì „ì²´ ë§¥ë½:
        {comprehensive_context}
        
        ì£¼ì œ: {meeting.meeting_topic}
        ì´ ë¼ìš´ë“œ: {meeting.max_rounds}
        
        ìœ„ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ íšŒì˜ë¥¼ ê³µì‹ì ìœ¼ë¡œ ë§ˆë¬´ë¦¬í•´ì£¼ì„¸ìš”."""
        
        if model_name.startswith('claude'):
            response = client.messages.create(
                model=model_name,
                max_tokens=300,
                temperature=0.7,
                system=system_prompt,
                messages=[{"role": "user", "content": user_message}]
            )
            return response.content[0].text.strip()
        else:
            response = client.chat.completions.create(
                model=model_name,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_message}
                ],
                max_tokens=300,
                temperature=0.7
            )
            return response.choices[0].message.content.strip()
    
    except Exception as e:
        return f"ğŸ ëª¨ë“  ì°¸ê°€ìë¶„ë“¤ì˜ í›Œë¥­í•œ ì˜ê²¬ ë°œí‘œë¡œ '{meeting.meeting_topic}' íšŒì˜ê°€ ì„±ê³µì ìœ¼ë¡œ ë§ˆë¬´ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì˜¤ëŠ˜ ë…¼ì˜ëœ ë‚´ìš©ë“¤ì„ ë°”íƒ•ìœ¼ë¡œ ì¢‹ì€ ê²°ê³¼ê°€ ìˆê¸°ë¥¼ ê¸°ëŒ€í•©ë‹ˆë‹¤. íšŒì˜ë¥¼ ê³µì‹ ì¢…ë£Œí•˜ê² ìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤."

def generate_moderator_intervention(meeting: VirtualMeeting, model_name: str = "gpt-4o-mini") -> str:
    """ì‚¬íšŒìì˜ ëŠ¥ë™ì  ê°œì… ë©”ì‹œì§€ ìƒì„±"""
    try:
        # ëª¨ë¸ì— ë”°ë¥¸ í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
        if model_name.startswith('claude'):
            anthropic_key = os.getenv('ANTHROPIC_API_KEY')
            if not anthropic_key or anthropic_key.strip() == '' or anthropic_key == 'NA':
                return "ì§€ê¸ˆê¹Œì§€ì˜ ë…¼ì˜ë¥¼ ì •ë¦¬í•´ë³´ê² ìŠµë‹ˆë‹¤."
            client = anthropic.Anthropic(api_key=anthropic_key)
        else:
            openai_key = os.getenv('OPENAI_API_KEY')
            if not openai_key or openai_key.strip() == '' or openai_key == 'NA':
                return "ì§€ê¸ˆê¹Œì§€ì˜ ë…¼ì˜ë¥¼ ì •ë¦¬í•´ë³´ê² ìŠµë‹ˆë‹¤."
            client = OpenAI(api_key=openai_key)
        
        # í˜„ì¬ ìƒí™© ë¶„ì„
        total_rounds = meeting.max_rounds
        current_round = meeting.conversation_round + 1
        round_percentage = current_round / total_rounds
        
        # ë‹¨ê³„ë³„ ì‚¬íšŒì ì—­í•  ì •ì˜
        if round_percentage <= 0.2:
            stage_role = "ë¬¸ì œ ì •ì˜ ë‹¨ê³„ë¥¼ ì •ë¦¬í•˜ê³  ë‹¤ìŒ ë‹¨ê³„ë¡œ ì•ˆë‚´"
        elif round_percentage <= 0.4:
            stage_role = "ë‹¤ì–‘í•œ ê´€ì ë“¤ì„ ì •ë¦¬í•˜ê³  í•´ê²°ì±… ëª¨ìƒ‰ ë‹¨ê³„ë¡œ ì „í™˜"
        elif round_percentage <= 0.6:
            stage_role = "ì œì‹œëœ í•´ê²°ì±…ë“¤ì„ ì •ë¦¬í•˜ê³  ë¹„êµ ë¶„ì„ ë‹¨ê³„ë¡œ ì•ˆë‚´"
        elif round_percentage <= 0.8:
            stage_role = "ë…¼ì˜ëœ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ í•©ì˜ì  ë„ì¶œ ìœ ë„"
        else:
            stage_role = "ì „ì²´ íšŒì˜ ë‚´ìš©ì„ ì¢…í•©í•˜ê³  ìµœì¢… ê²°ë¡  ë„ì¶œ"
        
        # ìµœê·¼ ëŒ€í™” ìš”ì•½
        recent_messages = meeting.messages[-6:] if len(meeting.messages) > 6 else meeting.messages
        recent_summary = "\n".join([f"{msg.persona_name}: {msg.content[:100]}..." for msg in recent_messages])
        
        # ê°œì… íšŸìˆ˜ì— ë”°ë¥¸ ë‹¤ì–‘í•œ ì ‘ê·¼ ë°©ì‹
        moderator_messages = [msg for msg in meeting.messages if msg.is_moderator and not msg.is_human_input]
        intervention_count = len(moderator_messages)
        
        if intervention_count % 3 == 0:
            approach = "ì°¸ê°€ìë“¤ì˜ ì˜ê²¬ì„ ìš”ì•½í•˜ê³  ë‹¤ìŒ ë‹¨ê³„ ë°©í–¥ì„ ì œì‹œí•˜ëŠ”"
        elif intervention_count % 3 == 1:
            approach = "êµ¬ì²´ì ì¸ ì§ˆë¬¸ì„ í†µí•´ ë…¼ì˜ë¥¼ ì‹¬í™”ì‹œí‚¤ëŠ”"
        else:
            approach = "ë‹¤ë¥¸ ê´€ì ì—ì„œ ë¬¸ì œë¥¼ ë°”ë¼ë³´ë„ë¡ ìœ ë„í•˜ëŠ”"
        
        system_prompt = f"""ë‹¹ì‹ ì€ ì „ë¬¸ì ì¸ íšŒì˜ ì‚¬íšŒìì…ë‹ˆë‹¤. 
        í˜„ì¬ ìƒí™©:
        - íšŒì˜ ì£¼ì œ: {meeting.meeting_topic}
        - í˜„ì¬ ë¼ìš´ë“œ: {current_round}/{total_rounds} ({round_percentage*100:.1f}% ì§„í–‰)
        - í˜„ì¬ ë‹¨ê³„: {stage_role}
        - ì ‘ê·¼ ë°©ì‹: {approach}
        
        ë‹¤ìŒ ì—­í• ì„ ìˆ˜í–‰í•˜ì„¸ìš”:
        1. {approach} ë°©ì‹ìœ¼ë¡œ ê°œì…
        2. ì´ì „ ë°œì–¸ê³¼ëŠ” ë‹¤ë¥¸ ê´€ì ì´ë‚˜ í‘œí˜„ ì‚¬ìš©
        3. ì°¸ê°€ìë“¤ì—ê²Œ êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ë°©í–¥ ì œì‹œ
        
        ì¤‘ìš”: ì´ì „ ì‚¬íšŒì ë°œì–¸ê³¼ ì¤‘ë³µë˜ì§€ ì•Šë„ë¡ ìƒˆë¡œìš´ ê´€ì ì´ë‚˜ êµ¬ì²´ì ì¸ ì§ˆë¬¸ì„ í¬í•¨í•˜ì—¬ 2-3ë¬¸ì¥ìœ¼ë¡œ ë°œì–¸í•˜ì„¸ìš”.
        ì˜ˆì‹œ ì ‘ê·¼:
        - "êµ¬ì²´ì ìœ¼ë¡œ ì–´ë–¤ ë¶€ë¶„ì—ì„œ..." 
        - "ë‹¤ë¥¸ ê´€ì ì—ì„œ ë³´ë©´..."
        - "ì‹¤ì œ êµ¬í˜„ ì‹œ ê³ ë ¤í•´ì•¼ í• ..."
        - "ìš°ì„ ìˆœìœ„ë¥¼ ì •í•œë‹¤ë©´..." ë“±"""
        
        user_message = f"ìµœê·¼ ëŒ€í™” ë‚´ìš©:\n{recent_summary}\n\nìœ„ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì‚¬íšŒìë¡œì„œ ì ì ˆí•œ ê°œì… ë°œì–¸ì„ í•´ì£¼ì„¸ìš”."
        
        if model_name.startswith('claude'):
            response = client.messages.create(
                model=model_name,
                max_tokens=300,
                temperature=0.7,
                system=system_prompt,
                messages=[{"role": "user", "content": user_message}]
            )
            return response.content[0].text.strip()
        else:
            response = client.chat.completions.create(
                model=model_name,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_message}
                ],
                max_tokens=300,
                temperature=0.7
            )
            return response.choices[0].message.content.strip()
            
    except Exception as e:
        # ê¸°ë³¸ ë©”ì‹œì§€ ë°˜í™˜
        total_rounds = meeting.max_rounds
        current_round = meeting.conversation_round + 1
        return f"ì§€ê¸ˆê¹Œì§€ ì¢‹ì€ ì˜ê²¬ë“¤ì´ ë§ì´ ë‚˜ì™”ìŠµë‹ˆë‹¤. í˜„ì¬ {current_round}/{total_rounds} ë¼ìš´ë“œê°€ ì§„í–‰ë˜ê³  ìˆìœ¼ë‹ˆ, ë…¼ì˜ë¥¼ ë”ìš± ë°œì „ì‹œì¼œ ë‚˜ê°€ê² ìŠµë‹ˆë‹¤."

def run_conversation_round(meeting: VirtualMeeting) -> bool:
    """ğŸ¯ ëŒ€í™” ì²´ì¸ ì‹œìŠ¤í…œ - í•œ ë²ˆì— í•œ ë°œì–¸ìë§Œ ì²˜ë¦¬"""
    if not meeting.should_continue():
        return False
    
    # í˜„ì¬ ë°œì–¸ì ê°€ì ¸ì˜¤ê¸°
    current_persona = meeting.get_next_speaker()
    if not current_persona:
        return False
    
    # ğŸ¯ ëŒ€í™” íë¦„ ë¶„ì„ ë° ë°©í–¥ ì œì‹œ
    meeting.analyze_conversation_flow()
    conversation_direction = meeting.get_conversation_direction()
    
    # ëª¨ë¸ ì„ íƒ
    selected_model = st.session_state.get('selected_ai_model', 'gpt-4o-mini')
    
    # ê¸°ë³¸ ëŒ€í™” íˆìŠ¤í† ë¦¬
    conversation_history = format_conversation_history(meeting.messages, last_n=10)
    
    # ì¢…í•© ë§¥ë½ ìƒì„±
    comprehensive_context = get_comprehensive_meeting_context(meeting)
    
    # ğŸ¯ AI ì‘ë‹µ ìƒì„± (ëŒ€í™” ì²´ì¸ ì‹œìŠ¤í…œ ì ìš©)
    response = generate_ai_response(
        current_persona,
        conversation_history,
        meeting.meeting_topic,
        meeting.uploaded_files_content,
        meeting.conversation_round + 1,  # ë‹¤ìŒ ë¼ìš´ë“œ ë²ˆí˜¸
        enhanced_context=comprehensive_context,
        model_name=selected_model,
        total_rounds=meeting.max_rounds,
        conversation_direction=conversation_direction  # ğŸ¯ ëŒ€í™” ë°©í–¥ ê°€ì´ë“œ ì¶”ê°€
    )
    
    # ë©”ì‹œì§€ ì¶”ê°€
    meeting.add_message(current_persona.id, response)
    
    # ğŸ¯ ë°œì–¸ì ìˆœì„œë§Œ ì§„í–‰ (ë¼ìš´ë“œëŠ” ì ˆëŒ€ ìë™ ì¦ê°€í•˜ì§€ ì•ŠìŒ)
    meeting.advance_speaker()
    
    return True

def preset_personas() -> List[Dict]:
    """ë¯¸ë¦¬ ì„¤ì •ëœ í˜ë¥´ì†Œë‚˜ ëª©ë¡"""
    return [
        {
            "name": "ì „ëµê¸°íšì ì´ì „ëµ",
            "role": "ì „ëµê¸°íšíŒ€ì¥",
            "personality": "ë¶„ì„ì ì´ê³  ì²´ê³„ì ì¸ ì‚¬ê³ ë¥¼ í•˜ëŠ” ì„±ê²©",
            "expertise": "ì „ëµ ìˆ˜ë¦½, ì‚¬ì—… ë¶„ì„, ì‹œì¥ ì¡°ì‚¬",
            "speaking_style": "ë…¼ë¦¬ì ì´ê³  ì²´ê³„ì ì¸ ì„¤ëª…ì„ í•˜ëŠ” ë§íˆ¬"
        },
        {
            "name": "ë””ìì´ë„ˆ ë°•ì°½ì˜",
            "role": "UX/UI ë””ìì´ë„ˆ",
            "personality": "ì°½ì˜ì ì´ê³  ì‚¬ìš©ì ì¤‘ì‹¬ì  ì‚¬ê³ ë¥¼ í•˜ëŠ” ì„±ê²©",
            "expertise": "ì‚¬ìš©ì ê²½í—˜, ì¸í„°í˜ì´ìŠ¤ ë””ìì¸, ë””ìì¸ ì‹œìŠ¤í…œ",
            "speaking_style": "ê°ì„±ì ì´ê³  ì§ê´€ì ì¸ í‘œí˜„ì„ ì‚¬ìš©í•˜ëŠ” ë§íˆ¬"
        },
        {
            "name": "ê°œë°œì ê¹€ì½”ë”©",
            "role": "ì‹œë‹ˆì–´ ê°œë°œì",
            "personality": "ë…¼ë¦¬ì ì´ê³  ë¬¸ì œ í•´ê²° ì§€í–¥ì ì¸ ì„±ê²©",
            "expertise": "ì†Œí”„íŠ¸ì›¨ì–´ ê°œë°œ, ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜, ê¸°ìˆ  ìµœì í™”",
            "speaking_style": "ê°„ê²°í•˜ê³  ê¸°ìˆ ì ì¸ ìš©ì–´ë¥¼ ì‚¬ìš©í•˜ëŠ” ë§íˆ¬"
        },
        {
            "name": "ì˜ì—…íŒ€ì¥ ìµœì„¸ì¼ì¦ˆ",
            "role": "ì˜ì—…íŒ€ì¥",
            "personality": "ì ê·¹ì ì´ê³  ëª©í‘œ ì§€í–¥ì ì¸ ì„±ê²©",
            "expertise": "ê³ ê° ê´€ë¦¬, ì˜ì—… ì „ëµ, í˜‘ìƒ",
            "speaking_style": "ì—´ì •ì ì´ê³  ì„¤ë“ë ¥ ìˆëŠ” ë§íˆ¬"
        },
        {
            "name": "ì¬ë¬´ë‹´ë‹¹ì ì •ìºì‹œ",
            "role": "ì¬ë¬´íŒ€ì¥",
            "personality": "ì‹ ì¤‘í•˜ê³  ì •í™•ì„±ì„ ì¤‘ì‹œí•˜ëŠ” ì„±ê²©",
            "expertise": "ì¬ë¬´ ë¶„ì„, ì˜ˆì‚° ê´€ë¦¬, íˆ¬ì í‰ê°€",
            "speaking_style": "ì •í™•í•œ ìˆ˜ì¹˜ì™€ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ì‹ ì¤‘í•œ ë§íˆ¬"
        }
    ]

def main():
    
    
    # ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
    initialize_session_state()
    meeting = st.session_state.virtual_meeting
    
    # ì‚¬ì´ë“œë°” - íšŒì˜ ì„¤ì •
    with st.sidebar:
        st.header("ğŸ¯ íšŒì˜ ì„¤ì •")
        
        # AI ëª¨ë¸ ì„ íƒ (ë…ì„œí† ë¡ ê³¼ ë™ì¼í•œ ë°©ì‹)
        st.subheader("ğŸ¤– AI ëª¨ë¸ ì„¤ì •")
        
        # ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ ëª©ë¡ ìƒì„±
        available_models = []
        has_anthropic_key = os.environ.get('ANTHROPIC_API_KEY') is not None
        if has_anthropic_key:
            available_models.extend([
                'claude-3-5-sonnet-latest',
                'claude-3-5-haiku-latest',
            ])
        has_openai_key = os.environ.get('OPENAI_API_KEY') is not None
        if has_openai_key:
            available_models.extend(['gpt-4o', 'gpt-4o-mini'])
        
        # ëª¨ë¸ì´ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì¶”ê°€
        if not available_models:
            available_models = ['gpt-4o-mini']
        
        # í˜„ì¬ ì„ íƒëœ ëª¨ë¸ì´ ì‚¬ìš© ê°€ëŠ¥í•œ ëª©ë¡ì— ìˆëŠ”ì§€ í™•ì¸
        current_model = st.session_state.get('selected_ai_model', 'gpt-4o-mini')
        if current_model not in available_models and available_models:
            current_model = available_models[0]
            st.session_state.selected_ai_model = current_model
        
        # ëª¨ë¸ ì„ íƒ UI
        selected_model = st.selectbox(
            'ğŸ§  AI ëª¨ë¸ ì„ íƒ',
            options=available_models,
            index=available_models.index(current_model) if current_model in available_models else 0,
            help='Claude(Anthropic)ëŠ” ANTHROPIC_API_KEY, OpenAIëŠ” OPENAI_API_KEY í•„ìš”'
        )
        
        # ëª¨ë¸ì´ ì‹¤ì œë¡œ ë³€ê²½ëœ ê²½ìš°ì—ë§Œ ì„¸ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
        if selected_model != st.session_state.get('selected_ai_model'):
            st.session_state.selected_ai_model = selected_model
        
        # ì„ íƒëœ ëª¨ë¸ ì •ë³´ í‘œì‹œ
        if selected_model.startswith('claude'):
            st.info("ğŸ§  **Claude ëª¨ë¸ ì‚¬ìš© ì¤‘**\n- ê³ í’ˆì§ˆ ëŒ€í™” ìƒì„±\n- ê¸´ ë§¥ë½ ì´í•´ ìš°ìˆ˜")
        else:
            st.info("ğŸ§  **OpenAI ëª¨ë¸ ì‚¬ìš© ì¤‘**\n- ë¹ ë¥¸ ì‘ë‹µ ì†ë„\n- ì•ˆì •ì ì¸ ì„±ëŠ¥")
        
        st.divider()
        
        # íšŒì˜ ì£¼ì œ
        meeting.meeting_topic = st.text_area(
            "íšŒì˜ ì£¼ì œ",
            value=meeting.meeting_topic,
            help="í† ë¡ í•  ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”",
            placeholder="ì˜ˆ: ì‹ ì œí’ˆ ì¶œì‹œ ì „ëµ ìˆ˜ë¦½"
        )
        
        # íšŒì˜ ì‹œê°„ ì„¤ì •
        meeting.meeting_duration = st.slider(
            "íšŒì˜ ì‹œê°„ (ë¶„)",
            min_value=5,
            max_value=120,
            value=meeting.meeting_duration
        )
        
        # ìµœëŒ€ ë¼ìš´ë“œ ì„¤ì •
        new_max_rounds = st.slider(
            "ìµœëŒ€ ëŒ€í™” ë¼ìš´ë“œ",
            min_value=3,
            max_value=100,
            value=meeting.max_rounds,
            help="ğŸ”’ ì´ ê°’ì€ ì ˆëŒ€ ìë™ìœ¼ë¡œ ë³€ê²½ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤! ë¼ìš´ë“œëŠ” ìë™ìœ¼ë¡œ ì§„í–‰ë˜ì§€ë§Œ, ì„¤ì •í•œ ìµœëŒ€ê°’ì€ ê³ ì •ë©ë‹ˆë‹¤."
        )
        
        # ğŸ”§ ì›ë³¸ ìµœëŒ€ ë¼ìš´ë“œ ì¶”ì  (ì‚¬ìš©ìê°€ ì§ì ‘ ë³€ê²½í•  ë•Œë§Œ)
        if new_max_rounds != meeting.max_rounds:
            meeting.max_rounds = new_max_rounds
            meeting.original_max_rounds = new_max_rounds  # ì‚¬ìš©ìê°€ ì§ì ‘ ì„¤ì •í•œ ì›ë³¸ ê°’ ì €ì¥
            meeting.extension_granted = False  # ì—°ì¥ ì—¬ë¶€ ì´ˆê¸°í™”
            st.success(f"âœ… ìµœëŒ€ ë¼ìš´ë“œê°€ {new_max_rounds}ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!")
        
        # ë°œì–¸ ì†ë„ ì„¤ì •
        meeting.speaking_speed = st.slider(
            "ë°œì–¸ ê°„ê²© (ì´ˆ)",
            min_value=1,
            max_value=10,
            value=meeting.speaking_speed,
            help="ìë™ ëª¨ë“œì—ì„œ ë°œì–¸ ê°„ê²©ì„ ì¡°ì ˆí•©ë‹ˆë‹¤"
        )
        
        # íƒ€ì´í•‘ ì†ë„ ì„¤ì • (ìƒˆë¡œ ì¶”ê°€)
        st.subheader("âŒ¨ï¸ í™”ë©´ í‘œì‹œ ì„¤ì •")
        
        # íƒ€ì´í•‘ ì†ë„ ì˜µì…˜
        typing_options = {
            "ë§¤ìš° ë¹ ë¦„ (0.02ì´ˆ)": 0.02,
            "ë¹ ë¦„ (0.05ì´ˆ)": 0.05,
            "ë³´í†µ (0.1ì´ˆ)": 0.1,
            "ëŠë¦¼ (0.15ì´ˆ)": 0.15,
            "ë§¤ìš° ëŠë¦¼ (0.25ì´ˆ)": 0.25,
            "ì»¤ìŠ¤í…€": "custom"
        }
        
        # í˜„ì¬ ì„¤ì •ëœ ê°’ì— ë§ëŠ” ì˜µì…˜ ì°¾ê¸°
        current_option = "ë³´í†µ (0.1ì´ˆ)"  # ê¸°ë³¸ê°’
        for option, value in typing_options.items():
            if value == meeting.typing_speed:
                current_option = option
                break
        
        selected_option = st.selectbox(
            "ğŸ’¬ í…ìŠ¤íŠ¸ íƒ€ì´í•‘ ì†ë„",
            options=list(typing_options.keys()),
            index=list(typing_options.keys()).index(current_option),
            help="AI ë°œì–¸ì´ í™”ë©´ì— íƒ€ì´í•‘ë˜ì–´ ë‚˜ì˜¤ëŠ” ì†ë„ë¥¼ ì¡°ì ˆí•©ë‹ˆë‹¤"
        )
        
        if typing_options[selected_option] == "custom":
            meeting.typing_speed = st.slider(
                "ì»¤ìŠ¤í…€ íƒ€ì´í•‘ ì†ë„ (ì´ˆ/ë‹¨ì–´)",
                min_value=0.01,
                max_value=0.5,
                value=meeting.typing_speed,
                step=0.01,
                help="ìˆ«ìê°€ ë‚®ì„ìˆ˜ë¡ ë¹ ë¥´ê²Œ íƒ€ì´í•‘ë©ë‹ˆë‹¤"
            )
        else:
            meeting.typing_speed = typing_options[selected_option]
        
        # íƒ€ì´í•‘ ì†ë„ ë¯¸ë¦¬ë³´ê¸°
        with st.expander("âš¡ íƒ€ì´í•‘ ì†ë„ ë¯¸ë¦¬ë³´ê¸°", expanded=False):
            if st.button("ğŸ¬ í…ŒìŠ¤íŠ¸ í•´ë³´ê¸°"):
                sample_text = "ì•ˆë…•í•˜ì„¸ìš”! ì´ê²ƒì€ íƒ€ì´í•‘ ì†ë„ í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤. í˜„ì¬ ì„¤ì •ëœ ì†ë„ë¡œ í…ìŠ¤íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤."
                st.write("**ìƒ˜í”Œ í…ìŠ¤íŠ¸:**")
                st.write_stream(stream_response(sample_text, meeting.typing_speed))
                st.caption(f"í˜„ì¬ ì„¤ì •: {meeting.typing_speed}ì´ˆ/ë‹¨ì–´")
        
        st.divider()
        
        # íŒŒì¼ ì—…ë¡œë“œ
        st.header("ğŸ“ ì°¸ê³  ìë£Œ ì—…ë¡œë“œ")
        uploaded_files = st.file_uploader(
            "íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”",
            type=['txt','md','pdf', 'docx', 'csv'],
            accept_multiple_files=True,
            help="í˜ë¥´ì†Œë‚˜ë“¤ì´ ì°¸ê³ í•  ìë£Œë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”"
        )
        
        if uploaded_files:
            if st.button("ğŸ“„ íŒŒì¼ ì²˜ë¦¬"):
                with st.spinner("íŒŒì¼ì„ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤..."):
                    combined_content = ""
                    for file in uploaded_files:
                        content = extract_text_from_file(file)
                        combined_content += f"\n--- {file.name} ---\n{content}\n"
                    
                    meeting.uploaded_files_content = combined_content
                    st.success(f"âœ… {len(uploaded_files)}ê°œ íŒŒì¼ì´ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤!")
            
            # íŒŒì¼ì´ ì²˜ë¦¬ëœ ê²½ìš° ë¶„ì„ ê²°ê³¼ í‘œì‹œ
            if meeting.uploaded_files_content:
                st.subheader("ğŸ“– íŒŒì¼ ë¶„ì„ ê²°ê³¼")
                
                # íŒŒì¼ ë¶„ì„ ì‹¤í–‰
                analysis = meeting.analyze_uploaded_files()
                
                # ë¶„ì„ ì •ë³´ í‘œì‹œ
                col1, col2, col3 = st.columns(3)
                with col1:
                    st.metric("ğŸ“„ ì´ ê¸¸ì´", f"{analysis.get('total_length', 0):,}ì")
                with col2:
                    st.metric("ğŸ“ ë‹¨ì–´ ìˆ˜", f"{analysis.get('word_count', 0):,}ê°œ")
                with col3:
                    st.metric("ğŸ”‘ í‚¤ì›Œë“œ", f"{len(analysis.get('keywords', [])):,}ê°œ")
                
                # í•µì‹¬ í‚¤ì›Œë“œ í‘œì‹œ
                if analysis.get('keywords'):
                    st.write("**ğŸ”‘ í•µì‹¬ í‚¤ì›Œë“œ:**")
                    keyword_display = ", ".join(analysis['keywords'][:15])
                    st.info(keyword_display)
                
                # íšŒì˜ ì£¼ì œì™€ì˜ ì—°ê´€ì„± í‘œì‹œ
                if meeting.meeting_topic:
                    topic_keywords = meeting.meeting_topic.replace(',', ' ').replace('.', ' ').split()
                    topic_keywords = [k.strip().lower() for k in topic_keywords if len(k.strip()) >= 2]
                    file_keywords = [k.lower() for k in analysis.get('keywords', [])]
                    
                    matching_keywords = [k for k in topic_keywords if k in file_keywords]
                    if matching_keywords:
                        st.success(f"âœ… íšŒì˜ ì£¼ì œì™€ ë§¤ì¹­ë˜ëŠ” í‚¤ì›Œë“œ: {', '.join(matching_keywords)}")
                    else:
                        st.warning("âš ï¸ íšŒì˜ ì£¼ì œì™€ ì§ì ‘ì ìœ¼ë¡œ ë§¤ì¹­ë˜ëŠ” í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤.")
                
                # íŒŒì¼ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸° (í† ê¸€)
                with st.expander("ğŸ“‹ íŒŒì¼ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°", expanded=False):
                    st.text_area(
                        "ì²˜ë¦¬ëœ ë‚´ìš©",
                        value=analysis.get('summary', meeting.uploaded_files_content[:500]),
                        height=150,
                        disabled=True,
                        key="file_preview"
                    )
                
                # RAG í™œìš© ë¯¸ë¦¬ë³´ê¸°
                if meeting.meeting_topic:
                    with st.expander("ğŸ” AIê°€ í™œìš©í•  ê´€ë ¨ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°", expanded=False):
                        relevant_content = meeting.get_relevant_file_content(topic_keywords)
                        if relevant_content:
                            st.text_area(
                                "íšŒì˜ ì£¼ì œì™€ ê´€ë ¨ëœ íŒŒì¼ ë‚´ìš©",
                                value=relevant_content,
                                height=200,
                                disabled=True,
                                help="ì´ ë‚´ìš©ì´ AI ì‘ë‹µ ìƒì„± ì‹œ ìš°ì„ ì ìœ¼ë¡œ ì°¸ê³ ë©ë‹ˆë‹¤"
                            )
                        else:
                            st.info("íšŒì˜ ì£¼ì œì™€ ê´€ë ¨ëœ íŠ¹ì • ë‚´ìš©ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì „ì²´ ìš”ì•½ì´ ì‚¬ìš©ë©ë‹ˆë‹¤.")
        
        st.divider()
        
        # íšŒì˜ ì œì–´
        st.header("ğŸ® íšŒì˜ ì œì–´")
        
        if not meeting.is_active:
            if st.button("ğŸš€ íšŒì˜ ì‹œì‘", type="primary"):
                if meeting.meeting_topic and len(meeting.personas) > 1:
                    meeting.is_active = True
                    meeting.start_time = datetime.now()
                    meeting.conversation_round = 0
                    meeting.current_speaker_index = 0
                    
                    # ì‚¬íšŒì ì¸ì‚¬ë§ ì¶”ê°€
                    moderator = meeting.get_moderator()
                    if moderator:
                        opening_message = f"ì•ˆë…•í•˜ì„¸ìš”, ì˜¤ëŠ˜ '{meeting.meeting_topic}'ì— ëŒ€í•´ ë…¼ì˜í•˜ê² ìŠµë‹ˆë‹¤. ëª¨ë“  ì°¸ê°€ìë“¤ì˜ í™œë°œí•œ ì°¸ì—¬ë¥¼ ë¶€íƒë“œë¦½ë‹ˆë‹¤."
                        meeting.add_message(moderator.id, opening_message)
                    
                    st.success("âœ… íšŒì˜ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!")
                    st.rerun()
                else:
                    st.error("âš ï¸ íšŒì˜ ì£¼ì œì™€ ìµœì†Œ 2ëª…ì˜ í˜ë¥´ì†Œë‚˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.")
        else:
            # íšŒì˜ ì§„í–‰ ìƒíƒœ í‘œì‹œ
            if meeting.start_time:
                elapsed = datetime.now() - meeting.start_time
                remaining = meeting.meeting_duration * 60 - elapsed.seconds
                st.info(f"â° ê²½ê³¼: {elapsed.seconds//60}ë¶„ | ë‚¨ì€ì‹œê°„: {max(0, remaining//60)}ë¶„")
            
            col1, col2 = st.columns(2)
            with col1:
                if st.button("â¸ï¸ íšŒì˜ ì¤‘ë‹¨"):
                    meeting.is_active = False
                    st.success("â¸ï¸ íšŒì˜ê°€ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.")
                    st.rerun()
            with col2:
                if st.button("ğŸ”„ íšŒì˜ ì¬ì‹œì‘"):
                    meeting.is_active = True
                    st.success("â–¶ï¸ íšŒì˜ê°€ ì¬ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.")
                    st.rerun()
            
            # ìë™ ëª¨ë“œ í† ê¸€
            meeting.auto_mode = st.toggle("ğŸ¤– ìë™ ì§„í–‰ ëª¨ë“œ", value=meeting.auto_mode)
            if meeting.auto_mode:
                st.success("ğŸš€ ìë™ ëª¨ë“œ í™œì„±í™”! ì •í•´ì§„ ë¼ìš´ë“œê¹Œì§€ ì™„ì „ ìë™ìœ¼ë¡œ ì§„í–‰ë©ë‹ˆë‹¤.")
                st.info("ğŸ’¡ í™”ë©´ì„ ë³´ê³  ìˆì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤. ìë™ìœ¼ë¡œ ì™„ë£Œë˜ë©´ ì•Œë¦¼ì´ í‘œì‹œë©ë‹ˆë‹¤.")
        
        # íšŒì˜ ì¢…ë£Œ ì¡°ê±´
        if meeting.is_active:
            st.divider()
            st.header("ğŸ“Š ì§„í–‰ ìƒí™©")
            progress = min(meeting.conversation_round / meeting.max_rounds, 1.0)
            st.progress(progress, text=f"ë¼ìš´ë“œ ì§„í–‰: {meeting.conversation_round}/{meeting.max_rounds}")
    
    # ë©”ì¸ ì˜ì—­
    tab1, tab2, tab3, tab4 = st.tabs(["ğŸ‘¥ í˜ë¥´ì†Œë‚˜ ê´€ë¦¬", "ğŸ’¬ ì‹¤ì‹œê°„ íšŒì˜", "ğŸ“Š íšŒì˜ í˜„í™©", "ğŸ“ íšŒì˜ë¡"])
    
    with tab1:
        st.header("ğŸ‘¥ í˜ë¥´ì†Œë‚˜ ê´€ë¦¬")
        
        # í”„ë¦¬ì…‹ í˜ë¥´ì†Œë‚˜ ì¶”ê°€
        st.subheader("ğŸ¯ í”„ë¦¬ì…‹ í˜ë¥´ì†Œë‚˜")
        preset_options = preset_personas()
        
        col1, col2 = st.columns([3, 1])
        with col1:
            selected_preset = st.selectbox(
                "í”„ë¦¬ì…‹ ì„ íƒ",
                options=range(len(preset_options)),
                format_func=lambda x: f"{preset_options[x]['name']} ({preset_options[x]['role']})",
                index=None,
                placeholder="í”„ë¦¬ì…‹ì„ ì„ íƒí•˜ì„¸ìš”"
            )
        with col2:
            if selected_preset is not None and st.button("â• í”„ë¦¬ì…‹ ì¶”ê°€"):
                preset = preset_options[selected_preset]
                new_persona = Persona(
                    id=str(uuid.uuid4()),
                    name=preset['name'],
                    role=preset['role'],
                    prompt="",  # ìë™ ìƒì„±ë¨
                    personality=preset['personality'],
                    expertise=preset['expertise'],
                    speaking_style=preset['speaking_style']
                )
                
                if meeting.add_persona(new_persona):
                    st.success(f"âœ… {preset['name']} í˜ë¥´ì†Œë‚˜ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!")
                    st.rerun()
                else:
                    st.error("âŒ ìµœëŒ€ 10ê°œì˜ í˜ë¥´ì†Œë‚˜ë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
        
        st.divider()
        
        # ì»¤ìŠ¤í…€ í˜ë¥´ì†Œë‚˜ ì¶”ê°€
        with st.expander("â• ì»¤ìŠ¤í…€ í˜ë¥´ì†Œë‚˜ ì¶”ê°€", expanded=False):
            with st.form("add_persona"):
                col1, col2 = st.columns(2)
                with col1:
                    name = st.text_input("ì´ë¦„", placeholder="ì˜ˆ: ê¹€ì „ë¬¸")
                    role = st.text_input("ì—­í• ", placeholder="ì˜ˆ: ë§ˆì¼€íŒ… ë‹´ë‹¹ì")
                    expertise = st.text_input("ì „ë¬¸ ë¶„ì•¼", placeholder="ì˜ˆ: ë””ì§€í„¸ ë§ˆì¼€íŒ…, SNS ì „ëµ")
                with col2:
                    personality = st.text_area("ì„±ê²©/íŠ¹ì„±", placeholder="ì˜ˆ: ì°½ì˜ì ì´ê³  ë„ì „ì ì¸ ì„±ê²©")
                    speaking_style = st.text_input("ë§í•˜ëŠ” ìŠ¤íƒ€ì¼", placeholder="ì˜ˆ: ì—´ì •ì ì´ê³  êµ¬ì²´ì ì¸ ë§íˆ¬")
                
                prompt = st.text_area(
                    "ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ (ì„ íƒì‚¬í•­)",
                    help="ë¹„ì›Œë‘ë©´ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤",
                    placeholder="ì´ í˜ë¥´ì†Œë‚˜ì˜ íŠ¹ë³„í•œ í–‰ë™ íŒ¨í„´ì´ë‚˜ ì „ë¬¸ì„±ì„ ì •ì˜í•˜ëŠ” í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                )
                
                if st.form_submit_button("í˜ë¥´ì†Œë‚˜ ì¶”ê°€", type="primary"):
                    if name and role:
                        new_persona = Persona(
                            id=str(uuid.uuid4()),
                            name=name,
                            role=role,
                            prompt=prompt,
                            personality=personality,
                            expertise=expertise,
                            speaking_style=speaking_style
                        )
                        
                        if meeting.add_persona(new_persona):
                            st.success(f"âœ… {name} í˜ë¥´ì†Œë‚˜ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!")
                            st.rerun()
                        else:
                            st.error("âŒ ìµœëŒ€ 10ê°œì˜ í˜ë¥´ì†Œë‚˜ë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
                    else:
                        st.error("âš ï¸ ì´ë¦„ê³¼ ì—­í• ì€ í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.")
        
        # ê¸°ì¡´ í˜ë¥´ì†Œë‚˜ ëª©ë¡
        st.subheader("í˜„ì¬ í˜ë¥´ì†Œë‚˜ ëª©ë¡")
        for i, persona in enumerate(meeting.personas):
            icon = "ğŸ¯" if persona.is_moderator else "ğŸ­"
            
            with st.expander(f"{icon} {persona.name} ({persona.role})"):
                col1, col2 = st.columns([3, 1])
                
                with col1:
                    st.write(f"**ì „ë¬¸ ë¶„ì•¼:** {persona.expertise}")
                    st.write(f"**ì„±ê²©:** {persona.personality}")
                    st.write(f"**ë§í•˜ëŠ” ìŠ¤íƒ€ì¼:** {persona.speaking_style}")
                    
                    # í”„ë¡¬í”„íŠ¸ í‘œì‹œ (expander ëŒ€ì‹  toggle ì‚¬ìš©)
                    show_prompt = st.toggle(
                        "ğŸ¤– AI í”„ë¡¬í”„íŠ¸ ë³´ê¸°", 
                        key=f"show_prompt_{persona.id}_{i}"  # ì¸ë±ìŠ¤ ì¶”ê°€ë¡œ ê³ ìœ ì„± ë³´ì¥
                    )
                    if show_prompt:
                        st.text_area(
                            "í”„ë¡¬í”„íŠ¸",
                            value=persona.prompt,
                            height=100,
                            disabled=True,
                            key=f"prompt_view_{persona.id}_{i}"  # ì¸ë±ìŠ¤ ì¶”ê°€ë¡œ ê³ ìœ ì„± ë³´ì¥
                        )
                
                with col2:
                    if not persona.is_moderator:
                        if st.button("ğŸ—‘ï¸ ì‚­ì œ", key=f"delete_{persona.id}"):
                            meeting.remove_persona(persona.id)
                            st.success(f"âœ… {persona.name} í˜ë¥´ì†Œë‚˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.")
                            st.rerun()
                    else:
                        st.info("ğŸ”’ ì‚¬íšŒì")
    
    with tab2:
        st.header("ğŸ’¬ ì‹¤ì‹œê°„ íšŒì˜")
        
        if not meeting.is_active:
            st.info("â„¹ï¸ íšŒì˜ë¥¼ ì‹œì‘í•˜ë ¤ë©´ ì‚¬ì´ë“œë°”ì—ì„œ 'íšŒì˜ ì‹œì‘' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.")
            
            # íšŒì˜ ì‹œì‘ ì „ ë¯¸ë¦¬ë³´ê¸°
            if meeting.meeting_topic:
                st.subheader("ğŸ“‹ íšŒì˜ ì •ë³´")
                st.write(f"**ì£¼ì œ:** {meeting.meeting_topic}")
                st.write(f"**ì˜ˆìƒ ì‹œê°„:** {meeting.meeting_duration}ë¶„")
                st.write(f"**ì°¸ì—¬ì:** {len(meeting.personas)}ëª…")
                st.write(f"**ì°¸ì—¬ì ëª©ë¡:** {', '.join([p.name for p in meeting.personas])}")
        else:
            # íšŒì˜ ì§„í–‰ ìƒí™©
            col1, col2, col3, col4 = st.columns(4)
            with col1:
                elapsed_time = datetime.now() - meeting.start_time
                st.metric("â° ê²½ê³¼ ì‹œê°„", f"{elapsed_time.seconds // 60}ë¶„")
            with col2:
                # ë¼ìš´ë“œ í‘œì‹œì— ìƒíƒœ ì •ë³´ ì¶”ê°€
                current_round_display = f"{meeting.conversation_round + 1}/{meeting.max_rounds}"
                if meeting.conversation_round + 1 == meeting.max_rounds:
                    current_round_display += " (ğŸ ë§ˆì§€ë§‰)"
                elif meeting.conversation_round >= meeting.max_rounds:
                    current_round_display = f"{meeting.max_rounds}/{meeting.max_rounds} (âœ… ì™„ë£Œ)"
                st.metric("ğŸ”„ í˜„ì¬ ë¼ìš´ë“œ", current_round_display)
            with col3:
                st.metric("ğŸ’¬ ì´ ë©”ì‹œì§€", len(meeting.messages))
            with col4:
                next_speaker = meeting.get_next_speaker()
                if meeting.conversation_round >= meeting.max_rounds:
                    # íšŒì˜ê°€ ì¢…ë£Œëœ ê²½ìš°
                    moderator = meeting.get_moderator()
                    last_message = meeting.messages[-1] if meeting.messages else None
                    
                    if last_message and last_message.is_moderator and moderator and last_message.persona_id == moderator.id:
                        st.metric("ğŸ¤ ë‹¤ìŒ ë°œì–¸ì", "íšŒì˜ ì™„ë£Œ")
                    else:
                        st.metric("ğŸ¤ ë‹¤ìŒ ë°œì–¸ì", f"{moderator.name} (ë§ˆë¬´ë¦¬)")
                elif meeting.conversation_round + 1 == meeting.max_rounds:
                    # ë§ˆì§€ë§‰ ë¼ìš´ë“œì¸ ê²½ìš°
                    speaker_name = next_speaker.name if next_speaker else "ì—†ìŒ"
                    st.metric("ğŸ¤ ë‹¤ìŒ ë°œì–¸ì", f"{speaker_name} (ìµœì¢…ê²°ë¡ )")
                else:
                    st.metric("ğŸ¤ ë‹¤ìŒ ë°œì–¸ì", next_speaker.name if next_speaker else "ì—†ìŒ")
            
            # ì‚¬íšŒì ê°œì…
            st.subheader("ğŸ¯ ì‚¬íšŒì ê°œì…")
            moderator = meeting.get_moderator()
            if moderator:
                with st.form("moderator_form"):
                    human_input = st.text_area(
                        f"{moderator.name}ë¡œì„œ ë°œì–¸",
                        help="ì‚¬íšŒì ì—­í• ë¡œ íšŒì˜ ë°©í–¥ì„ ì œì‹œí•˜ê±°ë‚˜ ì˜ê²¬ì„ ì¶”ê°€í•˜ì„¸ìš”",
                        placeholder="ì˜ˆ: ì§€ê¸ˆê¹Œì§€ì˜ ì˜ê²¬ì„ ì •ë¦¬í•´ë³´ê² ìŠµë‹ˆë‹¤..."
                    )
                    
                    if st.form_submit_button("ğŸ’¬ ë°œì–¸í•˜ê¸°", type="primary"):
                        if human_input:
                            meeting.add_message(moderator.id, human_input, is_human_input=True)
                            st.success("âœ… ë°œì–¸ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!")
                            st.rerun()
            
            # ë¼ìš´ë“œ ì§„í–‰ ìƒí™© í‘œì‹œ (ì¡°ì • ê¸°ëŠ¥ ì œê±°)
            st.subheader("ğŸ“Š ë¼ìš´ë“œ ì§„í–‰ ìƒí™©")
            col1, col2 = st.columns([2, 1])
            with col1:
                # í˜„ì¬ ì§„í–‰ë¥  ê³„ì‚°
                current_progress = meeting.conversation_round / meeting.max_rounds * 100
                progress_color = "ğŸŸ¢" if current_progress < 70 else "ğŸŸ¡" if current_progress < 90 else "ğŸ”´"
                
                st.write(f"**í˜„ì¬ ì§„í–‰ë¥ **: {progress_color} {current_progress:.1f}% ({meeting.conversation_round}/{meeting.max_rounds})")
                
                # í† ë¡  ë‹¨ê³„ í‘œì‹œ
                round_percentage = (meeting.conversation_round + 1) / meeting.max_rounds
                if round_percentage <= 0.2:
                    stage = "ğŸ” ë¬¸ì œ ì •ì˜ ë° í˜„í™© íŒŒì•…"
                elif round_percentage <= 0.4:
                    stage = "ğŸ’¡ ë¬¸ì œ íƒìƒ‰ ë° í•´ê²°ì±… ì œì‹œ"
                elif round_percentage <= 0.6:
                    stage = "âš–ï¸ í•´ê²°ì±… ë¹„êµ ë° ë¶„ì„"
                elif round_percentage <= 0.8:
                    stage = "ğŸ¤ í•©ì˜ì  ë„ì¶œ ë° êµ¬ì²´í™”"
                else:
                    stage = "ğŸ“‹ ìµœì¢… ê²°ë¡  ë° ì‹¤í–‰ ë°©ì•ˆ"
                
                st.info(f"**í˜„ì¬ í† ë¡  ë‹¨ê³„**: {stage}")
            
            with col2:
                # ì„¤ì •ê°’ ë³´í˜¸ ìƒíƒœ í‘œì‹œ
                st.success(f"ğŸ”’ **ìµœëŒ€ ë¼ìš´ë“œ ê³ ì •**\n{meeting.original_max_rounds}ë¼ìš´ë“œë¡œ ì„¤ì •ë¨")
                if meeting.extension_granted:
                    st.warning(f"âš ï¸ **1ë¼ìš´ë“œ ì—°ì¥**\n{meeting.original_max_rounds} â†’ {meeting.max_rounds}")
                st.info("ğŸ’¡ ì‚¬ì´ë“œë°”ì—ì„œë§Œ ë³€ê²½ ê°€ëŠ¥")
                
                # ë¼ìš´ë“œ ìë™ ì§„í–‰ ì•ˆë‚´
                st.caption("ğŸ”„ ë¼ìš´ë“œëŠ” ëª¨ë“  ì°¸ê°€ì ë°œì–¸ ì™„ë£Œ ì‹œ ìë™ ì§„í–‰ë©ë‹ˆë‹¤")
            
            # ëŒ€í™” ì§„í–‰ ì»¨íŠ¸ë¡¤
            st.subheader("ğŸ—£ï¸ ëŒ€í™” ì§„í–‰")
            
            # ğŸ¯ ëŒ€í™” ì²´ì¸ ì‹œìŠ¤í…œ ìƒíƒœ í‘œì‹œ
            non_moderator_personas = meeting.get_non_moderator_personas()
            if non_moderator_personas:
                next_speaker = meeting.get_next_speaker()
                if next_speaker:
                    st.info(f"ğŸ¯ **ë‹¤ìŒ ë°œì–¸ì**: {next_speaker.name} ({next_speaker.role}) | ë°œì–¸ ìˆœì„œ: {meeting.turn_counter + 1}ë²ˆì§¸")
                
                # ëŒ€í™” ë°©í–¥ ê°€ì´ë“œ í‘œì‹œ
                if hasattr(meeting, 'get_conversation_direction'):
                    direction = meeting.get_conversation_direction()
                    if direction and direction != "íšŒì˜ ì£¼ì œì— ëŒ€í•œ ì²« ë²ˆì§¸ ì˜ê²¬ì„ ì œì‹œí•´ì£¼ì„¸ìš”.":
                        st.info(f"ğŸ§­ **ëŒ€í™” ë°©í–¥**: {direction}")
                
                # í˜„ì¬ ë…¼ì˜ ì´ˆì  í‘œì‹œ
                if hasattr(meeting, 'discussion_focus') and meeting.discussion_focus:
                    st.success(f"ğŸ¯ **í˜„ì¬ ë…¼ì˜ ì´ˆì **: {meeting.discussion_focus}")
            
            col1, col2, col3, col4 = st.columns(4)
            with col1:
                # ğŸ¯ íšŒì˜ ìƒíƒœì— ë”°ë¥¸ ë²„íŠ¼ í‘œì‹œ
                if meeting.conversation_round >= meeting.max_rounds:
                    st.success("ğŸ íšŒì˜ ì™„ë£Œ")
                    st.info(f"âœ… {meeting.max_rounds}ë¼ìš´ë“œ ëª¨ë‘ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")
                elif st.button("ğŸ’¬ ë‹¤ìŒ ë°œì–¸", type="primary"):
                    with st.spinner("ğŸ¤– AIê°€ ì‘ë‹µì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤..."):
                        success = run_conversation_round(meeting)
                        if success:
                            st.rerun()
                        else:
                            st.info("â„¹ï¸ íšŒì˜ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")
            
            with col2:
                # ì§„í–‰ ìƒí™© í‘œì‹œ (ë¼ìš´ë“œëŠ” ìë™ìœ¼ë¡œ ì§„í–‰ë¨)
                current_round_display = meeting.conversation_round + 1
                progress = meeting.conversation_round / meeting.max_rounds
                st.metric(
                    "ğŸ“Š ì§„í–‰ ìƒí™©", 
                    f"{current_round_display}/{meeting.max_rounds} ë¼ìš´ë“œ",
                    f"{progress*100:.1f}% ì™„ë£Œ"
                )
                st.progress(progress)
                
                # ë¼ìš´ë“œ ìë™ ì§„í–‰ ìƒíƒœ í‘œì‹œ
                non_moderator_count = len(meeting.get_non_moderator_personas())
                if non_moderator_count > 0:
                    current_turn_in_round = (meeting.current_speaker_index % non_moderator_count) + 1
                    st.caption(f"í˜„ì¬ ë¼ìš´ë“œ ë‚´ ì§„í–‰: {current_turn_in_round}/{non_moderator_count}ëª… ë°œì–¸")
                else:
                    st.caption("ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤")
            
            with col3:
                if st.button("ğŸ¯ ì‚¬íšŒì ì •ë¦¬"):
                    # ê°•ì œë¡œ ì‚¬íšŒì ê°œì… ì‹¤í–‰
                    moderator = meeting.get_moderator()
                    if moderator:
                        with st.spinner("ğŸ¯ ì‚¬íšŒìê°€ ì •ë¦¬ ì¤‘ì…ë‹ˆë‹¤..."):
                            selected_model = st.session_state.get('selected_ai_model', 'gpt-4o-mini')
                            intervention_message = generate_moderator_intervention(meeting, selected_model)
                            meeting.add_message(moderator.id, intervention_message)
                            # ë§ˆì§€ë§‰ ê°œì… ì‹œê°„ ê¸°ë¡
                            meeting.last_moderator_intervention = datetime.now()
                            st.success("âœ… ì‚¬íšŒìê°€ ì¤‘ê°„ ì •ë¦¬ë¥¼ í–ˆìŠµë‹ˆë‹¤.")
                            st.rerun()
                    else:
                        st.error("âŒ ì‚¬íšŒìê°€ ì—†ìŠµë‹ˆë‹¤.")
            
            with col4:
                if st.button("ğŸ”š íšŒì˜ ì¢…ë£Œ"):
                    meeting.is_active = False
                    # ì‚¬íšŒì ë§ˆë¬´ë¦¬ ë°œì–¸
                    if moderator:
                        closing_message = "ì˜¤ëŠ˜ íšŒì˜ë¥¼ ë§ˆì¹˜ê² ìŠµë‹ˆë‹¤. ëª¨ë“  ë¶„ë“¤ì˜ í™œë°œí•œ ì°¸ì—¬ì— ê°ì‚¬ë“œë¦½ë‹ˆë‹¤."
                        meeting.add_message(moderator.id, closing_message)
                    st.success("âœ… íšŒì˜ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")
                    st.rerun()
            
            # í† ë¡  ì™„ì„±ë„ ì²´í¬ (ìƒˆë¡œ ì¶”ê°€)
            if meeting.conversation_round > 0:
                st.subheader("ğŸ“Š í† ë¡  ì™„ì„±ë„ ì²´í¬")
                
                # ì§„í–‰ë¥  ê¸°ë°˜ ì™„ì„±ë„ ë¶„ì„
                round_percentage = meeting.conversation_round / meeting.max_rounds
                
                col1, col2, col3 = st.columns(3)
                with col1:
                    # í† ë¡  ê¹Šì´ ì²´í¬
                    avg_message_length = sum(len(msg.content) for msg in meeting.messages) / len(meeting.messages) if meeting.messages else 0
                    depth_score = min(100, avg_message_length / 2)  # 200ì ê¸°ì¤€ 100ì 
                    st.metric("ğŸ’­ í† ë¡  ê¹Šì´", f"{depth_score:.0f}ì ", help="í‰ê·  ë°œì–¸ ê¸¸ì´ ê¸°ì¤€")
                
                with col2:
                    # ì°¸ì—¬ë„ ì²´í¬
                    non_mod_personas = meeting.get_non_moderator_personas()
                    if non_mod_personas:
                        speaker_counts = {}
                        for msg in meeting.messages:
                            if not msg.is_moderator and not msg.is_human_input:
                                speaker_counts[msg.persona_id] = speaker_counts.get(msg.persona_id, 0) + 1
                        
                        participation_rate = len(speaker_counts) / len(non_mod_personas) * 100
                        st.metric("ğŸ‘¥ ì°¸ì—¬ë„", f"{participation_rate:.0f}%", help="ëª¨ë“  ì°¸ê°€ì ë°œì–¸ ë¹„ìœ¨")
                
                with col3:
                    # ë‹¨ê³„ë³„ ì§„í–‰ë„
                    if round_percentage <= 0.2:
                        stage_completion = "ë¬¸ì œì •ì˜ ì§„í–‰ì¤‘"
                        stage_color = "ğŸ”µ"
                    elif round_percentage <= 0.4:
                        stage_completion = "í•´ê²°ì±… ëª¨ìƒ‰ì¤‘"
                        stage_color = "ğŸŸ¡"
                    elif round_percentage <= 0.6:
                        stage_completion = "ëŒ€ì•ˆ ë¹„êµì¤‘"
                        stage_color = "ğŸŸ "
                    elif round_percentage <= 0.8:
                        stage_completion = "í•©ì˜ ë„ì¶œì¤‘"
                        stage_color = "ğŸŸ£"
                    else:
                        stage_completion = "ê²°ë¡  ì •ë¦¬ì¤‘"
                        stage_color = "ğŸ”´"
                    
                    st.metric("ğŸ¯ ì§„í–‰ ë‹¨ê³„", f"{stage_color} {stage_completion}")
                
                # ì™„ì„±ë„ ì¢…í•© í‰ê°€
                overall_completion = (round_percentage * 40) + (min(depth_score, 100) * 0.3) + (participation_rate * 0.3)
                
                if overall_completion >= 80:
                    completion_status = "ğŸŸ¢ ìš°ìˆ˜í•œ í† ë¡  ì§„í–‰"
                elif overall_completion >= 60:
                    completion_status = "ğŸŸ¡ ì–‘í˜¸í•œ í† ë¡  ì§„í–‰"
                else:
                    completion_status = "ğŸ”´ ë” ê¹Šì´ ìˆëŠ” í† ë¡  í•„ìš”"
                
                st.info(f"**ì¢…í•© ì™„ì„±ë„**: {completion_status} ({overall_completion:.0f}ì )")
                
                # í† ë¡  ê°œì„  ì œì•ˆ ë° ì¢…ë£Œ ì•Œë¦¼
                if round_percentage > 0.6 and overall_completion < 70:
                    st.warning("ğŸ’¡ **í† ë¡  ê°œì„  ì œì•ˆ**: ë” êµ¬ì²´ì ì¸ í•´ê²°ì±…ê³¼ ì‹¤í–‰ ë°©ì•ˆì„ ë…¼ì˜í•´ë³´ì„¸ìš”.")
                elif round_percentage > 0.8 and overall_completion < 80:
                    st.warning("ğŸ’¡ **ë§ˆë¬´ë¦¬ ì œì•ˆ**: ì§€ê¸ˆê¹Œì§€ì˜ ë…¼ì˜ë¥¼ ì¢…í•©í•˜ì—¬ ëª…í™•í•œ ê²°ë¡ ì„ ë„ì¶œí•´ë³´ì„¸ìš”.")
                
                # íšŒì˜ ìë™ ì¢…ë£Œ ì•Œë¦¼
                try:
                    if hasattr(meeting, '_is_conclusion_reached') and meeting._is_conclusion_reached():
                        st.success("ğŸ‰ **íšŒì˜ ì™„ë£Œ**: ê²°ë¡ ì´ ì¶©ë¶„íˆ ë„ì¶œë˜ì–´ íšŒì˜ê°€ ìë™ìœ¼ë¡œ ì¢…ë£Œë  ì˜ˆì •ì…ë‹ˆë‹¤.")
                    elif round_percentage > 0.9:
                        st.info("â° **íšŒì˜ ë§ˆë¬´ë¦¬**: ìµœëŒ€ ë¼ìš´ë“œì— ê°€ê¹Œì›Œì§€ê³  ìˆìŠµë‹ˆë‹¤. ê²°ë¡ ì„ ì •ë¦¬í•´ì£¼ì„¸ìš”.")
                except AttributeError:
                    # êµ¬ë²„ì „ meeting ê°ì²´ì¸ ê²½ìš° ê°„ë‹¨í•œ ëŒ€ì•ˆ ì‚¬ìš©
                    if round_percentage > 0.9:
                        st.info("â° **íšŒì˜ ë§ˆë¬´ë¦¬**: ìµœëŒ€ ë¼ìš´ë“œì— ê°€ê¹Œì›Œì§€ê³  ìˆìŠµë‹ˆë‹¤. ê²°ë¡ ì„ ì •ë¦¬í•´ì£¼ì„¸ìš”.")
            
            # ğŸ¯ ëŒ€í™” ì²´ì¸ ì‹œìŠ¤í…œ ìƒíƒœ (ìƒˆë¡œ ì¶”ê°€)
            with st.expander("ğŸ¯ ëŒ€í™” ì²´ì¸ ì‹œìŠ¤í…œ ìƒíƒœ", expanded=False):
                if hasattr(meeting, 'conversation_chain'):
                    col1, col2 = st.columns(2)
                    
                    with col1:
                        st.write("**ğŸ“‹ í•©ì˜ëœ ì‚¬í•­ë“¤:**")
                        if meeting.agreements:
                            for i, agreement in enumerate(meeting.agreements[-3:], 1):
                                st.write(f"{i}. {agreement}")
                        else:
                            st.write("ì•„ì§ í•©ì˜ëœ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.")
                    
                    with col2:
                        st.write("**âš ï¸ ì´ê²¬ì´ ìˆëŠ” ì‚¬í•­ë“¤:**")
                        if meeting.disagreements:
                            for i, disagreement in enumerate(meeting.disagreements[-3:], 1):
                                st.write(f"{i}. {disagreement}")
                        else:
                            st.write("íŠ¹ë³„í•œ ì´ê²¬ì´ ì—†ìŠµë‹ˆë‹¤.")
                    
                    st.write(f"**ğŸ¯ í˜„ì¬ ë…¼ì˜ ì´ˆì :** {meeting.discussion_focus or 'ì•„ì§ ì„¤ì •ë˜ì§€ ì•ŠìŒ'}")
                    st.write(f"**ğŸ“Š ë°œì–¸ ìˆœì„œ:** {meeting.turn_counter}ë²ˆì§¸ ë°œì–¸")
                else:
                    st.info("ëŒ€í™” ì²´ì¸ ì‹œìŠ¤í…œì„ ì´ˆê¸°í™”í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...")
            
            # ë§¥ë½ ë¯¸ë¦¬ë³´ê¸° (ìƒˆë¡œ ì¶”ê°€)
            with st.expander("ğŸ” ë‹¤ìŒ ë°œì–¸ ë§¥ë½ ë¯¸ë¦¬ë³´ê¸°", expanded=False):
                next_speaker = meeting.get_next_speaker()
                if next_speaker:
                    st.write(f"**ë‹¤ìŒ ë°œì–¸ì:** {next_speaker.name} ({next_speaker.role})")
                    
                    # ë§¥ë½ ë¯¸ë¦¬ë³´ê¸°
                    comprehensive_context = get_comprehensive_meeting_context(meeting)
                    st.text_area(
                        "AIê°€ ì°¸ê³ í•  ì „ì²´ ë§¥ë½",
                        value=comprehensive_context,
                        height=200,
                        disabled=True,
                        help="ì´ ë§¥ë½ì´ AIì—ê²Œ ì „ë‹¬ë˜ì–´ ë¼ìš´ë“œë³„ ì—°ì†ì„±ì„ ìœ ì§€í•©ë‹ˆë‹¤"
                    )
                    
                    # í† í° ê¸¸ì´ ì •ë³´
                    context_length = len(comprehensive_context)
                    st.caption(f"ğŸ“Š ë§¥ë½ ê¸¸ì´: {context_length:,}ì (ì•½ {context_length//4:,} í† í°)")
                else:
                    st.info("ë°œì–¸ ê°€ëŠ¥í•œ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤.")
            
            # ìë™ ì§„í–‰ ëª¨ë“œ ìƒíƒœ í‘œì‹œë§Œ (ì‹¤í–‰ì€ ë©”ì¸ í•¨ìˆ˜ ëì—ì„œ)
            if meeting.auto_mode:
                st.success(f"ğŸš€ ìë™ ì§„í–‰ ëª¨ë“œ í™œì„±í™” - {meeting.speaking_speed}ì´ˆë§ˆë‹¤ ìë™ ë°œì–¸")
                st.info(f"ğŸ¯ ëª©í‘œ: {meeting.max_rounds}ë¼ìš´ë“œê¹Œì§€ ìë™ ì™„ë£Œ")
                
                # ìë™ ì§„í–‰ ìƒíƒœ í‘œì‹œ - ì •í™•í•œ ì‹œê°„ ê³„ì‚°
                col1, col2 = st.columns([3, 1])
                with col1:
                    if meeting.last_message_time:
                        time_since_last = (datetime.now() - meeting.last_message_time).total_seconds()
                        remaining_time = max(0, meeting.speaking_speed - time_since_last)
                        progress_value = min(1.0, (meeting.speaking_speed - remaining_time) / meeting.speaking_speed)
                        
                        if remaining_time <= 0:
                            st.success("âš¡ ë‹¤ìŒ ë°œì–¸ ì‹¤í–‰ ì¤‘...")
                        else:
                            st.progress(
                                progress_value,
                                text=f"ë‹¤ìŒ ë°œì–¸ê¹Œì§€ {remaining_time:.1f}ì´ˆ ë‚¨ìŒ"
                            )
                    else:
                        st.info("ğŸš€ ì²« ë°œì–¸ ì¤€ë¹„ ì¤‘...")
                
                with col2:
                    if st.button("â¸ï¸ ìë™ëª¨ë“œ ì¤‘ë‹¨"):
                        meeting.auto_mode = False
                        st.info("ìë™ ëª¨ë“œê°€ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.")
                        st.rerun()
            
            # ëŒ€í™” ë‚´ìš© í‘œì‹œ (í•­ìƒ ìµœì‹  ìƒíƒœë¡œ)
            st.subheader("ğŸ’­ ëŒ€í™” ë‚´ìš©")
            
            # ëŒ€í™” ì»¨í…Œì´ë„ˆ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥)
            chat_container = st.container()
            with chat_container:
                if meeting.messages:
                    # ëª¨ë“  ë©”ì‹œì§€ í‘œì‹œ (ìµœì‹  ë©”ì‹œì§€ë§Œ íƒ€ì´í•‘ íš¨ê³¼)
                    for i, message in enumerate(meeting.messages):
                        is_latest = (i == len(meeting.messages) - 1)  # ë§ˆì§€ë§‰ ë©”ì‹œì§€ì¸ì§€ í™•ì¸
                        display_message(message, is_latest=is_latest)
                    
                    # ìµœì‹  ë©”ì‹œì§€ ê°•ì¡°
                    st.info(f"ğŸ’¬ ì´ ë©”ì‹œì§€: {len(meeting.messages)}ê°œ | ë§ˆì§€ë§‰ ë°œì–¸: {meeting.messages[-1].timestamp.strftime('%H:%M:%S')}")
                else:
                    st.info("ğŸ’­ ì•„ì§ ëŒ€í™”ê°€ ì‹œì‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
                
                # ìë™ ìŠ¤í¬ë¡¤ì„ ìœ„í•œ ì•µì»¤
                st.write("")
    
    with tab3:
        st.header("ğŸ“Š íšŒì˜ í˜„í™©")
        
        if meeting.messages:
            # íšŒì˜ ê°œìš”
            col1, col2, col3 = st.columns(3)
            with col1:
                st.metric("ğŸ’¬ ì´ ë°œì–¸ ìˆ˜", len(meeting.messages))
            with col2:
                human_messages = sum(1 for msg in meeting.messages if msg.is_human_input)
                st.metric("ğŸ‘¤ ì¸ê°„ ê°œì…", human_messages)
            with col3:
                if meeting.start_time:
                    duration = datetime.now() - meeting.start_time
                    st.metric("â±ï¸ íšŒì˜ ì‹œê°„", f"{duration.seconds//60}ë¶„ {duration.seconds%60}ì´ˆ")
            
            # ì¶”ê°€ ì‹œìŠ¤í…œ ì„¤ì • ì •ë³´
            col4, col5, col6, col7 = st.columns(4)
            with col4:
                st.metric("ğŸ• ë°œì–¸ ê°„ê²©", f"{meeting.speaking_speed}ì´ˆ")
            with col5:
                st.metric("âŒ¨ï¸ íƒ€ì´í•‘ ì†ë„", f"{meeting.typing_speed}ì´ˆ/ë‹¨ì–´")
            with col6:
                saved_count = len(get_saved_meeting_records())
                st.metric("ğŸ’¾ ì €ì¥ëœ íšŒì˜ë¡", f"{saved_count}ê°œ")
            with col7:
                current_ai_model = st.session_state.get('selected_ai_model', 'gpt-4o-mini')
                model_display = current_ai_model.split('-')[0].upper()  # claude ë˜ëŠ” GPT
                st.metric("ğŸ§  AI ëª¨ë¸", model_display)
            
            # ë°œì–¸ í†µê³„
            speaker_stats = {}
            for message in meeting.messages:
                if message.persona_name in speaker_stats:
                    speaker_stats[message.persona_name] += 1
                else:
                    speaker_stats[message.persona_name] = 1
            
            # ë°œì–¸ íšŸìˆ˜ ì°¨íŠ¸
            if speaker_stats:
                st.subheader("ğŸ‘¤ ë°œì–¸ìë³„ í†µê³„")
                df_stats = pd.DataFrame(list(speaker_stats.items()), columns=['ë°œì–¸ì', 'ë°œì–¸ íšŸìˆ˜'])
                df_stats = df_stats.sort_values('ë°œì–¸ íšŸìˆ˜', ascending=True)
                st.bar_chart(df_stats.set_index('ë°œì–¸ì'))
                
                # ë°œì–¸ ë¶„í¬ íŒŒì´ ì°¨íŠ¸
                try:
                    import plotly.express as px
                    fig = px.pie(df_stats, values='ë°œì–¸ íšŸìˆ˜', names='ë°œì–¸ì', title='ë°œì–¸ ë¶„í¬')
                    st.plotly_chart(fig, use_container_width=True)
                except ImportError:
                    st.info("ğŸ“Š Plotlyê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•„ íŒŒì´ ì°¨íŠ¸ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            
            # ì‹œê°„ëŒ€ë³„ í™œë™
            st.subheader("ğŸ“ˆ ì‹œê°„ëŒ€ë³„ í™œë™")
            if len(meeting.messages) > 1:
                time_data = []
                for i, message in enumerate(meeting.messages):
                    time_data.append({
                        'ìˆœì„œ': i + 1,
                        'ì‹œê°„': message.timestamp.strftime('%H:%M:%S'),
                        'ë°œì–¸ì': message.persona_name,
                        'ë‚´ìš© ê¸¸ì´': len(message.content)
                    })
                
                df_time = pd.DataFrame(time_data)
                st.line_chart(df_time.set_index('ìˆœì„œ')['ë‚´ìš© ê¸¸ì´'])
            
            # ğŸ”§ ìƒˆë¡œìš´ íšŒì˜ ì œì–´ ìƒíƒœ (ë°˜ë³µ ê°ì§€, ì—°ì¥ ì •ë³´)
            st.subheader("ğŸ› ï¸ íšŒì˜ ì œì–´ ìƒíƒœ")
            col1, col2, col3 = st.columns(3)
            
            with col1:
                # ì›ë³¸ ìµœëŒ€ ë¼ìš´ë“œ vs í˜„ì¬ ìµœëŒ€ ë¼ìš´ë“œ
                if hasattr(meeting, 'original_max_rounds') and hasattr(meeting, 'extension_granted'):
                    if meeting.extension_granted:
                        st.warning(f"âš ï¸ **ë¼ìš´ë“œ ì—°ì¥ë¨**\nì›ë³¸: {meeting.original_max_rounds} â†’ í˜„ì¬: {meeting.max_rounds}")
                    else:
                        st.success(f"âœ… **ì›ë³¸ ì„¤ì • ìœ ì§€**\nì„¤ì •ëœ ìµœëŒ€ ë¼ìš´ë“œ: {meeting.original_max_rounds}")
                else:
                    st.info(f"ğŸ“Š ìµœëŒ€ ë¼ìš´ë“œ: {meeting.max_rounds}")
            
            with col2:
                # ë°˜ë³µ ëŒ€í™” ê°ì§€ ìƒíƒœ
                if hasattr(meeting, 'consecutive_repetitions'):
                    if meeting.consecutive_repetitions >= 2:
                        st.error(f"ğŸ”„ **ë°˜ë³µ ê°ì§€ë¨**\nì—°ì† ë°˜ë³µ: {meeting.consecutive_repetitions}íšŒ")
                    elif meeting.consecutive_repetitions >= 1:
                        st.warning(f"âš ï¸ **ë°˜ë³µ ì£¼ì˜**\nì—°ì† ë°˜ë³µ: {meeting.consecutive_repetitions}íšŒ")
                    else:
                        st.success("âœ… **ê±´ì „í•œ ëŒ€í™”**\në°˜ë³µ ì—†ìŒ")
                else:
                    st.info("ğŸ”„ ë°˜ë³µ ê°ì§€ ì´ˆê¸°í™” ì¤‘...")
            
            with col3:
                # ìë™ ì¢…ë£Œ ì¡°ê±´ ì²´í¬
                try:
                    if hasattr(meeting, '_is_conclusion_reached') and meeting._is_conclusion_reached():
                        st.success("ğŸ¯ **ê²°ë¡  ë„ì¶œ ì™„ë£Œ**\níšŒì˜ ì¢…ë£Œ ê°€ëŠ¥")
                    elif hasattr(meeting, '_detect_repetitive_conversation') and meeting._detect_repetitive_conversation():
                        st.warning("ğŸ”„ **ë°˜ë³µ ëŒ€í™” ê°ì§€**\nì¡°ê¸° ì¢…ë£Œ ì˜ˆì •")
                    else:
                        st.info("ğŸ’¬ **ëŒ€í™” ì§„í–‰ ì¤‘**\nì •ìƒ ìƒíƒœ")
                except:
                    st.info("ğŸ” **ìƒíƒœ ë¶„ì„ ì¤‘**")
            
            # ë¼ìš´ë“œë³„ ìš”ì•½ í˜„í™© (ìƒˆë¡œ ì¶”ê°€)
            st.subheader("ğŸ”„ ë¼ìš´ë“œë³„ ë§¥ë½ ìœ ì§€ í˜„í™©")
            if meeting.conversation_round > 0:
                for round_num in range(1, meeting.conversation_round + 1):
                    with st.expander(f"ğŸ“‹ ë¼ìš´ë“œ {round_num} ìš”ì•½", expanded=False):
                        summary = meeting.generate_round_summary(round_num)
                        if summary:
                            st.text(summary)
                        else:
                            st.info("ìš”ì•½ ìƒì„± ì¤‘...")
            else:
                st.info("ì•„ì§ ì™„ë£Œëœ ë¼ìš´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.")
            
            # í•µì‹¬ ì¸ì‚¬ì´íŠ¸ (ìƒˆë¡œ ì¶”ê°€)
            key_insights = meeting.extract_key_insights()
            if key_insights:
                st.subheader("ğŸ’¡ í•µì‹¬ ì¸ì‚¬ì´íŠ¸")
                for insight in key_insights:
                    st.write(f"â€¢ {insight}")
            
            # ì°¸ê³  ìë£Œ í™œìš© í˜„í™© (ìƒˆë¡œ ì¶”ê°€)
            if meeting.uploaded_files_content:
                st.subheader("ğŸ“Š ì°¸ê³  ìë£Œ í™œìš© í˜„í™©")
                analysis = meeting.analyze_uploaded_files()
                
                col1, col2 = st.columns(2)
                with col1:
                    st.metric("ğŸ“„ íŒŒì¼ í¬ê¸°", f"{analysis.get('total_length', 0):,}ì")
                    st.metric("ğŸ”‘ ì¶”ì¶œëœ í‚¤ì›Œë“œ", f"{len(analysis.get('keywords', []))}")
                
                with col2:
                    # íšŒì˜ ì£¼ì œì™€ í‚¤ì›Œë“œ ë§¤ì¹­ë¥  ê³„ì‚°
                    if meeting.meeting_topic and analysis.get('keywords'):
                        topic_keywords = meeting.meeting_topic.replace(',', ' ').replace('.', ' ').split()
                        topic_keywords = [k.strip().lower() for k in topic_keywords if len(k.strip()) >= 2]
                        file_keywords = [k.lower() for k in analysis.get('keywords', [])]
                        
                        matching_keywords = [k for k in topic_keywords if k in file_keywords]
                        match_rate = len(matching_keywords) / len(topic_keywords) * 100 if topic_keywords else 0
                        
                        st.metric("ğŸ¯ ì£¼ì œ ì—°ê´€ë„", f"{match_rate:.1f}%")
                        st.metric("âœ… ë§¤ì¹­ í‚¤ì›Œë“œ", f"{len(matching_keywords)}ê°œ")
                
                # íŒŒì¼ í™œìš© í’ˆì§ˆ ì§€í‘œ
                with st.expander("ğŸ“ˆ íŒŒì¼ í™œìš© ë¶„ì„", expanded=False):
                    if analysis.get('keywords'):
                        st.write("**ğŸ”‘ ìƒìœ„ í‚¤ì›Œë“œ:**")
                        st.write(", ".join(analysis['keywords'][:10]))
                    
                    if analysis.get('sections'):
                        st.write(f"**ğŸ“ ì„¹ì…˜ êµ¬ë¶„:** {len(analysis['sections'])}ê°œ")
                        for i, section in enumerate(analysis['sections'][:3]):
                            st.write(f"  {i+1}. {section['title']}")
                    
                    # RAG í’ˆì§ˆ í‰ê°€
                    if meeting.meeting_topic:
                        relevant_content = meeting.get_relevant_file_content(topic_keywords)
                        if "ê´€ë ¨ ì°¸ê³  ìë£Œ" in relevant_content:
                            st.success("âœ… RAG ì‹œìŠ¤í…œì´ ê´€ë ¨ ë‚´ìš©ì„ ì„±ê³µì ìœ¼ë¡œ ì¶”ì¶œí–ˆìŠµë‹ˆë‹¤")
                        else:
                            st.info("â„¹ï¸ ì „ì²´ ìš”ì•½ì„ ì‚¬ìš©í•˜ì—¬ ì°¸ê³  ìë£Œë¥¼ í™œìš©í•©ë‹ˆë‹¤")
            
            # ì €ì¥ëœ íšŒì˜ë¡ í˜„í™© (ìƒˆë¡œ ì¶”ê°€)
            st.subheader("ğŸ’¾ ì €ì¥ëœ íšŒì˜ë¡ í˜„í™©")
            saved_records = get_saved_meeting_records()
            
            if saved_records:
                # ìµœê·¼ 5ê°œ íšŒì˜ë¡ë§Œ í‘œì‹œ
                recent_saved = saved_records[:5]
                
                for record in recent_saved:
                    with st.container():
                        col1, col2, col3 = st.columns([3, 2, 1])
                        with col1:
                            st.write(f"ğŸ“‹ **{record['title']}**")
                        with col2:
                            st.caption(f"ğŸ“… {record['date'].strftime('%Y-%m-%d %H:%M')}")
                        with col3:
                            if st.button("ğŸ“–", key=f"quick_view_{record['meeting_id']}", help="ë¹ ë¥¸ ë³´ê¸°"):
                                st.session_state.selected_meeting_id = record['meeting_id']
                
                if len(saved_records) > 5:
                    st.caption(f"... ì™¸ {len(saved_records) - 5}ê°œ ë” (íšŒì˜ë¡ íƒ­ì—ì„œ ì „ì²´ í™•ì¸)")
            else:
                st.info("ì €ì¥ëœ íšŒì˜ë¡ì´ ì—†ìŠµë‹ˆë‹¤.")
            
            # ìµœê·¼ í™œë™
            st.subheader("ğŸ• ìµœê·¼ í™œë™")
            recent_messages = meeting.messages[-10:] if len(meeting.messages) > 10 else meeting.messages
            for message in reversed(recent_messages):
                icon = "ğŸ¯" if message.is_moderator else "ğŸ­"
                if message.is_human_input:
                    icon = "ğŸ‘¤"
                
                st.write(
                    f"{icon} **{message.timestamp.strftime('%H:%M:%S')}** - "
                    f"{message.persona_name}: {message.content[:100]}..."
                )
        else:
            st.info("â„¹ï¸ ì•„ì§ íšŒì˜ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.")
    
    with tab4:
        st.header("ğŸ“ íšŒì˜ë¡")
        
        # ì„œë¸Œíƒ­ ìƒì„±
        subtab1, subtab2, subtab3 = st.tabs(["ğŸ“ í˜„ì¬ íšŒì˜ë¡", "ğŸ’¾ íšŒì˜ë¡ ì €ì¥", "ğŸ“š ì €ì¥ëœ íšŒì˜ë¡"])
        
        with subtab1:
            st.subheader("ğŸ“ í˜„ì¬ íšŒì˜ ë‚´ìš©")
            
            if meeting.messages:
                # íšŒì˜ë¡ ìƒì„±
                meeting_log = generate_meeting_log(meeting)
                
                # ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
                col1, col2, col3 = st.columns([1, 1, 1])
                with col1:
                    st.download_button(
                        label="ğŸ“¥ Markdown ë‹¤ìš´ë¡œë“œ",
                        data=meeting_log,
                        file_name=f"meeting_log_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md",
                        mime="text/markdown"
                    )
                with col2:
                    # JSON í˜•íƒœë¡œë„ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥
                    json_data = {
                        "meeting_info": {
                            "topic": meeting.meeting_topic,
                            "start_time": meeting.start_time.isoformat() if meeting.start_time else None,
                            "duration": meeting.meeting_duration,
                            "participants": [{"name": p.name, "role": p.role} for p in meeting.personas]
                        },
                        "messages": [
                            {
                                "timestamp": msg.timestamp.isoformat(),
                                "speaker": msg.persona_name,
                                "content": msg.content,
                                "is_human_input": msg.is_human_input
                            } for msg in meeting.messages
                        ]
                    }
                    
                    st.download_button(
                        label="ğŸ“Š JSON ë‹¤ìš´ë¡œë“œ",
                        data=json.dumps(json_data, ensure_ascii=False, indent=2),
                        file_name=f"meeting_data_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json",
                        mime="application/json"
                    )
                
                # íšŒì˜ë¡ ë¯¸ë¦¬ë³´ê¸°
                st.subheader("ğŸ‘€ íšŒì˜ë¡ ë¯¸ë¦¬ë³´ê¸°")
                st.markdown(meeting_log)
            else:
                st.info("â„¹ï¸ íšŒì˜ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.")
        
        with subtab2:
            st.subheader("ğŸ’¾ íšŒì˜ë¡ ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥")
            
            if meeting.messages:
                # íšŒì˜ë¡ ìƒì„±
                meeting_log = generate_meeting_log(meeting)
                
                # AI ìš”ì•½ ìƒì„± ë²„íŠ¼
                col1, col2 = st.columns([2, 1])
                with col1:
                    st.write("**ğŸ“‹ AI íšŒì˜ë¡ ìš”ì•½ ìƒì„±**")
                    st.caption("AIê°€ íšŒì˜ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ êµ¬ì¡°í™”ëœ ìš”ì•½ì„ ìƒì„±í•©ë‹ˆë‹¤.")
                
                with col2:
                    if st.button("ğŸ¤– AI ìš”ì•½ ìƒì„±", type="secondary"):
                        with st.spinner("AIê°€ íšŒì˜ë¡ì„ ìš”ì•½í•˜ê³  ìˆìŠµë‹ˆë‹¤..."):
                            selected_model = st.session_state.get('selected_ai_model', 'gpt-4o-mini')
                            summary = generate_meeting_summary(meeting_log, selected_model)
                            st.session_state.meeting_summary = summary
                
                # ìƒì„±ëœ ìš”ì•½ í‘œì‹œ
                if 'meeting_summary' in st.session_state:
                    st.subheader("ğŸ“‹ AI ìƒì„± ìš”ì•½")
                    st.markdown(st.session_state.meeting_summary)
                    
                    # ì €ì¥ ë²„íŠ¼
                    col1, col2 = st.columns([1, 1])
                    with col1:
                        if st.button("ğŸ’¾ íšŒì˜ë¡ ì €ì¥", type="primary"):
                            if save_meeting_record(meeting, meeting_log, st.session_state.meeting_summary):
                                st.success("âœ… íšŒì˜ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!")
                                # ìš”ì•½ ì„¸ì…˜ ìƒíƒœ í´ë¦¬ì–´
                                if 'meeting_summary' in st.session_state:
                                    del st.session_state.meeting_summary
                                st.rerun()
                            else:
                                st.error("âŒ íšŒì˜ë¡ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
                    
                    with col2:
                        if st.button("ğŸ”„ ìš”ì•½ ì¬ìƒì„±"):
                            if 'meeting_summary' in st.session_state:
                                del st.session_state.meeting_summary
                            st.rerun()
                else:
                    st.info("ğŸ’¡ ë¨¼ì € 'AI ìš”ì•½ ìƒì„±' ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ íšŒì˜ë¡ ìš”ì•½ì„ ìƒì„±í•´ì£¼ì„¸ìš”.")
                
                # ì €ì¥ ì •ë³´ ì•ˆë‚´
                st.markdown("""
                ---
                ### ğŸ“Š ì €ì¥ë  ì •ë³´
                - **íšŒì˜ ì£¼ì œ**: {topic}
                - **íšŒì˜ ì¼ì‹œ**: {date}
                - **ì°¸ê°€ì**: {participants}
                - **ì „ì²´ ëŒ€í™”ë¡**: ëª¨ë“  ë°œì–¸ ë‚´ìš©
                - **AI ìš”ì•½**: êµ¬ì¡°í™”ëœ íšŒì˜ ìš”ì•½
                """.format(
                    topic=meeting.meeting_topic,
                    date=meeting.start_time.strftime('%Y-%m-%d %H:%M:%S') if meeting.start_time else "ë¯¸ì •",
                    participants=", ".join([p.name for p in meeting.personas])
                ))
            else:
                st.info("â„¹ï¸ ì €ì¥í•  íšŒì˜ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.")
        
        with subtab3:
            st.subheader("ğŸ“š ì €ì¥ëœ íšŒì˜ë¡ ê´€ë¦¬")
            
            # ì €ì¥ëœ íšŒì˜ë¡ ëª©ë¡ ì¡°íšŒ
            saved_records = get_saved_meeting_records()
            
            if saved_records:
                # ê²€ìƒ‰ ê¸°ëŠ¥
                search_term = st.text_input("ğŸ” íšŒì˜ë¡ ê²€ìƒ‰", placeholder="íšŒì˜ ì£¼ì œë‚˜ ì°¸ê°€ìëª…ìœ¼ë¡œ ê²€ìƒ‰...")
                
                # ê²€ìƒ‰ í•„í„°ë§
                if search_term:
                    filtered_records = [
                        record for record in saved_records 
                        if search_term.lower() in record['title'].lower() or 
                           search_term.lower() in record['participants'].lower()
                    ]
                else:
                    filtered_records = saved_records
                
                st.write(f"**ğŸ“Š ì´ {len(filtered_records)}ê°œì˜ íšŒì˜ë¡ì´ ìˆìŠµë‹ˆë‹¤.**")
                
                # íšŒì˜ë¡ ëª©ë¡ í‘œì‹œ
                for record in filtered_records:
                    with st.expander(f"ğŸ“… {record['date'].strftime('%Y-%m-%d %H:%M')} - {record['title']}", expanded=False):
                        col1, col2, col3 = st.columns([2, 1, 1])
                        
                        with col1:
                            st.write(f"**ì°¸ê°€ì**: {record['participants']}")
                            st.write(f"**ì €ì¥ì¼ì‹œ**: {record['created_at'].strftime('%Y-%m-%d %H:%M:%S')}")
                        
                        with col2:
                            if st.button("ğŸ“– ìƒì„¸ë³´ê¸°", key=f"view_{record['meeting_id']}"):
                                st.session_state.selected_meeting_id = record['meeting_id']
                        
                        with col3:
                            if st.button("ğŸ—‘ï¸ ì‚­ì œ", key=f"delete_{record['meeting_id']}", type="secondary"):
                                if delete_meeting_record(record['meeting_id']):
                                    st.success("âœ… íšŒì˜ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.")
                                    st.rerun()
                                else:
                                    st.error("âŒ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
                
                # ì„ íƒëœ íšŒì˜ë¡ ìƒì„¸ ë³´ê¸°
                if 'selected_meeting_id' in st.session_state:
                    st.markdown("---")
                    st.subheader("ğŸ“– íšŒì˜ë¡ ìƒì„¸ ë‚´ìš©")
                    
                    detail = get_meeting_record_detail(st.session_state.selected_meeting_id)
                    if detail:
                        # ê¸°ë³¸ ì •ë³´
                        col1, col2 = st.columns(2)
                        with col1:
                            st.write(f"**ğŸ“‹ íšŒì˜ ì£¼ì œ**: {detail['title']}")
                            st.write(f"**ğŸ“… íšŒì˜ ì¼ì‹œ**: {detail['date'].strftime('%Y-%m-%d %H:%M:%S')}")
                        with col2:
                            st.write(f"**ğŸ‘¥ ì°¸ê°€ì**: {detail['participants']}")
                            st.write(f"**ğŸ’¾ ì €ì¥ì¼ì‹œ**: {detail['created_at'].strftime('%Y-%m-%d %H:%M:%S')}")
                        
                        # íƒ­ìœ¼ë¡œ êµ¬ë¶„ëœ ë‚´ìš©
                        detail_tab1, detail_tab2 = st.tabs(["ğŸ“‹ AI ìš”ì•½", "ğŸ“ ì „ì²´ ëŒ€í™”ë¡"])
                        
                        with detail_tab1:
                            if detail['summary']:
                                st.markdown(detail['summary'])
                            else:
                                st.info("ìš”ì•½ì´ ì—†ìŠµë‹ˆë‹¤.")
                        
                        with detail_tab2:
                            if detail['full_text']:
                                st.markdown(detail['full_text'])
                            else:
                                st.info("ëŒ€í™”ë¡ì´ ì—†ìŠµë‹ˆë‹¤.")
                        
                        # ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
                        col1, col2, col3 = st.columns(3)
                        with col1:
                            st.download_button(
                                label="ğŸ“¥ ìš”ì•½ ë‹¤ìš´ë¡œë“œ",
                                data=detail['summary'] or "ìš”ì•½ ì—†ìŒ",
                                file_name=f"meeting_summary_{detail['meeting_id']}.md",
                                mime="text/markdown"
                            )
                        with col2:
                            st.download_button(
                                label="ğŸ“¥ ì „ì²´ ëŒ€í™”ë¡ ë‹¤ìš´ë¡œë“œ",
                                data=detail['full_text'] or "ëŒ€í™”ë¡ ì—†ìŒ",
                                file_name=f"meeting_full_{detail['meeting_id']}.md",
                                mime="text/markdown"
                            )
                        with col3:
                            if st.button("âŒ ìƒì„¸ë³´ê¸° ë‹«ê¸°"):
                                if 'selected_meeting_id' in st.session_state:
                                    del st.session_state.selected_meeting_id
                                st.rerun()
                    else:
                        st.error("íšŒì˜ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            else:
                st.info("ğŸ“ ì €ì¥ëœ íšŒì˜ë¡ì´ ì—†ìŠµë‹ˆë‹¤. íšŒì˜ë¥¼ ì§„í–‰í•œ í›„ 'íšŒì˜ë¡ ì €ì¥' íƒ­ì—ì„œ ì €ì¥í•´ë³´ì„¸ìš”.")

    # ğŸš€ ê°•í™”ëœ ìë™ ëª¨ë“œ ì‹¤í–‰ ë¡œì§
    if meeting.auto_mode and meeting.is_active:
        if meeting.should_continue():
            if meeting.is_time_to_speak():
                # ì‹¤ì œë¡œ ëŒ€í™” ì‹¤í–‰
                success = run_conversation_round(meeting)
                if success:
                    # ìƒˆë¡œìš´ ë©”ì‹œì§€ê°€ ì¶”ê°€ë˜ì—ˆìœ¼ë¯€ë¡œ ì¦‰ì‹œ ìƒˆë¡œê³ ì¹¨
                    st.rerun()
                else:
                    # íšŒì˜ ìë™ ì¢…ë£Œ
                    meeting.is_active = False
                    meeting.auto_mode = False
                    moderator = meeting.get_moderator()
                    if moderator:
                        closing_message = "ìë™ ëª¨ë“œë¡œ ì§„í–‰ëœ íšŒì˜ë¥¼ ë§ˆì¹˜ê² ìŠµë‹ˆë‹¤. ëª¨ë“  ë¶„ë“¤ì˜ ì˜ê²¬ì— ê°ì‚¬ë“œë¦½ë‹ˆë‹¤."
                        meeting.add_message(moderator.id, closing_message)
                    st.success("âœ… ìë™ ëª¨ë“œ íšŒì˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")
                    st.rerun()
            else:
                # ì‹œê°„ì´ ì•ˆ ë˜ì—ˆìœ¼ë©´ 0.5ì´ˆ í›„ ë‹¤ì‹œ ì²´í¬ (ë” ë¹ ë¥¸ ë°˜ì‘)
                time.sleep(0.5)
                st.rerun()
        else:
            # ğŸ¯ ì •í•´ì§„ ë¼ìš´ë“œ ì™„ë£Œ - ìë™ ì¢…ë£Œ
            meeting.is_active = False
            meeting.auto_mode = False
            moderator = meeting.get_moderator()
            if moderator:
                final_message = f"ì˜ˆì •ëœ {meeting.max_rounds}ë¼ìš´ë“œê°€ ëª¨ë‘ ì™„ë£Œë˜ì–´ íšŒì˜ë¥¼ ë§ˆì¹˜ê² ìŠµë‹ˆë‹¤. í™œë°œí•œ í† ë¡ ì— ê°ì‚¬ë“œë¦½ë‹ˆë‹¤."
                meeting.add_message(moderator.id, final_message)
            st.success(f"ğŸ {meeting.max_rounds}ë¼ìš´ë“œ íšŒì˜ê°€ ìë™ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
            st.balloons()  # ì¶•í•˜ ì• ë‹ˆë©”ì´ì…˜
            st.rerun()

def generate_meeting_log(meeting: VirtualMeeting) -> str:
    """íšŒì˜ë¡ ìƒì„±"""
    log = f"""# ğŸ“‹ íšŒì˜ë¡

## ğŸ¯ íšŒì˜ ì •ë³´
- **ì£¼ì œ**: {meeting.meeting_topic}
- **ì‹œì‘ ì‹œê°„**: {meeting.start_time.strftime('%Y-%m-%d %H:%M:%S') if meeting.start_time else 'N/A'}
- **ì˜ˆì • ì‹œê°„**: {meeting.meeting_duration}ë¶„
- **ì´ ë¼ìš´ë“œ**: {meeting.conversation_round}
- **ì°¸ì—¬ì ìˆ˜**: {len(meeting.personas)}ëª…

## ğŸ‘¥ ì°¸ì—¬ì ëª©ë¡
"""
    for persona in meeting.personas:
        icon = "ğŸ¯" if persona.is_moderator else "ğŸ­"
        log += f"- {icon} **{persona.name}** ({persona.role})\n"
    
    log += f"\n## ğŸ’¬ ëŒ€í™” ë‚´ìš© ({len(meeting.messages)}ê°œ ë©”ì‹œì§€)\n\n"
    
    current_round = 0
    for i, message in enumerate(meeting.messages):
        # ë¼ìš´ë“œ êµ¬ë¶„
        if i > 0 and not message.is_human_input and not message.is_moderator:
            speaker_index = [j for j, p in enumerate(meeting.get_non_moderator_personas()) 
                           if p.id == message.persona_id]
            if speaker_index and speaker_index[0] == 0:
                current_round += 1
                log += f"\n### ğŸ”„ ë¼ìš´ë“œ {current_round}\n\n"
        
        # ë©”ì‹œì§€ ì¶”ê°€
        icon = "ğŸ¯" if message.is_moderator else "ğŸ­"
        if message.is_human_input:
            icon = "ğŸ‘¤"
        
        log += f"**{message.timestamp.strftime('%H:%M:%S')}** {icon} **{message.persona_name}**\n"
        log += f"> {message.content}\n\n"
    
    log += f"\n---\n*íšŒì˜ë¡ ìƒì„± ì‹œê°„: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}*"
    
    return log

if __name__ == "__main__":
    main() 