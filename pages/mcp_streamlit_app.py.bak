import streamlit as st
import requests
import asyncio
import json
import os
import sys
import subprocess
import time
from datetime import datetime
import threading
from dotenv import load_dotenv
import mysql.connector
from mysql.connector import Error

# Load environment variables
load_dotenv()

# Get API keys
ANTHROPIC_API_KEY = os.getenv("ANTHROPIC_API_KEY")

# Initialize session state variables
if 'mcp_server_process' not in st.session_state:
    st.session_state['mcp_server_process'] = None

if 'mcp_server_logs' not in st.session_state:
    st.session_state['mcp_server_logs'] = []

if 'mcp_configs' not in st.session_state:
    st.session_state['mcp_configs'] = {}

if 'chat_history' not in st.session_state:
    st.session_state['chat_history'] = []

# Function to start the MCP server
def start_mcp_server(server_type, port):
    if st.session_state['mcp_server_process'] is not None:
        st.warning("ì´ë¯¸ MCP ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. ìƒˆ ì„œë²„ë¥¼ ì‹œì‘í•˜ê¸° ì „ì— ì¤‘ì§€í•˜ì„¸ìš”.")
        return False, "MCP server is already running"
    
    try:
        # Python ì‹¤í–‰ ê²½ë¡œ
        python_executable = sys.executable
        
        # ì„œë²„ ìœ í˜•ì— ë”°ë¥¸ ìŠ¤í¬ë¦½íŠ¸ ì„ íƒ
        if server_type == "mysql":
            script_path = os.path.join(os.path.dirname(os.path.dirname(__file__)), "servers", "mcp_mysql_server.py")
            
            # ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ìœ¼ë©´ ìƒì„±
            if not os.path.exists(script_path):
                with open(script_path, "w") as f:
                    f.write("""
import sys
import json
from http.server import HTTPServer, BaseHTTPRequestHandler
import mysql.connector
from mysql.connector import Error

# ê¸°ë³¸ í¬íŠ¸ ì„¤ì •
PORT = 3000

# ì»¤ë§¨ë“œ ë¼ì¸ì—ì„œ í¬íŠ¸ ë°›ê¸°
if len(sys.argv) > 1:
    PORT = int(sys.argv[1])

# MySQL ì—°ê²° ì„¤ì •
default_config = {
    "host": "localhost",
    "port": 3306,
    "user": "root",
    "password": ""
}

class MCPHandler(BaseHTTPRequestHandler):
    def _set_headers(self, content_type="application/json"):
        self.send_response(200)
        self.send_header('Content-type', content_type)
        self.end_headers()
    
    def _handle_error(self, status, message):
        self.send_response(status)
        self.send_header('Content-type', 'application/json')
        self.end_headers()
        self.wfile.write(json.dumps({"error": message}).encode())
    
    def do_GET(self):
        if self.path == "/status":
            self._set_headers()
            status = {
                "status": "running",
                "type": "mysql",
                "tools": ["mysql_query"]
            }
            self.wfile.write(json.dumps(status).encode())
        else:
            self._handle_error(404, "Not found")
    
    def do_POST(self):
        if self.path == "/execute":
            content_length = int(self.headers['Content-Length'])
            post_data = self.rfile.read(content_length)
            request = json.loads(post_data.decode())
            
            if "tool" not in request or "parameters" not in request:
                return self._handle_error(400, "Missing tool or parameters")
            
            tool = request["tool"]
            params = request["parameters"]
            
            if tool == "mysql_query":
                return self.execute_mysql_query(params)
            else:
                return self._handle_error(400, f"Unknown tool: {tool}")
        else:
            self._handle_error(404, "Not found")
    
    def execute_mysql_query(self, params):
        if "query" not in params:
            return self._handle_error(400, "Missing query parameter")
        
        query = params["query"]
        db_config = params.get("db_config", default_config)
        
        try:
            conn = mysql.connector.connect(**db_config)
            cursor = conn.cursor(dictionary=True)
            cursor.execute(query)
            
            try:
                # SELECT ì¿¼ë¦¬ ê²°ê³¼ ê°€ì ¸ì˜¤ê¸°
                results = cursor.fetchall()
                # ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìœ¼ë©´ ë‹¤ë¥¸ ìœ í˜•ì˜ ì¿¼ë¦¬ë¡œ ê°„ì£¼
                if not results:
                    conn.commit()
                    results = {"affectedRows": cursor.rowcount}
            except Error:
                # SELECTê°€ ì•„ë‹Œ ì¿¼ë¦¬ (INSERT, UPDATE ë“±) ì²˜ë¦¬
                conn.commit()
                results = {"affectedRows": cursor.rowcount}
            
            cursor.close()
            conn.close()
            
            self._set_headers()
            self.wfile.write(json.dumps({"results": results}).encode())
        except Error as e:
            self._handle_error(500, str(e))

def run_server(port):
    server_address = ('', port)
    try:
        httpd = HTTPServer(server_address, MCPHandler)
        print(f"MySQL MCP server running on port {port}")
        httpd.serve_forever()
    except OSError as e:
        if e.errno == 48:  # Address already in use
            print(f"í¬íŠ¸ {port}ê°€ ì´ë¯¸ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤. MySQL MCP ì„œë²„ê°€ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
            return
        raise  # ë‹¤ë¥¸ OSErrorëŠ” ê·¸ëŒ€ë¡œ ë°œìƒì‹œí‚´

if __name__ == "__main__":
    port = PORT
    run_server(port)
    
    # ì„œë²„ í”„ë¡œì„¸ìŠ¤ ì‹œì‘
    process = subprocess.Popen(
        [python_executable, script_path, str(port)],
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        text=True
    )
    
    st.session_state['mcp_server_process'] = process
    
    # ë¡œê·¸ ìº¡ì²˜ ìŠ¤ë ˆë“œ ì‹œì‘
    def capture_logs():
        while st.session_state['mcp_server_process']:
            line = process.stdout.readline()
            if line:
                st.session_state['mcp_server_logs'].append(line.strip())
                if len(st.session_state['mcp_server_logs']) > 100:
                    st.session_state['mcp_server_logs'].pop(0)
            else:
                time.sleep(0.1)
    
    log_thread = threading.Thread(target=capture_logs)
    log_thread.daemon = True
    log_thread.start()
    
    # ì„œë²„ ì‹œì‘ ëŒ€ê¸°
    for i in range(5):  # ìµœëŒ€ 5ì´ˆ ëŒ€ê¸°
        try:
            # ì„œë²„ ìƒíƒœ í™•ì¸
            response = requests.get(f"http://localhost:{port}/status", timeout=1)
            if response.status_code == 200:
                return True, f"{server_type.upper()} MCP ì„œë²„ê°€ í¬íŠ¸ {port}ì—ì„œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤."
        except:
            pass
        time.sleep(1)
    
    return True, f"{server_type.upper()} MCP ì„œë²„ ì‹œì‘ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ì—°ê²°ì„ ì‹œë„í•˜ì„¸ìš”."
    
except Exception as e:
    return False, f"MCP ì„œë²„ ì‹œì‘ ì˜¤ë¥˜: {str(e)}"

# Function to stop the MCP server
def stop_mcp_server():
    if st.session_state['mcp_server_process'] is None:
        return False, "MCP ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤."
    
    try:
        st.session_state['mcp_server_process'].terminate()
        st.session_state['mcp_server_process'] = None
        return True, "MCP ì„œë²„ê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤."
    except Exception as e:
        return False, f"MCP ì„œë²„ ì¤‘ì§€ ì˜¤ë¥˜: {str(e)}"

class SimpleMCPClient:
    """ê°„ë‹¨í•œ MCP í´ë¼ì´ì–¸íŠ¸ êµ¬í˜„"""
    
    def __init__(self, server_url: str, server_type: str, db_config=None):
        # MCP ì„œë²„ ê¸°ë³¸ í¬íŠ¸ ì„¤ì •
        if ":" not in server_url:
            if server_type == "mysql":
                server_url = f"{server_url}:3000"  # MySQL MCP ì„œë²„ ê¸°ë³¸ í¬íŠ¸
            elif server_type == "perplexity":
                server_url = f"{server_url}:3001"  # Perplexity MCP ì„œë²„ ê¸°ë³¸ í¬íŠ¸
            else:
                server_url = f"{server_url}:3002"  # FireCrawl MCP ì„œë²„ ê¸°ë³¸ í¬íŠ¸
        
        self.server_url = server_url if server_url.startswith(("http://", "https://")) else f"http://{server_url}"
        self.server_type = server_type
        self.is_mcp_server = False
        self.mcp_server_command = None
        self.mcp_server_args = None
        self.mcp_server_type = None
        self.api_key = None
        
        # ì„œë²„ ì„¤ì •
        if server_type == "mysql":
            if db_config:
                self.db_config = db_config
            else:
                self.db_config = {
                    "host": "localhost",
                    "port": 3306,
                    "user": "root",
                    "password": ""
                }
    
    def get_server_info(self):
        """ì„œë²„ ì •ë³´ ì¡°íšŒ"""
        try:
            headers = {}
            if self.api_key:
                headers["Authorization"] = f"Bearer {self.api_key}"
                
            response = requests.get(
                f"{self.server_url}/status",
                headers=headers,
                timeout=5  # 5ì´ˆ íƒ€ì„ì•„ì›ƒ ì„¤ì •
            )
            if response.status_code == 200:
                server_info = response.json()
                # ì„œë²„ì—ì„œ ë°˜í™˜í•œ ìœ í˜• ì •ë³´ê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
                if "type" in server_info:
                    self.server_type = server_info["type"]
                
                if self.server_type == "mysql":
                    server_info["db_config"] = {
                        "host": self.db_config["host"] if hasattr(self, 'db_config') and self.db_config else "localhost",
                        "port": self.db_config["port"] if hasattr(self, 'db_config') and self.db_config else 3306,
                        "user": self.db_config["user"] if hasattr(self, 'db_config') and self.db_config else "root"
                    }
                return server_info
            raise Exception(f"ì„œë²„ ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨: {response.status_code}")
        except requests.exceptions.RequestException as e:
            raise Exception(f"ì„œë²„ ì—°ê²° ì‹¤íŒ¨: {str(e)}")
    
    def execute_tool(self, tool_name: str, params: dict):
        """ë„êµ¬ ì‹¤í–‰"""
        if self.server_type == "mysql" and hasattr(self, 'db_config') and self.db_config:
            # MySQL ì„¤ì • ì¶”ê°€
            params["db_config"] = self.db_config
        
        try:
            headers = {"Content-Type": "application/json"}
            
            # ì„œë²„ ìœ í˜•ì— ë”°ë¼ ì ì ˆí•œ ì¸ì¦ í—¤ë” ì„¤ì •
            if self.api_key:
                if self.server_type == "firecrawl":
                    # FireCrawlì€ Bearer ì¸ì¦ ì‚¬ìš©
                    headers["Authorization"] = f"Bearer {self.api_key}"
                elif self.server_type == "perplexity":
                    # Perplexityë„ Bearer ì¸ì¦ ì‚¬ìš©
                    headers["Authorization"] = f"Bearer {self.api_key}"
                else:
                    # ê¸°íƒ€ ì„œë²„ ìœ í˜•
                    headers["Authorization"] = f"Bearer {self.api_key}"
            
            # ë””ë²„ê·¸ ì •ë³´ ì¶œë ¥
            print(f"ì„œë²„ ìš”ì²­: {self.server_url}/execute")
            print(f"í—¤ë”: {headers}")
            print(f"ìš”ì²­ ë°ì´í„°: tool={tool_name}, params={params}")
                
            try:
                response = requests.post(
                    f"{self.server_url}/execute",
                    headers=headers,
                    json={
                        "tool": tool_name,
                        "parameters": params
                    },
                    timeout=30  # 30ì´ˆ íƒ€ì„ì•„ì›ƒ ì„¤ì •
                )
                
                # ì‘ë‹µ ë””ë²„ê·¸ ì •ë³´
                print(f"ì‘ë‹µ ì½”ë“œ: {response.status_code}")
                print(f"ì‘ë‹µ í—¤ë”: {response.headers}")
                print(f"ì‘ë‹µ ë‚´ìš©: {response.text}")
                
                if response.status_code == 200:
                    try:
                        return response.json()
                    except json.JSONDecodeError as e:
                        print(f"JSON íŒŒì‹± ì˜¤ë¥˜: {str(e)}")
                        if response.text:
                            return {"results": response.text}
                        raise Exception("ì„œë²„ê°€ ë¹ˆ ì‘ë‹µì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤.")
                else:
                    error_message = f"ë„êµ¬ ì‹¤í–‰ ì‹¤íŒ¨: HTTP {response.status_code}"
                    try:
                        error_data = response.json()
                        if isinstance(error_data, dict) and "error" in error_data:
                            error_message += f" - {error_data['error']}"
                    except:
                        if response.text:
                            error_message += f" - {response.text}"
                    raise Exception(error_message)
                    
            except requests.exceptions.Timeout:
                raise Exception("ì„œë²„ ìš”ì²­ ì‹œê°„ ì´ˆê³¼")
            except requests.exceptions.ConnectionError:
                raise Exception("ì„œë²„ ì—°ê²° ì‹¤íŒ¨")
            
        except Exception as e:
            print(f"ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
            raise Exception(f"ì„œë²„ ìš”ì²­ ì‹¤íŒ¨: {str(e)}")
    
    def close(self):
        """ì—°ê²° ì¢…ë£Œ"""
        pass  # HTTP ê¸°ë°˜ì´ë¯€ë¡œ íŠ¹ë³„í•œ ì •ë¦¬ê°€ í•„ìš” ì—†ìŒ

# Function to call Claude API
def call_claude_api(user_input, model="claude-3-5-sonnet-20240620"):
    API_URL = "https://api.anthropic.com/v1/messages"
    
    headers = {
        "Content-Type": "application/json",
        "x-api-key": ANTHROPIC_API_KEY,
        "anthropic-version": "2023-06-01"
    }
    
    payload = {
        "model": model,
        "max_tokens": 1000,
        "messages": [{"role": "user", "content": user_input}]
    }
    
    try:
        response = requests.post(API_URL, json=payload, headers=headers)
        response.raise_for_status()
        sql_query = response.json()["content"][0]["text"].strip()
        return sql_query
    except Exception as e:
        return None, f"Error calling Claude API: {str(e)}"

# Function to initialize MCP server from configuration
def initialize_mcp_server(config_data):
    try:
        # ë””ë²„ê¹…: ì„¤ì • ë°ì´í„° ì¶œë ¥
        st.write("**ì„¤ì • ë°ì´í„° êµ¬ì¡°:**")
        st.json(config_data)
        
        # ì—°ê²° í…ŒìŠ¤íŠ¸ ê±´ë„ˆë›°ê¸° ì˜µì…˜
        skip_connection_test = config_data.get("skipConnectionTest", False)
        
        # API í‚¤ ì„¤ì •
        api_key = config_data.get("apiKey", None)
        
        # MySQL ì„¤ì • ê°€ì ¸ì˜¤ê¸°
        db_config = config_data.get("db_config", None)
        
        # MCP ì„œë²„ ì •ë³´ ì¶”ì¶œ
        is_mcp_server_config = False
        mcp_server_command = None
        mcp_server_args = None
        mcp_server_type = None
        
        # mcpServers ê°ì²´ ê°ì§€ ë° ì •ë³´ ì¶”ì¶œ
        if isinstance(config_data, dict) and "mcpServers" in config_data and config_data["mcpServers"]:
            is_mcp_server_config = True
            server_name = list(config_data["mcpServers"].keys())[0]
            server_config = config_data["mcpServers"][server_name]
            
            if "command" in server_config and "args" in server_config:
                mcp_server_command = server_config["command"]
                mcp_server_args = server_config["args"]
                
                # ì¸ìì—ì„œ ì„œë²„ ìœ í˜• ê°ì§€
                args_str = " ".join(str(arg) for arg in mcp_server_args)
                if "mcp-mysql-server" in args_str or "mysql" in args_str.lower():
                    mcp_server_type = "mysql"
                elif "mcp-perplexity-server" in args_str or "perplexity" in args_str.lower():
                    mcp_server_type = "perplexity"
                elif "mcp-firecrawl-server" in args_str or "firecrawl" in args_str.lower():
                    mcp_server_type = "firecrawl"
                
                # MCP ì„œë²„ ê´€ë ¨ ì •ë³´ í‘œì‹œ
                st.info(f"### MCP ì„œë²„ ì„¤ì • ê°ì§€ë¨ (ìœ í˜•: {mcp_server_type or 'ê°ì§€ ì‹¤íŒ¨'})")
                st.code(f"ì„œë²„ ì´ë¦„: {server_name}\nëª…ë ¹ì–´: {mcp_server_command}\nì¸ì: {' '.join(str(arg) for arg in mcp_server_args)}")
        
        # Extract server parameters from config
        server_url = None
        server_type = None
        
        # ë‹¤ì–‘í•œ ì„¤ì • í˜•ì‹ ì²˜ë¦¬
        if isinstance(config_data, str):
            # ë¬¸ìì—´ì¸ ê²½ìš° URLë¡œ ê°„ì£¼
            server_url = config_data
            server_type = "mysql"  # ê¸°ë³¸ê°’
            st.info(f"ì„¤ì •ì´ ë¬¸ìì—´ë¡œ ì œê³µë˜ì—ˆìŠµë‹ˆë‹¤. URL: {server_url}")
        elif isinstance(config_data, dict):
            # ë”•ì…”ë„ˆë¦¬ í˜•íƒœë¡œ ì œê³µëœ ê²½ìš°
            if "serverUrl" in config_data:
                server_url = config_data["serverUrl"]
                server_type = config_data.get("serverType", "mysql")  # ê¸°ë³¸ê°’ì€ mysql
                st.info(f"serverUrl í˜•ì‹ ë°œê²¬: {server_url}")
            elif "url" in config_data:
                server_url = config_data["url"]
                server_type = config_data.get("type", "mysql")  # ê¸°ë³¸ê°’ì€ mysql
                st.info(f"url í˜•ì‹ ë°œê²¬: {server_url}")
            elif "mcpServers" in config_data and config_data["mcpServers"]:
                # mcpServersì—ì„œ URLì„ ì¶”ì¶œí•´ì•¼ í•¨
                # ê¸°ë³¸ í¬íŠ¸ ì„¤ì •
                if mcp_server_type == "mysql":
                    server_url = "localhost:3000"
                elif mcp_server_type == "perplexity":
                    server_url = "localhost:3001"
                elif mcp_server_type == "firecrawl":
                    server_url = "localhost:3002"
                else:
                    server_url = "localhost:3000"  # ê¸°ë³¸ê°’
                
                # ì„œë²„ ìœ í˜• ì„¤ì • - mcp_server_typeì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’
                server_type = mcp_server_type or "mysql"
                
                st.info(f"mcpServers í˜•ì‹ ë°œê²¬: ê¸°ë³¸ URL {server_url}ë¡œ ì„¤ì •ë¨, ì„œë²„ ìœ í˜•: {server_type}")
            elif "command" in config_data and "args" in config_data:
                # ìŠ¤ë¯¸ì„œë¦¬ ì»¤ë§¨ë“œ í˜•ì‹
                st.info("command/args í˜•ì‹ ë°œê²¬")
                
                # ì¸ìì—ì„œ ì„œë²„ ìœ í˜• ê°ì§€
                args_str = " ".join(str(arg) for arg in config_data.get("args", []))
                if "mcp-mysql-server" in args_str or "mysql" in args_str.lower():
                    server_type = "mysql"
                elif "mcp-perplexity-server" in args_str or "perplexity" in args_str.lower():
                    server_type = "perplexity"
                elif "mcp-firecrawl-server" in args_str or "firecrawl" in args_str.lower():
                    server_type = "firecrawl"
                else:
                    server_type = "mysql"  # ê¸°ë³¸ê°’
                
                server_url = f"localhost:{3000 if server_type=='mysql' else 3001 if server_type=='perplexity' else 3002}"
                
                # argsì—ì„œ í˜¸ìŠ¤íŠ¸/í¬íŠ¸ ì¶”ì¶œ ì‹œë„
                try:
                    args = config_data.get("args", [])
                    for arg in args:
                        if arg.startswith("--host="):
                            host = arg.split("=")[1]
                            server_url = f"{host}:{3000 if server_type=='mysql' else 3001 if server_type=='perplexity' else 3002}"
                        elif arg.startswith("--port="):
                            port = arg.split("=")[1]
                            if ":" in server_url:
                                host = server_url.split(":")[0]
                                server_url = f"{host}:{port}"
                            else:
                                server_url = f"{server_url}:{port}"
                    st.info(f"command/argsì—ì„œ ì¶”ì¶œëœ URL: {server_url}, ì„œë²„ ìœ í˜•: {server_type}")
                except Exception as e:
                    st.error(f"command/args ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {str(e)}")
            else:
                st.warning("ì•Œë ¤ì§„ ì„¤ì • í˜•ì‹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„¤ì • í‚¤:")
                st.write(list(config_data.keys()))
        else:
            st.error(f"ì§€ì›ë˜ì§€ ì•ŠëŠ” ì„¤ì • ë°ì´í„° íƒ€ì…: {type(config_data)}")
        
        # ì„¤ì •ì´ ì—†ëŠ” ê²½ìš°, ê¸°ë³¸ê°’ ì‚¬ìš©
        if not server_url:
            st.warning("ì„œë²„ URLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.")
            server_url = "localhost:3000"
            server_type = "mysql"
        
        # URL í˜•ì‹ í™•ì¸ ë° ìˆ˜ì •
        if not server_url.startswith(("http://", "https://")):
            # HTTP í”„ë¡œí† ì½œ ì¶”ê°€
            if ":" in server_url:
                # í¬íŠ¸ê°€ ìˆëŠ” ê²½ìš°
                host, port = server_url.split(":", 1)
                server_url = f"http://{host}:{port}"
            else:
                # í¬íŠ¸ê°€ ì—†ëŠ” ê²½ìš°
                if server_type == "mysql":
                    server_url = f"http://{server_url}:3000"
                elif server_type == "perplexity":
                    server_url = f"http://{server_url}:3001"
                elif server_type == "firecrawl":
                    server_url = f"http://{server_url}:3002"
            
            st.info(f"URL í˜•ì‹ ìˆ˜ì •: {server_url}")
        
        # í´ë¼ì´ì–¸íŠ¸ ìƒì„±
        st.info(f"ì„œë²„ì— ì—°ê²° ì‹œë„: {server_url}, íƒ€ì…: {server_type}")
        client = SimpleMCPClient(server_url, server_type, db_config)
        
        # API í‚¤ê°€ ìˆìœ¼ë©´ ì„¤ì •
        if api_key:
            client.api_key = api_key
        
        # MCP ì„œë²„ ì„¤ì • ì •ë³´ ì €ì¥
        if is_mcp_server_config:
            client.is_mcp_server = True
            client.mcp_server_command = mcp_server_command
            client.mcp_server_args = mcp_server_args
            client.mcp_server_type = mcp_server_type
        else:
            client.is_mcp_server = False
        
        # ì—°ê²° í…ŒìŠ¤íŠ¸ ê±´ë„ˆë›°ê¸°ê°€ ì„¤ì •ëœ ê²½ìš°
        if skip_connection_test:
            st.warning("ì—°ê²° í…ŒìŠ¤íŠ¸ë¥¼ ê±´ë„ˆë›°ê³  ì„¤ì •ë§Œ ì €ì¥í•©ë‹ˆë‹¤.")
            return client, f"Connection test skipped. Configuration saved for {server_url}"
        
        try:
            # ì—°ê²°ì„± í…ŒìŠ¤íŠ¸ (íƒ€ì„ì•„ì›ƒ 3ì´ˆ)
            response = requests.get(f"{server_url}/status", timeout=3)
            st.success(f"ì„œë²„ ì‘ë‹µ: HTTP {response.status_code}")
            
            # ì •ìƒ ì‘ë‹µì´ ì•„ë‹Œ ê²½ìš°
            if response.status_code != 200:
                st.warning(f"ì„œë²„ê°€ ë¹„ì •ìƒ ì‘ë‹µì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤: HTTP {response.status_code}")
                if st.button("ê·¸ë˜ë„ ê³„ì†í•˜ê¸°"):
                    return client, f"ì„œë²„ê°€ ë¹„ì •ìƒ ì‘ë‹µì„ ë°˜í™˜í–ˆì§€ë§Œ, ì„¤ì •ì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤. ({server_url})"
                else:
                    raise Exception(f"ì„œë²„ê°€ ë¹„ì •ìƒ ì‘ë‹µì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤: HTTP {response.status_code}")
            
            # ì„œë²„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            server_info = client.get_server_info()
            
            # ë„êµ¬ ëª©ë¡ í™•ì¸
            tools = []
            if "tools" in server_info:
                tools = server_info["tools"]
                st.success(f"ì‚¬ìš© ê°€ëŠ¥í•œ ë„êµ¬: {tools}")
            
            return client, f"Successfully connected to {server_url}. Server type: {server_type}"
        except requests.exceptions.ConnectTimeout:
            st.error(f"ì„œë²„ ì—°ê²° ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤: {server_url}")
            # ì‚¬ìš©ìì—ê²Œ ì—°ê²° í…ŒìŠ¤íŠ¸ë¥¼ ê±´ë„ˆë›°ê³  ê³„ì†í•  ìˆ˜ ìˆëŠ” ì˜µì…˜ ì œê³µ
            if st.button("ì—°ê²° ë¬¸ì œê°€ ìˆì§€ë§Œ ê³„ì†í•˜ê¸°"):
                return client, f"ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸ì— ì‹¤íŒ¨í–ˆì§€ë§Œ, ì„¤ì •ì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤. ({server_url})"
            raise
        except requests.exceptions.ConnectionError as e:
            st.error(f"ì„œë²„ ì—°ê²° ì˜¤ë¥˜: {str(e)}")
            
            # ì—°ê²° ì—ëŸ¬ í•´ê²° ì œì•ˆ
            st.markdown("""
            ### ì—°ê²° ì˜¤ë¥˜ í•´ê²° ë°©ë²•
            
            1. **ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”**
            2. **í¬íŠ¸ ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ì„¸ìš”**
            3. **'localhost' ëŒ€ì‹  '127.0.0.1'ì„ ì‹œë„í•´ë³´ì„¸ìš”**
            4. **ë‹¤ë¥¸ í¬íŠ¸ë¡œ ì—°ê²°ì„ ì‹œë„í•´ë³´ì„¸ìš”**
            5. **ë°©í™”ë²½ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”**
            """)
            
            # ì‚¬ìš©ìì—ê²Œ ì—°ê²° í…ŒìŠ¤íŠ¸ë¥¼ ê±´ë„ˆë›°ê³  ê³„ì†í•  ìˆ˜ ìˆëŠ” ì˜µì…˜ ì œê³µ
            if st.button("ì—°ê²° ë¬¸ì œê°€ ìˆì§€ë§Œ ê³„ì†í•˜ê¸°"):
                return client, f"ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸ì— ì‹¤íŒ¨í–ˆì§€ë§Œ, ì„¤ì •ì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤. ({server_url})"
            
            raise
        except Exception as e:
            st.error(f"ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: {str(e)}")
            
            # ì‚¬ìš©ìì—ê²Œ ì—°ê²° í…ŒìŠ¤íŠ¸ë¥¼ ê±´ë„ˆë›°ê³  ê³„ì†í•  ìˆ˜ ìˆëŠ” ì˜µì…˜ ì œê³µ
            if st.button("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì§€ë§Œ ê³„ì†í•˜ê¸°"):
                return client, f"ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì§€ë§Œ, ì„¤ì •ì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤. ({server_url})"
            
            raise
        
    except Exception as e:
        return None, f"Error initializing MCP server: {str(e)}"

# Function to communicate with MCP server
def communicate_with_mcp_server(client, tool_name, params):
    try:
        # Call the tool
        result = client.execute_tool(tool_name, params)
        return result, None
    except Exception as e:
        return None, f"Error communicating with MCP server: {str(e)}"

# Function to convert natural language to SQL using Claude API
def natural_language_to_sql(query: str, model="claude-3-5-sonnet-20240620") -> str:
    API_URL = "https://api.anthropic.com/v1/messages"
    
    system_prompt = '''You are an expert SQL translator. 
Your task is to translate natural language queries into correct SQL statements.
Only return the SQL statement, nothing else. Do not include any explanations or markdown formatting.
If the query does not seem to be asking for a SQL statement, return the original query.
Always make sure the SQL statements are properly formatted and valid.'''
    
    headers = {
        "Content-Type": "application/json",
        "x-api-key": ANTHROPIC_API_KEY,
        "anthropic-version": "2023-06-01"
    }
    
    payload = {
        "model": model,
        "max_tokens": 1000,
        "system": system_prompt,
        "messages": [{"role": "user", "content": f"Convert this natural language query to SQL: {query}"}]
    }
    
    try:
        response = requests.post(API_URL, json=payload, headers=headers)
        response.raise_for_status()
        sql_query = response.json()["content"][0]["text"].strip()
        return sql_query
    except Exception as e:
        return None, f"Error converting to SQL: {str(e)}"

# UI Components
st.title("ğŸ§  Streamlit MCP Host")
st.write("A Streamlit app that functions as an MCP host, using Claude API and connecting to Smithery MCP servers.")

# Sidebar for configuration
with st.sidebar:
    st.header("Configuration")
    
    # MCP Server management
    st.subheader("MCP ì„œë²„ ê´€ë¦¬")
    
    # ì„œë²„ ì‹œì‘/ì¤‘ì§€ ì»¨íŠ¸ë¡¤
    server_col1, server_col2 = st.columns(2)
    
    with server_col1:
        local_server_type = st.selectbox(
            "ì„œë²„ ìœ í˜•",
            ["mysql", "perplexity", "firecrawl"],
            format_func=lambda x: {
                "mysql": "MySQL", 
                "perplexity": "Perplexity", 
                "firecrawl": "FireCrawl"
            }.get(x, x)
        )
    
    with server_col2:
        local_server_port = st.number_input(
            "í¬íŠ¸",
            value=3000 if local_server_type == "mysql" else (3001 if local_server_type == "perplexity" else 3002),
            min_value=1000,
            max_value=9999
        )
    
    # ì„œë²„ ìƒíƒœ í‘œì‹œ
    server_status = "ì •ì§€ë¨"
    if st.session_state['mcp_server_process'] is not None:
        if st.session_state['mcp_server_process'].poll() is None:
            server_status = "ì‹¤í–‰ ì¤‘"
        else:
            server_status = "ë¹„ì •ìƒ ì¢…ë£Œë¨"
            st.session_state['mcp_server_process'] = None
    
    st.metric("ì„œë²„ ìƒíƒœ", server_status)
    
    # ì‹œì‘/ì¤‘ì§€ ë²„íŠ¼
    if st.session_state['mcp_server_process'] is None:
        if st.button("MCP ì„œë²„ ì‹œì‘"):
            success, message = start_mcp_server(local_server_type, local_server_port)
            if success:
                st.success(message)
            else:
                st.error(message)
    else:
        if st.button("MCP ì„œë²„ ì¤‘ì§€"):
            success, message = stop_mcp_server()
            if success:
                st.success(message)
            else:
                st.error(message)
    
    # ì„œë²„ ë¡œê·¸ í‘œì‹œ
    if st.session_state['mcp_server_process'] is not None:
        with st.expander("ì„œë²„ ë¡œê·¸", expanded=False):
            log_text = "\n".join(st.session_state['mcp_server_logs'])
            st.code(log_text)
        
        # ì—°ê²° ì •ë³´ ìë™ ì„¤ì •
        if st.button("ì´ ì„œë²„ì— ì—°ê²°"):
            if local_server_type == "mysql":
                port = local_server_port
                config_name = f"local-mysql-{port}"
                config_data = {
                    "serverUrl": f"http://localhost:{port}",
                    "serverType": "mysql"
                }
            elif local_server_type == "perplexity":
                port = local_server_port
                config_name = f"local-perplexity-{port}"
                config_data = {
                    "serverUrl": f"http://localhost:{port}",
                    "serverType": "perplexity"
                }
            else:
                port = local_server_port
                config_name = f"local-firecrawl-{port}"
                # FireCrawl API í‚¤ë¥¼ í™˜ê²½ì—ì„œ ë¡œë“œ
                firecrawl_api_key = os.getenv("FIRECRAWL_API_KEY", "fc-f4745f41d5fd4e8c9d24d97b65e8a96c")
                config_data = {
                    "serverUrl": f"http://localhost:{port}",
                    "serverType": "firecrawl",
                    "apiKey": firecrawl_api_key  # API í‚¤ ì¶”ê°€
                }
            
            with st.spinner("Connecting to MCP server..."):
                client, message = initialize_mcp_server(config_data)
                
                if client:
                    st.session_state['mcp_configs'][config_name] = {
                        "client": client,
                        "config": config_data,
                        "added_time": datetime.now()
                    }
                    st.success(message)
                else:
                    st.error(message)
    
    # Claude API settings
    st.subheader("Claude API Settings")
    claude_model = st.selectbox(
        "Select Claude Model",
        ["claude-3-5-sonnet-20240620", "claude-3-opus-20240229", "claude-3-haiku-20240307"]
    )
    
    # MCP Server configuration
    st.subheader("MCP ì„œë²„ ì—°ê²°")
    
    # Create tabs for file upload and direct input
    config_tab1, config_tab2, config_tab3, config_tab4 = st.tabs(["Upload JSON File", "Paste JSON", "Quick Connect", "Smithery AI"])
    
    with config_tab1:
        uploaded_file = st.file_uploader("Upload MCP Server JSON Configuration", type=["json"])
        config_data = None
        if uploaded_file is not None:
            try:
                config_data = json.load(uploaded_file)
            except Exception as e:
                st.error(f"Error parsing JSON file: {str(e)}")
    
    # ì‚¬ìš©ì ì¹œí™”ì ì¸ JSON ì§ì ‘ ì…ë ¥ í•„ë“œ
    with config_tab2:
        # JSON ì˜ˆì‹œ ì¶”ê°€
        st.markdown("""
        **JSON ì„¤ì • ì˜ˆì‹œ:**
        ```json
        {
          "serverUrl": "localhost:3000",
          "serverType": "mysql"
        }
        ```
        ë˜ëŠ” ì‹¬í”Œ URLë§Œ ì…ë ¥:
        ```json
        "localhost:3000"
        ```
        
        ë˜ëŠ” Smithery MCP ì„œë²„ ì„¤ì •:
        ```json
        {
          "mcpServers": {
            "mcp-mysql-server": {
              "command": "npx",
              "args": [
                "-y",
                "@smithery/cli@latest",
                "run",
                "@f4ww4z/mcp-mysql-server",
                "--key",
                "your-key-here"
              ]
            }
          }
        }
        ```
        """)
        
        # ì‹¬í”Œ URL ì…ë ¥ ì˜µì…˜
        use_simple_url = st.checkbox("ê°„ë‹¨í•œ URL ì§ì ‘ ì…ë ¥")
        
        if use_simple_url:
            simple_url = st.text_input(
                "ì„œë²„ URL ì…ë ¥",
                value="localhost:3000",
                help="MCP ì„œë²„ URLì„ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: localhost:3000)"
            )
            server_type_option = st.radio(
                "ì„œë²„ íƒ€ì…",
                ["mysql", "perplexity", "firecrawl"]
            )
            
            if simple_url:
                config_data = {"serverUrl": simple_url, "serverType": server_type_option}
                
                # FireCrawlì¸ ê²½ìš° API í‚¤ ì¶”ê°€
                if server_type_option == "firecrawl":
                    firecrawl_api_key = os.getenv("FIRECRAWL_API_KEY", "fc-f4745f41d5fd4e8c9d24d97b65e8a96c")
                    config_data["apiKey"] = firecrawl_api_key
                
                # ì„¤ì • ì´ë¦„ ì…ë ¥ë€ í‘œì‹œ
                config_name = st.text_input(
                    "ì„¤ì • ì´ë¦„",
                    value=f"{server_type_option}-{simple_url}",
                    key="simple_url_config_name"
                )
                
                # ì—°ê²° ë²„íŠ¼
                if st.button("ê°„ë‹¨í•œ URLë¡œ ì—°ê²°", key="simple_url_connect"):
                    with st.spinner("Connecting to MCP server..."):
                        client, message = initialize_mcp_server(config_data)
                        
                        if client:
                            st.session_state['mcp_configs'][config_name] = {
                                "client": client,
                                "config": config_data,
                                "added_time": datetime.now()
                            }
                            st.success(message)
                            st.rerun()
                        else:
                            st.error(message)
                            st.error("ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„¤ì •ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.")
        else:
            json_input = st.text_area(
                "MCP ì„œë²„ JSON ì„¤ì • ë¶™ì—¬ë„£ê¸°",
                height=200,
                help="MCP ì„œë²„ ì„¤ì •ì„ JSON í˜•ì‹ìœ¼ë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”"
            )
            
            json_config_data = None
            if json_input:
                try:
                    json_config_data = json.loads(json_input)
                    
                    # JSONì´ ì„±ê³µì ìœ¼ë¡œ íŒŒì‹±ë˜ì—ˆì„ ë•Œ ì„¤ì • ì´ë¦„ ì…ë ¥ë€ í‘œì‹œ
                    json_config_name = st.text_input(
                        "ì„¤ì • ì´ë¦„",
                        value=f"Config_{int(time.time())}",
                        key="json_config_name"
                    )
                    
                    # MySQL ê´€ë ¨ ì„¤ì •ì¸ ê²½ìš° ì¶”ê°€ ì„¤ì • í•„ë“œ í‘œì‹œ
                    has_mysql = False
                    
                    # mcpServers ê°ì²´ê°€ ìˆê³  ê·¸ ì•ˆì— ì ì–´ë„ í•˜ë‚˜ì˜ ì„œë²„ê°€ ìˆëŠ”ì§€ í™•ì¸
                    if isinstance(json_config_data, dict) and "mcpServers" in json_config_data and json_config_data["mcpServers"]:
                        # mcpServersì—ì„œ ì²« ë²ˆì§¸ ì„œë²„ ê°€ì ¸ì˜¤ê¸°
                        server_name = list(json_config_data["mcpServers"].keys())[0]
                        server_config = json_config_data["mcpServers"][server_name]
                        
                        # ì»¤ë§¨ë“œê°€ ìˆê³  argsì— 'mcp-mysql-server'ê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ MySQL ê´€ë ¨ ì„¤ì •ìœ¼ë¡œ ê°„ì£¼
                        if "command" in server_config and "args" in server_config:
                            args_str = " ".join(str(arg) for arg in server_config["args"])
                            if "mysql" in args_str.lower():
                                has_mysql = True
                    
                    # ì„œë²„ íƒ€ì…ì´ ëª…ì‹œì ìœ¼ë¡œ mysqlì¸ ê²½ìš°ì—ë„ MySQL ì„¤ì • í‘œì‹œ
                    if "serverType" in json_config_data and json_config_data["serverType"] == "mysql":
                        has_mysql = True
                    
                    # MySQL ê´€ë ¨ ì„¤ì •ì¸ ê²½ìš° ì‚¬ìš©ì ì •ë³´ ì…ë ¥ë€ í‘œì‹œ
                    mysql_db_config = None
                    if has_mysql:
                        st.markdown("#### MySQL ì—°ê²° ì„¤ì •")
                        st.warning("JSON ì„¤ì •ì— MySQL ê´€ë ¨ ì„¤ì •ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. MySQL ì—°ê²° ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
                        
                        mysql_col1, mysql_col2 = st.columns(2)
                        with mysql_col1:
                            mysql_host = st.text_input("MySQL í˜¸ìŠ¤íŠ¸", value="localhost", key="json_mysql_host")
                            mysql_user = st.text_input("MySQL ì‚¬ìš©ì", value="root", key="json_mysql_user")
                        with mysql_col2:
                            mysql_port = st.number_input("MySQL í¬íŠ¸", value=3306, min_value=1, max_value=65535, key="json_mysql_port")
                            mysql_password = st.text_input("MySQL ë¹„ë°€ë²ˆí˜¸", type="password", key="json_mysql_password")
                        
                        mysql_db_config = {
                            "host": mysql_host,
                            "port": mysql_port,
                            "user": mysql_user,
                            "password": mysql_password
                        }
                        
                        # MySQL ë°ì´í„°ë² ì´ìŠ¤ ì„ íƒ (ì„ íƒ ì‚¬í•­)
                        mysql_database = st.text_input("MySQL ë°ì´í„°ë² ì´ìŠ¤ (ì„ íƒ ì‚¬í•­)", key="json_mysql_database")
                        if mysql_database:
                            mysql_db_config["database"] = mysql_database
                    
                    # ì—°ê²° ë²„íŠ¼
                    if st.button("JSONìœ¼ë¡œ ì—°ê²°", key="json_connect"):
                        # MySQL ì„¤ì •ì´ ìˆìœ¼ë©´ configì— ì¶”ê°€
                        if mysql_db_config:
                            json_config_data["db_config"] = mysql_db_config
                        
                        with st.spinner("Connecting to MCP server..."):
                            client, message = initialize_mcp_server(json_config_data)
                            
                            if client:
                                st.session_state['mcp_configs'][json_config_name] = {
                                    "client": client,
                                    "config": json_config_data,
                                    "added_time": datetime.now()
                                }
                                st.success(message)
                                st.rerun()
                            else:
                                st.error(message)
                    
                except Exception as e:
                    st.error(f"JSON íŒŒì‹± ì˜¤ë¥˜: {str(e)}")
                    st.error("ì˜¬ë°”ë¥¸ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. ì˜ˆì‹œë¥¼ ì°¸ê³ í•˜ì„¸ìš”.")

    # ë¹ ë¥¸ ì—°ê²° ì˜µì…˜
    with config_tab3:
        st.markdown("### ë¹ ë¥¸ ì—°ê²°")
        
        col1, col2 = st.columns(2)
        with col1:
            host = st.text_input("í˜¸ìŠ¤íŠ¸", value="localhost")
        with col2:
            port = st.number_input("í¬íŠ¸", value=3000, min_value=1, max_value=65535)
        
        server_type = st.radio(
            "ì„œë²„ íƒ€ì…",
            ["mysql", "perplexity", "firecrawl"]
        )
        
        # MySQL ì„¤ì • (ì„ íƒí•œ ì„œë²„ íƒ€ì…ì´ mysqlì¸ ê²½ìš°)
        mysql_db_config = None
        if server_type == "mysql":
            st.markdown("#### MySQL ì—°ê²° ì„¤ì •")
            mysql_host = st.text_input("MySQL í˜¸ìŠ¤íŠ¸", value="localhost", key="quick_mysql_host")
            mysql_port = st.number_input("MySQL í¬íŠ¸", value=3306, min_value=1, max_value=65535, key="quick_mysql_port")
            mysql_user = st.text_input("MySQL ì‚¬ìš©ì", value="root", key="quick_mysql_user")
            mysql_password = st.text_input("MySQL ë¹„ë°€ë²ˆí˜¸", type="password", key="quick_mysql_password")
            
            mysql_db_config = {
                "host": mysql_host,
                "port": mysql_port,
                "user": mysql_user,
                "password": mysql_password
            }
        
        # ê³ ê¸‰ ì˜µì…˜
        with st.expander("ê³ ê¸‰ ì˜µì…˜", expanded=False):
            use_https = st.checkbox("HTTPS ì‚¬ìš©")
            test_connection = st.checkbox("ì—°ê²° í…ŒìŠ¤íŠ¸ ê±´ë„ˆë›°ê¸°", help="ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ì§€ë§Œ ì„¤ì •ì„ ì €ì¥í•˜ë ¤ëŠ” ê²½ìš° ì„ íƒí•˜ì„¸ìš”")
        
        # FireCrawlì¸ ê²½ìš° API í‚¤ ì…ë ¥ í•„ë“œ í‘œì‹œ
        firecrawl_api_key = None
        if server_type == "firecrawl":
            firecrawl_api_key = st.text_input(
                "FireCrawl API í‚¤", 
                value=os.getenv("FIRECRAWL_API_KEY", "fc-f4745f41d5fd4e8c9d24d97b65e8a96c"),
                type="password",
                help="FireCrawl API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
            )
        
        quick_connect_button = st.button("ë¹ ë¥¸ ì—°ê²°", key="quick_connect_button")
        
        if quick_connect_button:
            protocol = "https" if use_https else "http"
            server_url = f"{protocol}://{host}:{port}"
            config_name = f"{server_type}-{host}-{port}"
            
            config_data = {
                "serverUrl": server_url,
                "serverType": server_type,
                "skipConnectionTest": test_connection
            }
            
            # MySQL ì„¤ì •ì´ ìˆìœ¼ë©´ ì¶”ê°€
            if mysql_db_config:
                config_data["db_config"] = mysql_db_config
            
            # FireCrawl API í‚¤ê°€ ìˆìœ¼ë©´ ì¶”ê°€
            if server_type == "firecrawl" and firecrawl_api_key:
                config_data["apiKey"] = firecrawl_api_key
            
            st.info(f"MCP ì„œë²„ {server_url}ì— ì—°ê²° ì¤‘...")
            
            with st.spinner("Connecting to MCP server..."):
                client, message = initialize_mcp_server(config_data)
                
                if client:
                    st.session_state['mcp_configs'][config_name] = {
                        "client": client,
                        "config": config_data,
                        "added_time": datetime.now()
                    }
                    st.success(message)
                    # ì„¸ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸ í›„ í˜ì´ì§€ ë¦¬í”„ë ˆì‹œ
                    st.rerun()
                else:
                    st.error(message)

    # Smithery AI MCP ì„œë²„ ì—°ê²°
    with config_tab4:
        st.markdown("### Smithery AI MCP ì„œë²„ ì—°ê²°")
        
        st.markdown("""
        Smithery AIëŠ” ì—¬ëŸ¬ ìœ í˜•ì˜ MCP ì„œë²„ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ì›í•˜ëŠ” ì„œë²„ë¥¼ ì„ íƒí•˜ê³  ì—°ê²°í•˜ì„¸ìš”.
        
        Smithery AI ê³„ì •ì—ì„œ ì œê³µí•˜ëŠ” MCP ì„œë²„ URLê³¼ API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.
        """)
        
        # Smithery ì„œë²„ ì„ íƒ
        smithery_server_type = st.selectbox(
            "Smithery AI ì„œë²„ ìœ í˜•",
            ["mysql", "perplexity", "firecrawl", "postgres", "azure-openai", "anthropic", "gemini"],
            format_func=lambda x: {
                "mysql": "MySQL",
                "perplexity": "Perplexity",
                "firecrawl": "FireCrawl",
                "postgres": "PostgreSQL",
                "azure-openai": "Azure OpenAI",
                "anthropic": "Anthropic",
                "gemini": "Google Gemini"
            }.get(x, x)
        )
        
        # MySQL ì„¤ì • (ì„ íƒí•œ ì„œë²„ íƒ€ì…ì´ mysqlì¸ ê²½ìš°)
        mysql_db_config = None
        if smithery_server_type == "mysql":
            st.markdown("#### MySQL ì—°ê²° ì„¤ì •")
            mysql_host = st.text_input("MySQL í˜¸ìŠ¤íŠ¸", value="localhost", key="smithery_mysql_host")
            mysql_port = st.number_input("MySQL í¬íŠ¸", value=3306, min_value=1, max_value=65535, key="smithery_mysql_port")
            mysql_user = st.text_input("MySQL ì‚¬ìš©ì", value="root", key="smithery_mysql_user")
            mysql_password = st.text_input("MySQL ë¹„ë°€ë²ˆí˜¸", type="password", key="smithery_mysql_password")
            
            mysql_db_config = {
                "host": mysql_host,
                "port": mysql_port,
                "user": mysql_user,
                "password": mysql_password
            }
        
        # ì„œë²„ URL ì„¤ì •
        smithery_url = st.text_input(
            "Smithery MCP ì„œë²„ URL",
            value="",
            placeholder="ì˜ˆ: https://your-smithery-subdomain.smithery.host",
            help="Smithery AIì—ì„œ ì œê³µí•œ MCP ì„œë²„ URLì„ ì…ë ¥í•˜ì„¸ìš”"
        )
        
        # API í‚¤ ì…ë ¥
        smithery_api_key = st.text_input(
            "Smithery API í‚¤ (ì„ íƒì‚¬í•­)",
            type="password",
            help="Smithery API í‚¤ê°€ í•„ìš”í•œ ê²½ìš° ì…ë ¥í•˜ì„¸ìš”"
        )
        
        # Smithery ì„¤ì • ì´ë¦„
        smithery_config_name = st.text_input(
            "ì„¤ì • ì´ë¦„",
            value=f"smithery-{smithery_server_type}",
            help="ì´ ì„¤ì •ì„ ì‹ë³„í•˜ê¸° ìœ„í•œ ì´ë¦„"
        )
        
        # ì—°ê²° ë²„íŠ¼
        smithery_connect_button = st.button("Smithery ì„œë²„ì— ì—°ê²°", key="smithery_connect_button")
        
        if smithery_connect_button:
            if not smithery_url:
                st.error("Smithery MCP ì„œë²„ URLì„ ì…ë ¥í•˜ì„¸ìš”")
            else:
                # URL í˜•ì‹ í™•ì¸
                if not smithery_url.startswith(("http://", "https://")):
                    smithery_url = f"https://{smithery_url}"
                
                # ì„¤ì • ìƒì„±
                smithery_config = {
                    "serverUrl": smithery_url,
                    "serverType": smithery_server_type
                }
                
                # API í‚¤ê°€ ìˆìœ¼ë©´ ì¶”ê°€
                if smithery_api_key:
                    smithery_config["apiKey"] = smithery_api_key
                
                # MySQL ì„¤ì •ì´ ìˆìœ¼ë©´ ì¶”ê°€
                if mysql_db_config:
                    smithery_config["db_config"] = mysql_db_config
                
                # ì—°ê²° í…ŒìŠ¤íŠ¸ ê±´ë„ˆë›°ê¸° ì˜µì…˜
                smithery_config["skipConnectionTest"] = st.checkbox(
                    "ì—°ê²° í…ŒìŠ¤íŠ¸ ê±´ë„ˆë›°ê¸°", 
                    value=False,
                    help="ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ì§€ë§Œ ì„¤ì •ì„ ì €ì¥í•˜ë ¤ëŠ” ê²½ìš° ì„ íƒí•˜ì„¸ìš”"
                )
                
                config_data = smithery_config
                config_name = smithery_config_name
                
                st.info(f"Smithery MCP ì„œë²„ {smithery_url}ì— ì—°ê²° ì¤‘...")
                
                with st.spinner("Connecting to Smithery MCP server..."):
                    client, message = initialize_mcp_server(config_data)
                    
                    if client:
                        st.session_state['mcp_configs'][config_name] = {
                            "client": client,
                            "config": config_data,
                            "added_time": datetime.now()
                        }
                        st.success(message)
                        # ì„¸ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸ í›„ í˜ì´ì§€ ë¦¬í”„ë ˆì‹œ
                        st.rerun()
                    else:
                        st.error(message)

    # Display added configurations
    if st.session_state['mcp_configs']:
        st.subheader("Added MCP Servers")
        for config_name in st.session_state['mcp_configs']:
            st.write(f"- {config_name}")

# Main interface
tab1, tab2 = st.tabs(["Chat", "MCP Tools"])

# Chat tab
with tab1:
    st.header("Chat with Claude")
    
    # Display chat history
    for message in st.session_state['chat_history']:
        if message["role"] == "user":
            st.write(f"You: {message['content']}")
        else:
            st.write(f"Claude: {message['content']}")
    
    # Chat input
    user_input = st.text_area("Enter your message:", height=100)
    
    if st.button("Send to Claude"):
        if user_input:
            # Add user message to history
            st.session_state['chat_history'].append({"role": "user", "content": user_input})
            
            # Call Claude API
            response, error = call_claude_api(user_input, model=claude_model)
            
            if response:
                # Add Claude response to history
                st.session_state['chat_history'].append({"role": "assistant", "content": response})
                st.rerun()
            else:
                st.error(error)

# MCP Tools tab
with tab2:
    st.header("MCP Tools")
    
    if not st.session_state['mcp_configs']:
        st.info("Please add an MCP server configuration in the sidebar first.")
    else:
        # Select MCP configuration
        selected_config = st.selectbox(
            "Select MCP Server Configuration",
            list(st.session_state['mcp_configs'].keys())
        )
        
        if selected_config:
            client = st.session_state['mcp_configs'][selected_config]["client"]
            server_type = client.server_type
            
            # ì„œë²„ ì •ë³´ í‘œì‹œ
            with st.expander("MCP ì„œë²„ ì—°ê²° ì •ë³´", expanded=True):
                st.markdown(f"**ì„œë²„ ìœ í˜•**: {server_type}")
                st.markdown(f"**ì„œë²„ URL**: {client.server_url}")
                
                if client.is_mcp_server:
                    st.markdown("### Smithery MCP ì„œë²„ ì •ë³´")
                    st.markdown(f"**ëª…ë ¹ì–´**: `{client.mcp_server_command}`")
                    if client.mcp_server_args:
                        st.markdown("**ì¸ì**:")
                        for arg in client.mcp_server_args:
                            st.markdown(f"- `{arg}`")
                    
                    # MCP ì„œë²„ ìœ í˜• í‘œì‹œ
                    if hasattr(client, 'mcp_server_type') and client.mcp_server_type:
                        st.markdown(f"**MCP ì„œë²„ ìœ í˜•**: `{client.mcp_server_type}`")
                    
                    # íŠ¹ë³„íˆ keyê°€ ìˆëŠ” ê²½ìš° ë§ˆìŠ¤í‚¹í•˜ì—¬ í‘œì‹œ
                    for arg in client.mcp_server_args or []:
                        if "--key" in str(arg):
                            key_index = client.mcp_server_args.index(arg) + 1
                            if key_index < len(client.mcp_server_args):
                                key_value = client.mcp_server_args[key_index]
                                # í‚¤ ì¼ë¶€ ë§ˆìŠ¤í‚¹
                                if len(str(key_value)) > 8:
                                    masked_key = str(key_value)[:4] + "*" * (len(str(key_value)) - 8) + str(key_value)[-4:]
                                    st.markdown(f"**API í‚¤**: `{masked_key}`")
                
                # MySQL ì—°ê²° ì •ë³´
                if server_type == "mysql" and hasattr(client, 'db_config') and client.db_config:
                    st.markdown("### MySQL ì—°ê²° ì •ë³´")
                    st.markdown(f"**í˜¸ìŠ¤íŠ¸**: `{client.db_config.get('host', 'N/A')}`")
                    st.markdown(f"**í¬íŠ¸**: `{client.db_config.get('port', 'N/A')}`")
                    st.markdown(f"**ì‚¬ìš©ì**: `{client.db_config.get('user', 'N/A')}`")
                    # ë¹„ë°€ë²ˆí˜¸ëŠ” ë³´ì•ˆì„ ìœ„í•´ ë§ˆìŠ¤í‚¹
                    if 'password' in client.db_config and client.db_config['password']:
                        st.markdown("**ë¹„ë°€ë²ˆí˜¸**: `********`")
            
            # ì„œë²„ ìœ í˜•ì— ë”°ë¥¸ ë„êµ¬ í‘œì‹œ
            if server_type == "mysql":
                tool_name = "mysql_query"
                st.subheader("MySQL Query")
                st.markdown("""
                MySQL ì¿¼ë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ìì—°ì–´ ë˜ëŠ” SQL ë¬¸ë²•ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                ì˜ˆì‹œ:
                - "ëª¨ë“  ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë³´ì—¬ì¤˜"
                - "Show me all tables in the current database"
                - "SELECT * FROM users LIMIT 5"
                """)
                
                # ì¿¼ë¦¬ ì…ë ¥
                query = st.text_area("ì¿¼ë¦¬ ì…ë ¥:", height=100)
                
                # ìì—°ì–´ ì²˜ë¦¬ ì˜µì…˜
                use_claude_for_nl = st.checkbox("ìì—°ì–´ ì¿¼ë¦¬ë¥¼ SQLë¡œ ë³€í™˜ (Claude API ì‚¬ìš©)", value=True)
                
                # ì¿¼ë¦¬ ì‹¤í–‰ ì „ ì¿¼ë¦¬ ë¯¸ë¦¬ë³´ê¸°
                if st.button("ì¿¼ë¦¬ ë³€í™˜ ë¯¸ë¦¬ë³´ê¸°") and query:
                    if use_claude_for_nl and ANTHROPIC_API_KEY:
                        with st.spinner("ìì—°ì–´ë¥¼ SQLë¡œ ë³€í™˜ ì¤‘..."):
                            sql_query = natural_language_to_sql(query)
                            if sql_query:
                                st.code(sql_query, language="sql")
                                st.session_state.last_converted_sql = sql_query
                            else:
                                st.error("SQL ë³€í™˜ ì‹¤íŒ¨")
                    else:
                        st.info("ì›ë³¸ ì¿¼ë¦¬ê°€ ê·¸ëŒ€ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.")
                        st.code(query)
                        st.session_state.last_converted_sql = query
                
                # ì‹¤í–‰ ë²„íŠ¼ - SQLë¡œ ë³€í™˜ í›„ ì‹¤í–‰
                if st.button("ì‹¤í–‰"):
                    if query:
                        # ìì—°ì–´ë¥¼ SQLë¡œ ë³€í™˜ (ì˜µì…˜ ë° API í‚¤ê°€ ìˆëŠ” ê²½ìš°)
                        execute_query = query
                        if use_claude_for_nl and ANTHROPIC_API_KEY:
                            with st.spinner("ìì—°ì–´ë¥¼ SQLë¡œ ë³€í™˜ ì¤‘..."):
                                sql_query = natural_language_to_sql(query)
                                if sql_query:
                                    st.info("ìì—°ì–´ê°€ SQLë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.")
                                    st.code(sql_query, language="sql")
                                    execute_query = sql_query
                                else:
                                    st.warning("SQL ë³€í™˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì›ë³¸ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.")
                        
                        # ë§ˆì§€ë§‰ìœ¼ë¡œ ë¯¸ë¦¬ë³´ê¸°í•œ SQLì´ ìˆë‹¤ë©´ ê·¸ê²ƒì„ ì‚¬ìš©
                        if 'last_converted_sql' in st.session_state and use_claude_for_nl:
                            execute_query = st.session_state.last_converted_sql
                        
                        # ì¿¼ë¦¬ ì‹¤í–‰
                        with st.spinner("ì¿¼ë¦¬ ì‹¤í–‰ ì¤‘..."):
                            params = {"query": execute_query, "format": "json"}
                            result, error = communicate_with_mcp_server(client, tool_name, params)
                            
                            if result:
                                st.subheader("ì¿¼ë¦¬ ê²°ê³¼")
                                st.json(result)
                                
                                # ì¿¼ë¦¬ íˆìŠ¤í† ë¦¬ ì €ì¥ (ì˜µì…˜)
                                if 'query_history' not in st.session_state:
                                    st.session_state.query_history = []
                                
                                st.session_state.query_history.append({
                                    'original_query': query,
                                    'executed_query': execute_query,
                                    'timestamp': datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                                    'success': True
                                })
                            else:
                                st.error(error)
                                
                                # ì‹¤íŒ¨í•œ ì¿¼ë¦¬ë„ íˆìŠ¤í† ë¦¬ì— ì €ì¥
                                if 'query_history' not in st.session_state:
                                    st.session_state.query_history = []
                                
                                st.session_state.query_history.append({
                                    'original_query': query,
                                    'executed_query': execute_query,
                                    'timestamp': datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                                    'success': False,
                                    'error': error
                                })
            
            elif server_type == "perplexity":
                tool_name = "search"
                st.subheader("Perplexity Search")
                st.markdown("""
                ê²€ìƒ‰í•˜ê³  ì‹¶ì€ ë‚´ìš©ì„ ìì—°ì–´ë¡œ ì…ë ¥í•˜ì„¸ìš”. Perplexity APIë¥¼ í†µí•´ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì–»ìŠµë‹ˆë‹¤.
                ì˜ˆì‹œ:
                - "ìµœì‹  ë¨¸ì‹ ëŸ¬ë‹ ì—°êµ¬ ë™í–¥"
                - "ì—ë„ˆì§€ íš¨ìœ¨ì„ ë†’ì´ëŠ” ìµœì‹  ê¸°ìˆ "
                - "ì§€ì† ê°€ëŠ¥í•œ ë†ì—… ë°©ë²•"
                """)
                
                query = st.text_area("ê²€ìƒ‰ ì¿¼ë¦¬:", height=100)
                
                # ê²€ìƒ‰ ë²„íŠ¼
                if st.button("ê²€ìƒ‰"):
                    if query:
                        with st.spinner("Perplexity ê²€ìƒ‰ ì¤‘..."):
                            params = {"query": query, "format": "json"}
                            result, error = communicate_with_mcp_server(client, tool_name, params)
                            
                            if result:
                                st.subheader("ê²€ìƒ‰ ê²°ê³¼")
                                
                                # ì‘ë‹µì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ ë° í‘œì‹œ
                                if "results" in result and isinstance(result["results"], dict):
                                    perplexity_result = result["results"]
                                    
                                    if "choices" in perplexity_result and perplexity_result["choices"]:
                                        content = perplexity_result["choices"][0].get("message", {}).get("content", "")
                                        
                                        if content:
                                            st.markdown(f"### ë‹µë³€\n{content}")
                                        
                                        # ì¸ìš© ì •ë³´ í‘œì‹œ
                                        if "citations" in perplexity_result and perplexity_result["citations"]:
                                            st.markdown("### ì¶œì²˜")
                                            for citation in perplexity_result["citations"]:
                                                if isinstance(citation, dict):
                                                    title = citation.get('title', 'Source')
                                                    url = citation.get('url', '#')
                                                    st.markdown(f"- [{title}]({url})")
                                                elif isinstance(citation, str):
                                                    st.markdown(f"- {citation}")
                                                else:
                                                    st.markdown(f"- {str(citation)}")
                                
                                # ì›ë³¸ ì‘ë‹µ ë°ì´í„° (ì ‘ê¸° í˜•íƒœë¡œ í‘œì‹œ)
                                with st.expander("ì›ë³¸ ì‘ë‹µ ë°ì´í„°", expanded=False):
                                    st.json(result)
                            else:
                                st.error(error)
            
            elif server_type == "firecrawl":
                st.subheader("FireCrawl Tools")
                
                # íƒ­ ìƒì„±
                firecrawl_tab1, firecrawl_tab2 = st.tabs(["Search", "Crawl"])
                
                with firecrawl_tab1:
                    st.markdown("""
                    ### FireCrawl Search
                    
                    ê²€ìƒ‰í•˜ê³  ì‹¶ì€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”. FireCrawl APIë¥¼ í†µí•´ ì›¹ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì–»ìŠµë‹ˆë‹¤.
                    """)
                    
                    search_query = st.text_area("ê²€ìƒ‰ì–´:", height=100)
                    max_results = st.slider("ìµœëŒ€ ê²°ê³¼ ìˆ˜", min_value=1, max_value=50, value=10)
                    
                    # ê²€ìƒ‰ ë²„íŠ¼
                    if st.button("ì›¹ ê²€ìƒ‰", key="firecrawl_search"):
                        if search_query:
                            with st.spinner("FireCrawl ê²€ìƒ‰ ì¤‘..."):
                                params = {"query": search_query, "max_results": max_results, "format": "json"}
                                result, error = communicate_with_mcp_server(client, "search", params)
                                
                                if result:
                                    st.subheader("ê²€ìƒ‰ ê²°ê³¼")
                                    
                                    # ê²°ê³¼ í‘œì‹œ
                                    if "results" in result:
                                        firecrawl_results = result["results"]
                                        
                                        if isinstance(firecrawl_results, dict) and "results" in firecrawl_results:
                                            for item in firecrawl_results["results"]:
                                                with st.expander(item.get("title", "ê²€ìƒ‰ ê²°ê³¼")):
                                                    st.markdown(f"**URL**: [{item.get('url', '#')}]({item.get('url', '#')})")
                                                    st.markdown(f"**ë‚´ìš©**: {item.get('content', '')}")
                                        else:
                                            st.json(firecrawl_results)
                                    
                                    # ì›ë³¸ ì‘ë‹µ ë°ì´í„°
                                    with st.expander("ì›ë³¸ ì‘ë‹µ ë°ì´í„°", expanded=False):
                                        st.json(result)
                                else:
                                    st.error(error)
                
                with firecrawl_tab2:
                    st.markdown("""
                    ### FireCrawl Web Crawling
                    
                    í¬ë¡¤ë§í•˜ë ¤ëŠ” ì›¹ í˜ì´ì§€ì˜ URLì„ ì…ë ¥í•˜ì„¸ìš”. FireCrawl APIë¥¼ í†µí•´ í˜ì´ì§€ ë‚´ìš©ì„ ì¶”ì¶œí•©ë‹ˆë‹¤.
                    """)
                    
                    crawl_url = st.text_input("ì›¹ í˜ì´ì§€ URL:", placeholder="https://example.com")
                    include_links = st.checkbox("ë§í¬ í¬í•¨", value=False)
                    include_images = st.checkbox("ì´ë¯¸ì§€ ì •ë³´ í¬í•¨", value=False)
                    
                    # í¬ë¡¤ë§ ë²„íŠ¼
                    if st.button("í˜ì´ì§€ í¬ë¡¤ë§", key="firecrawl_crawl"):
                        if crawl_url:
                            with st.spinner("ì›¹ í˜ì´ì§€ í¬ë¡¤ë§ ì¤‘..."):
                                params = {
                                    "url": crawl_url, 
                                    "include_links": include_links, 
                                    "include_images": include_images,
                                    "format": "json"
                                }
                                result, error = communicate_with_mcp_server(client, "crawl", params)
                                
                                if result:
                                    st.subheader("í¬ë¡¤ë§ ê²°ê³¼")
                                    
                                    # ê²°ê³¼ í‘œì‹œ
                                    if "results" in result:
                                        crawl_results = result["results"]
                                        
                                        if isinstance(crawl_results, dict):
                                            st.markdown(f"**ì œëª©**: {crawl_results.get('title', '(ì œëª© ì—†ìŒ)')}")
                                            st.markdown(f"**URL**: {crawl_results.get('url', crawl_url)}")
                                            
                                            with st.expander("ë³¸ë¬¸ ë‚´ìš©", expanded=True):
                                                st.markdown(crawl_results.get("content", "(ë‚´ìš© ì—†ìŒ)"))
                                            
                                            if include_links and "links" in crawl_results:
                                                with st.expander("ë°œê²¬ëœ ë§í¬", expanded=False):
                                                    for link in crawl_results["links"]:
                                                        st.markdown(f"- [{link.get('text', link.get('url', '#'))}]({link.get('url', '#')})")
                                            
                                            if include_images and "images" in crawl_results:
                                                with st.expander("ë°œê²¬ëœ ì´ë¯¸ì§€", expanded=False):
                                                    for image in crawl_results["images"]:
                                                        st.markdown(f"- ![ì´ë¯¸ì§€]({image.get('src', '#')})")
                                                        st.markdown(f"  - Alt: {image.get('alt', '(ëŒ€ì²´ í…ìŠ¤íŠ¸ ì—†ìŒ)')}")
                                        else:
                                            st.json(crawl_results)
                                    
                                    # ì›ë³¸ ì‘ë‹µ ë°ì´í„°
                                    with st.expander("ì›ë³¸ ì‘ë‹µ ë°ì´í„°", expanded=False):
                                        st.json(result)
                                else:
                                    st.error(error)
            
            else:
                st.info(f"ì„œë²„ ìœ í˜• '{server_type}'ì— ëŒ€í•œ ì¸í„°í˜ì´ìŠ¤ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
                st.write("ì•„ë˜ ì •ë³´ë¥¼ í™•ì¸í•˜ì—¬ ì„œë²„ì— ì í•©í•œ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”:")
                
                # ì„œë²„ ìƒíƒœ ì •ë³´ ìš”ì²­
                try:
                    server_info = client.get_server_info()
                    st.json(server_info)
                    
                    # ë„êµ¬ ëª©ë¡ í‘œì‹œ
                    if "tools" in server_info and server_info["tools"]:
                        st.subheader("ì‚¬ìš© ê°€ëŠ¥í•œ ë„êµ¬")
                        for tool in server_info["tools"]:
                            st.markdown(f"- `{tool}`")
                except Exception as e:
                    st.error(f"ì„œë²„ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨: {str(e)}")

# Footer
st.markdown("---")
st.caption("Streamlit MCP Host Application")

def get_db_config():
    """Get database configuration from session state or environment variables"""
    # Default configuration
    config = {
        'host': 'localhost',
        'user': 'root',
        'password': '',
        'database': 'smithery',
        'raise_on_warnings': True
    }
    
    # Override with session state values if available
    if 'db_config' in st.session_state:
        for key in st.session_state.db_config:
            if key in config and st.session_state.db_config[key]:
                config[key] = st.session_state.db_config[key]
    
    return config

def save_mcp_server_config(server_name, server_type, server_url, config_json):
    """MCP ì„œë²„ ì„¤ì •ì„ DBì— ì €ì¥"""
    try:
        conn = mysql.connector.connect(
            user=os.getenv('SQL_USER'),
            password=os.getenv('SQL_PASSWORD'),
            host=os.getenv('SQL_HOST'),
            database=os.getenv('SQL_DATABASE_NEWBIZ'),
            charset='utf8mb4'
        )
        cursor = conn.cursor()

        # ê¸°ì¡´ ì„¤ì •ì´ ìˆëŠ”ì§€ í™•ì¸
        cursor.execute(
            "SELECT config_id FROM mcp_server_configs WHERE server_name = %s",
            (server_name,)
        )
        existing = cursor.fetchone()

        if existing:
            # ê¸°ì¡´ ì„¤ì • ì—…ë°ì´íŠ¸
            cursor.execute("""
                UPDATE mcp_server_configs 
                SET server_type = %s, server_url = %s, config_json = %s, updated_at = NOW()
                WHERE server_name = %s
            """, (server_type, server_url, config_json, server_name))
        else:
            # ìƒˆ ì„¤ì • ì €ì¥
            cursor.execute("""
                INSERT INTO mcp_server_configs 
                (server_name, server_type, server_url, config_json)
                VALUES (%s, %s, %s, %s)
            """, (server_name, server_type, server_url, config_json))

        conn.commit()
        return True, "ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."

    except Exception as e:
        return False, f"ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}"
    finally:
        cursor.close()
        conn.close()

def get_mcp_server_configs():
    """ì €ì¥ëœ MCP ì„œë²„ ì„¤ì • ëª©ë¡ ì¡°íšŒ"""
    try:
        conn = mysql.connector.connect(
            user=os.getenv('SQL_USER'),
            password=os.getenv('SQL_PASSWORD'),
            host=os.getenv('SQL_HOST'),
            database=os.getenv('SQL_DATABASE_NEWBIZ'),
            charset='utf8mb4'
        )
        cursor = conn.cursor(dictionary=True)

        cursor.execute("""
            SELECT * FROM mcp_server_configs 
            WHERE is_active = TRUE 
            ORDER BY created_at DESC
        """)
        
        return cursor.fetchall()

    except Exception as e:
        st.error(f"ì„¤ì • ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
        return []
    finally:
        cursor.close()
        conn.close()

def get_mcp_server_config(server_name):
    """íŠ¹ì • MCP ì„œë²„ ì„¤ì • ì¡°íšŒ"""
    try:
        conn = mysql.connector.connect(
            user=os.getenv('SQL_USER'),
            password=os.getenv('SQL_PASSWORD'),
            host=os.getenv('SQL_HOST'),
            database=os.getenv('SQL_DATABASE_NEWBIZ'),
            charset='utf8mb4'
        )
        cursor = conn.cursor(dictionary=True)

        cursor.execute("""
            SELECT * FROM mcp_server_configs 
            WHERE server_name = %s AND is_active = TRUE
        """, (server_name,))
        
        return cursor.fetchone()

    except Exception as e:
        st.error(f"ì„¤ì • ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
        return None
    finally:
        cursor.close()
        conn.close()

def delete_mcp_config(server_name):
    """MCP ì„œë²„ ì„¤ì • ì‚­ì œ (soft delete)"""
    try:
        conn = mysql.connector.connect(
            user=os.getenv('SQL_USER'),
            password=os.getenv('SQL_PASSWORD'),
            host=os.getenv('SQL_HOST'),
            database=os.getenv('SQL_DATABASE_NEWBIZ'),
            charset='utf8mb4'
        )
        cursor = conn.cursor()

        cursor.execute("""
            UPDATE mcp_server_configs 
            SET is_active = FALSE 
            WHERE server_name = %s
        """, (server_name,))

        conn.commit()
        return True, "ì„¤ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."

    except Exception as e:
        return False, f"ì„¤ì • ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}"
    finally:
        cursor.close()
        conn.close()

# Update the sidebar to include saved configurations
def show_sidebar():
    st.sidebar.title("MCP ì„œë²„ ì„¤ì •")
    
    # ì €ì¥ëœ ì„¤ì • ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    saved_configs = get_mcp_server_configs()
    
    # ìƒˆë¡œìš´ ì„¤ì • ì¶”ê°€ ë˜ëŠ” ì €ì¥ëœ ì„¤ì • ì„ íƒ
    config_option = st.sidebar.radio(
        "ì„¤ì • ì„ íƒ",
        ["ì €ì¥ëœ ì„¤ì • ì‚¬ìš©", "ìƒˆë¡œìš´ ì„¤ì •"]
    )
    
    if config_option == "ì €ì¥ëœ ì„¤ì • ì‚¬ìš©":
        if saved_configs:
            st.sidebar.subheader("ì €ì¥ëœ ì„¤ì • ëª©ë¡")
            selected_config = st.sidebar.selectbox(
                "ì„¤ì •ì„ ì„ íƒí•˜ì„¸ìš”",
                options=saved_configs,
                format_func=lambda x: f"{x['server_name']} ({x['server_type']})"
            )
            
            if selected_config:
                st.sidebar.subheader("ì„ íƒëœ ì„¤ì • ì •ë³´")
                st.sidebar.write(f"ì„œë²„ ìœ í˜•: {selected_config['server_type']}")
                st.sidebar.write(f"ì„œë²„ URL: {selected_config['server_url']}")
                
                with st.sidebar.expander("ì„¤ì • ìƒì„¸ ì •ë³´"):
                    st.json(selected_config['config_json'])
                
                col1, col2 = st.sidebar.columns(2)
                with col1:
                    if st.button("ì„¤ì • ì‚¬ìš©"):
                        return json.loads(selected_config['config_json'])
                with col2:
                    if st.button("ì„¤ì • ì‚­ì œ"):
                        success, message = delete_mcp_config(selected_config['server_name'])
                        if success:
                            st.sidebar.success(message)
                            st.rerun()
                        else:
                            st.sidebar.error(message)
        else:
            st.sidebar.warning("ì €ì¥ëœ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.")
    
    else:  # ìƒˆë¡œìš´ ì„¤ì •
        st.sidebar.subheader("ìƒˆ ì„œë²„ ì„¤ì •")
        server_type = st.sidebar.selectbox(
            "ì„œë²„ ìœ í˜•", 
            ["MySQL", "Perplexity", "Claude"],
            key="new_server_type"
        )
        server_url = st.sidebar.text_input(
            "ì„œë²„ URL", 
            "http://localhost:8000",
            key="new_server_url"
        )
        
        # ì„œë²„ ìœ í˜•ì— ë”°ë¥¸ JSON í…œí”Œë¦¿ ì œê³µ
        template = {
            "MySQL": {
                "server_type": "MySQL",
                "server_url": server_url,
                "mysql_settings": {
                    "host": "localhost",
                    "port": 3306,
                    "username": "iotuser",
                    "password": "iot12345",
                    "database": "newbiz"
                }
            },
            "Perplexity": {
                "server_type": "Perplexity",
                "server_url": server_url,
                "api_key": "your_api_key_here"
            },
            "Claude": {
                "server_type": "Claude",
                "server_url": server_url,
                "api_key": "your_api_key_here",
                "model": "claude-3-sonnet"
            }
        }
        
        st.sidebar.subheader("JSON ì„¤ì •")
        with st.sidebar.expander("ì„¤ì • í…œí”Œë¦¿ ë³´ê¸°"):
            st.code(json.dumps(template[server_type], indent=2))
        
        config_json = st.sidebar.text_area(
            "ì„¤ì •ì„ JSON í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”",
            value=json.dumps(template[server_type], indent=2),
            height=300,
            key="new_config_json"
        )
        
        try:
            config_data = json.loads(config_json)
            server_name = st.sidebar.text_input(
                "ì„¤ì • ì´ë¦„",
                value=f"{server_type} Server",
                key="new_server_name"
            )
            
            if st.sidebar.button("ì„¤ì • ì €ì¥", key="save_config"):
                if server_name:
                    success, message = save_mcp_server_config(
                        server_name,
                        server_type,
                        server_url,
                        config_json
                    )
                    if success:
                        st.sidebar.success(message)
                        st.rerun()
                    else:
                        st.sidebar.error(message)
            
            return config_data
                
        except json.JSONDecodeError as e:
            st.sidebar.error(f"ì˜ëª»ëœ JSON í˜•ì‹ì…ë‹ˆë‹¤: {str(e)}")
            return None
    
    return None

def main():
    st.title("MCP ì„œë²„ ê´€ë¦¬")
    
    # ì‚¬ì´ë“œë°” í‘œì‹œ ë° ì„¤ì • ê°€ì ¸ì˜¤ê¸°
    config = show_sidebar()
    
    if config:
        st.success("MCP ì„œë²„ ì„¤ì •ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.")
        st.json(config)

if __name__ == "__main__":
    main()
