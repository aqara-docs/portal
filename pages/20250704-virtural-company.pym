import streamlit as st
import os
from datetime import datetime
import time
import random
from dotenv import load_dotenv
from openai import OpenAI
import anthropic
from langchain_anthropic import ChatAnthropic
import json
import asyncio
import threading
from concurrent.futures import ThreadPoolExecutor, as_completed

# RAG ê´€ë ¨ import ì¶”ê°€
import mysql.connector
import pandas as pd
from sqlalchemy import create_engine
import requests
from bs4 import BeautifulSoup
from urllib.parse import urljoin, urlparse
from urllib.robotparser import RobotFileParser
import nltk
import logging
from pathlib import Path
import hashlib

# ë²¡í„° ë°ì´í„°ë² ì´ìŠ¤ ê´€ë ¨ import
from langchain.embeddings import OpenAIEmbeddings
from langchain.vectorstores.faiss import FAISS
from langchain.text_splitter import CharacterTextSplitter
from langchain.document_loaders import UnstructuredFileLoader
from langchain.schema import Document

# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

# í‘œì¤€í™”ëœ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í•¨ìˆ˜
def connect_to_db():
    """ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°"""
    try:
        conn = mysql.connector.connect(
            host=os.getenv('SQL_HOST'),
            user=os.getenv('SQL_USER'),
            password=os.getenv('SQL_PASSWORD'),
            database=os.getenv('SQL_DATABASE_NEWBIZ'),
            charset='utf8mb4',
            collation='utf8mb4_unicode_ci'
        )
        return conn
    except mysql.connector.Error as err:
        st.error(f"ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì˜¤ë¥˜: {err}")
        return None

def create_virtual_company_tables_if_not_exists():
    """Virtual Company í…Œì´ë¸”ì´ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ìë™ ìƒì„±"""
    try:
        connection = connect_to_db()
        if not connection:
            return False
        
        cursor = connection.cursor()
        
        # í…Œì´ë¸” ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        cursor.execute("SHOW TABLES LIKE 'virtual_company_%'")
        existing_tables = cursor.fetchall()
        existing_table_names = [table[0] for table in existing_tables]
        
        # í•„ìš”í•œ í…Œì´ë¸” ëª©ë¡
        required_tables = [
            'virtual_company_analyses',
            'virtual_company_persona_analyses', 
            'virtual_company_rag_sources',
            'virtual_company_analysis_metrics'
        ]
        
        # ëˆ„ë½ëœ í…Œì´ë¸”ì´ ìˆëŠ”ì§€ í™•ì¸
        missing_tables = [table for table in required_tables if table not in existing_table_names]
        
        if not missing_tables:
            # ëª¨ë“  í…Œì´ë¸”ì´ ì¡´ì¬í•¨ - í•˜ì§€ë§Œ completion_status ì»¬ëŸ¼ íƒ€ì… í™•ì¸ í•„ìš”
            try:
                cursor.execute("DESCRIBE virtual_company_analyses completion_status")
                column_info = cursor.fetchone()
                if column_info and 'enum' in column_info[1].lower():
                    # ENUMì„ VARCHARë¡œ ê°•ì œ ë³€ê²½
                    st.info("ğŸ”§ ê¸°ì¡´ í…Œì´ë¸”ì˜ completion_status ì»¬ëŸ¼ì„ VARCHARë¡œ ë³€ê²½ ì¤‘...")
                    cursor.execute("ALTER TABLE virtual_company_analyses MODIFY COLUMN completion_status VARCHAR(50) DEFAULT 'ì§„í–‰ì¤‘' COMMENT 'ë¶„ì„ ì™„ë£Œ ìƒíƒœ'")
                    connection.commit()
                    st.success("âœ… completion_status ì»¬ëŸ¼ íƒ€ì… ë³€ê²½ ì™„ë£Œ")
            except Exception as alter_error:
                st.warning(f"âš ï¸ completion_status ì»¬ëŸ¼ ìˆ˜ì • ì‹œë„ ì¤‘ ì˜¤ë¥˜: {str(alter_error)}")
            
            cursor.close()
            connection.close()
            return True
        
        # ëˆ„ë½ëœ í…Œì´ë¸” ìƒì„±
        st.info(f"ğŸ”§ Virtual Company ë¶„ì„ ì €ì¥ì„ ìœ„í•œ DB í…Œì´ë¸”ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤... (ëˆ„ë½: {len(missing_tables)}ê°œ)")
        
        # 1. ë©”ì¸ ë¶„ì„ ì„¸ì…˜ í…Œì´ë¸”
        if 'virtual_company_analyses' in missing_tables:
            virtual_company_analyses_table = """
            CREATE TABLE IF NOT EXISTS virtual_company_analyses (
                id INT AUTO_INCREMENT PRIMARY KEY,
                session_title VARCHAR(255) NOT NULL COMMENT 'ë¶„ì„ ì„¸ì…˜ ì œëª©',
                user_query TEXT NOT NULL COMMENT 'ì‚¬ìš©ì ì…ë ¥ ì§ˆë¬¸/ì£¼ì œ',
                model_name VARCHAR(100) NOT NULL COMMENT 'ì‚¬ìš©ëœ AI ëª¨ë¸',
                analysis_date DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'ë¶„ì„ ìˆ˜í–‰ ë‚ ì§œ',
                completion_status VARCHAR(50) DEFAULT 'ì§„í–‰ì¤‘' COMMENT 'ë¶„ì„ ì™„ë£Œ ìƒíƒœ',
                ceo_synthesis LONGTEXT COMMENT 'CEO ìµœì¢… ì¢…í•© ë¶„ì„ ê²°ê³¼',
                total_personas INT DEFAULT 0 COMMENT 'ì°¸ì—¬í•œ í˜ë¥´ì†Œë‚˜ ìˆ˜',
                successful_personas INT DEFAULT 0 COMMENT 'ì„±ê³µí•œ í˜ë¥´ì†Œë‚˜ ë¶„ì„ ìˆ˜',
                rag_sources_used INT DEFAULT 0 COMMENT 'ì‚¬ìš©ëœ RAG ì†ŒìŠ¤ ìˆ˜',
                execution_time_seconds INT COMMENT 'ì „ì²´ ì‹¤í–‰ ì‹œê°„(ì´ˆ)',
                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
                tags VARCHAR(500) COMMENT 'ê²€ìƒ‰ìš© íƒœê·¸',
                notes TEXT COMMENT 'ì¶”ê°€ ë©”ëª¨',
                INDEX idx_analysis_date (analysis_date),
                INDEX idx_model_name (model_name),
                INDEX idx_completion_status (completion_status),
                FULLTEXT idx_search (session_title, user_query, tags, notes)
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Virtual Company AI ë©€í‹°ì—ì´ì „íŠ¸ ë¶„ì„ ì„¸ì…˜';
            """
            cursor.execute(virtual_company_analyses_table)
        else:
            # ê¸°ì¡´ í…Œì´ë¸”ì´ ìˆëŠ” ê²½ìš° completion_status ì»¬ëŸ¼ íƒ€ì… í™•ì¸ ë° ìˆ˜ì •
            try:
                cursor.execute("DESCRIBE virtual_company_analyses completion_status")
                column_info = cursor.fetchone()
                if column_info and ('enum' in column_info[1].lower() or 'varchar' not in column_info[1].lower()):
                    # ENUMì„ VARCHARë¡œ ë³€ê²½
                    st.info("ğŸ”§ completion_status ì»¬ëŸ¼ íƒ€ì…ì„ VARCHARë¡œ ë³€ê²½ ì¤‘...")
                    cursor.execute("ALTER TABLE virtual_company_analyses MODIFY COLUMN completion_status VARCHAR(50) DEFAULT 'ì§„í–‰ì¤‘' COMMENT 'ë¶„ì„ ì™„ë£Œ ìƒíƒœ'")
                    st.success("âœ… completion_status ì»¬ëŸ¼ íƒ€ì… ë³€ê²½ ì™„ë£Œ")
            except Exception as alter_error:
                st.warning(f"âš ï¸ completion_status ì»¬ëŸ¼ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ (ë¬´ì‹œí•˜ê³  ê³„ì†): {str(alter_error)}")
        
        # 2. í˜ë¥´ì†Œë‚˜ë³„ ë¶„ì„ ê²°ê³¼ í…Œì´ë¸”
        if 'virtual_company_persona_analyses' in missing_tables:
            persona_analyses_table = """
            CREATE TABLE IF NOT EXISTS virtual_company_persona_analyses (
                id INT AUTO_INCREMENT PRIMARY KEY,
                analysis_id INT NOT NULL COMMENT 'ë©”ì¸ ë¶„ì„ ì„¸ì…˜ ID',
                persona_key VARCHAR(50) NOT NULL COMMENT 'í˜ë¥´ì†Œë‚˜ í‚¤ (CTO, CMO, CFO ë“±)',
                persona_name VARCHAR(100) NOT NULL COMMENT 'í˜ë¥´ì†Œë‚˜ ì´ë¦„',
                persona_role VARCHAR(200) NOT NULL COMMENT 'í˜ë¥´ì†Œë‚˜ ì—­í• ',
                analysis_result LONGTEXT COMMENT 'í˜ë¥´ì†Œë‚˜ ë¶„ì„ ê²°ê³¼',
                custom_prompt TEXT COMMENT 'ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸',
                analysis_success BOOLEAN DEFAULT FALSE COMMENT 'ë¶„ì„ ì„±ê³µ ì—¬ë¶€',
                error_message TEXT COMMENT 'ì˜¤ë¥˜ ë©”ì‹œì§€ (ì‹¤íŒ¨ ì‹œ)',
                analysis_start_time DATETIME COMMENT 'ë¶„ì„ ì‹œì‘ ì‹œê°„',
                analysis_end_time DATETIME COMMENT 'ë¶„ì„ ì™„ë£Œ ì‹œê°„',
                analysis_duration_seconds INT COMMENT 'ë¶„ì„ ì†Œìš” ì‹œê°„(ì´ˆ)',
                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (analysis_id) REFERENCES virtual_company_analyses(id) ON DELETE CASCADE,
                INDEX idx_analysis_id (analysis_id),
                INDEX idx_persona_key (persona_key),
                INDEX idx_success (analysis_success),
                FULLTEXT idx_content_search (analysis_result)
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='í˜ë¥´ì†Œë‚˜ë³„ ë¶„ì„ ê²°ê³¼';
            """
            cursor.execute(persona_analyses_table)
        
        # 3. RAG ë°ì´í„° ì†ŒìŠ¤ ì •ë³´ í…Œì´ë¸”
        if 'virtual_company_rag_sources' in missing_tables:
            rag_sources_table = """
            CREATE TABLE IF NOT EXISTS virtual_company_rag_sources (
                id INT AUTO_INCREMENT PRIMARY KEY,
                analysis_id INT NOT NULL COMMENT 'ë©”ì¸ ë¶„ì„ ì„¸ì…˜ ID',
                source_type ENUM('mysql', 'website', 'files') NOT NULL COMMENT 'RAG ì†ŒìŠ¤ íƒ€ì…',
                source_name VARCHAR(255) NOT NULL COMMENT 'ì†ŒìŠ¤ ì´ë¦„',
                source_description TEXT COMMENT 'ì†ŒìŠ¤ ì„¤ëª…',
                source_details JSON COMMENT 'ì†ŒìŠ¤ ìƒì„¸ ì •ë³´ (í…Œì´ë¸”ëª…, URL, íŒŒì¼ëª… ë“±)',
                data_size INT COMMENT 'ë°ì´í„° í¬ê¸° (í–‰ìˆ˜, í˜ì´ì§€ìˆ˜, íŒŒì¼í¬ê¸° ë“±)',
                content_preview TEXT COMMENT 'ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°',
                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (analysis_id) REFERENCES virtual_company_analyses(id) ON DELETE CASCADE,
                INDEX idx_analysis_id (analysis_id),
                INDEX idx_source_type (source_type),
                INDEX idx_source_name (source_name)
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='RAG ë°ì´í„° ì†ŒìŠ¤ ì •ë³´';
            """
            cursor.execute(rag_sources_table)
        
        # 4. ë¶„ì„ í†µê³„ ë° ë©”íŠ¸ë¦­ í…Œì´ë¸”
        if 'virtual_company_analysis_metrics' in missing_tables:
            analysis_metrics_table = """
            CREATE TABLE IF NOT EXISTS virtual_company_analysis_metrics (
                id INT AUTO_INCREMENT PRIMARY KEY,
                analysis_id INT NOT NULL COMMENT 'ë©”ì¸ ë¶„ì„ ì„¸ì…˜ ID',
                metric_name VARCHAR(100) NOT NULL COMMENT 'ë©”íŠ¸ë¦­ ì´ë¦„',
                metric_value DECIMAL(15,4) COMMENT 'ë©”íŠ¸ë¦­ ê°’',
                metric_unit VARCHAR(50) COMMENT 'ë©”íŠ¸ë¦­ ë‹¨ìœ„',
                metric_category VARCHAR(100) COMMENT 'ë©”íŠ¸ë¦­ ì¹´í…Œê³ ë¦¬',
                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (analysis_id) REFERENCES virtual_company_analyses(id) ON DELETE CASCADE,
                INDEX idx_analysis_id (analysis_id),
                INDEX idx_metric_name (metric_name),
                INDEX idx_metric_category (metric_category)
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ë¶„ì„ ë©”íŠ¸ë¦­ ë° í†µê³„';
            """
            cursor.execute(analysis_metrics_table)
        
        connection.commit()
        cursor.close()
        connection.close()
        
        st.success(f"âœ… Virtual Company DB í…Œì´ë¸” ìƒì„± ì™„ë£Œ! ({len(missing_tables)}ê°œ í…Œì´ë¸” ìƒì„±)")
        return True
        
    except Exception as e:
        st.error(f"âŒ Virtual Company í…Œì´ë¸” ìƒì„± ì¤‘ ì˜¤ë¥˜: {str(e)}")
        return False

def check_database_connection():
    """ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ë° í…Œì´ë¸” ìƒíƒœ í™•ì¸"""
    try:
        connection = connect_to_db()
        if not connection:
            return False, "ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨"
        
        cursor = connection.cursor()
        
        # ë°ì´í„°ë² ì´ìŠ¤ ì •ë³´ í™•ì¸
        cursor.execute("SELECT DATABASE()")
        db_name = cursor.fetchone()[0]
        
        # ê°€ìƒíšŒì‚¬ í…Œì´ë¸” í™•ì¸
        cursor.execute("SHOW TABLES LIKE 'virtual_company_%'")
        tables = cursor.fetchall()
        table_count = len(tables)
        
        cursor.close()
        connection.close()
        
        return True, f"ì—°ê²° ì„±ê³µ (DB: {db_name}, Virtual Company í…Œì´ë¸”: {table_count}ê°œ)"
        
    except Exception as e:
        return False, f"ì—°ê²° ì˜¤ë¥˜: {str(e)}"

# ë¡œê¹… ì„¤ì •
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# NLTK ì„¤ì •
try:
    nltk.download('punkt', quiet=True)
except:
    pass

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(
    page_title="ğŸ¬ Virtual AqaraLife C-Level ë©€í‹°ì—ì´ì „íŠ¸ + RAG",
    page_icon="ğŸ¢",
    layout="wide"
)

st.title("ğŸ¢ Virtual Company")
if 'authenticated' not in st.session_state:
    st.session_state.authenticated = False

admin_pw = os.getenv('ADMIN_PASSWORD')
if not admin_pw:
    st.error('í™˜ê²½ë³€ìˆ˜(ADMIN_PASSWORD)ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. .env íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.')
    st.stop()

if not st.session_state.authenticated:
    password = st.text_input("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”", type="password")
    if password == admin_pw:
        st.session_state.authenticated = True
        st.rerun()
    else:
        if password:  # ë¹„ë°€ë²ˆí˜¸ê°€ ì…ë ¥ëœ ê²½ìš°ì—ë§Œ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
            st.error("ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤")
        st.stop()

# ìŠ¤íƒ€ì¼ë§
st.markdown("""
<style>
.persona-card {
    background: linear-gradient(145deg, #f0f2f6, #ffffff);
    border-radius: 15px;
    padding: 20px;
    margin: 10px 0;
    box-shadow: 5px 5px 15px #d1d9e6, -5px -5px 15px #ffffff;
    border-left: 5px solid #0066cc;
}

.persona-header {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
}

.persona-emoji {
    font-size: 2.5rem;
    margin-right: 15px;
}

.persona-title {
    color: #0066cc;
    font-size: 1.3rem;
    font-weight: bold;
    margin: 0;
}

.persona-subtitle {
    color: #666;
    font-size: 0.9rem;
    margin: 0;
}

.result-container {
    background: linear-gradient(145deg, #f8f9fa, #ffffff);
    border-radius: 12px;
    padding: 20px;
    margin: 15px 0;
    border-left: 4px solid #28a745;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.result-container h4 {
    color: #28a745;
    margin: 0;
    font-size: 1.1rem;
}

.ceo-final {
    background: linear-gradient(145deg, #fff3cd, #ffeaa7);
    border-left: 4px solid #f39c12;
    border-radius: 15px;
    padding: 20px;
    margin: 20px 0;
    box-shadow: 0 4px 15px rgba(243, 156, 18, 0.2);
    color: #2c3e50;
}

.ceo-final h3 {
    color: #c0392b;
    font-weight: bold;
    margin-bottom: 10px;
}

.ceo-final p {
    color: #34495e;
    font-weight: 500;
}

.progress-indicator {
    background: linear-gradient(145deg, #0066cc, #0052a3);
    color: white;
    text-align: center;
    padding: 15px 20px;
    border-radius: 12px;
    margin: 15px 0;
    box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);
    border: none;
}

.progress-indicator strong {
    font-size: 1.1rem;
    font-weight: 600;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    color: #ffffff;
}

.progress-section {
    background: #f8f9fa;
    border-radius: 15px;
    padding: 25px;
    margin: 20px 0;
    border: 2px solid #e9ecef;
}

.progress-section h2 {
    color: #0066cc;
    text-align: center;
    margin-bottom: 20px;
    font-size: 1.5rem;
}

.analysis-complete {
    background: linear-gradient(145deg, #d4edda, #c3e6cb);
    border: 2px solid #28a745;
    border-radius: 12px;
    padding: 15px;
    margin: 10px 0;
    text-align: center;
}

.analysis-complete h4 {
    color: #155724;
    margin: 0;
    font-size: 1.1rem;
    font-weight: bold;
}

.ceo-synthesis {
    background: linear-gradient(145deg, #ffeaa7, #fdcb6e);
    border: 2px solid #f39c12;
    border-radius: 12px;
    padding: 20px;
    margin: 15px 0;
    text-align: center;
    color: #2c3e50;
}

.ceo-synthesis strong {
    color: #8e5b00;
    font-size: 1.2rem;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
}

.main-title {
    text-align: center;
    color: #0066cc;
    margin-bottom: 10px;
}

.main-subtitle {
    text-align: center;
    color: #666;
    font-size: 1.1rem;
    margin-bottom: 30px;
}
</style>
""", unsafe_allow_html=True)

# C-Level í˜ë¥´ì†Œë‚˜ ì •ì˜
PERSONAS = {
    "CTO": {
        "name": "Chief Technology Officer",
        "emoji": "ğŸ’»",
        "role": "ê¸°ìˆ  ì „ëµ ë° í˜ì‹  ì±…ì„ì",
        "expertise": "ê¸°ìˆ  ì•„í‚¤í…ì²˜, ê°œë°œ ì „ëµ, í˜ì‹ , ë””ì§€í„¸ ì „í™˜",
        "perspective": "ê¸°ìˆ ì  íƒ€ë‹¹ì„±, êµ¬í˜„ ê°€ëŠ¥ì„±, ê¸°ìˆ  íŠ¸ë Œë“œ, ë³´ì•ˆ, í™•ì¥ì„±ì„ ì¤‘ì‹¬ìœ¼ë¡œ ë¶„ì„",
        "system_prompt": """ë‹¹ì‹ ì€ 15ë…„ ì´ìƒì˜ ê²½í—˜ì„ ê°€ì§„ ì„¸ê³„ì  ìˆ˜ì¤€ì˜ CTO(Chief Technology Officer)ì…ë‹ˆë‹¤.

ã€ì „ë¬¸ ì˜ì—­ã€‘
- ì—”í„°í”„ë¼ì´ì¦ˆ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ì„¤ê³„ ë° ìµœì í™”
- í´ë¼ìš°ë“œ ë„¤ì´í‹°ë¸Œ, ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤, DevOps/MLOps ì „ëµ
- AI/ML, ë¸”ë¡ì²´ì¸, IoT ë“± ìµœì‹  ê¸°ìˆ  ë„ì… ë° í™œìš©
- ì‚¬ì´ë²„ë³´ì•ˆ, ë°ì´í„° ê±°ë²„ë„ŒìŠ¤, ê·œì • ì¤€ìˆ˜
- ê¸°ìˆ íŒ€ ì¡°ì§ ê´€ë¦¬ ë° ê°œë°œ ë¬¸í™” í˜ì‹ 
- ê¸°ìˆ  íˆ¬ì ROI ë¶„ì„ ë° ìš°ì„ ìˆœìœ„ ì„¤ì •

ã€ë¶„ì„ ìŠ¤íƒ€ì¼ã€‘
1. ê¸°ìˆ ì  íƒ€ë‹¹ì„±ì„ ìˆ˜ì¹˜ì™€ êµ¬ì²´ì  ê·¼ê±°ë¡œ ì…ì¦
2. êµ¬í˜„ ë‹¨ê³„ë³„ ì„¸ë¶€ ê³„íšê³¼ ë¦¬ì†ŒìŠ¤ ìš”êµ¬ì‚¬í•­ ëª…ì‹œ
3. ê¸°ìˆ  ë¦¬ìŠ¤í¬ì™€ ëŒ€ì•ˆ ì†”ë£¨ì…˜ì„ ë‹¤ê°ë„ë¡œ ê²€í† 
4. í™•ì¥ì„±ê³¼ ìœ ì§€ë³´ìˆ˜ì„±ì„ ê³ ë ¤í•œ ì¥ê¸°ì  ê´€ì  ì œì‹œ
5. ë¹„ìš© íš¨ìœ¨ì„±ê³¼ ì„±ëŠ¥ ìµœì í™” ë°©ì•ˆ êµ¬ì²´í™”
6. ìµœì‹  ê¸°ìˆ  íŠ¸ë Œë“œì™€ ì—…ê³„ ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤ ì ìš©

ã€ë¦¬í¬íŠ¸ ìš”êµ¬ì‚¬í•­ã€‘
- ê¸°ìˆ  ì†”ë£¨ì…˜ì€ ë°˜ë“œì‹œ êµ¬ì²´ì ì¸ ë„êµ¬/í”„ë ˆì„ì›Œí¬ ëª…ì‹œ
- êµ¬í˜„ ì¼ì •, ì¸ë ¥, ì˜ˆì‚°ì„ í¬í•¨í•œ ìƒì„¸ ì‹¤í–‰ ê³„íš ì œê³µ
- ê¸°ìˆ ì  ìœ„í—˜ ìš”ì†Œì™€ ì™„í™” ì „ëµì„ ì„¸ë¶€ì ìœ¼ë¡œ ë¶„ì„
- ì„±ëŠ¥ ì§€í‘œ(KPI)ì™€ ëª¨ë‹ˆí„°ë§ ë°©ì•ˆì„ ëª…í™•íˆ ì œì‹œ
- ë‹¤ë¥¸ ë¶€ì„œì™€ì˜ ê¸°ìˆ ì  ì—°ë™ ë°©ì•ˆì„ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…"""
    },
    "CSO_Strategy": {
        "name": "Chief Strategy Officer",
        "emoji": "ğŸ¯",
        "role": "ì „ëµ ê¸°íš ë° ì‚¬ì—… ê°œë°œ ì±…ì„ì",
        "expertise": "ì‚¬ì—… ì „ëµ, ì‹œì¥ ë¶„ì„, ê²½ìŸ ë¶„ì„, ì„±ì¥ ì „ëµ",
        "perspective": "ì‹œì¥ ê¸°íšŒ, ê²½ìŸ ìš°ìœ„, ì„±ì¥ ì ì¬ë ¥, ë¦¬ìŠ¤í¬ ë¶„ì„ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì „ëµì  ê´€ì  ì œì‹œ",
        "system_prompt": """ë‹¹ì‹ ì€ ê¸€ë¡œë²Œ ì»¨ì„¤íŒ… ê²½í—˜ê³¼ ë‹¤ì–‘í•œ ì‚°ì—… ì „ë¬¸ì„±ì„ ë³´ìœ í•œ ìµœê³  ìˆ˜ì¤€ì˜ CSO(Chief Strategy Officer)ì…ë‹ˆë‹¤.

ã€ì „ë¬¸ ì˜ì—­ã€‘
- ì‹œì¥ ë™í–¥ ë¶„ì„ ë° ê¸°íšŒ ë°œêµ´ (TAM, SAM, SOM ë¶„ì„)
- ê²½ìŸì‚¬ ë¶„ì„ ë° í¬ì§€ì…”ë‹ ì „ëµ ìˆ˜ë¦½
- ì‚¬ì—… ëª¨ë¸ í˜ì‹  ë° ìˆ˜ìµ ë‹¤ê°í™” ë°©ì•ˆ
- M&A, íŒŒíŠ¸ë„ˆì‹­, ì „ëµì  ì œíœ´ ê¸°íš
- ESG ê²½ì˜ ë° ì§€ì†ê°€ëŠ¥ì„± ì „ëµ
- ê¸€ë¡œë²Œ ì‹œì¥ ì§„ì¶œ ë° í˜„ì§€í™” ì „ëµ

ã€ë¶„ì„ ìŠ¤íƒ€ì¼ã€‘
1. ì •ëŸ‰ì  ì‹œì¥ ë°ì´í„°ì™€ ì •ì„±ì  íŠ¸ë Œë“œ ë¶„ì„ì„ ì¢…í•©
2. 3-5ë…„ ì¤‘ì¥ê¸° ì‹œë‚˜ë¦¬ì˜¤ ê¸°ë°˜ ì „ëµ ë¡œë“œë§µ ì œì‹œ
3. ê²½ìŸ ìš°ìœ„ í™•ë³´ë¥¼ ìœ„í•œ ì°¨ë³„í™” ì „ëµ êµ¬ì²´í™”
4. ë¦¬ìŠ¤í¬ ë§¤íŠ¸ë¦­ìŠ¤ì™€ ëŒ€ì‘ ì‹œë‚˜ë¦¬ì˜¤ ë‹¤ê°ë„ ê²€í† 
5. ì¬ë¬´ì  ì„íŒ©íŠ¸ì™€ ì „ëµì  ê°€ì¹˜ë¥¼ ê· í˜• ìˆê²Œ í‰ê°€
6. ì‹¤í–‰ ê°€ëŠ¥ì„±ê³¼ ì¡°ì§ ì—­ëŸ‰ì„ ê³ ë ¤í•œ ìš°ì„ ìˆœìœ„ ì„¤ì •

ã€ë¦¬í¬íŠ¸ ìš”êµ¬ì‚¬í•­ã€‘
- ì‹œì¥ í¬ê¸°, ì„±ì¥ë¥ , ê³ ê° ì„¸ê·¸ë¨¼íŠ¸ë¥¼ ìˆ˜ì¹˜ë¡œ ì •ëŸ‰í™”
- ê²½ìŸì‚¬ ëŒ€ë¹„ ìš°ìœ„/ì—´ìœ„ ìš”ì†Œë¥¼ ë§¤íŠ¸ë¦­ìŠ¤ë¡œ ë¹„êµ ë¶„ì„
- ì „ëµì  ì˜µì…˜ë³„ ROI, NPV, Payback Period ì‚°ì¶œ
- ë¦¬ìŠ¤í¬ ìš”ì¸ë³„ ë°œìƒ í™•ë¥ ê³¼ ì„íŒ©íŠ¸ í¬ê¸°ë¥¼ ì •ëŸ‰í™”
- ë‹¨ê³„ë³„ ë§ˆì¼ìŠ¤í†¤ê³¼ ì„±ê³¼ ì§€í‘œ(KPI)ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ì •
- ì¡°ì§ ì—­ëŸ‰ Gapê³¼ ë³´ì™„ ë°©ì•ˆì„ ìƒì„¸íˆ ì œì‹œ"""
    },
    "CMO": {
        "name": "Chief Marketing Officer",
        "emoji": "ğŸ“¢",
        "role": "ë§ˆì¼€íŒ… ë° ë¸Œëœë“œ ì „ëµ ì±…ì„ì",
        "expertise": "ë¸Œëœë“œ ì „ëµ, ê³ ê° ê²½í—˜, ë””ì§€í„¸ ë§ˆì¼€íŒ…, ì‹œì¥ ì¡°ì‚¬",
        "perspective": "ê³ ê° ë‹ˆì¦ˆ, ë¸Œëœë“œ í¬ì§€ì…”ë‹, ë§ˆì¼€íŒ… ì±„ë„, ê³ ê° ê²½í—˜ì„ ì¤‘ì‹¬ìœ¼ë¡œ ë¶„ì„",
        "system_prompt": """ë‹¹ì‹ ì€ ë””ì§€í„¸ ë§ˆì¼€íŒ…ê³¼ ë¸Œëœë“œ ì „ëµ ë¶„ì•¼ì˜ ì„¸ê³„ì  ì „ë¬¸ê°€ì¸ CMO(Chief Marketing Officer)ì…ë‹ˆë‹¤.

ã€ì „ë¬¸ ì˜ì—­ã€‘
- ë¸Œëœë“œ í¬ì§€ì…”ë‹ ë° ì•„ì´ë´í‹°í‹° êµ¬ì¶• ì „ëµ
- ì˜´ë‹ˆì±„ë„ ê³ ê° ì—¬ì • ì„¤ê³„ ë° ìµœì í™”
- ë””ì§€í„¸ ë§ˆì¼€íŒ… (SEO/SEM, SNS, ì½˜í…ì¸ , ì¸í”Œë£¨ì–¸ì„œ)
- ë§ˆì¼€íŒ… ìë™í™” ë° ê°œì¸í™” ìº í˜ì¸ êµ¬ì¶•
- ê³ ê° ë°ì´í„° ë¶„ì„ ë° ì„¸ê·¸ë©˜í…Œì´ì…˜ ì „ëµ
- ë§ˆì¼€íŒ… ROI ì¸¡ì • ë° í¼í¬ë¨¼ìŠ¤ ìµœì í™”

ã€ë¶„ì„ ìŠ¤íƒ€ì¼ã€‘
1. ê³ ê° í˜ë¥´ì†Œë‚˜ë³„ ë‹ˆì¦ˆì™€ í–‰ë™ íŒ¨í„´ì„ ë°ì´í„°ë¡œ ë¶„ì„
2. ë¸Œëœë“œ ì¸ì§€ë„, ì„ í˜¸ë„, ì¶©ì„±ë„ ì§€í‘œë¥¼ ì •ëŸ‰í™”
3. ë§ˆì¼€íŒ… í¼ë„ë³„ ì „í™˜ìœ¨ê³¼ ê°œì„  í¬ì¸íŠ¸ êµ¬ì²´í™”
4. ì±„ë„ë³„ ROAS, CAC, LTV ë“± í•µì‹¬ ì§€í‘œ ì‚°ì¶œ
5. ê²½ìŸì‚¬ ë§ˆì¼€íŒ… ì „ëµ ë²¤ì¹˜ë§ˆí‚¹ ë° ì°¨ë³„í™” ë°©ì•ˆ ì œì‹œ
6. ì°½ì˜ì  ì•„ì´ë””ì–´ì™€ ë°ì´í„° ê¸°ë°˜ ì ‘ê·¼ë²•ì˜ ê· í˜•

ã€ë¦¬í¬íŠ¸ ìš”êµ¬ì‚¬í•­ã€‘
- íƒ€ê²Ÿ ê³ ê° ì„¸ê·¸ë¨¼íŠ¸ë³„ í¬ê¸°ì™€ íŠ¹ì„±ì„ êµ¬ì²´ì ìœ¼ë¡œ ë¶„ì„
- ë¸Œëœë“œ í¬ì§€ì…”ë‹ ë§µê³¼ ê²½ìŸì‚¬ ëŒ€ë¹„ ì°¨ë³„í™” í¬ì¸íŠ¸ ì‹œê°í™”
- ë§ˆì¼€íŒ… ì±„ë„ë³„ ì˜ˆì‚° ë°°ë¶„ê³¼ ê¸°ëŒ€ ì„±ê³¼ë¥¼ ì •ëŸ‰í™”
- ìº í˜ì¸ë³„ KPI ëª©í‘œì¹˜ì™€ ì¸¡ì • ë°©ë²•ì„ ëª…í™•íˆ ì„¤ì •
- ê³ ê° ìƒì• ê°€ì¹˜(CLV) í–¥ìƒì„ ìœ„í•œ êµ¬ì²´ì  ì•¡ì…˜ í”Œëœ ì œì‹œ
- ë¸Œëœë“œ ê°€ì¹˜ ì¦ëŒ€ë¥¼ ìœ„í•œ ì¥ê¸°ì  ë§ˆì¼€íŒ… ë¡œë“œë§µ ìˆ˜ë¦½"""
    },
    "CFO": {
        "name": "Chief Financial Officer",
        "emoji": "ğŸ’°",
        "role": "ì¬ë¬´ ì „ëµ ë° ë¦¬ìŠ¤í¬ ê´€ë¦¬ ì±…ì„ì",
        "expertise": "ì¬ë¬´ ë¶„ì„, íˆ¬ì í‰ê°€, ë¦¬ìŠ¤í¬ ê´€ë¦¬, ìˆ˜ìµì„± ë¶„ì„",
        "perspective": "ì¬ë¬´ì  íƒ€ë‹¹ì„±, íˆ¬ì ìˆ˜ìµë¥ , ë¹„ìš© íš¨ìœ¨ì„±, ë¦¬ìŠ¤í¬ ê´€ë¦¬ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ë¶„ì„",
        "system_prompt": """ë‹¹ì‹ ì€ ê¸€ë¡œë²Œ ê¸°ì—…ì˜ ì¬ë¬´ ì „ëµì„ ì´ëŒì–´ì˜¨ ìµœê³  ìˆ˜ì¤€ì˜ CFO(Chief Financial Officer)ì…ë‹ˆë‹¤.

ã€ì „ë¬¸ ì˜ì—­ã€‘
- ì¬ë¬´ì œí‘œ ë¶„ì„ ë° ì¬ë¬´ ëª¨ë¸ë§ (DCF, LBO, ë¯¼ê°ë„ ë¶„ì„)
- íˆ¬ì ì˜ì‚¬ê²°ì • ë° ìë³¸ ë°°ë¶„ ìµœì í™”
- ë¦¬ìŠ¤í¬ ê´€ë¦¬ ë° ë‚´ë¶€í†µì œ ì‹œìŠ¤í…œ êµ¬ì¶•
- ìê¸ˆ ì¡°ë‹¬ ì „ëµ (ì£¼ì‹, ì±„ê¶Œ, ì€í–‰ ëŒ€ì¶œ, ëŒ€ì•ˆ ê¸ˆìœµ)
- ì„¸ë¬´ ìµœì í™” ë° ê·œì • ì¤€ìˆ˜ ê´€ë¦¬
- M&A ì¬ë¬´ ì‹¤ì‚¬ ë° í†µí•© í›„ ì‹œë„ˆì§€ ì°½ì¶œ

ã€ë¶„ì„ ìŠ¤íƒ€ì¼ã€‘
1. ì¬ë¬´ ì§€í‘œë¥¼ ë‹¤ê°ë„ë¡œ ë¶„ì„í•˜ì—¬ í˜„í™©ì„ ì •í™•íˆ ì§„ë‹¨
2. NPV, IRR, ROIC ë“±ì„ í™œìš©í•œ íˆ¬ì íƒ€ë‹¹ì„± ì •ëŸ‰ í‰ê°€
3. ì‹œë‚˜ë¦¬ì˜¤ë³„ ì¬ë¬´ ì˜í–¥ë„ì™€ ë¯¼ê°ë„ ë¶„ì„ ìˆ˜í–‰
4. í˜„ê¸ˆíë¦„ ì˜ˆì¸¡ê³¼ ìœ ë™ì„± ë¦¬ìŠ¤í¬ ê´€ë¦¬ ë°©ì•ˆ ì œì‹œ
5. ë¹„ìš© êµ¬ì¡° ìµœì í™”ì™€ ìˆ˜ìµì„± ê°œì„  ë°©ì•ˆ ë„ì¶œ
6. ì£¼ì£¼ê°€ì¹˜ ê·¹ëŒ€í™”ë¥¼ ìœ„í•œ ì¬ë¬´ ì „ëµ ìˆ˜ë¦½

ã€ë¦¬í¬íŠ¸ ìš”êµ¬ì‚¬í•­ã€‘
- ì£¼ìš” ì¬ë¬´ ë¹„ìœ¨ê³¼ ì—…ê³„ ë²¤ì¹˜ë§ˆí¬ ë¹„êµ ë¶„ì„ ì œì‹œ
- íˆ¬ìì•ˆë³„ ì¬ë¬´ì  ìˆ˜ìµë¥ ê³¼ íšŒìˆ˜ ê¸°ê°„ì„ ì •í™•íˆ ê³„ì‚°
- ë¦¬ìŠ¤í¬ ìš”ì¸ë³„ ì¬ë¬´ì  ì„íŒ©íŠ¸ë¥¼ ì •ëŸ‰í™”í•˜ì—¬ ë¶„ì„
- í˜„ê¸ˆíë¦„ ì˜ˆì¸¡ê³¼ ìê¸ˆ ì¡°ë‹¬ ê³„íšì„ êµ¬ì²´ì ìœ¼ë¡œ ìˆ˜ë¦½
- ë¹„ìš© ì ˆê° ëª©í‘œì™€ ì‹¤í–‰ ë°©ì•ˆì„ ì„¸ë¶€ì ìœ¼ë¡œ ì œì‹œ
- ì£¼ì£¼ ë° ì´í•´ê´€ê³„ì ëŒ€ìƒ ì¬ë¬´ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ì „ëµ í¬í•¨"""
    },
    "CSO_Sales": {
        "name": "Chief Sales Officer",
        "emoji": "ğŸ¤",
        "role": "ì˜ì—… ì „ëµ ë° ê³ ê° ê´€ê³„ ì±…ì„ì",
        "expertise": "ì˜ì—… ì „ëµ, ê³ ê° ê´€ê³„ ê´€ë¦¬, ì‹œì¥ ê°œë°œ, íŒŒíŠ¸ë„ˆì‹­",
        "perspective": "ì˜ì—… íš¨ìœ¨ì„±, ê³ ê° ë§Œì¡±ë„, ì‹œì¥ í™•ëŒ€, ìˆ˜ìµ ì°½ì¶œì„ ì¤‘ì‹¬ìœ¼ë¡œ ë¶„ì„",
        "system_prompt": """ë‹¹ì‹ ì€ B2B/B2C ì˜ì—… ì „ëµê³¼ ê³ ê° ê´€ê³„ ê´€ë¦¬ ë¶„ì•¼ì˜ ìµœê³  ì „ë¬¸ê°€ì¸ CSO(Chief Sales Officer)ì…ë‹ˆë‹¤.

ã€ì „ë¬¸ ì˜ì—­ã€‘
- ì„¸ì¼ì¦ˆ í”„ë¡œì„¸ìŠ¤ ìµœì í™” ë° ì˜ì—… ìƒì‚°ì„± í–¥ìƒ
- CRM ì‹œìŠ¤í…œ êµ¬ì¶• ë° ê³ ê° ë°ì´í„° ë¶„ì„ í™œìš©
- ì˜ì—…íŒ€ ì¡°ì§ ì„¤ê³„ ë° ì„±ê³¼ ê´€ë¦¬ ì²´ê³„ êµ¬ì¶•
- ì£¼ìš” ê³ ê°(Key Account) ê´€ë¦¬ ë° ê´€ê³„ ì‹¬í™” ì „ëµ
- íŒŒíŠ¸ë„ˆ ì±„ë„ ê°œë°œ ë° í˜‘ë ¥ ê´€ê³„ ê°•í™”
- ì˜ì—… ì˜ˆì¸¡ ì •í™•ë„ í–¥ìƒ ë° íŒŒì´í”„ë¼ì¸ ê´€ë¦¬

ã€ë¶„ì„ ìŠ¤íƒ€ì¼ã€‘
1. ì˜ì—… í¼ë„ë³„ ì „í™˜ìœ¨ê³¼ ë³‘ëª© êµ¬ê°„ì„ ë°ì´í„°ë¡œ ë¶„ì„
2. ê³ ê°ë³„/ì œí’ˆë³„ ìˆ˜ìµì„±ê³¼ ì„±ì¥ ê°€ëŠ¥ì„±ì„ ì •ëŸ‰ í‰ê°€
3. ì˜ì—… ì‚¬ì´í´ ë‹¨ì¶•ê³¼ ì„±ì•½ë¥  í–¥ìƒ ë°©ì•ˆì„ êµ¬ì²´í™”
4. ì˜ì—…íŒ€ ì—­ëŸ‰ê³¼ ì‹œì¥ ì»¤ë²„ë¦¬ì§€ë¥¼ ë§¤íŠ¸ë¦­ìŠ¤ë¡œ ë¶„ì„
5. ê²½ìŸì‚¬ ì˜ì—… ì „ëµ ë²¤ì¹˜ë§ˆí‚¹ ë° ì°¨ë³„í™” í¬ì¸íŠ¸ ë„ì¶œ
6. ë‹¨ê¸° ì„±ê³¼ì™€ ì¥ê¸° ê´€ê³„ êµ¬ì¶•ì˜ ê· í˜•ì  ëª¨ìƒ‰

ã€ë¦¬í¬íŠ¸ ìš”êµ¬ì‚¬í•­ã€‘
- ì‹œì¥ë³„/ì œí’ˆë³„ ì˜ì—… ê¸°íšŒ í¬ê¸°ì™€ ìš°ì„ ìˆœìœ„ë¥¼ ì •ëŸ‰í™”
- ì˜ì—…íŒ€ ì„±ê³¼ ì§€í‘œ(KPI)ì™€ ê°œì„  ëª©í‘œì¹˜ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ì •
- ê³ ê°ë³„ ë§¤ì¶œ ê¸°ì—¬ë„ì™€ ì„±ì¥ ì ì¬ë ¥ì„ ë§¤íŠ¸ë¦­ìŠ¤ë¡œ ë¶„ì„
- ì˜ì—… í”„ë¡œì„¸ìŠ¤ ê°œì„ ì•ˆê³¼ ê¸°ëŒ€ íš¨ê³¼ë¥¼ ë‹¨ê³„ë³„ë¡œ ì œì‹œ
- íŒŒíŠ¸ë„ˆ ì±„ë„ ì „ëµê³¼ ìˆ˜ìµ ë¶„ë°° ëª¨ë¸ì„ ìƒì„¸íˆ ì„¤ê³„
- ê³ ê° ë§Œì¡±ë„ í–¥ìƒê³¼ ì¶©ì„±ë„ ì œê³ ë¥¼ ìœ„í•œ ì•¡ì…˜ í”Œëœ ìˆ˜ë¦½"""
    },
    "CIO": {
        "name": "Chief Information Officer",
        "emoji": "ğŸ”",
        "role": "ì •ë³´ì‹œìŠ¤í…œ ë° ë°ì´í„° ì „ëµ ì±…ì„ì",
        "expertise": "ì •ë³´ì‹œìŠ¤í…œ, ë°ì´í„° ê´€ë¦¬, IT ê±°ë²„ë„ŒìŠ¤, ë””ì§€í„¸ ì¸í”„ë¼",
        "perspective": "ì‹œìŠ¤í…œ íš¨ìœ¨ì„±, ë°ì´í„° í™œìš©, ë³´ì•ˆ, IT ê±°ë²„ë„ŒìŠ¤ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ë¶„ì„",
        "system_prompt": """ë‹¹ì‹ ì€ ë””ì§€í„¸ ì „í™˜ê³¼ ì •ë³´ ì „ëµ ë¶„ì•¼ì˜ ì„¸ê³„ì  ì „ë¬¸ê°€ì¸ CIO(Chief Information Officer)ì…ë‹ˆë‹¤.

ã€ì „ë¬¸ ì˜ì—­ã€‘
- ì—”í„°í”„ë¼ì´ì¦ˆ IT ì•„í‚¤í…ì²˜ ì„¤ê³„ ë° ê±°ë²„ë„ŒìŠ¤ êµ¬ì¶•
- ë°ì´í„° ë ˆì´í¬/ì›¨ì–´í•˜ìš°ìŠ¤ êµ¬ì¶• ë° ë¶„ì„ í”Œë«í¼ ìš´ì˜
- ì •ë³´ë³´ì•ˆ ì „ëµ ìˆ˜ë¦½ ë° ì»´í”Œë¼ì´ì–¸ìŠ¤ ê´€ë¦¬
- IT ì„œë¹„ìŠ¤ ê´€ë¦¬(ITSM) ë° ìš´ì˜ íš¨ìœ¨ì„± ìµœì í™”
- ë””ì§€í„¸ ì›Œí¬í”Œë ˆì´ìŠ¤ êµ¬ì¶• ë° ì—…ë¬´ ìë™í™”
- IT ì˜ˆì‚° ê´€ë¦¬ ë° ROI ì¸¡ì • ì²´ê³„ êµ¬ì¶•

ã€ë¶„ì„ ìŠ¤íƒ€ì¼ã€‘
1. IT ì¸í”„ë¼ í˜„í™©ê³¼ ì„±ëŠ¥ ì§€í‘œë¥¼ ì •ëŸ‰ì ìœ¼ë¡œ ë¶„ì„
2. ë°ì´í„° í’ˆì§ˆê³¼ í™œìš©ë„ë¥¼ ì¸¡ì •í•˜ì—¬ ê°œì„  ë°©ì•ˆ ë„ì¶œ
3. ë³´ì•ˆ ìœ„í˜‘ê³¼ ì·¨ì•½ì ì„ ì²´ê³„ì ìœ¼ë¡œ í‰ê°€í•˜ê³  ëŒ€ì‘ì±… ìˆ˜ë¦½
4. IT íˆ¬ì ëŒ€ë¹„ ë¹„ì¦ˆë‹ˆìŠ¤ ê°€ì¹˜ ì°½ì¶œ íš¨ê³¼ë¥¼ ì •ëŸ‰í™”
5. ì‹œìŠ¤í…œ ê°„ ì—°ë™ì„±ê³¼ í™•ì¥ì„±ì„ ì•„í‚¤í…ì²˜ ê´€ì ì—ì„œ ê²€í† 
6. ì‚¬ìš©ì ê²½í—˜ê³¼ ì—…ë¬´ íš¨ìœ¨ì„± ê°œì„  íš¨ê³¼ë¥¼ ì¸¡ì •

ã€ë¦¬í¬íŠ¸ ìš”êµ¬ì‚¬í•­ã€‘
- IT ì‹œìŠ¤í…œë³„ ì„±ëŠ¥ ì§€í‘œì™€ ê°œì„  ëª©í‘œë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ì •
- ë°ì´í„° ê±°ë²„ë„ŒìŠ¤ ì²´ê³„ì™€ í’ˆì§ˆ ê´€ë¦¬ ë°©ì•ˆì„ ìƒì„¸íˆ ì œì‹œ
- ë³´ì•ˆ ë¦¬ìŠ¤í¬ ë§¤íŠ¸ë¦­ìŠ¤ì™€ ëŒ€ì‘ ìš°ì„ ìˆœìœ„ë¥¼ ëª…í™•íˆ ë¶„ì„
- IT íˆ¬ì ê³„íšê³¼ ê¸°ëŒ€ íš¨ê³¼ë¥¼ ë¹„ìš©-í¸ìµ ê´€ì ì—ì„œ í‰ê°€
- ì‹œìŠ¤í…œ í†µí•© ë° ì—…ê·¸ë ˆì´ë“œ ë¡œë“œë§µì„ ë‹¨ê³„ë³„ë¡œ ìˆ˜ë¦½
- ì¡°ì§ì˜ ë””ì§€í„¸ ì„±ìˆ™ë„ì™€ í–¥í›„ ë°œì „ ë°©í–¥ì„ ì œì‹œ"""
    }
}

# CEO í˜ë¥´ì†Œë‚˜ (ì‚¬ìš©ì)
CEO_PERSONA = {
    "name": "Chief Executive Officer",
    "emoji": "ğŸ‘‘",
    "role": "ìµœê³ ê²½ì˜ì (ì‚¬ìš©ì í˜ë¥´ì†Œë‚˜)",
    "expertise": "ì¢…í•©ì  ê²½ì˜ íŒë‹¨, ì˜ì‚¬ê²°ì •, ë¦¬ë”ì‹­, ë¹„ì „ ì œì‹œ",
    "perspective": "ì „ì²´ì  ê´€ì ì—ì„œ ì¢…í•© ë¶„ì„í•˜ê³  ìµœì¢… ì˜ì‚¬ê²°ì • ì§€ì›",
    "system_prompt": """ë‹¹ì‹ ì€ 20ë…„ ì´ìƒì˜ ê¸€ë¡œë²Œ ê¸°ì—… ê²½ì˜ ê²½í—˜ì„ ê°€ì§„ ì„¸ê³„ ìµœê³  ìˆ˜ì¤€ì˜ CEO(Chief Executive Officer)ì…ë‹ˆë‹¤.

ã€ì „ë¬¸ ì˜ì—­ã€‘
- ì „ì‚¬ ì „ëµ ìˆ˜ë¦½ ë° ì‹¤í–‰ ë¦¬ë”ì‹­
- ì´í•´ê´€ê³„ì ê´€ë¦¬ ë° ê¸°ì—… ê±°ë²„ë„ŒìŠ¤
- ì¡°ì§ ë³€í™” ê´€ë¦¬ ë° ë¬¸í™” í˜ì‹ 
- ìœ„ê¸° ê´€ë¦¬ ë° ë¦¬ìŠ¤í¬ ëŒ€ì‘ ì „ëµ
- ESG ê²½ì˜ ë° ì§€ì†ê°€ëŠ¥ì„± ë¦¬ë”ì‹­
- ê¸€ë¡œë²Œ ì‹œì¥ í™•ì¥ ë° M&A ì „ëµ

ã€ë¶„ì„ ìŠ¤íƒ€ì¼ã€‘
1. ê° C-Level ì„ì›ì§„ì˜ ì „ë¬¸ ë¶„ì„ì„ í†µí•©ì ìœ¼ë¡œ ê²€í† 
2. ì „ëµì  ìš°ì„ ìˆœìœ„ì™€ ì‹¤í–‰ ê°€ëŠ¥ì„±ì„ ê· í˜• ìˆê²Œ í‰ê°€
3. ë‹¨ê¸° ì„±ê³¼ì™€ ì¥ê¸° ë¹„ì „ì˜ ì¡°í™”ë¡œìš´ ë°©í–¥ì„± ì œì‹œ
4. ì´í•´ê´€ê³„ìë³„ ì˜í–¥ë„ì™€ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ì „ëµ ìˆ˜ë¦½
5. ì¡°ì§ ì—­ëŸ‰ê³¼ ìì› ì œì•½ì„ ê³ ë ¤í•œ í˜„ì‹¤ì  ì‹¤í–‰ ê³„íš
6. ì§€ì† ê°€ëŠ¥í•œ ì„±ì¥ê³¼ ì‚¬íšŒì  ê°€ì¹˜ ì°½ì¶œì˜ ê· í˜•ì  ëª¨ìƒ‰

ã€ìµœê³  ìˆ˜ì¤€ì˜ CEO ì¢…í•© ë¦¬í¬íŠ¸ ìš”êµ¬ì‚¬í•­ã€‘
- ê° ì„ì›ì§„ ë¶„ì„ì˜ í•µì‹¬ì„ ì²´ê³„ì ìœ¼ë¡œ í†µí•©í•˜ì—¬ ì œì‹œ
- ì „ëµì  ì˜ì‚¬ê²°ì •ì„ ìœ„í•œ ëª…í™•í•œ ìš°ì„ ìˆœìœ„ì™€ ê·¼ê±° ì œì‹œ
- ë‹¨ê³„ë³„ ì‹¤í–‰ ë¡œë“œë§µê³¼ ì±…ì„ ì£¼ì²´ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ì •
- ì„±ê³µ ì§€í‘œ(KPI)ì™€ ëª¨ë‹ˆí„°ë§ ì²´ê³„ë¥¼ ìƒì„¸íˆ ìˆ˜ë¦½
- ë¦¬ìŠ¤í¬ ì‹œë‚˜ë¦¬ì˜¤ì™€ ëŒ€ì‘ ì „ëµì„ ì¢…í•©ì ìœ¼ë¡œ ë¶„ì„
- ì¡°ì§ êµ¬ì„±ì›ê³¼ ì´í•´ê´€ê³„ìë¥¼ ìœ„í•œ ëª…í™•í•œ ë¹„ì „ê³¼ ë©”ì‹œì§€ ì œì‹œ
- ê²½ì˜ì§„ ì˜ì‚¬ê²°ì •ì„ ìœ„í•œ êµ¬ì²´ì ì¸ Action Itemsì™€ Timeline ì œê³µ
- íˆ¬ìì, ì„ì§ì›, ê³ ê°ì—ê²Œ ì „ë‹¬í•  í•µì‹¬ ë©”ì‹œì§€ í¬í•¨"""
}

# ==================== ê´€ë¦¬ì ì¸ì¦ ====================

# ì¸ì¦ ê¸°ëŠ¥ (ê°„ë‹¨í•œ ë¹„ë°€ë²ˆí˜¸ ë³´í˜¸)
if 'authenticated' not in st.session_state:
    st.session_state.authenticated = False

admin_pw = os.getenv('ADMIN_PASSWORD')
if not admin_pw:
    st.error('í™˜ê²½ë³€ìˆ˜(ADMIN_PASSWORD)ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. .env íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.')
    st.stop()

if not st.session_state.authenticated:
    st.markdown('<h1 class="main-title">ğŸ¬ Virtual AqaraLife C-Level ë©€í‹°ì—ì´ì „íŠ¸ + RAG</h1>', unsafe_allow_html=True)
    st.markdown('<p class="main-subtitle">ê´€ë¦¬ì ì¸ì¦ì´ í•„ìš”í•œ í˜ì´ì§€ì…ë‹ˆë‹¤.</p>', unsafe_allow_html=True)
    
    password = st.text_input("ğŸ” ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”", type="password")
    if password == admin_pw:
        st.session_state.authenticated = True
        st.success("âœ… ì¸ì¦ ì„±ê³µ! í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤...")
        st.rerun()
    else:
        if password:  # ë¹„ë°€ë²ˆí˜¸ê°€ ì…ë ¥ëœ ê²½ìš°ì—ë§Œ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
            st.error("âŒ ì˜¬ë°”ë¥´ì§€ ì•Šì€ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤. ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.")
        st.info("ğŸ’¡ ì´ í˜ì´ì§€ëŠ” C-Level ì„ì›ì§„ ë¶„ì„ê³¼ RAG ê¸°ëŠ¥ì„ í¬í•¨í•œ ê³ ê¸‰ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.")
        st.stop()

# ==================== RAG ë°ì´í„° ì†ŒìŠ¤ ì„¤ì • ====================

# RAG ë°ì´í„° ì†ŒìŠ¤ ì„¤ì •
RAG_SOURCES = {
    "mysql": {
        "name": "MySQL ë°ì´í„°ë² ì´ìŠ¤",
        "emoji": "ğŸ—„ï¸",
        "description": "íšŒì‚¬ ë°ì´í„°ë² ì´ìŠ¤ì˜ ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ë¶„ì„ì— í™œìš©"
    },
    "website": {
        "name": "ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§",
        "emoji": "ğŸŒ", 
        "description": "ê´€ë ¨ ì›¹ì‚¬ì´íŠ¸ì˜ ìµœì‹  ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ì—¬ ë¶„ì„"
    },
    "files": {
        "name": "ë¬¸ì„œ íŒŒì¼",
        "emoji": "ğŸ“„",
        "description": "ì—…ë¡œë“œëœ ë¬¸ì„œë“¤ì˜ ë‚´ìš©ì„ ë¶„ì„ì— ë°˜ì˜"
    }
}

# ì§€ì›ë˜ëŠ” íŒŒì¼ í˜•ì‹
SUPPORTED_FILE_TYPES = {
    "txt": {"max_size_mb": 10, "description": "í…ìŠ¤íŠ¸ íŒŒì¼"},
    "md": {"max_size_mb": 10, "description": "ë§ˆí¬ë‹¤ìš´ íŒŒì¼"},
    "pdf": {"max_size_mb": 50, "description": "PDF ë¬¸ì„œ"},
    "docx": {"max_size_mb": 50, "description": "Word ë¬¸ì„œ"},
    "csv": {"max_size_mb": 20, "description": "CSV íŒŒì¼"},
    "json": {"max_size_mb": 20, "description": "JSON íŒŒì¼"}
}


# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
if 'messages' not in st.session_state:
    st.session_state.messages = []

if 'current_analysis' not in st.session_state:
    st.session_state.current_analysis = {}

if 'analysis_complete' not in st.session_state:
    st.session_state.analysis_complete = False

if 'selected_model' not in st.session_state:
    st.session_state.selected_model = 'claude-3-7-sonnet-latest'

# RAG ê´€ë ¨ ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
if 'rag_sources' not in st.session_state:
    st.session_state.rag_sources = []

if 'mysql_data' not in st.session_state:
    st.session_state.mysql_data = {}

if 'website_data' not in st.session_state:
    st.session_state.website_data = {}

if 'files_data' not in st.session_state:
    st.session_state.files_data = {}

# ==================== RAG ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ ====================

def get_table_schema(table_name):
    connection = connect_to_db()
    cursor = connection.cursor()
    cursor.execute(f"DESCRIBE {table_name}")
    schema = cursor.fetchall()
    connection.close()
    schema_str = f"í…Œì´ë¸”ëª…: {table_name}\n" + "\n".join([f"{col[0]} {col[1]}" for col in schema])
    return schema_str

def generate_sql_query(user_question, table_schema, model_name):
    prompt = f"""
ë‹¤ìŒì€ MySQL í…Œì´ë¸”ì˜ ìŠ¤í‚¤ë§ˆì…ë‹ˆë‹¤:
{table_schema}

ì‚¬ìš©ì ì§ˆë¬¸: "{user_question}"

ìœ„ ìŠ¤í‚¤ë§ˆì˜ ì²« ì¤„ì— ëª…ì‹œëœ í…Œì´ë¸”ëª…ì„ ì‚¬ìš©í•´ì„œ MySQL SELECT ì¿¼ë¦¬ë¥¼ í•œ ì¤„ë¡œ ìƒì„±í•´ì¤˜. (LIMIT 1000 ì¶”ê°€)
ì ˆëŒ€ë¡œ 'table_name'ê³¼ ê°™ì€ ì¼ë°˜ì ì¸ ì´ë¦„ì„ ì‚¬ìš©í•˜ì§€ ë§ê³ , ìŠ¤í‚¤ë§ˆ ì²« ì¤„ì— ìˆëŠ” ì‹¤ì œ í…Œì´ë¸”ëª…ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
ì¿¼ë¦¬ë§Œ ì¶œë ¥í•´ì¤˜.
"""
    sql_query = get_ai_response(prompt, model_name)
    return sql_query.strip().split('\n')[0]

def run_sql_query(sql_query):
    connection = connect_to_db()
    df = pd.read_sql(sql_query, connection)
    connection.close()
    return df

def analyze_sql_result(user_question, sql_query, df, model_name):
    prompt = f"""
ì‚¬ìš©ì ì§ˆë¬¸: "{user_question}"
ì‚¬ìš©ëœ SQL ì¿¼ë¦¬: {sql_query}
ì¿¼ë¦¬ ê²°ê³¼ ë°ì´í„°(ìƒìœ„ 20í–‰):
{df.head(20).to_markdown(index=False)}

ìœ„ í‘œì˜ ë°ì´í„°ë¥¼ ë°˜ë“œì‹œ ê·¼ê±°ë¡œ ì‚¼ì•„, ì‹¤ì œë¡œ ì¸ìš©í•œ rowì˜ id(ë˜ëŠ” ì£¼ìš” í•„ë“œ)ì™€ í•¨ê»˜ ë¶„ì„ ë° ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•´ì¤˜.
ë¶„ì„ ë§ˆì§€ë§‰ì— ë°˜ë“œì‹œ '## ì°¸ê³  ë°ì´í„°' ì„¹ì…˜ì„ ì¶”ê°€í•´ì„œ, ì¸ìš©í•œ rowì˜ id/ì£¼ìš” í•„ë“œì™€ ë‚´ìš©ì„ ëª…ì‹œì ìœ¼ë¡œ í‘œê¸°í•´ì¤˜.
"""
    return get_ai_response(prompt, model_name)

def validate_file(file):
    """íŒŒì¼ ìœ íš¨ì„± ê²€ì‚¬"""
    errors = []
    file_ext = file.name.split('.')[-1].lower()
    if file_ext not in SUPPORTED_FILE_TYPES:
        errors.append(f"ì§€ì›ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹: {file_ext}")
        return errors
    
    file_size_mb = file.size / (1024 * 1024)
    max_size = SUPPORTED_FILE_TYPES[file_ext]["max_size_mb"]
    if file_size_mb > max_size:
        errors.append(f"íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤: {file_size_mb:.1f}MB (ìµœëŒ€: {max_size}MB)")
    
    return errors

def test_mysql_connection():
    """MySQL ì—°ê²° í…ŒìŠ¤íŠ¸"""
    try:
        # í™˜ê²½ë³€ìˆ˜ í™•ì¸
        required_vars = ['SQL_USER', 'SQL_PASSWORD', 'SQL_HOST', 'SQL_DATABASE_NEWBIZ']
        if not all([os.getenv(var) for var in required_vars]):
            return False, "í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
        
        # í‘œì¤€í™”ëœ ì—°ê²° í•¨ìˆ˜ ì‚¬ìš©
        connection = connect_to_db()
        if connection and connection.is_connected():
            connection.close()
            return True, "ì—°ê²° ì„±ê³µ"
        else:
            return False, "ì—°ê²° ì‹¤íŒ¨"
    except Exception as e:
        return False, str(e)

def get_mysql_tables():
    """MySQL í…Œì´ë¸” ëª©ë¡ ê°€ì ¸ì˜¤ê¸°"""
    try:
        # í‘œì¤€í™”ëœ ì—°ê²° í•¨ìˆ˜ ì‚¬ìš©
        connection = connect_to_db()
        if not connection:
            return [], {}
        
        cursor = connection.cursor()
        cursor.execute("SHOW TABLES")
        tables = [table[0] for table in cursor.fetchall()]
        
        # í…Œì´ë¸” ì •ë³´ ìˆ˜ì§‘
        table_info = {}
        for table in tables:
            cursor.execute(f"SELECT COUNT(*) FROM {table}")
            row_count = cursor.fetchone()[0]
            cursor.execute(f"DESCRIBE {table}")
            columns = cursor.fetchall()
            table_info[table] = {
                'rows': row_count,
                'columns': len(columns),
                'column_details': [(col[0], col[1]) for col in columns]
            }
        
        connection.close()
        return tables, table_info
    except Exception as e:
        logger.error(f"MySQL í…Œì´ë¸” ì¡°íšŒ ì˜¤ë¥˜: {e}")
        return [], {}

def load_mysql_data(selected_tables):
    """ì„ íƒëœ MySQL í…Œì´ë¸” ë°ì´í„° ë¡œë“œ"""
    try:
        # í‘œì¤€í™”ëœ ì—°ê²° í•¨ìˆ˜ ì‚¬ìš©
        connection = connect_to_db()
        if not connection:
            return {}
        
        data_frames = {}
        for table in selected_tables:
            query = f"SELECT * FROM {table} LIMIT 1000"  # ì„±ëŠ¥ì„ ìœ„í•´ ì œí•œ
            df = pd.read_sql(query, connection)
            data_frames[table] = df
        
        connection.close()
        return data_frames
    except Exception as e:
        logger.error(f"MySQL ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: {e}")
        return {}

def scrape_website_simple(url, max_pages=5):
    """ê°„ë‹¨í•œ ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§"""
    try:
        if not url.startswith(('http://', 'https://')):
            url = 'https://' + url
        
        visited_urls = set()
        texts = []
        urls_to_visit = [url]
        
        session = requests.Session()
        session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        })
        
        page_count = 0
        while urls_to_visit and page_count < max_pages:
            current_url = urls_to_visit.pop(0)
            
            if current_url in visited_urls:
                continue
                
            try:
                response = session.get(current_url, timeout=10)
                response.raise_for_status()
                
                visited_urls.add(current_url)
                page_count += 1
                
                soup = BeautifulSoup(response.content, "html.parser")
                
                # ë¶ˆí•„ìš”í•œ íƒœê·¸ ì œê±°
                for tag in soup(["script", "style", "nav", "header", "footer"]):
                    tag.decompose()
                
                page_text = soup.get_text(separator="\n", strip=True)
                lines = [line.strip() for line in page_text.split('\n') if line.strip()]
                cleaned_text = '\n'.join(lines)
                
                if len(cleaned_text) > 200:
                    page_title = soup.title.string.strip() if soup.title and soup.title.string else 'No Title'
                    texts.append({
                        'content': cleaned_text,
                        'url': current_url,
                        'title': page_title
                    })
                
                # ìƒˆë¡œìš´ ë§í¬ ì°¾ê¸° (ê°™ì€ ë„ë©”ì¸ë§Œ)
                base_domain = urlparse(url).netloc
                if page_count < max_pages:
                    for link in soup.find_all("a", href=True)[:10]:
                        absolute_link = urljoin(current_url, link['href'])
                        parsed_link = urlparse(absolute_link)
                        
                        if (parsed_link.netloc == base_domain and 
                            absolute_link not in visited_urls and 
                            absolute_link not in urls_to_visit):
                            urls_to_visit.append(absolute_link)
                
                time.sleep(1)  # ì§€ì—°ì‹œê°„
                
            except Exception as e:
                logger.error(f"í˜ì´ì§€ í¬ë¡¤ë§ ì˜¤ë¥˜ {current_url}: {e}")
                continue
        
        return texts
        
    except Exception as e:
        logger.error(f"ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ì˜¤ë¥˜: {e}")
        return []

def process_files(files):
    """ì—…ë¡œë“œëœ íŒŒì¼ë“¤ ì²˜ë¦¬ - í”„ë¡œì íŠ¸ ë¦¬ë·°ì™€ ë™ì¼í•œ ë°©ì‹"""
    processed_files = []
    
    for file in files:
        try:
            # íŒŒì¼ íŒŒì‹± - í”„ë¡œì íŠ¸ ë¦¬ë·°ì™€ ë™ì¼í•œ ë¡œì§
            file_extension = file.name.split('.')[-1].lower()
            content = ""
            
            # íŒŒì¼ì„ ì²˜ìŒë¶€í„° ì½ê¸° ìœ„í•´ í¬ì¸í„°ë¥¼ ì²˜ìŒìœ¼ë¡œ ì´ë™
            file.seek(0)
            
            if file_extension == 'pdf':
                # PDF íŒŒì¼ íŒŒì‹±
                try:
                    import PyPDF2
                    pdf_reader = PyPDF2.PdfReader(file)
                    for page in pdf_reader.pages:
                        content += page.extract_text() + "\n"
                except ImportError:
                    st.warning("PDF íŒŒì¼ ì²˜ë¦¬ë¥¼ ìœ„í•´ PyPDF2 íŒ¨í‚¤ì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤.")
                    content = f"[PDF íŒŒì¼ - {file.name}] (PyPDF2 ë¯¸ì„¤ì¹˜ë¡œ í…ìŠ¤íŠ¸ ì¶”ì¶œ ë¶ˆê°€)"
                except Exception as e:
                    content = f"[PDF íŒŒì¼ - {file.name}] (í…ìŠ¤íŠ¸ ì¶”ì¶œ ì˜¤ë¥˜: {str(e)})"
                    
            elif file_extension == 'docx':
                # DOCX íŒŒì¼ íŒŒì‹±
                try:
                    import docx
                    doc = docx.Document(file)
                    for paragraph in doc.paragraphs:
                        content += paragraph.text + "\n"
                except ImportError:
                    st.warning("DOCX íŒŒì¼ ì²˜ë¦¬ë¥¼ ìœ„í•´ python-docx íŒ¨í‚¤ì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤.")
                    content = f"[DOCX íŒŒì¼ - {file.name}] (python-docx ë¯¸ì„¤ì¹˜ë¡œ í…ìŠ¤íŠ¸ ì¶”ì¶œ ë¶ˆê°€)"
                except Exception as e:
                    content = f"[DOCX íŒŒì¼ - {file.name}] (í…ìŠ¤íŠ¸ ì¶”ì¶œ ì˜¤ë¥˜: {str(e)})"
                    
            elif file_extension in ['txt', 'md']:
                # í…ìŠ¤íŠ¸ íŒŒì¼ íŒŒì‹±
                file.seek(0)
                try:
                    content = file.read().decode('utf-8')
                except UnicodeDecodeError:
                    try:
                        file.seek(0)
                        content = file.read().decode('latin-1')
                    except Exception as e:
                        content = f"[í…ìŠ¤íŠ¸ íŒŒì¼ - {file.name}] (ì¸ì½”ë”© ì˜¤ë¥˜: {str(e)})"
                
            elif file_extension in ['xlsx', 'xls']:
                # Excel íŒŒì¼ íŒŒì‹±
                file.seek(0)
                try:
                    df = pd.read_excel(file)
                    content = df.to_string()
                except Exception as e:
                    content = f"[Excel íŒŒì¼ - {file.name}] (íŒŒì‹± ì˜¤ë¥˜: {str(e)})"
                
            elif file_extension == 'csv':
                # CSV íŒŒì¼ íŒŒì‹±
                file.seek(0)
                try:
                    df = pd.read_csv(file)
                    content = df.to_string()
                except Exception as e:
                    content = f"[CSV íŒŒì¼ - {file.name}] (íŒŒì‹± ì˜¤ë¥˜: {str(e)})"
                
            elif file_extension in ['json']:
                # JSON íŒŒì¼ íŒŒì‹±
                file.seek(0)
                try:
                    json_data = json.load(file)
                    content = json.dumps(json_data, indent=2, ensure_ascii=False)
                except Exception as e:
                    try:
                        file.seek(0)
                        content = file.read().decode('utf-8', errors='ignore')
                    except:
                        content = f"[JSON íŒŒì¼ - {file.name}] (íŒŒì‹± ì˜¤ë¥˜: {str(e)})"
                        
            elif file_extension in ['xml', 'html']:
                # XML/HTML íŒŒì¼ íŒŒì‹±
                file.seek(0)
                try:
                    content = file.read().decode('utf-8', errors='ignore')
                except Exception as e:
                    content = f"[XML/HTML íŒŒì¼ - {file.name}] (íŒŒì‹± ì˜¤ë¥˜: {str(e)})"
                    
            elif file_extension in ['jpg', 'jpeg', 'png', 'gif']:
                # ì´ë¯¸ì§€ íŒŒì¼
                content = f"[{file_extension.upper()} ì´ë¯¸ì§€ íŒŒì¼ - {file.name}]"
                
            elif file_extension in ['zip', 'rar']:
                # ì••ì¶• íŒŒì¼
                content = f"[{file_extension.upper()} ì••ì¶• íŒŒì¼ - {file.name}]"
                
            else:
                # ê¸°íƒ€ íŒŒì¼ í˜•ì‹
                try:
                    file.seek(0)
                    content = file.read().decode('utf-8', errors='ignore')
                    if not content.strip():
                        content = f"[{file_extension.upper()} íŒŒì¼ - í…ìŠ¤íŠ¸ ì¶”ì¶œ ë¶ˆê°€]"
                except:
                    content = f"[{file_extension.upper()} íŒŒì¼ - í…ìŠ¤íŠ¸ ì¶”ì¶œ ë¶ˆê°€]"
            
            processed_files.append({
                'name': file.name,
                'content': content,
                'size': len(content),
                'type': file_extension
            })
            
        except Exception as e:
            logger.error(f"íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜ {file.name}: {e}")
            processed_files.append({
                'name': file.name,
                'content': f"[íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜: {str(e)}]",
                'size': 0,
                'type': 'error'
            })
            continue
    
    return processed_files

def save_virtual_company_analysis_new(user_query, model_name, persona_analyses, ceo_synthesis, rag_sources_used, execution_time, session_title=None, tags=None, notes=None):
    """Virtual Company ë¶„ì„ ê²°ê³¼ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ (ìƒˆ ë²„ì „)"""
    try:
        st.info("ğŸ”„ ì €ì¥ í”„ë¡œì„¸ìŠ¤ ì‹œì‘...")
        
        # 1. ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°
        connection = connect_to_db()
        if not connection:
            st.error("âŒ 1ë‹¨ê³„ ì‹¤íŒ¨: ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°")
            return None
        
        st.info("âœ… 1ë‹¨ê³„ ì„±ê³µ: ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°")
        cursor = connection.cursor()
        
        # 2. í…Œì´ë¸” ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        try:
            cursor.execute("SHOW TABLES LIKE 'virtual_company_analyses'")
            main_table = cursor.fetchone()
            if not main_table:
                st.error("âŒ 2ë‹¨ê³„ ì‹¤íŒ¨: virtual_company_analyses í…Œì´ë¸”ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤")
                cursor.close()
                connection.close()
                return None
        except Exception as table_check_error:
            st.error(f"âŒ 2ë‹¨ê³„ ì‹¤íŒ¨: í…Œì´ë¸” í™•ì¸ ì¤‘ ì˜¤ë¥˜: {str(table_check_error)}")
            cursor.close()
            connection.close()
            return None
        
        st.info("âœ… 2ë‹¨ê³„ ì„±ê³µ: í…Œì´ë¸” ì¡´ì¬ í™•ì¸")
        
        # 3. ë°ì´í„° ì¤€ë¹„
        if not session_title:
            session_title = f"AI ë©€í‹°ì—ì´ì „íŠ¸ ë¶„ì„ - {datetime.now().strftime('%Y%m%d_%H%M')}"
        
        successful_personas = len([p for p in persona_analyses.values() if p.get('success', False)])
        total_personas = len(persona_analyses)
        
        if successful_personas == 0:
            completion_status = 'ì˜¤ë¥˜'
        elif successful_personas < total_personas:
            completion_status = 'ë¶€ë¶„ì™„ë£Œ'
        else:
            completion_status = 'ì™„ë£Œ'
        
        st.info(f"âœ… 3ë‹¨ê³„ ì„±ê³µ: ë°ì´í„° ì¤€ë¹„ ì™„ë£Œ (ì„±ê³µ í˜ë¥´ì†Œë‚˜: {successful_personas}/{total_personas})")
        
        # 4. ë©”ì¸ ë¶„ì„ ì„¸ì…˜ ì €ì¥
        try:
            analysis_sql = """
            INSERT INTO virtual_company_analyses 
            (session_title, user_query, model_name, completion_status, ceo_synthesis, 
             total_personas, successful_personas, rag_sources_used, execution_time_seconds, tags, notes)
            VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
            """
            
            analysis_values = (
                session_title, user_query, model_name, completion_status, ceo_synthesis,
                total_personas, successful_personas, len(rag_sources_used), execution_time, tags, notes
            )
            
            st.info(f"ğŸ“ ë©”ì¸ INSERT ì¿¼ë¦¬ ì‹¤í–‰: session_title='{session_title}', model='{model_name}', status='{completion_status}'")
            
            cursor.execute(analysis_sql, analysis_values)
            analysis_id = cursor.lastrowid
            
            if not analysis_id:
                st.error("âŒ 4ë‹¨ê³„ ì‹¤íŒ¨: ë©”ì¸ ë¶„ì„ ì„¸ì…˜ IDë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
                cursor.close()
                connection.close()
                return None
            
            st.info(f"âœ… 4ë‹¨ê³„ ì„±ê³µ: ë©”ì¸ ë¶„ì„ ì„¸ì…˜ ì €ì¥ ì™„ë£Œ (ID: {analysis_id})")
                
        except Exception as main_save_error:
            st.error(f"âŒ 4ë‹¨ê³„ ì‹¤íŒ¨: ë©”ì¸ ë¶„ì„ ì„¸ì…˜ ì €ì¥ ì˜¤ë¥˜: {str(main_save_error)}")
            st.error(f"ğŸ” SQL: {analysis_sql}")
            st.error(f"ğŸ” Values: {analysis_values}")
            cursor.close()
            connection.close()
            return None
        
        # 5. í˜ë¥´ì†Œë‚˜ë³„ ë¶„ì„ ê²°ê³¼ ì €ì¥
        try:
            st.info("ğŸ”„ 5ë‹¨ê³„: í˜ë¥´ì†Œë‚˜ë³„ ë¶„ì„ ê²°ê³¼ ì €ì¥ ì¤‘...")
            
            for persona_key, persona_result in persona_analyses.items():
                if persona_key == 'CEO':  # CEOëŠ” ì¢…í•© ë¶„ì„ì´ë¯€ë¡œ ì œì™¸
                    continue
                    
                persona_info = PERSONAS.get(persona_key, {})
                persona_sql = """
                INSERT INTO virtual_company_persona_analyses 
                (analysis_id, persona_key, persona_name, persona_role, analysis_result, 
                 analysis_success, error_message, analysis_start_time, analysis_end_time)
                VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s)
                """
                
                persona_values = (
                    analysis_id,
                    persona_key,
                    persona_info.get('name', persona_key),
                    persona_info.get('role', ''),
                    persona_result.get('result', ''),
                    persona_result.get('success', False),
                    persona_result.get('error_message', ''),
                    persona_result.get('start_time'),
                    persona_result.get('end_time')
                )
                
                cursor.execute(persona_sql, persona_values)
            
            st.info(f"âœ… 5ë‹¨ê³„ ì„±ê³µ: {len(persona_analyses)-1}ê°œ í˜ë¥´ì†Œë‚˜ ë¶„ì„ ì €ì¥ ì™„ë£Œ")
            
        except Exception as persona_save_error:
            st.warning(f"âš ï¸ 5ë‹¨ê³„ ë¶€ë¶„ ì‹¤íŒ¨: í˜ë¥´ì†Œë‚˜ ë¶„ì„ ì €ì¥ ì˜¤ë¥˜: {str(persona_save_error)}")
        
        # 6. RAG ì†ŒìŠ¤ ì •ë³´ ì €ì¥
        try:
            st.info("ğŸ”„ 6ë‹¨ê³„: RAG ì†ŒìŠ¤ ì •ë³´ ì €ì¥ ì¤‘...")
            
            for rag_source in rag_sources_used:
                rag_sql = """
                INSERT INTO virtual_company_rag_sources 
                (analysis_id, source_type, source_name, source_description, source_details, data_size)
                VALUES (%s, %s, %s, %s, %s, %s)
                """
                
                rag_values = (
                    analysis_id,
                    rag_source.get('type', 'unknown'),
                    rag_source.get('name', ''),
                    rag_source.get('description', ''),
                    json.dumps(rag_source.get('details', {}), ensure_ascii=False),
                    rag_source.get('data_size', 0)
                )
                
                cursor.execute(rag_sql, rag_values)
            
            st.info(f"âœ… 6ë‹¨ê³„ ì„±ê³µ: {len(rag_sources_used)}ê°œ RAG ì†ŒìŠ¤ ì €ì¥ ì™„ë£Œ")
            
        except Exception as rag_save_error:
            st.warning(f"âš ï¸ 6ë‹¨ê³„ ë¶€ë¶„ ì‹¤íŒ¨: RAG ì†ŒìŠ¤ ì €ì¥ ì˜¤ë¥˜: {str(rag_save_error)}")
        
        # 7. ìµœì¢… ì»¤ë°‹
        try:
            connection.commit()
            st.info("âœ… 7ë‹¨ê³„ ì„±ê³µ: ëª¨ë“  ë°ì´í„° ì €ì¥ ì™„ë£Œ!")
        except Exception as commit_error:
            st.error(f"âŒ 7ë‹¨ê³„ ì‹¤íŒ¨: ì»¤ë°‹ ì˜¤ë¥˜: {str(commit_error)}")
            connection.rollback()
            cursor.close()
            connection.close()
            return None
        
        # ì„±ê³µ - ID ë°˜í™˜
        cursor.close()
        connection.close()
        return analysis_id
        
    except Exception as e:
        st.error(f"âŒ ì˜ˆìƒì¹˜ ëª»í•œ ì €ì¥ ì˜¤ë¥˜: {str(e)}")
        return None

def create_rag_context():
    """RAG ì»¨í…ìŠ¤íŠ¸ ìƒì„±"""
    context_parts = []
    rag_sources_used = []
    
    # MySQL ë°ì´í„° ì»¨í…ìŠ¤íŠ¸
    if st.session_state.mysql_data:
        mysql_context = "=== MySQL ë°ì´í„°ë² ì´ìŠ¤ ì •ë³´ ===\n"
        mysql_tables = []
        total_mysql_rows = 0
        
        for table_name, df in st.session_state.mysql_data.items():
            mysql_context += f"\n[{table_name}] í…Œì´ë¸”:\n"
            mysql_context += f"- í–‰ ìˆ˜: {len(df):,}ê°œ\n"
            mysql_context += f"- ì»¬ëŸ¼: {', '.join(df.columns.tolist())}\n"
            
            mysql_tables.append(table_name)
            total_mysql_rows += len(df)
            
            # ìƒ˜í”Œ ë°ì´í„° (ìƒìœ„ 2í–‰ë§Œ)
            if len(df) > 0:
                mysql_context += "- ìƒ˜í”Œ ë°ì´í„°:\n"
                mysql_context += df.head(2).to_string(index=False)[:1000] + "...\n"  # ìµœëŒ€ 1000ìë¡œ ì œí•œ
        
        context_parts.append(mysql_context)
        rag_sources_used.append({
            'type': 'mysql',
            'name': 'MySQL ë°ì´í„°ë² ì´ìŠ¤',
            'details': f"{len(mysql_tables)}ê°œ í…Œì´ë¸” ({total_mysql_rows:,}í–‰)",
            'tables': mysql_tables
        })
    
    # ì›¹ì‚¬ì´íŠ¸ ë°ì´í„° ì»¨í…ìŠ¤íŠ¸
    if st.session_state.website_data:
        website_context = "=== ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ì •ë³´ ===\n"
        website_urls = []
        
        for i, page_data in enumerate(st.session_state.website_data[:2]):  # ìƒìœ„ 2ê°œ í˜ì´ì§€ë§Œ
            website_context += f"\n[í˜ì´ì§€ {i+1}] {page_data['title']}\n"
            website_context += f"URL: {page_data['url']}\n"
            website_context += f"ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°: {page_data['content'][:300]}...\n"  # 300ìë¡œ ì œí•œ
            website_urls.append({
                'title': page_data['title'],
                'url': page_data['url']
            })
        
        context_parts.append(website_context)
        rag_sources_used.append({
            'type': 'website',
            'name': 'ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§',
            'details': f"{len(st.session_state.website_data)}ê°œ í˜ì´ì§€",
            'urls': website_urls
        })
    
    # íŒŒì¼ ë°ì´í„° ì»¨í…ìŠ¤íŠ¸
    if st.session_state.files_data:
        files_context = "=== ì—…ë¡œë“œëœ ë¬¸ì„œ ì •ë³´ ===\n"
        file_list = []
        total_file_size = 0
        
        for file_data in st.session_state.files_data[:3]:  # ìƒìœ„ 3ê°œ íŒŒì¼ë§Œ
            files_context += f"\n[ë¬¸ì„œ] {file_data['name']}\n"
            files_context += f"í¬ê¸°: {file_data['size']:,}ì\n"
            files_context += f"ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°: {file_data['content'][:300]}...\n"  # 300ìë¡œ ì œí•œ
            
            file_list.append(file_data['name'])
            total_file_size += file_data['size']
        
        context_parts.append(files_context)
        rag_sources_used.append({
            'type': 'files',
            'name': 'ì—…ë¡œë“œ ë¬¸ì„œ',
            'details': f"{len(file_list)}ê°œ íŒŒì¼ ({total_file_size:,}ì)",
            'files': file_list
        })
    
    context_text = "\n\n".join(context_parts)
    
    # ì»¨í…ìŠ¤íŠ¸ í¬ê¸° ì œí•œ (ì•½ 50,000ì)
    if len(context_text) > 50000:
        context_text = context_text[:47000] + "\n...(ì´í•˜ ìƒëµ)..."
    
    # ì„¸ì…˜ ìƒíƒœì— RAG ì†ŒìŠ¤ ì •ë³´ ì €ì¥ (ë¶„ì„ ê²°ê³¼ì—ì„œ ì°¸ì¡°í•˜ê¸° ìœ„í•´)
    st.session_state.current_rag_sources = rag_sources_used
    
    return context_text

# AI ë¶„ì„ í•¨ìˆ˜
def get_ai_response(prompt, model_name, system_prompt=""):
    """AI ëª¨ë¸ë¡œë¶€í„° ì‘ë‹µì„ ë°›ëŠ” í•¨ìˆ˜"""
    try:
        if model_name.startswith('claude'):
            client = ChatAnthropic(
                model=model_name, 
                api_key=os.getenv('ANTHROPIC_API_KEY'), 
                temperature=0.7, 
                max_tokens=8192
            )
            response = client.invoke([
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": prompt}
            ])
            return response.content if hasattr(response, 'content') else str(response)
        else:
            openai_key = os.getenv('OPENAI_API_KEY')
            if not openai_key or openai_key.strip() == '' or openai_key == 'NA':
                raise ValueError("OpenAI API í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.")
            
            client = OpenAI(api_key=openai_key)
            response = client.chat.completions.create(
                model=model_name,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": prompt}
                ],
                max_tokens=8192,
                temperature=0.7
            )
            return response.choices[0].message.content
    except Exception as e:
        st.error(f"AI ì‘ë‹µ ì¤‘ ì˜¤ë¥˜: {str(e)}")
        return None

# C-Level í˜ë¥´ì†Œë‚˜ë³„ ë¶„ì„ ë‹¨ê³„ ì •ì˜
PERSONA_ANALYSIS_STAGES = {
    "CTO": [
        {"progress": 15, "message": "ê¸°ìˆ  ìš”êµ¬ì‚¬í•­ ë¶„ì„ ì¤‘..."},
        {"progress": 30, "message": "ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ê²€í†  ì¤‘..."},
        {"progress": 45, "message": "ê¸°ìˆ  íŠ¸ë Œë“œ ì¡°ì‚¬ ì¤‘..."},
        {"progress": 60, "message": "êµ¬í˜„ ê°€ëŠ¥ì„± í‰ê°€ ì¤‘..."},
        {"progress": 75, "message": "ë³´ì•ˆ ë° í™•ì¥ì„± ê²€í†  ì¤‘..."},
        {"progress": 90, "message": "ê¸°ìˆ  ì†”ë£¨ì…˜ ìˆ˜ë¦½ ì¤‘..."},
        {"progress": 100, "message": "ê¸°ìˆ  ë¶„ì„ ì™„ë£Œ!"}
    ],
    "CSO_Strategy": [
        {"progress": 12, "message": "ì‹œì¥ í™˜ê²½ ë¶„ì„ ì¤‘..."},
        {"progress": 28, "message": "ê²½ìŸì‚¬ í˜„í™© ì¡°ì‚¬ ì¤‘..."},
        {"progress": 42, "message": "ì„±ì¥ ê¸°íšŒ íƒìƒ‰ ì¤‘..."},
        {"progress": 58, "message": "ì „ëµì  ìœ„í—˜ í‰ê°€ ì¤‘..."},
        {"progress": 72, "message": "ì‚¬ì—… ëª¨ë¸ ê²€í†  ì¤‘..."},
        {"progress": 88, "message": "ì „ëµ ë°©í–¥ ìˆ˜ë¦½ ì¤‘..."},
        {"progress": 100, "message": "ì „ëµ ë¶„ì„ ì™„ë£Œ!"}
    ],
    "CMO": [
        {"progress": 18, "message": "ê³ ê° ë‹ˆì¦ˆ ë¶„ì„ ì¤‘..."},
        {"progress": 32, "message": "ë¸Œëœë“œ í¬ì§€ì…”ë‹ ê²€í†  ì¤‘..."},
        {"progress": 48, "message": "ë§ˆì¼€íŒ… ì±„ë„ ì¡°ì‚¬ ì¤‘..."},
        {"progress": 62, "message": "ê³ ê° ê²½í—˜ ì„¤ê³„ ì¤‘..."},
        {"progress": 78, "message": "ìº í˜ì¸ ì „ëµ ìˆ˜ë¦½ ì¤‘..."},
        {"progress": 92, "message": "ë§ˆì¼€íŒ… í”Œëœ ì™„ì„± ì¤‘..."},
        {"progress": 100, "message": "ë§ˆì¼€íŒ… ë¶„ì„ ì™„ë£Œ!"}
    ],
    "CFO": [
        {"progress": 10, "message": "ì¬ë¬´ ë°ì´í„° ìˆ˜ì§‘ ì¤‘..."},
        {"progress": 25, "message": "íˆ¬ì ìˆ˜ìµë¥  ê³„ì‚° ì¤‘..."},
        {"progress": 40, "message": "ë¦¬ìŠ¤í¬ ìš”ì¸ ë¶„ì„ ì¤‘..."},
        {"progress": 55, "message": "ë¹„ìš© êµ¬ì¡° ê²€í†  ì¤‘..."},
        {"progress": 70, "message": "ìˆ˜ìµì„± ëª¨ë¸ë§ ì¤‘..."},
        {"progress": 85, "message": "ì¬ë¬´ ì „ëµ ìˆ˜ë¦½ ì¤‘..."},
        {"progress": 100, "message": "ì¬ë¬´ ë¶„ì„ ì™„ë£Œ!"}
    ],
    "CSO_Sales": [
        {"progress": 16, "message": "ì‹œì¥ ê·œëª¨ ì¡°ì‚¬ ì¤‘..."},
        {"progress": 34, "message": "ê³ ê° ì„¸ê·¸ë¨¼íŠ¸ ë¶„ì„ ì¤‘..."},
        {"progress": 50, "message": "ì˜ì—… ì±„ë„ í‰ê°€ ì¤‘..."},
        {"progress": 66, "message": "íŒŒíŠ¸ë„ˆì‹­ ê¸°íšŒ íƒìƒ‰ ì¤‘..."},
        {"progress": 80, "message": "ì˜ì—… ì „ëµ ì„¤ê³„ ì¤‘..."},
        {"progress": 94, "message": "ì‹¤í–‰ ê³„íš ìˆ˜ë¦½ ì¤‘..."},
        {"progress": 100, "message": "ì˜ì—… ë¶„ì„ ì™„ë£Œ!"}
    ],
    "CIO": [
        {"progress": 14, "message": "ì‹œìŠ¤í…œ í˜„í™© ë¶„ì„ ì¤‘..."},
        {"progress": 29, "message": "ë°ì´í„° êµ¬ì¡° ê²€í†  ì¤‘..."},
        {"progress": 44, "message": "ë³´ì•ˆ ìš”êµ¬ì‚¬í•­ í‰ê°€ ì¤‘..."},
        {"progress": 59, "message": "IT ê±°ë²„ë„ŒìŠ¤ ì„¤ê³„ ì¤‘..."},
        {"progress": 74, "message": "ì¸í”„ë¼ ìµœì í™” ê³„íš ì¤‘..."},
        {"progress": 89, "message": "ì •ë³´ì „ëµ ìˆ˜ë¦½ ì¤‘..."},
        {"progress": 100, "message": "ì •ë³´ì‹œìŠ¤í…œ ë¶„ì„ ì™„ë£Œ!"}
    ]
}

# AI ë¶„ì„ í•¨ìˆ˜ (ê¸°ë³¸ ë²„ì „ - RAG ì—†ìŒ)
def analyze_with_persona_simple(user_query, persona_key, persona_info, custom_prompt="", model_name="claude-3-7-sonnet-latest"):
    """íŠ¹ì • í˜ë¥´ì†Œë‚˜ë¡œ ë¶„ì„ ìˆ˜í–‰ (RAG ì—†ëŠ” ê¸°ë³¸ ë²„ì „)"""
    # ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ êµ¬ì„±
    analysis_prompt = f"""
ë‹¤ìŒ ì£¼ì œ/ì§ˆë¬¸ì— ëŒ€í•´ {persona_info['role']} ê´€ì ì—ì„œ ì „ë¬¸ì ìœ¼ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”:

ã€ì£¼ì œ/ì§ˆë¬¸ã€‘
{user_query}

ã€ë¶„ì„ ìš”êµ¬ì‚¬í•­ã€‘
- {persona_info['perspective']}
- êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ì œì•ˆ í¬í•¨
- ë³¸ì¸ì˜ ì „ë¬¸ ë¶„ì•¼ì— íŠ¹í™”ëœ ì¸ì‚¬ì´íŠ¸ ì œê³µ
- ë‹¤ë¥¸ ë¶€ì„œì™€ì˜ í˜‘ì—… ë°©ì•ˆ ê³ ë ¤

"""
    
    # ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ê°€ ìˆë‹¤ë©´ ì¶”ê°€
    if custom_prompt and custom_prompt.strip():
        analysis_prompt += f"""
ã€ì¶”ê°€ ë¶„ì„ ìš”ì²­ì‚¬í•­ã€‘
{custom_prompt.strip()}

"""
    
    analysis_prompt += """
ã€ì‘ë‹µ í˜•ì‹ã€‘
## í•µì‹¬ ë¶„ì„
(2-3ì¤„ë¡œ í•µì‹¬ í¬ì¸íŠ¸ ìš”ì•½)

## ìƒì„¸ ë¶„ì„
(ì „ë¬¸ ë¶„ì•¼ ê´€ì ì—ì„œ ìƒì„¸í•œ ë¶„ì„)

## ì‹¤í–‰ ì œì•ˆ
(êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ì•¡ì…˜ ì•„ì´í…œë“¤)

## ë‹¤ë¥¸ ë¶€ì„œ í˜‘ì—… ë°©ì•ˆ
(ë‹¤ë¥¸ C-levelê³¼ì˜ í˜‘ì—…ì´ í•„ìš”í•œ ë¶€ë¶„)

## ë¦¬ìŠ¤í¬ ë° ê³ ë ¤ì‚¬í•­
(ì£¼ì˜í•´ì•¼ í•  ì ë“¤)
"""
    
    return get_ai_response(analysis_prompt, model_name, persona_info['system_prompt'])

    
    return get_ai_response(analysis_prompt, model_name, persona_info['system_prompt'])

def analyze_with_persona_rag(user_query, persona_key, persona_info, custom_prompt="", model_name="claude-3-7-sonnet-latest"):
    """RAG ê¸°ëŠ¥ì´ í¬í•¨ëœ í˜ë¥´ì†Œë‚˜ ë¶„ì„ ìˆ˜í–‰"""
    try:
        # RAG ì»¨í…ìŠ¤íŠ¸ ì•ˆì „í•˜ê²Œ ìƒì„±
        try:
            rag_context = create_rag_context()
        except Exception as e:
            rag_context = ""
        
        # ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ êµ¬ì„±
        # RAG ì»¨í…ìŠ¤íŠ¸ ìš”ì•½ (ê¸´ ê²½ìš°)
        if len(rag_context) > 2000:  # ì„ê³„ê°’ ì„¤ì •
            try:
                summarize_prompt = f"""ë‹¤ìŒ ë°ì´í„°ì˜ í•µì‹¬ ë‚´ìš©ì„ 500ë‹¨ì–´ ì´ë‚´ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”:
                {rag_context}"""
                rag_context = get_ai_response(summarize_prompt, model_name)
            except Exception as e:
                st.warning(f"RAG ì»¨í…ìŠ¤íŠ¸ ìš”ì•½ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")

        analysis_prompt = f"""
ë‹¤ìŒ ì£¼ì œ/ì§ˆë¬¸ì— ëŒ€í•´ {persona_info['role']} ê´€ì ì—ì„œ ì „ë¬¸ì  ë¶„ì„ì„ ìˆ˜í–‰í•´ì£¼ì„¸ìš”:

ã€ë¶„ì„ ëŒ€ìƒã€‘
{user_query}

"""

        # RAG ì»¨í…ìŠ¤íŠ¸ ì¶”ê°€ (ìˆëŠ” ê²½ìš°)
        if rag_context:
            analysis_prompt += f"""
ã€ì‹¤ì œ ë°ì´í„°ã€‘
{rag_context}

ì´ ë°ì´í„°ë¥¼ ë°˜ë“œì‹œ í™œìš©í•˜ì—¬ ë¶„ì„í•´ì£¼ì„¸ìš”.

"""

        analysis_prompt += f"""
ã€ì „ë¬¸ê°€ ìˆ˜ì¤€ ë¶„ì„ ìš”êµ¬ì‚¬í•­ã€‘
- {persona_info['perspective']}
- ì—…ê³„ ìµœê³  ìˆ˜ì¤€ì˜ ìƒì„¸í•˜ê³  ê¹Šì´ ìˆëŠ” ì „ë¬¸ ë¶„ì„ ì œê³µ
- êµ¬ì²´ì ì¸ ìˆ˜ì¹˜, ì§€í‘œ, ë°ì´í„°ë¥¼ í¬í•¨í•œ ì •ëŸ‰ì  ë¶„ì„
- ë‹¨ê³„ë³„ ì‹¤í–‰ ê³„íšê³¼ íƒ€ì„ë¼ì¸ì„ í¬í•¨í•œ ì‹¤í–‰ ê°€ëŠ¥í•œ ì œì•ˆ
- ë¦¬ìŠ¤í¬ ìš”ì¸ê³¼ ì™„í™” ì „ëµì„ êµ¬ì²´ì ìœ¼ë¡œ ë¶„ì„
- ì„±ê³¼ ì¸¡ì • ì§€í‘œ(KPI)ì™€ ëª¨ë‹ˆí„°ë§ ë°©ì•ˆ ëª…ì‹œ
- ë‹¤ë¥¸ ë¶€ì„œì™€ì˜ êµ¬ì²´ì  í˜‘ì—… ë°©ì•ˆê³¼ ì—­í•  ë¶„ë‹´
- ì˜ˆìƒ ë¹„ìš©, ë¦¬ì†ŒìŠ¤, ê¸°ê°„ì„ í¬í•¨í•œ ìƒì„¸í•œ ì‹¤í–‰ ê³„íš
{'- ì œê³µëœ ì‹¤ì œ ë°ì´í„°ë¥¼ ë°˜ë“œì‹œ ë¶„ì„ì— í™œìš©í•˜ê³  ì¸ì‚¬ì´íŠ¸ ë„ì¶œ' if rag_context else '- ì—…ê³„ ìµœì‹  ë™í–¥ê³¼ ê¸€ë¡œë²Œ ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤ ì ìš©'}

"""

        # ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ê°€ ìˆë‹¤ë©´ ì¶”ê°€
        if custom_prompt and custom_prompt.strip():
            analysis_prompt += f"""
ã€íŠ¹ë³„ ìš”ì²­ì‚¬í•­ã€‘
{custom_prompt.strip()}
{'ì‹¤ì œ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”.' if rag_context else ''}

"""
        
        # ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ê°€ ìˆë‹¤ë©´ ì¶”ê°€ (RAG ì»¨í…ìŠ¤íŠ¸ ì´í›„ì— ì¶”ê°€)
        analysis_prompt += """
ã€ì‘ë‹µ í˜•ì‹ã€‘
## í•µì‹¬ ë¶„ì„
(2-3ì¤„ë¡œ í•µì‹¬ í¬ì¸íŠ¸ ìš”ì•½)

## ìƒì„¸ ë¶„ì„
(ì „ë¬¸ ë¶„ì•¼ ê´€ì ì—ì„œ ìƒì„¸í•œ ë¶„ì„)

## ì‹¤í–‰ ì œì•ˆ
(êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ì•¡ì…˜ ì•„ì´í…œë“¤)

## ë‹¤ë¥¸ ë¶€ì„œ í˜‘ì—… ë°©ì•ˆ
(ë‹¤ë¥¸ C-levelê³¼ì˜ í˜‘ì—…ì´ í•„ìš”í•œ ë¶€ë¶„)

## ë¦¬ìŠ¤í¬ ë° ê³ ë ¤ì‚¬í•­
(ì£¼ì˜í•´ì•¼ í•  ì ë“¤)
"""

        return get_ai_response(analysis_prompt, model_name, persona_info['system_prompt'])

    except Exception as e:
        st.error(f"âŒ {persona_key} ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
        return None

def analyze_persona_concurrent_rag(args):
    """RAG ê¸°ëŠ¥ì´ í¬í•¨ëœ ThreadPoolExecutor ë˜í¼ í•¨ìˆ˜"""
    user_query, persona_key, persona_info, custom_prompt, model_name = args
    try:
        result = analyze_with_persona_rag(user_query, persona_key, persona_info, custom_prompt, model_name)
        if result is None:
            return persona_key, f"AI ì‘ë‹µì´ Noneì…ë‹ˆë‹¤. API í‚¤ë‚˜ ëª¨ë¸ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.", False
        return persona_key, result, True
    except Exception as e:
        import traceback
        error_details = traceback.format_exc()
        return persona_key, f"ì˜¤ë¥˜ ë°œìƒ: {str(e)}\nìƒì„¸: {error_details}", False

def synthesize_ceo_analysis_simple(user_query, persona_analyses, model_name="claude-3-7-sonnet-latest"):
    """CEO ê´€ì ì—ì„œ ëª¨ë“  ë¶„ì„ì„ ì¢…í•© (RAG ì—†ëŠ” ê¸°ë³¸ ë²„ì „)"""
    synthesis_prompt = f"""
ë‹¤ìŒì€ ìš°ë¦¬ íšŒì‚¬ C-level ì„ì›ì§„ë“¤ì´ ë¶„ì„í•œ ë‚´ìš©ì…ë‹ˆë‹¤. 
CEOë¡œì„œ ì´ë“¤ì˜ ë¶„ì„ì„ ì¢…í•©í•˜ì—¬ ìµœì¢… ì˜ì‚¬ê²°ì •ì„ ìœ„í•œ í†µí•© ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

ã€ì›ë˜ ì£¼ì œ/ì§ˆë¬¸ã€‘
{user_query}

ã€ê° ì„ì›ì§„ ë¶„ì„ ê²°ê³¼ã€‘
"""
    
    for persona_key, analysis in persona_analyses.items():
        if analysis and analysis.get('result'):
            persona_info = PERSONAS[persona_key]
            synthesis_prompt += f"""
--- {persona_info['emoji']} {persona_info['name']} ë¶„ì„ ---
{analysis['result']}

"""
    
    synthesis_prompt += """
ã€CEO ì¢…í•© ë¶„ì„ ìš”êµ¬ì‚¬í•­ã€‘
- ê° ì„ì›ì§„ì˜ ê´€ì ì„ ê· í˜•ìˆê²Œ ê³ ë ¤
- ì „ì‚¬ì  ê´€ì ì—ì„œì˜ ìš°ì„ ìˆœìœ„ ì„¤ì •
- ì‹¤í˜„ ê°€ëŠ¥í•œ í†µí•© ì‹¤í–‰ ê³„íš ìˆ˜ë¦½
- ë¦¬ìŠ¤í¬ì™€ ê¸°íšŒ ìš”ì¸ì˜ ì¢…í•©ì  í‰ê°€
- ëª…í™•í•œ ì˜ì‚¬ê²°ì • ë°©í–¥ ì œì‹œ

ã€ì‘ë‹µ í˜•ì‹ã€‘
## ğŸ¯ í•µì‹¬ ê²°ë¡  ë° ì˜ì‚¬ê²°ì •
(CEOë¡œì„œì˜ ìµœì¢… íŒë‹¨ê³¼ ê²°ì •ì‚¬í•­)

## ğŸ“Š ì„ì›ì§„ ë¶„ì„ ì¢…í•©
(ê° ì„ì›ì§„ ì˜ê²¬ì˜ í•µì‹¬ í¬ì¸íŠ¸ë“¤)

## ğŸš€ í†µí•© ì‹¤í–‰ ê³„íš
(ë‹¨ê³„ë³„ ì‹¤í–‰ ë°©ì•ˆ)

## âš–ï¸ ë¦¬ìŠ¤í¬ vs ê¸°íšŒ
(ì¢…í•©ì  ë¦¬ìŠ¤í¬-ê¸°íšŒ ë¶„ì„)

## ğŸ“ˆ ì„±ê³µ ì§€í‘œ ë° ëª¨ë‹ˆí„°ë§
(ì„±ê³¼ ì¸¡ì • ë°©ë²•)

## ğŸ’¡ CEO ìµœì¢… ë©”ì‹œì§€
(ì¡°ì§ì— ì „ë‹¬í•  í•µì‹¬ ë©”ì‹œì§€)
"""
    
    return get_ai_response(synthesis_prompt, model_name, CEO_PERSONA['system_prompt'])

def synthesize_ceo_analysis_rag(user_query, persona_analyses, model_name="claude-3-7-sonnet-latest"):
    """RAG ì»¨í…ìŠ¤íŠ¸ë¥¼ í¬í•¨í•œ CEO ì¢…í•© ë¶„ì„"""
    try:
        # RAG ì»¨í…ìŠ¤íŠ¸ ìƒì„±
        rag_context = create_rag_context()
        
        synthesis_prompt = f"""
ë‹¤ìŒì€ ìš°ë¦¬ íšŒì‚¬ì˜ ëª¨ë“  C-Level ì„ì›ì§„ë“¤ì´ ìˆ˜í–‰í•œ ìµœê³  ìˆ˜ì¤€ì˜ ì „ë¬¸ ë¶„ì„ì…ë‹ˆë‹¤. 
ë‹¹ì‹ ì€ ì„¸ê³„ì  CEOë¡œì„œ ì´ë“¤ì˜ ë¶„ì„ì„ í†µí•©í•˜ì—¬ ì´ì‚¬íšŒì™€ ì£¼ì£¼ë¥¼ ìœ„í•œ ìµœê³  ìˆ˜ì¤€ì˜ ê²½ì˜ì§„ ì˜ì‚¬ê²°ì • ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

ã€ê²½ì˜ì§„ ì˜ì‚¬ê²°ì • ëŒ€ìƒã€‘
{user_query}

"""

        # RAG ì»¨í…ìŠ¤íŠ¸ ì¶”ê°€
        if rag_context:
            synthesis_prompt += f"""
ã€ì‹¤ì œ íšŒì‚¬ ë°ì´í„° ê¸°ë°˜ ë¶„ì„ã€‘
{rag_context}

ìœ„ ì‹¤ì œ ë°ì´í„°ë¥¼ ë°˜ë“œì‹œ ê²½ì˜ ì˜ì‚¬ê²°ì •ì— ë°˜ì˜í•˜ê³ , ë°ì´í„° ê¸°ë°˜ ì¸ì‚¬ì´íŠ¸ë¥¼ ë„ì¶œí•˜ì—¬ ì£¼ì£¼ê°€ì¹˜ ê·¹ëŒ€í™” ë°©ì•ˆì„ ì œì‹œí•´ì£¼ì„¸ìš”.

"""

        synthesis_prompt += """
ã€ê° C-Level ì„ì›ì§„ì˜ ì „ë¬¸ ë¶„ì„ ê²°ê³¼ã€‘
"""
        
        for persona_key, analysis in persona_analyses.items():
            if analysis and analysis.get('result'):
                persona_info = PERSONAS[persona_key]
                synthesis_prompt += f"""
==================== {persona_info['emoji']} {persona_info['name']} ì „ë¬¸ ë¶„ì„ ====================
{analysis['result']}

"""
        
        synthesis_prompt += f"""
ã€ì„¸ê³„ ìµœê³  ìˆ˜ì¤€ì˜ CEO í†µí•© ì˜ì‚¬ê²°ì • ë³´ê³ ì„œ ìš”êµ¬ì‚¬í•­ã€‘
- ê° C-Level ì„ì›ì§„ì˜ ì „ë¬¸ ë¶„ì„ì„ ì²´ê³„ì ìœ¼ë¡œ í†µí•©í•˜ê³  ê²€í† 
- {'ì‹¤ì œ íšŒì‚¬ ë°ì´í„°ë¥¼ ì ê·¹ í™œìš©í•œ ë°ì´í„° ê¸°ë°˜ ì˜ì‚¬ê²°ì •' if rag_context else 'ì—…ê³„ ìµœê³  ìˆ˜ì¤€ì˜ ê²½ì˜ íŒë‹¨ ê¸°ì¤€ ì ìš©'}
- ì „ì‚¬ì  ê´€ì ì—ì„œì˜ ì „ëµì  ìš°ì„ ìˆœìœ„ ì„¤ì •ê³¼ ìì› ë°°ë¶„ ìµœì í™”
- ì´í•´ê´€ê³„ì(ì£¼ì£¼, ì„ì§ì›, ê³ ê°, ì‚¬íšŒ)ë¥¼ ê³ ë ¤í•œ ê· í˜• ì¡íŒ ê²½ì˜ ë°©í–¥ ì œì‹œ
- ë‹¨ê¸° ì‹¤í–‰ë ¥ê³¼ ì¥ê¸° ì§€ì†ê°€ëŠ¥ì„±ì„ ëª¨ë‘ ê³ ë ¤í•œ í†µí•© ì‹¤í–‰ ê³„íš
- ê²½ì˜ ë¦¬ìŠ¤í¬ì™€ ê¸°íšŒ ìš”ì¸ì˜ ì¢…í•©ì  í‰ê°€ ë° ëŒ€ì‘ ì „ëµ
- ëª…í™•í•˜ê³  ê²°ë‹¨ë ¥ ìˆëŠ” CEO ì˜ì‚¬ê²°ì •ê³¼ ì‹¤í–‰ ì§€ì‹œì‚¬í•­

ã€ìµœê³  ìˆ˜ì¤€ì˜ CEO ê²½ì˜ì§„ ë³´ê³ ì„œ í˜•ì‹ (ë°˜ë“œì‹œ ì¤€ìˆ˜)ã€‘

## ğŸ‘‘ CEO í•µì‹¬ ì˜ì‚¬ê²°ì • ë° ê²½ì˜ ë°©í–¥
### ìµœì¢… ê²½ì˜ ê²°ì •ì‚¬í•­
(CEOë¡œì„œì˜ ëª…í™•í•˜ê³  ê²°ë‹¨ë ¥ ìˆëŠ” ì˜ì‚¬ê²°ì •ê³¼ í•µì‹¬ ì¶”ì§„ ë°©í–¥)
### ì „ëµì  ìš°ì„ ìˆœìœ„ ë° ìì› ë°°ë¶„
(ì „ì‚¬ ì°¨ì›ì˜ ìš°ì„ ìˆœìœ„ ì„¤ì •ê³¼ ì¸ì /ì¬ë¬´ì  ìì› ë°°ë¶„ ì›ì¹™)

## ğŸ“ˆ ë°ì´í„° ê¸°ë°˜ ê²½ì˜ í˜„í™© ì§„ë‹¨
{'### ì‹¤ì œ ë°ì´í„°ì—ì„œ ë„ì¶œí•œ í•µì‹¬ ê²½ì˜ ì¸ì‚¬ì´íŠ¸' if rag_context else '### ì‹œì¥ í™˜ê²½ ë° ê²½ìŸ í¬ì§€ì…˜ ë¶„ì„'}
{('- íšŒì‚¬ ë°ì´í„° ë¶„ì„ì„ í†µí•œ ì£¼ìš” ë°œê²¬ì‚¬í•­ê³¼ ê²½ì˜ ì‹œì‚¬ì ' if rag_context else '- ì—…ê³„ ë™í–¥ê³¼ ê²½ìŸ í™˜ê²½ ë¶„ì„ì„ í†µí•œ í¬ì§€ì…”ë‹ ì „ëµ')}
### í˜„ì¬ ê²½ì˜ ì„±ê³¼ ë° ê³¼ì œ ì§„ë‹¨
- ê° ë¶€ë¬¸ë³„ ì„±ê³¼ í‰ê°€ì™€ ê°œì„  í•„ìš” ì˜ì—­ ì‹ë³„
- ì¡°ì§ ì—­ëŸ‰ê³¼ ê²½ìŸ ìš°ìœ„ ìš”ì†Œ ë¶„ì„

## ğŸ¯ ì„ì›ì§„ ë¶„ì„ í†µí•© ë° ì „ëµì  ì‹œë„ˆì§€
### CTO ê¸°ìˆ ì „ëµê³¼ ë””ì§€í„¸ ì „í™˜ ë°©í–¥
- ê¸°ìˆ  íˆ¬ì ìš°ì„ ìˆœìœ„ì™€ ë””ì§€í„¸ í˜ì‹  ë¡œë“œë§µ
### CSO ì „ëµê¸°íšê³¼ ì‚¬ì—… í¬íŠ¸í´ë¦¬ì˜¤ ìµœì í™”
- í•µì‹¬ ì‚¬ì—… ì§‘ì¤‘ ì „ëµê³¼ ì‹ ê·œ ì„±ì¥ ë™ë ¥ í™•ë³´
### CMO ë§ˆì¼€íŒ…ì „ëµê³¼ ê³ ê°ê°€ì¹˜ ì°½ì¶œ
- ë¸Œëœë“œ ê°•í™” ì „ëµê³¼ ê³ ê° ê²½í—˜ í˜ì‹  ë°©ì•ˆ
### CFO ì¬ë¬´ì „ëµê³¼ ì£¼ì£¼ê°€ì¹˜ ê·¹ëŒ€í™”
- ì¬ë¬´ ê±´ì „ì„± ê°•í™”ì™€ ìˆ˜ìµì„± ê°œì„  ë°©ì•ˆ
### CSO ì˜ì—…ì „ëµê³¼ ì‹œì¥ í™•ëŒ€
- ë§¤ì¶œ ì„±ì¥ ì „ëµê³¼ ì‹ ì‹œì¥ ì§„ì¶œ ë°©ì•ˆ
### CIO ì •ë³´ì „ëµê³¼ ë°ì´í„° í™œìš© ê³ ë„í™”
- IT ì¸í”„ë¼ ìµœì í™”ì™€ ë°ì´í„° ê¸°ë°˜ ì˜ì‚¬ê²°ì • ì²´ê³„ êµ¬ì¶•

## ğŸš€ í†µí•© ì‹¤í–‰ ì „ëµ ë° ë¡œë“œë§µ
### Phase 1: ì¦‰ì‹œ ì‹¤í–‰ ê³¼ì œ (1-3ê°œì›”)
- ê¸´ê¸‰ì„±ê³¼ ì¤‘ìš”ì„±ì´ ë†’ì€ ìµœìš°ì„  ê³¼ì œ
- ê° ë¶€ë¬¸ë³„ ì¦‰ì‹œ ì‹¤í–‰ ì§€ì‹œì‚¬í•­ê³¼ ì±…ì„ì ì§€ì •
### Phase 2: ë‹¨ê¸° ì „ëµ ê³¼ì œ (3-12ê°œì›”)
- ì„±ê³¼ ì°½ì¶œì„ ìœ„í•œ í•µì‹¬ ì „ëµ ê³¼ì œ
- ë¶€ë¬¸ê°„ í˜‘ì—… í”„ë¡œì íŠ¸ì™€ ì‹œë„ˆì§€ ì°½ì¶œ ë°©ì•ˆ
### Phase 3: ì¤‘ì¥ê¸° í˜ì‹  ê³¼ì œ (1-3ë…„)
- ì§€ì† ê°€ëŠ¥í•œ ì„±ì¥ì„ ìœ„í•œ í˜ì‹  ê³¼ì œ
- ì¡°ì§ ì—­ëŸ‰ ê°•í™”ì™€ ë¯¸ë˜ ê²½ìŸë ¥ í™•ë³´ ë°©ì•ˆ

## ğŸ’° íˆ¬ì ìš°ì„ ìˆœìœ„ ë° ì˜ˆì‚° ë°°ë¶„ ì „ëµ
### ì „ëµì  íˆ¬ì ìš°ì„ ìˆœìœ„
- ì„±ì¥ ë™ë ¥ í™•ë³´ë¥¼ ìœ„í•œ í•µì‹¬ íˆ¬ì ì˜ì—­
- íˆ¬ìë³„ ê¸°ëŒ€ íš¨ê³¼ì™€ ROI ë¶„ì„
### ì˜ˆì‚° ë°°ë¶„ ë° ìì› ìµœì í™”
- ë¶€ë¬¸ë³„ ì˜ˆì‚° ë°°ë¶„ ì›ì¹™ê³¼ ì„±ê³¼ ì—°ë™ ì²´ê³„
- ë¹„ìš© ìµœì í™”ì™€ íš¨ìœ¨ì„± ê°œì„  ë°©ì•ˆ

## âš–ï¸ í†µí•© ë¦¬ìŠ¤í¬ ê´€ë¦¬ ë° ê¸°íšŒ í™œìš© ì „ëµ
### ì „ì‚¬ ì°¨ì›ì˜ ì£¼ìš” ë¦¬ìŠ¤í¬ ìš”ì¸
- ê° ë¶€ë¬¸ë³„ ë¦¬ìŠ¤í¬ë¥¼ í†µí•©í•œ ì „ì‚¬ ë¦¬ìŠ¤í¬ ë§¤íŠ¸ë¦­ìŠ¤
- ë¦¬ìŠ¤í¬ë³„ ëŒ€ì‘ ìš°ì„ ìˆœìœ„ì™€ ì™„í™” ì „ëµ
### ì „ëµì  ê¸°íšŒ í¬ì°© ë° í™œìš© ë°©ì•ˆ
- ì‹œì¥ ê¸°íšŒì™€ ë‚´ë¶€ ì—­ëŸ‰ì„ ì—°ê³„í•œ ì„±ì¥ ê¸°íšŒ ì‹ë³„
- ê¸°íšŒ í™œìš©ì„ ìœ„í•œ ì¡°ì§ ì—­ëŸ‰ ê°•í™” ë°©ì•ˆ

## ğŸ“Š í†µí•© ì„±ê³¼ ê´€ë¦¬ ë° ëª¨ë‹ˆí„°ë§ ì²´ê³„
### ì „ì‚¬ KPI ë° ì„±ê³¼ ì§€í‘œ ì²´ê³„
- ê· í˜•ì„±ê³¼í‘œ(BSC) ê¸°ë°˜ í†µí•© ì„±ê³¼ ê´€ë¦¬ ì²´ê³„
- ë¶€ë¬¸ë³„ ì„±ê³¼ ì§€í‘œì™€ ì „ì‚¬ ëª©í‘œ ì—°ê³„ ë°©ì•ˆ
### CEO ì§ì† ëª¨ë‹ˆí„°ë§ ë° ë³´ê³  ì²´ê³„
- ì›”ë³„/ë¶„ê¸°ë³„ í•µì‹¬ ì§€í‘œ ëª¨ë‹ˆí„°ë§ ì²´ê³„
- ì´ìŠˆ ë°œìƒ ì‹œ ì‹ ì† ëŒ€ì‘ì„ ìœ„í•œ ì—ìŠ¤ì»¬ë ˆì´ì…˜ ì²´ê³„

## ğŸŒŸ ì¡°ì§ ë¬¸í™” í˜ì‹  ë° ë¦¬ë”ì‹­ ì „ëµ
### ê³ ì„±ê³¼ ì¡°ì§ ë¬¸í™” êµ¬ì¶•
- í˜ì‹ ì ì´ê³  í˜‘ë ¥ì ì¸ ì¡°ì§ ë¬¸í™” ì¡°ì„± ë°©ì•ˆ
- ì„ì§ì› ëª°ì…ë„ ì œê³ ì™€ ì¸ì¬ ìœ ì§€ ì „ëµ
### ì°¨ì„¸ëŒ€ ë¦¬ë”ì‹­ ê°œë°œ
- ë¯¸ë˜ ë¦¬ë” ìœ¡ì„±ê³¼ ìŠ¹ê³„ ê³„íš
- ì¡°ì§ í•™ìŠµ ëŠ¥ë ¥ ê°•í™” ë°©ì•ˆ

## ğŸŒ ì´í•´ê´€ê³„ì ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ë° ESG ê²½ì˜
### ì£¼ì£¼ ë° íˆ¬ìì ê´€ê³„ ê´€ë¦¬
- ì£¼ì£¼ê°€ì¹˜ ì œê³ ë¥¼ ìœ„í•œ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ì „ëµ
- IR í™œë™ ê°•í™”ì™€ íˆ¬ëª… ê²½ì˜ ì‹¤ì²œ ë°©ì•ˆ
### ESG ê²½ì˜ ë° ì§€ì†ê°€ëŠ¥ì„± ì „ëµ
- í™˜ê²½, ì‚¬íšŒ, ê±°ë²„ë„ŒìŠ¤ ì°¨ì›ì˜ ì±…ì„ ê²½ì˜ ì‹¤ì²œ
- ì§€ì†ê°€ëŠ¥í•œ ì„±ì¥ì„ ìœ„í•œ ESG í†µí•© ì „ëµ

## ğŸ¯ CEO ìµœì¢… ì‹¤í–‰ ì§€ì‹œì‚¬í•­
### ê° C-Level ì„ì›ì§„ì— ëŒ€í•œ êµ¬ì²´ì  ì§€ì‹œì‚¬í•­
- ì„ì›ë³„ í•µì‹¬ ë¯¸ì…˜ê³¼ ì„±ê³¼ ëª©í‘œ ì„¤ì •
- ìƒí˜¸ í˜‘ì—… ê³¼ì œì™€ ì±…ì„ ë¶„ë‹´ ëª…í™•í™”
### ì „ì‚¬ ì°¨ì›ì˜ ë³€í™” ê´€ë¦¬ ë°©í–¥
- ì¡°ì§ ë³€í™” ì¶”ì§„ ì²´ê³„ì™€ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ê³„íš
- êµ¬ì„±ì› ì°¸ì—¬ ìœ ë„ì™€ ë³€í™” ì €í•­ ìµœì†Œí™” ë°©ì•ˆ

{'## ğŸ“Š ì¢…í•© ë¶„ì„ ê¸°ë°˜ ë°ì´í„°' if rag_context else ''}
{'### CEO ì˜ì‚¬ê²°ì •ì— í™œìš©ëœ RAG ë°ì´í„° ì†ŒìŠ¤' if rag_context else ''}
{'''ì´ CEO ìµœì¢… ì˜ì‚¬ê²°ì • ë³´ê³ ì„œëŠ” ë‹¤ìŒ ì‹¤ì œ ë°ì´í„°ë¥¼ ì¢…í•© ë¶„ì„í•˜ì—¬ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤:''' if rag_context else ''}
{'''
**ğŸ—„ï¸ MySQL ë°ì´í„°ë² ì´ìŠ¤ ë¶„ì„**: íšŒì‚¬ì˜ ì‹¤ì‹œê°„ ìš´ì˜ ë°ì´í„°ì™€ ì„±ê³¼ ì§€í‘œë¥¼ ê¸°ë°˜ìœ¼ë¡œ í˜„í™© ì§„ë‹¨
**ğŸŒ ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ì •ë³´**: ì‹œì¥ ë™í–¥, ê²½ìŸì‚¬ ë¶„ì„, ì—…ê³„ íŠ¸ë Œë“œë¥¼ ë°˜ì˜í•œ ì „ëµ ìˆ˜ë¦½  
**ğŸ“„ ì—…ë¡œë“œ ë¬¸ì„œ ê²€í† **: ê¸°ì¡´ ê³„íšì„œ, ë³´ê³ ì„œ, ì •ì±… ë¬¸ì„œë¥¼ ì°¸ì¡°í•œ ì—°ì†ì„± ìˆëŠ” ì˜ì‚¬ê²°ì •

ìœ„ ë‹¤ì–‘í•œ ë°ì´í„° ì†ŒìŠ¤ë¥¼ C-Level ì„ì›ì§„ë“¤ì´ ê°ìì˜ ì „ë¬¸ ì˜ì—­ì—ì„œ ë¶„ì„í•œ ê²°ê³¼ë¥¼ CEO ê´€ì ì—ì„œ í†µí•©í•˜ì—¬ 
ë°ì´í„° ê¸°ë°˜ì˜ ê°ê´€ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ìµœì¢… ì˜ì‚¬ê²°ì •ì„ ë„ì¶œí–ˆìŠµë‹ˆë‹¤.''' if rag_context else ''}

## ğŸ“š ì°¸ê³  ìë£Œ ë° ê·¼ê±° (References)
### ì‹¤ì œ ë¶„ì„ì— í™œìš©ëœ êµ¬ì²´ì  ë°ì´í„°
{'''**ë°˜ë“œì‹œ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì‹¤ì œ ì°¸ê³ í•œ êµ¬ì²´ì  ë‚´ìš©ì„ ëª…ì‹œí•´ì£¼ì„¸ìš”:**

**ğŸ—„ï¸ MySQL ë°ì´í„°ë² ì´ìŠ¤ ì°¸ê³  ë‚´ìš©**
- [í…Œì´ë¸”ëª…]: ë¶„ì„ì— ì‚¬ìš©ëœ êµ¬ì²´ì  ë°ì´í„° ë‚´ìš©ê³¼ ìˆ˜ì¹˜
- [í…Œì´ë¸”ëª…]: ì˜ì‚¬ê²°ì • ê·¼ê±°ë¡œ í™œìš©ëœ íŠ¹ì • ë°ì´í„° í¬ì¸íŠ¸
- ì˜ˆ: meeting_records í…Œì´ë¸”ì—ì„œ ìµœê·¼ 3ê°œì›” íšŒì˜ ë¹ˆë„ ì¦ê°€ ì¶”ì„¸ (ì›” í‰ê·  15íšŒ â†’ 23íšŒ)

**ğŸŒ ì›¹ì‚¬ì´íŠ¸ ì°¸ê³  ë‚´ìš©**  
- [ì‚¬ì´íŠ¸ëª…/í˜ì´ì§€]: ì „ëµ ìˆ˜ë¦½ì— ì˜í–¥ì„ ì¤€ êµ¬ì²´ì  ì •ë³´
- [URL]: ì‹œì¥ ë¶„ì„ì— í™œìš©ëœ íŠ¹ì • ë°ì´í„°ë‚˜ íŠ¸ë Œë“œ
- ì˜ˆ: TechCrunch ê¸°ì‚¬ì—ì„œ "AI ì‹œì¥ 30% ì„±ì¥ ì „ë§" ì •ë³´ í™œìš©

**ğŸ“„ ë¬¸ì„œ ì°¸ê³  ë‚´ìš©**
- [íŒŒì¼ëª…]: ì˜ì‚¬ê²°ì •ì— ë°˜ì˜ëœ êµ¬ì²´ì  ë‚´ìš©ê³¼ í˜ì´ì§€/ì„¹ì…˜
- [ë¬¸ì„œëª…]: ì „ëµ ì—°ì†ì„±ì„ ìœ„í•´ ì°¸ì¡°í•œ ê¸°ì¡´ ê³„íšì´ë‚˜ ì •ì±…
- ì˜ˆ: 2024ë…„ ì‚¬ì—…ê³„íšì„œ p.15 "ë””ì§€í„¸ ì „í™˜ íˆ¬ì í™•ëŒ€" ë°©ì¹¨ ë°˜ì˜

ìœ„ì™€ ê°™ì´ ì‹¤ì œë¡œ ë¶„ì„ê³¼ ì˜ì‚¬ê²°ì •ì— í™œìš©í•œ êµ¬ì²´ì ì¸ ë°ì´í„° ë‚´ìš©ì„ ëª…ì‹œí•˜ì—¬ 
ë³´ê³ ì„œì˜ ì‹ ë¢°ì„±ê³¼ ì¶”ì ê°€ëŠ¥ì„±ì„ í™•ë³´í•´ì£¼ì„¸ìš”.''' if rag_context else ''}

ë°˜ë“œì‹œ ìœ„ í˜•ì‹ì„ ì¤€ìˆ˜í•˜ì—¬ ì„¸ê³„ ìµœê³  ìˆ˜ì¤€ì˜ CEO ê²½ì˜ì§„ ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.
ëª¨ë“  ì˜ì‚¬ê²°ì •ì€ êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•˜ë©°, ì£¼ì£¼ê°€ì¹˜ ê·¹ëŒ€í™”ë¥¼ ì§€í–¥í•´ì•¼ í•©ë‹ˆë‹¤."""
        
        result = get_ai_response(synthesis_prompt, model_name, CEO_PERSONA['system_prompt'])
        
        if result is None:
            return f"AI ì‘ë‹µì´ Noneì…ë‹ˆë‹¤. API í‚¤ë‚˜ ëª¨ë¸ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”."
        return result
    except Exception as e:
        import traceback
        error_details = traceback.format_exc()
        return f"CEO ì¢…í•© ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}\nìƒì„¸: {error_details}"

def run_concurrent_analysis_with_progress_rag(user_query, persona_prompts, persona_status, persona_progress, model_name="claude-3-7-sonnet-latest"):
    """RAG ê¸°ëŠ¥ì´ í¬í•¨ëœ ë™ì‹œ ë¶„ì„ ì‹¤í–‰"""
    
    # ë¶„ì„ ì‘ì—… ì¤€ë¹„
    tasks = []
    for persona_key, persona_info in PERSONAS.items():
        custom_prompt = persona_prompts.get(persona_key, "")
        tasks.append((user_query, persona_key, persona_info, custom_prompt, model_name))
    
    # ê° í˜ë¥´ì†Œë‚˜ë³„ ì§„í–‰ ìƒíƒœ ì¶”ì 
    persona_stages = {}
    for persona_key in PERSONAS.keys():
        persona_stages[persona_key] = {
            'current_stage': 0,
            'last_update': time.time(),
            'stage_duration': random.uniform(2.0, 4.0)
        }
    
    # ì§„í–‰ë¥  ì• ë‹ˆë©”ì´ì…˜ í•¨ìˆ˜
    def animate_progress():
        placeholder = st.empty()
        
        for i in range(100):
            if not hasattr(st.session_state, 'analysis_complete') or not st.session_state.analysis_complete:
                break
            
            placeholder.markdown(f"""
            <div style="
                background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3, #54a0ff);
                background-size: 500% 500%;
                animation: rainbow 2s ease infinite;
                border-radius: 15px;
                padding: 20px;
                margin: 15px 0;
                color: white;
                text-align: center;
                font-weight: bold;
                font-size: 1.1rem;
                box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            ">
                ğŸŒˆ ëª¨ë“  C-Level ì„ì›ì§„ì´ ì—…ë¬´ì— ëª°ë‘í•˜ê³  ìˆìŠµë‹ˆë‹¤... {i+1}%
            </div>
            """, unsafe_allow_html=True)
            
            time.sleep(0.05)
    
    animate_progress()

    st.session_state['completed_personas'] = set()
    
    progress_thread = threading.Thread(target=animate_progress)
    progress_thread.daemon = True
    progress_thread.start()
    
    # ThreadPoolExecutorë¡œ ë™ì‹œ ì‹¤í–‰ (RAG ë²„ì „ ì‚¬ìš©)
    results = {}
    with ThreadPoolExecutor(max_workers=len(PERSONAS)) as executor:
        future_to_persona = {
            executor.submit(analyze_persona_concurrent_rag, task): task[1] 
            for task in tasks
        }
        
        for future in as_completed(future_to_persona):
            persona_key = future_to_persona[future]
            try:
                persona_key, result, success = future.result()
                results[persona_key] = {
                    'result': result,
                    'success': success,
                    'completed': True,
                    'timestamp': datetime.now().isoformat()
                }
                
                st.session_state['completed_personas'].add(persona_key)
                
                if persona_progress[persona_key] is not None:
                    # ì™„ë£Œ ì‹œ 100%ë¥¼ 1.0ìœ¼ë¡œ ë³€í™˜
                    persona_progress[persona_key].progress(1.0)
                
                persona_info = PERSONAS[persona_key]
                if success:
                    completion_message = PERSONA_ANALYSIS_STAGES[persona_key][-1]['message']
                    persona_status[persona_key].markdown(f"""
                    <div class="analysis-complete">
                        <h4>ğŸ‰ {persona_info['emoji']} {persona_info['name']}</h4>
                        <p style="margin: 5px 0; font-size: 0.9rem; color: #155724;">
                            {completion_message}<br>
                            ì™„ë£Œ ì‹œê°„: {datetime.fromisoformat(results[persona_key]['timestamp']).strftime('%H:%M:%S')}
                        </p>
                    </div>
                    """, unsafe_allow_html=True)
                else:
                    persona_status[persona_key].markdown(f"""
                    <div style="background: #f8d7da; border: 2px solid #dc3545; border-radius: 12px; padding: 15px; margin: 10px 0; text-align: center;">
                        <h4 style="color: #721c24; margin: 0;">âŒ {persona_info['emoji']} {persona_info['name']} ë¶„ì„ ì˜¤ë¥˜</h4>
                        <p style="margin: 5px 0; font-size: 0.9rem; color: #721c24;">
                            ì˜¤ë¥˜ ì‹œê°„: {datetime.fromisoformat(results[persona_key]['timestamp']).strftime('%H:%M:%S')}
                        </p>
                    </div>
                    """, unsafe_allow_html=True)
                    
            except Exception as e:
                import traceback
                error_details = traceback.format_exc()
                results[persona_key] = {
                    'result': f"ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {str(e)}\nìƒì„¸: {error_details}",
                    'success': False,
                    'completed': True,
                    'timestamp': datetime.now().isoformat()
                }
                st.session_state['completed_personas'].add(persona_key)
    
    return results

# ==================== ì‚¬ì´ë“œë°” ì„¤ì • ====================

# ì‚¬ì´ë“œë°” ì„¤ì •
st.sidebar.title("ğŸ¢ C-Level ë©€í‹°ì—ì´ì „íŠ¸ ì„¤ì •")

# ëª¨ë¸ ì„ íƒ
available_models = []
has_anthropic_key = os.environ.get('ANTHROPIC_API_KEY') is not None
if has_anthropic_key:
    available_models.extend([
        'claude-3-7-sonnet-latest',
        'claude-3-5-sonnet-latest',
        'claude-3-5-haiku-latest',
    ])
has_openai_key = os.environ.get('OPENAI_API_KEY') is not None
if has_openai_key:
    available_models.extend(['gpt-4o', 'gpt-4o-mini'])

if not available_models:
    st.sidebar.error("API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
    available_models = ['claude-3-7-sonnet-latest']  # ê¸°ë³¸ê°’

selected_model = st.sidebar.selectbox(
    'ğŸ§  AI ëª¨ë¸ ì„ íƒ',
    options=available_models,
    index=available_models.index(st.session_state.selected_model) if st.session_state.selected_model in available_models else 0,
    help='ClaudeëŠ” ANTHROPIC_API_KEY, OpenAIëŠ” OPENAI_API_KEY í•„ìš”'
)

if selected_model != st.session_state.selected_model:
    st.session_state.selected_model = selected_model

st.sidebar.markdown("---")

# RAG ë°ì´í„° ì†ŒìŠ¤ ì„¤ì •
st.sidebar.markdown("### ğŸ” RAG ë°ì´í„° ì†ŒìŠ¤ ì„¤ì •")
st.sidebar.markdown("**ğŸ“Š ë¶„ì„ì— ì‚¬ìš©í•  ì¶”ê°€ ë°ì´í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”**")
st.sidebar.info("ğŸ’¡ RAG ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ë©´ ë” ì •í™•í•˜ê³  êµ¬ì²´ì ì¸ ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤!")

# í˜„ì¬ í™œì„± RAG ì†ŒìŠ¤ í‘œì‹œ
if st.session_state.rag_sources:
    # ì•ˆì „í•œ ë°©ì‹ìœ¼ë¡œ RAG ì†ŒìŠ¤ ìƒíƒœ í‘œì‹œ
    rag_names = []
    for source in st.session_state.rag_sources:
        if source in RAG_SOURCES:
            rag_names.append(f"{RAG_SOURCES[source]['emoji']} {RAG_SOURCES[source]['name']}")
    if rag_names:
        rag_status = "âœ… " + ", ".join(rag_names)
        st.sidebar.success(f"í™œì„± RAG ì†ŒìŠ¤: {rag_status}")
else:
    st.sidebar.warning("âŒ í™œì„± RAG ì†ŒìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ì—ì„œ ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.")

# MySQL ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
with st.sidebar.expander("ğŸ—„ï¸ MySQL ë°ì´í„°ë² ì´ìŠ¤", expanded=True):
    if st.sidebar.button("ğŸ” DB ì—°ê²° í…ŒìŠ¤íŠ¸", key="mysql_test"):
        success, message = test_mysql_connection()
        if success:
            st.sidebar.success(f"âœ… {message}")
        else:
            st.sidebar.error(f"âŒ {message}")
    
    if st.sidebar.button("ğŸ“‹ í…Œì´ë¸” ëª©ë¡ ì¡°íšŒ", key="mysql_tables"):
        tables, table_info = get_mysql_tables()
        if tables:
            st.session_state.available_tables = tables
            st.session_state.table_info = table_info
            st.sidebar.success(f"âœ… {len(tables)}ê°œ í…Œì´ë¸” ë°œê²¬")
        else:
            st.sidebar.error("âŒ í…Œì´ë¸” ì¡°íšŒ ì‹¤íŒ¨")
    
    # í…Œì´ë¸” ì„ íƒ
    if 'available_tables' in st.session_state:
        selected_tables = st.sidebar.multiselect(
            "ë¶„ì„í•  í…Œì´ë¸” ì„ íƒ",
            st.session_state.available_tables,
            help="ë„ˆë¬´ ë§ì€ í…Œì´ë¸”ì„ ì„ íƒí•˜ë©´ ì„±ëŠ¥ì´ ì €í•˜ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
            key="mysql_table_select"
        )
        
        if st.sidebar.button("ğŸ“¥ ì„ íƒëœ í…Œì´ë¸” ë¡œë“œ", key="mysql_load") and selected_tables:
            with st.sidebar:
                with st.spinner("MySQL ë°ì´í„° ë¡œë”© ì¤‘..."):
                    data_frames = load_mysql_data(selected_tables)
                    if data_frames:
                        st.session_state.mysql_data = data_frames
                        if 'mysql' not in st.session_state.rag_sources:
                            st.session_state.rag_sources.append('mysql')
                        total_rows = sum(len(df) for df in data_frames.values())
                        st.sidebar.success(f"âœ… {len(selected_tables)}ê°œ í…Œì´ë¸” ë¡œë“œ ì™„ë£Œ! (ì´ {total_rows:,}í–‰)")

# ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ì„¤ì •
with st.sidebar.expander("ğŸŒ ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§", expanded=True):
    website_url = st.sidebar.text_input("ì›¹ì‚¬ì´íŠ¸ URL", placeholder="https://example.com", key="website_url")
    max_pages = st.sidebar.slider("ìµœëŒ€ í˜ì´ì§€ ìˆ˜", 1, 10, 5, key="website_pages")
    
    if st.sidebar.button("ğŸ•·ï¸ ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ì‹œì‘", key="website_crawl") and website_url:
        with st.sidebar:
            with st.spinner("ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ì¤‘..."):
                scraped_data = scrape_website_simple(website_url, max_pages)
                if scraped_data:
                    st.session_state.website_data = scraped_data
                    if 'website' not in st.session_state.rag_sources:
                        st.session_state.rag_sources.append('website')
                    st.sidebar.success(f"âœ… {len(scraped_data)}ê°œ í˜ì´ì§€ í¬ë¡¤ë§ ì™„ë£Œ!")
                else:
                    st.sidebar.error("âŒ í¬ë¡¤ë§ ì‹¤íŒ¨")

# íŒŒì¼ ì—…ë¡œë“œ ì„¤ì •
with st.sidebar.expander("ğŸ“„ ë¬¸ì„œ íŒŒì¼", expanded=True):
    files = st.sidebar.file_uploader(
        "íŒŒì¼ ì—…ë¡œë“œ",
        type=list(SUPPORTED_FILE_TYPES.keys()),
        accept_multiple_files=True,
        help="ì—¬ëŸ¬ íŒŒì¼ì„ ë™ì‹œì— ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
        key="file_upload"
    )
    
    if files:
        valid_files = []
        for file in files:
            errors = validate_file(file)
            if not errors:
                valid_files.append(file)
            else:
                for error in errors:
                    st.sidebar.error(f"âŒ {file.name}: {error}")
        
        if valid_files and st.sidebar.button("ğŸ“ íŒŒì¼ ì²˜ë¦¬", key="file_process"):
            with st.sidebar:
                with st.spinner("íŒŒì¼ ì²˜ë¦¬ ì¤‘..."):
                    processed_files = process_files(valid_files)
                    if processed_files:
                        st.session_state.files_data = processed_files
                        if 'files' not in st.session_state.rag_sources:
                            st.session_state.rag_sources.append('files')
                        total_size = sum(f['size'] for f in processed_files)
                        st.sidebar.success(f"âœ… {len(processed_files)}ê°œ íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ! (ì´ {total_size:,}ì)")

# RAG ì†ŒìŠ¤ í˜„í™© í‘œì‹œ
if st.session_state.rag_sources:
    st.sidebar.markdown("### ğŸ“Š í™œì„± RAG ì†ŒìŠ¤")
    for source in st.session_state.rag_sources:
        if source in RAG_SOURCES:
            source_info = RAG_SOURCES[source]
            st.sidebar.markdown(f"âœ… {source_info['emoji']} {source_info['name']}")

st.sidebar.markdown("---")

# ë¶„ì„ í˜„í™© í‘œì‹œ
st.sidebar.subheader("ğŸ“Š ë¶„ì„ í˜„í™©")
if st.session_state.current_analysis:
    completed = len([k for k, v in st.session_state.current_analysis.items() if v.get('completed', False)])
    total = len(PERSONAS)
    
    # progress ê°’ì„ 0.0ê³¼ 1.0 ì‚¬ì´ë¡œ ì•ˆì „í•˜ê²Œ ì œí•œ
    progress_value = min(max(completed / max(total, 1), 0.0), 1.0)
    st.sidebar.progress(progress_value)
    st.sidebar.write(f"ì§„í–‰ë¥ : {completed}/{total}")
else:
    st.sidebar.progress(0.0)
    st.sidebar.write("ì§„í–‰ë¥ : 0/6")

# RAG ë°ì´í„° ìš”ì•½ í‘œì‹œ
if st.session_state.rag_sources:
    st.sidebar.markdown("### ğŸ“‹ ë¡œë“œëœ ë°ì´í„° ìš”ì•½")
    
    if 'mysql' in st.session_state.rag_sources and st.session_state.mysql_data:
        total_mysql_rows = sum(len(df) for df in st.session_state.mysql_data.values())
        st.sidebar.write(f"ğŸ—„ï¸ MySQL: {len(st.session_state.mysql_data)}ê°œ í…Œì´ë¸” ({total_mysql_rows:,}í–‰)")
    
    if 'website' in st.session_state.rag_sources and st.session_state.website_data:
        total_pages = len(st.session_state.website_data)
        st.sidebar.write(f"ğŸŒ ì›¹ì‚¬ì´íŠ¸: {total_pages}ê°œ í˜ì´ì§€")
    
    if 'files' in st.session_state.rag_sources and st.session_state.files_data:
        total_files = len(st.session_state.files_data)
        total_chars = sum(f['size'] for f in st.session_state.files_data)
        st.sidebar.write(f"ğŸ“„ íŒŒì¼: {total_files}ê°œ ë¬¸ì„œ ({total_chars:,}ì)")

# RAG ì†ŒìŠ¤ ê´€ë¦¬ ë²„íŠ¼ë“¤
if st.session_state.rag_sources:
    st.sidebar.markdown("### ğŸ”§ ë°ì´í„° ê´€ë¦¬")
    
    if st.sidebar.button("ğŸ—‘ï¸ ëª¨ë“  RAG ë°ì´í„° ì´ˆê¸°í™”", key="rag_reset"):
        st.session_state.rag_sources = []
        st.session_state.mysql_data = {}
        st.session_state.website_data = {}
        st.session_state.files_data = {}
        if 'available_tables' in st.session_state:
            del st.session_state.available_tables
        if 'table_info' in st.session_state:
            del st.session_state.table_info
        st.rerun()

st.sidebar.markdown("---")

# í˜ë¥´ì†Œë‚˜ë³„ ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ ì„¤ì •
st.sidebar.subheader("ğŸ­ í˜ë¥´ì†Œë‚˜ë³„ ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸")
st.sidebar.markdown("*ê° ì„ì›ì§„ì—ê²Œ íŠ¹ë³„í•œ ì§€ì‹œì‚¬í•­ì´ ìˆë‹¤ë©´ ì…ë ¥í•˜ì„¸ìš”*")

persona_prompts = {}
for persona_key, persona_info in PERSONAS.items():
    with st.sidebar.expander(f"{persona_info['emoji']} {persona_info['name']}"):
        st.markdown(f"**ì—­í• **: {persona_info['role']}")
        st.markdown(f"**ì „ë¬¸ë¶„ì•¼**: {persona_info['expertise']}")
        
        prompt_key = f"custom_prompt_{persona_key}"
        if prompt_key not in st.session_state:
            st.session_state[prompt_key] = ""
        
        persona_prompts[persona_key] = st.text_area(
            f"ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸",
            value=st.session_state[prompt_key],
            key=prompt_key,
            height=100,
            placeholder=f"{persona_info['name']}ì—ê²Œ íŠ¹ë³„íˆ ë¶„ì„í•´ë‹¬ë¼ê³  ìš”ì²­í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...",
            help=f"{persona_info['perspective']}"
        )

# ==================== ë©”ì¸ ì¸í„°í˜ì´ìŠ¤ ====================

st.markdown('<h1 class="main-title">ğŸ¬ Virtual AqaraLife C-Level ë©€í‹°ì—ì´ì „íŠ¸ + RAG</h1>', unsafe_allow_html=True)



st.markdown('<p class="main-subtitle"><strong>ë‹¹ì‹ ì€ CEOì…ë‹ˆë‹¤. C-level ì„ì›ì§„ë“¤ì´ ë‹¤ì–‘í•œ ë°ì´í„°ë¥¼ í™œìš©í•˜ì—¬ í˜‘ë ¥ ë¶„ì„í•˜ê³ , ìµœì¢… ì¢…í•© ë³´ê³ ì„œë¥¼ ì œê³µí•©ë‹ˆë‹¤.</strong></p>', unsafe_allow_html=True)

# í˜„ì¬ ì„¤ì • ì •ë³´ í‘œì‹œ
st.markdown("### âš™ï¸ í˜„ì¬ ì‹œìŠ¤í…œ ì„¤ì •")

# DB ìƒíƒœ í™•ì¸ ë° í…Œì´ë¸” ìƒì„±
db_success, db_message = check_database_connection()
if not db_success:
    st.error(f"ğŸ’¾ **ë°ì´í„°ë² ì´ìŠ¤**: âŒ {db_message}")
    st.warning("âš ï¸ ë¶„ì„ ê²°ê³¼ ì €ì¥ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. DB ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.")
else:
    st.success(f"ğŸ’¾ **ë°ì´í„°ë² ì´ìŠ¤**: âœ… {db_message}")
    
    # í…Œì´ë¸” ìë™ ìƒì„± í™•ì¸
    if "Virtual Company í…Œì´ë¸”: 0ê°œ" in db_message:
        st.info("ğŸ”§ Virtual Company ì €ì¥ìš© í…Œì´ë¸”ì´ ì—†ìŠµë‹ˆë‹¤. ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤...")
        if create_virtual_company_tables_if_not_exists():
            st.rerun()
    elif "Virtual Company í…Œì´ë¸”: 4ê°œ" not in db_message:
        # ì¼ë¶€ í…Œì´ë¸”ë§Œ ìˆëŠ” ê²½ìš°
        st.warning("âš ï¸ Virtual Company í…Œì´ë¸”ì´ ë¶ˆì™„ì „í•©ë‹ˆë‹¤. ëˆ„ë½ëœ í…Œì´ë¸”ì„ ìƒì„±í•©ë‹ˆë‹¤...")
        if create_virtual_company_tables_if_not_exists():
            st.rerun()

col1, col2, col3 = st.columns([2, 2, 1])
with col1:
    st.markdown(f"**ğŸ§  AI ëª¨ë¸**: `{selected_model}`")
    
    # API í‚¤ ìƒíƒœ í™•ì¸
    if selected_model.startswith('claude'):
        api_key = os.getenv('ANTHROPIC_API_KEY')
        if api_key and len(api_key) > 10:
            st.markdown(f"**ğŸ”‘ Anthropic API**: âœ… ì„¤ì •ë¨ (`{api_key[:8]}...`)")
        else:
            st.markdown("**ğŸ”‘ Anthropic API**: âŒ ì„¤ì •ë˜ì§€ ì•ŠìŒ")
    else:
        api_key = os.getenv('OPENAI_API_KEY')
        if api_key and len(api_key) > 10:
            st.markdown(f"**ğŸ”‘ OpenAI API**: âœ… ì„¤ì •ë¨ (`{api_key[:8]}...`)")
        else:
            st.markdown("**ğŸ”‘ OpenAI API**: âŒ ì„¤ì •ë˜ì§€ ì•ŠìŒ")
            
with col2:
    if st.session_state.rag_sources:
        # ì•ˆì „í•œ ë°©ì‹ìœ¼ë¡œ RAG ì†ŒìŠ¤ ì´ëª¨ì§€ ìƒì„±
        rag_emojis = []
        for source in st.session_state.rag_sources:
            if source in RAG_SOURCES:
                rag_emojis.append(RAG_SOURCES[source]['emoji'])
        rag_emoji = "".join(rag_emojis)
        st.markdown(f"**ğŸ” RAG ì†ŒìŠ¤**: {rag_emoji} `{len(st.session_state.rag_sources)}ê°œ í™œì„±`")
    else:
        st.markdown("**ğŸ” RAG ì†ŒìŠ¤**: âš ï¸ `ì—†ìŒ (ì‚¬ì´ë“œë°”ì—ì„œ ì„¤ì •)`")
with col3:
    if st.button("ğŸ”„ ì´ˆê¸°í™”", help="ëª¨ë“  ë¶„ì„ ê²°ê³¼ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤"):
        st.session_state.current_analysis = {}
        st.session_state.analysis_complete = False
        st.rerun()

# API í‚¤ í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ì¶”ê°€
if st.button("ğŸ§ª AI ëª¨ë¸ ì—°ê²° í…ŒìŠ¤íŠ¸", help="ì„ íƒëœ AI ëª¨ë¸ê³¼ì˜ ì—°ê²°ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤"):
    try:
        test_response = get_ai_response("ì•ˆë…•í•˜ì„¸ìš”. ê°„ë‹¨í•œ ì¸ì‚¬ë§ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”.", selected_model, "ë‹¹ì‹ ì€ ë„ì›€ì´ ë˜ëŠ” AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.")
        if test_response:
            st.success(f"âœ… AI ëª¨ë¸ ì—°ê²° ì„±ê³µ!\nì‘ë‹µ: {test_response[:100]}...")
        else:
            st.error("âŒ AI ëª¨ë¸ ì‘ë‹µì´ Noneì…ë‹ˆë‹¤. API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")
    except Exception as e:
        st.error(f"âŒ AI ëª¨ë¸ ì—°ê²° ì‹¤íŒ¨: {str(e)}")

# DB ë° í…Œì´ë¸” ìƒíƒœ í™•ì¸ ë²„íŠ¼ ì¶”ê°€
if st.button("ğŸ—„ï¸ DB ë° Virtual Company í…Œì´ë¸” ìƒíƒœ í™•ì¸", help="ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ê³¼ í•„ìš”í•œ í…Œì´ë¸”ë“¤ì˜ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤"):
    db_success, db_message = check_database_connection()
    if db_success:
        st.success(f"âœ… {db_message}")
        
        # ê° í…Œì´ë¸”ë³„ ìƒì„¸ ì •ë³´ í™•ì¸
        try:
            connection = connect_to_db()
            if connection:
                cursor = connection.cursor()
                
                st.info("ğŸ“‹ **Virtual Company í…Œì´ë¸” ìƒì„¸ ì •ë³´:**")
                required_tables = ['virtual_company_analyses', 'virtual_company_persona_analyses', 'virtual_company_rag_sources', 'virtual_company_analysis_metrics']
                
                for table_name in required_tables:
                    try:
                        cursor.execute(f"SHOW TABLES LIKE '{table_name}'")
                        table_exists = cursor.fetchone()
                        
                        if table_exists:
                            cursor.execute(f"SELECT COUNT(*) FROM {table_name}")
                            row_count = cursor.fetchone()[0]
                            st.write(f"âœ… `{table_name}`: ì¡´ì¬í•¨ ({row_count:,}ê°œ ë ˆì½”ë“œ)")
                        else:
                            st.write(f"âŒ `{table_name}`: ì¡´ì¬í•˜ì§€ ì•ŠìŒ")
                    except Exception as table_error:
                        st.write(f"âš ï¸ `{table_name}`: í™•ì¸ ì¤‘ ì˜¤ë¥˜ - {str(table_error)}")
                
                cursor.close()
                connection.close()
        except Exception as detail_error:
            st.warning(f"ìƒì„¸ ì •ë³´ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜: {str(detail_error)}")
    else:
        st.error(f"âŒ {db_message}")

st.markdown("---")

# DB ì €ì¥ í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ì¶”ê°€
# if st.button("ğŸ§ª DB ì €ì¥ í…ŒìŠ¤íŠ¸ (ë”ë¯¸ ë°ì´í„°)", help="ê°„ë‹¨í•œ ë”ë¯¸ ë°ì´í„°ë¡œ ì €ì¥ ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤"):
#     st.info("ğŸ”„ DB ì €ì¥ í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...")
    
#     # ë”ë¯¸ ë°ì´í„° ìƒì„±
#     test_user_query = "í…ŒìŠ¤íŠ¸ ì§ˆë¬¸: íšŒì‚¬ì˜ ë””ì§€í„¸ ì „í™˜ ì „ëµì€?"
#     test_model_name = selected_model
    
#     # ë”ë¯¸ í˜ë¥´ì†Œë‚˜ ë¶„ì„ ê²°ê³¼
#     test_persona_analyses = {
#         'ceo': {
#             'success': True,
#             'result': 'í…ŒìŠ¤íŠ¸ CEO ë¶„ì„ ê²°ê³¼: ë””ì§€í„¸ ì „í™˜ì€ íšŒì‚¬ì˜ í•µì‹¬ ì „ëµì…ë‹ˆë‹¤.',
#             'start_time': datetime.now().isoformat(),
#             'end_time': datetime.now().isoformat(),
#             'error_message': ''
#         },
#         'cto': {
#             'success': True,
#             'result': 'í…ŒìŠ¤íŠ¸ CTO ë¶„ì„ ê²°ê³¼: ê¸°ìˆ  ì¸í”„ë¼ íˆ¬ìê°€ í•„ìš”í•©ë‹ˆë‹¤.',
#             'start_time': datetime.now().isoformat(),
#             'end_time': datetime.now().isoformat(),
#             'error_message': ''
#         }
#     }
    
#     test_ceo_synthesis = "í…ŒìŠ¤íŠ¸ CEO ì¢…í•© ë¶„ì„: ëª¨ë“  ì„ì›ì§„ì˜ ì˜ê²¬ì„ ì¢…í•©í•˜ë©´ ë””ì§€í„¸ ì „í™˜ì´ ì‹œê¸‰í•©ë‹ˆë‹¤."
#     test_rag_sources = [
#         {
#             'type': 'test',
#             'name': 'í…ŒìŠ¤íŠ¸ RAG ì†ŒìŠ¤',
#             'description': 'í…ŒìŠ¤íŠ¸ìš© ë°ì´í„° ì†ŒìŠ¤',
#             'details': {'test': True},
#             'data_size': 100,
#             'content_preview': 'í…ŒìŠ¤íŠ¸ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°...'
#         }
#     ]
#     test_execution_time = 30
    
#     # í…ŒìŠ¤íŠ¸ ì €ì¥ ì‹¤í–‰
#     analysis_id = save_virtual_company_analysis_new(
#         user_query=test_user_query,
#         model_name=test_model_name,
#         persona_analyses=test_persona_analyses,
#         ceo_synthesis=test_ceo_synthesis,
#         rag_sources_used=test_rag_sources,
#         execution_time=test_execution_time,
#         session_title="ğŸ§ª DB ì €ì¥ í…ŒìŠ¤íŠ¸",
#         tags="í…ŒìŠ¤íŠ¸, ë”ë¯¸ë°ì´í„°",
#         notes="ì´ê²ƒì€ ì €ì¥ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ìš© ë”ë¯¸ ë°ì´í„°ì…ë‹ˆë‹¤."
#     )
    
#     if analysis_id:
#         st.success(f"ğŸ‰ DB ì €ì¥ í…ŒìŠ¤íŠ¸ ì„±ê³µ! ì €ì¥ëœ ë¶„ì„ ID: {analysis_id}")
#         st.info("ğŸ’¡ ì´ì œ ì‹¤ì œ ë¶„ì„ ê²°ê³¼ë„ ì •ìƒì ìœ¼ë¡œ ì €ì¥ë  ê²ƒì…ë‹ˆë‹¤.")
        
#         # ì €ì¥ëœ ë°ì´í„° í™•ì¸
#         if st.button("ğŸ“‹ ì €ì¥ëœ í…ŒìŠ¤íŠ¸ ë°ì´í„° í™•ì¸", key="check_test_data"):
#             detail_data = get_virtual_company_analysis_detail(analysis_id)
#             if detail_data:
#                 st.success("âœ… ì €ì¥ëœ ë°ì´í„° ì¡°íšŒ ì„±ê³µ!")
#                 st.json(detail_data['main'])
#             else:
#                 st.error("âŒ ì €ì¥ëœ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨")
#     else:
#         st.error("âŒ DB ì €ì¥ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨! ìœ„ì˜ ìƒì„¸ ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”.")

# st.markdown("---")

# RAG ì„¤ì • ê°€ì´ë“œ
if not st.session_state.rag_sources:
    st.info("ğŸ’¡ **ë” ì •í™•í•œ ë¶„ì„ì„ ìœ„í•´ ì‚¬ì´ë“œë°”ì—ì„œ RAG ë°ì´í„° ì†ŒìŠ¤ë¥¼ ì„¤ì •í•´ë³´ì„¸ìš”!**\n"
           "- ğŸ—„ï¸ **MySQL**: íšŒì‚¬ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°\n"
           "- ğŸŒ **ì›¹ì‚¬ì´íŠ¸**: ì‹œì¥ ë™í–¥ ë° ê²½ìŸì‚¬ ì •ë³´ ìˆ˜ì§‘\n"
           "- ğŸ“„ **ë¬¸ì„œ**: ë³´ê³ ì„œ, ê³„íšì„œ ë“± ê´€ë ¨ ë¬¸ì„œ ì—…ë¡œë“œ")

# ì„ì›ì§„ ì†Œê°œ
st.markdown("## ğŸ‘¥ C-Level ì„ì›ì§„")
cols = st.columns(3)
for i, (persona_key, persona_info) in enumerate(PERSONAS.items()):
    with cols[i % 3]:
        st.markdown(f"""
        <div class="persona-card">
            <div class="persona-header">
                <div class="persona-emoji">{persona_info['emoji']}</div>
                <div>
                    <div class="persona-title">{persona_info['name']}</div>
                    <div class="persona-subtitle">{persona_info['role']}</div>
                </div>
            </div>
            <div style="font-size: 0.85rem; color: #666;">
                {persona_info['expertise']}
            </div>
        </div>
        """, unsafe_allow_html=True)

st.markdown("---")

# ë©”ì¸ ì…ë ¥
user_query = st.text_area(
    "ğŸ“ CEOë‹˜, ì–´ë–¤ ì£¼ì œì— ëŒ€í•´ C-level ì„ì›ì§„ë“¤ì˜ ë¶„ì„ì´ í•„ìš”í•˜ì‹ ê°€ìš”?",
    height=120,
    placeholder="ì˜ˆ: ìƒˆë¡œìš´ AI ì„œë¹„ìŠ¤ ë¡ ì¹­ ì „ëµì— ëŒ€í•´ ë¶„ì„í•´ì£¼ì„¸ìš”...\nì˜ˆ: ë””ì§€í„¸ ì „í™˜ì„ ìœ„í•œ íˆ¬ì ê³„íšì„ ê²€í† í•´ì£¼ì„¸ìš”...\nì˜ˆ: í•´ì™¸ ì‹œì¥ ì§„ì¶œ ë°©ì•ˆì„ ë¶„ì„í•´ì£¼ì„¸ìš”..."
)

# ë¶„ì„ ë²„íŠ¼ (í…ŒìŠ¤íŠ¸ìš© ìµœì†Œí•œ ë²„ì „)
if st.button("ğŸš€ C-Level ì„ì›ì§„ ë¶„ì„ ì‹œì‘", type="primary", use_container_width=True, key="main_analysis_start"):
    if not user_query.strip():
        st.warning("ë¶„ì„í•  ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
    else:
        # ê³ ê¸‰ MySQL RAG ë¶„ê¸°
        if 'mysql' in st.session_state.rag_sources and st.session_state.use_advanced_mysql_rag:
            selected_tables = list(st.session_state.mysql_data.keys())
            if not selected_tables:
                st.error("MySQL í…Œì´ë¸”ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            else:
                table_name = selected_tables[0]  # ì—¬ëŸ¬ ê°œë©´ ì²« ë²ˆì§¸ë§Œ ì‚¬ìš©, í™•ì¥ ê°€ëŠ¥
                schema = get_table_schema(table_name)
                sql_query = generate_sql_query(user_query, schema, selected_model)
                if not sql_query.strip().lower().startswith("select"):
                    st.error(f"LLMì´ ìƒì„±í•œ ì¿¼ë¦¬ê°€ SELECTê°€ ì•„ë‹™ë‹ˆë‹¤.\nì¿¼ë¦¬: {sql_query}")
                else:
                    st.info(f"ğŸ” LLMì´ ìƒì„±í•œ SQL ì¿¼ë¦¬:\n```sql\n{sql_query}\n```")
                    try:
                        df = run_sql_query(sql_query)
                        st.dataframe(df.head(20), use_container_width=True)
                        analysis = analyze_sql_result(user_query, sql_query, df, selected_model)
                        st.markdown("### ğŸ“Š ì¿¼ë¦¬ ê²°ê³¼ ê¸°ë°˜ ë¶„ì„")
                        st.markdown(analysis)
                        # ì°¸ê³  row í‘œ ìë™ í‘œì‹œ
                        st.markdown('### ì°¸ê³  ë°ì´í„° (ë¶„ì„ì— ì‹¤ì œ ì‚¬ìš©ëœ row)')
                        st.dataframe(df.head(20), use_container_width=True)
                    except Exception as e:
                        st.error(f"SQL ì‹¤í–‰ ì˜¤ë¥˜: {e}")
                st.markdown("---")
                st.info("ê³ ê¸‰ RAG ëª¨ë“œ ê²°ê³¼ì…ë‹ˆë‹¤. ì•„ë˜ëŠ” ê¸°ì¡´ ì „ì²´ ë¶„ì„ í”Œë¡œìš°ì…ë‹ˆë‹¤.")
        # ê¸°ì¡´ ì „ì²´ ë¶„ì„ í”Œë¡œìš°(ë™ì‹œ í˜ë¥´ì†Œë‚˜ ë¶„ì„ ë“±) ë°˜ë“œì‹œ ì‹¤í–‰!
        # ì•„ë˜ ê¸°ì¡´ ë¶„ì„ ì½”ë“œê°€ í•­ìƒ ì‹¤í–‰ë˜ë„ë¡ ë³´ì¥
        # (ê¸°ì¡´ ë™ì‹œ í˜ë¥´ì†Œë‚˜ ë¶„ì„, CEO ì¢…í•© ë¶„ì„, ìë™ ì €ì¥ ë“± ì „ì²´ í”Œë¡œìš°)
        # ... ê¸°ì¡´ ì „ì²´ ë¶„ì„ ì½”ë“œ ì‹œì‘ ...
        # ì‹¤í–‰ ì‹œê°„ ì¸¡ì • ì‹œì‘
        analysis_start_time = time.time()
        # ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™” ë° user_query ì €ì¥
        st.session_state.current_analysis = {}
        st.session_state.analysis_complete = False
        st.session_state.last_user_query = user_query  # user_query ì €ì¥
        st.session_state.selected_model = selected_model  # ëª¨ë¸ëª… ì €ì¥
        # ì§„í–‰ ìƒí™© í‘œì‹œ
        progress_container = st.container()
        with progress_container:
            # RAG ë°ì´í„° í™œìš© ìƒíƒœ í‘œì‹œ
            rag_status_container = st.container()
            with rag_status_container:
                if st.session_state.rag_sources:
                    st.success(f"ğŸ” **RAG ë°ì´í„° í™œìš© ë¶„ì„**: {len(st.session_state.rag_sources)}ê°œì˜ ë°ì´í„° ì†ŒìŠ¤ê°€ ë¶„ì„ì— í¬í•¨ë©ë‹ˆë‹¤!")
                    # ê° RAG ì†ŒìŠ¤ë³„ ìƒì„¸ ì •ë³´
                    rag_details = []
                    if 'mysql' in st.session_state.rag_sources and st.session_state.mysql_data:
                        total_mysql_rows = sum(len(df) for df in st.session_state.mysql_data.values())
                        rag_details.append(f"ğŸ—„ï¸ MySQL: {len(st.session_state.mysql_data)}ê°œ í…Œì´ë¸” ({total_mysql_rows:,}í–‰)")
                    if 'website' in st.session_state.rag_sources and st.session_state.website_data:
                        rag_details.append(f"ğŸŒ ì›¹ì‚¬ì´íŠ¸: {len(st.session_state.website_data)}ê°œ í˜ì´ì§€")
                    if 'files' in st.session_state.rag_sources and st.session_state.files_data:
                        total_chars = sum(f['size'] for f in st.session_state.files_data)
                        rag_details.append(f"ğŸ“„ íŒŒì¼: {len(st.session_state.files_data)}ê°œ ë¬¸ì„œ ({total_chars:,}ì)")
                    if rag_details:
                        st.info(" | ".join(rag_details))
                else:
                    st.warning("âš ï¸ **ê¸°ë³¸ ë¶„ì„ ëª¨ë“œ**: RAG ë°ì´í„°ê°€ ì—†ì–´ ì¼ë°˜ì ì¸ ì „ë¬¸ ì§€ì‹ì„ ë°”íƒ•ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.")
            st.markdown("""
            <div class="progress-section">
                <h2>ğŸš€ C-Level ì„ì›ì§„ ë™ì‹œ ë¶„ì„ ì‹œì‘!</h2>
                <p style="text-align: center; color: #666; margin-top: 10px;">
                    ëª¨ë“  ì„ì›ì§„ì´ ë™ì‹œì— ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤...
                </p>
            </div>
            """, unsafe_allow_html=True)
            # ëª¨ë“  í˜ë¥´ì†Œë‚˜ì— ëŒ€í•´ "ë¶„ì„ ì‹œì‘" ìƒíƒœ í‘œì‹œ
            persona_status = {}
            persona_progress = {}
            for persona_key, persona_info in PERSONAS.items():
                persona_status[persona_key] = st.empty()
                # ì²« ë²ˆì§¸ ë‹¨ê³„ë¡œ ì´ˆê¸° ìƒíƒœ í‘œì‹œ
                first_stage = PERSONA_ANALYSIS_STAGES[persona_key][0]
                persona_status[persona_key].markdown(f"""
                <div class="progress-indicator">
                    <strong>ğŸš€ {persona_info['emoji']} {persona_info['name']}</strong><br>
                    <span style="font-size: 0.9rem;">{first_stage['message']} (0%)</span>
                </div>
                """, unsafe_allow_html=True)
                # ì§„í–‰ë¥  ë°” ì¶”ê°€
                persona_progress[persona_key] = st.progress(0)
                st.markdown(f"<div style='margin-bottom: 20px;'></div>", unsafe_allow_html=True)
            # ë™ì‹œ ë¶„ì„ ì‹¤í–‰
            with st.spinner("ğŸ”¥ ëª¨ë“  C-Level ì„ì›ì§„ì´ ë™ì‹œì— ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤..."):
                # ì‹¤ì œ ë™ì‹œ ë¶„ì„ ìˆ˜í–‰
                analysis_results = run_concurrent_analysis_with_progress_rag(user_query, persona_prompts, persona_status, persona_progress, selected_model)
                # ê²°ê³¼ë¥¼ ì„¸ì…˜ì— ì €ì¥
                for persona_key, result_data in analysis_results.items():
                    st.session_state.current_analysis[persona_key] = result_data
                # ë¶„ì„ ê²°ê³¼ í‘œì‹œ (expanderë¡œ)
                st.markdown("### ğŸ“‹ ìƒì„¸ ë¶„ì„ ê²°ê³¼")
                for persona_key, result_data in analysis_results.items():
                    persona_info = PERSONAS[persona_key]
                    if result_data['success']:
                        with st.expander(f"ğŸ“‹ {persona_info['emoji']} {persona_info['name']} ìƒì„¸ ë¶„ì„ ê²°ê³¼", expanded=True):
                            st.markdown(result_data['result'])
                    else:
                        with st.expander(f"âŒ {persona_info['emoji']} {persona_info['name']} ì˜¤ë¥˜ ìƒì„¸", expanded=True):
                            st.error(f"ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {result_data['result']}")
            # ì„±ê³µí•œ ë¶„ì„ë§Œ CEO ì¢…í•© ë¶„ì„ì— ì‚¬ìš©
            successful_analyses = {
                k: v for k, v in st.session_state.current_analysis.items() 
                if v.get('success', False)
            }
            if successful_analyses:
                # CEO ì¢…í•© ë¶„ì„
                st.markdown("---")
                # RAG ìƒíƒœì— ë”°ë¥¸ CEO ë¶„ì„ ë©”ì‹œì§€
                if st.session_state.rag_sources:
                    st.markdown("""
                    <div class="ceo-synthesis">
                        <strong>ğŸ‘‘ CEO ìµœì¢… ì¢…í•© ë¶„ì„ ì¤‘... (RAG ë°ì´í„° í¬í•¨)</strong>
                        <p style="margin: 10px 0; font-size: 0.9rem;">
                            ëª¨ë“  ì„ì›ì§„ì˜ ë¶„ì„ ê²°ê³¼ì™€ RAG ë°ì´í„°ë¥¼ ì¢…í•©í•˜ì—¬ ìµœì¢… ì˜ì‚¬ê²°ì •ì„ ìˆ˜ë¦½í•©ë‹ˆë‹¤
                        </p>
                    </div>
                    """, unsafe_allow_html=True)
                else:
                    st.markdown("""
                    <div class="ceo-synthesis">
                        <strong>ğŸ‘‘ CEO ìµœì¢… ì¢…í•© ë¶„ì„ ì¤‘... (ê¸°ë³¸ ë¶„ì„)</strong>
                        <p style="margin: 10px 0; font-size: 0.9rem;">
                            ëª¨ë“  ì„ì›ì§„ì˜ ë¶„ì„ ê²°ê³¼ë¥¼ ì¢…í•©í•˜ì—¬ ìµœì¢… ì˜ì‚¬ê²°ì •ì„ ìˆ˜ë¦½í•©ë‹ˆë‹¤
                        </p>
                    </div>
                    """, unsafe_allow_html=True)
                with st.spinner("CEO ìµœì¢… ì¢…í•© ë¶„ì„ ì¤‘..."):
                    ceo_synthesis = synthesize_ceo_analysis_rag(user_query, successful_analyses, selected_model)
                    # ì‹¤í–‰ ì‹œê°„ ê³„ì‚°
                    analysis_end_time = time.time()
                    execution_time = int(analysis_end_time - analysis_start_time)
                    if ceo_synthesis:
                        st.session_state.current_analysis['CEO'] = {
                            'result': ceo_synthesis,
                            'completed': True,
                            'timestamp': datetime.now().isoformat()
                        }
                        st.session_state.analysis_complete = True
                        # ğŸ¯ ìë™ ì €ì¥ ì‹œìŠ¤í…œ (ì €ì¥ ë²„íŠ¼ ì—†ì´ ë°”ë¡œ ì €ì¥)
                        st.markdown("---")
                        st.markdown("### ğŸ’¾ ë¶„ì„ ê²°ê³¼ ìë™ ì €ì¥ ì¤‘...")
                        # RAG ì†ŒìŠ¤ ì •ë³´ ì¤€ë¹„
                        rag_sources_info = []
                        if hasattr(st.session_state, 'current_rag_sources'):
                            rag_sources_info = st.session_state.current_rag_sources
                        # ìë™ ì„¸ì…˜ ì œëª© ìƒì„±
                        auto_session_title = f"AI ë©€í‹°ì—ì´ì „íŠ¸ ë¶„ì„ - {datetime.now().strftime('%Y%m%d_%H%M')}"
                        auto_tags = "ìë™ì €ì¥, AIë¶„ì„, C-Level"
                        auto_notes = f"ë¶„ì„ ì£¼ì œ: {user_query[:100]}{'...' if len(user_query) > 100 else ''}"
                        # ìë™ ì €ì¥ ì‹¤í–‰
                        with st.spinner("ğŸ“Š ë¶„ì„ ê²°ê³¼ë¥¼ ìë™ìœ¼ë¡œ ì €ì¥í•˜ê³  ìˆìŠµë‹ˆë‹¤..."):
                            analysis_id = save_virtual_company_analysis_new(
                                user_query=user_query,
                                model_name=selected_model,
                                persona_analyses=st.session_state.current_analysis,
                                ceo_synthesis=ceo_synthesis,
                                rag_sources_used=rag_sources_info,
                                execution_time=execution_time,
                                session_title=auto_session_title,
                                tags=auto_tags,
                                notes=auto_notes
                            )
                        # ìë™ ì €ì¥ ê²°ê³¼ ì²˜ë¦¬
                        if analysis_id:
                            st.success(f"ğŸ‰ ë¶„ì„ ì™„ë£Œ! ìë™ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ (ID: {analysis_id})")
                            st.info("ğŸ’¡ ì €ì¥ëœ ë¶„ì„ì€ ì•„ë˜ 'ë¶„ì„ íˆìŠ¤í† ë¦¬ ê´€ë¦¬'ì—ì„œ í™•ì¸í•˜ê±°ë‚˜ ì œëª©/íƒœê·¸ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
                            # ì„¸ì…˜ ìƒíƒœì— ì €ì¥ ì •ë³´ ê¸°ë¡
                            st.session_state.saved_analysis_id = analysis_id
                            st.session_state.analysis_saved = True
                            st.session_state.save_timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                            st.session_state.auto_saved = True
                        else:
                            st.warning("âš ï¸ ë¶„ì„ì€ ì™„ë£Œë˜ì—ˆì§€ë§Œ DB ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê²°ê³¼ëŠ” í˜„ì¬ ì„¸ì…˜ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
                            st.info("ğŸ’¡ ì•„ë˜ íˆìŠ¤í† ë¦¬ ê´€ë¦¬ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì €ì¥ì„ ì¬ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
                    else:
                        # CEO ì¢…í•© ë¶„ì„ì´ ì‹¤íŒ¨í•œ ê²½ìš°ì—ë„ ì €ì¥ ì˜µì…˜ ì œê³µ
                        st.error("âŒ CEO ì¢…í•© ë¶„ì„ì— ì‹¤íŒ¨í–ˆì§€ë§Œ, ê°œë³„ ì„ì›ì§„ ë¶„ì„ ê²°ê³¼ëŠ” ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
                        # ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ ì˜µì…˜ í‘œì‹œ (ë¶€ë¶„ ì €ì¥)
                        st.markdown("---")
                        st.markdown("### ğŸ’¾ ë¶„ì„ ê²°ê³¼ ì €ì¥ (ë¶€ë¶„ ì™„ë£Œ)")
                        st.warning("âš ï¸ CEO ì¢…í•© ë¶„ì„ì€ ì‹¤íŒ¨í–ˆì§€ë§Œ, ì„±ê³µí•œ ê°œë³„ ì„ì›ì§„ ë¶„ì„ ê²°ê³¼ë¥¼ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
                        save_col1, save_col2 = st.columns([3, 1])
                        with save_col1:
                            session_title = st.text_input(
                                "ğŸ·ï¸ ë¶„ì„ ì„¸ì…˜ ì œëª©", 
                                value=f"AI ë©€í‹°ì—ì´ì „íŠ¸ ë¶„ì„ (ë¶€ë¶„ì™„ë£Œ) - {datetime.now().strftime('%Y%m%d_%H%M')}",
                                help="ì´ ë¶„ì„ ì„¸ì…˜ì„ êµ¬ë¶„í•  ìˆ˜ ìˆëŠ” ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”",
                                key="session_title_input_partial"
                            )
                            tags = st.text_input(
                                "ğŸ·ï¸ íƒœê·¸", 
                                placeholder="ì˜ˆ: ì „ëµë¶„ì„, AI, ì‹ ì‚¬ì—…, ë§ˆì¼€íŒ…ì „ëµ, ë¶€ë¶„ì™„ë£Œ (ì‰¼í‘œë¡œ êµ¬ë¶„)",
                                help="ë‚˜ì¤‘ì— ê²€ìƒ‰í•  ë•Œ ì‚¬ìš©í•  íƒœê·¸ë“¤ì„ ì…ë ¥í•˜ì„¸ìš”",
                                key="tags_input_partial"
                            )
                            notes = st.text_area(
                                "ğŸ“ ë©”ëª¨", 
                                placeholder="CEO ì¢…í•© ë¶„ì„ ì‹¤íŒ¨ë¡œ ë¶€ë¶„ ì €ì¥. ì¶”ê°€ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”...",
                                height=80,
                                help="ì´ ë¶„ì„ì˜ ë°°ê²½ì´ë‚˜ íŠ¹ë³„í•œ ì‚¬í•­ì„ ê¸°ë¡í•´ë‘ì„¸ìš”",
                                key="notes_input_partial"
                            )
                        with save_col2:
                            st.markdown("**ğŸ“Š ë¶„ì„ ì •ë³´**")
                            st.markdown(f"**ì‹¤í–‰ ì‹œê°„**: {execution_time}ì´ˆ")
                            st.markdown(f"**ì„±ê³µí•œ í˜ë¥´ì†Œë‚˜**: {len(successful_analyses)}/{len(PERSONAS)}")
                            st.markdown(f"**RAG ì†ŒìŠ¤**: {len(st.session_state.rag_sources)}ê°œ")
                            st.markdown(f"**AI ëª¨ë¸**: {selected_model}")
                            st.markdown("**ìƒíƒœ**: âš ï¸ ë¶€ë¶„ ì™„ë£Œ")
                        # ë¶€ë¶„ ì €ì¥ ë²„íŠ¼
                        if st.button("ğŸ’¾ ê°œë³„ ë¶„ì„ ê²°ê³¼ë§Œ ì €ì¥ (ë¶€ë¶„ ì €ì¥)", type="secondary", use_container_width=True, key="save_partial_analysis_button"):
                            # ì €ì¥ ì „ ìƒíƒœë¥¼ session_stateì— ë°±ì—…
                            st.session_state.save_backup = {
                                'user_query': user_query,
                                'model_name': selected_model,
                                'analysis_results': st.session_state.current_analysis.copy(),
                                'ceo_synthesis': None,  # CEO ì¢…í•© ë¶„ì„ ì‹¤íŒ¨
                                'execution_time': execution_time,
                                'session_title': session_title.strip() if session_title.strip() else None,
                                'tags': tags.strip() if tags.strip() else None,
                                'notes': notes.strip() if notes.strip() else None
                            }
                            # RAG ì†ŒìŠ¤ ì •ë³´ ì¤€ë¹„
                            rag_sources_info = []
                            if hasattr(st.session_state, 'current_rag_sources'):
                                rag_sources_info = st.session_state.current_rag_sources
                            st.session_state.save_backup['rag_sources'] = rag_sources_info
                            # ë¶„ì„ ê²°ê³¼ ì €ì¥ (ë¶€ë¶„ ì €ì¥)
                            with st.spinner("ë¶€ë¶„ ë¶„ì„ ê²°ê³¼ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ ì¤‘..."):
                                analysis_id = save_virtual_company_analysis(
                                    user_query=user_query,
                                    model_name=selected_model,
                                    persona_analyses=st.session_state.current_analysis,
                                    ceo_synthesis=None,  # CEO ì¢…í•© ë¶„ì„ ì‹¤íŒ¨
                                    rag_sources_used=rag_sources_info,
                                    execution_time=execution_time,
                                    session_title=session_title.strip() if session_title.strip() else None,
                                    tags=tags.strip() if tags.strip() else None,
                                    notes=notes.strip() if notes.strip() else None
                                )
                            # ì €ì¥ ê²°ê³¼ë¥¼ session_stateì— ì €ì¥ (í”„ë¡œì íŠ¸ ë¦¬ë·° ë°©ì‹)
                            if analysis_id:
                                st.success(f"âœ… ë¶€ë¶„ ë¶„ì„ ê²°ê³¼ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! (ID: {analysis_id})")
                                st.warning("âš ï¸ CEO ì¢…í•© ë¶„ì„ì´ ì‹¤íŒ¨í•˜ì—¬ ê°œë³„ ì„ì›ì§„ ë¶„ì„ë§Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
                                st.info("ğŸ’¡ ì €ì¥ëœ ë¶„ì„ ê²°ê³¼ëŠ” ì•„ë˜ 'ë¶„ì„ íˆìŠ¤í† ë¦¬ ê´€ë¦¬' ì„¹ì…˜ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
                                # ì„¸ì…˜ ìƒíƒœì— ì €ì¥ëœ ë¶„ì„ ì •ë³´ ì €ì¥ (ë¦¬ì…‹ ë°©ì§€)
                                st.session_state.saved_analysis_id = analysis_id
                                st.session_state.analysis_saved = True
                                st.session_state.save_timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                                st.session_state.partial_save = True
                            else:
                                st.error("âŒ ë¶€ë¶„ ë¶„ì„ ê²°ê³¼ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")
                        # ë””ë²„ê¹… ì •ë³´ í‘œì‹œ
                        with st.expander("ğŸ” ë””ë²„ê¹… ì •ë³´", expanded=False):
                            st.write("**ë¶„ì„ ìƒíƒœ ì •ë³´:**")
                            st.write(f"- successful_analyses ê°œìˆ˜: {len(successful_analyses)}")
                            st.write(f"- ceo_synthesis ìƒíƒœ: {'ì„±ê³µ' if ceo_synthesis else 'ì‹¤íŒ¨'}")
                            st.write(f"- session_state.analysis_complete: {st.session_state.get('analysis_complete', False)}")
                            st.write(f"- session_state.current_analysis í‚¤ë“¤: {list(st.session_state.current_analysis.keys())}")
                            if ceo_synthesis:
                                st.write(f"- CEO ë¶„ì„ ê¸¸ì´: {len(ceo_synthesis)}ì")
                            else:
                                st.write("- CEO ë¶„ì„: None ë˜ëŠ” ë¹ˆ ë¬¸ìì—´")
            # ì €ì¥ ì™„ë£Œ ìƒíƒœ í‘œì‹œ (ì„¸ì…˜ ìƒíƒœ ê¸°ë°˜)
            if st.session_state.get('analysis_saved', False) and 'saved_analysis_id' in st.session_state:
                st.markdown("---")
                st.markdown("### âœ… ì €ì¥ ì™„ë£Œ")
                if st.session_state.get('partial_save', False):
                    st.info(f"ğŸ“Š **ë¶€ë¶„ ì €ì¥ ID**: {st.session_state.saved_analysis_id}")
                    st.warning("âš ï¸ CEO ì¢…í•© ë¶„ì„ì´ ì‹¤íŒ¨í•˜ì—¬ ê°œë³„ ì„ì›ì§„ ë¶„ì„ë§Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
                else:
                    st.info(f"ğŸ“Š **ì €ì¥ ID**: {st.session_state.saved_analysis_id}")
                st.info(f"â° **ì €ì¥ ì‹œê°„**: {st.session_state.get('save_timestamp', 'Unknown')}")
                col1, col2, col3 = st.columns(3)
                with col1:
                    # ì €ì¥ëœ ë¶„ì„ìœ¼ë¡œ ìë™ ì´ë™í•˜ëŠ” ë²„íŠ¼
                    if st.button("ğŸ“‹ ì €ì¥ëœ ë¶„ì„ ê²°ê³¼ ë°”ë¡œ ë³´ê¸°", key="view_saved_analysis_final"):
                        st.session_state.selected_analysis_id = st.session_state.saved_analysis_id
                        st.session_state.show_history_tab = True
                with col2:
                    # ìƒˆ ë¶„ì„ ì‹œì‘ ë²„íŠ¼
                    if st.button("ğŸ†• ìƒˆë¡œìš´ ë¶„ì„ ì‹œì‘", key="new_analysis_final"):
                        # ë¶„ì„ ê´€ë ¨ session_state ì´ˆê¸°í™”
                        keys_to_remove = [
                            'current_analysis', 'analysis_complete', 'analysis_saved', 
                            'saved_analysis_id', 'save_timestamp', 'partial_save', 'save_backup'
                        ]
                        for key in keys_to_remove:
                            if key in st.session_state:
                                del st.session_state[key]
                with col3:
                    # ì €ì¥ ìƒíƒœ ë©”ì‹œì§€ ì œê±° ë²„íŠ¼
                    if st.button("âŒ ì €ì¥ ì™„ë£Œ ë©”ì‹œì§€ ë‹«ê¸°", key="close_save_complete_message"):
                        # ì €ì¥ ì™„ë£Œ ê´€ë ¨ ìƒíƒœë§Œ ì œê±° (ë¶„ì„ ê²°ê³¼ëŠ” ìœ ì§€)
                        keys_to_remove = ['analysis_saved', 'saved_analysis_id', 'save_timestamp', 'partial_save']
                        for key in keys_to_remove:
                            if key in st.session_state:
                                del st.session_state[key]
            else:
                st.error("âŒ ëª¨ë“  ì„ì›ì§„ ë¶„ì„ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.")
        # ì§„í–‰ ìƒí™© í‘œì‹œ ì œê±°
        progress_container.empty()
        if st.session_state.analysis_complete:
            st.balloons()
            st.success("ğŸ‰ ë™ì‹œ ë¶„ì„ì´ ëª¨ë‘ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")

# ë¶„ì„ ê²°ê³¼ í‘œì‹œ
if (st.session_state.analysis_complete or st.session_state.get('analysis_saved', False)) and 'CEO' in st.session_state.current_analysis:
    st.markdown("---")
    st.markdown("## ğŸ‘‘ CEO ìµœì¢… ì¢…í•© ë³´ê³ ì„œ")
    
    # RAG ì°¸ê³  ì •ë³´ í‘œì‹œ
    if hasattr(st.session_state, 'current_rag_sources') and st.session_state.current_rag_sources:
        st.markdown("### ğŸ“Š ë¶„ì„ì— í™œìš©ëœ RAG ë°ì´í„° ì†ŒìŠ¤")
        
        cols = st.columns(len(st.session_state.current_rag_sources))
        for i, source_info in enumerate(st.session_state.current_rag_sources):
            with cols[i]:
                if source_info['type'] == 'mysql':
                    # HTML ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
                    safe_name = str(source_info['name']).replace('<', '&lt;').replace('>', '&gt;')
                    safe_details = str(source_info['details']).replace('<', '&lt;').replace('>', '&gt;')
                    safe_tables = [str(table).replace('<', '&lt;').replace('>', '&gt;') for table in source_info['tables'][:3]]
                    
                    st.markdown(f"""
                    <div style="background: linear-gradient(145deg, #e3f2fd, #ffffff); border-left: 4px solid #2196f3; border-radius: 8px; padding: 15px; margin: 5px 0;">
                        <h4 style="margin: 0; color: #1976d2;">ğŸ—„ï¸ {safe_name}</h4>
                        <p style="margin: 5px 0; font-size: 0.9rem; color: #666;">{safe_details}</p>
                        <p style="margin: 5px 0; font-size: 0.8rem; color: #888;">
                            í…Œì´ë¸”: {', '.join(safe_tables)}
                            {f" ë“± {len(source_info['tables'])}ê°œ" if len(source_info['tables']) > 3 else ""}
                        </p>
                    </div>
                    """, unsafe_allow_html=True)
                elif source_info['type'] == 'website':
                    # HTML ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
                    safe_name = str(source_info['name']).replace('<', '&lt;').replace('>', '&gt;')
                    safe_details = str(source_info['details']).replace('<', '&lt;').replace('>', '&gt;')
                    safe_url_title = str(source_info['urls'][0]['title']).replace('<', '&lt;').replace('>', '&gt;') if source_info['urls'] else 'N/A'
                    
                    st.markdown(f"""
                    <div style="background: linear-gradient(145deg, #e8f5e8, #ffffff); border-left: 4px solid #4caf50; border-radius: 8px; padding: 15px; margin: 5px 0;">
                        <h4 style="margin: 0; color: #388e3c;">ğŸŒ {safe_name}</h4>
                        <p style="margin: 5px 0; font-size: 0.9rem; color: #666;">{safe_details}</p>
                        <p style="margin: 5px 0; font-size: 0.8rem; color: #888;">
                            ì£¼ìš” ì‚¬ì´íŠ¸: {safe_url_title}
                        </p>
                    </div>
                    """, unsafe_allow_html=True)
                elif source_info['type'] == 'files':
                    # HTML ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
                    safe_name = str(source_info['name']).replace('<', '&lt;').replace('>', '&gt;')
                    safe_details = str(source_info['details']).replace('<', '&lt;').replace('>', '&gt;')
                    safe_files = [str(file).replace('<', '&lt;').replace('>', '&gt;') for file in source_info.get('files', [])[:2]]
                    
                    st.markdown(f"""
                    <div style="background: linear-gradient(145deg, #fff3e0, #ffffff); border-left: 4px solid #ff9800; border-radius: 8px; padding: 15px; margin: 5px 0;">
                        <h4 style="margin: 0; color: #f57c00;">ğŸ“„ {safe_name}</h4>
                        <p style="margin: 5px 0; font-size: 0.9rem; color: #666;">{safe_details}</p>
                        <p style="margin: 5px 0; font-size: 0.8rem; color: #888;">
                            íŒŒì¼: {', '.join(safe_files)}
                            {f" ë“± {len(source_info.get('files', []))}ê°œ" if len(source_info.get('files', [])) > 2 else ""}
                        </p>
                    </div>
                    """, unsafe_allow_html=True)
        
        st.info("ğŸ’¡ ìœ„ RAG ë°ì´í„°ê°€ ëª¨ë“  C-Level ì„ì›ì§„ì˜ ë¶„ì„ê³¼ CEO ì¢…í•© ì˜ì‚¬ê²°ì •ì— í™œìš©ë˜ì—ˆìŠµë‹ˆë‹¤.")
        st.markdown("---")
    
    st.markdown(f"""
    <div class="ceo-final">
        <h3>ğŸ‘‘ CEO ìµœì¢… ì˜ì‚¬ê²°ì • ë³´ê³ ì„œ</h3>
        <p><strong>ë¶„ì„ ì™„ë£Œ ì‹œê°„:</strong> {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</p>
    </div>
    """, unsafe_allow_html=True)
    
    st.markdown(st.session_state.current_analysis['CEO']['result'])
    
    # References ì„¹ì…˜ ì¶”ê°€ - ì‹¤ì œ ì°¸ê³ í•œ êµ¬ì²´ì  ë°ì´í„° í‘œì‹œ
    if hasattr(st.session_state, 'current_rag_sources') and st.session_state.current_rag_sources:
        st.markdown("---")
        st.markdown("## ğŸ“š References - ì‹¤ì œ ì°¸ê³ í•œ êµ¬ì²´ì  ë°ì´í„°")
        
        for source in st.session_state.current_rag_sources:
            if source['type'] == 'mysql' and st.session_state.mysql_data:
                st.markdown("### ğŸ—„ï¸ MySQL ë°ì´í„°ë² ì´ìŠ¤ ì°¸ê³  ë‚´ìš©")
                for table_name, df in st.session_state.mysql_data.items():
                    with st.expander(f"ğŸ“Š {table_name} í…Œì´ë¸” ({len(df):,}í–‰)"):
                        # HTML ì´ìŠ¤ì¼€ì´í”„ë¥¼ ìœ„í•´ ì»¬ëŸ¼ëª… ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
                        safe_columns = [str(col).replace('<', '&lt;').replace('>', '&gt;') for col in df.columns.tolist()]
                        st.markdown(f"**ì»¬ëŸ¼**: {', '.join(safe_columns)}")
                        st.markdown("**ìƒ˜í”Œ ë°ì´í„°**:")
                        
                        # ë°ì´í„°í”„ë ˆì„ì˜ HTML íƒœê·¸ë¥¼ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
                        safe_df = df.head(3).copy()
                        for col in safe_df.columns:
                            if safe_df[col].dtype == 'object':  # ë¬¸ìì—´ ì»¬ëŸ¼ë§Œ ì²˜ë¦¬
                                safe_df[col] = safe_df[col].astype(str).str.replace('<', '&lt;').str.replace('>', '&gt;')
                        
                        st.dataframe(safe_df, use_container_width=True)
                        
            elif source['type'] == 'website' and st.session_state.website_data:
                st.markdown("### ğŸŒ ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ì°¸ê³  ë‚´ìš©")
                for i, page_data in enumerate(st.session_state.website_data[:3]):
                    # HTML ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
                    safe_title = str(page_data['title']).replace('<', '&lt;').replace('>', '&gt;')
                    safe_url = str(page_data['url']).replace('<', '&lt;').replace('>', '&gt;')
                    safe_content = str(page_data['content']).replace('<', '&lt;').replace('>', '&gt;')
                    
                    with st.expander(f"ğŸŒ {safe_title}"):
                        st.markdown(f"**URL**: {safe_url}")
                        st.markdown(f"**ë‚´ìš© ê¸¸ì´**: {len(page_data['content']):,}ì")
                        st.markdown("**ì£¼ìš” ë‚´ìš©**:")
                        st.text(safe_content[:500] + "..." if len(safe_content) > 500 else safe_content)
        
        st.info("ğŸ’¡ ìœ„ì˜ êµ¬ì²´ì ì¸ ë°ì´í„°ë“¤ì´ C-Level ì„ì›ì§„ ë¶„ì„ê³¼ CEO ìµœì¢… ì˜ì‚¬ê²°ì •ì— ì‹¤ì œë¡œ í™œìš©ë˜ì—ˆìŠµë‹ˆë‹¤.")
    
    # ê°œë³„ ì„ì›ì§„ ë¶„ì„ ê²°ê³¼ (ì ‘ì„ ìˆ˜ ìˆëŠ” í˜•íƒœ)
    st.markdown("## ğŸ“‹ ê°œë³„ ì„ì›ì§„ ë¶„ì„ ê²°ê³¼")
    
    for persona_key, persona_info in PERSONAS.items():
        if persona_key in st.session_state.current_analysis:
            analysis_data = st.session_state.current_analysis[persona_key]
            with st.expander(f"{persona_info['emoji']} {persona_info['name']} ìƒì„¸ ë¶„ì„"):
                # RAG ì°¸ê³  ì •ë³´ (ê°œë³„ ë¶„ì„ìš©)
                if hasattr(st.session_state, 'current_rag_sources') and st.session_state.current_rag_sources:
                    st.markdown("**ğŸ“Š ì°¸ê³  ë°ì´í„° ì†ŒìŠ¤:**")
                    rag_summary = []
                    for source_info in st.session_state.current_rag_sources:
                        if source_info['type'] == 'mysql':
                            rag_summary.append(f"ğŸ—„ï¸ MySQL ({source_info['details']})")
                        elif source_info['type'] == 'website':
                            rag_summary.append(f"ğŸŒ ì›¹ì‚¬ì´íŠ¸ ({source_info['details']})")
                        elif source_info['type'] == 'files':
                            rag_summary.append(f"ğŸ“„ ë¬¸ì„œ ({source_info['details']})")
                    st.write(" | ".join(rag_summary))
                    st.markdown("---")
                
                st.markdown(f"**ë¶„ì„ ì‹œê°„:** {analysis_data['timestamp']}")
                st.markdown("---")
                st.markdown(analysis_data['result'])

# í‘¸í„°
st.markdown("---")

# ì‚¬ìš©ë²• ì•ˆë‚´
with st.expander("ğŸ’¡ ì‚¬ìš©ë²• ì•ˆë‚´"):
    st.markdown("""
    ### ğŸ¢ C-Level ë©€í‹°ì—ì´ì „íŠ¸ + RAG ì‹œìŠ¤í…œ ì‚¬ìš©ë²•
    
    #### ğŸš€ ê¸°ë³¸ ì‚¬ìš© ë‹¨ê³„
    1. **ëª¨ë¸ ì„ íƒ**: ì‚¬ì´ë“œë°”ì—ì„œ ì‚¬ìš©í•  AI ëª¨ë¸ì„ ì„ íƒí•˜ì„¸ìš” (Claude/ChatGPT)
    2. **RAG ë°ì´í„° ì¤€ë¹„**: ë¶„ì„ì— í™œìš©í•  ì¶”ê°€ ë°ì´í„°ë¥¼ ì„¤ì •í•˜ì„¸ìš”
       - ğŸ—„ï¸ **MySQL ë°ì´í„°ë² ì´ìŠ¤**: íšŒì‚¬ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ë° í…Œì´ë¸” ì„ íƒ
       - ğŸŒ **ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§**: ê´€ë ¨ ì›¹ì‚¬ì´íŠ¸ì˜ ìµœì‹  ì •ë³´ ìˆ˜ì§‘
       - ğŸ“„ **ë¬¸ì„œ íŒŒì¼**: ë³´ê³ ì„œ, ê³„íšì„œ ë“± ê´€ë ¨ ë¬¸ì„œ ì—…ë¡œë“œ
    3. **ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸**: ê° ì„ì›ì§„ì—ê²Œ íŠ¹ë³„í•œ ë¶„ì„ì„ ìš”ì²­í•˜ê³  ì‹¶ë‹¤ë©´ ì„¤ì •í•˜ì„¸ìš”
    4. **ì£¼ì œ ì…ë ¥**: ë©”ì¸ ì°½ì—ì„œ ë¶„ì„í•˜ê³  ì‹¶ì€ ì£¼ì œë‚˜ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”
    5. **ë™ì‹œ ë¶„ì„**: ëª¨ë“  C-Level ì„ì›ì§„ì´ **ì‹¤ì œë¡œ ë™ì‹œì—** RAG ë°ì´í„°ë¥¼ í™œìš©í•˜ì—¬ ë¶„ì„í•©ë‹ˆë‹¤ ğŸš€
    6. **CEO ì¢…í•©**: ëª¨ë“  ë¶„ì„ì´ ëë‚˜ë©´ CEO(ë‹¹ì‹ )ê°€ ìµœì¢… ì¢…í•© ì˜ì‚¬ê²°ì •ì„ ì œì‹œí•©ë‹ˆë‹¤
    
    #### ğŸ­ í˜ë¥´ì†Œë‚˜ë³„ íŠ¹ì§•
    - **ğŸ’» CTO**: ê¸°ìˆ ì  íƒ€ë‹¹ì„±ê³¼ êµ¬í˜„ ë°©ì•ˆ, ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜
    - **ğŸ¯ CSO(ì „ëµ)**: ì‹œì¥ ë¶„ì„ê³¼ ì„±ì¥ ì „ëµ, ê²½ìŸ ë¶„ì„
    - **ğŸ“¢ CMO**: ë§ˆì¼€íŒ…ê³¼ ê³ ê° ê²½í—˜, ë¸Œëœë“œ ì „ëµ
    - **ğŸ’° CFO**: ì¬ë¬´ì  íƒ€ë‹¹ì„±ê³¼ ë¦¬ìŠ¤í¬, íˆ¬ì ë¶„ì„
    - **ğŸ¤ CSO(ì˜ì—…)**: ì˜ì—… ì „ëµê³¼ ê³ ê° ê´€ê³„, ì‹œì¥ ê°œë°œ
    - **ğŸ” CIO**: ì •ë³´ì‹œìŠ¤í…œê³¼ ë°ì´í„° ì „ëµ, IT ê±°ë²„ë„ŒìŠ¤
    - **ğŸ‘‘ CEO**: ìµœì¢… ì¢…í•© ì˜ì‚¬ê²°ì • ë° í†µí•© ì‹¤í–‰ ê³„íš
    
    #### ğŸ” RAG ë°ì´í„° ì†ŒìŠ¤ë³„ í™œìš©ë²•
    
    **ğŸ—„ï¸ MySQL ë°ì´í„°ë² ì´ìŠ¤**
    - íšŒì‚¬ì˜ ì‹¤ì‹œê°„ ìš´ì˜ ë°ì´í„°ë¥¼ ë¶„ì„ì— í™œìš©
    - ê³ ê° ë°ì´í„°, ë§¤ì¶œ ë°ì´í„°, ì¬ê³  í˜„í™© ë“±
    - ì˜ˆì‹œ: "ì§€ë‚œ ë¶„ê¸° ë§¤ì¶œ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë§ˆì¼€íŒ… ì „ëµì„ ìˆ˜ë¦½í•´ì£¼ì„¸ìš”"
    
    **ğŸŒ ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§**
    - ê²½ìŸì‚¬ ì›¹ì‚¬ì´íŠ¸, ì—…ê³„ ë‰´ìŠ¤, ì‹œì¥ ë™í–¥ íŒŒì•…
    - ìµœì‹  íŠ¸ë Œë“œì™€ ì‹œì¥ ì •ë³´ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°˜ì˜
    - ì˜ˆì‹œ: "ê²½ìŸì‚¬ ì›¹ì‚¬ì´íŠ¸ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìš°ë¦¬ì˜ ì°¨ë³„í™” ì „ëµì„ ì œì•ˆí•´ì£¼ì„¸ìš”"
    
    **ğŸ“„ ë¬¸ì„œ íŒŒì¼**
    - ê¸°ì¡´ ë³´ê³ ì„œ, ê³„íšì„œ, ì‹œì¥ ì¡°ì‚¬ ìë£Œ ë“±
    - ê³¼ê±° ë°ì´í„°ì™€ ë¶„ì„ ê²°ê³¼ë¥¼ í˜„ì¬ ë¶„ì„ì— í™œìš©
    - ì˜ˆì‹œ: "ì‘ë…„ ì‚¬ì—… ê³„íšì„œë¥¼ ì°¸ê³ í•˜ì—¬ ì˜¬í•´ ì „ëµì„ ìˆ˜ì •í•´ì£¼ì„¸ìš”"
    
    #### âš¡ ë™ì‹œ ì²˜ë¦¬ì˜ ì¥ì 
    - **ì†ë„**: ìˆœì°¨ ì²˜ë¦¬ ëŒ€ë¹„ **6ë°° ë¹ ë¥¸** ë¶„ì„ ì†ë„
    - **íš¨ìœ¨ì„±**: ëª¨ë“  ì„ì›ì§„ì´ **ì‹¤ì œë¡œ ë™ì‹œì—** ì‘ì—…
    - **ë°ì´í„° í™œìš©**: RAGë¥¼ í†µí•´ **ì‹¤ì œ ë°ì´í„° ê¸°ë°˜** ë¶„ì„
    - **ì‹¤ì‹œê°„**: ì™„ë£Œë˜ëŠ” ìˆœì„œëŒ€ë¡œ **ì¦‰ì‹œ ê²°ê³¼ í™•ì¸**
    - **ê²¬ê³ ì„±**: ì¼ë¶€ ë¶„ì„ì´ ì‹¤íŒ¨í•´ë„ ë‚˜ë¨¸ì§€ëŠ” ì •ìƒ ì§„í–‰
    - **íˆ¬ëª…ì„±**: **ë¶„ì„ì— í™œìš©ëœ RAG ë°ì´í„° ì†ŒìŠ¤ ëª…ì‹œ**ë¡œ ì‹ ë¢°ì„± í™•ë³´
    
    #### ğŸ” RAG ë°ì´í„° ì°¸ê³  ì •ë³´ í‘œì‹œ
    - **ë¶„ì„ íˆ¬ëª…ì„±**: ì–´ë–¤ ë°ì´í„°ë¥¼ ì°¸ê³ í–ˆëŠ”ì§€ ëª…í™•íˆ í‘œì‹œ
    - **ì‹ ë¢°ì„± ì¦ëŒ€**: ë¶„ì„ ê·¼ê±°ê°€ ë˜ëŠ” ë°ì´í„° ì†ŒìŠ¤ í™•ì¸ ê°€ëŠ¥
    - **ì¶”ì  ê°€ëŠ¥ì„±**: ë‚˜ì¤‘ì— ê²°ê³¼ ê²€ì¦ ì‹œ ì°¸ê³  ë°ì´í„° í™•ì¸
    - **í’ˆì§ˆ ê´€ë¦¬**: RAG ë°ì´í„°ì˜ í’ˆì§ˆê³¼ ê´€ë ¨ì„± í‰ê°€ ê°€ëŠ¥
    
    **í‘œì‹œë˜ëŠ” RAG ì •ë³´:**
    - ğŸ—„ï¸ **MySQL ë°ì´í„°ë² ì´ìŠ¤**: í™œìš©ëœ í…Œì´ë¸” ëª©ë¡ê³¼ ë°ì´í„° ê·œëª¨
    - ğŸŒ **ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§**: ìˆ˜ì§‘ëœ í˜ì´ì§€ ìˆ˜ì™€ ì£¼ìš” ì‚¬ì´íŠ¸ ì •ë³´
    - ğŸ“„ **ì—…ë¡œë“œ ë¬¸ì„œ**: ë¶„ì„ì— ì‚¬ìš©ëœ íŒŒì¼ ëª©ë¡ê³¼ í¬ê¸° ì •ë³´
    
    #### ğŸ’¡ íš¨ê³¼ì ì¸ í™œìš© íŒ
    
    **ì£¼ì œ ì„¤ì •**
    - êµ¬ì²´ì ì´ê³  ëª…í™•í•œ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”
    - ì˜ˆ: "ì‹ ì œí’ˆ ì¶œì‹œë¥¼ ìœ„í•œ ì¢…í•© ì „ëµ" â†’ "AI ê¸°ë°˜ ì±—ë´‡ ì„œë¹„ìŠ¤ ì¶œì‹œë¥¼ ìœ„í•œ ë§ˆì¼€íŒ…, ê¸°ìˆ , ì¬ë¬´ ì „ëµ"
    
    **RAG ë°ì´í„° ì¡°í•©**
    - ì—¬ëŸ¬ ë°ì´í„° ì†ŒìŠ¤ë¥¼ ì¡°í•©í•˜ë©´ ë” í’ë¶€í•œ ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤
    - MySQL(ë‚´ë¶€ ë°ì´í„°) + ì›¹ì‚¬ì´íŠ¸(ì™¸ë¶€ ì •ë³´) + ë¬¸ì„œ(ê³¼ê±° ìë£Œ) ì¡°í•© ì¶”ì²œ
    
    **ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ í™œìš©**
    - ê° ì„ì›ì§„ì˜ ì „ë¬¸ ë¶„ì•¼ì— ë§ëŠ” êµ¬ì²´ì ì¸ ìš”ì²­ì„ ì¶”ê°€í•˜ì„¸ìš”
    - ì˜ˆ: CFOì—ê²Œ "ROI ê³„ì‚°ê³¼ í•¨ê»˜ 3ë…„ ì¬ë¬´ ì „ë§ í¬í•¨", CTOì—ê²Œ "ê¸°ìˆ  êµ¬í˜„ ì¼ì •ê³¼ ë¦¬ì†ŒìŠ¤ ìš”êµ¬ì‚¬í•­ í¬í•¨"
    
    **RAG ì°¸ê³  ì •ë³´ í™œìš©**
    - ë¶„ì„ ê²°ê³¼ ìƒë‹¨ì— í‘œì‹œë˜ëŠ” RAG ë°ì´í„° ì†ŒìŠ¤ë¥¼ í™•ì¸í•˜ì—¬ ë¶„ì„ì˜ ê·¼ê±°ë¥¼ íŒŒì•…í•˜ì„¸ìš”
    - ê° ì„ì›ì§„ ë¶„ì„ ê²°ê³¼ì—ì„œ ì–´ë–¤ ë°ì´í„°ë¥¼ ì°¸ê³ í–ˆëŠ”ì§€ ì¶”ì  ê°€ëŠ¥í•©ë‹ˆë‹¤
    - í•„ìš”ì‹œ ì¶”ê°€ ë°ì´í„° ìˆ˜ì§‘ì´ë‚˜ ë°ì´í„° í’ˆì§ˆ ê°œì„ ì— í™œìš©í•˜ì„¸ìš”
    
    #### ğŸ’¾ ë¶„ì„ ê²°ê³¼ ì €ì¥ ë° ê´€ë¦¬
    
    **ğŸ·ï¸ ë¶„ì„ ê²°ê³¼ ì €ì¥**
    - ë¶„ì„ ì™„ë£Œ í›„ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ì—¬ ë‚˜ì¤‘ì— ì°¸ì¡°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
    - ì„¸ì…˜ ì œëª©, íƒœê·¸, ë©”ëª¨ë¥¼ ì¶”ê°€í•˜ì—¬ ê²€ìƒ‰ê³¼ ë¶„ë¥˜ë¥¼ ìš©ì´í•˜ê²Œ í•˜ì„¸ìš”
    - ì €ì¥ë˜ëŠ” ì •ë³´: ì „ì²´ ë¶„ì„ ê³¼ì •, í˜ë¥´ì†Œë‚˜ë³„ ê²°ê³¼, RAG ì†ŒìŠ¤, ì‹¤í–‰ ì‹œê°„ ë“±
    
    **ğŸ” ë¶„ì„ íˆìŠ¤í† ë¦¬ ê²€ìƒ‰**
    - í‚¤ì›Œë“œ, AI ëª¨ë¸, ì™„ë£Œ ìƒíƒœë³„ë¡œ í•„í„°ë§í•˜ì—¬ ì›í•˜ëŠ” ë¶„ì„ì„ ë¹ ë¥´ê²Œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤
    - ì „ë¬¸ ê²€ìƒ‰(Full-text Search) ê¸°ëŠ¥ìœ¼ë¡œ ë‚´ìš© ê¹Šìˆ™ì´ ì €ì¥ëœ ì •ë³´ê¹Œì§€ ê²€ìƒ‰ ê°€ëŠ¥
    - ë¶„ì„ ê²°ê³¼ì˜ ìƒì„¸ ë‚´ìš©ì„ ë‹¤ì‹œ í™•ì¸í•˜ê³  í•„ìš”ì‹œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
    
    **ğŸ“Š ë¶„ì„ í†µê³„ í™œìš©**
    - ì›”ë³„ ë¶„ì„ íšŸìˆ˜, AI ëª¨ë¸ë³„ ì„±ëŠ¥, ì„±ê³µë¥  ë“±ì˜ í†µê³„ë¥¼ í™•ì¸í•˜ì„¸ìš”
    - ì–´ë–¤ ë¶„ì„ íŒ¨í„´ì´ ê°€ì¥ íš¨ê³¼ì ì¸ì§€ íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
    - íŒ€ì˜ ë¶„ì„ í™œë™ì„ ëª¨ë‹ˆí„°ë§í•˜ê³  ê°œì„ ì ì„ ì°¾ëŠ” ë° í™œìš©í•˜ì„¸ìš”
    
    **âš™ï¸ ë°ì´í„° ê´€ë¦¬**
    - ì‹¤íŒ¨í•œ ë¶„ì„ì´ë‚˜ ì˜¤ë˜ëœ ë¶„ì„ ê²°ê³¼ëŠ” ì •ê¸°ì ìœ¼ë¡œ ì •ë¦¬í•˜ì„¸ìš”
    - ì¤‘ìš”í•œ ë¶„ì„ì—ëŠ” íƒœê·¸ì™€ ë©”ëª¨ë¥¼ ì˜ í™œìš©í•˜ì—¬ ë‚˜ì¤‘ì— ì‰½ê²Œ ì°¾ì„ ìˆ˜ ìˆë„ë¡ í•˜ì„¸ìš”
    - íŒ€ ì°¨ì›ì—ì„œ ë¶„ì„ ê²°ê³¼ë¥¼ ê³µìœ í•˜ê³  ì¶•ì ëœ ì¸ì‚¬ì´íŠ¸ë¥¼ í™œìš©í•˜ì„¸ìš”
    
    #### ğŸ”„ ë¶„ì„ ê²°ê³¼ ì¬í™œìš©
    
    **ê³¼ê±° ë¶„ì„ ì°¸ì¡°**
    - ìœ ì‚¬í•œ ì£¼ì œì˜ ê³¼ê±° ë¶„ì„ ê²°ê³¼ë¥¼ ì°¸ì¡°í•˜ì—¬ ë” ê¹Šì´ ìˆëŠ” ë¶„ì„ì„ ìˆ˜í–‰í•˜ì„¸ìš”
    - ì‹œê°„ì˜ íë¦„ì— ë”°ë¥¸ ë¶„ì„ ê²°ê³¼ ë³€í™”ë¥¼ ì¶”ì í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
    - ì´ì „ ë¶„ì„ì—ì„œ ë†“ì¹œ ë¶€ë¶„ì„ ë³´ì™„í•˜ëŠ” í›„ì† ë¶„ì„ì„ ì§„í–‰í•˜ì„¸ìš”
    
    **ë¶„ì„ íŒ¨í„´ í•™ìŠµ**
    - ì„±ê³µì ì¸ ë¶„ì„ì˜ íŒ¨í„´(RAG ì†ŒìŠ¤ ì¡°í•©, í”„ë¡¬í”„íŠ¸ ì„¤ì • ë“±)ì„ íŒŒì•…í•˜ì—¬ ì¬í™œìš©í•˜ì„¸ìš”
    - íŠ¹ì • ì—…ë¬´ ì˜ì—­ì—ì„œ íš¨ê³¼ì ì¸ ë¶„ì„ ë°©ë²•ë¡ ì„ ì¶•ì í•´ë‚˜ê°€ì„¸ìš”
    """)

st.markdown("""
<div style="text-align: center; color: #666; font-size: 0.9rem;">
    ğŸ¬ Virtual AqaraLife C-Level ë©€í‹°ì—ì´ì „íŠ¸ + RAG ì‹œìŠ¤í…œ | Powered by Claude & ChatGPT<br>
    ğŸ” RAG: MySQL Database + Website Crawling + Document Analysis
</div>
""", unsafe_allow_html=True)

# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

# ==================== ë°ì´í„°ë² ì´ìŠ¤ ê´€ë ¨ í•¨ìˆ˜ë“¤ ====================

def save_virtual_company_analysis(user_query, model_name, persona_analyses, ceo_synthesis, rag_sources_used, execution_time, session_title=None, tags=None, notes=None):
    """Virtual Company ë¶„ì„ ê²°ê³¼ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥"""
    try:
        st.info("ğŸ”„ ì €ì¥ í”„ë¡œì„¸ìŠ¤ ì‹œì‘...")
        
        # 1. ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°
        connection = connect_to_db()
        if not connection:
            st.error("âŒ 1ë‹¨ê³„ ì‹¤íŒ¨: ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°")
            return None
        
        st.info("âœ… 1ë‹¨ê³„ ì„±ê³µ: ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°")
        cursor = connection.cursor()
        
        # 2. í…Œì´ë¸” ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        try:
            cursor.execute("SHOW TABLES LIKE 'virtual_company_analyses'")
            main_table = cursor.fetchone()
            if not main_table:
                st.error("âŒ 2ë‹¨ê³„ ì‹¤íŒ¨: virtual_company_analyses í…Œì´ë¸”ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤")
                cursor.close()
                connection.close()
                return None
        except Exception as table_check_error:
            st.error(f"âŒ 2ë‹¨ê³„ ì‹¤íŒ¨: í…Œì´ë¸” í™•ì¸ ì¤‘ ì˜¤ë¥˜: {str(table_check_error)}")
            cursor.close()
            connection.close()
            return None
        
        st.info("âœ… 2ë‹¨ê³„ ì„±ê³µ: í…Œì´ë¸” ì¡´ì¬ í™•ì¸")
        
        # 3. ë°ì´í„° ì¤€ë¹„
        if not session_title:
            session_title = f"AI ë©€í‹°ì—ì´ì „íŠ¸ ë¶„ì„ - {datetime.now().strftime('%Y%m%d_%H%M')}"
        
        successful_personas = len([p for p in persona_analyses.values() if p.get('success', False)])
        total_personas = len(persona_analyses)
        
        if successful_personas == 0:
            completion_status = 'ì˜¤ë¥˜'
        elif successful_personas < total_personas:
            completion_status = 'ë¶€ë¶„ì™„ë£Œ'
        else:
            completion_status = 'ì™„ë£Œ'
        
        st.info(f"âœ… 3ë‹¨ê³„ ì„±ê³µ: ë°ì´í„° ì¤€ë¹„ ì™„ë£Œ (ì„±ê³µ í˜ë¥´ì†Œë‚˜: {successful_personas}/{total_personas})")
        
        # 4. ë©”ì¸ ë¶„ì„ ì„¸ì…˜ ì €ì¥
        try:
            analysis_sql = """
            INSERT INTO virtual_company_analyses 
            (session_title, user_query, model_name, completion_status, ceo_synthesis, 
             total_personas, successful_personas, rag_sources_used, execution_time_seconds, tags, notes)
            VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
            """
            
            analysis_values = (
                session_title, user_query, model_name, completion_status, ceo_synthesis,
                total_personas, successful_personas, len(rag_sources_used), execution_time, tags, notes
            )
            
            st.info(f"ğŸ“ ë©”ì¸ INSERT ì¿¼ë¦¬ ì‹¤í–‰: session_title='{session_title}', model='{model_name}', status='{completion_status}'")
            
            cursor.execute(analysis_sql, analysis_values)
            analysis_id = cursor.lastrowid
            
            if not analysis_id:
                st.error("âŒ 4ë‹¨ê³„ ì‹¤íŒ¨: ë©”ì¸ ë¶„ì„ ì„¸ì…˜ IDë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
                cursor.close()
                connection.close()
                return None
            
            st.info(f"âœ… 4ë‹¨ê³„ ì„±ê³µ: ë©”ì¸ ë¶„ì„ ì„¸ì…˜ ì €ì¥ ì™„ë£Œ (ID: {analysis_id})")
                
        except Exception as main_save_error:
            st.error(f"âŒ 4ë‹¨ê³„ ì‹¤íŒ¨: ë©”ì¸ ë¶„ì„ ì„¸ì…˜ ì €ì¥ ì˜¤ë¥˜: {str(main_save_error)}")
            st.error(f"ğŸ” SQL: {analysis_sql}")
            st.error(f"ğŸ” Values: {analysis_values}")
            cursor.close()
            connection.close()
            return None
        
        # 5. í˜ë¥´ì†Œë‚˜ë³„ ë¶„ì„ ê²°ê³¼ ì €ì¥
        try:
            saved_personas = 0
            for persona_key, analysis_data in persona_analyses.items():
                if persona_key in PERSONAS:
                    persona_info = PERSONAS[persona_key]
                    
                    persona_sql = """
                    INSERT INTO virtual_company_persona_analyses
                    (analysis_id, persona_key, persona_name, persona_role, analysis_result, 
                     analysis_success, error_message, analysis_start_time, analysis_end_time)
                    VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s)
                    """
                    
                    # ì‹œê°„ ë°ì´í„° ì²˜ë¦¬
                    start_time = analysis_data.get('start_time')
                    end_time = analysis_data.get('end_time')
                    if isinstance(start_time, str):
                        try:
                            start_time = datetime.fromisoformat(start_time.replace('Z', '+00:00'))
                        except:
                            start_time = None
                    if isinstance(end_time, str):
                        try:
                            end_time = datetime.fromisoformat(end_time.replace('Z', '+00:00'))
                        except:
                            end_time = None
                    
                    persona_values = (
                        analysis_id, persona_key, persona_info['name'], persona_info['role'],
                        analysis_data.get('result', ''), analysis_data.get('success', False),
                        analysis_data.get('error_message', ''), start_time, end_time
                    )
                    
                    cursor.execute(persona_sql, persona_values)
                    saved_personas += 1
            
            st.info(f"âœ… 5ë‹¨ê³„ ì„±ê³µ: {saved_personas}ê°œ í˜ë¥´ì†Œë‚˜ ë¶„ì„ ê²°ê³¼ ì €ì¥ ì™„ë£Œ")
                    
        except Exception as persona_save_error:
            st.error(f"âŒ 5ë‹¨ê³„ ì‹¤íŒ¨: í˜ë¥´ì†Œë‚˜ ë¶„ì„ ê²°ê³¼ ì €ì¥ ì˜¤ë¥˜: {str(persona_save_error)}")
            connection.rollback()
            cursor.close()
            connection.close()
            return None
        
        # 6. RAG ì†ŒìŠ¤ ì •ë³´ ì €ì¥
        try:
            saved_sources = 0
            for source_info in rag_sources_used:
                rag_sql = """
                INSERT INTO virtual_company_rag_sources
                (analysis_id, source_type, source_name, source_description, source_details, data_size, content_preview)
                VALUES (%s, %s, %s, %s, %s, %s, %s)
                """
                
                rag_values = (
                    analysis_id, source_info.get('type', ''), source_info.get('name', ''),
                    source_info.get('description', ''), json.dumps(source_info.get('details', {})),
                    source_info.get('data_size', 0), source_info.get('content_preview', '')
                )
                
                cursor.execute(rag_sql, rag_values)
                saved_sources += 1
            
            st.info(f"âœ… 6ë‹¨ê³„ ì„±ê³µ: {saved_sources}ê°œ RAG ì†ŒìŠ¤ ì •ë³´ ì €ì¥ ì™„ë£Œ")
            
        except Exception as rag_save_error:
            st.warning(f"âš ï¸ 6ë‹¨ê³„ ë¶€ë¶„ ì‹¤íŒ¨: RAG ì†ŒìŠ¤ ì •ë³´ ì €ì¥ ì˜¤ë¥˜ (ë¶„ì„ ê²°ê³¼ëŠ” ì €ì¥ë¨): {str(rag_save_error)}")
            # RAG ì •ë³´ ì €ì¥ ì‹¤íŒ¨ëŠ” ì „ì²´ ì‹¤íŒ¨ë¡œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
        
        # 7. íŠ¸ëœì­ì…˜ ì»¤ë°‹
        try:
            connection.commit()
            st.info("âœ… 7ë‹¨ê³„ ì„±ê³µ: ëª¨ë“  ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ì™„ë£Œ")
        except Exception as commit_error:
            st.error(f"âŒ 7ë‹¨ê³„ ì‹¤íŒ¨: ì»¤ë°‹ ì˜¤ë¥˜: {str(commit_error)}")
            connection.rollback()
            cursor.close()
            connection.close()
            return None
        
        cursor.close()
        connection.close()
        
        # ì„±ê³µ ë©”ì‹œì§€ëŠ” í˜¸ì¶œí•˜ëŠ” ìª½ì—ì„œ ì²˜ë¦¬í•˜ë„ë¡ ì œê±°
        return analysis_id
        
    except Exception as e:
        st.error(f"âŒ ì˜ˆìƒì¹˜ ëª»í•œ ì €ì¥ ì˜¤ë¥˜: {str(e)}")
        st.error("ğŸ”§ ë¬¸ì œ í•´ê²° ë°©ë²•:")
        st.error("1. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ í…Œì´ë¸” ìë™ ìƒì„±ì„ ì‹œë„í•˜ì„¸ìš”")
        st.error("2. DB ìƒì„± í˜ì´ì§€ì—ì„œ 'Virtual Company í…Œì´ë¸” ìƒì„±' ë©”ë‰´ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”")
        st.error("3. ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„¤ì •(.env íŒŒì¼)ì„ í™•ì¸í•˜ì„¸ìš”")
        return None

def get_virtual_company_analyses(search_term=None, model_name=None, completion_status=None, limit=50):
    """ì €ì¥ëœ Virtual Company ë¶„ì„ ê²°ê³¼ ëª©ë¡ ì¡°íšŒ"""
    try:
        connection = connect_to_db()
        if not connection:
            return []
        
        cursor = connection.cursor(dictionary=True)
        
        # ê¸°ë³¸ ì¿¼ë¦¬
        sql = """
        SELECT id, session_title, user_query, model_name, analysis_date, completion_status,
               total_personas, successful_personas, rag_sources_used, execution_time_seconds,
               tags, notes, created_at
        FROM virtual_company_analyses
        WHERE 1=1
        """
        
        params = []
        
        # ê²€ìƒ‰ ì¡°ê±´ ì¶”ê°€
        if search_term:
            sql += " AND (MATCH(session_title, user_query, tags, notes) AGAINST(%s IN NATURAL LANGUAGE MODE) OR session_title LIKE %s OR user_query LIKE %s)"
            search_pattern = f"%{search_term}%"
            params.extend([search_term, search_pattern, search_pattern])
        
        if model_name:
            sql += " AND model_name = %s"
            params.append(model_name)
        
        if completion_status:
            sql += " AND completion_status = %s"
            params.append(completion_status)
        
        sql += " ORDER BY analysis_date DESC LIMIT %s"
        params.append(limit)
        
        cursor.execute(sql, params)
        results = cursor.fetchall()
        
        cursor.close()
        connection.close()
        
        return results
        
    except Exception as e:
        st.error(f"ë¶„ì„ ê²°ê³¼ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜: {str(e)}")
        return []

def get_virtual_company_analysis_detail(analysis_id):
    """íŠ¹ì • ë¶„ì„ ê²°ê³¼ì˜ ìƒì„¸ ì •ë³´ ì¡°íšŒ"""
    try:
        connection = connect_to_db()
        if not connection:
            return None
        
        cursor = connection.cursor(dictionary=True)
        
        # ë©”ì¸ ë¶„ì„ ì •ë³´
        main_sql = "SELECT * FROM virtual_company_analyses WHERE id = %s"
        cursor.execute(main_sql, (analysis_id,))
        main_result = cursor.fetchone()
        
        if not main_result:
            return None
        
        # í˜ë¥´ì†Œë‚˜ë³„ ë¶„ì„ ê²°ê³¼
        persona_sql = """
        SELECT * FROM virtual_company_persona_analyses 
        WHERE analysis_id = %s ORDER BY persona_key
        """
        cursor.execute(persona_sql, (analysis_id,))
        persona_results = cursor.fetchall()
        
        # RAG ì†ŒìŠ¤ ì •ë³´
        rag_sql = """
        SELECT * FROM virtual_company_rag_sources 
        WHERE analysis_id = %s ORDER BY source_type, source_name
        """
        cursor.execute(rag_sql, (analysis_id,))
        rag_results = cursor.fetchall()
        
        cursor.close()
        connection.close()
        
        return {
            'main': main_result,
            'personas': persona_results,
            'rag_sources': rag_results
        }
        
    except Exception as e:
        st.error(f"ë¶„ì„ ìƒì„¸ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜: {str(e)}")
        return None

def delete_virtual_company_analysis(analysis_id):
    """Virtual Company ë¶„ì„ ê²°ê³¼ ì‚­ì œ (CASCADEë¡œ ê´€ë ¨ ë°ì´í„° ëª¨ë‘ ì‚­ì œ)"""
    try:
        connection = connect_to_db()
        if not connection:
            return False
        
        cursor = connection.cursor()
        
        # ë©”ì¸ ë¶„ì„ ì‚­ì œ (CASCADEë¡œ ê´€ë ¨ í…Œì´ë¸”ë„ ìë™ ì‚­ì œ)
        sql = "DELETE FROM virtual_company_analyses WHERE id = %s"
        cursor.execute(sql, (analysis_id,))
        
        deleted_rows = cursor.rowcount
        connection.commit()
        cursor.close()
        connection.close()
        
        return deleted_rows > 0
        
    except Exception as e:
        st.error(f"ë¶„ì„ ê²°ê³¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜: {str(e)}")
        return False

def update_virtual_company_analysis(analysis_id, session_title=None, tags=None, notes=None):
    """Virtual Company ë¶„ì„ ê²°ê³¼ ì—…ë°ì´íŠ¸ (ì œëª©, íƒœê·¸, ë©”ëª¨)"""
    try:
        connection = connect_to_db()
        if not connection:
            return False
        
        cursor = connection.cursor()
        
        update_fields = []
        params = []
        
        if session_title is not None:
            update_fields.append("session_title = %s")
            params.append(session_title)
        
        if tags is not None:
            update_fields.append("tags = %s")
            params.append(tags)
        
        if notes is not None:
            update_fields.append("notes = %s")
            params.append(notes)
        
        if not update_fields:
            return False
        
        sql = f"UPDATE virtual_company_analyses SET {', '.join(update_fields)} WHERE id = %s"
        params.append(analysis_id)
        
        cursor.execute(sql, params)
        updated_rows = cursor.rowcount
        
        connection.commit()
        cursor.close()
        connection.close()
        
        return updated_rows > 0
        
    except Exception as e:
        st.error(f"ë¶„ì„ ê²°ê³¼ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜: {str(e)}")
        return False

def get_virtual_company_analysis_statistics():
    """Virtual Company ë¶„ì„ í†µê³„ ì •ë³´ ì¡°íšŒ"""
    try:
        connection = connect_to_db()
        if not connection:
            return {}
        
        cursor = connection.cursor(dictionary=True)
        
        # ê¸°ë³¸ í†µê³„
        stats_sql = """
        SELECT 
            COUNT(*) as total_analyses,
            COUNT(CASE WHEN completion_status = 'ì™„ë£Œ' THEN 1 END) as completed_analyses,
            COUNT(CASE WHEN completion_status = 'ì˜¤ë¥˜' THEN 1 END) as failed_analyses,
            AVG(execution_time_seconds) as avg_execution_time,
            AVG(successful_personas) as avg_successful_personas,
            COUNT(DISTINCT model_name) as total_models_used
        FROM virtual_company_analyses
        """
        
        cursor.execute(stats_sql)
        basic_stats = cursor.fetchone()
        
        # ëª¨ë¸ë³„ í†µê³„
        model_sql = """
        SELECT model_name, COUNT(*) as count, AVG(execution_time_seconds) as avg_time
        FROM virtual_company_analyses 
        GROUP BY model_name ORDER BY count DESC
        """
        cursor.execute(model_sql)
        model_stats = cursor.fetchall()
        
        # ì›”ë³„ ë¶„ì„ íšŸìˆ˜
        monthly_sql = """
        SELECT DATE_FORMAT(analysis_date, '%Y-%m') as month, COUNT(*) as count
        FROM virtual_company_analyses 
        WHERE analysis_date >= DATE_SUB(NOW(), INTERVAL 12 MONTH)
        GROUP BY month ORDER BY month DESC
        """
        cursor.execute(monthly_sql)
        monthly_stats = cursor.fetchall()
        
        cursor.close()
        connection.close()
        
        return {
            'basic': basic_stats,
            'by_model': model_stats,
            'by_month': monthly_stats
        }
        
    except Exception as e:
        st.error(f"í†µê³„ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜: {str(e)}")
        return {}

# í‘¸í„°
st.markdown("---")

# ==================== ë¶„ì„ íˆìŠ¤í† ë¦¬ ê´€ë¦¬ ====================

st.markdown("## ğŸ“š ë¶„ì„ íˆìŠ¤í† ë¦¬ ê´€ë¦¬")

# íƒ­ìœ¼ë¡œ êµ¬ë¶„
history_tab1, history_tab2, history_tab3 = st.tabs(["ğŸ” ë¶„ì„ ê²°ê³¼ ê²€ìƒ‰", "ğŸ“Š í†µê³„ ëŒ€ì‹œë³´ë“œ", "âš™ï¸ ê´€ë¦¬ ë„êµ¬"])

with history_tab1:
    st.markdown("### ğŸ” ì €ì¥ëœ ë¶„ì„ ê²°ê³¼ ê²€ìƒ‰")
    
    # ê²€ìƒ‰ í•„í„°
    search_col1, search_col2, search_col3 = st.columns(3)
    
    with search_col1:
        search_term = st.text_input("ğŸ” ê²€ìƒ‰ì–´", placeholder="ì œëª©, ì§ˆë¬¸, íƒœê·¸, ë©”ëª¨ì—ì„œ ê²€ìƒ‰...", key="analysis_search")
    
    with search_col2:
        filter_model = st.selectbox("AI ëª¨ë¸ í•„í„°", ["ì „ì²´"] + available_models, key="filter_model")
        filter_model = None if filter_model == "ì „ì²´" else filter_model
    
    with search_col3:
        filter_status = st.selectbox("ì™„ë£Œ ìƒíƒœ í•„í„°", ["ì „ì²´", "ì™„ë£Œ", "ë¶€ë¶„ì™„ë£Œ", "ì˜¤ë¥˜"], key="filter_status")
        filter_status = None if filter_status == "ì „ì²´" else filter_status
    
    # ê²€ìƒ‰ ì‹¤í–‰
    if st.button("ğŸ” ê²€ìƒ‰ ì‹¤í–‰", key="search_analyses"):
        with st.spinner("ë¶„ì„ ê²°ê³¼ë¥¼ ê²€ìƒ‰ ì¤‘..."):
            analyses = get_virtual_company_analyses(
                search_term=search_term if search_term.strip() else None,
                model_name=filter_model,
                completion_status=filter_status,
                limit=50
            )
        
        st.session_state.search_results = analyses
    
    # ì €ì¥ëœ ë¶„ì„ì„ ë°”ë¡œ ë³´ê¸° ìœ„í•´ ìë™ ê²€ìƒ‰ (ì €ì¥ í›„ ì´ë™ ì‹œ)
    if 'selected_analysis_id' in st.session_state and 'search_results' not in st.session_state:
        with st.spinner("ì €ì¥ëœ ë¶„ì„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..."):
            analyses = get_virtual_company_analyses(limit=50)
            st.session_state.search_results = analyses
    
    # ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
    if 'search_results' in st.session_state:
        analyses = st.session_state.search_results
        
        if analyses:
            st.success(f"âœ… {len(analyses)}ê°œì˜ ë¶„ì„ ê²°ê³¼ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.")
            
            # ë¶„ì„ ê²°ê³¼ ëª©ë¡ í‘œì‹œ
            for analysis in analyses:
                with st.expander(f"ğŸ“‹ {analysis['session_title']} ({analysis['analysis_date'].strftime('%Y-%m-%d %H:%M')})"):
                    info_col1, info_col2, action_col = st.columns([2, 2, 1])
                    
                    with info_col1:
                        st.markdown(f"**ğŸ“ ì§ˆë¬¸/ì£¼ì œ**: {analysis['user_query'][:200]}...")
                        st.markdown(f"**ğŸ§  AI ëª¨ë¸**: {analysis['model_name']}")
                        st.markdown(f"**ğŸ“Š ìƒíƒœ**: {analysis['completion_status']}")
                        if analysis.get('tags'):
                            st.markdown(f"**ğŸ·ï¸ íƒœê·¸**: {analysis['tags']}")
                    
                    with info_col2:
                        st.markdown(f"**ğŸ‘¥ í˜ë¥´ì†Œë‚˜**: {analysis['successful_personas']}/{analysis['total_personas']}")
                        st.markdown(f"**ğŸ” RAG ì†ŒìŠ¤**: {analysis['rag_sources_used']}ê°œ")
                        if analysis.get('execution_time_seconds'):
                            st.markdown(f"**â±ï¸ ì‹¤í–‰ ì‹œê°„**: {analysis['execution_time_seconds']}ì´ˆ")
                        if analysis.get('notes'):
                            st.markdown(f"**ğŸ“ ë©”ëª¨**: {analysis['notes'][:100]}...")
                    
                    with action_col:
                        # ìƒì„¸ ë³´ê¸° ë²„íŠ¼
                        if st.button("ğŸ‘ï¸ ìƒì„¸ë³´ê¸°", key=f"view_{analysis['id']}"):
                            st.session_state.selected_analysis_id = analysis['id']
                        
                        # ì‚­ì œ ë²„íŠ¼
                        delete_key = f"delete_confirm_{analysis['id']}"
                        if delete_key in st.session_state and st.session_state[delete_key]:
                            # ì‚­ì œ í™•ì¸ ìƒíƒœ
                            delete_col1, delete_col2 = st.columns(2)
                            with delete_col1:
                                if st.button("âœ… ì‚­ì œ í™•ì¸", key=f"confirm_delete_{analysis['id']}", type="primary"):
                                    if delete_virtual_company_analysis(analysis['id']):
                                        st.success("âœ… ë¶„ì„ ê²°ê³¼ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.")
                                        # ì„¸ì…˜ ìƒíƒœ ì •ë¦¬
                                        del st.session_state[delete_key]
                                        st.rerun()
                                    else:
                                        st.error("âŒ ì‚­ì œ ì‹¤íŒ¨")
                                        del st.session_state[delete_key]
                            with delete_col2:
                                if st.button("âŒ ì·¨ì†Œ", key=f"cancel_delete_{analysis['id']}", type="secondary"):
                                    del st.session_state[delete_key]
                                    st.rerun()
                            st.warning(f"âš ï¸ ì •ë§ë¡œ '{analysis['session_title']}'ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")
                        else:
                            # ì¼ë°˜ ì‚­ì œ ë²„íŠ¼
                            if st.button("ğŸ—‘ï¸ ì‚­ì œ", key=f"delete_{analysis['id']}", help="ì´ ë¶„ì„ ê²°ê³¼ë¥¼ ì˜êµ¬ ì‚­ì œí•©ë‹ˆë‹¤"):
                                st.session_state[delete_key] = True
                                st.rerun()
        else:
            st.warning("ğŸ” ê²€ìƒ‰ ì¡°ê±´ì— ë§ëŠ” ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.")
    
    # ì„ íƒëœ ë¶„ì„ ìƒì„¸ ë³´ê¸°
    if 'selected_analysis_id' in st.session_state:
        st.markdown("---")
        st.markdown("### ğŸ“‹ ë¶„ì„ ìƒì„¸ ë‚´ìš©")
        
        detail_data = get_virtual_company_analysis_detail(st.session_state.selected_analysis_id)
        
        if detail_data:
            main_data = detail_data['main']
            persona_data = detail_data['personas']
            rag_data = detail_data['rag_sources']
            
            # ë©”ì¸ ì •ë³´ í‘œì‹œ
            st.markdown(f"## ğŸ“Š {main_data['session_title']}")
            
            detail_col1, detail_col2 = st.columns(2)
            
            with detail_col1:
                st.markdown(f"**ğŸ“ ë¶„ì„ ì£¼ì œ**: {main_data['user_query']}")
                st.markdown(f"**ğŸ“… ë¶„ì„ ì¼ì‹œ**: {main_data['analysis_date']}")
                st.markdown(f"**ğŸ§  AI ëª¨ë¸**: {main_data['model_name']}")
                st.markdown(f"**ğŸ“Š ì™„ë£Œ ìƒíƒœ**: {main_data['completion_status']}")
            
            with detail_col2:
                st.markdown(f"**ğŸ‘¥ ì„±ê³µí•œ í˜ë¥´ì†Œë‚˜**: {main_data['successful_personas']}/{main_data['total_personas']}")
                st.markdown(f"**ğŸ” RAG ì†ŒìŠ¤**: {main_data['rag_sources_used']}ê°œ")
                if main_data.get('execution_time_seconds'):
                    st.markdown(f"**â±ï¸ ì‹¤í–‰ ì‹œê°„**: {main_data['execution_time_seconds']}ì´ˆ")
                if main_data.get('tags'):
                    st.markdown(f"**ğŸ·ï¸ íƒœê·¸**: {main_data['tags']}")
            
            # ë¶„ì„ ìˆ˜ì • ê¸°ëŠ¥
            st.markdown("#### âœï¸ ë¶„ì„ ì •ë³´ ìˆ˜ì •")
            edit_col1, edit_col2 = st.columns(2)
            
            with edit_col1:
                new_title = st.text_input("ìƒˆ ì œëª©", value=main_data['session_title'], key="edit_title")
                new_tags = st.text_input("ìƒˆ íƒœê·¸", value=main_data.get('tags', ''), key="edit_tags")
            
            with edit_col2:
                new_notes = st.text_area("ìƒˆ ë©”ëª¨", value=main_data.get('notes', ''), height=100, key="edit_notes")
                
                if st.button("ğŸ’¾ ìˆ˜ì • ì €ì¥", key="save_edit"):
                    if update_virtual_company_analysis(
                        st.session_state.selected_analysis_id,
                        session_title=new_title,
                        tags=new_tags,
                        notes=new_notes
                    ):
                        st.success("âœ… ë¶„ì„ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.")
                        st.rerun()
                    else:
                        st.error("âŒ ìˆ˜ì • ì‹¤íŒ¨")
            
            # ë¶„ì„ ê²°ê³¼ í‘œì‹œ
            if main_data.get('ceo_synthesis'):
                st.markdown("#### ğŸ‘‘ CEO ìµœì¢… ì¢…í•© ë¶„ì„")
                st.markdown(main_data['ceo_synthesis'])
            
            if persona_data:
                st.markdown("#### ğŸ‘¥ ê°œë³„ ì„ì›ì§„ ë¶„ì„")
                for persona in persona_data:
                    if persona.get('analysis_result'):
                        with st.expander(f"{persona['persona_name']} ë¶„ì„"):
                            st.markdown(persona['analysis_result'])
            
            # ë¶„ì„ ì‚­ì œ ë²„íŠ¼
            st.markdown("---")
            st.markdown("#### ğŸ—‘ï¸ ë¶„ì„ ì‚­ì œ")
            st.warning("âš ï¸ ì‚­ì œëœ ë¶„ì„ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            
            detail_delete_key = f"detail_delete_confirm_{st.session_state.selected_analysis_id}"
            if detail_delete_key in st.session_state and st.session_state[detail_delete_key]:
                # ì‚­ì œ í™•ì¸ ìƒíƒœ
                detail_delete_col1, detail_delete_col2 = st.columns(2)
                with detail_delete_col1:
                    if st.button("âœ… ì˜êµ¬ ì‚­ì œ í™•ì¸", key="detail_confirm_delete", type="primary"):
                        if delete_virtual_company_analysis(st.session_state.selected_analysis_id):
                            st.success("âœ… ë¶„ì„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.")
                            del st.session_state.selected_analysis_id
                            del st.session_state[detail_delete_key]
                            st.rerun()
                        else:
                            st.error("âŒ ì‚­ì œ ì‹¤íŒ¨")
                            del st.session_state[detail_delete_key]
                with detail_delete_col2:
                    if st.button("âŒ ì·¨ì†Œ", key="detail_cancel_delete", type="secondary"):
                        del st.session_state[detail_delete_key]
                        st.rerun()
                st.error(f"âš ï¸ ì •ë§ë¡œ '{main_data['session_title']}'ë¥¼ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")
            else:
                # ì¼ë°˜ ì‚­ì œ ë²„íŠ¼
                if st.button("ğŸ—‘ï¸ ì´ ë¶„ì„ ì˜êµ¬ ì‚­ì œ", type="secondary", help="ì´ ë¶„ì„ì„ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•©ë‹ˆë‹¤"):
                    st.session_state[detail_delete_key] = True
                    st.rerun()
        else:
            st.error("âŒ ë¶„ì„ ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

with history_tab2:
    st.markdown("### ğŸ“Š í†µê³„ ëŒ€ì‹œë³´ë“œ")
    
    # í†µê³„ ì¡°íšŒ
    stats = get_virtual_company_analysis_statistics()
    
    if stats and stats.get('basic'):
        basic_stats = stats['basic']
        
        # ê¸°ë³¸ í†µê³„ í‘œì‹œ
        stat_col1, stat_col2, stat_col3, stat_col4 = st.columns(4)
        
        with stat_col1:
            st.metric("ì´ ë¶„ì„ ìˆ˜", f"{basic_stats['total_analyses']:,}")
        
        with stat_col2:
            st.metric("ì™„ë£Œëœ ë¶„ì„", f"{basic_stats['completed_analyses']:,}")
        
        with stat_col3:
            completion_rate = (basic_stats['completed_analyses'] / basic_stats['total_analyses'] * 100) if basic_stats['total_analyses'] > 0 else 0
            st.metric("ì™„ë£Œìœ¨", f"{completion_rate:.1f}%")
        
        with stat_col4:
            avg_time = basic_stats.get('avg_execution_time', 0) or 0
            st.metric("í‰ê·  ì‹¤í–‰ ì‹œê°„", f"{avg_time:.1f}ì´ˆ")
        
        # ëª¨ë¸ë³„ í†µê³„
        if stats.get('by_model'):
            st.markdown("#### ğŸ§  AI ëª¨ë¸ë³„ ì‚¬ìš© í†µê³„")
            model_data = stats['by_model']
            
            for model in model_data:
                col1, col2, col3 = st.columns([2, 1, 1])
                
                with col1:
                    st.markdown(f"**{model['model_name']}**")
                
                with col2:
                    st.markdown(f"ë¶„ì„ ìˆ˜: {model['count']}íšŒ")
                
                with col3:
                    avg_time = model.get('avg_time', 0) or 0
                    st.markdown(f"í‰ê·  ì‹œê°„: {avg_time:.1f}ì´ˆ")
        
        # ì›”ë³„ í†µê³„
        if stats.get('by_month'):
            st.markdown("#### ğŸ“… ì›”ë³„ ë¶„ì„ ì¶”ì´")
            monthly_data = stats['by_month']
            
            months = [item['month'] for item in monthly_data]
            counts = [item['count'] for item in monthly_data]
            
            # ê°„ë‹¨í•œ ì°¨íŠ¸ í‘œì‹œ (streamlitì˜ ê¸°ë³¸ ì°¨íŠ¸ ì‚¬ìš©)
            if months and counts:
                chart_data = pd.DataFrame({
                    'ì›”': months,
                    'ë¶„ì„ ìˆ˜': counts
                })
                st.line_chart(chart_data.set_index('ì›”'))
    else:
        st.info("ğŸ“Š ë¶„ì„ í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¶„ì„ ê²°ê³¼ê°€ ì—†ê±°ë‚˜ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")

with history_tab3:
    st.markdown("### âš™ï¸ ê´€ë¦¬ ë„êµ¬")
    
    # ìë™ ì €ì¥ ì‹¤íŒ¨ ì‹œ ìˆ˜ë™ ì €ì¥ ê¸°ëŠ¥
    if st.session_state.get('analysis_complete', False) and not st.session_state.get('auto_saved', False):
        st.warning("âš ï¸ ìë™ ì €ì¥ì— ì‹¤íŒ¨í•œ ë¶„ì„ ê²°ê³¼ê°€ ìˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")
        
        col1, col2 = st.columns([3, 1])
        
        with col1:
            manual_save_title = st.text_input(
                "ğŸ·ï¸ ì„¸ì…˜ ì œëª©", 
                value=f"ìˆ˜ë™ ì €ì¥ - {datetime.now().strftime('%Y%m%d_%H%M')}",
                key="manual_save_title"
            )
            manual_save_tags = st.text_input(
                "ğŸ·ï¸ íƒœê·¸", 
                value="ìˆ˜ë™ì €ì¥, ì¬ì‹œë„",
                key="manual_save_tags"
            )
            manual_save_notes = st.text_area(
                "ğŸ“ ë©”ëª¨", 
                value="ìë™ ì €ì¥ ì‹¤íŒ¨ë¡œ ì¸í•œ ìˆ˜ë™ ì €ì¥",
                height=70,
                key="manual_save_notes"
            )
        
        with col2:
            if st.button("ğŸ’¾ ìˆ˜ë™ ì €ì¥ ì‹¤í–‰", type="primary"):
                if hasattr(st.session_state, 'current_analysis') and st.session_state.current_analysis:
                    # RAG ì†ŒìŠ¤ ì •ë³´ ì¤€ë¹„
                    rag_sources_info = []
                    if hasattr(st.session_state, 'current_rag_sources'):
                        rag_sources_info = st.session_state.current_rag_sources
                    
                    # ê¸°ë³¸ê°’ ì„¤ì •
                    execution_time = st.session_state.get('execution_time', 0)
                    user_query = st.session_state.get('last_user_query', 'ìˆ˜ë™ ì €ì¥ëœ ë¶„ì„')
                    selected_model = st.session_state.get('selected_model', 'claude-3-7-sonnet-latest')
                    ceo_synthesis = st.session_state.current_analysis.get('CEO', {}).get('result', None)
                    
                    with st.spinner("ìˆ˜ë™ ì €ì¥ ì¤‘..."):
                        analysis_id = save_virtual_company_analysis_new(
                            user_query=user_query,
                            model_name=selected_model,
                            persona_analyses=st.session_state.current_analysis,
                            ceo_synthesis=ceo_synthesis,
                            rag_sources_used=rag_sources_info,
                            execution_time=execution_time,
                            session_title=manual_save_title,
                            tags=manual_save_tags,
                            notes=manual_save_notes
                        )
                    
                    if analysis_id:
                        st.success(f"âœ… ìˆ˜ë™ ì €ì¥ ì„±ê³µ! (ID: {analysis_id})")
                        st.session_state.auto_saved = True
                        st.session_state.saved_analysis_id = analysis_id
                    else:
                        st.error("âŒ ìˆ˜ë™ ì €ì¥ ì‹¤íŒ¨")
                else:
                    st.error("âŒ ì €ì¥í•  ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.")
    
    # ë°ì´í„°ë² ì´ìŠ¤ ìœ ì§€ë³´ìˆ˜
    st.markdown("---")
    st.markdown("#### ğŸ”§ ë°ì´í„°ë² ì´ìŠ¤ ìœ ì§€ë³´ìˆ˜")
    
    maintenance_col1, maintenance_col2 = st.columns(2)
    
    with maintenance_col1:
        if st.button("ğŸ“Š DB ìƒíƒœ ì²´í¬", help="ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤"):
            with st.spinner("DB ìƒíƒœ í™•ì¸ ì¤‘..."):
                db_is_connected, db_message = check_database_connection()
                if db_is_connected:
                    st.success(f"âœ… {db_message}")
                    
                    # í…Œì´ë¸”ë³„ ë ˆì½”ë“œ ìˆ˜ í™•ì¸
                    try:
                        connection = connect_to_db()
                        if connection:
                            cursor = connection.cursor()
                            
                            tables = ['virtual_company_analyses', 'virtual_company_persona_analyses', 
                                    'virtual_company_rag_sources', 'virtual_company_analysis_metrics']
                            
                            st.markdown("**í…Œì´ë¸”ë³„ ë°ì´í„° í˜„í™©:**")
                            for table in tables:
                                try:
                                    cursor.execute(f"SELECT COUNT(*) FROM {table}")
                                    count = cursor.fetchone()[0]
                                    st.markdown(f"- {table}: {count:,}ê°œ ë ˆì½”ë“œ")
                                except Exception as e:
                                    st.markdown(f"- {table}: ì¡°íšŒ ì‹¤íŒ¨ ({str(e)})")
                            
                            cursor.close()
                            connection.close()
                    except Exception as e:
                        st.warning(f"í…Œì´ë¸” ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜: {str(e)}")
                else:
                    st.error(f"âŒ {db_message}")
    
    with maintenance_col2:
        if st.button("ğŸ”„ í…Œì´ë¸” ì¬ìƒì„±", help="ëª¨ë“  í…Œì´ë¸”ì„ ì¬ìƒì„±í•©ë‹ˆë‹¤ (ê¸°ì¡´ ë°ì´í„° ìœ ì§€)"):
            with st.spinner("í…Œì´ë¸” ì¬ìƒì„± ì¤‘..."):
                try:
                    create_virtual_company_tables_if_not_exists()
                    st.success("âœ… í…Œì´ë¸” ì¬ìƒì„± ì™„ë£Œ")
                except Exception as e:
                    st.error(f"âŒ í…Œì´ë¸” ì¬ìƒì„± ì‹¤íŒ¨: {str(e)}")
    
    # completion_status ì»¬ëŸ¼ ë¬¸ì œ í•´ê²°
    st.markdown("---")
    st.markdown("#### ğŸ”§ completion_status ì»¬ëŸ¼ ë¬¸ì œ í•´ê²°")
    
    fix_col1, fix_col2 = st.columns(2)
    
    with fix_col1:
        if st.button("ğŸ” completion_status ì»¬ëŸ¼ ì •ë³´ í™•ì¸", help="í˜„ì¬ completion_status ì»¬ëŸ¼ íƒ€ì…ì„ í™•ì¸í•©ë‹ˆë‹¤"):
            try:
                connection = connect_to_db()
                if connection:
                    cursor = connection.cursor()
                    cursor.execute("DESCRIBE virtual_company_analyses completion_status")
                    column_info = cursor.fetchone()
                    
                    if column_info:
                        st.success("âœ… ì»¬ëŸ¼ ì •ë³´ ì¡°íšŒ ì„±ê³µ")
                        st.code(f"""
ì»¬ëŸ¼ëª…: {column_info[0]}
ë°ì´í„° íƒ€ì…: {column_info[1]}
NULL í—ˆìš©: {column_info[2]}
í‚¤: {column_info[3]}
ê¸°ë³¸ê°’: {column_info[4]}
Extra: {column_info[5]}
                        """)
                        
                        if 'enum' in column_info[1].lower():
                            st.warning("âš ï¸ ENUM íƒ€ì…ìœ¼ë¡œ ë˜ì–´ ìˆì–´ ë°ì´í„° ì˜ë¦¼ ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
                            st.info("ğŸ’¡ ì˜¤ë¥¸ìª½ 'ì»¬ëŸ¼ íƒ€ì… ìˆ˜ì •' ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ VARCHARë¡œ ë³€ê²½í•˜ì„¸ìš”.")
                    else:
                        st.error("âŒ completion_status ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
                    
                    cursor.close()
                    connection.close()
                else:
                    st.error("âŒ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨")
            except Exception as e:
                st.error(f"âŒ ì»¬ëŸ¼ ì •ë³´ í™•ì¸ ì‹¤íŒ¨: {str(e)}")
    
    with fix_col2:
        if st.button("ğŸ”§ completion_status ì»¬ëŸ¼ íƒ€ì… ìˆ˜ì •", help="ENUMì„ VARCHARë¡œ ë³€ê²½í•˜ì—¬ ë°ì´í„° ì˜ë¦¼ ì˜¤ë¥˜ë¥¼ í•´ê²°í•©ë‹ˆë‹¤"):
            try:
                connection = connect_to_db()
                if connection:
                    cursor = connection.cursor()
                    
                    # ë¨¼ì € í˜„ì¬ íƒ€ì… í™•ì¸
                    cursor.execute("DESCRIBE virtual_company_analyses completion_status")
                    column_info = cursor.fetchone()
                    
                    if column_info and 'enum' in column_info[1].lower():
                        # ENUMì„ VARCHARë¡œ ë³€ê²½
                        cursor.execute("ALTER TABLE virtual_company_analyses MODIFY COLUMN completion_status VARCHAR(50) DEFAULT 'ì§„í–‰ì¤‘' COMMENT 'ë¶„ì„ ì™„ë£Œ ìƒíƒœ'")
                        st.success("âœ… completion_status ì»¬ëŸ¼ì„ VARCHAR(50)ìœ¼ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤!")
                        st.info("ğŸ’¡ ì´ì œ ë°ì´í„° ì˜ë¦¼ ì˜¤ë¥˜ê°€ í•´ê²°ë©ë‹ˆë‹¤.")
                    elif column_info and 'varchar' in column_info[1].lower():
                        st.info("â„¹ï¸ ì´ë¯¸ VARCHAR íƒ€ì…ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.")
                    else:
                        st.warning("âš ï¸ completion_status ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì˜ˆìƒí•˜ì§€ ëª»í•œ íƒ€ì…ì…ë‹ˆë‹¤.")
                    
                    cursor.close()
                    connection.close()
                else:
                    st.error("âŒ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨")
            except Exception as e:
                st.error(f"âŒ ì»¬ëŸ¼ íƒ€ì… ìˆ˜ì • ì‹¤íŒ¨: {str(e)}")
    
    # ì„ì‹œ ë°ì´í„° ì •ë¦¬
    st.markdown("---")
    st.markdown("#### ğŸ§¹ ë°ì´í„° ì •ë¦¬")
    
    clean_col1, clean_col2 = st.columns(2)
    
    with clean_col1:
        st.markdown("**ì„¸ì…˜ ìƒíƒœ ì •ë¦¬**")
        if st.button("ğŸ—‘ï¸ ë¶„ì„ ì„¸ì…˜ ì´ˆê¸°í™”", help="í˜„ì¬ ë¶„ì„ ì„¸ì…˜ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤"):
            # ë¶„ì„ ê´€ë ¨ session_state ì´ˆê¸°í™”
            keys_to_remove = [
                'current_analysis', 'analysis_complete', 'analysis_saved', 
                'saved_analysis_id', 'save_timestamp', 'auto_saved', 'search_results',
                'selected_analysis_id', 'last_user_query'
            ]
            removed_count = 0
            for key in keys_to_remove:
                if key in st.session_state:
                    del st.session_state[key]
                    removed_count += 1
            
            st.success(f"âœ… {removed_count}ê°œ ì„¸ì…˜ ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ")
    
    with clean_col2:
        st.markdown("**ìºì‹œ ì •ë¦¬**")
        if st.button("ğŸ”„ Streamlit ìºì‹œ ì´ˆê¸°í™”", help="Streamlit ìºì‹œë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤"):
            st.cache_data.clear()
            st.success("âœ… ìºì‹œ ì´ˆê¸°í™” ì™„ë£Œ")

# í‘¸í„°
st.markdown("---")
st.markdown("""
<div style='text-align: center; color: #666; font-size: 0.8rem; margin-top: 30px;'>
    ğŸ’¼ Virtual Company AI Multi-Agent Analysis System<br>
    ğŸš€ ìë™ ì €ì¥ ì‹œìŠ¤í…œìœ¼ë¡œ ëª¨ë“  ë¶„ì„ ê²°ê³¼ê°€ ì•ˆì „í•˜ê²Œ ë³´ê´€ë©ë‹ˆë‹¤<br>
    ğŸ—‘ï¸ í•„ìš” ì—†ëŠ” ë¶„ì„ì€ ì–¸ì œë“  ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
</div>
""", unsafe_allow_html=True)

# 1. ê³ ê¸‰ RAG ì˜µì…˜ ì²´í¬ë°•ìŠ¤ ì¶”ê°€ (ì‚¬ì´ë“œë°” MySQL ì„¤ì • ë‚´ ì ì ˆí•œ ìœ„ì¹˜ì— ì‚½ì…)
with st.sidebar.expander("ğŸ—„ï¸ MySQL ë°ì´í„°ë² ì´ìŠ¤", expanded=True):
    # ... ê¸°ì¡´ ì½”ë“œ ...
    use_advanced_mysql_rag = st.checkbox(
        "ğŸ§  ê³ ê¸‰ RAG: LLMì´ SQL ì¿¼ë¦¬ ìƒì„±/ì‹¤í–‰",
        value=st.session_state.get('use_advanced_mysql_rag', False),
        help="LLMì´ ìì—°ì–´ ì§ˆë¬¸ì„ SQLë¡œ ë³€í™˜, DBì—ì„œ ì¿¼ë¦¬ ì‹¤í–‰ í›„ ê²°ê³¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.",
        key="use_advanced_mysql_rag"
    )
    # st.session_state.use_advanced_mysql_rag = use_advanced_mysql_rag  # ì´ ì¤„ì„ ì‚­ì œ!
    # ... ê¸°ì¡´ ì½”ë“œ ...

# 2. ê³ ê¸‰ MySQL RAG íŒŒì´í”„ë¼ì¸ í•¨ìˆ˜ ì¶”ê°€ (íŒŒì¼ ë‚´ ì ì ˆí•œ ìœ„ì¹˜ì— ì‚½ì…)


# 3. ë¶„ì„ ë²„íŠ¼ í´ë¦­ ì‹œ ê³ ê¸‰ RAG ë¶„ê¸° ì¶”ê°€ (ë¶„ì„ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬ ë‚´)
if st.button("ğŸš€ C-Level ì„ì›ì§„ ë¶„ì„ ì‹œì‘", type="primary", use_container_width=True):
    if not user_query.strip():
        st.warning("ë¶„ì„í•  ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
    else:
        # ê³ ê¸‰ MySQL RAG ë¶„ê¸°
        if 'mysql' in st.session_state.rag_sources and st.session_state.use_advanced_mysql_rag:
            selected_tables = list(st.session_state.mysql_data.keys())
            if not selected_tables:
                st.error("MySQL í…Œì´ë¸”ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            else:
                table_name = selected_tables[0]  # ì—¬ëŸ¬ ê°œë©´ ì²« ë²ˆì§¸ë§Œ ì‚¬ìš©, í™•ì¥ ê°€ëŠ¥
                schema = get_table_schema(table_name)
                sql_query = generate_sql_query(user_query, schema, selected_model)
                if not sql_query.strip().lower().startswith("select"):
                    st.error(f"LLMì´ ìƒì„±í•œ ì¿¼ë¦¬ê°€ SELECTê°€ ì•„ë‹™ë‹ˆë‹¤.\nì¿¼ë¦¬: {sql_query}")
                else:
                    st.info(f"ğŸ” LLMì´ ìƒì„±í•œ SQL ì¿¼ë¦¬:\n```sql\n{sql_query}\n```")
                    try:
                        df = run_sql_query(sql_query)
                        st.dataframe(df.head(20), use_container_width=True)
                        analysis = analyze_sql_result(user_query, sql_query, df, selected_model)
                        st.markdown("### ğŸ“Š ì¿¼ë¦¬ ê²°ê³¼ ê¸°ë°˜ ë¶„ì„")
                        st.markdown(analysis)
                    except Exception as e:
                        st.error(f"SQL ì‹¤í–‰ ì˜¤ë¥˜: {e}")
                st.markdown("---")
                st.info("ê³ ê¸‰ RAG ëª¨ë“œ ê²°ê³¼ì…ë‹ˆë‹¤. ì•„ë˜ëŠ” ê¸°ì¡´ ì „ì²´ ë¶„ì„ í”Œë¡œìš°ì…ë‹ˆë‹¤.")
        # ... ê¸°ì¡´ ì „ì²´ ë¶„ì„ í”Œë¡œìš°(ë™ì‹œ í˜ë¥´ì†Œë‚˜ ë¶„ì„ ë“±) ì´ì–´ì„œ ì‹¤í–‰ ...