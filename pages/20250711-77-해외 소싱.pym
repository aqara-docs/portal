import streamlit as st
import os
import pandas as pd
import mysql.connector
from datetime import datetime, timedelta
import time
import re
import json
import requests
from dotenv import load_dotenv
import concurrent.futures
import threading
import asyncio
import io
from functools import lru_cache
import urllib.parse

# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

# í™˜ê²½ ë³€ìˆ˜ ê°•ì œ ì¬ë¡œë“œ (ë””ë²„ê¹…ìš©)
from pathlib import Path
env_path = Path('.') / '.env'
if env_path.exists():
    load_dotenv(env_path, override=True)

# API í‚¤ ì •ë¦¬ í•¨ìˆ˜
def clean_api_key(api_key):
    """API í‚¤ì—ì„œ ë”°ì˜´í‘œì™€ ê³µë°± ì œê±°"""
    if not api_key:
        return None
    
    # ë”°ì˜´í‘œ ì œê±°
    api_key = api_key.strip().strip("'").strip('"')
    
    # ê³µë°± ì œê±°
    api_key = api_key.strip()
    
    return api_key if api_key else None

def get_perplexity_models(api_key):
    """Perplexity APIì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°"""
    try:
        # Perplexity APIì˜ ì‹¤ì œ ëª¨ë¸ ëª©ë¡ (2024ë…„ ê¸°ì¤€)
        # https://docs.perplexity.ai/guides/model-cards
        current_models = [
            "sonar-pro",
            "sonar-medium-online",
            "sonar-small-online",
            "llama-3.1-sonar-small-128k-online",
            "llama-3.1-sonar-medium-128k-online", 
            "llama-3.1-sonar-large-128k-online",
            "llama-3.1-sonar-small-128k",
            "llama-3.1-sonar-medium-128k",
            "llama-3.1-sonar-large-128k"
        ]
        
        return current_models
            
    except Exception as e:
        return []
    
    return []

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(
    page_title="ğŸ” AI ì œí’ˆ ì†Œì‹± ì‹œìŠ¤í…œ",
    page_icon="ğŸ”",
    layout="wide",
    initial_sidebar_state="expanded"
)

# CSS ìŠ¤íƒ€ì¼ë§
st.markdown("""
<style>
.main-header {
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    padding: 1rem;
    border-radius: 10px;
    text-align: center;
    color: white;
    margin-bottom: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.metric-container {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    border-left: 4px solid #667eea;
    margin: 0.5rem 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.agent-card {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    padding: 1rem;
    border-radius: 10px;
    margin: 0.5rem 0;
    border: 1px solid #e1e5e9;
}

.supplier-card {
    background: white;
    border: 1px solid #e1e5e9;
    border-radius: 8px;
    padding: 1rem;
    margin: 0.5rem 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.search-result {
    background: #f8f9fa;
    border-left: 4px solid #28a745;
    padding: 1rem;
    margin: 0.5rem 0;
    border-radius: 4px;
}
</style>
""", unsafe_allow_html=True)

# ë©”ì¸ í—¤ë”
st.markdown("""
<div class="main-header">
    <h1>ğŸ” AI ì œí’ˆ ì†Œì‹± ì‹œìŠ¤í…œ</h1>
    <p>ì‹¤ì‹œê°„ ì›¹ ê²€ìƒ‰ ê¸°ë°˜ ì œí’ˆëª…, ì œì¡°ì‚¬ëª…, í‚¤ì›Œë“œ ê²€ìƒ‰ ì‹œìŠ¤í…œ</p>
    ğŸ’¡ Perplexity APIë¥¼ í™œìš©í•œ ì •í™•í•œ ì œí’ˆ ì†Œì‹± ë° SCM ì •ë³´ ê´€ë¦¬
</div>
""", unsafe_allow_html=True) 

# ì¸ì¦ ê¸°ëŠ¥ (ê°„ë‹¨í•œ ë¹„ë°€ë²ˆí˜¸ ë³´í˜¸)
if 'authenticated' not in st.session_state:
    st.session_state.authenticated = False

admin_pw = os.getenv('ADMIN_PASSWORD')
if not admin_pw:
    st.error('í™˜ê²½ë³€ìˆ˜(ADMIN_PASSWORD)ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. .env íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.')
    st.stop()

if not st.session_state.authenticated:
    password = st.text_input("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”", type="password")
    if password == admin_pw:
        st.session_state.authenticated = True
        st.rerun()
    else:
        if password:  # ë¹„ë°€ë²ˆí˜¸ê°€ ì…ë ¥ëœ ê²½ìš°ì—ë§Œ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
            st.error("ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤")
        st.stop()

# ===== ê°œì„ ëœ ì†Œì‹± í•¨ìˆ˜ë“¤ =====

def generate_smart_search_queries(product_description, target_count=5):
    """ì œí’ˆëª…, ì œì¡°ì‚¬ëª…, í‚¤ì›Œë“œë¥¼ ë°”íƒ•ìœ¼ë¡œ ìŠ¤ë§ˆíŠ¸ ê²€ìƒ‰ ì¿¼ë¦¬ ìƒì„±"""
    queries = []
    
    # ì…ë ¥ í…ìŠ¤íŠ¸ ì •ë¦¬
    search_text = product_description.strip()
    
    # ê¸°ë³¸ ê²€ìƒ‰ íŒ¨í„´ë“¤ (ì œí’ˆëª…, ì œì¡°ì‚¬ëª…, í‚¤ì›Œë“œ ëª¨ë‘ í¬í•¨)
    search_patterns = [
        f'"{search_text}" manufacturer supplier',
        f'"{search_text}" factory production',
        f'"{search_text}" OEM ODM manufacturer',
        f'"{search_text}" wholesale supplier',
        f'"{search_text}" manufacturer directory',
        f'"{search_text}" manufacturing company',
        f'"{search_text}" supplier list',
        f'"{search_text}" factory China',
        f'"{search_text}" manufacturer Vietnam',
        f'"{search_text}" supplier Korea',
        f'"{search_text}" company information',
        f'"{search_text}" business directory',
        f'"{search_text}" industrial supplier'
    ]
    
    # ì œí’ˆ í‚¤ì›Œë“œ ì¶”ì¶œ
    keywords = extract_product_keywords(search_text)
    
    # í‚¤ì›Œë“œ ê¸°ë°˜ ì¶”ê°€ ì¿¼ë¦¬
    for keyword in keywords[:3]:  # ìƒìœ„ 3ê°œ í‚¤ì›Œë“œë§Œ ì‚¬ìš©
        queries.extend([
            f'"{keyword}" manufacturer supplier',
            f'"{keyword}" factory production',
            f'"{keyword}" OEM manufacturer',
            f'"{keyword}" company directory',
            f'"{keyword}" industrial supplier'
        ])
    
    # ìœ ì‚¬ ì œí’ˆëª… ìƒì„± (ì œí’ˆëª…ì´ í¬í•¨ëœ ê²½ìš°)
    similar_products = generate_similar_product_queries(search_text)
    queries.extend(similar_products)
    
    # ê¸°ë³¸ íŒ¨í„´ê³¼ í‚¤ì›Œë“œ ì¿¼ë¦¬ ê²°í•©
    all_queries = search_patterns + queries
    
    # ì¤‘ë³µ ì œê±° ë° ìˆœì„œ ì„ê¸°
    unique_queries = list(dict.fromkeys(all_queries))
    
    return unique_queries[:target_count]

def generate_similar_product_queries(search_text):
    """ìœ ì‚¬ ì œí’ˆëª… ì¿¼ë¦¬ ìƒì„±"""
    similar_queries = []
    
    # ì œí’ˆëª… ë§¤í•‘ (ìœ ì‚¬ ì œí’ˆë“¤)
    product_mappings = {
        'iphone': ['smartphone', 'mobile phone', 'cell phone', 'galaxy', 'android phone'],
        'galaxy': ['smartphone', 'mobile phone', 'cell phone', 'iphone', 'android phone'],
        'smartphone': ['mobile phone', 'cell phone', 'iphone', 'galaxy', 'android phone'],
        'led': ['lighting', 'light', 'bulb', 'lamp', 'illumination'],
        'lighting': ['led', 'light', 'bulb', 'lamp', 'illumination'],
        'wireless': ['bluetooth', 'wifi', 'cordless', 'remote'],
        'bluetooth': ['wireless', 'audio', 'speaker', 'headphone'],
        'speaker': ['audio', 'sound', 'bluetooth speaker', 'wireless speaker'],
        'case': ['cover', 'protector', 'shell', 'housing'],
        'cover': ['case', 'protector', 'shell', 'housing'],
        'charger': ['charging', 'power supply', 'adapter', 'cable'],
        'cable': ['wire', 'cord', 'connector', 'charger'],
        'sensor': ['detector', 'monitor', 'meter', 'gauge'],
        'motor': ['engine', 'actuator', 'driver', 'controller'],
        'battery': ['power', 'energy', 'cell', 'accumulator'],
        'display': ['screen', 'monitor', 'panel', 'lcd', 'oled'],
        'screen': ['display', 'monitor', 'panel', 'lcd', 'oled']
    }
    
    # ê²€ìƒ‰ í…ìŠ¤íŠ¸ì—ì„œ ì œí’ˆëª… ì°¾ê¸°
    search_lower = search_text.lower()
    for product, similar_products in product_mappings.items():
        if product in search_lower:
            for similar in similar_products[:2]:  # ìƒìœ„ 2ê°œë§Œ ì‚¬ìš©
                similar_queries.extend([
                    f'"{similar}" manufacturer supplier',
                    f'"{similar}" factory production',
                    f'"{similar}" OEM manufacturer'
                ])
    
    return similar_queries

def extract_product_keywords(description):
    """ì œí’ˆ ì„¤ëª…ì—ì„œ í•µì‹¬ í‚¤ì›Œë“œ ì¶”ì¶œ"""
    # ë¶ˆìš©ì–´ ì œê±°
    stop_words = {'the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'is', 'are', 'was', 'were', 'be', 'been', 'being', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could', 'should', 'may', 'might', 'must', 'can', 'this', 'that', 'these', 'those', 'i', 'you', 'he', 'she', 'it', 'we', 'they', 'me', 'him', 'her', 'us', 'them', 'my', 'your', 'his', 'her', 'its', 'our', 'their', 'mine', 'yours', 'his', 'hers', 'ours', 'theirs'}
    
    # í…ìŠ¤íŠ¸ ì •ë¦¬
    text = re.sub(r'[^\w\s]', ' ', description.lower())
    words = text.split()
    
    # ë¶ˆìš©ì–´ ì œê±° ë° ê¸¸ì´ í•„í„°ë§
    keywords = [word for word in words if word not in stop_words and len(word) > 2]
    
    # ë¹ˆë„ ê¸°ë°˜ ì •ë ¬ (ê°„ë‹¨í•œ êµ¬í˜„)
    word_freq = {}
    for word in keywords:
        word_freq[word] = word_freq.get(word, 0) + 1
    
    # ë¹ˆë„ìˆœ ì •ë ¬
    sorted_keywords = sorted(word_freq.items(), key=lambda x: x[1], reverse=True)
    
    return [word for word, freq in sorted_keywords[:5]]  # ìƒìœ„ 5ê°œ í‚¤ì›Œë“œ

def verify_perplexity_api_key(api_key):
    """Perplexity API í‚¤ ê²€ì¦ (ê°œì„ ëœ ë²„ì „)"""
    try:
        # API í‚¤ í˜•ì‹ ê²€ì¦
        if not api_key or not api_key.strip():
            return False, "API í‚¤ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤."
        
        api_key = api_key.strip()
        
        # pplx- ì ‘ë‘ì‚¬ í™•ì¸
        if not api_key.startswith('pplx-'):
            return False, f"API í‚¤ê°€ 'pplx-'ë¡œ ì‹œì‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í˜„ì¬: {api_key[:10]}..."
        
        # í‚¤ ê¸¸ì´ í™•ì¸ (pplx- + ìµœì†Œ 20ì)
        if len(api_key) < 25:
            return False, f"API í‚¤ê°€ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤. ê¸¸ì´: {len(api_key)}"
        
        try:
            from openai import OpenAI
            
            # Perplexity API í´ë¼ì´ì–¸íŠ¸ ìƒì„±
            client = OpenAI(
                api_key=api_key,
                base_url="https://api.perplexity.ai"
            )
            
            # í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€
            messages = [
                {
                    "role": "system",
                    "content": "You are a helpful assistant."
                },
                {
                    "role": "user", 
                    "content": "Hello"
                }
            ]
            
            # ì—¬ëŸ¬ ëª¨ë¸ë¡œ í…ŒìŠ¤íŠ¸
            test_models = ["sonar-pro", "sonar-medium-online", "sonar-small-online"]
            
            for test_model in test_models:
                try:
                    response = client.chat.completions.create(
                        model=test_model,
                        messages=messages,
                        max_tokens=10,
                        temperature=0.1
                    )
                    
                    return True, f"API í‚¤ê°€ ìœ íš¨í•©ë‹ˆë‹¤. (ì‘ë™ ëª¨ë¸: {test_model})"
                    
                except Exception as e:
                    error_msg = str(e)
                    
                    if "Invalid model" in error_msg or "model not found" in error_msg.lower():
                        continue  # ë‹¤ìŒ ëª¨ë¸ ì‹œë„
                    elif "authentication" in error_msg.lower() or "unauthorized" in error_msg.lower():
                        return False, "API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (ì¸ì¦ ì‹¤íŒ¨)"
                    elif "rate limit" in error_msg.lower() or "quota" in error_msg.lower():
                        return False, "API ìš”ì²­ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤."
                    else:
                        continue  # ë‹¤ë¥¸ ì˜¤ë¥˜ëŠ” ë‹¤ìŒ ëª¨ë¸ ì‹œë„
            
            # ëª¨ë“  ëª¨ë¸ì—ì„œ ì‹¤íŒ¨í•œ ê²½ìš°
            return False, "ëª¨ë“  í…ŒìŠ¤íŠ¸ ëª¨ë¸ì—ì„œ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
            
        except ImportError:
            return False, "OpenAI ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. 'pip install openai'ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”."
        except Exception as e:
            return False, f"OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì˜¤ë¥˜: {str(e)}"
            
    except requests.exceptions.Timeout:
        return False, "API ìš”ì²­ ì‹œê°„ ì´ˆê³¼"
    except requests.exceptions.ConnectionError:
        return False, "ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì˜¤ë¥˜"
    except Exception as e:
        return False, f"API í‚¤ ê²€ì¦ ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜: {str(e)}"

def search_manufacturers_with_perplexity(product_description, max_results=15, query_count=3):
    """Perplexity APIë¥¼ ì‚¬ìš©í•œ ì œì¡°ì‚¬ ê²€ìƒ‰ (ê°œì„ ëœ ë²„ì „)"""
    try:
        raw_api_key = os.environ.get('PERPLEXITY_API_KEY')
        api_key = clean_api_key(raw_api_key)
        
        if not api_key:
            st.error("âŒ PERPLEXITY_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            if raw_api_key:
                st.caption(f"ì›ë³¸ í‚¤: '{raw_api_key[:30]}...' (ì •ë¦¬ í•„ìš”)")
            return []
        
        # API í‚¤ ê²€ì¦
        is_valid, message = verify_perplexity_api_key(api_key)
        
        if not is_valid:
            st.error(f"âŒ API í‚¤ ê²€ì¦ ì‹¤íŒ¨: {message}")
            return []
        
        st.success("âœ… API í‚¤ ê²€ì¦ ì™„ë£Œ")
        
        # ìŠ¤ë§ˆíŠ¸ ê²€ìƒ‰ ì¿¼ë¦¬ ìƒì„± (ì¿¼ë¦¬ ìˆ˜ ë°˜ì˜)
        search_queries = generate_smart_search_queries(product_description, target_count=query_count)
        
        all_suppliers = []
        
        for i, query in enumerate(search_queries):
            try:
                suppliers = execute_single_search(query, api_key, max_results_per_query=5)
                if suppliers:
                    all_suppliers.extend(suppliers)
                    
                    # ì¤‘ë³µ ì œê±°
                    unique_suppliers = remove_duplicate_suppliers(all_suppliers)
                    all_suppliers = unique_suppliers
                    
                    st.success(f"âœ… ì¿¼ë¦¬ {i+1}ì—ì„œ {len(suppliers)}ê°œ ê³µê¸‰ì—…ì²´ ë°œê²¬ (ì´ {len(all_suppliers)}ê°œ)")
                
                # ì ì‹œ ëŒ€ê¸° (API ì œí•œ ë°©ì§€)
                time.sleep(2)
                
            except Exception as e:
                st.warning(f"âš ï¸ ì¿¼ë¦¬ {i+1} ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜: {str(e)}")
                continue
        
        return all_suppliers[:max_results]
        
    except Exception as e:
        st.error(f"âŒ ì œì¡°ì‚¬ ê²€ìƒ‰ ì˜¤ë¥˜: {str(e)}")
        return []

def execute_single_search(query, api_key, max_results_per_query=5):
    """ë‹¨ì¼ ê²€ìƒ‰ ì¿¼ë¦¬ ì‹¤í–‰ (OpenAI í´ë¼ì´ì–¸íŠ¸ ì‚¬ìš©)"""
    try:
        from openai import OpenAI
        
        # Perplexity API í´ë¼ì´ì–¸íŠ¸ ìƒì„±
        client = OpenAI(
            api_key=api_key,
            base_url="https://api.perplexity.ai"
        )
        
        # ë” êµ¬ì²´ì ì´ê³  íš¨ê³¼ì ì¸ í”„ë¡¬í”„íŠ¸ (ì œí’ˆëª…, ì œì¡°ì‚¬ëª…, í‚¤ì›Œë“œ ëª¨ë‘ ì§€ì›)
        search_prompt = f"""
You are a professional sourcing agent. Find {max_results_per_query} REAL manufacturing companies for: {query}

CRITICAL REQUIREMENTS:
1. Only find ACTUAL manufacturers, not distributors or trading companies
2. Each company must have a working website
3. Focus on companies that actually produce the requested product or related products
4. Include companies from China, Vietnam, Korea, Taiwan, and other manufacturing countries
5. Search for both the exact term and related/similar products/companies

SEARCH SCOPE:
- If searching for a product name: Find manufacturers of that product and similar products
- If searching for a company name: Find that company and similar companies in the same industry
- If searching for a keyword: Find manufacturers related to that technology/field
- Include OEM/ODM companies that can manufacture similar products

For each company, provide information in this EXACT format (copy this format exactly):

COMPANY: [Full Company Name]
WEBSITE: [Complete website URL with http:// or https://]
EMAIL: [Contact email address]
PHONE: [Phone number]
LOCATION: [City, Country]
SPECIALIZATION: [What they manufacture]
COMPANY_TYPE: [Manufacturer/OEM/ODM]
ESTABLISHED: [Year established]
CERTIFICATIONS: [ISO, CE, RoHS, etc.]

EXAMPLE FORMAT:
COMPANY: ABC Electronics Manufacturing Co., Ltd.
WEBSITE: https://www.abcelectronics.com
EMAIL: sales@abcelectronics.com
PHONE: +86-755-1234-5678
LOCATION: Shenzhen, China
SPECIALIZATION: Electronic components and PCB manufacturing
COMPANY_TYPE: Manufacturer
ESTABLISHED: 2010
CERTIFICATIONS: ISO 9001, CE, RoHS

IMPORTANT: 
- Do not include companies without websites
- Do not include companies that are clearly just trading companies
- Focus on companies that actually manufacture the requested product or related products
- Provide real, verifiable information
- Include both exact matches and related manufacturers
"""
        
        # ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ë“¤
        test_models = ["sonar-pro", "sonar-medium-online", "sonar-small-online"]
        
        # ê° ëª¨ë¸ë¡œ ì‹œë„
        for model in test_models:
            try:
                response = client.chat.completions.create(
                    model=model,
                    messages=[{"role": "user", "content": search_prompt}],
                    max_tokens=4000,
                    temperature=0.2
                )
                
                content = response.choices[0].message.content
                
                # ì‘ë‹µ íŒŒì‹±
                suppliers = parse_manufacturer_response(content)
                
                if suppliers:
                    return suppliers
                
            except Exception as e:
                error_msg = str(e)
                
                if "Invalid model" in error_msg or "model not found" in error_msg.lower():
                    continue  # ë‹¤ìŒ ëª¨ë¸ ì‹œë„
                elif "authentication" in error_msg.lower() or "unauthorized" in error_msg.lower():
                    st.error("âŒ API í‚¤ ì¸ì¦ ì‹¤íŒ¨")
                    return []
                elif "rate limit" in error_msg.lower() or "quota" in error_msg.lower():
                    st.error("âŒ API ìš”ì²­ í•œë„ ì´ˆê³¼")
                    return []
                else:
                    continue  # ë‹¤ë¥¸ ì˜¤ë¥˜ëŠ” ë‹¤ìŒ ëª¨ë¸ ì‹œë„
        
        # ëª¨ë“  ëª¨ë¸ì—ì„œ ì‹¤íŒ¨í•œ ê²½ìš°
        return []
        
    except ImportError:
        st.error("âŒ OpenAI ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. 'pip install openai'ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.")
        return []
    except Exception as e:
        st.error(f"âŒ ê²€ìƒ‰ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜: {str(e)}")
        return []

def parse_manufacturer_response(raw_text):
    """ì œì¡°ì‚¬ ì‘ë‹µ íŒŒì‹± (ê°œì„ ëœ ë²„ì „)"""
    suppliers = []
    
    try:
        # ë” ìœ ì—°í•œ íŒ¨í„´ ë§¤ì¹­
        patterns = [
            # ì™„ì „í•œ í˜•ì‹
            r'COMPANY:\s*([^\n]+)\s*\nWEBSITE:\s*([^\n]+)\s*\nEMAIL:\s*([^\n]+)\s*\nPHONE:\s*([^\n]+)\s*\nLOCATION:\s*([^\n]+)\s*\nSPECIALIZATION:\s*([^\n]+)\s*\nCOMPANY_TYPE:\s*([^\n]+)\s*\nESTABLISHED:\s*([^\n]+)\s*\nCERTIFICATIONS:\s*([^\n]+)',
            # ê¸°ë³¸ í˜•ì‹
            r'COMPANY:\s*([^\n]+)\s*\nWEBSITE:\s*([^\n]+)\s*\nEMAIL:\s*([^\n]+)\s*\nPHONE:\s*([^\n]+)\s*\nLOCATION:\s*([^\n]+)\s*\nSPECIALIZATION:\s*([^\n]+)',
            # ìµœì†Œ í˜•ì‹
            r'COMPANY:\s*([^\n]+)\s*\nWEBSITE:\s*([^\n]+)\s*\nEMAIL:\s*([^\n]+)\s*\nPHONE:\s*([^\n]+)\s*\nLOCATION:\s*([^\n]+)',
            # íšŒì‚¬ëª…ê³¼ ì›¹ì‚¬ì´íŠ¸ë§Œ
            r'COMPANY:\s*([^\n]+)\s*\nWEBSITE:\s*([^\n]+)'
        ]
        
        for pattern in patterns:
            matches = re.findall(pattern, raw_text, re.MULTILINE | re.IGNORECASE)
            
            for match in matches:
                supplier = {}
                
                if len(match) >= 2:
                    supplier['company_name'] = match[0].strip()
                    supplier['website'] = clean_url(match[1].strip())
                    
                    if len(match) > 2:
                        supplier['email'] = clean_email(match[2].strip())
                    if len(match) > 3:
                        supplier['phone'] = match[3].strip()
                    if len(match) > 4:
                        supplier['location'] = match[4].strip()
                    if len(match) > 5:
                        supplier['specialization'] = match[5].strip()
                    if len(match) > 6:
                        supplier['company_type'] = match[6].strip()
                    if len(match) > 7:
                        supplier['established'] = match[7].strip()
                    if len(match) > 8:
                        supplier['certifications'] = match[8].strip()
                    
                    # ê¸°ë³¸ê°’ ì„¤ì •
                    supplier.setdefault('email', '')
                    supplier.setdefault('phone', '')
                    supplier.setdefault('location', 'Unknown')
                    supplier.setdefault('specialization', 'Manufacturing')
                    supplier.setdefault('company_type', 'Manufacturer')
                    supplier.setdefault('established', 'Unknown')
                    supplier.setdefault('certifications', 'Not specified')
                    
                    # ìœ íš¨ì„± ê²€ì‚¬
                    if is_valid_supplier(supplier):
                        suppliers.append(supplier)
        
        # êµ¬ì¡°í™”ëœ íŒŒì‹±ì´ ì‹¤íŒ¨í•œ ê²½ìš°, í…ìŠ¤íŠ¸ì—ì„œ ì •ë³´ ì¶”ì¶œ
        if not suppliers:
            suppliers = extract_suppliers_from_text(raw_text)
        
        return suppliers
        
    except Exception as e:
        return []

def extract_suppliers_from_text(text):
    """í…ìŠ¤íŠ¸ì—ì„œ ê³µê¸‰ì—…ì²´ ì •ë³´ ì¶”ì¶œ (ë°±ì—… ë°©ë²•)"""
    suppliers = []
    
    try:
        # íšŒì‚¬ëª… íŒ¨í„´ ì°¾ê¸° (ë” í¬ê´„ì )
        company_patterns = [
            r'([A-Z][A-Za-z\s&.,]+(?:Ltd|Limited|Inc|Corp|Corporation|Company|Co|Manufacturing|Factory|Industries|Electronics|Technology|Industrial))',
            r'([A-Z][A-Za-z\s&.,]+(?:Group|International|Global|Trading|Manufacturing))',
            r'([A-Z][A-Za-z\s&.,]+(?:Co\.|Ltd\.|Inc\.|Corp\.))',
            r'([A-Z][A-Za-z\s&.,]+(?:Manufacturing|Factory|Industries))'
        ]
        
        # ì›¹ì‚¬ì´íŠ¸ íŒ¨í„´
        website_pattern = r'https?://[^\s\)\]\},;]+'
        
        # ì´ë©”ì¼ íŒ¨í„´
        email_pattern = r'\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b'
        
        # ì „í™”ë²ˆí˜¸ íŒ¨í„´
        phone_pattern = r'[\+]?[0-9\s\-\(\)]{7,}'
        
        # ìœ„ì¹˜ íŒ¨í„´
        location_pattern = r'([A-Z][a-z]+,\s*[A-Z][a-z]+|[A-Z][a-z]+,\s*[A-Z]{2,3})'
        
        lines = text.split('\n')
        
        current_supplier = {}
        
        for line in lines:
            line = line.strip()
            if not line:
                continue
            
            # íšŒì‚¬ëª… ì°¾ê¸°
            for pattern in company_patterns:
                match = re.search(pattern, line)
                if match:
                    company_name = match.group(1).strip()
                    # ì´ì „ ê³µê¸‰ì—…ì²´ê°€ ì™„ì„±ë˜ë©´ ì €ì¥
                    if current_supplier and current_supplier.get('company_name'):
                        if is_valid_supplier(current_supplier):
                            suppliers.append(current_supplier.copy())
                    # ìƒˆ ê³µê¸‰ì—…ì²´ ì‹œì‘
                    current_supplier = {'company_name': company_name}
                    break
            
            # ì›¹ì‚¬ì´íŠ¸ ì°¾ê¸°
            website_match = re.search(website_pattern, line)
            if website_match:
                current_supplier['website'] = clean_url(website_match.group(0))
            
            # ì´ë©”ì¼ ì°¾ê¸°
            email_match = re.search(email_pattern, line)
            if email_match:
                current_supplier['email'] = email_match.group(0)
            
            # ì „í™”ë²ˆí˜¸ ì°¾ê¸°
            phone_match = re.search(phone_pattern, line)
            if phone_match:
                current_supplier['phone'] = phone_match.group(0)
            
            # ìœ„ì¹˜ ì°¾ê¸°
            location_match = re.search(location_pattern, line)
            if location_match:
                current_supplier['location'] = location_match.group(1)
        
        # ë§ˆì§€ë§‰ ê³µê¸‰ì—…ì²´ ì²˜ë¦¬
        if current_supplier and current_supplier.get('company_name'):
            if is_valid_supplier(current_supplier):
                suppliers.append(current_supplier)
        
        # ê¸°ë³¸ê°’ ì„¤ì •
        for supplier in suppliers:
            supplier.setdefault('email', '')
            supplier.setdefault('phone', '')
            supplier.setdefault('location', 'Unknown')
            supplier.setdefault('specialization', 'Manufacturing')
            supplier.setdefault('company_type', 'Manufacturer')
            supplier.setdefault('established', 'Unknown')
            supplier.setdefault('certifications', 'Not specified')
        
        return suppliers
        
    except Exception as e:
        st.error(f"âŒ í…ìŠ¤íŠ¸ ì¶”ì¶œ ì˜¤ë¥˜: {str(e)}")
        return []

def clean_url(url):
    if not url:
        return ""
    # ë§ˆí¬ë‹¤ìš´ ë§í¬ íŒ¨í„´ ì²˜ë¦¬ (í…ìŠ¤íŠ¸ê°€ URLì¸ ê²½ìš°ë„ í¬í•¨)
    markdown_pattern = r'\[([^\]]+)\]\((https?://[^\s\)]+)\)'
    markdown_match = re.search(markdown_pattern, url)
    if markdown_match:
        url = markdown_match.group(2)
    # ê´„í˜¸, ê³µë°±, íŠ¹ìˆ˜ë¬¸ì ë“± ëë¶€ë¶„ ì •ë¦¬
    url = url.strip().split(' ')[0]
    url = re.sub(r'[)\]\},;]+$', '', url)
    # ê´„í˜¸ê°€ ë‚¨ì•„ìˆëŠ” ê²½ìš° ì œê±°
    url = url.split('(')[0]
    # http/https ë³´ì •
    if url and not url.startswith(('http://', 'https://')):
        if url.startswith('www.'):
            url = f"https://{url}"
        elif '.' in url:
            url = f"https://{url}"
    # URL ì¸ì½”ë”© ì •ë¦¬
    url = urllib.parse.unquote(url)
    return url

def clean_email(email):
    """ì´ë©”ì¼ ì •ë¦¬"""
    if not email:
        return ""
    
    # ì´ë©”ì¼ íŒ¨í„´ìœ¼ë¡œ ê²€ì¦
    email_pattern = r'\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b'
    match = re.search(email_pattern, email)
    return match.group(0) if match else ""

def is_valid_supplier(supplier):
    """ê³µê¸‰ì—…ì²´ ì •ë³´ ìœ íš¨ì„± ê²€ì‚¬ (ê°œì„ ëœ ë²„ì „)"""
    # ìµœì†Œí•œ íšŒì‚¬ëª…ì´ ìˆì–´ì•¼ í•¨
    if not supplier.get('company_name'):
        return False
    
    # íšŒì‚¬ëª…ì´ ë„ˆë¬´ ì§§ìœ¼ë©´ ì œì™¸
    if len(supplier.get('company_name', '')) < 3:
        return False
    
    # ì›¹ì‚¬ì´íŠ¸ë‚˜ ì´ë©”ì¼ ì¤‘ í•˜ë‚˜ëŠ” ìˆì–´ì•¼ í•¨ (ë” ìœ ì—°í•˜ê²Œ)
    if not supplier.get('website') and not supplier.get('email'):
        return False
    
    # ëª…ë°±íˆ ì˜ëª»ëœ íšŒì‚¬ëª… ì œì™¸
    invalid_names = ['unknown', 'n/a', 'none', 'example', 'sample', 'test']
    company_name_lower = supplier.get('company_name', '').lower()
    if any(invalid in company_name_lower for invalid in invalid_names):
        return False
    
    return True

def remove_duplicate_suppliers(suppliers):
    """ì¤‘ë³µ ê³µê¸‰ì—…ì²´ ì œê±°"""
    seen = set()
    unique_suppliers = []
    
    for supplier in suppliers:
        # íšŒì‚¬ëª…ê³¼ ì›¹ì‚¬ì´íŠ¸ë¡œ ì¤‘ë³µ íŒë‹¨
        key = f"{supplier.get('company_name', '').lower()}_{supplier.get('website', '').lower()}"
        
        if key not in seen:
            seen.add(key)
            unique_suppliers.append(supplier)
    
    return unique_suppliers

def verify_supplier_website(website):
    """ê³µê¸‰ì—…ì²´ ì›¹ì‚¬ì´íŠ¸ ê²€ì¦ (ê°•í™”ëœ ë²„ì „)"""
    if not website:
        return False
    try:
        import requests
        headers = {
            "User-Agent": (
                "Mozilla/5.0 (Windows NT 10.0; Win64; x64) "
                "AppleWebKit/537.36 (KHTML, like Gecko) "
                "Chrome/122.0.0.0 Safari/537.36"
            )
        }
        response = requests.get(
            website,
            headers=headers,
            timeout=7,
            allow_redirects=True,
            verify=False  # SSL ì¸ì¦ì„œ ì˜¤ë¥˜ ë¬´ì‹œ (í•„ìš”ì‹œ)
        )
        # 200~399ê¹Œì§€ëŠ” ì„±ê³µìœ¼ë¡œ ê°„ì£¼
        return 200 <= response.status_code < 400
    except Exception:
        return False

def save_suppliers_to_database(suppliers, search_query, session_id):
    """ê³µê¸‰ì—…ì²´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ (ê¸°ì¡´ ë°ì´í„°ëŠ” ì‚­ì œí•˜ì§€ ì•ŠìŒ)"""
    try:
        connection = connect_to_db()
        if not connection:
            st.error("âŒ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨")
            return 0
        cursor = connection.cursor()
        # í…Œì´ë¸”ì´ ì—†ìœ¼ë©´ ìƒì„± (ê¸°ì¡´ ë°ì´í„°ëŠ” ì‚­ì œí•˜ì§€ ì•ŠìŒ)
        try:
            cursor.execute("""
                CREATE TABLE IF NOT EXISTS sourcing_suppliers (
                    id INT AUTO_INCREMENT PRIMARY KEY,
                    company_name VARCHAR(255) NOT NULL,
                    website VARCHAR(500) DEFAULT '',
                    email VARCHAR(255) DEFAULT '',
                    phone VARCHAR(100) DEFAULT '',
                    location VARCHAR(255) DEFAULT '',
                    specialization VARCHAR(500) DEFAULT '',
                    company_type VARCHAR(100) DEFAULT '',
                    established VARCHAR(255) DEFAULT '',
                    certifications VARCHAR(500) DEFAULT '',
                    search_query VARCHAR(1000) DEFAULT '',
                    session_id INT DEFAULT NULL,
                    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                    memo TEXT,
                    rating VARCHAR(50) DEFAULT '',
                    contact_person VARCHAR(255) DEFAULT '',
                    history TEXT,
                    INDEX idx_company_name (company_name),
                    INDEX idx_search_query (search_query(255)),
                    INDEX idx_session_id (session_id)
                ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
            """)
            connection.commit()
        except Exception as table_error:
            st.error(f"âŒ í…Œì´ë¸” ìƒì„± ì˜¤ë¥˜: {str(table_error)}")
            return 0
        saved_count = 0
        failed_count = 0
        for i, supplier in enumerate(suppliers):
            try:
                # ì¤‘ë³µ í™•ì¸
                cursor.execute("""
                    SELECT COUNT(*) FROM sourcing_suppliers 
                    WHERE company_name = %s AND website = %s
                """, (supplier.get('company_name', ''), supplier.get('website', '')))
                if cursor.fetchone()[0] > 0:
                    st.caption(f"â­ï¸ ì¤‘ë³µ ì œì™¸: {supplier.get('company_name', 'Unknown')}")
                    continue
                cursor.execute("""
                    INSERT INTO sourcing_suppliers (
                        company_name, website, email, phone, location, 
                        specialization, company_type, established, certifications,
                        search_query, session_id
                    ) VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
                """, (
                    supplier.get('company_name', ''),
                    supplier.get('website', ''),
                    supplier.get('email', ''),
                    supplier.get('phone', ''),
                    supplier.get('location', ''),
                    supplier.get('specialization', ''),
                    supplier.get('company_type', ''),
                    supplier.get('established', ''),
                    supplier.get('certifications', ''),
                    search_query,
                    session_id
                ))
                saved_count += 1
                # ì§„í–‰ë¥  í‘œì‹œ
                if (i + 1) % 5 == 0 or i == len(suppliers) - 1:
                    st.caption(f"ğŸ’¾ ì €ì¥ ì§„í–‰ë¥ : {i+1}/{len(suppliers)}")
            except Exception as e:
                failed_count += 1
                st.warning(f"âš ï¸ ê³µê¸‰ì—…ì²´ ì €ì¥ ì‹¤íŒ¨: {supplier.get('company_name', 'Unknown')} - {str(e)}")
                continue
        connection.commit()
        cursor.close()
        connection.close()
        if saved_count > 0:
            st.success(f"âœ… {saved_count}ê°œ ê³µê¸‰ì—…ì²´ ì €ì¥ ì™„ë£Œ")
        if failed_count > 0:
            st.warning(f"âš ï¸ {failed_count}ê°œ ê³µê¸‰ì—…ì²´ ì €ì¥ ì‹¤íŒ¨")
        return saved_count
    except Exception as e:
        st.error(f"âŒ ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ì˜¤ë¥˜: {str(e)}")
        return 0

def get_saved_suppliers(session_id=None):
    """ì €ì¥ëœ ê³µê¸‰ì—…ì²´ ì¡°íšŒ"""
    try:
        connection = connect_to_db()
        if not connection:
            return []
        
        cursor = connection.cursor(dictionary=True)
        
        if session_id:
            cursor.execute("""
                SELECT *, 
                       COALESCE(memo, '') as memo,
                       COALESCE(rating, '') as rating,
                       COALESCE(contact_person, '') as contact_person,
                       COALESCE(history, '') as history
                FROM sourcing_suppliers 
                WHERE session_id = %s 
                ORDER BY created_at DESC
            """, (session_id,))
        else:
            cursor.execute("""
                SELECT *, 
                       COALESCE(memo, '') as memo,
                       COALESCE(rating, '') as rating,
                       COALESCE(contact_person, '') as contact_person,
                       COALESCE(history, '') as history
                FROM sourcing_suppliers 
                ORDER BY created_at DESC
            """)
        
        suppliers = cursor.fetchall()
        
        cursor.close()
        connection.close()
        
        return suppliers
        
    except Exception as e:
        st.error(f"âŒ ê³µê¸‰ì—…ì²´ ì¡°íšŒ ì˜¤ë¥˜: {str(e)}")
        return []

def delete_supplier(supplier_id):
    """ê³µê¸‰ì—…ì²´ ì‚­ì œ"""
    try:
        connection = connect_to_db()
        if not connection:
            return False, "ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨"
        
        cursor = connection.cursor()
        
        # ì‚­ì œ ì „ íšŒì‚¬ëª… ì¡°íšŒ (ë¡œê·¸ìš©)
        cursor.execute("SELECT company_name FROM sourcing_suppliers WHERE id = %s", (supplier_id,))
        result = cursor.fetchone()
        
        if not result:
            cursor.close()
            connection.close()
            return False, "í•´ë‹¹ ê³µê¸‰ì—…ì²´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
        
        company_name = result[0]
        
        # ì‚­ì œ ì‹¤í–‰
        cursor.execute("DELETE FROM sourcing_suppliers WHERE id = %s", (supplier_id,))
        affected_rows = cursor.rowcount
        connection.commit()
        
        cursor.close()
        connection.close()
        
        if affected_rows > 0:
            return True, f"'{company_name}' ì‚­ì œ ì™„ë£Œ"
        else:
            return False, f"'{company_name}' ì‚­ì œ ì‹¤íŒ¨ (ì˜í–¥ë°›ì€ í–‰ ì—†ìŒ)"
        
    except Exception as e:
        return False, f"ì‚­ì œ ì˜¤ë¥˜: {str(e)}"

def delete_multiple_suppliers(supplier_ids):
    """ì—¬ëŸ¬ ê³µê¸‰ì—…ì²´ ì¼ê´„ ì‚­ì œ"""
    try:
        connection = connect_to_db()
        if not connection:
            return False, "ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨"
        
        cursor = connection.cursor()
        
        # ì‚­ì œí•  íšŒì‚¬ëª…ë“¤ ì¡°íšŒ (ë¡œê·¸ìš©)
        placeholders = ', '.join(['%s'] * len(supplier_ids))
        cursor.execute(f"SELECT company_name FROM sourcing_suppliers WHERE id IN ({placeholders})", supplier_ids)
        companies = [row[0] for row in cursor.fetchall()]
        
        # ì¼ê´„ ì‚­ì œ ì‹¤í–‰
        cursor.execute(f"DELETE FROM sourcing_suppliers WHERE id IN ({placeholders})", supplier_ids)
        affected_rows = cursor.rowcount
        connection.commit()
        
        cursor.close()
        connection.close()
        
        if affected_rows > 0:
            return True, f"{affected_rows}ê°œ ê³µê¸‰ì—…ì²´ ì‚­ì œ ì™„ë£Œ: {', '.join(companies[:3])}{'...' if len(companies) > 3 else ''}"
        else:
            return False, f"ì‚­ì œ ì‹¤íŒ¨ (ì˜í–¥ë°›ì€ í–‰ ì—†ìŒ)"
        
    except Exception as e:
        return False, f"ì¼ê´„ ì‚­ì œ ì˜¤ë¥˜: {str(e)}"

# ===== ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í•¨ìˆ˜ =====

def connect_to_db():
    """ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°"""
    try:
        # í™˜ê²½ ë³€ìˆ˜ í™•ì¸
        host = os.getenv('SQL_HOST')
        user = os.getenv('SQL_USER')
        password = os.getenv('SQL_PASSWORD')
        database = os.getenv('SQL_DATABASE_NEWBIZ')
        
        if not all([host, user, password, database]):
            st.error("âŒ ë°ì´í„°ë² ì´ìŠ¤ í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            st.caption("í•„ìš”í•œ í™˜ê²½ ë³€ìˆ˜: SQL_HOST, SQL_USER, SQL_PASSWORD, SQL_DATABASE_NEWBIZ")
            return None
        
        connection = mysql.connector.connect(
            host=host,
            user=user,
            password=password,
            database=database,
            charset='utf8mb4',
            collation='utf8mb4_unicode_ci',
            autocommit=False,  # ëª…ì‹œì ìœ¼ë¡œ autocommit ë¹„í™œì„±í™”
            connection_timeout=10,  # ì—°ê²° íƒ€ì„ì•„ì›ƒ ì„¤ì •
            pool_size=5,  # ì—°ê²° í’€ í¬ê¸°
            pool_name="sourcing_pool"
        )
        return connection
    except mysql.connector.Error as err:
        st.error(f"âŒ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì˜¤ë¥˜: {err}")
        return None
    except Exception as e:
        st.error(f"âŒ ì˜ˆìƒì¹˜ ëª»í•œ ë°ì´í„°ë² ì´ìŠ¤ ì˜¤ë¥˜: {str(e)}")
        return None

# 1. DB ì»¬ëŸ¼ ìë™ ì¶”ê°€ (main í•¨ìˆ˜ ì´ˆê¸°ì—)
def ensure_extra_columns():
    try:
        connection = connect_to_db()
        if not connection:
            return
        cursor = connection.cursor()
        cursor.execute("SHOW COLUMNS FROM sourcing_suppliers")
        columns = [row[0] for row in cursor.fetchall()]
        alter_sqls = []
        if 'memo' not in columns:
            alter_sqls.append("ALTER TABLE sourcing_suppliers ADD COLUMN memo TEXT")
        if 'rating' not in columns:
            alter_sqls.append("ALTER TABLE sourcing_suppliers ADD COLUMN rating VARCHAR(50) DEFAULT ''")
        if 'contact_person' not in columns:
            alter_sqls.append("ALTER TABLE sourcing_suppliers ADD COLUMN contact_person VARCHAR(255) DEFAULT ''")
        if 'history' not in columns:
            alter_sqls.append("ALTER TABLE sourcing_suppliers ADD COLUMN history TEXT")
        for sql in alter_sqls:
            try:
                cursor.execute(sql)
            except Exception as e:
                st.error(f"DB ì»¬ëŸ¼ ì¶”ê°€ ì˜¤ë¥˜: {str(e)}")
        # established ì»¬ëŸ¼ ê¸¸ì´ í™•ì¥
        try:
            cursor.execute("ALTER TABLE sourcing_suppliers MODIFY COLUMN established VARCHAR(255)")
        except Exception:
            pass
        connection.commit()
        cursor.close()
        connection.close()
    except Exception as e:
        st.error(f"DB ì»¬ëŸ¼ ì¶”ê°€ ì˜¤ë¥˜: {str(e)}")

# main í•¨ìˆ˜ ë§¨ ì•ì— í˜¸ì¶œ
ensure_extra_columns()

# ===== ë©”ì¸ UI =====

def main():
    """ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜"""
    import pandas as pd   
    # ì‚¬ì´ë“œë°” ì„¤ì •
    with st.sidebar:
        st.markdown("## ğŸ”§ ì‹œìŠ¤í…œ ìƒíƒœ")
        
        # API í‚¤ ìƒíƒœ í™•ì¸
        raw_perplexity_key = os.environ.get('PERPLEXITY_API_KEY', '')
        perplexity_key = clean_api_key(raw_perplexity_key)
        
        if perplexity_key and len(perplexity_key) > 10:
            st.success("âœ… Perplexity API í‚¤ ì„¤ì •ë¨")
            
            # API í‚¤ ê²€ì¦ ë²„íŠ¼
            if st.button("ğŸ” API í‚¤ ê²€ì¦", key="verify_api_key"):
                with st.spinner("API í‚¤ ê²€ì¦ ì¤‘..."):
                    is_valid, message = verify_perplexity_api_key(perplexity_key)
                    if is_valid:
                        st.success("âœ… API í‚¤ê°€ ìœ íš¨í•©ë‹ˆë‹¤!")
                    else:
                        st.error(f"âŒ API í‚¤ ê²€ì¦ ì‹¤íŒ¨: {message}")
        else:
            st.error("âŒ Perplexity API í‚¤ í•„ìš”")
            
            with st.expander("ğŸ”‘ API í‚¤ ì„¤ì •"):
                temp_key = st.text_input("Perplexity API Key", type="password")
                if st.button("ì„ì‹œ í‚¤ ì„¤ì •"):
                    if temp_key.strip():
                        cleaned_key = clean_api_key(temp_key)
                        os.environ['PERPLEXITY_API_KEY'] = cleaned_key
                        st.success("âœ… API í‚¤ ì„¤ì •ë¨")
                        st.rerun()
                
                st.caption("ğŸ’¡ API í‚¤ ë°œê¸‰ ë°©ë²•:")
                st.caption("1. https://www.perplexity.ai/settings/api ë°©ë¬¸")
                st.caption("2. ë¡œê·¸ì¸ í›„ API í‚¤ ìƒì„±")
                st.caption("3. í‚¤ëŠ” 'pplx-'ë¡œ ì‹œì‘í•´ì•¼ í•¨")
        
        # ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ
        try:
            connection = connect_to_db()
            if connection:
                st.success("âœ… ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ë¨")
                connection.close()
            else:
                st.error("âŒ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨")
        except:
            st.error("âŒ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨")
        
        st.markdown("---")
        st.markdown("## ğŸ“Š ì‚¬ìš© í†µê³„")
        
        # ì €ì¥ëœ ê³µê¸‰ì—…ì²´ ìˆ˜ (ìºì‹œ í™œìš©)
        try:
            cached_suppliers = get_suppliers_with_cache()
            total_suppliers = len(cached_suppliers)
            st.metric("ì´ ê³µê¸‰ì—…ì²´", total_suppliers)
            
            # ì˜¤ëŠ˜ ë°œê²¬ëœ ê³µê¸‰ì—…ì²´ ìˆ˜
            today = datetime.now().date()
            today_suppliers = sum(1 for s in cached_suppliers 
                                if s.get('created_at') and s['created_at'].date() == today)
            st.metric("ì˜¤ëŠ˜ ë°œê²¬", today_suppliers)
            
            # ì „ì²´ ê°œìˆ˜ í™•ì¸ (ìºì‹œ ë¬´ì‹œ)
            if st.button("ğŸ”„ ì „ì²´ ê°œìˆ˜ ìƒˆë¡œê³ ì¹¨", key="refresh_total_count"):
                refresh_suppliers_cache()
                st.rerun()
            
        except:
            st.metric("ì´ ê³µê¸‰ì—…ì²´", "í™•ì¸ ë¶ˆê°€")
        
        # ìºì‹œ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼
        if st.button("ğŸ”„ ìºì‹œ ìƒˆë¡œê³ ì¹¨", key="refresh_cache"):
            refresh_suppliers_cache()
            st.success("âœ… ìºì‹œê°€ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤!")
            st.rerun()
    
    # ë©”ì¸ íƒ­ êµ¬ì„±
    tab1, tab2, tab_register, tab3 = st.tabs(["ğŸ” ì œí’ˆ ì†Œì‹±", "ğŸ“‹ SCM ì •ë³´", "â• ê³µê¸‰ì—…ì²´ ë“±ë¡", "ğŸ“Š ë¶„ì„ ê²°ê³¼"])

    # ===== íƒ­ 1: ì œí’ˆ ì†Œì‹± =====
    with tab1:
        st.markdown("## ğŸ” ì œí’ˆ ì†Œì‹± ê²€ìƒ‰")
        
        # ê²€ìƒ‰ ì˜ˆì‹œ
        with st.expander("ğŸ’¡ ê²€ìƒ‰ ì˜ˆì‹œ ë° íŒ", expanded=False):
            st.markdown("""
            **íš¨ê³¼ì ì¸ ê²€ìƒ‰ ì˜ˆì‹œ:**
            - ì œí’ˆëª…: "LED ì¡°ëª…", "ìŠ¤ë§ˆíŠ¸í° ì¼€ì´ìŠ¤", "ì „ì ë¶€í’ˆ"
            - ì œì¡°ì‚¬ëª…: "ì‚¼ì„±ì „ì", "LGì „ì", "Apple"
            - ìœ ì‚¬ ì œí’ˆ: "iPhone ì¼€ì´ìŠ¤", "ê°¤ëŸ­ì‹œ ì¼€ì´ìŠ¤"
            - í‚¤ì›Œë“œ: "ë¬´ì„ ì¶©ì „", "ë¸”ë£¨íˆ¬ìŠ¤ ìŠ¤í”¼ì»¤", "ìŠ¤ë§ˆíŠ¸ì›Œì¹˜"
            - ì¬ì§ˆ/ê¸°ìˆ : "í”Œë¼ìŠ¤í‹±", "ì‹¤ë¦¬ì½˜", "ë¬´ì„ ì¶©ì „ ê¸°ìˆ "
            
            **ê²€ìƒ‰ íŒ:**
            - ì œí’ˆëª…, ì œì¡°ì‚¬ëª…, í‚¤ì›Œë“œ ëª¨ë‘ ê²€ìƒ‰ ê°€ëŠ¥
            - ì˜ì–´ í‚¤ì›Œë“œ í˜¼ìš©: "LED lighting", "wireless charging"
            - ìœ ì‚¬ ì œí’ˆëª…ë„ í•¨ê»˜ ê²€ìƒ‰ë¨
            - ì¬ì§ˆì´ë‚˜ ê¸°ìˆ  í‚¤ì›Œë“œ ì¶”ê°€
            """)
        
        # ê²€ìƒ‰ í¼
        with st.form("sourcing_form"):
            col1, col2 = st.columns([2, 1])
            
            with col1:
                product_description = st.text_area(
                    "ê²€ìƒ‰í•  ì œí’ˆëª…, ì œì¡°ì‚¬ëª…, ë˜ëŠ” í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”:",
                    placeholder="ì˜ˆ: LED ì¡°ëª…, ì‚¼ì„±ì „ì, iPhone ì¼€ì´ìŠ¤, ë¬´ì„ ì¶©ì „, ë¸”ë£¨íˆ¬ìŠ¤ ìŠ¤í”¼ì»¤ ë“±",
                    height=100,
                    help="ì œí’ˆëª…, ì œì¡°ì‚¬ëª…, ìœ ì‚¬ ì œí’ˆëª…, ë˜ëŠ” ê´€ë ¨ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."
                )
                
                search_options = st.multiselect(
                    "ê²€ìƒ‰ ì§€ì—­:",
                    ["ì¤‘êµ­", "ë² íŠ¸ë‚¨", "í•œêµ­", "ëŒ€ë§Œ", "ì¼ë³¸", "ì¸ë„", "íƒœêµ­"],
                    default=["ì¤‘êµ­"],
                    help="ì–´ëŠ ì§€ì—­ì˜ ì œì¡°ì‚¬ë¥¼ ì°¾ì„ì§€ ì„ íƒí•˜ì„¸ìš”"
                )
            
            with col2:
                max_results = st.slider("ìµœëŒ€ ê²°ê³¼ ìˆ˜", 5, 30, 15, help="ì°¾ì„ ê³µê¸‰ì—…ì²´ì˜ ìµœëŒ€ ê°œìˆ˜")
                
                query_count = st.slider("ì¿¼ë¦¬ ìˆ˜ (ë‹¤ì–‘í•œ ê²€ìƒ‰ íŒ¨í„´)", 1, 10, 3, help="Perplexity APIì— ë³´ë‚¼ ê²€ìƒ‰ ì¿¼ë¦¬ ê°œìˆ˜ (ê¸°ë³¸ 3, ìµœëŒ€ 10)")
                
                search_depth = st.selectbox(
                    "ê²€ìƒ‰ ê¹Šì´:",
                    ["ê¸°ë³¸ (ë¹ ë¦„)", "ìƒì„¸ (ë³´í†µ)", "í¬ê´„ (ëŠë¦¼)"],
                    help="ê²€ìƒ‰ ê¹Šì´ê°€ ê¹Šì„ìˆ˜ë¡ ë” ë§ì€ ê²°ê³¼ë¥¼ ì°¾ì§€ë§Œ ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦½ë‹ˆë‹¤"
                )
                
                st.markdown("### ğŸ” ê²€ìƒ‰ íŒ")
                st.markdown("""
                **íš¨ê³¼ì ì¸ ê²€ìƒ‰ì„ ìœ„í•œ íŒ:**
                - ì œí’ˆëª…, ì œì¡°ì‚¬ëª…, í‚¤ì›Œë“œ ëª¨ë‘ ê²€ìƒ‰ ê°€ëŠ¥
                - ìœ ì‚¬ ì œí’ˆëª…ë„ í•¨ê»˜ ê²€ìƒ‰ë¨
                - ì¬ì§ˆì´ë‚˜ ê¸°ìˆ  í‚¤ì›Œë“œ ì¶”ê°€
                - ì˜ì–´ í‚¤ì›Œë“œ í˜¼ìš©
                """)
            
            submitted = st.form_submit_button("ğŸ” ì œí’ˆ ì†Œì‹± ì‹œì‘", type="primary")
        
        # ê²€ìƒ‰ ì‹¤í–‰
        if submitted:
            if not product_description.strip():
                st.error("âŒ ì œí’ˆ ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
            else:
                # ì„¸ì…˜ ID ìƒì„±
                session_id = int(time.time())
                
                with st.spinner("ğŸ” ì œí’ˆ ì†Œì‹± ì¤‘..."):
                    # ê²€ìƒ‰ ì¿¼ë¦¬ ìƒì„±
                    base_query = product_description
                    if search_options:
                        regions = " ".join(search_options)
                        base_query = f"{product_description} {regions}"
                    
                    # ê²€ìƒ‰ ì‹¤í–‰ (ì¿¼ë¦¬ ìˆ˜ ì˜µì…˜ ì¶”ê°€)
                    suppliers = search_manufacturers_with_perplexity(base_query, max_results, query_count)
                    
                    if suppliers:
                        st.success(f"ğŸ‰ {len(suppliers)}ê°œì˜ ê³µê¸‰ì—…ì²´ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤!")
                        
                        # ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
                        saved_count = save_suppliers_to_database(suppliers, base_query, session_id)
                        if saved_count > 0:
                            st.success(f"ğŸ’¾ {saved_count}ê°œ ê³µê¸‰ì—…ì²´ê°€ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
                            # ìºì‹œ ìƒˆë¡œê³ ì¹¨
                            refresh_suppliers_cache()
                        
                        # ì„¸ì…˜ ID ì €ì¥
                        st.session_state.last_session_id = session_id
                        
                        # ê²°ê³¼ í‘œì‹œ
                        display_suppliers(get_saved_suppliers(session_id=session_id), show_delete=False, show_detail=False, show_verify=False)
                        
                    else:
                        st.warning("âš ï¸ ê²€ìƒ‰ ì¡°ê±´ì— ë§ëŠ” ê³µê¸‰ì—…ì²´ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
                        
                        with st.expander("ğŸ”§ ê²€ìƒ‰ ê°œì„  ì œì•ˆ"):
                            st.markdown("""
                            **ë” ë‚˜ì€ ê²°ê³¼ë¥¼ ìœ„í•œ ì œì•ˆ:**
                            1. **ì œí’ˆëª… ë‹¤ì–‘í™”**: "iPhone ì¼€ì´ìŠ¤" â†’ "ê°¤ëŸ­ì‹œ ì¼€ì´ìŠ¤", "ìŠ¤ë§ˆíŠ¸í° ì¼€ì´ìŠ¤"
                            2. **ì œì¡°ì‚¬ëª… ì¶”ê°€**: "ì‚¼ì„±ì „ì", "LGì „ì", "Apple"
                            3. **í‚¤ì›Œë“œ í™•ì¥**: "ë¬´ì„ ì¶©ì „", "ë¸”ë£¨íˆ¬ìŠ¤", "ìŠ¤ë§ˆíŠ¸ì›Œì¹˜"
                            4. **ì¬ì§ˆ/ê¸°ìˆ  í‚¤ì›Œë“œ**: "í”Œë¼ìŠ¤í‹±", "ì‹¤ë¦¬ì½˜", "ë¬´ì„ ì¶©ì „ ê¸°ìˆ "
                            5. **ì˜ì–´ í‚¤ì›Œë“œ í˜¼ìš©**: "LED lighting", "wireless charging"
                            """)
    
    # ===== íƒ­ 2: SCM ì •ë³´ =====
    with tab2:
        st.markdown("## ğŸ“‹ SCM ì •ë³´ ëª©ë¡")
        
        # í•„í„°ë§ ë° ê´€ë¦¬ ì˜µì…˜
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            search_filter = st.text_input("ğŸ” í†µí•©ê²€ìƒ‰", placeholder="íšŒì‚¬ëª…, ì œí’ˆëª…, í‚¤ì›Œë“œ ë“±ìœ¼ë¡œ ê²€ìƒ‰")
        
        with col2:
            location_filter = st.selectbox("ğŸŒ ì§€ì—­ í•„í„°", ["ì „ì²´", "ì¤‘êµ­", "ë² íŠ¸ë‚¨", "í•œêµ­", "ëŒ€ë§Œ", "ì¼ë³¸", "ì¸ë„", "ê¸°íƒ€"])
        
        with col3:
            sort_by = st.selectbox("ğŸ”„ ì •ë ¬", ["ìµœì‹ ìˆœ", "íšŒì‚¬ëª…ìˆœ", "ì§€ì—­ìˆœ"])
        
        with col4:
            # í˜ì´ì§€ë„¤ì´ì…˜ ì„¤ì •
            items_per_page = st.selectbox("ğŸ“„ í˜ì´ì§€ë‹¹ í‘œì‹œ", [20, 50, 100, 200], index=1)
        
        # ì „ì²´ ì‚­ì œ ë²„íŠ¼
        st.markdown("### ğŸ—‘ï¸ ê´€ë¦¬")
        
        # ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
        if 'confirm_delete_all' not in st.session_state:
            st.session_state['confirm_delete_all'] = False
        
        if not st.session_state['confirm_delete_all']:
            if st.button("ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ", type="secondary", key="delete_all_btn"):
                st.session_state['confirm_delete_all'] = True
                st.rerun()
        else:
            st.warning("âš ï¸ ì •ë§ë¡œ ì „ì²´ ê³µê¸‰ì—…ì²´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            
            col_yes, col_no = st.columns(2)
            
            with col_yes:
                if st.button("ì˜ˆ, ì „ì²´ ì‚­ì œ", key="yes_delete_all", type="primary"):
                    try:
                        connection = connect_to_db()
                        if connection:
                            cursor = connection.cursor()
                            
                            # ì‚­ì œ ì „ ê°œìˆ˜ í™•ì¸
                            cursor.execute("SELECT COUNT(*) FROM sourcing_suppliers")
                            count_before = cursor.fetchone()[0]
                            
                            if count_before > 0:
                                # ì‹¤ì œ ì‚­ì œ ì‹¤í–‰
                                cursor.execute("DELETE FROM sourcing_suppliers")
                                connection.commit()
                                
                                # ì‚­ì œ í›„ ê°œìˆ˜ í™•ì¸
                                cursor.execute("SELECT COUNT(*) FROM sourcing_suppliers")
                                count_after = cursor.fetchone()[0]
                                
                                cursor.close()
                                connection.close()
                                
                                if count_after == 0:
                                    st.success(f"âœ… ì „ì²´ {count_before}ê°œ ê³µê¸‰ì—…ì²´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.")
                                    # ìºì‹œ ìƒˆë¡œê³ ì¹¨
                                    refresh_suppliers_cache()
                                else:
                                    st.warning(f"âš ï¸ ì¼ë¶€ë§Œ ì‚­ì œë¨: {count_before}ê°œ â†’ {count_after}ê°œ")
                            else:
                                st.info("â„¹ï¸ ì‚­ì œí•  ê³µê¸‰ì—…ì²´ê°€ ì—†ìŠµë‹ˆë‹¤.")
                                cursor.close()
                                connection.close()
                            
                            st.session_state['confirm_delete_all'] = False
                            st.rerun()
                        else:
                            st.error("âŒ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨")
                    except Exception as e:
                        st.error(f"âŒ ì „ì²´ ì‚­ì œ ì˜¤ë¥˜: {str(e)}")
                        st.session_state['confirm_delete_all'] = False
                        st.rerun()
            
            with col_no:
                if st.button("ì•„ë‹ˆì˜¤", key="no_delete_all", type="secondary"):
                    st.session_state['confirm_delete_all'] = False
                    st.rerun()

        # ê³µê¸‰ì—…ì²´ ì¡°íšŒ (ìºì‹œ í™œìš©)
        suppliers = get_suppliers_with_cache()
        
        # ìœ ì‚¬ ì—…ì²´ ê²½ê³ 
        if 'all_suppliers' not in st.session_state:
            st.session_state['all_suppliers'] = suppliers

        # filtered_suppliers ë³€ìˆ˜ ì´ˆê¸°í™”
        filtered_suppliers = []
        current_suppliers = []
        current_page = 1
        start_idx = 0

        if suppliers:
            # ìµœì í™”ëœ í•„í„°ë§
            filtered_suppliers = filter_suppliers_optimized(
                suppliers, 
                search_filter=search_filter, 
                location_filter=location_filter, 
                sort_by=sort_by
            )
            
            st.success(f"ğŸ“Š ì´ {len(filtered_suppliers)}ê°œì˜ ê³µê¸‰ì—…ì²´ê°€ ìˆìŠµë‹ˆë‹¤.")
            
            # ë””ë²„ê¹… ì •ë³´ (í•„í„° ì ìš© ì‹œì—ë§Œ í‘œì‹œ)
            if search_filter or (location_filter and location_filter != "ì „ì²´"):
                with st.expander("ğŸ” í•„í„°ë§ ë””ë²„ê¹… ì •ë³´", expanded=False):
                    st.write(f"**ê²€ìƒ‰ í•„í„°:** {search_filter or 'ì—†ìŒ'}")
                    st.write(f"**ì§€ì—­ í•„í„°:** {location_filter or 'ì—†ìŒ'}")
                    st.write(f"**ì •ë ¬:** {sort_by}")
                    st.write(f"**í•„í„°ë§ ì „:** {len(suppliers)}ê°œ")
                    st.write(f"**í•„í„°ë§ í›„:** {len(filtered_suppliers)}ê°œ")
                    
                    # ì§€ì—­ë³„ ë¶„í¬ í‘œì‹œ
                    if location_filter and location_filter != "ì „ì²´":
                        location_counts = {}
                        country_counts = {}
                        for s in suppliers:
                            loc = s.get('location', 'Unknown')
                            location_counts[loc] = location_counts.get(loc, 0) + 1
                            country = extract_country(loc)
                            country_counts[country] = country_counts.get(country, 0) + 1
                        
                        st.write("**ì „ì²´ ì§€ì—­ ë¶„í¬ (ìƒìœ„ 10ê°œ):**")
                        for loc, count in sorted(location_counts.items(), key=lambda x: x[1], reverse=True)[:10]:
                            st.write(f"- {loc}: {count}ê°œ")
                        
                        st.write("**êµ­ê°€ë³„ ë¶„í¬:**")
                        for country, count in sorted(country_counts.items(), key=lambda x: x[1], reverse=True):
                            st.write(f"- {country}: {count}ê°œ")
            
            # í˜ì´ì§€ë„¤ì´ì…˜
            total_items = len(filtered_suppliers)
            total_pages = (total_items + items_per_page - 1) // items_per_page
            
            if total_pages > 1:
                # í˜ì´ì§€ ì„ íƒ
                current_page = st.selectbox(
                    f"ğŸ“„ í˜ì´ì§€ ì„ íƒ (ì´ {total_pages}í˜ì´ì§€)",
                    range(1, total_pages + 1),
                    index=0
                )
                
                # í˜ì´ì§€ ì •ë³´ í‘œì‹œ
                start_idx = (current_page - 1) * items_per_page
                end_idx = min(start_idx + items_per_page, total_items)
                st.info(f"ğŸ“„ {start_idx + 1}ë²ˆì§¸ ~ {end_idx}ë²ˆì§¸ ê³µê¸‰ì—…ì²´ (ì´ {total_items}ê°œ ì¤‘)")
                
                # í˜„ì¬ í˜ì´ì§€ì˜ ê³µê¸‰ì—…ì²´ë§Œ í‘œì‹œ
                current_suppliers = filtered_suppliers[start_idx:end_idx]
            else:
                current_suppliers = filtered_suppliers
                current_page = 1
                start_idx = 0
            
            # ê³µê¸‰ì—…ì²´ ëª©ë¡ í‘œì‹œ
            for i, supplier in enumerate(current_suppliers):
                company_name = supplier.get('company_name', 'Unknown Company')
                
                with st.expander(f"ğŸ¢ {company_name}"):
                    display_supplier_card(supplier, start_idx + i + 1, show_delete=True, show_detail=True, show_verify=True)
        
        else:
            st.info("ğŸ” ì•„ì§ ë°œê²¬ëœ ê³µê¸‰ì—…ì²´ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì œí’ˆ ì†Œì‹±ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.")
        
        # ì—‘ì…€/CSV ë‚´ë³´ë‚´ê¸° ë²„íŠ¼ ì¶”ê°€ (filtered_suppliersê°€ ìˆê³  ë¹„ì–´ìˆì§€ ì•Šì„ ë•Œë§Œ)
        if filtered_suppliers and len(filtered_suppliers) > 0:
            col_dl1, col_dl2, col_dl3 = st.columns([1,1,1])
            with col_dl1:
                # í˜„ì¬ í˜ì´ì§€ë§Œ ë‚´ë³´ë‚´ê¸°
                df_current = pd.DataFrame(current_suppliers)
                output_current = io.BytesIO()
                df_current.to_excel(output_current, index=False, engine='openpyxl')
                output_current.seek(0)
                st.download_button(
                    label="ğŸ“¥ í˜„ì¬ í˜ì´ì§€ ì—‘ì…€",
                    data=output_current,
                    file_name=f"scm_suppliers_page_{current_page}.xlsx",
                    mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                )
            with col_dl2:
                # ì „ì²´ ë°ì´í„° ë‚´ë³´ë‚´ê¸°
                df_export = pd.DataFrame(filtered_suppliers)
                output = io.BytesIO()
                df_export.to_excel(output, index=False, engine='openpyxl')
                output.seek(0)
                st.download_button(
                    label="ğŸ“¥ ì „ì²´ ì—‘ì…€",
                    data=output,
                    file_name="scm_suppliers_all.xlsx",
                    mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                )
            with col_dl3:
                st.download_button(
                    label="ğŸ“¥ ì „ì²´ CSV",
                    data=df_export.to_csv(index=False),
                    file_name="scm_suppliers_all.csv",
                    mime="text/csv"
                )

    # ===== ì‹ ê·œ ê³µê¸‰ì—…ì²´ ë“±ë¡ íƒ­ =====
    with tab_register:
        st.markdown("## â• ì‹ ê·œ ê³µê¸‰ì—…ì²´ ë“±ë¡")
        with st.form("register_supplier_form", clear_on_submit=True):
            col1, col2 = st.columns(2)
            with col1:
                company_name = st.text_input("íšŒì‚¬ëª…*", max_chars=255)
                website = st.text_input("ì›¹ì‚¬ì´íŠ¸*", max_chars=500)
                email = st.text_input("ì´ë©”ì¼", max_chars=255)
                phone = st.text_input("ì „í™”ë²ˆí˜¸", max_chars=100)
                location = st.text_input("ìœ„ì¹˜", max_chars=255)
            with col2:
                specialization = st.text_input("ì „ë¬¸ë¶„ì•¼", max_chars=500)
                company_type = st.text_input("íšŒì‚¬ìœ í˜•", max_chars=100, placeholder="Manufacturer/OEM/ODM ë“±")
                established = st.text_input("ì„¤ë¦½ì—°ë„", max_chars=50)
                certifications = st.text_input("ì¸ì¦", max_chars=500, placeholder="ISO, CE, RoHS ë“±")
                search_query = st.text_input("ë“±ë¡ ì‚¬ìœ /ê²€ìƒ‰ ì¿¼ë¦¬", max_chars=1000)
            submitted = st.form_submit_button("ë“±ë¡í•˜ê¸°", type="primary")
        if submitted:
            # í•„ìˆ˜ê°’ ì²´í¬
            if not company_name.strip() or not website.strip():
                st.error("íšŒì‚¬ëª…ê³¼ ì›¹ì‚¬ì´íŠ¸ëŠ” í•„ìˆ˜ ì…ë ¥ì…ë‹ˆë‹¤.")
            else:
                # ìœ ì‚¬ ì—…ì²´ ê²½ê³  (ìºì‹œ í™œìš©)
                if company_name or website or email or phone:
                    temp_target = dict(company_name=company_name, website=website, email=email, phone=phone)
                    all_suppliers = get_suppliers_with_cache()
                    similar = find_similar_suppliers(temp_target, all_suppliers)
                    if similar:
                        st.warning(f"âš ï¸ ìœ ì‚¬ ì—…ì²´ {len(similar)}ê±´ ìˆìŒ! (ì˜ˆ: {similar[0].get('company_name','')})")

                # ì¤‘ë³µ ì²´í¬
                connection = connect_to_db()
                if connection:
                    cursor = connection.cursor()
                    cursor.execute("SELECT COUNT(*) FROM sourcing_suppliers WHERE company_name = %s AND website = %s", (company_name.strip(), website.strip()))
                    if cursor.fetchone()[0] > 0:
                        st.warning("ì´ë¯¸ ë™ì¼í•œ íšŒì‚¬ëª…ê³¼ ì›¹ì‚¬ì´íŠ¸ê°€ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.")
                        cursor.close()
                        connection.close()
                    else:
                        cursor.execute("""
                            INSERT INTO sourcing_suppliers (
                                company_name, website, email, phone, location, specialization, company_type, established, certifications, search_query
                            ) VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
                        """, (
                            company_name.strip(), website.strip(), email.strip(), phone.strip(), location.strip(), specialization.strip(), company_type.strip(), established.strip(), certifications.strip(), search_query.strip()
                        ))
                        connection.commit()
                        cursor.close()
                        connection.close()
                        st.success(f"'{company_name}' ê³µê¸‰ì—…ì²´ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!")
                        # ìºì‹œ ìƒˆë¡œê³ ì¹¨
                        refresh_suppliers_cache()

    # ===== íƒ­ 3: ë¶„ì„ ê²°ê³¼ =====
    with tab3:
        st.markdown("## ğŸ“Š ì†Œì‹± ë¶„ì„ ê²°ê³¼")
        
        suppliers = get_suppliers_with_cache()
        
        if suppliers:
            # ìµœì í™”ëœ í†µê³„ ê³„ì‚°
            stats = calculate_supplier_stats(suppliers)
            
            # í†µê³„ ë¶„ì„
            col1, col2, col3, col4 = st.columns(4)
            
            with col1:
                st.metric("ì´ ê³µê¸‰ì—…ì²´", stats['total'])
            
            with col2:
                st.metric("ì¤‘êµ­ ì—…ì²´", stats['china'])
            
            with col3:
                st.metric("ë² íŠ¸ë‚¨ ì—…ì²´", stats['vietnam'])
            
            with col4:
                st.metric("í•œêµ­ ì—…ì²´", stats['korea'])
            
            # ì§€ì—­ë³„ ë¶„í¬ ì°¨íŠ¸
            st.markdown("### ğŸŒ ì§€ì—­ë³„ ê³µê¸‰ì—…ì²´ ë¶„í¬")
            
            if stats['location_counts']:
                df_location = pd.DataFrame(list(stats['location_counts'].items()), columns=['êµ­ê°€', 'ì—…ì²´ ìˆ˜'])
                st.bar_chart(df_location.set_index('êµ­ê°€'))
            
            # íšŒì‚¬ ìœ í˜•ë³„ ë¶„ì„
            st.markdown("### ğŸ­ íšŒì‚¬ ìœ í˜•ë³„ ë¶„ì„")
            
            if stats['type_counts']:
                df_types = pd.DataFrame(list(stats['type_counts'].items()), columns=['íšŒì‚¬ ìœ í˜•', 'ì—…ì²´ ìˆ˜'])
                st.bar_chart(df_types.set_index('íšŒì‚¬ ìœ í˜•'))
            
            # ìµœê·¼ ë°œê²¬ ì¶”ì´
            st.markdown("### ğŸ“ˆ ìµœê·¼ ë°œê²¬ ì¶”ì´")
            try:
                connection = connect_to_db()
                if connection:
                    cursor = connection.cursor()
                    cursor.execute("""
                        SELECT DATE(created_at) as ë‚ ì§œ, COUNT(*) as ë°œê²¬ìˆ˜
                        FROM sourcing_suppliers
                        WHERE created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
                        GROUP BY DATE(created_at)
                        ORDER BY ë‚ ì§œ
                    """)
                    daily_data = cursor.fetchall()
                    cursor.close()
                    connection.close()
                    st.write('ì¿¼ë¦¬ ê²°ê³¼:', daily_data)  # ë””ë²„ê¹…ìš©
                    if daily_data:
                        df_daily = pd.DataFrame(daily_data, columns=['ë‚ ì§œ', 'ë°œê²¬ìˆ˜'])
                        st.write(df_daily)  # DataFrame í™•ì¸
                        df_daily['ë‚ ì§œ'] = pd.to_datetime(df_daily['ë‚ ì§œ'].astype(str))
                        st.line_chart(df_daily.set_index('ë‚ ì§œ'))
                    else:
                        st.info('ìµœê·¼ 7ì¼ê°„ ì‹ ê·œ ë“±ë¡ëœ ê³µê¸‰ì—…ì²´ê°€ ì—†ìŠµë‹ˆë‹¤.')
            except Exception as e:
                st.warning(f"âš ï¸ ì¼ë³„ í†µê³„ ì¡°íšŒ ì‹¤íŒ¨: {str(e)}")
        else:
            st.info("ğŸ“Š ë¶„ì„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì œí’ˆ ì†Œì‹±ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.")

def display_suppliers(suppliers, show_delete=True, show_detail=True, show_verify=True):
    # í•­ìƒ ì„¸ì…˜ì— ì €ì¥
    st.session_state['last_sourcing_suppliers'] = suppliers
    st.markdown("### ğŸ¢ ë°œê²¬ëœ ê³µê¸‰ì—…ì²´")
    for i, supplier in enumerate(suppliers, 1):
        company_name = supplier.get('company_name', 'Unknown Company')
        with st.expander(f"{i}. {company_name}"):
            display_supplier_card(supplier, i, show_delete, show_detail, show_verify)

def display_supplier_card(supplier, index=None, show_delete=True, show_detail=True, show_verify=True):
    col1, col2 = st.columns([2, 1])
    with col1:
        st.markdown(f"**ğŸ¢ íšŒì‚¬ëª…:** {supplier.get('company_name', 'N/A')}")
        if supplier.get('website'):
            valid = is_valid_website_cached(supplier['website'])
            st.markdown(f"**ğŸŒ ì›¹ì‚¬ì´íŠ¸:** [{supplier['website']}]({supplier['website']}) {'âœ…' if valid else 'âŒ'}")
        if supplier.get('email'):
            valid = is_valid_email(supplier['email'])
            st.markdown(f"**ğŸ“§ ì´ë©”ì¼:** {supplier['email']} {'âœ…' if valid else 'âŒ'}")
        if supplier.get('phone'):
            valid = is_valid_phone(supplier['phone'])
            st.markdown(f"**ğŸ“ ì „í™”ë²ˆí˜¸:** {supplier['phone']} {'âœ…' if valid else 'âŒ'}")
        if supplier.get('location'):
            st.markdown(f"**ğŸ“ ìœ„ì¹˜:** {supplier['location']}")
        if supplier.get('specialization'):
            st.markdown(f"**ğŸ­ ì „ë¬¸ë¶„ì•¼:** {supplier['specialization']}")
    with col2:
        if supplier.get('company_type'):
            st.markdown(f"**ğŸ¢ ìœ í˜•:** {supplier['company_type']}")
        if supplier.get('established'):
            st.markdown(f"**ğŸ“… ì„¤ë¦½:** {supplier['established']}")
        if supplier.get('certifications'):
            st.markdown(f"**âœ… ì¸ì¦:** {supplier['certifications']}")
        
        # ì €ì¥ëœ ë©”ëª¨ ì •ë³´ í‘œì‹œ
        if supplier.get('memo'):
            st.markdown(f"**ğŸ“ ë©”ëª¨:** {supplier['memo']}")
        if supplier.get('rating'):
            st.markdown(f"**â­ í‰ê°€:** {supplier['rating']}")
        if supplier.get('contact_person'):
            st.markdown(f"**ğŸ‘¤ ë‹´ë‹¹ì:** {supplier['contact_person']}")
        if supplier.get('history'):
            st.markdown(f"**ğŸ“‹ ì´ë ¥:** {supplier['history']}")
        # ì›¹ì‚¬ì´íŠ¸ í™•ì¸ ë²„íŠ¼
        if show_verify and supplier.get('website'):
            company_name = supplier.get('company_name', 'Unknown')
            supplier_id = supplier.get('id', 'unknown')
            session_id = supplier.get('session_id', 'no_session')
            index_str = f"idx_{index}" if index is not None else "no_idx"
            safe_company_name = re.sub(r'[^a-zA-Z0-9]', '_', company_name)[:20]
            verify_key = f"verify_{index_str}_{safe_company_name}_{supplier_id}_{session_id}"
            if st.button(f"ğŸ” ì›¹ì‚¬ì´íŠ¸ í™•ì¸", key=verify_key):
                is_valid = verify_supplier_website(supplier['website'])
                if is_valid:
                    st.success("âœ… ì›¹ì‚¬ì´íŠ¸ ì ‘ì† ê°€ëŠ¥")
                else:
                    st.error("âŒ ì›¹ì‚¬ì´íŠ¸ ì ‘ì† ë¶ˆê°€")
        # ì‚­ì œ ë²„íŠ¼
        if show_delete:
            delete_key = f"delete_card_{index_str}_{safe_company_name}_{supplier_id}_{session_id}"
            delete_failed_key = f"delete_failed_{supplier_id}"
            
            if st.button(f"ğŸ—‘ï¸ ì‚­ì œ", key=delete_key, type="secondary", disabled=st.session_state.get(delete_failed_key, False)):
                with st.spinner("ì‚­ì œ ì¤‘..."):
                    success, message = delete_supplier(supplier_id)
                    if success:
                        st.success(message)
                        # ìºì‹œ ê°•ì œ ìƒˆë¡œê³ ì¹¨
                        refresh_suppliers_cache()
                        # ì¦‰ì‹œ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ rowê°€ ì‚¬ë¼ì§ì„ ë³´ì¥
                        st.rerun()
                    else:
                        st.error(message)
                        st.session_state[delete_failed_key] = True
                        st.rerun()
            
            if st.session_state.get(delete_failed_key):
                st.error("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.")
                if st.button("ğŸ”„ ìƒˆë¡œê³ ì¹¨", key=f"refresh_after_fail_{supplier_id}"):
                    del st.session_state[delete_failed_key]
                    st.rerun()
        # ìƒì„¸ ì •ë³´/ë©”ëª¨ ë²„íŠ¼
        if show_detail:
            detail_key = f"detail_{supplier_id}_{index}"
            detail_state_key = f"show_detail_{supplier_id}_{index}"
            
            # ìƒì„¸ ì •ë³´ í‘œì‹œ ìƒíƒœ ê´€ë¦¬
            if st.button("ğŸ“ ìƒì„¸ ì •ë³´/ë©”ëª¨", key=detail_key):
                st.session_state[detail_state_key] = True
                st.rerun()
            
            if st.session_state.get(detail_state_key, False):
                st.markdown("---")
                st.markdown("#### ğŸ“ ìƒì„¸ ì •ë³´/ë©”ëª¨ (ëª¨ë“  í•„ë“œ í¸ì§‘ ê°€ëŠ¥)")

                current = lambda k: supplier.get(k) or ''
                # ì…ë ¥ í•„ë“œë“¤ (2ì—´ ë°°ì¹˜)
                colA, colB = st.columns(2)
                with colA:
                    company_name = st.text_input("íšŒì‚¬ëª…*", value=current('company_name'), key=f"edit_company_name_{supplier_id}_{index}")
                    website = st.text_input("ì›¹ì‚¬ì´íŠ¸*", value=current('website'), key=f"edit_website_{supplier_id}_{index}")
                    email = st.text_input("ì´ë©”ì¼", value=current('email'), key=f"edit_email_{supplier_id}_{index}")
                    phone = st.text_input("ì „í™”ë²ˆí˜¸", value=current('phone'), key=f"edit_phone_{supplier_id}_{index}")
                    location = st.text_input("ìœ„ì¹˜", value=current('location'), key=f"edit_location_{supplier_id}_{index}")
                    specialization = st.text_input("ì „ë¬¸ë¶„ì•¼", value=current('specialization'), key=f"edit_specialization_{supplier_id}_{index}")
                with colB:
                    company_type = st.text_input("íšŒì‚¬ìœ í˜•", value=current('company_type'), key=f"edit_company_type_{supplier_id}_{index}")
                    established = st.text_input("ì„¤ë¦½ì—°ë„", value=current('established'), key=f"edit_established_{supplier_id}_{index}")
                    certifications = st.text_input("ì¸ì¦", value=current('certifications'), key=f"edit_certifications_{supplier_id}_{index}")
                    memo = st.text_area("ë©”ëª¨", value=current('memo'), key=f"edit_memo_{supplier_id}_{index}")
                    rating = st.text_input("í‰ê°€(ë“±ê¸‰/ì ìˆ˜)", value=current('rating'), key=f"edit_rating_{supplier_id}_{index}")
                    contact_person = st.text_input("ë‹´ë‹¹ì", value=current('contact_person'), key=f"edit_contact_{supplier_id}_{index}")
                    history = st.text_area("ì´ë ¥/ë¹„ê³ ", value=current('history'), key=f"edit_history_{supplier_id}_{index}")

                # ì €ì¥ ë²„íŠ¼
                col_save, col_close = st.columns(2)
                with col_save:
                    if st.button("ğŸ’¾ ì €ì¥", key=f"save_detail_{supplier_id}_{index}", type="primary"):
                        # í•„ìˆ˜ê°’ ì²´í¬
                        if not company_name.strip() or not website.strip():
                            st.error("íšŒì‚¬ëª…ê³¼ ì›¹ì‚¬ì´íŠ¸ëŠ” í•„ìˆ˜ ì…ë ¥ì…ë‹ˆë‹¤.")
                        else:
                            try:
                                connection = connect_to_db()
                                if connection:
                                    cursor = connection.cursor()
                                    cursor.execute(
                                        """
                                        UPDATE sourcing_suppliers SET
                                            company_name=%s, website=%s, email=%s, phone=%s, location=%s,
                                            specialization=%s, company_type=%s, established=%s, certifications=%s,
                                            memo=%s, rating=%s, contact_person=%s, history=%s
                                        WHERE id=%s
                                        """,
                                        (
                                            company_name, website, email, phone, location,
                                            specialization, company_type, established, certifications,
                                            memo, rating, contact_person, history, supplier_id
                                        )
                                    )
                                    affected_rows = cursor.rowcount
                                    connection.commit()
                                    cursor.close()
                                    connection.close()
                                    if affected_rows > 0:
                                        st.success("âœ… ìƒì„¸ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
                                        refresh_suppliers_cache()
                                        st.session_state[detail_state_key] = False
                                        st.rerun()
                                    else:
                                        st.warning(f"âš ï¸ ì €ì¥ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤. (ID: {supplier_id})")
                                else:
                                    st.error("âŒ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨")
                            except Exception as e:
                                st.error(f"âŒ ì €ì¥ ì˜¤ë¥˜: {str(e)}")
                with col_close:
                    if st.button("âŒ ë‹«ê¸°", key=f"close_detail_{supplier_id}_{index}"):
                        st.session_state[detail_state_key] = False
                        st.rerun()
            # íŒŒì¼ ì—…ë¡œë“œ/ë¯¸ë¦¬ë³´ê¸°/ë‹¤ìš´ë¡œë“œ UI ì¶”ê°€
            st.markdown("---")
            st.markdown("#### ğŸ“ ê²¬ì ì„œ/ë¸Œë¡œì…” ë“± íŒŒì¼ ê´€ë¦¬")
            uploaded_files = st.file_uploader(
                "íŒŒì¼ ì—…ë¡œë“œ (PDF, DOCX, PPTX, XLSX, ì´ë¯¸ì§€ ë“±)",
                type=['pdf', 'docx', 'pptx', 'xlsx', 'md', 'txt', 'jpg', 'jpeg', 'png', 'gif'],
                accept_multiple_files=True,
                key=f"supplier_files_{supplier_id}_{index}"
            )
            if uploaded_files and st.button("íŒŒì¼ ì €ì¥", key=f"save_files_{supplier_id}_{index}"):
                for file in uploaded_files:
                    file_data = parse_uploaded_file(file)
                    if file_data:
                        save_supplier_file(supplier_id, file_data)
                st.success("íŒŒì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!")
                st.rerun()
            files = get_supplier_files(supplier_id)
            preview_id = st.session_state.get(f'preview_file_{supplier_id}_{index}')
            if files:
                st.markdown("**ì—…ë¡œë“œëœ íŒŒì¼ ëª©ë¡:**")
                for file in files:
                    colf1, colf2, colf3 = st.columns([4,1,1])
                    with colf1:
                        st.write(f"{file['filename']} ({file['file_type']}, {file['file_size']} bytes)")
                    with colf2:
                        if st.button("ë¯¸ë¦¬ë³´ê¸°", key=f"preview_{file['file_id']}_{supplier_id}_{index}"):
                            st.session_state[f'preview_file_{supplier_id}_{index}'] = file['file_id']
                    with colf3:
                        file_bin = get_supplier_file_binary(file['file_id'])
                        if file_bin:
                            st.download_button(
                                label="ë‹¤ìš´ë¡œë“œ",
                                data=file_bin['file_binary_data'],
                                file_name=file_bin['filename'],
                                mime=get_file_mime_type(file_bin['file_type']),
                                key=f"download_{file['file_id']}_{supplier_id}_{index}"
                            )
            else:
                st.info("ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
            # ë¯¸ë¦¬ë³´ê¸°ëŠ” ë°˜ë“œì‹œ forë¬¸/with ë¸”ë¡ ë°”ê¹¥, expander ìµœìƒìœ„ì—ì„œ ì‹¤í–‰
            if preview_id and files:
                file = next((f for f in files if f['file_id'] == preview_id), None)
                if file:
                    st.markdown("---")
                    st.markdown(f"#### ğŸ“„ ë¯¸ë¦¬ë³´ê¸°: {file['filename']}")
                    display_file_preview(file, file['file_type'], file['filename'])
                    if st.button("ë¯¸ë¦¬ë³´ê¸° ë‹«ê¸°", key=f"close_preview_{supplier_id}_{index}"):
                        del st.session_state[f'preview_file_{supplier_id}_{index}']

def extract_country(location):
    """ìœ„ì¹˜ì—ì„œ êµ­ê°€ ì¶”ì¶œ"""
    if not location:
        return "Unknown"
    
    location_lower = location.lower()
    
    country_mapping = {
        'china': 'ì¤‘êµ­',
        'chinese': 'ì¤‘êµ­',
        'vietnam': 'ë² íŠ¸ë‚¨',
        'vietnamese': 'ë² íŠ¸ë‚¨',
        'korea': 'í•œêµ­',
        'korean': 'í•œêµ­',
        'taiwan': 'ëŒ€ë§Œ',
        'japan': 'ì¼ë³¸',
        'japanese': 'ì¼ë³¸',
        'india': 'ì¸ë„',
        'indian': 'ì¸ë„',
        'thailand': 'íƒœêµ­',
        'thai': 'íƒœêµ­',
        'malaysia': 'ë§ë ˆì´ì‹œì•„',
        'indonesia': 'ì¸ë„ë„¤ì‹œì•„',
        'philippines': 'í•„ë¦¬í•€',
        'singapore': 'ì‹±ê°€í¬ë¥´'
    }
    
    for english, korean in country_mapping.items():
        if english in location_lower:
            return korean
    
    return "ê¸°íƒ€"

def find_similar_suppliers(target, all_suppliers):
    def normalize(s):
        return re.sub(r'[^a-zA-Z0-9]', '', s or '').lower()
    target_fields = [normalize(target.get('company_name')), normalize(target.get('website')), normalize(target.get('email')), normalize(target.get('phone'))]
    similar = []
    for s in all_suppliers:
        if s.get('id') == target.get('id'):
            continue
        fields = [normalize(s.get('company_name')), normalize(s.get('website')), normalize(s.get('email')), normalize(s.get('phone'))]
        for tf in target_fields:
            if tf and any(tf in f and f for f in fields):
                similar.append(s)
                break
    return similar

@lru_cache(maxsize=128)
def is_valid_email(email):
    if not email:
        return False
    pattern = r'^([a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+)$'
    return re.match(pattern, email) is not None

@lru_cache(maxsize=128)
def is_valid_phone(phone):
    if not phone:
        return False
    digits = re.sub(r'\D', '', phone)
    return 7 <= len(digits) <= 15

@lru_cache(maxsize=128)
def is_valid_website(url):
    if not url:
        return False
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
    }
    try:
        resp = requests.get(url, headers=headers, timeout=5, allow_redirects=True)
        return resp.status_code in [200, 301, 302, 403, 405]
    except Exception:
        return False

# í‘¸í„°
st.markdown("---")
st.markdown("""
<div style='text-align: center; color: #666; padding: 20px;'>
    <p>ğŸ” <strong>AI ì œí’ˆ ì†Œì‹± ì‹œìŠ¤í…œ</strong></p>
    <p>ì‹¤ì‹œê°„ ì›¹ ê²€ìƒ‰ ê¸°ë°˜ ì œì¡°ì‚¬ ë° ê³µê¸‰ì—…ì²´ ë°œêµ´ | Powered by Perplexity AI</p>
</div>
""", unsafe_allow_html=True)

# ===== ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•œ ìºì‹± ë©”ì»¤ë‹ˆì¦˜ =====

# ì„¸ì…˜ ìƒíƒœì— ìºì‹œëœ ë°ì´í„° ì €ì¥
def get_cached_suppliers():
    """ìºì‹œëœ ê³µê¸‰ì—…ì²´ ë°ì´í„° ë°˜í™˜"""
    if 'cached_suppliers' not in st.session_state:
        st.session_state['cached_suppliers'] = get_saved_suppliers()
        st.session_state['cache_timestamp'] = time.time()
    return st.session_state['cached_suppliers']

def refresh_suppliers_cache():
    """ê³µê¸‰ì—…ì²´ ìºì‹œ ìƒˆë¡œê³ ì¹¨"""
    if 'cached_suppliers' in st.session_state:
        del st.session_state['cached_suppliers']
    if 'cache_timestamp' in st.session_state:
        del st.session_state['cache_timestamp']

def get_suppliers_with_cache(session_id=None, force_refresh=False):
    """ìºì‹œë¥¼ í™œìš©í•œ ê³µê¸‰ì—…ì²´ ì¡°íšŒ"""
    if force_refresh:
        refresh_suppliers_cache()
    
    if session_id:
        # ì„¸ì…˜ë³„ ì¡°íšŒëŠ” ìºì‹œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
        return get_saved_suppliers(session_id)
    
    return get_cached_suppliers()

# ìµœì í™”ëœ í•„í„°ë§ í•¨ìˆ˜
def filter_suppliers_optimized(suppliers, search_filter=None, location_filter=None, sort_by="ìµœì‹ ìˆœ"):
    """ìµœì í™”ëœ ê³µê¸‰ì—…ì²´ í•„í„°ë§ (ëª¨ë“  ì£¼ìš” ì¹¼ëŸ¼+ë©”ëª¨ í¬í•¨)"""
    if not suppliers:
        return []
    filtered = suppliers
    # ê²€ìƒ‰ í•„í„° ì ìš© (ëª¨ë“  ì£¼ìš” ì¹¼ëŸ¼ í¬í•¨, memoë„ í¬í•¨)
    if search_filter:
        search_lower = search_filter.strip().lower()
        filtered = [
            s for s in filtered
            if any(
                search_lower in str(s.get(field, '') or '').lower()
                for field in [
                    'company_name', 'website', 'email', 'phone', 'location',
                    'specialization', 'company_type', 'established', 'certifications',
                    'memo', 'rating', 'contact_person', 'history', 'search_query'
                ]
            )
        ]
    # ì§€ì—­ í•„í„° ì ìš©
    if location_filter and location_filter != "ì „ì²´":
        # extract_country í•¨ìˆ˜ë¥¼ í™œìš©í•œ ì •í™•í•œ ì§€ì—­ í•„í„°ë§
        filtered_by_country = [
            s for s in filtered 
            if extract_country(s.get('location', '')) == location_filter
        ]
        
        # ë°±ì—… ë°©ë²•: í‚¤ì›Œë“œ ê¸°ë°˜ í•„í„°ë§
        location_mapping = {
            "ì¤‘êµ­": ["china", "chinese", "shenzhen", "guangzhou", "shanghai", "beijing"],
            "ë² íŠ¸ë‚¨": ["vietnam", "vietnamese", "ho chi minh", "hanoi"],
            "í•œêµ­": ["korea", "korean", "seoul", "busan", "incheon"],
            "ëŒ€ë§Œ": ["taiwan", "taipei"],
            "ì¼ë³¸": ["japan", "japanese", "tokyo", "osaka"],
            "ì¸ë„": ["india", "indian", "mumbai", "delhi"],
            "íƒœêµ­": ["thailand", "thai", "bangkok"]
        }
        
        target_keywords = location_mapping.get(location_filter, [location_filter.lower()])
        filtered_by_keyword = [
            s for s in filtered 
            if any(keyword in s.get('location', '').lower() for keyword in target_keywords)
        ]
        
        # ë‘ ë°©ë²• ì¤‘ ë” ë§ì€ ê²°ê³¼ë¥¼ ë°˜í™˜
        if len(filtered_by_country) > len(filtered_by_keyword):
            filtered = filtered_by_country
        else:
            filtered = filtered_by_keyword
    
    # ì •ë ¬ ì ìš©
    if sort_by == "íšŒì‚¬ëª…ìˆœ":
        filtered.sort(key=lambda x: x.get('company_name', ''))
    elif sort_by == "ì§€ì—­ìˆœ":
        filtered.sort(key=lambda x: x.get('location', ''))
    else:  # ìµœì‹ ìˆœ
        filtered.sort(key=lambda x: x.get('created_at', ''), reverse=True)
    
    return filtered

# ì›¹ì‚¬ì´íŠ¸ ê²€ì¦ ìµœì í™”
@lru_cache(maxsize=256)
def is_valid_website_cached(url):
    """ìºì‹œëœ ì›¹ì‚¬ì´íŠ¸ ê²€ì¦"""
    if not url:
        return False
    
    # ê°„ë‹¨í•œ URL í˜•ì‹ ê²€ì¦ë§Œ ìˆ˜í–‰ (ì‹¤ì œ HTTP ìš”ì²­ ì œê±°)
    url_pattern = r'^https?://[^\s/$.?#].[^\s]*$'
    return bool(re.match(url_pattern, url))

# í†µê³„ ê³„ì‚° ìµœì í™”
def calculate_supplier_stats(suppliers):
    """ê³µê¸‰ì—…ì²´ í†µê³„ ê³„ì‚° (ìµœì í™”ëœ ë²„ì „)"""
    if not suppliers:
        return {
            'total': 0,
            'china': 0,
            'vietnam': 0,
            'korea': 0,
            'location_counts': {},
            'type_counts': {}
        }
    
    stats = {
        'total': len(suppliers),
        'china': 0,
        'vietnam': 0,
        'korea': 0,
        'location_counts': {},
        'type_counts': {}
    }
    
    for supplier in suppliers:
        location = supplier.get('location', 'Unknown').lower()
        company_type = supplier.get('company_type', 'Unknown')
        
        # ì§€ì—­ë³„ ì¹´ìš´íŠ¸
        if 'china' in location:
            stats['china'] += 1
        elif 'vietnam' in location:
            stats['vietnam'] += 1
        elif 'korea' in location:
            stats['korea'] += 1
        
        # ìœ„ì¹˜ë³„ í†µê³„
        country = extract_country(supplier.get('location', 'Unknown'))
        stats['location_counts'][country] = stats['location_counts'].get(country, 0) + 1
        
        # íšŒì‚¬ ìœ í˜•ë³„ í†µê³„
        stats['type_counts'][company_type] = stats['type_counts'].get(company_type, 0) + 1
    
    return stats

def ensure_supplier_files_table():
    """ê³µê¸‰ì—…ì²´ íŒŒì¼ í…Œì´ë¸”ì´ ì—†ìœ¼ë©´ ìƒì„± (ê¸°ì¡´ ë°ì´í„° ë³´ì¡´)"""
    try:
        connection = connect_to_db()
        if not connection:
            return
        cursor = connection.cursor()
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS supplier_files (
                file_id INT AUTO_INCREMENT PRIMARY KEY,
                supplier_id INT,
                filename VARCHAR(500) NOT NULL,
                file_type VARCHAR(50),
                file_content LONGTEXT,
                file_binary_data LONGBLOB,
                file_size BIGINT,
                uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (supplier_id) REFERENCES sourcing_suppliers(id) ON DELETE CASCADE,
                INDEX idx_supplier_id (supplier_id),
                INDEX idx_file_type (file_type),
                INDEX idx_filename (filename)
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
        """)
        connection.commit()
        cursor.close()
        connection.close()
    except Exception as e:
        st.error(f"ê³µê¸‰ì—…ì²´ íŒŒì¼ í…Œì´ë¸” ìƒì„± ì˜¤ë¥˜: {str(e)}")

# ì•± ì‹œì‘ ì‹œ í…Œì´ë¸” ë³´ì¥
ensure_supplier_files_table()

# íŒŒì¼ ì €ì¥/ì¡°íšŒ/ë¯¸ë¦¬ë³´ê¸° í•¨ìˆ˜ë“¤ (02_ğŸ—ƒï¸_Archives.py ì°¸ê³ )
def parse_uploaded_file(uploaded_file):
    try:
        file_extension = uploaded_file.name.split('.')[-1].lower()
        content = ""
        uploaded_file.seek(0)
        binary_data = uploaded_file.read()
        binary_base64 = binary_data  # ë°”ì´ë„ˆë¦¬ ê·¸ëŒ€ë¡œ ì €ì¥
        uploaded_file.seek(0)
        if file_extension == 'pdf':
            import PyPDF2
            pdf_reader = PyPDF2.PdfReader(uploaded_file)
            for page in pdf_reader.pages:
                content += page.extract_text() + "\n"
        elif file_extension == 'docx':
            import docx
            doc = docx.Document(uploaded_file)
            for paragraph in doc.paragraphs:
                content += paragraph.text + "\n"
        elif file_extension == 'pptx':
            from pptx import Presentation
            prs = Presentation(uploaded_file)
            for slide in prs.slides:
                for shape in slide.shapes:
                    if hasattr(shape, "text"):
                        content += shape.text + "\n"
        elif file_extension == 'xlsx':
            import openpyxl
            workbook = openpyxl.load_workbook(uploaded_file, data_only=True)
            for sheet_name in workbook.sheetnames:
                sheet = workbook[sheet_name]
                content += f"=== {sheet_name} ===\n"
                for row in sheet.iter_rows(values_only=True):
                    row_text = '\t'.join([str(cell) if cell is not None else '' for cell in row])
                    if row_text.strip():
                        content += row_text + "\n"
                content += "\n"
        elif file_extension in ['txt', 'md']:
            uploaded_file.seek(0)
            content = uploaded_file.read().decode('utf-8')
        elif file_extension in ['jpg', 'jpeg', 'png', 'gif']:
            content = f"[{file_extension.upper()} ì´ë¯¸ì§€ íŒŒì¼ - {uploaded_file.name}]"
        else:
            try:
                uploaded_file.seek(0)
                content = uploaded_file.read().decode('utf-8', errors='ignore')
                if not content.strip():
                    content = f"[{file_extension.upper()} íŒŒì¼ - í…ìŠ¤íŠ¸ ì¶”ì¶œ ë¶ˆê°€]"
            except:
                content = f"[{file_extension.upper()} íŒŒì¼ - í…ìŠ¤íŠ¸ ì¶”ì¶œ ë¶ˆê°€]"
        return {
            'filename': uploaded_file.name,
            'file_type': file_extension,
            'content': content,
            'binary_data': binary_base64,
            'size': len(binary_data)
        }
    except Exception as e:
        st.error(f"íŒŒì¼ íŒŒì‹± ì˜¤ë¥˜: {str(e)}")
        return None

def save_supplier_file(supplier_id, file_data):
    try:
        connection = connect_to_db()
        if not connection:
            return False
        cursor = connection.cursor()
        cursor.execute("""
            INSERT INTO supplier_files 
            (supplier_id, filename, file_type, file_content, file_binary_data, file_size)
            VALUES (%s, %s, %s, %s, %s, %s)
        """, (
            supplier_id,
            file_data['filename'],
            file_data['file_type'],
            file_data['content'],
            file_data['binary_data'],
            file_data['size']
        ))
        connection.commit()
        cursor.close()
        connection.close()
        return True
    except Exception as e:
        st.error(f"íŒŒì¼ ì €ì¥ ì˜¤ë¥˜: {str(e)}")
        return False

def get_supplier_files(supplier_id):
    try:
        connection = connect_to_db()
        if not connection:
            return []
        cursor = connection.cursor(dictionary=True)
        cursor.execute("""
            SELECT * FROM supplier_files WHERE supplier_id = %s ORDER BY uploaded_at DESC
        """, (supplier_id,))
        files = cursor.fetchall()
        cursor.close()
        connection.close()
        return files
    except Exception as e:
        st.error(f"íŒŒì¼ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜: {str(e)}")
        return []

def get_supplier_file_binary(file_id):
    try:
        connection = connect_to_db()
        if not connection:
            return None
        cursor = connection.cursor(dictionary=True)
        cursor.execute("""
            SELECT filename, file_type, file_binary_data, file_size FROM supplier_files WHERE file_id = %s
        """, (file_id,))
        result = cursor.fetchone()
        cursor.close()
        connection.close()
        return result
    except Exception as e:
        st.error(f"íŒŒì¼ ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜: {str(e)}")
        return None

def get_file_mime_type(file_type):
    mime_types = {
        'pdf': 'application/pdf',
        'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'pptx': 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
        'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'txt': 'text/plain',
        'md': 'text/markdown',
        'jpg': 'image/jpeg',
        'jpeg': 'image/jpeg',
        'png': 'image/png',
        'gif': 'image/gif'
    }
    return mime_types.get(file_type.lower(), 'application/octet-stream')

def display_file_preview(file, file_type, filename):
    try:
        import base64
        file_type_lower = file_type.lower()
        if file_type_lower in ['jpg', 'jpeg', 'png', 'gif']:
            st.image(file['file_binary_data'], caption=f"ğŸ–¼ï¸ {filename}", use_container_width=True)
            return True
        elif file_type_lower == 'pdf':
            pdf_base64 = base64.b64encode(file['file_binary_data']).decode('utf-8')
            pdf_display = f"""
            <iframe src=\"data:application/pdf;base64,{pdf_base64}\" width=\"100%\" height=\"600px\" type=\"application/pdf\"></iframe>
            """
            st.markdown(pdf_display, unsafe_allow_html=True)
            return True
        elif file_type_lower in ['txt', 'md']:
            try:
                text_content = file['file_binary_data'].decode('utf-8')
                if file_type_lower == 'md':
                    st.markdown(text_content)
                else:
                    st.text_area("íŒŒì¼ ë‚´ìš©", value=text_content, height=400, disabled=True)
                return True
            except Exception as e:
                st.error(f"í…ìŠ¤íŠ¸ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
                return False
        # ê¸°íƒ€ íŒŒì¼ì€ ë‹¤ìš´ë¡œë“œë§Œ ì§€ì›
        return False
    except Exception as e:
        st.error(f"íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ì˜¤ë¥˜: {str(e)}")
        return False

if __name__ == "__main__":
    main() 