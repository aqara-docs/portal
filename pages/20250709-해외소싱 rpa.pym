import streamlit as st
import os
import pandas as pd
import mysql.connector
from datetime import datetime, timedelta
import time
import re
import json
import requests
from dotenv import load_dotenv
import concurrent.futures
import threading
import asyncio

# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

# í™˜ê²½ ë³€ìˆ˜ ê°•ì œ ì¬ë¡œë“œ (ë””ë²„ê¹…ìš©)
from pathlib import Path
env_path = Path('.') / '.env'
if env_path.exists():
    load_dotenv(env_path, override=True)

# API í‚¤ ì •ë¦¬ í•¨ìˆ˜
def clean_api_key(api_key):
    """API í‚¤ì—ì„œ ë”°ì˜´í‘œì™€ ê³µë°± ì œê±°"""
    if not api_key:
        return None
    
    # ë”°ì˜´í‘œ ì œê±°
    api_key = api_key.strip().strip("'").strip('"')
    
    # ê³µë°± ì œê±°
    api_key = api_key.strip()
    
    return api_key if api_key else None

def get_perplexity_models(api_key):
    """Perplexity APIì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°"""
    try:
        # Perplexity APIì˜ ì‹¤ì œ ëª¨ë¸ ëª©ë¡ (2024ë…„ ê¸°ì¤€)
        # https://docs.perplexity.ai/guides/model-cards
        current_models = [
            "sonar-pro",
            "sonar-medium-online",
            "sonar-small-online",
            "llama-3.1-sonar-small-128k-online",
            "llama-3.1-sonar-medium-128k-online", 
            "llama-3.1-sonar-large-128k-online",
            "llama-3.1-sonar-small-128k",
            "llama-3.1-sonar-medium-128k",
            "llama-3.1-sonar-large-128k"
        ]
        
        return current_models
            
    except Exception as e:
        return []
    
    return []

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(
    page_title="ğŸ” AI ì œí’ˆ ì†Œì‹± ì‹œìŠ¤í…œ",
    page_icon="ğŸ”",
    layout="wide",
    initial_sidebar_state="expanded"
)

# CSS ìŠ¤íƒ€ì¼ë§
st.markdown("""
<style>
.main-header {
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    padding: 1rem;
    border-radius: 10px;
    text-align: center;
    color: white;
    margin-bottom: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.metric-container {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    border-left: 4px solid #667eea;
    margin: 0.5rem 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.agent-card {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    padding: 1rem;
    border-radius: 10px;
    margin: 0.5rem 0;
    border: 1px solid #e1e5e9;
}

.supplier-card {
    background: white;
    border: 1px solid #e1e5e9;
    border-radius: 8px;
    padding: 1rem;
    margin: 0.5rem 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.search-result {
    background: #f8f9fa;
    border-left: 4px solid #28a745;
    padding: 1rem;
    margin: 0.5rem 0;
    border-radius: 4px;
}
</style>
""", unsafe_allow_html=True)

# ë©”ì¸ í—¤ë”
st.markdown("""
<div class="main-header">
    <h1>ğŸ” AI ì œí’ˆ ì†Œì‹± ì‹œìŠ¤í…œ</h1>
    <p>ì‹¤ì‹œê°„ ì›¹ ê²€ìƒ‰ ê¸°ë°˜ ì œì¡°ì‚¬ ë° ê³µê¸‰ì—…ì²´ ë°œêµ´ ì‹œìŠ¤í…œ</p>
    ğŸ’¡ Perplexity APIë¥¼ í™œìš©í•œ ì •í™•í•œ ì œí’ˆ ì†Œì‹± ë° ê³µê¸‰ì—…ì²´ ê²€ì¦
</div>
""", unsafe_allow_html=True) 

# ì¸ì¦ ê¸°ëŠ¥ (ê°„ë‹¨í•œ ë¹„ë°€ë²ˆí˜¸ ë³´í˜¸)
if 'authenticated' not in st.session_state:
    st.session_state.authenticated = False

admin_pw = os.getenv('ADMIN_PASSWORD')
if not admin_pw:
    st.error('í™˜ê²½ë³€ìˆ˜(ADMIN_PASSWORD)ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. .env íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.')
    st.stop()

if not st.session_state.authenticated:
    password = st.text_input("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”", type="password")
    if password == admin_pw:
        st.session_state.authenticated = True
        st.rerun()
    else:
        if password:  # ë¹„ë°€ë²ˆí˜¸ê°€ ì…ë ¥ëœ ê²½ìš°ì—ë§Œ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
            st.error("ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤")
        st.stop()

# ===== ê°œì„ ëœ ì†Œì‹± í•¨ìˆ˜ë“¤ =====

def generate_smart_search_queries(product_description, target_count=5):
    """ì œí’ˆ ì„¤ëª…ì„ ë°”íƒ•ìœ¼ë¡œ ìŠ¤ë§ˆíŠ¸ ê²€ìƒ‰ ì¿¼ë¦¬ ìƒì„±"""
    queries = []
    
    # ê¸°ë³¸ ê²€ìƒ‰ íŒ¨í„´ë“¤
    search_patterns = [
        f'"{product_description}" manufacturer supplier',
        f'"{product_description}" factory production',
        f'"{product_description}" OEM ODM manufacturer',
        f'"{product_description}" wholesale supplier',
        f'"{product_description}" manufacturer directory',
        f'"{product_description}" manufacturing company',
        f'"{product_description}" supplier list',
        f'"{product_description}" factory China',
        f'"{product_description}" manufacturer Vietnam',
        f'"{product_description}" supplier Korea'
    ]
    
    # ì œí’ˆ í‚¤ì›Œë“œ ì¶”ì¶œ
    keywords = extract_product_keywords(product_description)
    
    # í‚¤ì›Œë“œ ê¸°ë°˜ ì¶”ê°€ ì¿¼ë¦¬
    for keyword in keywords[:3]:  # ìƒìœ„ 3ê°œ í‚¤ì›Œë“œë§Œ ì‚¬ìš©
        queries.extend([
            f'"{keyword}" manufacturer supplier',
            f'"{keyword}" factory production',
            f'"{keyword}" OEM manufacturer'
        ])
    
    # ê¸°ë³¸ íŒ¨í„´ê³¼ í‚¤ì›Œë“œ ì¿¼ë¦¬ ê²°í•©
    all_queries = search_patterns + queries
    
    # ì¤‘ë³µ ì œê±° ë° ìˆœì„œ ì„ê¸°
    unique_queries = list(dict.fromkeys(all_queries))
    
    return unique_queries[:target_count]

def extract_product_keywords(description):
    """ì œí’ˆ ì„¤ëª…ì—ì„œ í•µì‹¬ í‚¤ì›Œë“œ ì¶”ì¶œ"""
    # ë¶ˆìš©ì–´ ì œê±°
    stop_words = {'the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'is', 'are', 'was', 'were', 'be', 'been', 'being', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could', 'should', 'may', 'might', 'must', 'can', 'this', 'that', 'these', 'those', 'i', 'you', 'he', 'she', 'it', 'we', 'they', 'me', 'him', 'her', 'us', 'them', 'my', 'your', 'his', 'her', 'its', 'our', 'their', 'mine', 'yours', 'his', 'hers', 'ours', 'theirs'}
    
    # í…ìŠ¤íŠ¸ ì •ë¦¬
    text = re.sub(r'[^\w\s]', ' ', description.lower())
    words = text.split()
    
    # ë¶ˆìš©ì–´ ì œê±° ë° ê¸¸ì´ í•„í„°ë§
    keywords = [word for word in words if word not in stop_words and len(word) > 2]
    
    # ë¹ˆë„ ê¸°ë°˜ ì •ë ¬ (ê°„ë‹¨í•œ êµ¬í˜„)
    word_freq = {}
    for word in keywords:
        word_freq[word] = word_freq.get(word, 0) + 1
    
    # ë¹ˆë„ìˆœ ì •ë ¬
    sorted_keywords = sorted(word_freq.items(), key=lambda x: x[1], reverse=True)
    
    return [word for word, freq in sorted_keywords[:5]]  # ìƒìœ„ 5ê°œ í‚¤ì›Œë“œ

def verify_perplexity_api_key(api_key):
    """Perplexity API í‚¤ ê²€ì¦ (ê°œì„ ëœ ë²„ì „)"""
    try:
        # API í‚¤ í˜•ì‹ ê²€ì¦
        if not api_key or not api_key.strip():
            return False, "API í‚¤ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤."
        
        api_key = api_key.strip()
        
        # pplx- ì ‘ë‘ì‚¬ í™•ì¸
        if not api_key.startswith('pplx-'):
            return False, f"API í‚¤ê°€ 'pplx-'ë¡œ ì‹œì‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í˜„ì¬: {api_key[:10]}..."
        
        # í‚¤ ê¸¸ì´ í™•ì¸ (pplx- + ìµœì†Œ 20ì)
        if len(api_key) < 25:
            return False, f"API í‚¤ê°€ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤. ê¸¸ì´: {len(api_key)}"
        
        try:
            from openai import OpenAI
            
            # Perplexity API í´ë¼ì´ì–¸íŠ¸ ìƒì„±
            client = OpenAI(
                api_key=api_key,
                base_url="https://api.perplexity.ai"
            )
            
            # í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€
            messages = [
                {
                    "role": "system",
                    "content": "You are a helpful assistant."
                },
                {
                    "role": "user", 
                    "content": "Hello"
                }
            ]
            
            # ì—¬ëŸ¬ ëª¨ë¸ë¡œ í…ŒìŠ¤íŠ¸
            test_models = ["sonar-pro", "sonar-medium-online", "sonar-small-online"]
            
            for test_model in test_models:
                try:
                    response = client.chat.completions.create(
                        model=test_model,
                        messages=messages,
                        max_tokens=10,
                        temperature=0.1
                    )
                    
                    return True, f"API í‚¤ê°€ ìœ íš¨í•©ë‹ˆë‹¤. (ì‘ë™ ëª¨ë¸: {test_model})"
                    
                except Exception as e:
                    error_msg = str(e)
                    
                    if "Invalid model" in error_msg or "model not found" in error_msg.lower():
                        continue  # ë‹¤ìŒ ëª¨ë¸ ì‹œë„
                    elif "authentication" in error_msg.lower() or "unauthorized" in error_msg.lower():
                        return False, "API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (ì¸ì¦ ì‹¤íŒ¨)"
                    elif "rate limit" in error_msg.lower() or "quota" in error_msg.lower():
                        return False, "API ìš”ì²­ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤."
                    else:
                        continue  # ë‹¤ë¥¸ ì˜¤ë¥˜ëŠ” ë‹¤ìŒ ëª¨ë¸ ì‹œë„
            
            # ëª¨ë“  ëª¨ë¸ì—ì„œ ì‹¤íŒ¨í•œ ê²½ìš°
            return False, "ëª¨ë“  í…ŒìŠ¤íŠ¸ ëª¨ë¸ì—ì„œ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
            
        except ImportError:
            return False, "OpenAI ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. 'pip install openai'ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”."
        except Exception as e:
            return False, f"OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì˜¤ë¥˜: {str(e)}"
            
    except requests.exceptions.Timeout:
        return False, "API ìš”ì²­ ì‹œê°„ ì´ˆê³¼"
    except requests.exceptions.ConnectionError:
        return False, "ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì˜¤ë¥˜"
    except Exception as e:
        return False, f"API í‚¤ ê²€ì¦ ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜: {str(e)}"

def search_manufacturers_with_perplexity(product_description, max_results=15):
    """Perplexity APIë¥¼ ì‚¬ìš©í•œ ì œì¡°ì‚¬ ê²€ìƒ‰ (ê°œì„ ëœ ë²„ì „)"""
    try:
        raw_api_key = os.environ.get('PERPLEXITY_API_KEY')
        api_key = clean_api_key(raw_api_key)
        
        if not api_key:
            st.error("âŒ PERPLEXITY_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            if raw_api_key:
                st.caption(f"ì›ë³¸ í‚¤: '{raw_api_key[:30]}...' (ì •ë¦¬ í•„ìš”)")
            return []
        
        # API í‚¤ ê²€ì¦
        is_valid, message = verify_perplexity_api_key(api_key)
        
        if not is_valid:
            st.error(f"âŒ API í‚¤ ê²€ì¦ ì‹¤íŒ¨: {message}")
            return []
        
        st.success("âœ… API í‚¤ ê²€ì¦ ì™„ë£Œ")
        
        # ìŠ¤ë§ˆíŠ¸ ê²€ìƒ‰ ì¿¼ë¦¬ ìƒì„±
        search_queries = generate_smart_search_queries(product_description, target_count=3)
        
        all_suppliers = []
        
        for i, query in enumerate(search_queries):
            try:
                suppliers = execute_single_search(query, api_key, max_results_per_query=5)
                if suppliers:
                    all_suppliers.extend(suppliers)
                    
                    # ì¤‘ë³µ ì œê±°
                    unique_suppliers = remove_duplicate_suppliers(all_suppliers)
                    all_suppliers = unique_suppliers
                    
                    st.success(f"âœ… ì¿¼ë¦¬ {i+1}ì—ì„œ {len(suppliers)}ê°œ ê³µê¸‰ì—…ì²´ ë°œê²¬ (ì´ {len(all_suppliers)}ê°œ)")
                
                # ì ì‹œ ëŒ€ê¸° (API ì œí•œ ë°©ì§€)
                time.sleep(2)
                
            except Exception as e:
                st.warning(f"âš ï¸ ì¿¼ë¦¬ {i+1} ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜: {str(e)}")
                continue
        
        return all_suppliers[:max_results]
        
    except Exception as e:
        st.error(f"âŒ ì œì¡°ì‚¬ ê²€ìƒ‰ ì˜¤ë¥˜: {str(e)}")
        return []

def execute_single_search(query, api_key, max_results_per_query=5):
    """ë‹¨ì¼ ê²€ìƒ‰ ì¿¼ë¦¬ ì‹¤í–‰ (OpenAI í´ë¼ì´ì–¸íŠ¸ ì‚¬ìš©)"""
    try:
        from openai import OpenAI
        
        # Perplexity API í´ë¼ì´ì–¸íŠ¸ ìƒì„±
        client = OpenAI(
            api_key=api_key,
            base_url="https://api.perplexity.ai"
        )
        
        # ë” êµ¬ì²´ì ì´ê³  íš¨ê³¼ì ì¸ í”„ë¡¬í”„íŠ¸
        search_prompt = f"""
You are a professional sourcing agent. Find {max_results_per_query} REAL manufacturing companies for: {query}

CRITICAL REQUIREMENTS:
1. Only find ACTUAL manufacturers, not distributors or trading companies
2. Each company must have a working website
3. Focus on companies that actually produce the requested product
4. Include companies from China, Vietnam, Korea, Taiwan, and other manufacturing countries

For each company, provide information in this EXACT format (copy this format exactly):

COMPANY: [Full Company Name]
WEBSITE: [Complete website URL with http:// or https://]
EMAIL: [Contact email address]
PHONE: [Phone number]
LOCATION: [City, Country]
SPECIALIZATION: [What they manufacture]
COMPANY_TYPE: [Manufacturer/OEM/ODM]
ESTABLISHED: [Year established]
CERTIFICATIONS: [ISO, CE, RoHS, etc.]

EXAMPLE FORMAT:
COMPANY: ABC Electronics Manufacturing Co., Ltd.
WEBSITE: https://www.abcelectronics.com
EMAIL: sales@abcelectronics.com
PHONE: +86-755-1234-5678
LOCATION: Shenzhen, China
SPECIALIZATION: Electronic components and PCB manufacturing
COMPANY_TYPE: Manufacturer
ESTABLISHED: 2010
CERTIFICATIONS: ISO 9001, CE, RoHS

IMPORTANT: 
- Do not include companies without websites
- Do not include companies that are clearly just trading companies
- Focus on companies that actually manufacture the requested product
- Provide real, verifiable information
"""
        
        # ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ë“¤
        test_models = ["sonar-pro", "sonar-medium-online", "sonar-small-online"]
        
        # ê° ëª¨ë¸ë¡œ ì‹œë„
        for model in test_models:
            try:
                response = client.chat.completions.create(
                    model=model,
                    messages=[{"role": "user", "content": search_prompt}],
                    max_tokens=4000,
                    temperature=0.2
                )
                
                content = response.choices[0].message.content
                
                # ì‘ë‹µ íŒŒì‹±
                suppliers = parse_manufacturer_response(content)
                
                if suppliers:
                    return suppliers
                
            except Exception as e:
                error_msg = str(e)
                
                if "Invalid model" in error_msg or "model not found" in error_msg.lower():
                    continue  # ë‹¤ìŒ ëª¨ë¸ ì‹œë„
                elif "authentication" in error_msg.lower() or "unauthorized" in error_msg.lower():
                    st.error("âŒ API í‚¤ ì¸ì¦ ì‹¤íŒ¨")
                    return []
                elif "rate limit" in error_msg.lower() or "quota" in error_msg.lower():
                    st.error("âŒ API ìš”ì²­ í•œë„ ì´ˆê³¼")
                    return []
                else:
                    continue  # ë‹¤ë¥¸ ì˜¤ë¥˜ëŠ” ë‹¤ìŒ ëª¨ë¸ ì‹œë„
        
        # ëª¨ë“  ëª¨ë¸ì—ì„œ ì‹¤íŒ¨í•œ ê²½ìš°
        return []
        
    except ImportError:
        st.error("âŒ OpenAI ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. 'pip install openai'ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.")
        return []
    except Exception as e:
        st.error(f"âŒ ê²€ìƒ‰ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜: {str(e)}")
        return []

def parse_manufacturer_response(raw_text):
    """ì œì¡°ì‚¬ ì‘ë‹µ íŒŒì‹± (ê°œì„ ëœ ë²„ì „)"""
    suppliers = []
    
    try:
        # ë” ìœ ì—°í•œ íŒ¨í„´ ë§¤ì¹­
        patterns = [
            # ì™„ì „í•œ í˜•ì‹
            r'COMPANY:\s*([^\n]+)\s*\nWEBSITE:\s*([^\n]+)\s*\nEMAIL:\s*([^\n]+)\s*\nPHONE:\s*([^\n]+)\s*\nLOCATION:\s*([^\n]+)\s*\nSPECIALIZATION:\s*([^\n]+)\s*\nCOMPANY_TYPE:\s*([^\n]+)\s*\nESTABLISHED:\s*([^\n]+)\s*\nCERTIFICATIONS:\s*([^\n]+)',
            # ê¸°ë³¸ í˜•ì‹
            r'COMPANY:\s*([^\n]+)\s*\nWEBSITE:\s*([^\n]+)\s*\nEMAIL:\s*([^\n]+)\s*\nPHONE:\s*([^\n]+)\s*\nLOCATION:\s*([^\n]+)\s*\nSPECIALIZATION:\s*([^\n]+)',
            # ìµœì†Œ í˜•ì‹
            r'COMPANY:\s*([^\n]+)\s*\nWEBSITE:\s*([^\n]+)\s*\nEMAIL:\s*([^\n]+)\s*\nPHONE:\s*([^\n]+)\s*\nLOCATION:\s*([^\n]+)',
            # íšŒì‚¬ëª…ê³¼ ì›¹ì‚¬ì´íŠ¸ë§Œ
            r'COMPANY:\s*([^\n]+)\s*\nWEBSITE:\s*([^\n]+)'
        ]
        
        for pattern in patterns:
            matches = re.findall(pattern, raw_text, re.MULTILINE | re.IGNORECASE)
            
            for match in matches:
                supplier = {}
                
                if len(match) >= 2:
                    supplier['company_name'] = match[0].strip()
                    supplier['website'] = clean_url(match[1].strip())
                    
                    if len(match) > 2:
                        supplier['email'] = clean_email(match[2].strip())
                    if len(match) > 3:
                        supplier['phone'] = match[3].strip()
                    if len(match) > 4:
                        supplier['location'] = match[4].strip()
                    if len(match) > 5:
                        supplier['specialization'] = match[5].strip()
                    if len(match) > 6:
                        supplier['company_type'] = match[6].strip()
                    if len(match) > 7:
                        supplier['established'] = match[7].strip()
                    if len(match) > 8:
                        supplier['certifications'] = match[8].strip()
                    
                    # ê¸°ë³¸ê°’ ì„¤ì •
                    supplier.setdefault('email', '')
                    supplier.setdefault('phone', '')
                    supplier.setdefault('location', 'Unknown')
                    supplier.setdefault('specialization', 'Manufacturing')
                    supplier.setdefault('company_type', 'Manufacturer')
                    supplier.setdefault('established', 'Unknown')
                    supplier.setdefault('certifications', 'Not specified')
                    
                    # ìœ íš¨ì„± ê²€ì‚¬
                    if is_valid_supplier(supplier):
                        suppliers.append(supplier)
        
        # êµ¬ì¡°í™”ëœ íŒŒì‹±ì´ ì‹¤íŒ¨í•œ ê²½ìš°, í…ìŠ¤íŠ¸ì—ì„œ ì •ë³´ ì¶”ì¶œ
        if not suppliers:
            suppliers = extract_suppliers_from_text(raw_text)
        
        return suppliers
        
    except Exception as e:
        return []

def extract_suppliers_from_text(text):
    """í…ìŠ¤íŠ¸ì—ì„œ ê³µê¸‰ì—…ì²´ ì •ë³´ ì¶”ì¶œ (ë°±ì—… ë°©ë²•)"""
    suppliers = []
    
    try:
        # íšŒì‚¬ëª… íŒ¨í„´ ì°¾ê¸° (ë” í¬ê´„ì )
        company_patterns = [
            r'([A-Z][A-Za-z\s&.,]+(?:Ltd|Limited|Inc|Corp|Corporation|Company|Co|Manufacturing|Factory|Industries|Electronics|Technology|Industrial))',
            r'([A-Z][A-Za-z\s&.,]+(?:Group|International|Global|Trading|Manufacturing))',
            r'([A-Z][A-Za-z\s&.,]+(?:Co\.|Ltd\.|Inc\.|Corp\.))',
            r'([A-Z][A-Za-z\s&.,]+(?:Manufacturing|Factory|Industries))'
        ]
        
        # ì›¹ì‚¬ì´íŠ¸ íŒ¨í„´
        website_pattern = r'https?://[^\s\)\]\},;]+'
        
        # ì´ë©”ì¼ íŒ¨í„´
        email_pattern = r'\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b'
        
        # ì „í™”ë²ˆí˜¸ íŒ¨í„´
        phone_pattern = r'[\+]?[0-9\s\-\(\)]{7,}'
        
        # ìœ„ì¹˜ íŒ¨í„´
        location_pattern = r'([A-Z][a-z]+,\s*[A-Z][a-z]+|[A-Z][a-z]+,\s*[A-Z]{2,3})'
        
        lines = text.split('\n')
        
        current_supplier = {}
        
        for line in lines:
            line = line.strip()
            if not line:
                continue
            
            # íšŒì‚¬ëª… ì°¾ê¸°
            for pattern in company_patterns:
                match = re.search(pattern, line)
                if match:
                    company_name = match.group(1).strip()
                    # ì´ì „ ê³µê¸‰ì—…ì²´ê°€ ì™„ì„±ë˜ë©´ ì €ì¥
                    if current_supplier and current_supplier.get('company_name'):
                        if is_valid_supplier(current_supplier):
                            suppliers.append(current_supplier.copy())
                    # ìƒˆ ê³µê¸‰ì—…ì²´ ì‹œì‘
                    current_supplier = {'company_name': company_name}
                    break
            
            # ì›¹ì‚¬ì´íŠ¸ ì°¾ê¸°
            website_match = re.search(website_pattern, line)
            if website_match:
                current_supplier['website'] = clean_url(website_match.group(0))
            
            # ì´ë©”ì¼ ì°¾ê¸°
            email_match = re.search(email_pattern, line)
            if email_match:
                current_supplier['email'] = email_match.group(0)
            
            # ì „í™”ë²ˆí˜¸ ì°¾ê¸°
            phone_match = re.search(phone_pattern, line)
            if phone_match:
                current_supplier['phone'] = phone_match.group(0)
            
            # ìœ„ì¹˜ ì°¾ê¸°
            location_match = re.search(location_pattern, line)
            if location_match:
                current_supplier['location'] = location_match.group(1)
        
        # ë§ˆì§€ë§‰ ê³µê¸‰ì—…ì²´ ì²˜ë¦¬
        if current_supplier and current_supplier.get('company_name'):
            if is_valid_supplier(current_supplier):
                suppliers.append(current_supplier)
        
        # ê¸°ë³¸ê°’ ì„¤ì •
        for supplier in suppliers:
            supplier.setdefault('email', '')
            supplier.setdefault('phone', '')
            supplier.setdefault('location', 'Unknown')
            supplier.setdefault('specialization', 'Manufacturing')
            supplier.setdefault('company_type', 'Manufacturer')
            supplier.setdefault('established', 'Unknown')
            supplier.setdefault('certifications', 'Not specified')
        
        return suppliers
        
    except Exception as e:
        st.error(f"âŒ í…ìŠ¤íŠ¸ ì¶”ì¶œ ì˜¤ë¥˜: {str(e)}")
        return []

def clean_url(url):
    """URL ì •ë¦¬"""
    if not url:
        return ""
    
    # ë§ˆí¬ë‹¤ìš´ ë§í¬ íŒ¨í„´ ì œê±°
    markdown_pattern = r'\[([^\]]+)\]\(([^)]+)\)'
    markdown_match = re.search(markdown_pattern, url)
    if markdown_match:
        url = markdown_match.group(2)
    
    # URL ëì˜ ë¶ˆí•„ìš”í•œ ë¬¸ì ì œê±°
    url = re.sub(r'[)\]\},;]+$', '', url)
    
    # http:// ë˜ëŠ” https:// ì¶”ê°€
    if url and not url.startswith(('http://', 'https://')):
        if url.startswith('www.'):
            url = f"https://{url}"
        elif '.' in url:
            url = f"https://{url}"
    
    return url

def clean_email(email):
    """ì´ë©”ì¼ ì •ë¦¬"""
    if not email:
        return ""
    
    # ì´ë©”ì¼ íŒ¨í„´ìœ¼ë¡œ ê²€ì¦
    email_pattern = r'\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b'
    match = re.search(email_pattern, email)
    return match.group(0) if match else ""

def is_valid_supplier(supplier):
    """ê³µê¸‰ì—…ì²´ ì •ë³´ ìœ íš¨ì„± ê²€ì‚¬ (ê°œì„ ëœ ë²„ì „)"""
    # ìµœì†Œí•œ íšŒì‚¬ëª…ì´ ìˆì–´ì•¼ í•¨
    if not supplier.get('company_name'):
        return False
    
    # íšŒì‚¬ëª…ì´ ë„ˆë¬´ ì§§ìœ¼ë©´ ì œì™¸
    if len(supplier.get('company_name', '')) < 3:
        return False
    
    # ì›¹ì‚¬ì´íŠ¸ë‚˜ ì´ë©”ì¼ ì¤‘ í•˜ë‚˜ëŠ” ìˆì–´ì•¼ í•¨ (ë” ìœ ì—°í•˜ê²Œ)
    if not supplier.get('website') and not supplier.get('email'):
        return False
    
    # ëª…ë°±íˆ ì˜ëª»ëœ íšŒì‚¬ëª… ì œì™¸
    invalid_names = ['unknown', 'n/a', 'none', 'example', 'sample', 'test']
    company_name_lower = supplier.get('company_name', '').lower()
    if any(invalid in company_name_lower for invalid in invalid_names):
        return False
    
    return True

def remove_duplicate_suppliers(suppliers):
    """ì¤‘ë³µ ê³µê¸‰ì—…ì²´ ì œê±°"""
    seen = set()
    unique_suppliers = []
    
    for supplier in suppliers:
        # íšŒì‚¬ëª…ê³¼ ì›¹ì‚¬ì´íŠ¸ë¡œ ì¤‘ë³µ íŒë‹¨
        key = f"{supplier.get('company_name', '').lower()}_{supplier.get('website', '').lower()}"
        
        if key not in seen:
            seen.add(key)
            unique_suppliers.append(supplier)
    
    return unique_suppliers

def verify_supplier_website(website):
    """ê³µê¸‰ì—…ì²´ ì›¹ì‚¬ì´íŠ¸ ê²€ì¦ (ê°„ë‹¨í•œ ë²„ì „)"""
    if not website:
        return False
    
    try:
        # ê°„ë‹¨í•œ HTTP ìš”ì²­ìœ¼ë¡œ ì›¹ì‚¬ì´íŠ¸ ì¡´ì¬ í™•ì¸
        response = requests.head(website, timeout=5, allow_redirects=True)
        return response.status_code == 200
    except:
        return False

def save_suppliers_to_database(suppliers, search_query, session_id):
    """ê³µê¸‰ì—…ì²´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ (ê°œì„ ëœ ë²„ì „)"""
    try:
        connection = connect_to_db()
        if not connection:
            st.error("âŒ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨")
            return 0
        
        cursor = connection.cursor()
        
        # í…Œì´ë¸” ì¡´ì¬ í™•ì¸ ë° ìƒì„±
        try:
            # ê¸°ì¡´ í…Œì´ë¸”ì´ ìˆëŠ”ì§€ í™•ì¸
            cursor.execute("SHOW TABLES LIKE 'sourcing_suppliers'")
            table_exists = cursor.fetchone()
            
            if table_exists:
                # ê¸°ì¡´ í…Œì´ë¸” ì‚­ì œ (ìŠ¤í‚¤ë§ˆ ë¬¸ì œ í•´ê²°ì„ ìœ„í•´)
                cursor.execute("DROP TABLE sourcing_suppliers")
                connection.commit()
            
            cursor.execute("""
                CREATE TABLE IF NOT EXISTS sourcing_suppliers (
                    id INT AUTO_INCREMENT PRIMARY KEY,
                    company_name VARCHAR(255) NOT NULL,
                    website VARCHAR(500) DEFAULT '',
                    email VARCHAR(255) DEFAULT '',
                    phone VARCHAR(100) DEFAULT '',
                    location VARCHAR(255) DEFAULT '',
                    specialization VARCHAR(500) DEFAULT '',
                    company_type VARCHAR(100) DEFAULT '',
                    established VARCHAR(50) DEFAULT '',
                    certifications VARCHAR(500) DEFAULT '',
                    search_query VARCHAR(1000) DEFAULT '',
                    session_id INT DEFAULT NULL,
                    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                    INDEX idx_company_name (company_name),
                    INDEX idx_search_query (search_query(255)),
                    INDEX idx_session_id (session_id)
                ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
            """)
            connection.commit()
            st.success("âœ… ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸” ì¤€ë¹„ ì™„ë£Œ")
        except Exception as table_error:
            st.error(f"âŒ í…Œì´ë¸” ìƒì„± ì˜¤ë¥˜: {str(table_error)}")
            return 0
        
        saved_count = 0
        failed_count = 0
        
        for i, supplier in enumerate(suppliers):
            try:
                # ì¤‘ë³µ í™•ì¸
                cursor.execute("""
                    SELECT COUNT(*) FROM sourcing_suppliers 
                    WHERE company_name = %s AND website = %s
                """, (supplier.get('company_name', ''), supplier.get('website', '')))
                
                if cursor.fetchone()[0] > 0:
                    st.caption(f"â­ï¸ ì¤‘ë³µ ì œì™¸: {supplier.get('company_name', 'Unknown')}")
                    continue
                
                cursor.execute("""
                    INSERT INTO sourcing_suppliers (
                        company_name, website, email, phone, location, 
                        specialization, company_type, established, certifications,
                        search_query, session_id
                    ) VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
                """, (
                    supplier.get('company_name', ''),
                    supplier.get('website', ''),
                    supplier.get('email', ''),
                    supplier.get('phone', ''),
                    supplier.get('location', ''),
                    supplier.get('specialization', ''),
                    supplier.get('company_type', ''),
                    supplier.get('established', ''),
                    supplier.get('certifications', ''),
                    search_query,
                    session_id
                ))
                saved_count += 1
                
                # ì§„í–‰ë¥  í‘œì‹œ
                if (i + 1) % 5 == 0 or i == len(suppliers) - 1:
                    st.caption(f"ğŸ’¾ ì €ì¥ ì§„í–‰ë¥ : {i+1}/{len(suppliers)}")
                
            except Exception as e:
                failed_count += 1
                st.warning(f"âš ï¸ ê³µê¸‰ì—…ì²´ ì €ì¥ ì‹¤íŒ¨: {supplier.get('company_name', 'Unknown')} - {str(e)}")
                continue
        
        connection.commit()
        cursor.close()
        connection.close()
        
        if saved_count > 0:
            st.success(f"âœ… {saved_count}ê°œ ê³µê¸‰ì—…ì²´ ì €ì¥ ì™„ë£Œ")
        if failed_count > 0:
            st.warning(f"âš ï¸ {failed_count}ê°œ ê³µê¸‰ì—…ì²´ ì €ì¥ ì‹¤íŒ¨")
        
        return saved_count
        
    except Exception as e:
        st.error(f"âŒ ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ì˜¤ë¥˜: {str(e)}")
        return 0

def get_saved_suppliers(session_id=None):
    """ì €ì¥ëœ ê³µê¸‰ì—…ì²´ ì¡°íšŒ"""
    try:
        connection = connect_to_db()
        if not connection:
            return []
        
        cursor = connection.cursor(dictionary=True)
        
        if session_id:
            cursor.execute("""
                SELECT * FROM sourcing_suppliers 
                WHERE session_id = %s 
                ORDER BY created_at DESC
            """, (session_id,))
        else:
            cursor.execute("""
                SELECT * FROM sourcing_suppliers 
                ORDER BY created_at DESC 
                LIMIT 100
            """)
        
        suppliers = cursor.fetchall()
        
        cursor.close()
        connection.close()
        
        return suppliers
        
    except Exception as e:
        st.error(f"âŒ ê³µê¸‰ì—…ì²´ ì¡°íšŒ ì˜¤ë¥˜: {str(e)}")
        return []

# ===== ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í•¨ìˆ˜ =====

def connect_to_db():
    """ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°"""
    try:
        connection = mysql.connector.connect(
            host=os.getenv('SQL_HOST'),
            user=os.getenv('SQL_USER'),
            password=os.getenv('SQL_PASSWORD'),
            database=os.getenv('SQL_DATABASE_NEWBIZ'),
            charset='utf8mb4',
            collation='utf8mb4_unicode_ci'
        )
        return connection
    except mysql.connector.Error as err:
        st.error(f"ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì˜¤ë¥˜: {err}")
        return None

# ===== ë©”ì¸ UI =====

def main():
    """ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜"""
    
    # ì‚¬ì´ë“œë°” ì„¤ì •
    with st.sidebar:
        st.markdown("## ğŸ”§ ì‹œìŠ¤í…œ ìƒíƒœ")
        
        # API í‚¤ ìƒíƒœ í™•ì¸
        raw_perplexity_key = os.environ.get('PERPLEXITY_API_KEY', '')
        perplexity_key = clean_api_key(raw_perplexity_key)
        
        if perplexity_key and len(perplexity_key) > 10:
            st.success("âœ… Perplexity API í‚¤ ì„¤ì •ë¨")
            
            # API í‚¤ ê²€ì¦ ë²„íŠ¼
            if st.button("ğŸ” API í‚¤ ê²€ì¦", key="verify_api_key"):
                with st.spinner("API í‚¤ ê²€ì¦ ì¤‘..."):
                    is_valid, message = verify_perplexity_api_key(perplexity_key)
                    if is_valid:
                        st.success("âœ… API í‚¤ê°€ ìœ íš¨í•©ë‹ˆë‹¤!")
                    else:
                        st.error(f"âŒ API í‚¤ ê²€ì¦ ì‹¤íŒ¨: {message}")
        else:
            st.error("âŒ Perplexity API í‚¤ í•„ìš”")
            
            with st.expander("ğŸ”‘ API í‚¤ ì„¤ì •"):
                temp_key = st.text_input("Perplexity API Key", type="password")
                if st.button("ì„ì‹œ í‚¤ ì„¤ì •"):
                    if temp_key.strip():
                        cleaned_key = clean_api_key(temp_key)
                        os.environ['PERPLEXITY_API_KEY'] = cleaned_key
                        st.success("âœ… API í‚¤ ì„¤ì •ë¨")
                        st.rerun()
                
                st.caption("ğŸ’¡ API í‚¤ ë°œê¸‰ ë°©ë²•:")
                st.caption("1. https://www.perplexity.ai/settings/api ë°©ë¬¸")
                st.caption("2. ë¡œê·¸ì¸ í›„ API í‚¤ ìƒì„±")
                st.caption("3. í‚¤ëŠ” 'pplx-'ë¡œ ì‹œì‘í•´ì•¼ í•¨")
        
        # ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ
        try:
            connection = connect_to_db()
            if connection:
                st.success("âœ… ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ë¨")
                connection.close()
            else:
                st.error("âŒ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨")
        except:
            st.error("âŒ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨")
        
        st.markdown("---")
        st.markdown("## ğŸ“Š ì‚¬ìš© í†µê³„")
        
        # ì €ì¥ëœ ê³µê¸‰ì—…ì²´ ìˆ˜
        try:
            connection = connect_to_db()
            if connection:
                cursor = connection.cursor()
                cursor.execute("SELECT COUNT(*) FROM sourcing_suppliers")
                total_suppliers = cursor.fetchone()[0]
                st.metric("ì´ ê³µê¸‰ì—…ì²´", total_suppliers)
                
                cursor.execute("SELECT COUNT(*) FROM sourcing_suppliers WHERE created_at >= DATE_SUB(NOW(), INTERVAL 1 DAY)")
                today_suppliers = cursor.fetchone()[0]
                st.metric("ì˜¤ëŠ˜ ë°œê²¬", today_suppliers)
                
                cursor.close()
                connection.close()
        except:
            st.metric("ì´ ê³µê¸‰ì—…ì²´", "í™•ì¸ ë¶ˆê°€")
    
    # ë©”ì¸ íƒ­ êµ¬ì„±
    tab1, tab2, tab3 = st.tabs(["ğŸ” ì œí’ˆ ì†Œì‹±", "ğŸ“‹ ë°œê²¬ëœ ê³µê¸‰ì—…ì²´", "ğŸ“Š ë¶„ì„ ê²°ê³¼"])
    
    # ===== íƒ­ 1: ì œí’ˆ ì†Œì‹± =====
    with tab1:
        st.markdown("## ğŸ” ì œí’ˆ ì†Œì‹± ê²€ìƒ‰")
        
        # ê²€ìƒ‰ ì˜ˆì‹œ
        with st.expander("ğŸ’¡ ê²€ìƒ‰ ì˜ˆì‹œ ë° íŒ", expanded=False):
            st.markdown("""
            **íš¨ê³¼ì ì¸ ê²€ìƒ‰ ì˜ˆì‹œ:**
            - "LED ì¡°ëª… ì œì¡°ì—…ì²´"
            - "ìŠ¤ë§ˆíŠ¸í° ì¼€ì´ìŠ¤ ê³µì¥"
            - "ì „ì ë¶€í’ˆ ì œì¡°ì‚¬"
            - "ì˜ë¥˜ ì œì¡°ì—…ì²´"
            - "ê¸°ê³„ ë¶€í’ˆ ê³µê¸‰ì—…ì²´"
            
            **ê²€ìƒ‰ íŒ:**
            - êµ¬ì²´ì ì¸ ì œí’ˆëª… ì‚¬ìš©
            - "ì œì¡°ì—…ì²´", "ê³µì¥", "ì œì¡°ì‚¬" í‚¤ì›Œë“œ ì¶”ê°€
            - ì˜ì–´ í‚¤ì›Œë“œ í˜¼ìš©: "LED lighting manufacturer"
            - ì¬ì§ˆ ëª…ì‹œ: "í”Œë¼ìŠ¤í‹± ì¼€ì´ìŠ¤ ì œì¡°ì—…ì²´"
            """)
        
        # ê²€ìƒ‰ í¼
        with st.form("sourcing_form"):
            col1, col2 = st.columns([2, 1])
            
            with col1:
                product_description = st.text_area(
                    "ì œí’ˆ ì„¤ëª…ì„ ìƒì„¸íˆ ì…ë ¥í•˜ì„¸ìš”:",
                    placeholder="ì˜ˆ: LED ì¡°ëª… ì œì¡°ì—…ì²´, ìŠ¤ë§ˆíŠ¸í° ì¼€ì´ìŠ¤ ê³µì¥, ì „ì ë¶€í’ˆ ì œì¡°ì‚¬ ë“±",
                    height=100,
                    help="êµ¬ì²´ì ìœ¼ë¡œ ì–´ë–¤ ì œí’ˆì„ ì°¾ê³  ìˆëŠ”ì§€ ì„¤ëª…í•´ì£¼ì„¸ìš”."
                )
                
                search_options = st.multiselect(
                    "ê²€ìƒ‰ ì§€ì—­:",
                    ["ì¤‘êµ­", "ë² íŠ¸ë‚¨", "í•œêµ­", "ëŒ€ë§Œ", "ì¼ë³¸", "ì¸ë„", "íƒœêµ­"],
                    default=["ì¤‘êµ­", "ë² íŠ¸ë‚¨"],
                    help="ì–´ëŠ ì§€ì—­ì˜ ì œì¡°ì‚¬ë¥¼ ì°¾ì„ì§€ ì„ íƒí•˜ì„¸ìš”"
                )
            
            with col2:
                max_results = st.slider("ìµœëŒ€ ê²°ê³¼ ìˆ˜", 5, 30, 15, help="ì°¾ì„ ê³µê¸‰ì—…ì²´ì˜ ìµœëŒ€ ê°œìˆ˜")
                
                search_depth = st.selectbox(
                    "ê²€ìƒ‰ ê¹Šì´:",
                    ["ê¸°ë³¸ (ë¹ ë¦„)", "ìƒì„¸ (ë³´í†µ)", "í¬ê´„ (ëŠë¦¼)"],
                    help="ê²€ìƒ‰ ê¹Šì´ê°€ ê¹Šì„ìˆ˜ë¡ ë” ë§ì€ ê²°ê³¼ë¥¼ ì°¾ì§€ë§Œ ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦½ë‹ˆë‹¤"
                )
                
                st.markdown("### ğŸ” ê²€ìƒ‰ íŒ")
                st.markdown("""
                **íš¨ê³¼ì ì¸ ê²€ìƒ‰ì„ ìœ„í•œ íŒ:**
                - êµ¬ì²´ì ì¸ ì œí’ˆëª… ì‚¬ìš©
                - ì¬ì§ˆì´ë‚˜ ê·œê²© ëª…ì‹œ
                - ìš©ë„ë‚˜ íŠ¹ì„± í¬í•¨
                - ì˜ì–´ í‚¤ì›Œë“œ í˜¼ìš©
                """)
            
            submitted = st.form_submit_button("ğŸ” ì œí’ˆ ì†Œì‹± ì‹œì‘", type="primary")
        
        # ê²€ìƒ‰ ì‹¤í–‰
        if submitted:
            if not product_description.strip():
                st.error("âŒ ì œí’ˆ ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
            else:
                # ì„¸ì…˜ ID ìƒì„±
                session_id = int(time.time())
                
                with st.spinner("ğŸ” ì œí’ˆ ì†Œì‹± ì¤‘..."):
                    # ê²€ìƒ‰ ì¿¼ë¦¬ ìƒì„±
                    base_query = product_description
                    if search_options:
                        regions = " ".join(search_options)
                        base_query = f"{product_description} {regions}"
                    
                    # ê²€ìƒ‰ ì‹¤í–‰
                    suppliers = search_manufacturers_with_perplexity(base_query, max_results)
                    
                    if suppliers:
                        st.success(f"ğŸ‰ {len(suppliers)}ê°œì˜ ê³µê¸‰ì—…ì²´ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤!")
                        
                        # ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
                        saved_count = save_suppliers_to_database(suppliers, base_query, session_id)
                        if saved_count > 0:
                            st.success(f"ğŸ’¾ {saved_count}ê°œ ê³µê¸‰ì—…ì²´ê°€ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
                        
                        # ì„¸ì…˜ ID ì €ì¥
                        st.session_state.last_session_id = session_id
                        
                        # ê²°ê³¼ í‘œì‹œ
                        display_suppliers(suppliers)
                        
                    else:
                        st.warning("âš ï¸ ê²€ìƒ‰ ì¡°ê±´ì— ë§ëŠ” ê³µê¸‰ì—…ì²´ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
                        
                        with st.expander("ğŸ”§ ê²€ìƒ‰ ê°œì„  ì œì•ˆ"):
                            st.markdown("""
                            **ë” ë‚˜ì€ ê²°ê³¼ë¥¼ ìœ„í•œ ì œì•ˆ:**
                            1. **ë” êµ¬ì²´ì ì¸ ì œí’ˆëª… ì‚¬ìš©**: "ìŠ¤ë§ˆíŠ¸í° ì¼€ì´ìŠ¤" â†’ "iPhone 15 Pro ì¼€ì´ìŠ¤"
                            2. **ì˜ì–´ í‚¤ì›Œë“œ ì¶”ê°€**: "LED ì¡°ëª…" â†’ "LED lighting manufacturer"
                            3. **ì¬ì§ˆ ëª…ì‹œ**: "í”Œë¼ìŠ¤í‹± ì¼€ì´ìŠ¤", "ì‹¤ë¦¬ì½˜ ì¼€ì´ìŠ¤"
                            4. **ìš©ë„ í¬í•¨**: "ìë™ì°¨ìš© LED", "ê°€ì •ìš© ì¡°ëª…"
                            5. **ê·œê²© ì¶”ê°€**: "5V LED", "12V ì „ì› ê³µê¸‰ê¸°"
                            """)
    
    # ===== íƒ­ 2: ë°œê²¬ëœ ê³µê¸‰ì—…ì²´ =====
    with tab2:
        st.markdown("## ğŸ“‹ ë°œê²¬ëœ ê³µê¸‰ì—…ì²´ ëª©ë¡")
        
        # í•„í„°ë§ ì˜µì…˜
        col1, col2, col3 = st.columns(3)
        
        with col1:
            search_filter = st.text_input("ğŸ” ê³µê¸‰ì—…ì²´ëª… ê²€ìƒ‰", placeholder="íšŒì‚¬ëª…ìœ¼ë¡œ ê²€ìƒ‰")
        
        with col2:
            location_filter = st.selectbox("ğŸŒ ì§€ì—­ í•„í„°", ["ì „ì²´", "ì¤‘êµ­", "ë² íŠ¸ë‚¨", "í•œêµ­", "ëŒ€ë§Œ", "ì¼ë³¸", "ì¸ë„", "ê¸°íƒ€"])
        
        with col3:
            sort_by = st.selectbox("ğŸ”„ ì •ë ¬", ["ìµœì‹ ìˆœ", "íšŒì‚¬ëª…ìˆœ", "ì§€ì—­ìˆœ"])
        
        # ê³µê¸‰ì—…ì²´ ì¡°íšŒ
        suppliers = get_saved_suppliers()
        
        if suppliers:
            # í•„í„°ë§
            filtered_suppliers = suppliers
            
            if search_filter:
                filtered_suppliers = [
                    s for s in filtered_suppliers 
                    if search_filter.lower() in s.get('company_name', '').lower()
                ]
            
            if location_filter != "ì „ì²´":
                filtered_suppliers = [
                    s for s in filtered_suppliers 
                    if location_filter.lower() in s.get('location', '').lower()
                ]
            
            # ì •ë ¬
            if sort_by == "íšŒì‚¬ëª…ìˆœ":
                filtered_suppliers.sort(key=lambda x: x.get('company_name', ''))
            elif sort_by == "ì§€ì—­ìˆœ":
                filtered_suppliers.sort(key=lambda x: x.get('location', ''))
            else:  # ìµœì‹ ìˆœ
                filtered_suppliers.sort(key=lambda x: x.get('created_at', ''), reverse=True)
            
            st.success(f"ğŸ“Š ì´ {len(filtered_suppliers)}ê°œì˜ ê³µê¸‰ì—…ì²´ê°€ ìˆìŠµë‹ˆë‹¤.")
            
            # ê³µê¸‰ì—…ì²´ ëª©ë¡ í‘œì‹œ
            for i, supplier in enumerate(filtered_suppliers):
                company_name = supplier.get('company_name', 'Unknown Company')
                
                with st.expander(f"ğŸ¢ {company_name}"):
                    display_supplier_card(supplier, i)
        
        else:
            st.info("ğŸ” ì•„ì§ ë°œê²¬ëœ ê³µê¸‰ì—…ì²´ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì œí’ˆ ì†Œì‹±ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.")
    
    # ===== íƒ­ 3: ë¶„ì„ ê²°ê³¼ =====
    with tab3:
        st.markdown("## ğŸ“Š ì†Œì‹± ë¶„ì„ ê²°ê³¼")
        
        suppliers = get_saved_suppliers()
        
        if suppliers:
            # í†µê³„ ë¶„ì„
            col1, col2, col3, col4 = st.columns(4)
            
            with col1:
                st.metric("ì´ ê³µê¸‰ì—…ì²´", len(suppliers))
            
            with col2:
                # ì§€ì—­ë³„ í†µê³„
                locations = [s.get('location', 'Unknown') for s in suppliers]
                china_count = sum(1 for loc in locations if 'china' in loc.lower())
                st.metric("ì¤‘êµ­ ì—…ì²´", china_count)
            
            with col3:
                vietnam_count = sum(1 for loc in locations if 'vietnam' in loc.lower())
                st.metric("ë² íŠ¸ë‚¨ ì—…ì²´", vietnam_count)
            
            with col4:
                korea_count = sum(1 for loc in locations if 'korea' in loc.lower())
                st.metric("í•œêµ­ ì—…ì²´", korea_count)
            
            # ì§€ì—­ë³„ ë¶„í¬ ì°¨íŠ¸
            st.markdown("### ğŸŒ ì§€ì—­ë³„ ê³µê¸‰ì—…ì²´ ë¶„í¬")
            
            location_counts = {}
            for supplier in suppliers:
                location = supplier.get('location', 'Unknown')
                # êµ­ê°€ ì¶”ì¶œ
                country = extract_country(location)
                location_counts[country] = location_counts.get(country, 0) + 1
            
            if location_counts:
                df_location = pd.DataFrame(list(location_counts.items()), columns=['êµ­ê°€', 'ì—…ì²´ ìˆ˜'])
                st.bar_chart(df_location.set_index('êµ­ê°€'))
            
            # íšŒì‚¬ ìœ í˜•ë³„ ë¶„ì„
            st.markdown("### ğŸ­ íšŒì‚¬ ìœ í˜•ë³„ ë¶„ì„")
            
            company_types = [s.get('company_type', 'Unknown') for s in suppliers]
            type_counts = {}
            for company_type in company_types:
                type_counts[company_type] = type_counts.get(company_type, 0) + 1
            
            if type_counts:
                df_types = pd.DataFrame(list(type_counts.items()), columns=['íšŒì‚¬ ìœ í˜•', 'ì—…ì²´ ìˆ˜'])
                st.bar_chart(df_types.set_index('íšŒì‚¬ ìœ í˜•'))
            
            # ìµœê·¼ ë°œê²¬ ì¶”ì´
            st.markdown("### ğŸ“ˆ ìµœê·¼ ë°œê²¬ ì¶”ì´")
            
            try:
                connection = connect_to_db()
                if connection:
                    cursor = connection.cursor()
                    cursor.execute("""
                        SELECT DATE(created_at) as date, COUNT(*) as count 
                        FROM sourcing_suppliers 
                        WHERE created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
                        GROUP BY DATE(created_at)
                        ORDER BY date
                    """)
                    
                    daily_data = cursor.fetchall()
                    cursor.close()
                    connection.close()
                    
                    if daily_data:
                        df_daily = pd.DataFrame(daily_data, columns=['ë‚ ì§œ', 'ë°œê²¬ ìˆ˜'])
                        st.line_chart(df_daily.set_index('ë‚ ì§œ'))
                    
            except Exception as e:
                st.warning(f"âš ï¸ ì¼ë³„ í†µê³„ ì¡°íšŒ ì‹¤íŒ¨: {str(e)}")
        
        else:
            st.info("ğŸ“Š ë¶„ì„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì œí’ˆ ì†Œì‹±ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.")

def display_suppliers(suppliers):
    """ê³µê¸‰ì—…ì²´ ëª©ë¡ í‘œì‹œ"""
    st.markdown("### ğŸ¢ ë°œê²¬ëœ ê³µê¸‰ì—…ì²´")
    
    for i, supplier in enumerate(suppliers, 1):
        # ê³ ìœ í•œ í‚¤ ìƒì„±
        company_name = supplier.get('company_name', 'Unknown Company')
        
        with st.expander(f"{i}. {company_name}"):
            display_supplier_card(supplier, i)

def display_supplier_card(supplier, index=None):
    """ê°œë³„ ê³µê¸‰ì—…ì²´ ì¹´ë“œ í‘œì‹œ"""
    col1, col2 = st.columns([2, 1])
    
    with col1:
        st.markdown(f"**ğŸ¢ íšŒì‚¬ëª…:** {supplier.get('company_name', 'N/A')}")
        
        if supplier.get('website'):
            st.markdown(f"**ğŸŒ ì›¹ì‚¬ì´íŠ¸:** [{supplier['website']}]({supplier['website']})")
        
        if supplier.get('email'):
            st.markdown(f"**ğŸ“§ ì´ë©”ì¼:** {supplier['email']}")
        
        if supplier.get('phone'):
            st.markdown(f"**ğŸ“ ì „í™”ë²ˆí˜¸:** {supplier['phone']}")
        
        if supplier.get('location'):
            st.markdown(f"**ğŸ“ ìœ„ì¹˜:** {supplier['location']}")
        
        if supplier.get('specialization'):
            st.markdown(f"**ğŸ­ ì „ë¬¸ë¶„ì•¼:** {supplier['specialization']}")
    
    with col2:
        if supplier.get('company_type'):
            st.markdown(f"**ğŸ¢ ìœ í˜•:** {supplier['company_type']}")
        
        if supplier.get('established'):
            st.markdown(f"**ğŸ“… ì„¤ë¦½:** {supplier['established']}")
        
        if supplier.get('certifications'):
            st.markdown(f"**âœ… ì¸ì¦:** {supplier['certifications']}")
        
        # ì›¹ì‚¬ì´íŠ¸ ê²€ì¦ ë²„íŠ¼
        if supplier.get('website'):
            # ê³ ìœ í•œ í‚¤ ìƒì„± (ì¸ë±ìŠ¤ + íšŒì‚¬ëª… + ID ì‚¬ìš©)
            company_name = supplier.get('company_name', 'Unknown')
            supplier_id = supplier.get('id', 'unknown')
            index_str = f"idx_{index}" if index is not None else "no_idx"
            # ì•ˆì „í•œ í‚¤ ìƒì„± (íŠ¹ìˆ˜ë¬¸ì ì œê±° ë° ê¸¸ì´ ì œí•œ)
            safe_company_name = re.sub(r'[^a-zA-Z0-9]', '_', company_name)[:20]
            unique_key = f"verify_{index_str}_{safe_company_name}_{supplier_id}"[:50]
            
            if st.button(f"ğŸ” ì›¹ì‚¬ì´íŠ¸ í™•ì¸", key=unique_key):
                is_valid = verify_supplier_website(supplier['website'])
                if is_valid:
                    st.success("âœ… ì›¹ì‚¬ì´íŠ¸ ì ‘ì† ê°€ëŠ¥")
                else:
                    st.error("âŒ ì›¹ì‚¬ì´íŠ¸ ì ‘ì† ë¶ˆê°€")

def extract_country(location):
    """ìœ„ì¹˜ì—ì„œ êµ­ê°€ ì¶”ì¶œ"""
    if not location:
        return "Unknown"
    
    location_lower = location.lower()
    
    country_mapping = {
        'china': 'ì¤‘êµ­',
        'chinese': 'ì¤‘êµ­',
        'vietnam': 'ë² íŠ¸ë‚¨',
        'vietnamese': 'ë² íŠ¸ë‚¨',
        'korea': 'í•œêµ­',
        'korean': 'í•œêµ­',
        'taiwan': 'ëŒ€ë§Œ',
        'japan': 'ì¼ë³¸',
        'japanese': 'ì¼ë³¸',
        'india': 'ì¸ë„',
        'indian': 'ì¸ë„',
        'thailand': 'íƒœêµ­',
        'thai': 'íƒœêµ­',
        'malaysia': 'ë§ë ˆì´ì‹œì•„',
        'indonesia': 'ì¸ë„ë„¤ì‹œì•„',
        'philippines': 'í•„ë¦¬í•€',
        'singapore': 'ì‹±ê°€í¬ë¥´'
    }
    
    for english, korean in country_mapping.items():
        if english in location_lower:
            return korean
    
    return "ê¸°íƒ€"

# í‘¸í„°
st.markdown("---")
st.markdown("""
<div style='text-align: center; color: #666; padding: 20px;'>
    <p>ğŸ” <strong>AI ì œí’ˆ ì†Œì‹± ì‹œìŠ¤í…œ</strong></p>
    <p>ì‹¤ì‹œê°„ ì›¹ ê²€ìƒ‰ ê¸°ë°˜ ì œì¡°ì‚¬ ë° ê³µê¸‰ì—…ì²´ ë°œêµ´ | Powered by Perplexity AI</p>
</div>
""", unsafe_allow_html=True)

if __name__ == "__main__":
    main() 