import streamlit as st
import os
from datetime import datetime
import time
import random
from dotenv import load_dotenv
from openai import OpenAI
import anthropic
from langchain_anthropic import ChatAnthropic
import json
import asyncio
import threading
from concurrent.futures import ThreadPoolExecutor, as_completed

# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(
    page_title="ğŸ¢ ê°€ìƒíšŒì‚¬ C-Level ë©€í‹°ì—ì´ì „íŠ¸",
    page_icon="ğŸ¢",
    layout="wide"
)

# ìŠ¤íƒ€ì¼ë§
st.markdown("""
<style>
.persona-card {
    background: linear-gradient(145deg, #f0f2f6, #ffffff);
    border-radius: 15px;
    padding: 20px;
    margin: 10px 0;
    box-shadow: 5px 5px 15px #d1d9e6, -5px -5px 15px #ffffff;
    border-left: 5px solid #0066cc;
}

.persona-header {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
}

.persona-emoji {
    font-size: 2.5rem;
    margin-right: 15px;
}

.persona-title {
    color: #0066cc;
    font-size: 1.3rem;
    font-weight: bold;
    margin: 0;
}

.persona-subtitle {
    color: #666;
    font-size: 0.9rem;
    margin: 0;
}

.result-container {
    background: linear-gradient(145deg, #f8f9fa, #ffffff);
    border-radius: 12px;
    padding: 20px;
    margin: 15px 0;
    border-left: 4px solid #28a745;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.result-container h4 {
    color: #28a745;
    margin: 0;
    font-size: 1.1rem;
}

.ceo-final {
    background: linear-gradient(145deg, #fff3cd, #ffeaa7);
    border-left: 4px solid #f39c12;
    border-radius: 15px;
    padding: 20px;
    margin: 20px 0;
    box-shadow: 0 4px 15px rgba(243, 156, 18, 0.2);
}

.progress-indicator {
    background: linear-gradient(145deg, #0066cc, #0052a3);
    color: white;
    text-align: center;
    padding: 15px 20px;
    border-radius: 12px;
    margin: 15px 0;
    box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);
    border: none;
}

.progress-indicator strong {
    font-size: 1.1rem;
    font-weight: 600;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
}

.progress-section {
    background: #f8f9fa;
    border-radius: 15px;
    padding: 25px;
    margin: 20px 0;
    border: 2px solid #e9ecef;
}

.progress-section h2 {
    color: #0066cc;
    text-align: center;
    margin-bottom: 20px;
    font-size: 1.5rem;
}

.analysis-complete {
    background: linear-gradient(145deg, #d4edda, #c3e6cb);
    border: 2px solid #28a745;
    border-radius: 12px;
    padding: 15px;
    margin: 10px 0;
    text-align: center;
}

.analysis-complete h4 {
    color: #155724;
    margin: 0;
    font-size: 1.1rem;
}

.ceo-synthesis {
    background: linear-gradient(145deg, #ffeaa7, #fdcb6e);
    border: 2px solid #f39c12;
    border-radius: 12px;
    padding: 20px;
    margin: 15px 0;
    text-align: center;
}

.ceo-synthesis strong {
    color: #8e5b00;
    font-size: 1.2rem;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
}

.main-title {
    text-align: center;
    color: #0066cc;
    margin-bottom: 10px;
}

.main-subtitle {
    text-align: center;
    color: #666;
    font-size: 1.1rem;
    margin-bottom: 30px;
}
</style>
""", unsafe_allow_html=True)

# C-Level í˜ë¥´ì†Œë‚˜ ì •ì˜
PERSONAS = {
    "CTO": {
        "name": "Chief Technology Officer",
        "emoji": "ğŸ’»",
        "role": "ê¸°ìˆ  ì „ëµ ë° í˜ì‹  ì±…ì„ì",
        "expertise": "ê¸°ìˆ  ì•„í‚¤í…ì²˜, ê°œë°œ ì „ëµ, í˜ì‹ , ë””ì§€í„¸ ì „í™˜",
        "perspective": "ê¸°ìˆ ì  íƒ€ë‹¹ì„±, êµ¬í˜„ ê°€ëŠ¥ì„±, ê¸°ìˆ  íŠ¸ë Œë“œ, ë³´ì•ˆ, í™•ì¥ì„±ì„ ì¤‘ì‹¬ìœ¼ë¡œ ë¶„ì„",
        "system_prompt": """ë‹¹ì‹ ì€ ê²½í—˜ì´ í’ë¶€í•œ CTO(Chief Technology Officer)ì…ë‹ˆë‹¤. 
ê¸°ìˆ  ì „ëµ, ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜, ê°œë°œ ë°©ë²•ë¡ , ë³´ì•ˆ, í™•ì¥ì„± ê´€ì ì—ì„œ ë¶„ì„í•˜ê³  ì¡°ì–¸í•©ë‹ˆë‹¤.
í•­ìƒ ê¸°ìˆ ì  íƒ€ë‹¹ì„±ê³¼ êµ¬í˜„ ê°€ëŠ¥ì„±ì„ ìš°ì„ ì ìœ¼ë¡œ ê³ ë ¤í•˜ë©°, ìµœì‹  ê¸°ìˆ  íŠ¸ë Œë“œë¥¼ ë°˜ì˜í•©ë‹ˆë‹¤.
ì‹¤ìš©ì ì´ê³  êµ¬ì²´ì ì¸ ê¸°ìˆ  ì†”ë£¨ì…˜ì„ ì œì‹œí•©ë‹ˆë‹¤."""
    },
    "CSO_Strategy": {
        "name": "Chief Strategy Officer",
        "emoji": "ğŸ¯",
        "role": "ì „ëµ ê¸°íš ë° ì‚¬ì—… ê°œë°œ ì±…ì„ì",
        "expertise": "ì‚¬ì—… ì „ëµ, ì‹œì¥ ë¶„ì„, ê²½ìŸ ë¶„ì„, ì„±ì¥ ì „ëµ",
        "perspective": "ì‹œì¥ ê¸°íšŒ, ê²½ìŸ ìš°ìœ„, ì„±ì¥ ì ì¬ë ¥, ë¦¬ìŠ¤í¬ ë¶„ì„ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì „ëµì  ê´€ì  ì œì‹œ",
        "system_prompt": """ë‹¹ì‹ ì€ ì „ëµì  ì‚¬ê³ ê°€ ë›°ì–´ë‚œ CSO(Chief Strategy Officer)ì…ë‹ˆë‹¤.
ì‹œì¥ ë¶„ì„, ê²½ìŸ ë¶„ì„, ì‚¬ì—… ëª¨ë¸, ì„±ì¥ ì „ëµì„ ì „ë¬¸ìœ¼ë¡œ í•©ë‹ˆë‹¤.
ì¥ê¸°ì  ê´€ì ì—ì„œ ì „ëµì  ê¸°íšŒì™€ ìœ„í—˜ì„ í‰ê°€í•˜ê³ , ì§€ì† ê°€ëŠ¥í•œ ì„±ì¥ ë°©ì•ˆì„ ì œì‹œí•©ë‹ˆë‹¤.
ë°ì´í„° ê¸°ë°˜ì˜ ë…¼ë¦¬ì ì´ê³  ì²´ê³„ì ì¸ ì „ëµì„ ìˆ˜ë¦½í•©ë‹ˆë‹¤."""
    },
    "CMO": {
        "name": "Chief Marketing Officer",
        "emoji": "ğŸ“¢",
        "role": "ë§ˆì¼€íŒ… ë° ë¸Œëœë“œ ì „ëµ ì±…ì„ì",
        "expertise": "ë¸Œëœë“œ ì „ëµ, ê³ ê° ê²½í—˜, ë””ì§€í„¸ ë§ˆì¼€íŒ…, ì‹œì¥ ì¡°ì‚¬",
        "perspective": "ê³ ê° ë‹ˆì¦ˆ, ë¸Œëœë“œ í¬ì§€ì…”ë‹, ë§ˆì¼€íŒ… ì±„ë„, ê³ ê° ê²½í—˜ì„ ì¤‘ì‹¬ìœ¼ë¡œ ë¶„ì„",
        "system_prompt": """ë‹¹ì‹ ì€ ì°½ì˜ì ì´ê³  ê³ ê° ì¤‘ì‹¬ì ì¸ CMO(Chief Marketing Officer)ì…ë‹ˆë‹¤.
ë¸Œëœë“œ ì „ëµ, ê³ ê° ê²½í—˜, ë§ˆì¼€íŒ… ìº í˜ì¸, ì‹œì¥ í¬ì§€ì…”ë‹ì„ ì „ë¬¸ìœ¼ë¡œ í•©ë‹ˆë‹¤.
ê³ ê°ì˜ ê´€ì ì—ì„œ ê°€ì¹˜ë¥¼ ì°½ì¶œí•˜ê³ , íš¨ê³¼ì ì¸ ë§ˆì¼€íŒ… ì „ëµì„ ìˆ˜ë¦½í•©ë‹ˆë‹¤.
ë°ì´í„° ê¸°ë°˜ ë§ˆì¼€íŒ…ê³¼ ì°½ì˜ì  ì•„ì´ë””ì–´ë¥¼ ê²°í•©í•©ë‹ˆë‹¤."""
    },
    "CFO": {
        "name": "Chief Financial Officer",
        "emoji": "ğŸ’°",
        "role": "ì¬ë¬´ ì „ëµ ë° ë¦¬ìŠ¤í¬ ê´€ë¦¬ ì±…ì„ì",
        "expertise": "ì¬ë¬´ ë¶„ì„, íˆ¬ì í‰ê°€, ë¦¬ìŠ¤í¬ ê´€ë¦¬, ìˆ˜ìµì„± ë¶„ì„",
        "perspective": "ì¬ë¬´ì  íƒ€ë‹¹ì„±, íˆ¬ì ìˆ˜ìµë¥ , ë¹„ìš© íš¨ìœ¨ì„±, ë¦¬ìŠ¤í¬ ê´€ë¦¬ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ë¶„ì„",
        "system_prompt": """ë‹¹ì‹ ì€ ì‹ ì¤‘í•˜ê³  ë¶„ì„ì ì¸ CFO(Chief Financial Officer)ì…ë‹ˆë‹¤.
ì¬ë¬´ ë¶„ì„, íˆ¬ì í‰ê°€, ì˜ˆì‚° ê³„íš, ë¦¬ìŠ¤í¬ ê´€ë¦¬ë¥¼ ì „ë¬¸ìœ¼ë¡œ í•©ë‹ˆë‹¤.
ëª¨ë“  ê²°ì •ì„ ì¬ë¬´ì  ê´€ì ì—ì„œ í‰ê°€í•˜ê³ , ìˆ˜ìµì„±ê³¼ ì§€ì†ê°€ëŠ¥ì„±ì„ ì¤‘ì‹œí•©ë‹ˆë‹¤.
ì •í™•í•œ ìˆ˜ì¹˜ ë¶„ì„ê³¼ ì‹ ì¤‘í•œ ì¬ë¬´ ì „ëµì„ ì œì‹œí•©ë‹ˆë‹¤."""
    },
    "CSO_Sales": {
        "name": "Chief Sales Officer",
        "emoji": "ğŸ¤",
        "role": "ì˜ì—… ì „ëµ ë° ê³ ê° ê´€ê³„ ì±…ì„ì",
        "expertise": "ì˜ì—… ì „ëµ, ê³ ê° ê´€ê³„ ê´€ë¦¬, ì‹œì¥ ê°œë°œ, íŒŒíŠ¸ë„ˆì‹­",
        "perspective": "ì˜ì—… íš¨ìœ¨ì„±, ê³ ê° ë§Œì¡±ë„, ì‹œì¥ í™•ëŒ€, ìˆ˜ìµ ì°½ì¶œì„ ì¤‘ì‹¬ìœ¼ë¡œ ë¶„ì„",
        "system_prompt": """ë‹¹ì‹ ì€ ì„±ê³¼ ì§€í–¥ì ì´ê³  ê´€ê³„ ì¤‘ì‹¬ì ì¸ CSO(Chief Sales Officer)ì…ë‹ˆë‹¤.
ì˜ì—… ì „ëµ, ê³ ê° ê´€ê³„ ê´€ë¦¬, ì‹œì¥ ê°œë°œ, íŒŒíŠ¸ë„ˆì‹­ êµ¬ì¶•ì„ ì „ë¬¸ìœ¼ë¡œ í•©ë‹ˆë‹¤.
ê³ ê°ê³¼ì˜ ê´€ê³„ë¥¼ ì¤‘ì‹œí•˜ë©°, ì‹¤ì§ˆì ì¸ ë§¤ì¶œ ì„±ê³¼ë¥¼ ì¶”êµ¬í•©ë‹ˆë‹¤.
ì‹œì¥ ë™í–¥ì„ íŒŒì•…í•˜ê³  íš¨ê³¼ì ì¸ ì˜ì—… ì „ëµì„ ìˆ˜ë¦½í•©ë‹ˆë‹¤."""
    },
    "CIO": {
        "name": "Chief Information Officer",
        "emoji": "ğŸ”",
        "role": "ì •ë³´ì‹œìŠ¤í…œ ë° ë°ì´í„° ì „ëµ ì±…ì„ì",
        "expertise": "ì •ë³´ì‹œìŠ¤í…œ, ë°ì´í„° ê´€ë¦¬, IT ê±°ë²„ë„ŒìŠ¤, ë””ì§€í„¸ ì¸í”„ë¼",
        "perspective": "ì‹œìŠ¤í…œ íš¨ìœ¨ì„±, ë°ì´í„° í™œìš©, ë³´ì•ˆ, IT ê±°ë²„ë„ŒìŠ¤ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ë¶„ì„",
        "system_prompt": """ë‹¹ì‹ ì€ ì²´ê³„ì ì´ê³  ë³´ì•ˆ ì¤‘ì‹¬ì ì¸ CIO(Chief Information Officer)ì…ë‹ˆë‹¤.
ì •ë³´ì‹œìŠ¤í…œ, ë°ì´í„° ê´€ë¦¬, IT ê±°ë²„ë„ŒìŠ¤, ì‚¬ì´ë²„ ë³´ì•ˆì„ ì „ë¬¸ìœ¼ë¡œ í•©ë‹ˆë‹¤.
ì •ë³´ ìì‚°ì˜ íš¨ìœ¨ì  í™œìš©ê³¼ ë³´ì•ˆì„ ì¤‘ì‹œí•˜ë©°, ì²´ê³„ì ì¸ IT ì „ëµì„ ìˆ˜ë¦½í•©ë‹ˆë‹¤.
ë°ì´í„° ê¸°ë°˜ ì˜ì‚¬ê²°ì •ì„ ì§€ì›í•˜ëŠ” ì‹œìŠ¤í…œì„ êµ¬ì¶•í•©ë‹ˆë‹¤."""
    }
}

# CEO í˜ë¥´ì†Œë‚˜ (ì‚¬ìš©ì)
CEO_PERSONA = {
    "name": "Chief Executive Officer",
    "emoji": "ğŸ‘‘",
    "role": "ìµœê³ ê²½ì˜ì (ì‚¬ìš©ì í˜ë¥´ì†Œë‚˜)",
    "expertise": "ì¢…í•©ì  ê²½ì˜ íŒë‹¨, ì˜ì‚¬ê²°ì •, ë¦¬ë”ì‹­, ë¹„ì „ ì œì‹œ",
    "perspective": "ì „ì²´ì  ê´€ì ì—ì„œ ì¢…í•© ë¶„ì„í•˜ê³  ìµœì¢… ì˜ì‚¬ê²°ì • ì§€ì›",
    "system_prompt": """ë‹¹ì‹ ì€ ê²½í—˜ì´ í’ë¶€í•œ CEO(Chief Executive Officer)ì…ë‹ˆë‹¤.
ê° ì„ì›ì§„ë“¤ì˜ ë¶„ì„ê³¼ ì œì•ˆì„ ì¢…í•©í•˜ì—¬ ìµœì¢…ì ì¸ ì˜ì‚¬ê²°ì •ì„ ë‚´ë¦½ë‹ˆë‹¤.
ì „ì²´ì ì¸ ê´€ì ì—ì„œ ê· í˜• ì¡íŒ íŒë‹¨ì„ í•˜ë©°, íšŒì‚¬ì˜ ë¹„ì „ê³¼ ëª©í‘œì— ë§ëŠ” ë°©í–¥ì„ ì œì‹œí•©ë‹ˆë‹¤.
ë¦¬ë”ì‹­ê³¼ ì‹¤í–‰ë ¥ì„ ê²¸ë¹„í•œ í†µí•©ì  ì‚¬ê³ ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤."""
}

# C-Level í˜ë¥´ì†Œë‚˜ë³„ ë¶„ì„ ë‹¨ê³„ ì •ì˜
PERSONA_ANALYSIS_STAGES = {
    "CTO": [
        {"progress": 15, "message": "ê¸°ìˆ  ìš”êµ¬ì‚¬í•­ ë¶„ì„ ì¤‘..."},
        {"progress": 30, "message": "ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ê²€í†  ì¤‘..."},
        {"progress": 45, "message": "ê¸°ìˆ  íŠ¸ë Œë“œ ì¡°ì‚¬ ì¤‘..."},
        {"progress": 60, "message": "êµ¬í˜„ ê°€ëŠ¥ì„± í‰ê°€ ì¤‘..."},
        {"progress": 75, "message": "ë³´ì•ˆ ë° í™•ì¥ì„± ê²€í†  ì¤‘..."},
        {"progress": 90, "message": "ê¸°ìˆ  ì†”ë£¨ì…˜ ìˆ˜ë¦½ ì¤‘..."},
        {"progress": 100, "message": "ê¸°ìˆ  ë¶„ì„ ì™„ë£Œ!"}
    ],
    "CSO_Strategy": [
        {"progress": 12, "message": "ì‹œì¥ í™˜ê²½ ë¶„ì„ ì¤‘..."},
        {"progress": 28, "message": "ê²½ìŸì‚¬ í˜„í™© ì¡°ì‚¬ ì¤‘..."},
        {"progress": 42, "message": "ì„±ì¥ ê¸°íšŒ íƒìƒ‰ ì¤‘..."},
        {"progress": 58, "message": "ì „ëµì  ìœ„í—˜ í‰ê°€ ì¤‘..."},
        {"progress": 72, "message": "ì‚¬ì—… ëª¨ë¸ ê²€í†  ì¤‘..."},
        {"progress": 88, "message": "ì „ëµ ë°©í–¥ ìˆ˜ë¦½ ì¤‘..."},
        {"progress": 100, "message": "ì „ëµ ë¶„ì„ ì™„ë£Œ!"}
    ],
    "CMO": [
        {"progress": 18, "message": "ê³ ê° ë‹ˆì¦ˆ ë¶„ì„ ì¤‘..."},
        {"progress": 32, "message": "ë¸Œëœë“œ í¬ì§€ì…”ë‹ ê²€í†  ì¤‘..."},
        {"progress": 48, "message": "ë§ˆì¼€íŒ… ì±„ë„ ì¡°ì‚¬ ì¤‘..."},
        {"progress": 62, "message": "ê³ ê° ê²½í—˜ ì„¤ê³„ ì¤‘..."},
        {"progress": 78, "message": "ìº í˜ì¸ ì „ëµ ìˆ˜ë¦½ ì¤‘..."},
        {"progress": 92, "message": "ë§ˆì¼€íŒ… í”Œëœ ì™„ì„± ì¤‘..."},
        {"progress": 100, "message": "ë§ˆì¼€íŒ… ë¶„ì„ ì™„ë£Œ!"}
    ],
    "CFO": [
        {"progress": 10, "message": "ì¬ë¬´ ë°ì´í„° ìˆ˜ì§‘ ì¤‘..."},
        {"progress": 25, "message": "íˆ¬ì ìˆ˜ìµë¥  ê³„ì‚° ì¤‘..."},
        {"progress": 40, "message": "ë¦¬ìŠ¤í¬ ìš”ì¸ ë¶„ì„ ì¤‘..."},
        {"progress": 55, "message": "ë¹„ìš© êµ¬ì¡° ê²€í†  ì¤‘..."},
        {"progress": 70, "message": "ìˆ˜ìµì„± ëª¨ë¸ë§ ì¤‘..."},
        {"progress": 85, "message": "ì¬ë¬´ ì „ëµ ìˆ˜ë¦½ ì¤‘..."},
        {"progress": 100, "message": "ì¬ë¬´ ë¶„ì„ ì™„ë£Œ!"}
    ],
    "CSO_Sales": [
        {"progress": 16, "message": "ì‹œì¥ ê·œëª¨ ì¡°ì‚¬ ì¤‘..."},
        {"progress": 34, "message": "ê³ ê° ì„¸ê·¸ë¨¼íŠ¸ ë¶„ì„ ì¤‘..."},
        {"progress": 50, "message": "ì˜ì—… ì±„ë„ í‰ê°€ ì¤‘..."},
        {"progress": 66, "message": "íŒŒíŠ¸ë„ˆì‹­ ê¸°íšŒ íƒìƒ‰ ì¤‘..."},
        {"progress": 80, "message": "ì˜ì—… ì „ëµ ì„¤ê³„ ì¤‘..."},
        {"progress": 94, "message": "ì‹¤í–‰ ê³„íš ìˆ˜ë¦½ ì¤‘..."},
        {"progress": 100, "message": "ì˜ì—… ë¶„ì„ ì™„ë£Œ!"}
    ],
    "CIO": [
        {"progress": 14, "message": "ì‹œìŠ¤í…œ í˜„í™© ë¶„ì„ ì¤‘..."},
        {"progress": 29, "message": "ë°ì´í„° êµ¬ì¡° ê²€í†  ì¤‘..."},
        {"progress": 44, "message": "ë³´ì•ˆ ìš”êµ¬ì‚¬í•­ í‰ê°€ ì¤‘..."},
        {"progress": 59, "message": "IT ê±°ë²„ë„ŒìŠ¤ ì„¤ê³„ ì¤‘..."},
        {"progress": 74, "message": "ì¸í”„ë¼ ìµœì í™” ê³„íš ì¤‘..."},
        {"progress": 89, "message": "ì •ë³´ì „ëµ ìˆ˜ë¦½ ì¤‘..."},
        {"progress": 100, "message": "ì •ë³´ì‹œìŠ¤í…œ ë¶„ì„ ì™„ë£Œ!"}
    ]
}

# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
if 'messages' not in st.session_state:
    st.session_state.messages = []

if 'current_analysis' not in st.session_state:
    st.session_state.current_analysis = {}

if 'analysis_complete' not in st.session_state:
    st.session_state.analysis_complete = False

# ëª¨ë¸ ì„ íƒ ë° ì„¤ì •
if 'selected_model' not in st.session_state:
    st.session_state.selected_model = 'claude-3-5-sonnet-latest'

# ì‚¬ì´ë“œë°” ì„¤ì •
st.sidebar.title("ğŸ¢ C-Level ë©€í‹°ì—ì´ì „íŠ¸ ì„¤ì •")

# ëª¨ë¸ ì„ íƒ
available_models = []
has_anthropic_key = os.environ.get('ANTHROPIC_API_KEY') is not None
if has_anthropic_key:
    available_models.extend([
        'claude-3-5-sonnet-latest',
        'claude-3-5-haiku-latest',
    ])
has_openai_key = os.environ.get('OPENAI_API_KEY') is not None
if has_openai_key:
    available_models.extend(['gpt-4o', 'gpt-4o-mini'])

if not available_models:
    st.sidebar.error("API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
    st.stop()

selected_model = st.sidebar.selectbox(
    'ğŸ§  AI ëª¨ë¸ ì„ íƒ',
    options=available_models,
    index=available_models.index(st.session_state.selected_model) if st.session_state.selected_model in available_models else 0,
    help='ClaudeëŠ” ANTHROPIC_API_KEY, OpenAIëŠ” OPENAI_API_KEY í•„ìš”'
)

if selected_model != st.session_state.selected_model:
    st.session_state.selected_model = selected_model

st.sidebar.markdown("---")

# í˜ë¥´ì†Œë‚˜ë³„ ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ ì„¤ì •
st.sidebar.subheader("ğŸ­ í˜ë¥´ì†Œë‚˜ë³„ ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸")
st.sidebar.markdown("*ê° ì„ì›ì§„ì—ê²Œ íŠ¹ë³„í•œ ì§€ì‹œì‚¬í•­ì´ ìˆë‹¤ë©´ ì…ë ¥í•˜ì„¸ìš”*")

persona_prompts = {}
for persona_key, persona_info in PERSONAS.items():
    with st.sidebar.expander(f"{persona_info['emoji']} {persona_info['name']}"):
        st.markdown(f"**ì—­í• **: {persona_info['role']}")
        st.markdown(f"**ì „ë¬¸ë¶„ì•¼**: {persona_info['expertise']}")
        
        prompt_key = f"custom_prompt_{persona_key}"
        if prompt_key not in st.session_state:
            st.session_state[prompt_key] = ""
        
        persona_prompts[persona_key] = st.text_area(
            f"ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸",
            value=st.session_state[prompt_key],
            key=prompt_key,
            height=100,
            placeholder=f"{persona_info['name']}ì—ê²Œ íŠ¹ë³„íˆ ë¶„ì„í•´ë‹¬ë¼ê³  ìš”ì²­í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...",
            help=f"{persona_info['perspective']}"
        )

st.sidebar.markdown("---")
st.sidebar.subheader("ğŸ“Š ë¶„ì„ í˜„í™©")
if st.session_state.current_analysis:
    completed = len([k for k, v in st.session_state.current_analysis.items() if v.get('completed', False)])
    total = len(PERSONAS)
    st.sidebar.progress(completed / total)
    st.sidebar.write(f"ì§„í–‰ë¥ : {completed}/{total}")

# AI ë¶„ì„ í•¨ìˆ˜
def get_ai_response(prompt, model_name, system_prompt=""):
    """AI ëª¨ë¸ë¡œë¶€í„° ì‘ë‹µì„ ë°›ëŠ” í•¨ìˆ˜"""
    try:
        if model_name.startswith('claude'):
            client = ChatAnthropic(
                model=model_name, 
                api_key=os.getenv('ANTHROPIC_API_KEY'), 
                temperature=0.7, 
                max_tokens=4000
            )
            response = client.invoke([
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": prompt}
            ])
            return response.content if hasattr(response, 'content') else str(response)
        else:
            openai_key = os.getenv('OPENAI_API_KEY')
            if not openai_key or openai_key.strip() == '' or openai_key == 'NA':
                raise ValueError("OpenAI API í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.")
            
            client = OpenAI(api_key=openai_key)
            response = client.chat.completions.create(
                model=model_name,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": prompt}
                ],
                max_tokens=4000,
                temperature=0.7
            )
            return response.choices[0].message.content
    except Exception as e:
        st.error(f"AI ì‘ë‹µ ì¤‘ ì˜¤ë¥˜: {str(e)}")
        return None

def analyze_with_persona(user_query, persona_key, persona_info, custom_prompt=""):
    """íŠ¹ì • í˜ë¥´ì†Œë‚˜ë¡œ ë¶„ì„ ìˆ˜í–‰"""
    # ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ êµ¬ì„±
    analysis_prompt = f"""
ë‹¤ìŒ ì£¼ì œ/ì§ˆë¬¸ì— ëŒ€í•´ {persona_info['role']} ê´€ì ì—ì„œ ì „ë¬¸ì ìœ¼ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”:

ã€ì£¼ì œ/ì§ˆë¬¸ã€‘
{user_query}

ã€ë¶„ì„ ìš”êµ¬ì‚¬í•­ã€‘
- {persona_info['perspective']}
- êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ì œì•ˆ í¬í•¨
- ë³¸ì¸ì˜ ì „ë¬¸ ë¶„ì•¼ì— íŠ¹í™”ëœ ì¸ì‚¬ì´íŠ¸ ì œê³µ
- ë‹¤ë¥¸ ë¶€ì„œì™€ì˜ í˜‘ì—… ë°©ì•ˆ ê³ ë ¤

"""
    
    # ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ê°€ ìˆë‹¤ë©´ ì¶”ê°€
    if custom_prompt and custom_prompt.strip():
        analysis_prompt += f"""
ã€ì¶”ê°€ ë¶„ì„ ìš”ì²­ì‚¬í•­ã€‘
{custom_prompt.strip()}

"""
    
    analysis_prompt += """
ã€ì‘ë‹µ í˜•ì‹ã€‘
## í•µì‹¬ ë¶„ì„
(2-3ì¤„ë¡œ í•µì‹¬ í¬ì¸íŠ¸ ìš”ì•½)

## ìƒì„¸ ë¶„ì„
(ì „ë¬¸ ë¶„ì•¼ ê´€ì ì—ì„œ ìƒì„¸í•œ ë¶„ì„)

## ì‹¤í–‰ ì œì•ˆ
(êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ì•¡ì…˜ ì•„ì´í…œë“¤)

## ë‹¤ë¥¸ ë¶€ì„œ í˜‘ì—… ë°©ì•ˆ
(ë‹¤ë¥¸ C-levelê³¼ì˜ í˜‘ì—…ì´ í•„ìš”í•œ ë¶€ë¶„)

## ë¦¬ìŠ¤í¬ ë° ê³ ë ¤ì‚¬í•­
(ì£¼ì˜í•´ì•¼ í•  ì ë“¤)
"""
    
    return get_ai_response(analysis_prompt, selected_model, persona_info['system_prompt'])

def analyze_persona_concurrent(args):
    """ThreadPoolExecutorì—ì„œ ì‚¬ìš©í•  ë˜í¼ í•¨ìˆ˜"""
    user_query, persona_key, persona_info, custom_prompt = args
    try:
        result = analyze_with_persona(user_query, persona_key, persona_info, custom_prompt)
        return persona_key, result, True
    except Exception as e:
        return persona_key, str(e), False

def run_concurrent_analysis_with_progress(user_query, persona_prompts, persona_status, persona_progress):
    """ëª¨ë“  í˜ë¥´ì†Œë‚˜ ë¶„ì„ì„ ë™ì‹œì— ì‹¤í–‰í•˜ë©´ì„œ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸"""
    
    # ë¶„ì„ ì‘ì—… ì¤€ë¹„
    tasks = []
    for persona_key, persona_info in PERSONAS.items():
        custom_prompt = persona_prompts.get(persona_key, "")
        tasks.append((user_query, persona_key, persona_info, custom_prompt))
    
    # ê° í˜ë¥´ì†Œë‚˜ë³„ ì§„í–‰ ìƒíƒœ ì¶”ì 
    persona_stages = {}
    for persona_key in PERSONAS.keys():
        persona_stages[persona_key] = {
            'current_stage': 0,
            'last_update': time.time(),
            'stage_duration': random.uniform(2.0, 4.0)  # ê° ë‹¨ê³„ë‹¹ 2-4ì´ˆ
        }
    
    # ì§„í–‰ë¥  ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•œ í•¨ìˆ˜
    def animate_progress():
        while True:
            current_time = time.time()
            
            all_completed = True
            for persona_key, persona_info in PERSONAS.items():
                if persona_key not in st.session_state.get('completed_personas', set()):
                    all_completed = False
                    
                    stages = PERSONA_ANALYSIS_STAGES[persona_key]
                    stage_info = persona_stages[persona_key]
                    
                    # í˜„ì¬ ë‹¨ê³„ í™•ì¸
                    if stage_info['current_stage'] < len(stages):
                        current_stage = stages[stage_info['current_stage']]
                        
                        # ë‹¨ê³„ ì§„í–‰ ì‹œê°„ ì²´í¬
                        elapsed_since_update = current_time - stage_info['last_update']
                        
                        if elapsed_since_update >= stage_info['stage_duration']:
                            # ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰
                            stage_info['current_stage'] += 1
                            stage_info['last_update'] = current_time
                            stage_info['stage_duration'] = random.uniform(1.5, 3.5)  # ë‹¤ìŒ ë‹¨ê³„ ì‹œê°„
                            
                            # ìƒˆë¡œìš´ ë‹¨ê³„ê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
                            if stage_info['current_stage'] < len(stages):
                                new_stage = stages[stage_info['current_stage']]
                                
                                # ì§„í–‰ë¥  ë°” ì—…ë°ì´íŠ¸
                                if persona_progress[persona_key] is not None:
                                    persona_progress[persona_key].progress(new_stage['progress'])
                                
                                # ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                                persona_status[persona_key].markdown(f"""
                                <div class="progress-indicator">
                                    <strong>âš¡ {persona_info['emoji']} {persona_info['name']}</strong><br>
                                    <span style="font-size: 0.9rem;">{new_stage['message']} ({new_stage['progress']}%)</span>
                                </div>
                                """, unsafe_allow_html=True)
                        else:
                            # í˜„ì¬ ë‹¨ê³„ ë‚´ì—ì„œ ë¶€ë“œëŸ¬ìš´ ì§„í–‰
                            if stage_info['current_stage'] > 0:
                                prev_progress = stages[stage_info['current_stage'] - 1]['progress']
                                curr_progress = current_stage['progress']
                                
                                # ë‹¨ê³„ ë‚´ ì§„í–‰ë¥  ê³„ì‚°
                                stage_progress = min(elapsed_since_update / stage_info['stage_duration'], 1.0)
                                interpolated_progress = prev_progress + (curr_progress - prev_progress) * stage_progress
                                
                                # ë¶€ë“œëŸ¬ìš´ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                                if persona_progress[persona_key] is not None:
                                    persona_progress[persona_key].progress(int(interpolated_progress))
                                
                                # ë©”ì‹œì§€ëŠ” í˜„ì¬ ë‹¨ê³„ ìœ ì§€
                                persona_status[persona_key].markdown(f"""
                                <div class="progress-indicator">
                                    <strong>âš¡ {persona_info['emoji']} {persona_info['name']}</strong><br>
                                    <span style="font-size: 0.9rem;">{current_stage['message']} ({int(interpolated_progress)}%)</span>
                                </div>
                                """, unsafe_allow_html=True)
            
            if all_completed:
                break
                
            time.sleep(0.3)  # ë” ë¹ˆë²ˆí•œ ì—…ë°ì´íŠ¸ (0.3ì´ˆë§ˆë‹¤)
    
    # ì™„ë£Œëœ í˜ë¥´ì†Œë‚˜ ì¶”ì ì„ ìœ„í•œ ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
    st.session_state['completed_personas'] = set()
    
    # ì§„í–‰ë¥  ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘ (ë³„ë„ ìŠ¤ë ˆë“œ)
    progress_thread = threading.Thread(target=animate_progress)
    progress_thread.daemon = True
    progress_thread.start()
    
    # ThreadPoolExecutorë¡œ ë™ì‹œ ì‹¤í–‰
    results = {}
    with ThreadPoolExecutor(max_workers=len(PERSONAS)) as executor:
        # ëª¨ë“  ì‘ì—…ì„ ë™ì‹œì— ì‹œì‘
        future_to_persona = {
            executor.submit(analyze_persona_concurrent, task): task[1] 
            for task in tasks
        }
        
        # ì™„ë£Œë˜ëŠ” ìˆœì„œëŒ€ë¡œ ê²°ê³¼ ìˆ˜ì§‘
        for future in as_completed(future_to_persona):
            persona_key = future_to_persona[future]
            try:
                persona_key, result, success = future.result()
                results[persona_key] = {
                    'result': result,
                    'success': success,
                    'completed': True,
                    'timestamp': datetime.now().isoformat()
                }
                
                # ì™„ë£Œëœ í˜ë¥´ì†Œë‚˜ ë§ˆí‚¹
                st.session_state['completed_personas'].add(persona_key)
                
                # ì§„í–‰ë¥ ì„ 100%ë¡œ ì„¤ì •
                if persona_progress[persona_key] is not None:
                    persona_progress[persona_key].progress(100)
                
                # ì™„ë£Œ ìƒíƒœë¡œ ì—…ë°ì´íŠ¸
                persona_info = PERSONAS[persona_key]
                if success:
                    completion_message = PERSONA_ANALYSIS_STAGES[persona_key][-1]['message']
                    persona_status[persona_key].markdown(f"""
                    <div class="analysis-complete">
                        <h4>ğŸ‰ {persona_info['emoji']} {persona_info['name']}</h4>
                        <p style="margin: 5px 0; font-size: 0.9rem; color: #155724;">
                            {completion_message}<br>
                            ì™„ë£Œ ì‹œê°„: {datetime.fromisoformat(results[persona_key]['timestamp']).strftime('%H:%M:%S')}
                        </p>
                    </div>
                    """, unsafe_allow_html=True)
                else:
                    persona_status[persona_key].markdown(f"""
                    <div style="background: #f8d7da; border: 2px solid #dc3545; border-radius: 12px; padding: 15px; margin: 10px 0; text-align: center;">
                        <h4 style="color: #721c24; margin: 0;">âŒ {persona_info['emoji']} {persona_info['name']} ë¶„ì„ ì˜¤ë¥˜</h4>
                        <p style="margin: 5px 0; font-size: 0.9rem; color: #721c24;">
                            ì˜¤ë¥˜ ì‹œê°„: {datetime.fromisoformat(results[persona_key]['timestamp']).strftime('%H:%M:%S')}
                        </p>
                    </div>
                    """, unsafe_allow_html=True)
                    
            except Exception as e:
                results[persona_key] = {
                    'result': str(e),
                    'success': False,
                    'completed': True,
                    'timestamp': datetime.now().isoformat()
                }
                st.session_state['completed_personas'].add(persona_key)
    
    return results

def synthesize_ceo_analysis(user_query, persona_analyses):
    """CEO ê´€ì ì—ì„œ ëª¨ë“  ë¶„ì„ì„ ì¢…í•©"""
    synthesis_prompt = f"""
ë‹¤ìŒì€ ìš°ë¦¬ íšŒì‚¬ C-level ì„ì›ì§„ë“¤ì´ ë¶„ì„í•œ ë‚´ìš©ì…ë‹ˆë‹¤. 
CEOë¡œì„œ ì´ë“¤ì˜ ë¶„ì„ì„ ì¢…í•©í•˜ì—¬ ìµœì¢… ì˜ì‚¬ê²°ì •ì„ ìœ„í•œ í†µí•© ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

ã€ì›ë˜ ì£¼ì œ/ì§ˆë¬¸ã€‘
{user_query}

ã€ê° ì„ì›ì§„ ë¶„ì„ ê²°ê³¼ã€‘
"""
    
    for persona_key, analysis in persona_analyses.items():
        if analysis and analysis.get('result'):
            persona_info = PERSONAS[persona_key]
            synthesis_prompt += f"""
--- {persona_info['emoji']} {persona_info['name']} ë¶„ì„ ---
{analysis['result']}

"""
    
    synthesis_prompt += """
ã€CEO ì¢…í•© ë¶„ì„ ìš”êµ¬ì‚¬í•­ã€‘
- ê° ì„ì›ì§„ì˜ ê´€ì ì„ ê· í˜•ìˆê²Œ ê³ ë ¤
- ì „ì‚¬ì  ê´€ì ì—ì„œì˜ ìš°ì„ ìˆœìœ„ ì„¤ì •
- ì‹¤í˜„ ê°€ëŠ¥í•œ í†µí•© ì‹¤í–‰ ê³„íš ìˆ˜ë¦½
- ë¦¬ìŠ¤í¬ì™€ ê¸°íšŒ ìš”ì¸ì˜ ì¢…í•©ì  í‰ê°€
- ëª…í™•í•œ ì˜ì‚¬ê²°ì • ë°©í–¥ ì œì‹œ

ã€ì‘ë‹µ í˜•ì‹ã€‘
## ğŸ¯ í•µì‹¬ ê²°ë¡  ë° ì˜ì‚¬ê²°ì •
(CEOë¡œì„œì˜ ìµœì¢… íŒë‹¨ê³¼ ê²°ì •ì‚¬í•­)

## ğŸ“Š ì„ì›ì§„ ë¶„ì„ ì¢…í•©
(ê° ì„ì›ì§„ ì˜ê²¬ì˜ í•µì‹¬ í¬ì¸íŠ¸ë“¤)

## ğŸš€ í†µí•© ì‹¤í–‰ ê³„íš
(ë‹¨ê³„ë³„ ì‹¤í–‰ ë°©ì•ˆ)

## âš–ï¸ ë¦¬ìŠ¤í¬ vs ê¸°íšŒ
(ì¢…í•©ì  ë¦¬ìŠ¤í¬-ê¸°íšŒ ë¶„ì„)

## ğŸ“ˆ ì„±ê³µ ì§€í‘œ ë° ëª¨ë‹ˆí„°ë§
(ì„±ê³¼ ì¸¡ì • ë°©ë²•)

## ğŸ’¡ CEO ìµœì¢… ë©”ì‹œì§€
(ì¡°ì§ì— ì „ë‹¬í•  í•µì‹¬ ë©”ì‹œì§€)
"""
    
    return get_ai_response(synthesis_prompt, selected_model, CEO_PERSONA['system_prompt'])

# ë©”ì¸ ì¸í„°í˜ì´ìŠ¤
st.markdown('<h1 class="main-title">ğŸ¢ ê°€ìƒíšŒì‚¬ C-Level ë©€í‹°ì—ì´ì „íŠ¸</h1>', unsafe_allow_html=True)
st.markdown('<p class="main-subtitle"><strong>ë‹¹ì‹ ì€ CEOì…ë‹ˆë‹¤. C-level ì„ì›ì§„ë“¤ì´ í˜‘ë ¥í•˜ì—¬ ë¶„ì„í•˜ê³ , ìµœì¢… ì¢…í•© ë³´ê³ ì„œë¥¼ ì œê³µí•©ë‹ˆë‹¤.</strong></p>', unsafe_allow_html=True)

# í˜„ì¬ ì„¤ì • ì •ë³´ í‘œì‹œ
col1, col2 = st.columns([3, 1])
with col1:
    st.markdown(f"**ì„ íƒëœ ëª¨ë¸**: {selected_model}")
with col2:
    if st.button("ğŸ”„ ì´ˆê¸°í™”", help="ëª¨ë“  ë¶„ì„ ê²°ê³¼ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤"):
        st.session_state.current_analysis = {}
        st.session_state.analysis_complete = False
        st.rerun()

# ì„ì›ì§„ ì†Œê°œ
st.markdown("## ğŸ‘¥ C-Level ì„ì›ì§„")
cols = st.columns(3)
for i, (persona_key, persona_info) in enumerate(PERSONAS.items()):
    with cols[i % 3]:
        st.markdown(f"""
        <div class="persona-card">
            <div class="persona-header">
                <div class="persona-emoji">{persona_info['emoji']}</div>
                <div>
                    <div class="persona-title">{persona_info['name']}</div>
                    <div class="persona-subtitle">{persona_info['role']}</div>
                </div>
            </div>
            <div style="font-size: 0.85rem; color: #666;">
                {persona_info['expertise']}
            </div>
        </div>
        """, unsafe_allow_html=True)

st.markdown("---")

# ë©”ì¸ ì…ë ¥
user_query = st.text_area(
    "ğŸ“ CEOë‹˜, ì–´ë–¤ ì£¼ì œì— ëŒ€í•´ C-level ì„ì›ì§„ë“¤ì˜ ë¶„ì„ì´ í•„ìš”í•˜ì‹ ê°€ìš”?",
    height=120,
    placeholder="ì˜ˆ: ìƒˆë¡œìš´ AI ì„œë¹„ìŠ¤ ë¡ ì¹­ ì „ëµì— ëŒ€í•´ ë¶„ì„í•´ì£¼ì„¸ìš”...\nì˜ˆ: ë””ì§€í„¸ ì „í™˜ì„ ìœ„í•œ íˆ¬ì ê³„íšì„ ê²€í† í•´ì£¼ì„¸ìš”...\nì˜ˆ: í•´ì™¸ ì‹œì¥ ì§„ì¶œ ë°©ì•ˆì„ ë¶„ì„í•´ì£¼ì„¸ìš”..."
)

if st.button("ğŸš€ C-Level ì„ì›ì§„ ë¶„ì„ ì‹œì‘", type="primary", use_container_width=True):
    if not user_query.strip():
        st.warning("ë¶„ì„í•  ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
    else:
        st.session_state.current_analysis = {}
        st.session_state.analysis_complete = False
        
        # ì§„í–‰ ìƒí™© í‘œì‹œ
        progress_container = st.container()
        
        with progress_container:
            st.markdown("""
            <div class="progress-section">
                <h2>ğŸš€ C-Level ì„ì›ì§„ ë™ì‹œ ë¶„ì„ ì‹œì‘!</h2>
                <p style="text-align: center; color: #666; margin-top: 10px;">
                    ëª¨ë“  ì„ì›ì§„ì´ ë™ì‹œì— ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤...
                </p>
            </div>
            """, unsafe_allow_html=True)
            
            # ëª¨ë“  í˜ë¥´ì†Œë‚˜ì— ëŒ€í•´ "ë¶„ì„ ì‹œì‘" ìƒíƒœ í‘œì‹œ
            persona_status = {}
            persona_progress = {}
            for persona_key, persona_info in PERSONAS.items():
                persona_status[persona_key] = st.empty()
                
                # ì²« ë²ˆì§¸ ë‹¨ê³„ë¡œ ì´ˆê¸° ìƒíƒœ í‘œì‹œ
                first_stage = PERSONA_ANALYSIS_STAGES[persona_key][0]
                persona_status[persona_key].markdown(f"""
                <div class="progress-indicator">
                    <strong>ğŸš€ {persona_info['emoji']} {persona_info['name']}</strong><br>
                    <span style="font-size: 0.9rem;">{first_stage['message']} (0%)</span>
                </div>
                """, unsafe_allow_html=True)
                
                # ì§„í–‰ë¥  ë°” ì¶”ê°€
                persona_progress[persona_key] = st.progress(0)
                st.markdown(f"<div style='margin-bottom: 20px;'></div>", unsafe_allow_html=True)
            
            # ë™ì‹œ ë¶„ì„ ì‹¤í–‰
            with st.spinner("ğŸ”¥ ëª¨ë“  C-Level ì„ì›ì§„ì´ ë™ì‹œì— ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤..."):
                # ì‹¤ì œ ë™ì‹œ ë¶„ì„ ìˆ˜í–‰
                analysis_results = run_concurrent_analysis_with_progress(user_query, persona_prompts, persona_status, persona_progress)
                
                # ê²°ê³¼ë¥¼ ì„¸ì…˜ì— ì €ì¥
                for persona_key, result_data in analysis_results.items():
                    st.session_state.current_analysis[persona_key] = result_data
                
                # ë¶„ì„ ê²°ê³¼ í‘œì‹œ (expanderë¡œ)
                st.markdown("### ğŸ“‹ ìƒì„¸ ë¶„ì„ ê²°ê³¼")
                for persona_key, result_data in analysis_results.items():
                    persona_info = PERSONAS[persona_key]
                    
                    if result_data['success']:
                        with st.expander(f"ğŸ“‹ {persona_info['emoji']} {persona_info['name']} ìƒì„¸ ë¶„ì„ ê²°ê³¼", expanded=False):
                            st.markdown(result_data['result'])
                    else:
                        with st.expander(f"âŒ {persona_info['emoji']} {persona_info['name']} ì˜¤ë¥˜ ìƒì„¸", expanded=False):
                            st.error(f"ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {result_data['result']}")
            
            # ì„±ê³µí•œ ë¶„ì„ë§Œ CEO ì¢…í•© ë¶„ì„ì— ì‚¬ìš©
            successful_analyses = {
                k: v for k, v in st.session_state.current_analysis.items() 
                if v.get('success', False)
            }
            
            if successful_analyses:
                # CEO ì¢…í•© ë¶„ì„
                st.markdown("---")
                st.markdown("""
                <div class="ceo-synthesis">
                    <strong>ğŸ‘‘ CEO ìµœì¢… ì¢…í•© ë¶„ì„ ì¤‘...</strong>
                    <p style="margin: 10px 0; font-size: 0.9rem;">
                        ëª¨ë“  ì„ì›ì§„ì˜ ë™ì‹œ ë¶„ì„ ê²°ê³¼ë¥¼ ì¢…í•©í•©ë‹ˆë‹¤
                    </p>
                </div>
                """, unsafe_allow_html=True)
                
                with st.spinner("CEO ìµœì¢… ì¢…í•© ë¶„ì„ ì¤‘..."):
                    ceo_synthesis = synthesize_ceo_analysis(user_query, successful_analyses)
                    
                    if ceo_synthesis:
                        st.session_state.current_analysis['CEO'] = {
                            'result': ceo_synthesis,
                            'completed': True,
                            'timestamp': datetime.now().isoformat()
                        }
                        st.session_state.analysis_complete = True
            else:
                st.error("âŒ ëª¨ë“  ì„ì›ì§„ ë¶„ì„ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.")
        
        # ì§„í–‰ ìƒí™© í‘œì‹œ ì œê±°
        progress_container.empty()
        
        if st.session_state.analysis_complete:
            st.balloons()
            st.success("ğŸ‰ ë™ì‹œ ë¶„ì„ì´ ëª¨ë‘ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")

# ë¶„ì„ ê²°ê³¼ í‘œì‹œ
if st.session_state.analysis_complete and 'CEO' in st.session_state.current_analysis:
    st.markdown("---")
    st.markdown("## ğŸ‘‘ CEO ìµœì¢… ì¢…í•© ë³´ê³ ì„œ")
    
    st.markdown(f"""
    <div class="ceo-final">
        <h3>ğŸ‘‘ CEO ìµœì¢… ì˜ì‚¬ê²°ì • ë³´ê³ ì„œ</h3>
        <p><strong>ë¶„ì„ ì™„ë£Œ ì‹œê°„:</strong> {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</p>
    </div>
    """, unsafe_allow_html=True)
    
    st.markdown(st.session_state.current_analysis['CEO']['result'])
    
    # ê°œë³„ ì„ì›ì§„ ë¶„ì„ ê²°ê³¼ (ì ‘ì„ ìˆ˜ ìˆëŠ” í˜•íƒœ)
    st.markdown("## ğŸ“‹ ê°œë³„ ì„ì›ì§„ ë¶„ì„ ê²°ê³¼")
    
    for persona_key, persona_info in PERSONAS.items():
        if persona_key in st.session_state.current_analysis:
            analysis_data = st.session_state.current_analysis[persona_key]
            with st.expander(f"{persona_info['emoji']} {persona_info['name']} ìƒì„¸ ë¶„ì„"):
                st.markdown(f"**ë¶„ì„ ì‹œê°„:** {analysis_data['timestamp']}")
                st.markdown("---")
                st.markdown(analysis_data['result'])

# ì‚¬ìš©ë²• ì•ˆë‚´
with st.expander("ğŸ’¡ ì‚¬ìš©ë²• ì•ˆë‚´"):
    st.markdown("""
    ### ğŸ¢ C-Level ë©€í‹°ì—ì´ì „íŠ¸ ì‹œìŠ¤í…œ ì‚¬ìš©ë²•
    
    1. **ëª¨ë¸ ì„ íƒ**: ì‚¬ì´ë“œë°”ì—ì„œ ì‚¬ìš©í•  AI ëª¨ë¸ì„ ì„ íƒí•˜ì„¸ìš”
    2. **ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸**: ê° ì„ì›ì§„ì—ê²Œ íŠ¹ë³„í•œ ë¶„ì„ì„ ìš”ì²­í•˜ê³  ì‹¶ë‹¤ë©´ ì‚¬ì´ë“œë°”ì—ì„œ ì„¤ì •í•˜ì„¸ìš”
    3. **ì£¼ì œ ì…ë ¥**: ë©”ì¸ ì°½ì—ì„œ ë¶„ì„í•˜ê³  ì‹¶ì€ ì£¼ì œë‚˜ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”
    4. **ë™ì‹œ ë¶„ì„**: ëª¨ë“  C-Level ì„ì›ì§„ì´ **ì‹¤ì œë¡œ ë™ì‹œì—** ë¶„ì„í•©ë‹ˆë‹¤ ğŸš€
    5. **CEO ì¢…í•©**: ëª¨ë“  ë¶„ì„ì´ ëë‚˜ë©´ CEO(ë‹¹ì‹ )ê°€ ìµœì¢… ì¢…í•© ì˜ì‚¬ê²°ì •ì„ ì œì‹œí•©ë‹ˆë‹¤
    
    ### ğŸ­ í˜ë¥´ì†Œë‚˜ë³„ íŠ¹ì§•
    - **ğŸ’» CTO**: ê¸°ìˆ ì  íƒ€ë‹¹ì„±ê³¼ êµ¬í˜„ ë°©ì•ˆ
    - **ğŸ¯ CSO(ì „ëµ)**: ì‹œì¥ ë¶„ì„ê³¼ ì„±ì¥ ì „ëµ
    - **ğŸ“¢ CMO**: ë§ˆì¼€íŒ…ê³¼ ê³ ê° ê²½í—˜
    - **ğŸ’° CFO**: ì¬ë¬´ì  íƒ€ë‹¹ì„±ê³¼ ë¦¬ìŠ¤í¬
    - **ğŸ¤ CSO(ì˜ì—…)**: ì˜ì—… ì „ëµê³¼ ê³ ê° ê´€ê³„
    - **ğŸ” CIO**: ì •ë³´ì‹œìŠ¤í…œê³¼ ë°ì´í„° ì „ëµ
    - **ğŸ‘‘ CEO**: ìµœì¢… ì¢…í•© ì˜ì‚¬ê²°ì •
    
    ### âš¡ ë™ì‹œ ì²˜ë¦¬ì˜ ì¥ì 
    - **ì†ë„**: ìˆœì°¨ ì²˜ë¦¬ ëŒ€ë¹„ **6ë°° ë¹ ë¥¸** ë¶„ì„ ì†ë„
    - **íš¨ìœ¨ì„±**: ëª¨ë“  ì„ì›ì§„ì´ **ì‹¤ì œë¡œ ë™ì‹œì—** ì‘ì—…
    - **ì‹¤ì‹œê°„**: ì™„ë£Œë˜ëŠ” ìˆœì„œëŒ€ë¡œ **ì¦‰ì‹œ ê²°ê³¼ í™•ì¸**
    - **ê²¬ê³ ì„±**: ì¼ë¶€ ë¶„ì„ì´ ì‹¤íŒ¨í•´ë„ ë‚˜ë¨¸ì§€ëŠ” ì •ìƒ ì§„í–‰
    
    ### ğŸ’¡ íŒ
    - ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ê°€ ì—†ìœ¼ë©´ ë©”ì¸ ì§ˆë¬¸ì„ ëª¨ë“  ì„ì›ì§„ì´ ê³µí†µìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤
    - ê° ì„ì›ì§„ì˜ ì „ë¬¸ ë¶„ì•¼ì— ë§ëŠ” êµ¬ì²´ì ì¸ ìš”ì²­ì„ ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ì— ì¶”ê°€í•˜ë©´ ë” ì •í™•í•œ ë¶„ì„ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤
    - ë™ì‹œ ì²˜ë¦¬ë¡œ ì¸í•´ **ëŒ€í­ ë‹¨ì¶•ëœ ë¶„ì„ ì‹œê°„**ì„ ê²½í—˜í•´ë³´ì„¸ìš”!
    """)

# í‘¸í„°
st.markdown("---")
st.markdown("""
<div style="text-align: center; color: #666; font-size: 0.9rem;">
    ğŸ¢ ê°€ìƒíšŒì‚¬ C-Level ë©€í‹°ì—ì´ì „íŠ¸ ì‹œìŠ¤í…œ | Powered by Claude & ChatGPT
</div>
""", unsafe_allow_html=True) 