import streamlit as st
from openai import OpenAI
import time
import threading
from datetime import datetime, timedelta
import json
import os
from typing import List, Dict, Any
import uuid
from dotenv import load_dotenv
import pandas as pd
from io import StringIO
import PyPDF2
import docx
import tempfile
from dataclasses import dataclass
import asyncio
import queue
import random

load_dotenv()

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(
    page_title="Virtual Meeting - AI ê°€ìƒ íšŒì˜",
    page_icon="ğŸ­",
    layout="wide"
)

@dataclass
class Persona:
    id: str
    name: str
    role: str
    prompt: str
    personality: str
    expertise: str
    speaking_style: str
    is_moderator: bool = False

@dataclass
class Message:
    timestamp: datetime
    persona_id: str
    persona_name: str
    content: str
    is_human_input: bool = False

class VirtualMeeting:
    def __init__(self):
        self.personas: List[Persona] = []
        self.messages: List[Message] = []
        self.meeting_topic = ""
        self.meeting_duration = 30  # ë¶„
        self.start_time = None
        self.is_active = False
        self.uploaded_files_content = ""
        self.current_speaker_index = 0
        self.conversation_round = 0
        self.max_rounds = 10
        
    def add_persona(self, persona: Persona):
        if len(self.personas) < 10:
            self.personas.append(persona)
            return True
        return False
    
    def remove_persona(self, persona_id: str):
        self.personas = [p for p in self.personas if p.id != persona_id]
    
    def get_moderator(self) -> Persona:
        for persona in self.personas:
            if persona.is_moderator:
                return persona
        return None
    
    def add_message(self, persona_id: str, content: str, is_human_input: bool = False):
        persona = next((p for p in self.personas if p.id == persona_id), None)
        if persona:
            message = Message(
                timestamp=datetime.now(),
                persona_id=persona_id,
                persona_name=persona.name,
                content=content,
                is_human_input=is_human_input
            )
            self.messages.append(message)
            return message
        return None

def initialize_session_state():
    """ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”"""
    if 'virtual_meeting' not in st.session_state:
        st.session_state.virtual_meeting = VirtualMeeting()
        
        # ê¸°ë³¸ ì‚¬íšŒì í˜ë¥´ì†Œë‚˜ ìƒì„±
        moderator = Persona(
            id="moderator_001",
            name="ì‚¬íšŒì ê¹€ì§„í–‰",
            role="íšŒì˜ ì‚¬íšŒì",
            prompt="""ë‹¹ì‹ ì€ ì „ë¬¸ì ì¸ íšŒì˜ ì‚¬íšŒìì…ë‹ˆë‹¤. 
            íšŒì˜ì˜ íë¦„ì„ ì›í™œí•˜ê²Œ ì´ëŒê³ , ì°¸ê°€ìë“¤ì˜ ì˜ê²¬ì„ ì ì ˆíˆ ì¡°ìœ¨í•˜ë©°, 
            ì£¼ì œì—ì„œ ë²—ì–´ë‚˜ì§€ ì•Šë„ë¡ ì•ˆë‚´í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.
            ê°„ê²°í•˜ê³  ëª…í™•í•˜ê²Œ ë§í•˜ë©°, ëª¨ë“  ì°¸ê°€ìê°€ ë°œì–¸í•  ê¸°íšŒë¥¼ ê°–ë„ë¡ í•©ë‹ˆë‹¤.""",
            personality="ì°¨ë¶„í•˜ê³  ê³µì •í•˜ë©° ì „ë¬¸ì ",
            expertise="íšŒì˜ ì§„í–‰, í† ë¡  ì¡°ìœ¨, ì˜ê²¬ ì •ë¦¬",
            speaking_style="ì •ì¤‘í•˜ê³  ëª…í™•í•˜ë©° ê°„ê²°í•œ ë§íˆ¬",
            is_moderator=True
        )
        st.session_state.virtual_meeting.add_persona(moderator)
    
    if 'meeting_log' not in st.session_state:
        st.session_state.meeting_log = []
    
    if 'human_input_queue' not in st.session_state:
        st.session_state.human_input_queue = queue.Queue()
    
    if 'conversation_active' not in st.session_state:
        st.session_state.conversation_active = False

def extract_text_from_file(uploaded_file) -> str:
    """ì—…ë¡œë“œëœ íŒŒì¼ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ"""
    try:
        file_type = uploaded_file.type
        content = ""
        
        if file_type == "text/plain":
            content = str(uploaded_file.read(), "utf-8")
        elif file_type == "application/pdf":
            pdf_reader = PyPDF2.PdfReader(uploaded_file)
            for page in pdf_reader.pages:
                content += page.extract_text()
        elif file_type == "application/vnd.openxmlformats-officedocument.wordprocessingml.document":
            doc = docx.Document(uploaded_file)
            for paragraph in doc.paragraphs:
                content += paragraph.text + "\n"
        elif file_type == "text/csv":
            df = pd.read_csv(uploaded_file)
            content = df.to_string()
        else:
            content = "ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤."
            
        return content
    except Exception as e:
        return f"íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: {str(e)}"

def generate_ai_response(persona: Persona, conversation_history: str, meeting_topic: str, file_content: str) -> str:
    """AI ì‘ë‹µ ìƒì„±"""
    try:
        # OpenAI API í‚¤ ê²€ì¦
        openai_key = os.getenv('OPENAI_API_KEY')
        if not openai_key or openai_key.strip() == '' or openai_key == 'NA':
            raise ValueError("OpenAI API í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. .env íŒŒì¼ì—ì„œ OPENAI_API_KEYë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")
        
        client = OpenAI(api_key=openai_key)
        
        system_prompt = f"""
        {persona.prompt}
        
        ë‹¹ì‹ ì˜ ì •ë³´:
        - ì´ë¦„: {persona.name}
        - ì—­í• : {persona.role}
        - ì„±ê²©: {persona.personality}
        - ì „ë¬¸ ë¶„ì•¼: {persona.expertise}
        - ë§í•˜ëŠ” ìŠ¤íƒ€ì¼: {persona.speaking_style}
        
        íšŒì˜ ì£¼ì œ: {meeting_topic}
        
        ì°¸ê³  ìë£Œ: {file_content[:2000] if file_content else "ì—†ìŒ"}
        
        ì§€ê¸ˆê¹Œì§€ì˜ ëŒ€í™” íë¦„ì„ íŒŒì•…í•˜ê³ , ë‹¹ì‹ ì˜ ì—­í• ê³¼ ì „ë¬¸ì„±ì— ë§ëŠ” ì˜ê²¬ì„ ì œì‹œí•˜ì„¸ìš”.
        ì‘ë‹µì€ 1-2ë¬¸ì¥ìœ¼ë¡œ ìì—°ìŠ¤ëŸ½ê³  ê°„ê²°í•˜ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”.
        """
        
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": f"ëŒ€í™” ë‚´ìš©:\n{conversation_history}\n\nìœ„ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”."}
            ],
            max_tokens=200,
            temperature=0.7
        )
        
        return response.choices[0].message.content.strip()
    except Exception as e:
        return f"[AI ì‘ë‹µ ìƒì„± ì˜¤ë¥˜: {str(e)}]"

def format_conversation_history(messages: List[Message], last_n: int = 10) -> str:
    """ëŒ€í™” íˆìŠ¤í† ë¦¬ í¬ë§·íŒ…"""
    recent_messages = messages[-last_n:] if len(messages) > last_n else messages
    history = ""
    for msg in recent_messages:
        history += f"{msg.persona_name}: {msg.content}\n"
    return history

def display_message(message: Message):
    """ë©”ì‹œì§€ í‘œì‹œ"""
    with st.chat_message(
        "assistant" if not message.is_human_input else "human",
        avatar="ğŸ­" if not message.is_human_input else "ğŸ‘¤"
    ):
        st.write(f"**{message.persona_name}** ({message.timestamp.strftime('%H:%M:%S')})")
        st.write(message.content)

def simulate_typing_delay():
    """íƒ€ì´í•‘ ì‹œë®¬ë ˆì´ì…˜ ì§€ì—°"""
    delay = random.uniform(2, 5)  # 2-5ì´ˆ ëœë¤ ì§€ì—°
    time.sleep(delay)

def run_conversation_round(meeting: VirtualMeeting, placeholder):
    """í•œ ë¼ìš´ë“œì˜ ëŒ€í™” ì‹¤í–‰"""
    if not meeting.is_active or meeting.conversation_round >= meeting.max_rounds:
        return False
    
    # ì‚¬íšŒìê°€ ì•„ë‹Œ í˜ë¥´ì†Œë‚˜ë“¤ì´ ìˆœì„œëŒ€ë¡œ ë°œì–¸
    non_moderator_personas = [p for p in meeting.personas if not p.is_moderator]
    
    if not non_moderator_personas:
        return False
    
    # í˜„ì¬ ë°œì–¸ì ì„ íƒ
    current_persona = non_moderator_personas[meeting.current_speaker_index % len(non_moderator_personas)]
    
    # ëŒ€í™” íˆìŠ¤í† ë¦¬ ìƒì„±
    conversation_history = format_conversation_history(meeting.messages)
    
    # AI ì‘ë‹µ ìƒì„±
    response = generate_ai_response(
        current_persona,
        conversation_history,
        meeting.meeting_topic,
        meeting.uploaded_files_content
    )
    
    # ë©”ì‹œì§€ ì¶”ê°€
    message = meeting.add_message(current_persona.id, response)
    
    # ë©”ì‹œì§€ í‘œì‹œ
    with placeholder.container():
        for msg in meeting.messages:
            display_message(msg)
    
    # ë‹¤ìŒ ë°œì–¸ìë¡œ ì´ë™
    meeting.current_speaker_index += 1
    
    # ëª¨ë“  ì°¸ê°€ìê°€ ë°œì–¸í–ˆìœ¼ë©´ ë¼ìš´ë“œ ì¦ê°€
    if meeting.current_speaker_index % len(non_moderator_personas) == 0:
        meeting.conversation_round += 1
    
    return True

def main():
    st.title("ğŸ­ Virtual Meeting - AI ê°€ìƒ íšŒì˜")
    
    # ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
    initialize_session_state()
    meeting = st.session_state.virtual_meeting
    
    # ì‚¬ì´ë“œë°” - íšŒì˜ ì„¤ì •
    with st.sidebar:
        st.header("ğŸ¯ íšŒì˜ ì„¤ì •")
        
        # íšŒì˜ ì£¼ì œ
        meeting.meeting_topic = st.text_area(
            "íšŒì˜ ì£¼ì œ",
            value=meeting.meeting_topic,
            help="í† ë¡ í•  ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”"
        )
        
        # íšŒì˜ ì‹œê°„ ì„¤ì •
        meeting.meeting_duration = st.slider(
            "íšŒì˜ ì‹œê°„ (ë¶„)",
            min_value=5,
            max_value=120,
            value=meeting.meeting_duration
        )
        
        # ìµœëŒ€ ë¼ìš´ë“œ ì„¤ì •
        meeting.max_rounds = st.slider(
            "ìµœëŒ€ ëŒ€í™” ë¼ìš´ë“œ",
            min_value=3,
            max_value=20,
            value=meeting.max_rounds
        )
        
        st.divider()
        
        # íŒŒì¼ ì—…ë¡œë“œ
        st.header("ğŸ“ ì°¸ê³  ìë£Œ ì—…ë¡œë“œ")
        uploaded_files = st.file_uploader(
            "íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”",
            type=['txt', 'pdf', 'docx', 'csv'],
            accept_multiple_files=True,
            help="í˜ë¥´ì†Œë‚˜ë“¤ì´ ì°¸ê³ í•  ìë£Œë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”"
        )
        
        if uploaded_files:
            if st.button("íŒŒì¼ ì²˜ë¦¬"):
                with st.spinner("íŒŒì¼ì„ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤..."):
                    combined_content = ""
                    for file in uploaded_files:
                        content = extract_text_from_file(file)
                        combined_content += f"\n--- {file.name} ---\n{content}\n"
                    
                    meeting.uploaded_files_content = combined_content
                    st.success(f"{len(uploaded_files)}ê°œ íŒŒì¼ì´ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤!")
        
        st.divider()
        
        # íšŒì˜ ì œì–´
        st.header("ğŸ® íšŒì˜ ì œì–´")
        
        if not meeting.is_active:
            if st.button("ğŸš€ íšŒì˜ ì‹œì‘", type="primary"):
                if meeting.meeting_topic and len(meeting.personas) > 1:
                    meeting.is_active = True
                    meeting.start_time = datetime.now()
                    meeting.conversation_round = 0
                    meeting.current_speaker_index = 0
                    st.success("íšŒì˜ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!")
                    st.rerun()
                else:
                    st.error("íšŒì˜ ì£¼ì œì™€ ìµœì†Œ 2ëª…ì˜ í˜ë¥´ì†Œë‚˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.")
        else:
            col1, col2 = st.columns(2)
            with col1:
                if st.button("â¸ï¸ íšŒì˜ ì¤‘ë‹¨"):
                    meeting.is_active = False
                    st.success("íšŒì˜ê°€ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.")
                    st.rerun()
            with col2:
                if st.button("ğŸ”„ íšŒì˜ ì¬ì‹œì‘"):
                    meeting.is_active = True
                    st.success("íšŒì˜ê°€ ì¬ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.")
                    st.rerun()
    
    # ë©”ì¸ ì˜ì—­
    tab1, tab2, tab3, tab4 = st.tabs(["ğŸ‘¥ í˜ë¥´ì†Œë‚˜ ê´€ë¦¬", "ğŸ’¬ ì‹¤ì‹œê°„ íšŒì˜", "ğŸ“Š íšŒì˜ í˜„í™©", "ğŸ“ íšŒì˜ë¡"])
    
    with tab1:
        st.header("ğŸ‘¥ í˜ë¥´ì†Œë‚˜ ê´€ë¦¬")
        
        # ìƒˆ í˜ë¥´ì†Œë‚˜ ì¶”ê°€
        with st.expander("â• ìƒˆ í˜ë¥´ì†Œë‚˜ ì¶”ê°€", expanded=False):
            with st.form("add_persona"):
                name = st.text_input("ì´ë¦„")
                role = st.text_input("ì—­í• ")
                expertise = st.text_input("ì „ë¬¸ ë¶„ì•¼")
                personality = st.text_area("ì„±ê²©/íŠ¹ì„±")
                speaking_style = st.text_input("ë§í•˜ëŠ” ìŠ¤íƒ€ì¼")
                prompt = st.text_area(
                    "ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸",
                    help="ì´ í˜ë¥´ì†Œë‚˜ì˜ í–‰ë™ì„ ì •ì˜í•˜ëŠ” í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                )
                
                if st.form_submit_button("í˜ë¥´ì†Œë‚˜ ì¶”ê°€"):
                    if name and role and prompt:
                        new_persona = Persona(
                            id=str(uuid.uuid4()),
                            name=name,
                            role=role,
                            prompt=prompt,
                            personality=personality,
                            expertise=expertise,
                            speaking_style=speaking_style
                        )
                        
                        if meeting.add_persona(new_persona):
                            st.success(f"{name} í˜ë¥´ì†Œë‚˜ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!")
                            st.rerun()
                        else:
                            st.error("ìµœëŒ€ 10ê°œì˜ í˜ë¥´ì†Œë‚˜ë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
                    else:
                        st.error("ì´ë¦„, ì—­í• , í”„ë¡¬í”„íŠ¸ëŠ” í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.")
        
        # ê¸°ì¡´ í˜ë¥´ì†Œë‚˜ ëª©ë¡
        st.subheader("í˜„ì¬ í˜ë¥´ì†Œë‚˜ ëª©ë¡")
        for i, persona in enumerate(meeting.personas):
            with st.expander(f"{'ğŸ¯' if persona.is_moderator else 'ğŸ­'} {persona.name} ({persona.role})"):
                st.write(f"**ì „ë¬¸ ë¶„ì•¼:** {persona.expertise}")
                st.write(f"**ì„±ê²©:** {persona.personality}")
                st.write(f"**ë§í•˜ëŠ” ìŠ¤íƒ€ì¼:** {persona.speaking_style}")
                st.write(f"**í”„ë¡¬í”„íŠ¸:** {persona.prompt}")
                
                if not persona.is_moderator:
                    if st.button(f"ğŸ—‘ï¸ ì‚­ì œ", key=f"delete_{persona.id}"):
                        meeting.remove_persona(persona.id)
                        st.success(f"{persona.name} í˜ë¥´ì†Œë‚˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.")
                        st.rerun()
    
    with tab2:
        st.header("ğŸ’¬ ì‹¤ì‹œê°„ íšŒì˜")
        
        if not meeting.is_active:
            st.info("íšŒì˜ë¥¼ ì‹œì‘í•˜ë ¤ë©´ ì‚¬ì´ë“œë°”ì—ì„œ 'íšŒì˜ ì‹œì‘' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.")
        else:
            # íšŒì˜ ì§„í–‰ ìƒí™©
            col1, col2, col3 = st.columns(3)
            with col1:
                elapsed_time = datetime.now() - meeting.start_time
                st.metric("ê²½ê³¼ ì‹œê°„", f"{elapsed_time.seconds // 60}ë¶„")
            with col2:
                st.metric("í˜„ì¬ ë¼ìš´ë“œ", f"{meeting.conversation_round + 1}/{meeting.max_rounds}")
            with col3:
                st.metric("ì´ ë©”ì‹œì§€", len(meeting.messages))
            
            # ì‚¬íšŒì ê°œì…
            st.subheader("ğŸ¯ ì‚¬íšŒì ê°œì…")
            moderator = meeting.get_moderator()
            if moderator:
                human_input = st.text_area(
                    f"{moderator.name}ë¡œì„œ ë°œì–¸",
                    key="moderator_input",
                    help="ì‚¬íšŒì ì—­í• ë¡œ íšŒì˜ ë°©í–¥ì„ ì œì‹œí•˜ê±°ë‚˜ ì˜ê²¬ì„ ì¶”ê°€í•˜ì„¸ìš”"
                )
                
                if st.button("ğŸ’¬ ë°œì–¸í•˜ê¸°"):
                    if human_input:
                        meeting.add_message(moderator.id, human_input, is_human_input=True)
                        st.success("ë°œì–¸ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!")
                        st.rerun()
            
            # ëŒ€í™” ì§„í–‰
            st.subheader("ğŸ—£ï¸ ëŒ€í™” ì§„í–‰")
            
            # ëŒ€í™” í‘œì‹œ ì˜ì—­
            conversation_placeholder = st.empty()
            
            # ìë™ ëŒ€í™” ì§„í–‰
            if st.button("â¡ï¸ ë‹¤ìŒ ë°œì–¸"):
                with st.spinner("AIê°€ ì‘ë‹µì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤..."):
                    success = run_conversation_round(meeting, conversation_placeholder)
                    if success:
                        st.rerun()
                    else:
                        st.info("íšŒì˜ê°€ ì¢…ë£Œë˜ì—ˆê±°ë‚˜ ë” ì´ìƒ ì§„í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            
            # ìë™ ì§„í–‰ ëª¨ë“œ
            auto_mode = st.checkbox("ğŸ”„ ìë™ ì§„í–‰ ëª¨ë“œ", help="ì²´í¬í•˜ë©´ ìë™ìœ¼ë¡œ ëŒ€í™”ê°€ ì§„í–‰ë©ë‹ˆë‹¤")
            
            if auto_mode and meeting.is_active:
                # ìë™ ì§„í–‰ ë¡œì§ì€ ë³„ë„ êµ¬í˜„ í•„ìš” (ë³µì¡ì„±ìœ¼ë¡œ ì¸í•´ ìˆ˜ë™ ì§„í–‰ìœ¼ë¡œ ëŒ€ì²´)
                st.info("ìë™ ì§„í–‰ ëª¨ë“œëŠ” 'ë‹¤ìŒ ë°œì–¸' ë²„íŠ¼ì„ ë°˜ë³µì ìœ¼ë¡œ í´ë¦­í•´ì£¼ì„¸ìš”.")
            
            # ëŒ€í™” ë‚´ìš© í‘œì‹œ
            with conversation_placeholder.container():
                for message in meeting.messages:
                    display_message(message)
    
    with tab3:
        st.header("ğŸ“Š íšŒì˜ í˜„í™©")
        
        if meeting.messages:
            # ë°œì–¸ í†µê³„
            speaker_stats = {}
            for message in meeting.messages:
                if message.persona_name in speaker_stats:
                    speaker_stats[message.persona_name] += 1
                else:
                    speaker_stats[message.persona_name] = 1
            
            # ë°œì–¸ íšŸìˆ˜ ì°¨íŠ¸
            if speaker_stats:
                st.subheader("ğŸ‘¤ ë°œì–¸ìë³„ í†µê³„")
                df_stats = pd.DataFrame(list(speaker_stats.items()), columns=['ë°œì–¸ì', 'ë°œì–¸ íšŸìˆ˜'])
                st.bar_chart(df_stats.set_index('ë°œì–¸ì'))
            
            # ìµœê·¼ í™œë™
            st.subheader("ğŸ• ìµœê·¼ í™œë™")
            recent_messages = meeting.messages[-5:] if len(meeting.messages) > 5 else meeting.messages
            for message in reversed(recent_messages):
                st.write(f"**{message.timestamp.strftime('%H:%M:%S')}** - {message.persona_name}: {message.content[:100]}...")
        else:
            st.info("ì•„ì§ íšŒì˜ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.")
    
    with tab4:
        st.header("ğŸ“ íšŒì˜ë¡")
        
        if meeting.messages:
            # íšŒì˜ë¡ ë‹¤ìš´ë¡œë“œ
            meeting_log = ""
            meeting_log += f"# íšŒì˜ë¡\n\n"
            meeting_log += f"**ì£¼ì œ:** {meeting.meeting_topic}\n"
            meeting_log += f"**ì‹œì‘ ì‹œê°„:** {meeting.start_time.strftime('%Y-%m-%d %H:%M:%S') if meeting.start_time else 'N/A'}\n"
            meeting_log += f"**ì°¸ì—¬ì:** {', '.join([p.name for p in meeting.personas])}\n\n"
            meeting_log += "## ëŒ€í™” ë‚´ìš©\n\n"
            
            for message in meeting.messages:
                meeting_log += f"**{message.persona_name}** ({message.timestamp.strftime('%H:%M:%S')})\n"
                meeting_log += f"{message.content}\n\n"
            
            st.download_button(
                label="ğŸ“¥ íšŒì˜ë¡ ë‹¤ìš´ë¡œë“œ",
                data=meeting_log,
                file_name=f"meeting_log_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md",
                mime="text/markdown"
            )
            
            # íšŒì˜ë¡ ë¯¸ë¦¬ë³´ê¸°
            st.subheader("ğŸ‘€ íšŒì˜ë¡ ë¯¸ë¦¬ë³´ê¸°")
            st.markdown(meeting_log)
        else:
            st.info("íšŒì˜ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.")

if __name__ == "__main__":
    main() 