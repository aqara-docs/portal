import streamlit as st
import random
import time
import pandas as pd
import numpy as np
from datetime import timedelta, datetime
import base64
from openai import OpenAI
import os
from dotenv import load_dotenv
import mysql.connector

# .env íŒŒì¼ ë¡œë“œ
load_dotenv()

st.set_page_config(page_title="ğŸ¯ ë…ì„œí† ë¡  ìˆœì„œì •í•˜ê¸°", page_icon="ğŸ¯", layout="wide")

# ì „ì²´ í˜ì´ì§€ ìŠ¤íƒ€ì¼ ì„¤ì •
st.markdown("""
<style>
    .stApp {
        background-color: #f0f2f6;
    }
    .character-card {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }
    .ability-text {
        color: #1f1f1f;
        font-size: 0.9em;
    }
    .character-name {
        color: #0066cc;
        font-weight: bold;
    }
    .special-effect {
        color: #ff4b4b;
        font-weight: bold;
    }
    h1, h2, h3, h4, h5, h6 {
        color: #1f1f1f !important;
    }
    .st-emotion-cache-1629p8f h1,
    .st-emotion-cache-1629p8f h2,
    .st-emotion-cache-1629p8f h3 {
        color: #1f1f1f !important;
    }
    .timer-display {
        color: #1f1f1f;
        font-size: 4rem;
        font-weight: bold;
        text-align: center;
    }
    .timer-status {
        font-size: 1.2rem;
        text-align: center;
    }
    @keyframes blink {
        0% { opacity: 1; }
        50% { opacity: 0; }
        100% { opacity: 1; }
    }
    
    .blink-warning {
        background: linear-gradient(145deg, #ff4b4b, #ff6b6b);
        color: white;
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        font-size: 24px;
        font-weight: bold;
        margin: 20px 0;
        animation: blink 1s infinite;
        box-shadow: 0 4px 8px rgba(255, 75, 75, 0.3);
    }
</style>
""", unsafe_allow_html=True)

# ì•ŒëŒ ì†Œë¦¬ ì¬ìƒì„ ìœ„í•œ JavaScript í•¨ìˆ˜ ìˆ˜ì •
def get_alarm_js():
    # Base64ë¡œ ì¸ì½”ë”©ëœ ì§§ì€ ë¹„í”„ìŒ MP3
    beep_sound = "data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjIwLjEwMAAAAAAAAAAAAAAA//tUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAAFbgCenp6enp6enp6enp6enp6e//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjM1AAAAAAAAAAAAAAAAJAAAAAAAAAAAAQVuha3nkgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//sUZAAP8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAETEFNRTMuMTAwVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV//sUZB4P8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAEVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV//sUZDwP8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAEVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV//sUZFoP8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAEVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV"
    
    return f"""
    <div style="display: none;">
        <audio id="beepAudio" style="display: none;">
            <source src="{beep_sound}" type="audio/mp3">
        </audio>
        <script>
        (function() {{
            let audio = document.getElementById('beepAudio');
            
            function playBeep() {{
                try {{
                    // ì˜¤ë””ì˜¤ ìš”ì†Œ ë³µì œ (ë™ì‹œ ì¬ìƒì„ ìœ„í•´)
                    let beep = audio.cloneNode(true);
                    beep.volume = 0.5;  // ë³¼ë¥¨ ì„¤ì •
                    beep.play()
                        .then(() => console.log("ë¹„í”„ìŒ ì¬ìƒ ì„±ê³µ"))
                        .catch(e => console.error("ë¹„í”„ìŒ ì¬ìƒ ì‹¤íŒ¨:", e));
                }} catch (e) {{
                    console.error("ì˜¤ë””ì˜¤ ì¬ìƒ ì¤‘ ì˜¤ë¥˜:", e);
                }}
            }}

            // ì „ì—­ ìŠ¤ì½”í”„ì— í•¨ìˆ˜ ë“±ë¡
            if (typeof window !== 'undefined') {{
                window.playBeep = playBeep;
            }}
        }})();
        </script>
    </div>
    """

# í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œë¥¼ ìœ„í•œ JavaScript í•¨ìˆ˜
def get_toast_notification_js():
    return """
    <style>
    .toast {
        visibility: hidden;
        min-width: 250px;
        margin-left: -125px;
        background-color: #ff4b4b;
        color: white;
        text-align: center;
        border-radius: 10px;
        padding: 16px;
        position: fixed;
        z-index: 1000;
        left: 50%;
        bottom: 30px;
        font-size: 18px;
        font-weight: bold;
        box-shadow: 0px 0px 10px rgba(0,0,0,0.5);
    }
    .toast.show {
        visibility: visible;
        animation: fadein 0.5s, fadeout 0.5s 2.5s;
    }
    @keyframes fadein {
        from {bottom: 0; opacity: 0;}
        to {bottom: 30px; opacity: 1;}
    }
    @keyframes fadeout {
        from {bottom: 30px; opacity: 1;}
        to {bottom: 0; opacity: 0;}
    }
    </style>
    <div id="toast" class="toast">â° ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</div>
    <script>
    function showToast(message) {
        var toast = document.getElementById("toast");
        toast.innerHTML = message;
        toast.className = "toast show";
        setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
    }
    </script>
    """

# TTS ê¸°ëŠ¥ì„ ìœ„í•œ JavaScript í•¨ìˆ˜ ì¶”ê°€
def get_tts_js():
    return """
    <script>
    function speakText(text) {
        // TTS ê¸°ëŠ¥ ì´ˆê¸°í™”
        const speech = new SpeechSynthesisUtterance();
        speech.lang = 'ko-KR';  // í•œêµ­ì–´ ì„¤ì •
        speech.text = text;
        speech.volume = 1;  // ë³¼ë¥¨ ì„¤ì • (0.0 ~ 1.0)
        speech.rate = 1;    // ì†ë„ ì„¤ì • (0.1 ~ 10)
        speech.pitch = 1;   // ìŒë†’ì´ ì„¤ì • (0 ~ 2)
        
        // TTS ì‹¤í–‰
        window.speechSynthesis.speak(speech);
    }
    
    // ì „ì—­ ìŠ¤ì½”í”„ì— í•¨ìˆ˜ ë“±ë¡
    window.speakText = speakText;
    </script>
    """

# ì°¸ì—¬ìë³„ ìºë¦­í„° ì„¤ì •
CHARACTERS = {
    "í˜„ì² ë‹˜": "ğŸ§™â€â™‚ï¸ ì§€í˜œì˜ í˜„ì",
    "ì°½í™˜ë‹˜": "ğŸš€ ë¯¸ë˜ì˜ ì„ êµ¬ì",
    "ì„±ë²”ë‹˜": "ğŸ¯ í†µì°°ì˜ ëŒ€ê°€",
    "ì„±í˜„ë‹˜": "ğŸŒŸ ì°½ì˜ì˜ ì—°ê¸ˆìˆ ì‚¬",
    "ìƒí˜„ë‹˜": "ğŸ­ ì§ˆë¬¸ì˜ ì˜ˆìˆ ê°€",
    "ì„±ì¼ë‹˜": "ğŸŒˆ í˜ì‹ ì˜ ì•„ì´ì½˜"
}

# íŠ¹ë³„í•œ ëŠ¥ë ¥ì¹˜
ABILITIES = {
    "í˜„ì² ë‹˜": ["í†µì°°ë ¥ MAX", "ì§€í˜œ +100", "ê²½í—˜ì¹˜ +500"],
    "ì°½í™˜ë‹˜": ["ì°½ì˜ë ¥ MAX", "í˜ì‹  +100", "ì„ êµ¬ì•ˆ +500"],
    "ì„±ë²”ë‹˜": ["ë¶„ì„ë ¥ MAX", "ì „ëµ +100", "ì‹¤í–‰ë ¥ +500"],
    "ì„±í˜„ë‹˜": ["ì°½ì¡°ë ¥ MAX", "ë°œìƒ +100", "ê¸°íšë ¥ +500"],
    "ìƒí˜„ë‹˜": ["ì§ˆë¬¸ë ¥ MAX", "íƒêµ¬ +100", "í˜¸ê¸°ì‹¬ +500"],
    "ì„±ì¼ë‹˜": ["í˜ì‹ ë ¥ MAX", "ì°½ì˜ì„± +100", "ì ì‘ë ¥ +500"]
}

# ìš”ì¼ë³„ í…Œë§ˆ ì„¤ì •
THEMES = {
    "ì›”ìš”ì¼": {
        "name": "ğŸ¯ ìºë¦­í„° ë£°ë ›",
        "description": "ê°ìì˜ ìºë¦­í„°ë¡œ ì§„í–‰í•˜ëŠ” í´ë˜ì‹í•œ ë£°ë › ë°©ì‹",
        "style": "classic"
    },
    "í™”ìš”ì¼": {
        "name": "ğŸ² ì£¼ì‚¬ìœ„ ë°°í‹€",
        "description": "ê°ì ì£¼ì‚¬ìœ„ë¥¼ êµ´ë ¤ ë†’ì€ ìˆ«ìê°€ ë‚˜ì˜¨ ìˆœì„œëŒ€ë¡œ ì§„í–‰",
        "style": "dice"
    },
    "ìˆ˜ìš”ì¼": {
        "name": "ğŸƒ ì¹´ë“œ ë“œë¡œìš°",
        "description": "ê°ì ì¹´ë“œë¥¼ ë½‘ì•„ ì¹´ë“œ ìˆ«ì ìˆœì„œëŒ€ë¡œ ì§„í–‰",
        "style": "cards"
    },
    "ëª©ìš”ì¼": {
        "name": "ğŸ® RPG í€˜ìŠ¤íŠ¸",
        "description": "RPG ìŠ¤íƒ€ì¼ì˜ ë¯¸ë‹ˆê²Œì„ìœ¼ë¡œ ìˆœì„œ ê²°ì •",
        "style": "rpg"
    },
    "ê¸ˆìš”ì¼": {
        "name": "ğŸª ëœë¤ ë¯¸ì…˜",
        "description": "ì¬ë¯¸ìˆëŠ” ë¯¸ì…˜ì„ ìˆ˜í–‰í•˜ì—¬ ìˆœì„œ ê²°ì •",
        "style": "mission"
    }
}

# ì£¼ì‚¬ìœ„ ë°°í‹€ìš© íš¨ê³¼
DICE_EFFECTS = {
    6: "ğŸŒŸ í¬ë¦¬í‹°ì»¬ íˆíŠ¸! 2ë°° ë°ë¯¸ì§€",
    5: "âœ¨ ê°•í™” ì£¼ì‚¬ìœ„! +2 ë³´ë„ˆìŠ¤",
    4: "ğŸ’« ëŸ­í‚¤ í¬ì¸íŠ¸! +1 ë³´ë„ˆìŠ¤",
    3: "ğŸ¯ ì•ˆì •ì ì¸ êµ´ë¦¼!",
    2: "ğŸ˜… ì•„ì‰¬ìš´ êµ´ë¦¼...",
    1: "ğŸ’” í¬ë¦¬í‹°ì»¬ ë¯¸ìŠ¤..."
}

# ì¹´ë“œ ë“œë¡œìš°ìš© ì¹´ë“œ ì„¤ì •
CARDS = {
    "A": "ğŸ‘‘ ì—ì´ìŠ¤ì˜ ê¸°í’ˆ",
    "K": "ğŸ‘‘ ì™•ì˜ ì¹´ë¦¬ìŠ¤ë§ˆ",
    "Q": "ğŸ‘‘ ì—¬ì™•ì˜ ìš°ì•„í•¨",
    "J": "ğŸ‘‘ ê¸°ì‚¬ì˜ ìš©ë§¹",
    "10": "ğŸŒŸ ì™„ë²½í•œ ê· í˜•",
    "9": "âœ¨ ë†’ì€ ì—ë„ˆì§€",
    "8": "ğŸ’« ì•ˆì •ì ì¸ í˜",
    "7": "ğŸ¯ í–‰ìš´ì˜ ìˆ«ì",
    "6": "ğŸ’ª ë„ì „ì ì¸ ì •ì‹ ",
    "5": "ğŸ­ ë³€í™”ì˜ ê¸°ìš´",
    "4": "ğŸª ì‹ ë¹„í•œ í˜",
    "3": "ğŸ² ê¸°íšŒì˜ ìˆ«ì",
    "2": "ğŸƒ ë°˜ì „ì˜ ê¸°íšŒ"
}

# RPG í€˜ìŠ¤íŠ¸ìš© ìŠ¤íƒ¯
RPG_STATS = {
    "í˜„ì² ë‹˜": {"ì§€í˜œ": 90, "í†µì°°ë ¥": 95, "ê²½í—˜": 88},
    "ì°½í™˜ë‹˜": {"ì°½ì˜ë ¥": 92, "í˜ì‹ ": 94, "ì„ êµ¬ì•ˆ": 89},
    "ì„±ë²”ë‹˜": {"ë¶„ì„ë ¥": 93, "ì „ëµ": 91, "ì‹¤í–‰ë ¥": 90},
    "ì„±í˜„ë‹˜": {"ì°½ì¡°ë ¥": 91, "ë°œìƒ": 93, "ê¸°íšë ¥": 92},
    "ìƒí˜„ë‹˜": {"ì§ˆë¬¸ë ¥": 94, "íƒêµ¬": 92, "í˜¸ê¸°ì‹¬": 91},
    "ì„±ì¼ë‹˜": {"í˜ì‹ ë ¥": 93, "ì°½ì˜ì„±": 94, "ì ì‘ë ¥": 92}
}

# ëœë¤ ë¯¸ì…˜ ëª©ë¡
MISSIONS = [
    "ğŸ“š ê°€ì¥ ìµœê·¼ì— ì½ì€ ì±… ì œëª© ë§í•˜ê¸°",
    "ğŸ’¡ ì´ë²ˆ ì£¼ ìµœê³ ì˜ ì•„ì´ë””ì–´ ê³µìœ í•˜ê¸°",
    "ğŸ¯ í•œ ë¬¸ì¥ìœ¼ë¡œ ì´ë²ˆ ì£¼ ëª©í‘œ ì„¤ëª…í•˜ê¸°",
    "ğŸŒŸ ê°€ì¥ ì¸ìƒ ê¹Šì—ˆë˜ ì±… êµ¬ì ˆ ì•”ê¸°í•˜ê¸°",
    "ğŸ­ ì±… ì† í•œ ì¥ë©´ ì—°ê¸°í•˜ê¸°"
]

# íƒ€ì´ë¨¸ ê´€ë ¨ session_state ì´ˆê¸°í™” í•¨ìˆ˜ ì¶”ê°€
def init_timer_state():
    if 'timer_started' not in st.session_state:
        st.session_state.timer_started = False
    if 'start_time' not in st.session_state:
        st.session_state.start_time = None
    if 'duration' not in st.session_state:
        st.session_state.duration = timedelta(minutes=20)
    if 'timer_finished' not in st.session_state:
        st.session_state.timer_finished = False
    if 'alarm_enabled' not in st.session_state:
        st.session_state.alarm_enabled = True
    if 'toast_enabled' not in st.session_state:
        st.session_state.toast_enabled = True

def format_time(td):
    """íƒ€ì„ë¸íƒ€ë¥¼ MM:SS í˜•ì‹ìœ¼ë¡œ ë³€í™˜"""
    total_seconds = int(td.total_seconds())
    minutes = total_seconds // 60
    seconds = total_seconds % 60
    return f"{minutes:02d}:{seconds:02d}"

def get_timer_status(remaining):
    """ë‚¨ì€ ì‹œê°„ì— ë”°ë¥¸ ìƒíƒœ ë©”ì‹œì§€ì™€ ìƒ‰ìƒ ë°˜í™˜"""
    if remaining.total_seconds() <= 60:
        return "âš ï¸ 1ë¶„ ë‚¨ì•˜ìŠµë‹ˆë‹¤!", "#ff4b4b"
    elif remaining.total_seconds() <= 300:
        return "ğŸ•’ 5ë¶„ ë¯¸ë§Œ ë‚¨ì•˜ìŠµë‹ˆë‹¤", "#ff9900"
    else:
        return "í† ë¡ ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤", "#666666"

def generate_roulette_animation():
    """ë£°ë › ì• ë‹ˆë©”ì´ì…˜ ìƒì„±"""
    placeholder = st.empty()
    participants = list(CHARACTERS.keys())
    for _ in range(20):  # 20í”„ë ˆì„ì˜ ì• ë‹ˆë©”ì´ì…˜
        random.shuffle(participants)
        display_text = "\n".join([f"### {CHARACTERS[p]}" for p in participants[:5]])
        placeholder.markdown(display_text)
        time.sleep(0.1)
    return placeholder

def get_special_effect():
    """íŠ¹ë³„ íš¨ê³¼ ìƒì„±"""
    effects = [
        "ğŸŒˆ ë…ì„œë ¥ 2ë°° ì¦ê°€!",
        "ğŸ’« í†µì°°ë ¥ ë ˆë²¨ UP!",
        "ğŸ­ í† ë¡  ìŠ¤í‚¬ ê°•í™”!",
        "ğŸ¯ ì§‘ì¤‘ë ¥ MAX!",
        "ğŸš€ ì•„ì´ë””ì–´ í­ë°œ!",
        "ğŸ§  ë¸Œë ˆì¸ìŠ¤í† ë° íŒŒì›Œ!"
    ]
    return random.choice(effects)

def generate_dice_battle():
    """ì£¼ì‚¬ìœ„ ë°°í‹€ ì§„í–‰"""
    results = {}
    for person in CHARACTERS.keys():
        dice = random.randint(1, 6)
        bonus = random.randint(0, 2)
        total = dice + bonus
        results[person] = {
            "dice": dice,
            "bonus": bonus,
            "total": total,
            "effect": DICE_EFFECTS[dice]
        }
    return dict(sorted(results.items(), key=lambda x: (-x[1]['total'], random.random())))

def draw_cards():
    """ì¹´ë“œ ë“œë¡œìš° ì§„í–‰"""
    card_values = list(CARDS.keys())
    results = {}
    drawn_cards = random.sample(card_values, len(CHARACTERS))
    for person, card in zip(CHARACTERS.keys(), drawn_cards):
        results[person] = {
            "card": card,
            "effect": CARDS[card]
        }
    return dict(sorted(results.items(), key=lambda x: card_values.index(x[1]['card'])))

def rpg_quest():
    """RPG í€˜ìŠ¤íŠ¸ ì§„í–‰"""
    results = {}
    quest_type = random.choice(list(next(iter(RPG_STATS.values())).keys()))
    for person, stats in RPG_STATS.items():
        base_score = stats[quest_type]
        roll = random.randint(1, 20)
        total = base_score + roll
        results[person] = {
            "stat": quest_type,
            "base": base_score,
            "roll": roll,
            "total": total
        }
    return dict(sorted(results.items(), key=lambda x: (-x[1]['total'], random.random())))

def random_mission():
    """ëœë¤ ë¯¸ì…˜ ìˆ˜í–‰"""
    results = {}
    for person in CHARACTERS.keys():
        mission = random.choice(MISSIONS)
        score = random.randint(70, 100)
        results[person] = {
            "mission": mission,
            "score": score,
            "feedback": get_mission_feedback(score)
        }
    return dict(sorted(results.items(), key=lambda x: (-x[1]['score'], random.random())))

def get_mission_feedback(score):
    """ë¯¸ì…˜ ì ìˆ˜ì— ë”°ë¥¸ í”¼ë“œë°± ìƒì„±"""
    if score >= 90:
        return "ğŸŒŸ ì™„ë²½í•œ ìˆ˜í–‰!"
    elif score >= 80:
        return "âœ¨ í›Œë¥­í•œ ìˆ˜í–‰!"
    elif score >= 70:
        return "ğŸ’« ì¢‹ì€ ì‹œë„!"
    else:
        return "ğŸ¯ ë‹¤ìŒì„ ê¸°ëŒ€í•´ìš”!"

# ë” ê°•ë ¥í•œ ì‹œê°ì  ì•Œë¦¼ íš¨ê³¼ ì¶”ê°€
st.markdown("""
<style>
@keyframes blink-intense {
    0% { transform: scale(1); background: linear-gradient(145deg, #ff4b4b, #ff6b6b); }
    50% { transform: scale(1.05); background: linear-gradient(145deg, #ff6b6b, #ff8b8b); }
    100% { transform: scale(1); background: linear-gradient(145deg, #ff4b4b, #ff6b6b); }
}

.intense-warning {
    background: linear-gradient(145deg, #ff4b4b, #ff6b6b);
    color: white;
    padding: 20px;
    border-radius: 15px;
    text-align: center;
    font-size: 28px;
    font-weight: bold;
    margin: 20px 0;
    animation: blink-intense 0.7s infinite;
    box-shadow: 0 4px 15px rgba(255, 75, 75, 0.5);
}

.shake {
    animation: shake 0.5s infinite;
}

@keyframes shake {
    0% { transform: translate(1px, 1px) rotate(0deg); }
    10% { transform: translate(-1px, -2px) rotate(-1deg); }
    20% { transform: translate(-3px, 0px) rotate(1deg); }
    30% { transform: translate(3px, 2px) rotate(0deg); }
    40% { transform: translate(1px, -1px) rotate(1deg); }
    50% { transform: translate(-1px, 2px) rotate(-1deg); }
    60% { transform: translate(-3px, 1px) rotate(0deg); }
    70% { transform: translate(3px, 1px) rotate(-1deg); }
    80% { transform: translate(-1px, -1px) rotate(1deg); }
    90% { transform: translate(1px, 2px) rotate(0deg); }
    100% { transform: translate(1px, -2px) rotate(-1deg); }
}
</style>
""", unsafe_allow_html=True)

# íƒ€ì´ë¨¸ ì¢…ë£Œ ì‹œ ì „ì²´ í™”ë©´ ì•Œë¦¼ íš¨ê³¼
st.markdown("""
<style>
/* ì „ì²´ í™”ë©´ ì˜¤ë²„ë ˆì´ */
.fullscreen-alert {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(255, 75, 75, 0.95);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { background: rgba(255, 75, 75, 0.95); }
    50% { background: rgba(255, 75, 75, 0.7); }
    100% { background: rgba(255, 75, 75, 0.95); }
}

/* ì•Œë¦¼ ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ */
.alert-content {
    background: white;
    padding: 2rem;
    border-radius: 20px;
    text-align: center;
    box-shadow: 0 0 30px rgba(0,0,0,0.3);
    animation: bounce 1s infinite;
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-20px); }
}

/* í° ì‹œê³„ ì´ëª¨ì§€ */
.large-emoji {
    font-size: 5rem;
    margin-bottom: 1rem;
}

/* ì•Œë¦¼ í…ìŠ¤íŠ¸ */
.alert-text {
    font-size: 2rem;
    font-weight: bold;
    color: #ff4b4b;
    margin: 1rem 0;
}

/* ì„œë¸Œ í…ìŠ¤íŠ¸ */
.alert-subtext {
    font-size: 1.2rem;
    color: #666;
}
</style>
""", unsafe_allow_html=True)

def get_audio_js():
    return """
    <div style="display: none;">
        <script>
        let audioContext = null;
        let isAudioInitialized = false;

        // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™” í•¨ìˆ˜
        async function initAudioContext() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                await audioContext.resume();
                isAudioInitialized = true;
                console.log('ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™” ì„±ê³µ');
            } catch (e) {
                console.error('ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨:', e);
            }
        }

        // ë¹„í”„ìŒ ì¬ìƒ í•¨ìˆ˜
        async function playBeep() {
            if (!isAudioInitialized) {
                await initAudioContext();
            }

            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);

                console.log('ë¹„í”„ìŒ ì¬ìƒ ì„±ê³µ');
            } catch (e) {
                console.error('ë¹„í”„ìŒ ì¬ìƒ ì‹¤íŒ¨:', e);
            }
        }

        // ì „ì—­ ìŠ¤ì½”í”„ì— í•¨ìˆ˜ ë“±ë¡
        window.initAudioContext = initAudioContext;
        window.playBeep = playBeep;
        </script>
    </div>
    """

# ì•ŒëŒ ìŒì„± ìƒì„± í•¨ìˆ˜
def generate_alarm_audio():
    try:
        client = OpenAI(api_key=os.getenv('OPENAI_API_KEY'))
        if not os.getenv('OPENAI_API_KEY'):
            st.error("OpenAI API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            return None
            
        # ì•ŒëŒ ë©”ì‹œì§€ ìƒì„± (ë” ìì—°ìŠ¤ëŸ¬ìš´ ë¬¸ì¥ìœ¼ë¡œ)
        alarm_text = """
        í† ë¡  ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.
        í† ë¡ ì„ ë§ˆë¬´ë¦¬í•´ ì£¼ì„¸ìš”.
        í† ë¡ ì„ ë§ˆë¬´ë¦¬í•´ ì£¼ì„¸ìš”.
        í† ë¡ ì„ ë§ˆë¬´ë¦¬í•´ ì£¼ì„¸ìš”.
        """
        
        # ìŒì„± ìƒì„± (í•œêµ­ì–´ ìŒì„±ìœ¼ë¡œ ì„¤ì •)
        response = client.audio.speech.create(
            model="tts-1",
            voice="nova",  # ë” ìì—°ìŠ¤ëŸ¬ìš´ ëª©ì†Œë¦¬ ì„ íƒ
            input=alarm_text,
            speed=0.9  # ì•½ê°„ ì²œì²œíˆ ë§í•˜ë„ë¡ ì„¤ì •
        )
        
        # ìŒì„± ë°ì´í„°ë¥¼ base64ë¡œ ì¸ì½”ë”©
        audio_base64 = base64.b64encode(response.content).decode('utf-8')
        return audio_base64
        
    except Exception as e:
        st.error(f"ì•ŒëŒ ìŒì„± ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
        return None

# DB ì„¤ì •
db_config = {
    'user': os.getenv('SQL_USER'),
    'password': os.getenv('SQL_PASSWORD'),
    'host': os.getenv('SQL_HOST'),
    'database': os.getenv('SQL_DATABASE_NEWBIZ'),
    'charset': 'utf8mb4',
    'collation': 'utf8mb4_unicode_ci'
}

def get_mission_vision_values():
    """ë¯¸ì…˜/ë¹„ì „/ê°€ì¹˜/ì›ì¹™ ë°ì´í„°ë¥¼ ëª¨ë‘ ê°€ì ¸ì˜´"""
    try:
        conn = mysql.connector.connect(**db_config)
        cursor = conn.cursor(dictionary=True)
        
        all_items = []
        
        # ë¯¸ì…˜ & ë¹„ì „
        cursor.execute("SELECT mission_text, vision_text FROM mission_vision LIMIT 1")
        mission_vision = cursor.fetchone()
        if mission_vision:
            all_items.extend([
                f"ğŸ¯ ë¯¸ì…˜: {mission_vision['mission_text']}",
                f"ğŸŒŸ ë¹„ì „: {mission_vision['vision_text']}"
            ])
        
        # í•µì‹¬ ê°€ì¹˜
        cursor.execute("SELECT value_title, value_description FROM core_values ORDER BY sort_order")
        values = cursor.fetchall()
        all_items.extend([f"ğŸ’ í•µì‹¬ê°€ì¹˜ - {value['value_title']}: {value['value_description']}" for value in values])
        
        # í•µì‹¬ ëª©í‘œ
        cursor.execute("SELECT category, objective_text FROM key_objectives ORDER BY category, sort_order")
        objectives = cursor.fetchall()
        all_items.extend([f"ğŸ¯ {obj['category']}: {obj['objective_text']}" for obj in objectives])
        
        # ì›ì¹™ ë°ì´í„°
        # ì„œë¬¸
        cursor.execute("SELECT intro_text FROM introduction LIMIT 1")
        intro = cursor.fetchone()
        if intro:
            all_items.append(f"ğŸ“œ ì„œë¬¸: {intro['intro_text']}")
        
        # ìš”ì•½
        cursor.execute("SELECT summary_title, summary_text FROM summary")
        summaries = cursor.fetchall()
        all_items.extend([f"ğŸ“‹ {summary['summary_title']}: {summary['summary_text']}" for summary in summaries])
        
        # ì›ì¹™
        cursor.execute("""
            SELECT 
                p.principle_number,
                p.principle_title,
                sp.sub_principle_number,
                sp.sub_principle_title,
                ai.action_item_text
            FROM principles p
            LEFT JOIN sub_principles sp ON p.principle_id = sp.principle_id
            LEFT JOIN action_items ai ON sp.sub_principle_id = ai.sub_principle_id
            ORDER BY p.principle_number, sp.sub_principle_number
        """)
        principles = cursor.fetchall()
        
        current_principle = None
        for p in principles:
            if current_principle != p['principle_number']:
                current_principle = p['principle_number']
                all_items.append(f"ğŸ“Œ ì›ì¹™ {p['principle_number']}: {p['principle_title']}")
            if p['sub_principle_title']:
                all_items.append(f"   â”” {p['sub_principle_number']} {p['sub_principle_title']}")
            if p['action_item_text']:
                all_items.append(f"      â–ª {p['action_item_text']}")
        
        cursor.close()
        conn.close()
        
        return all_items
    except Exception as e:
        st.error(f"ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
        return []

def init_values_state():
    """ë¯¸ì…˜/ë¹„ì „/ê°€ì¹˜ í‘œì‹œë¥¼ ìœ„í•œ ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”"""
    if 'values_state' not in st.session_state:
        st.session_state.values_state = {
            'all_items': [],  # ëª¨ë“  í•­ëª©ì„ ì €ì¥í•  ë¦¬ìŠ¤íŠ¸
            'current_index': 0  # í˜„ì¬ í‘œì‹œí•  í•­ëª©ì˜ ì¸ë±ìŠ¤
        }
        
        # ë¯¸ì…˜/ë¹„ì „ ê°€ì ¸ì˜¤ê¸°
        mission_vision = get_mission_vision_values()
        if mission_vision:
            st.session_state.values_state['all_items'].extend(mission_vision)

def display_current_value():
    """í˜„ì¬ í•­ëª© í‘œì‹œ"""
    if not st.session_state.values_state['all_items']:
        return
    
    current_item = st.session_state.values_state['all_items'][st.session_state.values_state['current_index']]
    total_items = len(st.session_state.values_state['all_items'])
    
    st.markdown(f"""
    <div style="
        background: linear-gradient(145deg, #ffffff, #f0f0f0);
        padding: 20px;
        border-radius: 10px;
        box-shadow: 3px 3px 6px #d9d9d9, -3px -3px 6px #ffffff;
        margin: 10px 0;
        font-size: 16px;
        color: #1f1f1f;
        text-align: center;
    ">
        {current_item}
        <div style="font-size: 12px; color: #666; margin-top: 10px;">
            {st.session_state.values_state['current_index'] + 1} / {total_items}
        </div>
    </div>
    """, unsafe_allow_html=True)
    
    # ë‹¤ìŒ í•­ëª©ìœ¼ë¡œ ì´ë™
    st.session_state.values_state['current_index'] = (st.session_state.values_state['current_index'] + 1) % total_items

def main():
    st.markdown('<h1 style="color: black;">ğŸ¯ ë…ì„œí† ë¡  ìˆœì„œ ì •í•˜ê¸°</h1>', unsafe_allow_html=True)
    st.markdown('<h3 style="color: black;">ğŸ² ì˜¤ëŠ˜ì˜ í† ë¡  ë©¤ë²„ë¥¼ í™•ì¸í•˜ì„¸ìš”!</h3>', unsafe_allow_html=True)

    # JavaScript ì½”ë“œ ì‚½ì…
    st.markdown(get_alarm_js(), unsafe_allow_html=True)
    st.markdown(get_toast_notification_js(), unsafe_allow_html=True)
    st.markdown(get_tts_js(), unsafe_allow_html=True)
    st.markdown(get_audio_js(), unsafe_allow_html=True)

    # ìºë¦­í„° ì†Œê°œ
    cols = st.columns(6)  # 5ì—ì„œ 6ìœ¼ë¡œ ë³€ê²½
    for i, (person, character) in enumerate(CHARACTERS.items()):
        with cols[i]:
            st.markdown(f"""
            <div class="character-card">
                <h3>{character}</h3>
                <p class="character-name">{person}</p>
            </div>
            """, unsafe_allow_html=True)

    st.markdown("---")

    if 'order_generated' not in st.session_state:
        st.session_state.order_generated = False
        st.session_state.final_order = []
        st.session_state.effects = {}

    if not st.session_state.order_generated:
        if st.button("ğŸ¯ ë°œí‘œ ìˆœì„œ ì •í•˜ê¸°!", use_container_width=True):
            with st.spinner("ìˆœì„œë¥¼ ì •í•˜ëŠ” ì¤‘..."):
                placeholder = generate_roulette_animation()
                participants = list(CHARACTERS.keys())
                random.shuffle(participants)
                st.session_state.final_order = participants
                st.session_state.effects = {person: get_special_effect() for person in participants}
                st.session_state.order_generated = True
                st.balloons()
                st.snow()
                st.rerun()

    if st.session_state.order_generated:
        col1, col2 = st.columns([1, 1], gap="large")
        
        with col1:
            st.markdown('<h2 style="color: black; font-size: 24px; margin-bottom: 20px;">ğŸ‰ ë°œí‘œ ìˆœì„œ</h2>', unsafe_allow_html=True)
            # ìˆœì„œ ì¹´ë“œë¥¼ ë” ì‘ê³  ì¡°ë°€í•˜ê²Œ í‘œì‹œ
            for i, person in enumerate(st.session_state.final_order, 1):
                st.markdown(f"""
                <div style="background: linear-gradient(145deg, #ffffff, #f0f0f0);
                           padding: 10px;
                           border-radius: 8px;
                           margin: 5px 0;
                           box-shadow: 3px 3px 6px #d9d9d9, -3px -3px 6px #ffffff;">
                    <div style="color: #0066cc; margin: 0; font-size: 16px; display: flex; align-items: center;">
                        <span style="font-weight: bold; min-width: 24px;">{i}.</span>
                        <span style="margin-left: 8px;">{person}</span>
                        <span style="margin-left: 8px; opacity: 0.8;">{CHARACTERS[person]}</span>
                    </div>
                </div>
                """, unsafe_allow_html=True)
        
        with col2:
            st.markdown('<h2 style="color: black; font-size: 24px; margin-bottom: 20px;">â±ï¸ í† ë¡  íƒ€ì´ë¨¸</h2>', unsafe_allow_html=True)
            init_timer_state()
            init_values_state()  # ë¯¸ì…˜/ë¹„ì „/ê°€ì¹˜ ìƒíƒœ ì´ˆê¸°í™”
            
            # ì•ŒëŒ ì„¤ì • ì¶”ê°€
            with st.expander("âš™ï¸ ì•ŒëŒ ì„¤ì •"):
                # ì „ì²´ ìŠ¤íƒ€ì¼ ìˆ˜ì •
                st.markdown("""
                <style>
                    /* Streamlit expander ë‚´ë¶€ ìŠ¤íƒ€ì¼ */
                    .streamlit-expanderHeader {
                        color: #000000 !important;
                        background-color: #f8f9fa !important;
                    }
                    
                    /* ì²´í¬ë°•ìŠ¤ ë¼ë²¨ ìŠ¤íƒ€ì¼ */
                    div[data-testid="stCheckbox"] label {
                        color: #000000 !important;
                    }
                    
                    /* ìŠ¬ë¼ì´ë” ë¼ë²¨ ìŠ¤íƒ€ì¼ */
                    div[data-testid="stSlider"] label {
                        color: #000000 !important;
                    }
                    
                    /* ì•ŒëŒ ì„¤ì • ì»¨í…Œì´ë„ˆ */
                    .settings-container {
                        background-color: #f8f9fa;
                        padding: 15px;
                        border-radius: 10px;
                        margin: 10px 0;
                    }
                </style>
                """, unsafe_allow_html=True)
                
                # ì•ŒëŒ ì„¤ì • ì»¨í…Œì´ë„ˆ ì‹œì‘
                st.markdown('<div class="settings-container">', unsafe_allow_html=True)
                
                # ì•ŒëŒ ì†Œë¦¬ ì„¤ì •
                st.markdown('<p style="color: #000000; font-weight: 500; margin-bottom: 10px;">ì•ŒëŒ ì„¤ì •</p>', unsafe_allow_html=True)
                
                col1, col2 = st.columns(2)
                with col1:
                    st.markdown('<div style="color: #000000;">', unsafe_allow_html=True)
                    st.session_state.alarm_enabled = st.checkbox(
                        "ğŸ”” ì†Œë¦¬ ì•Œë¦¼",
                        value=st.session_state.alarm_enabled,
                        key="alarm_sound",
                        help="íƒ€ì´ë¨¸ ì¢…ë£Œ ì‹œ ì•ŒëŒ ì†Œë¦¬ë¥¼ ì¬ìƒí•©ë‹ˆë‹¤"
                    )
                    st.markdown('</div>', unsafe_allow_html=True)
                
                with col2:
                    st.markdown('<div style="color: #000000;">', unsafe_allow_html=True)
                    st.session_state.toast_enabled = st.checkbox(
                        "ğŸ“± í™”ë©´ ì•Œë¦¼",
                        value=st.session_state.toast_enabled,
                        key="toast_notification",
                        help="íƒ€ì´ë¨¸ ì¢…ë£Œ ì‹œ í™”ë©´ì— ì•Œë¦¼ì„ í‘œì‹œí•©ë‹ˆë‹¤"
                    )
                    st.markdown('</div>', unsafe_allow_html=True)
                
                # íƒ€ì´ë¨¸ ì„¤ì •
                st.markdown('<p style="color: #000000; font-weight: 500; margin: 15px 0 10px 0;">â° íƒ€ì´ë¨¸ ì„¤ì •</p>', unsafe_allow_html=True)
                st.markdown('<div style="color: #000000;">', unsafe_allow_html=True)
                timer_duration = st.slider(
                    "ì‹œê°„ (ë¶„)",
                    min_value=1,
                    max_value=30,
                    value=int(st.session_state.duration.total_seconds() // 60),
                    key="timer_duration",
                    help="í† ë¡  ì‹œê°„ì„ ì„¤ì •í•©ë‹ˆë‹¤"
                )
                st.markdown('</div>', unsafe_allow_html=True)
                
                # ì•ŒëŒ ì„¤ì • ì»¨í…Œì´ë„ˆ ì¢…ë£Œ
                st.markdown('</div>', unsafe_allow_html=True)
                
                st.session_state.duration = timedelta(minutes=timer_duration)
            
            if not st.session_state.timer_started:
                if st.button("â±ï¸ í† ë¡  ì‹œì‘í•˜ê¸°", use_container_width=True):
                    st.markdown("""
                    <script>
                    // ì‚¬ìš©ì ìƒí˜¸ì‘ìš©ìœ¼ë¡œ ì˜¤ë””ì˜¤ ì´ˆê¸°í™”
                    document.addEventListener('click', async function initAudio() {
                        await initAudioContext();
                        // ì´ˆê¸°í™” í™•ì¸ì„ ìœ„í•œ ì§§ì€ ë¬´ìŒ ì¬ìƒ
                        const testOscillator = audioContext.createOscillator();
                        const testGain = audioContext.createGain();
                        testGain.gain.value = 0.0001;  // ê±°ì˜ ë“¤ë¦¬ì§€ ì•ŠëŠ” ë³¼ë¥¨
                        testOscillator.connect(testGain);
                        testGain.connect(audioContext.destination);
                        testOscillator.start();
                        testOscillator.stop(audioContext.currentTime + 0.1);
                        console.log('ì˜¤ë””ì˜¤ ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ');
                    }, { once: true });
                    </script>
                    """, unsafe_allow_html=True)
                    st.session_state.timer_started = True
                    st.session_state.start_time = datetime.now()
                    st.session_state.timer_finished = False
                    st.rerun()
            else:
                current_time = datetime.now()
                elapsed = current_time - st.session_state.start_time
                remaining = st.session_state.duration - elapsed
                
                if remaining.total_seconds() <= 0:
                    if not st.session_state.timer_finished:
                        st.session_state.timer_finished = True
                        
                        # ì•ŒëŒ ìŒì„±ê³¼ ì‹œê°ì  íš¨ê³¼ í•¨ê»˜ í‘œì‹œ
                        st.markdown(f"""
                        <div class="fullscreen-alert">
                            <div class="alert-content">
                                <div class="large-emoji">â°</div>
                                <div class="alert-text">ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</div>
                                <div class="alert-subtext">í† ë¡ ì„ ë§ˆë¬´ë¦¬í•´ ì£¼ì„¸ìš”</div>
                            </div>
                        </div>
                        <audio id="alarmAudio" autoplay style="display: none;">
                            <source src="data:audio/mp3;base64,{st.session_state.alarm_audio}" type="audio/mp3">
                        </audio>
                        <script>
                        // ì•ŒëŒ ìŒì„± ìë™ ì¬ìƒ ë° ë°˜ë³µ
                        const audio = document.getElementById('alarmAudio');
                        
                        function playAlarm() {{
                            audio.currentTime = 0;
                            audio.play()
                                .then(() => console.log('ì•ŒëŒ ì¬ìƒ ì„±ê³µ'))
                                .catch(e => console.error('ì•ŒëŒ ì¬ìƒ ì‹¤íŒ¨:', e));
                        }}
                        
                        // ì´ˆê¸° ì¬ìƒ
                        playAlarm();
                        
                        // 2ì´ˆ ê°„ê²©ìœ¼ë¡œ 3ë²ˆ ë°˜ë³µ ì¬ìƒ
                        let playCount = 0;
                        const interval = setInterval(() => {{
                            playCount++;
                            if (playCount < 3) {{
                                playAlarm();
                            }} else {{
                                clearInterval(interval);
                            }}
                        }}, 2000);
                        </script>
                        """, unsafe_allow_html=True)
                    
                    if st.button("ğŸ”„ íƒ€ì´ë¨¸ ë¦¬ì…‹", use_container_width=True):
                        st.session_state.timer_started = False
                        st.session_state.start_time = None
                        st.session_state.timer_finished = False
                        st.rerun()
                else:
                    status_msg, status_color = get_timer_status(remaining)
                    progress = 1 - (remaining / st.session_state.duration)
                    
                    st.markdown(f"""
                    <div style="
                        background: linear-gradient(145deg, #f8f9fa, #e9ecef);
                        border-radius: 15px;
                        padding: 20px;
                        text-align: center;
                        box-shadow: 5px 5px 10px #d9d9d9, -5px -5px 10px #ffffff;
                    ">
                        <div class="timer-display">{format_time(remaining)}</div>
                        <div class="timer-status" style="color: {status_color};">{status_msg}</div>
                        <div style="
                            width: 100%;
                            height: 10px;
                            background-color: #e9ecef;
                            border-radius: 5px;
                            overflow: hidden;
                            margin: 10px 0;
                        ">
                            <div style="
                                width: {progress * 100}%;
                                height: 100%;
                                background: linear-gradient(90deg, #0066cc, #00cc99);
                                transition: width 1s linear;
                            "></div>
                        </div>
                    </div>
                    """, unsafe_allow_html=True)
                    
                    # ë¯¸ì…˜/ë¹„ì „/ê°€ì¹˜ í‘œì‹œ
                    st.markdown("---")
                    st.markdown('<h3 style="color: black; font-size: 20px;">ğŸ’« ì‹ ì‚¬ì—…ì‹¤ì˜ ì›ì¹™ </h3>', unsafe_allow_html=True)
                    display_current_value()
                    
                    # 1ì´ˆ ëŒ€ê¸° í›„ ìƒˆë¡œê³ ì¹¨
                    time.sleep(1)
                    st.rerun()
                    
                    if st.button("ğŸ”„ íƒ€ì´ë¨¸ ë¦¬ì…‹", use_container_width=True):
                        st.session_state.timer_started = False
                        st.session_state.start_time = None
                        st.session_state.timer_finished = False
                        st.rerun()

        # í•˜ë‹¨ì— ë‹¤ì‹œ ì •í•˜ê¸° ë²„íŠ¼
        st.markdown("---")
        if st.button("ğŸ”„ ë‹¤ì‹œ ì •í•˜ê¸°", use_container_width=True):
            st.session_state.order_generated = False
            st.session_state.timer_started = False
            st.session_state.start_time = None
            st.session_state.timer_finished = False
            st.rerun()

    # ì•± ì‹œì‘ ì‹œ ì•ŒëŒ ìŒì„± ìƒì„± (í•œ ë²ˆë§Œ)
    if 'alarm_audio' not in st.session_state:
        st.session_state.alarm_audio = generate_alarm_audio()

if __name__ == "__main__":
    main() 
    