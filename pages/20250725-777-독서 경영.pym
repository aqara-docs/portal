import streamlit as st
import mysql.connector
from mysql.connector import Error
import os
from dotenv import load_dotenv
import base64
import hashlib
import re
import time
import openai
from openai import OpenAI
import io
import requests

# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

# OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
client = OpenAI(api_key=os.getenv('OPENAI_API_KEY'))

st.set_page_config(page_title="ğŸµ ì´ì•¼ê¸° ì¬ìƒ ì „ìš©", layout="wide")

st.title("ğŸµ ë…ì„œ ê²½ì˜-ì´ì•¼ê¸° ì¬ìƒ ì „ìš©")

# DB ì—°ê²° í•¨ìˆ˜
def connect_to_db():
    try:
        connection = mysql.connector.connect(
            user=os.getenv('SQL_USER'),
            password=os.getenv('SQL_PASSWORD'),
            host=os.getenv('SQL_HOST'),
            database=os.getenv('SQL_DATABASE_NEWBIZ'),
            charset='utf8mb4',
            collation='utf8mb4_unicode_ci'
        )
        return connection
    except Error as e:
        st.error(f"ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì˜¤ë¥˜: {e}")
        return None

# í…ìŠ¤íŠ¸ í¬ë§·íŒ… í•¨ìˆ˜
def format_bullet_points(text):
    """í…ìŠ¤íŠ¸ë¥¼ bullet point í˜•íƒœë¡œ í¬ë§·íŒ…"""
    lines = text.split('\n')
    formatted = []
    for line in lines:
        # ì œëª©(ì„¹ì…˜) ê°•ì¡°: êµµê²Œ ì²˜ë¦¬
        if line.strip().startswith('#') or line.strip().startswith('**') or (line.strip() and not line.strip().startswith('â€¢') and not line.strip().startswith('-')):
            formatted.append(f"**{line.strip().replace('#','').strip()}**")
        # bullet point
        elif 'â€¢' in line:
            parts = line.split('â€¢')
            new_line = parts[0]
            for part in parts[1:]:
                if part.strip():
                    new_line += '\nâ€¢ ' + part.strip()
            formatted.append(new_line)
        else:
            formatted.append(line)
    return '\n'.join(formatted)

# AI ì»¨í…ì¸  íŒŒì‹± í•¨ìˆ˜
def parse_ai_content(ai_content, content_type):
    """AI ì»¨í…ì¸ ë¥¼ íŒŒì‹±í•˜ì—¬ êµ¬ë¶„ëœ ì„¹ì…˜ìœ¼ë¡œ ë°˜í™˜"""
    if not ai_content:
        return None, None
    
    try:
        if content_type == 'summary':
            # Summary íƒ€ì…: ì›ë³¸ ìš”ì•½ íŒŒì¼ê³¼ AI ìƒì„± í•µì‹¬ ìš”ì•½ìœ¼ë¡œ êµ¬ë¶„
            if "=== ğŸ“ ì›ë³¸ ìš”ì•½ íŒŒì¼ ===" in ai_content and "=== ğŸ¤– AI ìƒì„± í•µì‹¬ ìš”ì•½ ===" in ai_content:
                parts = ai_content.split("=== ğŸ¤– AI ìƒì„± í•µì‹¬ ìš”ì•½ ===")
                original_part = parts[0].replace("=== ğŸ“ ì›ë³¸ ìš”ì•½ íŒŒì¼ ===", "").strip()
                ai_part = parts[1].strip() if len(parts) > 1 else ""
                return original_part, ai_part
                
        elif content_type == 'application':
            # Application íƒ€ì…: ì›ë³¸ ì ìš© íŒŒì¼ê³¼ AI ìš”ì•½ ë° ì´í‰ìœ¼ë¡œ êµ¬ë¶„
            if "=== ğŸ“ ì›ë³¸ ì ìš© íŒŒì¼ ===" in ai_content and "=== ğŸ¤– AI ìš”ì•½ ë° ì´í‰ ===" in ai_content:
                parts = ai_content.split("=== ğŸ¤– AI ìš”ì•½ ë° ì´í‰ ===")
                original_part = parts[0].replace("=== ğŸ“ ì›ë³¸ ì ìš© íŒŒì¼ ===", "").strip()
                ai_part = parts[1].strip() if len(parts) > 1 else ""
                return original_part, ai_part
                
        elif content_type == 'fable':
            # Fable íƒ€ì…: ì „ì²´ê°€ AI ìƒì„± ìš°í™”
            return None, ai_content
            
        # êµ¬ë¶„ìê°€ ì—†ëŠ” ê²½ìš° ì „ì²´ë¥¼ AI ë¶€ë¶„ìœ¼ë¡œ ê°„ì£¼
        return None, ai_content
        
    except Exception as e:
        st.warning(f"ì»¨í…ì¸  íŒŒì‹± ì¤‘ ì˜¤ë¥˜: {e}")
        return None, ai_content

# ë…ì„œí† ë¡  ë ˆì½”ë“œ ì¡°íšŒ í•¨ìˆ˜ (ë””ë²„ê¹… ê°•í™”)
def get_reading_discussion_records(content_type=None, book_title=None):
    connection = connect_to_db()
    if not connection:
        return []
    
    try:
        cursor = connection.cursor(dictionary=True)
        
        # ì¿¼ë¦¬ ë¡œê¹…ì„ ìœ„í•œ ì •ë³´ ìˆ˜ì§‘
        query = """
            SELECT id, book_title, source_file_name, content_type, ai_content, 
                   audio_data, audio_filename, fable_type, model_used, extra_prompt,
                   opening_ment, next_topic, previous_topic, created_at
            FROM reading_discussion_records 
            WHERE 1=1
        """
        params = []
        
        if content_type:
            query += " AND content_type = %s"
            params.append(content_type)
        
        if book_title:
            query += " AND book_title = %s"
            params.append(book_title)
        
        # IDë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
        query += " ORDER BY id DESC"
        
        # ë””ë²„ê·¸ ëª¨ë“œì—ì„œ ì¿¼ë¦¬ ì •ë³´ í‘œì‹œ
        if st.session_state.get("show_query_debug", False):
            st.sidebar.markdown("### ğŸ” ì¿¼ë¦¬ ë””ë²„ê·¸")
            st.sidebar.code(f"Query: {query}")
            st.sidebar.write(f"Params: {params}")
        
        cursor.execute(query, params)
        records = cursor.fetchall()
        
        # ë””ë²„ê·¸ ëª¨ë“œì—ì„œ ì¡°íšŒ ê²°ê³¼ í‘œì‹œ
        if st.session_state.get("show_query_debug", False):
            st.sidebar.write(f"ì¡°íšŒëœ ë ˆì½”ë“œ ìˆ˜: {len(records)}")
            for i, record in enumerate(records):
                st.sidebar.write(f"{i+1}. ID {record['id']}: {record['book_title']}")
                audio_size = len(record['audio_data']) if record['audio_data'] else 0
                st.sidebar.caption(f"   ìŒì„±: {audio_size} bytes, íŒŒì¼ëª…: {record['audio_filename']}")
        
        return records
        
    except Error as e:
        st.error(f"ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜: {e}")
        return []
    
    finally:
        if connection and connection.is_connected():
            cursor.close()
            connection.close()

# ìŒì„± íŒŒì¼ ì§€ë¬¸ ìƒì„± í•¨ìˆ˜
def generate_audio_fingerprint(audio_data):
    """ìŒì„± ë°ì´í„°ì˜ ê³ ìœ  ì§€ë¬¸ ìƒì„±"""
    if not audio_data:
        return "NO_AUDIO"
    
    # ìŒì„± ë°ì´í„°ì˜ í¬ê¸°ì™€ ì‹œì‘/ë ë¶€ë¶„ì˜ í•´ì‹œë¥¼ ì¡°í•©
    size = len(audio_data)
    start_hash = hashlib.md5(audio_data[:min(1000, size)]).hexdigest()[:8]
    end_hash = hashlib.md5(audio_data[-min(1000, size):]).hexdigest()[:8]
    
    return f"{size}_{start_hash}_{end_hash}"

# êµì°¨ ì°¸ì¡° ë¶„ì„ í•¨ìˆ˜
def analyze_audio_text_matching():
    """ì „ì²´ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ìŒì„±-í…ìŠ¤íŠ¸ ë§¤ì¹­ ë¶„ì„"""
    connection = connect_to_db()
    if not connection:
        return []
    
    try:
        cursor = connection.cursor(dictionary=True)
        cursor.execute("""
            SELECT id, book_title, content_type, ai_content, audio_data, created_at
            FROM reading_discussion_records 
            ORDER BY id ASC
        """)
        all_records = cursor.fetchall()
        
        analysis_results = []
        for record in all_records:
            # í…ìŠ¤íŠ¸ ì§€ë¬¸ ìƒì„± (ì²« 100ì)
            text_snippet = record['ai_content'][:100] if record['ai_content'] else "NO_TEXT"
            text_fingerprint = hashlib.md5(text_snippet.encode()).hexdigest()[:8]
            
            # ìŒì„± ì§€ë¬¸ ìƒì„±
            audio_fingerprint = generate_audio_fingerprint(record['audio_data'])
            
            analysis_results.append({
                'id': record['id'],
                'book_title': record['book_title'],
                'content_type': record['content_type'],
                'text_fingerprint': text_fingerprint,
                'audio_fingerprint': audio_fingerprint,
                'text_snippet': text_snippet,
                'created_at': record['created_at']
            })
        
        return analysis_results
        
    except Error as e:
        st.error(f"ë¶„ì„ ì¤‘ ì˜¤ë¥˜: {e}")
        return []
    
    finally:
        if connection and connection.is_connected():
            cursor.close()
            connection.close()

# ì±… ì œëª© ëª©ë¡ ì¡°íšŒ í•¨ìˆ˜
def get_book_titles():
    connection = connect_to_db()
    if not connection:
        return []
    
    try:
        cursor = connection.cursor()
        cursor.execute("SELECT DISTINCT book_title FROM reading_discussion_records ORDER BY book_title")
        titles = [row[0] for row in cursor.fetchall()]
        return titles
        
    except Error as e:
        st.error(f"ì±… ì œëª© ì¡°íšŒ ì˜¤ë¥˜: {e}")
        return []
    
    finally:
        if connection and connection.is_connected():
            cursor.close()
            connection.close()

# ëª…ì–¸ ìƒì„± í•¨ìˆ˜
def generate_quote_from_content(content, book_title, quote_type="ê¸°ë³¸", user_prompt=None, language_option="í•œêµ­ì–´+ì˜ì–´"):
    """ì €ì¥ëœ ì»¨í…ì¸ ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ëª…ì–¸ì„ ìƒì„±"""
    try:
        # ì»¨í…ì¸  ê²€ì¦ ë° ì²˜ë¦¬
        if not content or content.strip() == "":
            st.error("ì €ì¥ëœ ì»¨í…ì¸ ê°€ ì—†ì–´ ëª…ì–¸ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            return None
        
        # ì»¨í…ì¸ ì—ì„œ í•µì‹¬ ë‚´ìš© ì¶”ì¶œ (ìµœëŒ€ 4000ìë¡œ ì¦ê°€)
        content_summary = content[:4000] if content else ""
        
        # ì½˜í…ì¸  ê²€ì¦ ê°•í™”
        if len(content_summary.strip()) < 50:
            st.error("ì €ì¥ëœ ì½˜í…ì¸ ê°€ ë„ˆë¬´ ì§§ì•„ ì˜ë¯¸ ìˆëŠ” ëª…ì–¸ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìµœì†Œ 50ì ì´ìƒì˜ ì½˜í…ì¸ ê°€ í•„ìš”í•©ë‹ˆë‹¤.")
            return None
        
        # ëª…ì–¸ íƒ€ì…ë³„ ìƒì„¸í•œ ìŠ¤íƒ€ì¼ ê°€ì´ë“œ (ìœ ëª… ì¸ì‚¬ ìŠ¤íƒ€ì¼ í¬í•¨)
        quote_type_guides = {
            "ê¸°ë³¸": {
                "description": "ê¹Šì´ ìˆê³  ì˜ê°ì„ ì£¼ëŠ” ëª…ì–¸",
                "tone": "ê· í˜•ì¡íˆê³  í†µì°°ë ¥ ìˆëŠ”",
                "focus": "ì±…ì˜ í•µì‹¬ ë©”ì‹œì§€ë¥¼ ë‹´ì€",
                "style_note": "ì¼ë°˜ì ì´ë©´ì„œë„ ê¹Šì´ ìˆëŠ” í†µì°°ì„ ë‹´ì•„ì£¼ì„¸ìš”"
            },
            "ì§„ì§€í•œ": {
                "description": "ì§„ì¤‘í•˜ê³  ê¹Šì´ ìˆëŠ” ì² í•™ì  ëª…ì–¸",
                "tone": "ë¬´ê²ê³  ì§„ì¤‘í•œ",
                "focus": "ì¸ìƒì˜ ê·¼ë³¸ì ì¸ ì§ˆë¬¸ê³¼ ì² í•™ì  ì‚¬ê³ ë¥¼ ë‹´ì€",
                "style_note": "ë¬´ê²ê³  ì§„ì¤‘í•œ í†¤ìœ¼ë¡œ, ì¸ìƒì˜ ê¹Šì€ ì˜ë¯¸ë¥¼ ë‹¤ë£¨ëŠ” ëª…ì–¸ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”"
            },
            "ê°ë™ì ì¸": {
                "description": "ë§ˆìŒì„ ìš¸ë¦¬ëŠ” ê°ë™ì ì´ê³  ë”°ëœ»í•œ ëª…ì–¸",
                "tone": "ë”°ëœ»í•˜ê³  ê°ë™ì ì¸",
                "focus": "ë§ˆìŒì„ ìš¸ë¦¬ê³  ê°ë™ì„ ì£¼ëŠ”",
                "style_note": "ë”°ëœ»í•˜ê³  ê°ë™ì ì¸ í†¤ìœ¼ë¡œ, ë§ˆìŒì„ ìš¸ë¦¬ëŠ” ëª…ì–¸ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”"
            },
            "ìœ ì¾Œí•œ": {
                "description": "ì¬ì¹˜ ìˆê³  ìœ ë¨¸ëŸ¬ìŠ¤í•œ ëª…ì–¸",
                "tone": "ì¬ì¹˜ ìˆê³  ìœ ë¨¸ëŸ¬ìŠ¤í•œ",
                "focus": "ì¬ë¯¸ìˆìœ¼ë©´ì„œë„ ì˜ë¯¸ ìˆëŠ”",
                "style_note": "ì¬ì¹˜ ìˆê³  ìœ ë¨¸ëŸ¬ìŠ¤í•œ í†¤ìœ¼ë¡œ, ì›ƒìŒì„ ìì•„ë‚´ë©´ì„œë„ ì˜ë¯¸ ìˆëŠ” ëª…ì–¸ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”"
            },
            "ë„ì „ì ì¸": {
                "description": "ìš©ê¸°ì™€ ë„ì „ì„ ë¶ˆëŸ¬ì¼ìœ¼í‚¤ëŠ” ëª…ì–¸",
                "tone": "ê°•ë ¬í•˜ê³  ë„ì „ì ì¸",
                "focus": "ìš©ê¸°ì™€ ë„ì „ ì •ì‹ ì„ ë¶ˆëŸ¬ì¼ìœ¼í‚¤ëŠ”",
                "style_note": "ê°•ë ¬í•˜ê³  ë„ì „ì ì¸ í†¤ìœ¼ë¡œ, í–‰ë™ì„ ì´‰êµ¬í•˜ëŠ” ëª…ì–¸ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”"
            },
            "í‰í™”ë¡œìš´": {
                "description": "ë§ˆìŒì˜ í‰í™”ì™€ ì•ˆì •ì„ ì£¼ëŠ” ëª…ì–¸",
                "tone": "ì°¨ë¶„í•˜ê³  í‰í™”ë¡œìš´",
                "focus": "ë§ˆìŒì˜ í‰í™”ì™€ ì•ˆì •ì„ ì£¼ëŠ”",
                "style_note": "ì°¨ë¶„í•˜ê³  í‰í™”ë¡œìš´ í†¤ìœ¼ë¡œ, ë§ˆìŒì„ ì§„ì •ì‹œí‚¤ëŠ” ëª…ì–¸ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”"
            },
            "ì§€í˜œë¡œìš´": {
                "description": "ì‚¶ì˜ ì§€í˜œì™€ í†µì°°ì„ ë‹´ì€ ëª…ì–¸",
                "tone": "í˜„ëª…í•˜ê³  í†µì°°ë ¥ ìˆëŠ”",
                "focus": "ì‚¶ì˜ ì§€í˜œì™€ ê¹Šì€ í†µì°°ì„ ë‹´ì€",
                "style_note": "í˜„ëª…í•˜ê³  í†µì°°ë ¥ ìˆëŠ” í†¤ìœ¼ë¡œ, ì‚¶ì˜ ì§€í˜œë¥¼ ë‹´ì€ ëª…ì–¸ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”"
            },
            "í¬ë§ì ì¸": {
                "description": "í¬ë§ê³¼ ê¸ì •ì˜ ë©”ì‹œì§€ë¥¼ ë‹´ì€ ëª…ì–¸",
                "tone": "í¬ë§ì ì´ê³  ê¸ì •ì ì¸",
                "focus": "í¬ë§ê³¼ ê¸ì •ì˜ ë©”ì‹œì§€ë¥¼ ë‹´ì€",
                "style_note": "í¬ë§ì ì´ê³  ê¸ì •ì ì¸ í†¤ìœ¼ë¡œ, ë¯¸ë˜ì— ëŒ€í•œ í¬ë§ì„ ì£¼ëŠ” ëª…ì–¸ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”"
            },
            "ì‹¤ìš©ì ì¸": {
                "description": "ì‹¤ìƒí™œì— ë°”ë¡œ ì ìš©í•  ìˆ˜ ìˆëŠ” ì‹¤ìš©ì  ëª…ì–¸",
                "tone": "ì‹¤ìš©ì ì´ê³  êµ¬ì²´ì ì¸",
                "focus": "ì‹¤ìƒí™œì— ë°”ë¡œ ì ìš©í•  ìˆ˜ ìˆëŠ”",
                "style_note": "ì‹¤ìš©ì ì´ê³  êµ¬ì²´ì ì¸ í†¤ìœ¼ë¡œ, ë°”ë¡œ ì‹¤ì²œí•  ìˆ˜ ìˆëŠ” ëª…ì–¸ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”"
            },
            "ì˜ê°ì ì¸": {
                "description": "ì°½ì˜ì„±ê³¼ í˜ì‹ ì„ ìê·¹í•˜ëŠ” ì˜ê°ì ì¸ ëª…ì–¸",
                "tone": "ì˜ê°ì ì´ê³  ì°½ì˜ì ì¸",
                "focus": "ì°½ì˜ì„±ê³¼ í˜ì‹ ì„ ìê·¹í•˜ëŠ”",
                "style_note": "ì˜ê°ì ì´ê³  ì°½ì˜ì ì¸ í†¤ìœ¼ë¡œ, ìƒˆë¡œìš´ ì•„ì´ë””ì–´ë¥¼ ìê·¹í•˜ëŠ” ëª…ì–¸ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”"
            },
            # ìœ ëª… ì¸ì‚¬ ìŠ¤íƒ€ì¼ ì¶”ê°€
            "ì˜ˆìˆ˜ë‹˜": {
                "description": "ì‚¬ë‘ê³¼ ìš©ì„œ, ê²¸ì†ê³¼ ì„¬ê¹€ì˜ ê°€ì¹˜ë¥¼ ë‹´ì€ ëª…ì–¸",
                "tone": "ë”°ëœ»í•˜ê³  ìë¹„ë¡œìš´",
                "focus": "ì‚¬ë‘ê³¼ ìš©ì„œ, ê²¸ì†ê³¼ ì„¬ê¹€ì˜ ê°€ì¹˜ë¥¼ ë‹´ì€",
                "style_note": "ì˜ˆìˆ˜ë‹˜ì˜ ë”°ëœ»í•˜ê³  ìë¹„ë¡œìš´ í†¤ìœ¼ë¡œ, ì‚¬ë‘ê³¼ ìš©ì„œì˜ ê°€ì¹˜ë¥¼ ë‹´ì€ ëª…ì–¸ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”"
            },
            "ë¶€ì²˜ë‹˜": {
                "description": "ìë¹„ì™€ ê¹¨ë‹¬ìŒ, ì¤‘ë„ì™€ ë¬´ìƒì˜ ê°€ë¥´ì¹¨ì„ ë‹´ì€ ëª…ì–¸",
                "tone": "ìë¹„ë¡­ê³  ê¹¨ë‹¬ì€",
                "focus": "ìë¹„ì™€ ê¹¨ë‹¬ìŒ, ì¤‘ë„ì™€ ë¬´ìƒì˜ ê°€ë¥´ì¹¨ì„ ë‹´ì€",
                "style_note": "ë¶€ì²˜ë‹˜ì˜ ìë¹„ë¡­ê³  ê¹¨ë‹¬ì€ í†¤ìœ¼ë¡œ, ì¤‘ë„ì™€ ë¬´ìƒì˜ ì§€í˜œë¥¼ ë‹´ì€ ëª…ì–¸ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”"
            },
            "ê³µìë‹˜": {
                "description": "ì¸(ä»)ê³¼ ì˜ˆ(ç¦®), ìˆ˜ì‹ ì œê°€ì¹˜êµ­í‰ì²œí•˜ì˜ ë„ë•ì  ê°€ë¥´ì¹¨ì„ ë‹´ì€ ëª…ì–¸",
                "tone": "ì˜¨í™”í•˜ê³  ë„ë•ì ì¸",
                "focus": "ì¸(ä»)ê³¼ ì˜ˆ(ç¦®), ìˆ˜ì‹ ì œê°€ì¹˜êµ­í‰ì²œí•˜ì˜ ë„ë•ì  ê°€ë¥´ì¹¨ì„ ë‹´ì€",
                "style_note": "ê³µìë‹˜ì˜ ì˜¨í™”í•˜ê³  ë„ë•ì ì¸ í†¤ìœ¼ë¡œ, ì¸ê³¼ ì˜ˆì˜ ê°€ì¹˜ë¥¼ ë‹´ì€ ëª…ì–¸ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”"
            },
            "ì†Œí¬ë¼í…ŒìŠ¤ë‹˜": {
                "description": "ë¬¸ë‹µë²•ê³¼ ë•ì˜ ì¶”êµ¬, 'ë‚˜ëŠ” ì•„ë¬´ê²ƒë„ ëª¨ë¥¸ë‹¤'ëŠ” ê²¸ì†í•¨ì„ ë‹´ì€ ëª…ì–¸",
                "tone": "ì§€í˜œë¡­ê³  ê²¸ì†í•œ",
                "focus": "ë¬¸ë‹µë²•ê³¼ ë•ì˜ ì¶”êµ¬, ê²¸ì†í•¨ì„ ë‹´ì€",
                "style_note": "ì†Œí¬ë¼í…ŒìŠ¤ë‹˜ì˜ ì§€í˜œë¡­ê³  ê²¸ì†í•œ í†¤ìœ¼ë¡œ, ì§„ë¦¬ íƒêµ¬ì˜ ì •ì‹ ì„ ë‹´ì€ ëª…ì–¸ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”"
            },
            "ì¥ìë‹˜": {
                "description": "ë¬´ìœ„ìì—°(ç„¡çˆ²è‡ªç„¶), ìƒëŒ€ì„±, ììœ ë¡œìš´ ì •ì‹ ì„ ë‹´ì€ ëª…ì–¸",
                "tone": "ììœ ë¡­ê³  ì—­ì„¤ì ì¸",
                "focus": "ë¬´ìœ„ìì—°ê³¼ ìƒëŒ€ì„±, ììœ ë¡œìš´ ì •ì‹ ì„ ë‹´ì€",
                "style_note": "ì¥ìë‹˜ì˜ ììœ ë¡­ê³  ì—­ì„¤ì ì¸ í†¤ìœ¼ë¡œ, ê³ ì •ê´€ë…ì„ ë’¤í”ë“œëŠ” ì§€í˜œë¥¼ ë‹´ì€ ëª…ì–¸ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”"
            },
            "ë…¸ìë‹˜": {
                "description": "ë„(é“), ë¬´ìœ„(ç„¡çˆ²), ìŒì–‘(é™°é™½)ì˜ ì¡°í™”ì™€ ê²¸ì†í•¨ì„ ë‹´ì€ ëª…ì–¸",
                "tone": "ê¹Šì´ ìˆê³  ì‹ ë¹„ë¡œìš´",
                "focus": "ë„(é“), ë¬´ìœ„(ç„¡çˆ²), ìŒì–‘ì˜ ì¡°í™”ì™€ ê²¸ì†í•¨ì„ ë‹´ì€",
                "style_note": "ë…¸ìë‹˜ì˜ ê¹Šì´ ìˆê³  ì‹ ë¹„ë¡œìš´ í†¤ìœ¼ë¡œ, ìì—°ì˜ ìˆœë¦¬ë¥¼ ë‹´ì€ ëª…ì–¸ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”"
            },
            "ì œê°ˆëŸ‰ë‹˜": {
                "description": "ì§€ëµê³¼ ì¶©ì˜, ì¸ì¬ê²½ì˜ê³¼ ì „ëµì  ì‚¬ê³ ë¥¼ ë‹´ì€ ëª…ì–¸",
                "tone": "ì§€ëµì ì´ê³  ì¶©ì„±ìŠ¤ëŸ¬ìš´",
                "focus": "ì§€ëµê³¼ ì¶©ì˜, ì¸ì¬ê²½ì˜ê³¼ ì „ëµì  ì‚¬ê³ ë¥¼ ë‹´ì€",
                "style_note": "ì œê°ˆëŸ‰ë‹˜ì˜ ì§€ëµì ì´ê³  ì¶©ì„±ìŠ¤ëŸ¬ìš´ í†¤ìœ¼ë¡œ, ì „ëµê³¼ ì¶©ì˜ì˜ ê°€ì¹˜ë¥¼ ë‹´ì€ ëª…ì–¸ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”"
            },
            "í”¼í„° ë“œëŸ¬ì»¤ë‹˜": {
                "description": "ê²½ì˜ì˜ ë³¸ì§ˆ, ëª©í‘œ ì„¤ì •, ìê¸°ê´€ë¦¬, ì‚¬íšŒì  ì±…ì„ì„ ë‹´ì€ ëª…ì–¸",
                "tone": "ì‹¤ìš©ì ì´ê³  í†µì°°ë ¥ ìˆëŠ”",
                "focus": "ê²½ì˜ì˜ ë³¸ì§ˆ, ëª©í‘œ ì„¤ì •, ìê¸°ê´€ë¦¬, ì‚¬íšŒì  ì±…ì„ì„ ë‹´ì€",
                "style_note": "ë“œëŸ¬ì»¤ë‹˜ì˜ ì‹¤ìš©ì ì´ê³  í†µì°°ë ¥ ìˆëŠ” í†¤ìœ¼ë¡œ, ê²½ì˜ì˜ ë³¸ì§ˆì„ ë‹´ì€ ëª…ì–¸ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”"
            },
            "ë§ˆì´í´ í¬í„°ë‹˜": {
                "description": "ê²½ìŸ ì „ëµ, ì‚°ì—…êµ¬ì¡°, ì°¨ë³„í™”ì™€ ì›ê°€ìš°ìœ„ë¥¼ ë‹´ì€ ëª…ì–¸",
                "tone": "ì „ëµì ì´ê³  ë¶„ì„ì ì¸",
                "focus": "ê²½ìŸ ì „ëµ, ì‚°ì—…êµ¬ì¡°, ì°¨ë³„í™”ì™€ ì›ê°€ìš°ìœ„ë¥¼ ë‹´ì€",
                "style_note": "í¬í„°ë‹˜ì˜ ì „ëµì ì´ê³  ë¶„ì„ì ì¸ í†¤ìœ¼ë¡œ, ê²½ìŸ ìš°ìœ„ì˜ ì›ë¦¬ë¥¼ ë‹´ì€ ëª…ì–¸ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”"
            },
            "ìŠ¤í‹°ë¸Œ ì¡ìŠ¤ë‹˜": {
                "description": "í˜ì‹ ê³¼ ì°½ì˜ì„±, ì™„ë²½ì£¼ì˜ì™€ ë¹„ì „ì„ ë‹´ì€ ëª…ì–¸",
                "tone": "í˜ì‹ ì ì´ê³  ì˜ê°ì ì¸",
                "focus": "í˜ì‹ ê³¼ ì°½ì˜ì„±, ì™„ë²½ì£¼ì˜ì™€ ë¹„ì „ì„ ë‹´ì€",
                "style_note": "ì¡ìŠ¤ë‹˜ì˜ í˜ì‹ ì ì´ê³  ì˜ê°ì ì¸ í†¤ìœ¼ë¡œ, í˜ì‹ ê³¼ ì™„ë²½ì£¼ì˜ì˜ ê°€ì¹˜ë¥¼ ë‹´ì€ ëª…ì–¸ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”"
            },
            # AI 4ëŒ€ ì„í•™ ì¶”ê°€
            "ì œí”„ë¦¬ íŒíŠ¼ë‹˜": {
                "description": "ë”¥ëŸ¬ë‹ì˜ ì°½ì‹œì, ì—­ì „íŒŒ ì•Œê³ ë¦¬ì¦˜, ì‹ ê²½ë§ ê¸°ë°˜ AIë¥¼ ë‹´ì€ ëª…ì–¸",
                "tone": "í˜ì‹ ì ì´ê³  ì´ë¡ ì ì¸",
                "focus": "ë”¥ëŸ¬ë‹ì˜ ì°½ì‹œì, ì—­ì „íŒŒ ì•Œê³ ë¦¬ì¦˜, ì‹ ê²½ë§ ê¸°ë°˜ AIë¥¼ ë‹´ì€",
                "style_note": "íŒíŠ¼ë‹˜ì˜ í˜ì‹ ì ì´ê³  ì´ë¡ ì ì¸ í†¤ìœ¼ë¡œ, ë”¥ëŸ¬ë‹ì˜ í˜ì‹ ì„ ë‹´ì€ ëª…ì–¸ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”"
            },
            "ì–€ ë¥´ì¿¤ë‹˜": {
                "description": "í•©ì„±ê³± ì‹ ê²½ë§(CNN), ì»´í“¨í„° ë¹„ì „, AI ê¸°ìˆ  í•œê³„ í‰ê°€ë¥¼ ë‹´ì€ ëª…ì–¸",
                "tone": "ì‹¤ìš©ì ì´ê³  ì†”ì§í•œ",
                "focus": "í•©ì„±ê³± ì‹ ê²½ë§(CNN), ì»´í“¨í„° ë¹„ì „, AI ê¸°ìˆ  í•œê³„ í‰ê°€ë¥¼ ë‹´ì€",
                "style_note": "ë¥´ì¿¤ë‹˜ì˜ ì‹¤ìš©ì ì´ê³  ì†”ì§í•œ í†¤ìœ¼ë¡œ, AI ê¸°ìˆ ì˜ í˜„ì‹¤ì  í•œê³„ë¥¼ ë‹´ì€ ëª…ì–¸ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”"
            },
            "ìš”ìŠˆì•„ ë²¤ì§€ì˜¤ë‹˜": {
                "description": "ìˆœí™˜ ì‹ ê²½ë§(RNN), AI ì•ˆì „ì„±ê³¼ ìœ¤ë¦¬ë¥¼ ë‹´ì€ ëª…ì–¸",
                "tone": "ì‹ ì¤‘í•˜ê³  ìœ¤ë¦¬ì ì¸",
                "focus": "ìˆœí™˜ ì‹ ê²½ë§(RNN), AI ì•ˆì „ì„±ê³¼ ìœ¤ë¦¬ë¥¼ ë‹´ì€",
                "style_note": "ë²¤ì§€ì˜¤ë‹˜ì˜ ì‹ ì¤‘í•˜ê³  ìœ¤ë¦¬ì ì¸ í†¤ìœ¼ë¡œ, AIì˜ ì•ˆì „ì„±ê³¼ ìœ¤ë¦¬ë¥¼ ë‹´ì€ ëª…ì–¸ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”"
            },
            "ì•¤ë“œë¥˜ ì‘ë‹˜": {
                "description": "ë¨¸ì‹ ëŸ¬ë‹ ëŒ€ì¤‘í™”, AI êµìœ¡ í˜ì‹ , ì‹¤ìš©ì  AI ì ìš©ì„ ë‹´ì€ ëª…ì–¸",
                "tone": "êµìœ¡ì ì´ê³  ì‹¤ìš©ì ì¸",
                "focus": "ë¨¸ì‹ ëŸ¬ë‹ ëŒ€ì¤‘í™”, AI êµìœ¡ í˜ì‹ , ì‹¤ìš©ì  AI ì ìš©ì„ ë‹´ì€",
                "style_note": "ì‘ë‹˜ì˜ êµìœ¡ì ì´ê³  ì‹¤ìš©ì ì¸ í†¤ìœ¼ë¡œ, AIì˜ ëŒ€ì¤‘í™”ì™€ êµìœ¡ì„ ë‹´ì€ ëª…ì–¸ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”"
            }
        }
        
        # ì„ íƒëœ íƒ€ì…ì˜ ìŠ¤íƒ€ì¼ ê°€ì´ë“œ
        style_guide = quote_type_guides.get(quote_type, quote_type_guides["ê¸°ë³¸"])
        
        # ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ êµ¬ì„± - ì €ì¥ëœ ì»¨í…ì¸  í™œìš©ì„ ë” ê°•ì¡°
        base_prompt = f"""
ë‹¤ìŒì€ '{book_title}' ì±…ì—ì„œ ì¶”ì¶œëœ ì‹¤ì œ ë…ì„œ ë‚´ìš©ì…ë‹ˆë‹¤. ì´ ë‚´ìš©ì„ ë°˜ë“œì‹œ ê¸°ë°˜ìœ¼ë¡œ í•˜ì—¬ {style_guide['description']}ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”.

**ğŸ“– ì±… ì œëª©:** {book_title}

**ğŸ“ ì €ì¥ëœ ë…ì„œ ë‚´ìš© (ë°˜ë“œì‹œ ì´ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ëª…ì–¸ì„ ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤):**
{content_summary}

**ğŸ¯ í•µì‹¬ ìš”ì²­ì‚¬í•­:** 
- ìœ„ì˜ êµ¬ì²´ì ì¸ ë…ì„œ ë‚´ìš©ì—ì„œ ë‚˜ì˜¨ í•µì‹¬ ë©”ì‹œì§€ì™€ ì¸ì‚¬ì´íŠ¸ë¥¼ ë°”íƒ•ìœ¼ë¡œ {style_guide['description']}ì„ ì‘ì„±í•´ì£¼ì„¸ìš”
- ì¼ë°˜ì ì¸ ëª…ì–¸ì´ ì•„ë‹Œ, ì´ ì±…ì˜ ë‚´ìš©ê³¼ ì§ì ‘ì ìœ¼ë¡œ ì—°ê´€ëœ ëª…ì–¸ì´ì–´ì•¼ í•©ë‹ˆë‹¤
- ë°˜ë“œì‹œ ìœ„ì— ì œê³µëœ ë…ì„œ ë‚´ìš©ì˜ êµ¬ì²´ì ì¸ ê°œë…, ì•„ì´ë””ì–´, ë©”ì‹œì§€ë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤

**ğŸ¨ ëª…ì–¸ ìŠ¤íƒ€ì¼ ìš”êµ¬ì‚¬í•­:**
- **í†¤:** {style_guide['tone']} í†¤ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”
- **ì´ˆì :** {style_guide['focus']} ëª…ì–¸ì´ì–´ì•¼ í•©ë‹ˆë‹¤
- **ìŠ¤íƒ€ì¼:** {style_guide['style_note']}

**âš ï¸ ì¤‘ìš”:** ìœ ëª… ì¸ì‚¬ ìŠ¤íƒ€ì¼ì„ ì„ íƒí–ˆë”ë¼ë„, ë°˜ë“œì‹œ ìœ„ì— ì œê³µëœ ë…ì„œ ë‚´ìš©ì˜ êµ¬ì²´ì ì¸ ë©”ì‹œì§€ì™€ ì¸ì‚¬ì´íŠ¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ëª…ì–¸ì„ ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤. í•´ë‹¹ ì¸ì‚¬ì˜ ì¼ë°˜ì ì¸ ëª…ì–¸ì´ ì•„ë‹Œ, ì´ ì±…ì˜ ë‚´ìš©ì„ ê·¸ ì¸ì‚¬ì˜ ê´€ì ì—ì„œ í•´ì„í•œ ëª…ì–¸ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
"""
        
        # ì‚¬ìš©ì ì¶”ê°€ í”„ë¡¬í”„íŠ¸ê°€ ìˆë‹¤ë©´ í¬í•¨
        if user_prompt and user_prompt.strip():
            base_prompt += f"""

**ğŸ’¡ ì‚¬ìš©ì ì¶”ê°€ ìš”ì²­:**
{user_prompt.strip()}
(ë‹¨, ìœ„ì˜ ë…ì„œ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ í•˜ë˜ ì´ ì¶”ê°€ ìš”ì²­ì„ ë°˜ì˜í•´ì£¼ì„¸ìš”)
"""
        
        # ì–¸ì–´ ì˜µì…˜ì— ë”°ë¥¸ ì‘ë‹µ í˜•ì‹ ê²°ì •
        language_formats = {
            "í•œêµ­ì–´": "í•œê¸€ ëª…ì–¸: \"ëª…ì–¸ ë‚´ìš©\"",
            "í•œêµ­ì–´+ì˜ì–´": "í•œê¸€ ëª…ì–¸: \"ëª…ì–¸ ë‚´ìš©\"\nì˜ë¬¸ ëª…ì–¸: \"Quote content\"",
            "í•œêµ­ì–´+ì˜ì–´+ì¤‘êµ­ì–´": "í•œê¸€ ëª…ì–¸: \"ëª…ì–¸ ë‚´ìš©\"\nì˜ë¬¸ ëª…ì–¸: \"Quote content\"\nì¤‘êµ­ì–´ ëª…ì–¸: \"ä¸­æ–‡åè¨€\"\ní•œì–´ë³‘ìŒ: \"zhÅng wÃ©n mÃ­ng yÃ¡n\"",
            "í•œêµ­ì–´+ì˜ì–´+ì¤‘êµ­ì–´+ì¼ë³¸ì–´": "í•œê¸€ ëª…ì–¸: \"ëª…ì–¸ ë‚´ìš©\"\nì˜ë¬¸ ëª…ì–¸: \"Quote content\"\nì¤‘êµ­ì–´ ëª…ì–¸: \"ä¸­æ–‡åè¨€\"\ní•œì–´ë³‘ìŒ: \"zhÅng wÃ©n mÃ­ng yÃ¡n\"\nì¼ë³¸ì–´ ëª…ì–¸: \"æ—¥æœ¬èªã®åè¨€\"\nì¹´íƒ€ì¹´ë‚˜: \"ãƒ‹ãƒ›ãƒ³ã‚´ãƒãƒ¡ã‚¤ã‚²ãƒ³\""
        }
        
        response_format = language_formats.get(language_option, language_formats["í•œêµ­ì–´+ì˜ì–´"])
        
        # ì–¸ì–´ë³„ ì„¤ëª… ì¶”ê°€
        language_descriptions = {
            "í•œêµ­ì–´": "í•œêµ­ì–´ë¡œë§Œ ëª…ì–¸ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.",
            "í•œêµ­ì–´+ì˜ì–´": "í•œêµ­ì–´ì™€ ì˜ì–´ë¡œ ëª…ì–¸ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.",
            "í•œêµ­ì–´+ì˜ì–´+ì¤‘êµ­ì–´": "í•œêµ­ì–´, ì˜ì–´, ì¤‘êµ­ì–´ë¡œ ëª…ì–¸ì„ ì‘ì„±í•´ì£¼ì„¸ìš”. ì¤‘êµ­ì–´ ëª…ì–¸ ì•„ë˜ì—ëŠ” í•œì–´ë³‘ìŒì„ í•¨ê»˜ ì œê³µí•´ì£¼ì„¸ìš”.",
            "í•œêµ­ì–´+ì˜ì–´+ì¤‘êµ­ì–´+ì¼ë³¸ì–´": "í•œêµ­ì–´, ì˜ì–´, ì¤‘êµ­ì–´, ì¼ë³¸ì–´ë¡œ ëª…ì–¸ì„ ì‘ì„±í•´ì£¼ì„¸ìš”. ì¤‘êµ­ì–´ ëª…ì–¸ ì•„ë˜ì—ëŠ” í•œì–´ë³‘ìŒì„, ì¼ë³¸ì–´ ëª…ì–¸ ì•„ë˜ì—ëŠ” ì¹´íƒ€ì¹´ë‚˜ ë…ìŒì„ í•¨ê»˜ ì œê³µí•´ì£¼ì„¸ìš”."
        }
        
        language_description = language_descriptions.get(language_option, language_descriptions["í•œêµ­ì–´+ì˜ì–´"])
        
        final_prompt = base_prompt + f"""

**ğŸ“‹ ëª…ì–¸ ì‘ì„± ìš”êµ¬ì‚¬í•­:**
1. **ë°˜ë“œì‹œ ìœ„ì— ì œê³µëœ ë…ì„œ ë‚´ìš©ì˜ í•µì‹¬ ë©”ì‹œì§€ë¥¼ ê¸°ë°˜ìœ¼ë¡œ** ëª…ì–¸ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”
2. {language_description}
3. ëª…ì–¸ì€ ê°„ê²°í•˜ë©´ì„œë„ ê¹Šì´ê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤
4. ì‹¤ì œ ì‚¶ì— ì ìš©í•  ìˆ˜ ìˆëŠ” ì‹¤ìš©ì ì¸ ì§€í˜œë¥¼ ë‹´ì•„ì£¼ì„¸ìš”
5. **ë…ì„œ ë‚´ìš©ì—ì„œ ë‚˜ì˜¨ êµ¬ì²´ì ì¸ ê°œë…ì´ë‚˜ ì•„ì´ë””ì–´ë¥¼ ë°˜ì˜í•´ì£¼ì„¸ìš”**
6. ì‚¬ìš©ìì˜ ì¶”ê°€ ìš”ì²­ì´ ìˆë‹¤ë©´ ê·¸ê²ƒì„ ë°˜ì˜í•˜ë˜, ë°˜ë“œì‹œ ë…ì„œ ë‚´ìš© ê¸°ë°˜ì„ ìœ ì§€í•´ì£¼ì„¸ìš”
7. **ìŠ¤íƒ€ì¼ ê°•ì¡°:** {style_guide['style_note']}
8. **í†¤ ìœ ì§€:** ë°˜ë“œì‹œ {style_guide['tone']} í†¤ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”
9. **ì´ˆì  ë§ì¶¤:** {style_guide['focus']} ëª…ì–¸ì´ ë˜ë„ë¡ í•´ì£¼ì„¸ìš”
10. **ì½˜í…ì¸  ê¸°ë°˜ ê°•í™”:** ìœ ëª… ì¸ì‚¬ ìŠ¤íƒ€ì¼ì´ì–´ë„ ë°˜ë“œì‹œ ë…ì„œ ë‚´ìš©ì˜ êµ¬ì²´ì ì¸ ë©”ì‹œì§€ë¥¼ ê·¸ ì¸ì‚¬ì˜ ê´€ì ì—ì„œ í•´ì„í•œ ëª…ì–¸ì´ì–´ì•¼ í•©ë‹ˆë‹¤
11. **ê²€ì¦:** ìƒì„±ëœ ëª…ì–¸ì´ ìœ„ì˜ ë…ì„œ ë‚´ìš©ê³¼ ì§ì ‘ì ìœ¼ë¡œ ì—°ê´€ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”

**ğŸ“„ ì‘ë‹µ í˜•ì‹:**
{response_format}
"""

        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": f"ë‹¹ì‹ ì€ ë…ì„œ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ ê·¸ ì±…ì˜ í•µì‹¬ ë©”ì‹œì§€ë¥¼ ë°”íƒ•ìœ¼ë¡œ {style_guide['description']}ì„ ë§Œë“œëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë°˜ë“œì‹œ ì œê³µëœ ë…ì„œ ë‚´ìš©ì˜ êµ¬ì²´ì ì¸ ì¸ì‚¬ì´íŠ¸ì™€ ê°œë…ì„ ê¸°ë°˜ìœ¼ë¡œ ëª…ì–¸ì„ ë§Œë“¤ì–´ì•¼ í•˜ë©°, ì¼ë°˜ì ì´ê±°ë‚˜ ì¶”ìƒì ì¸ ëª…ì–¸ì´ ì•„ë‹Œ í•´ë‹¹ ì±…ì˜ ë‚´ìš©ê³¼ ì§ì ‘ ì—°ê´€ëœ ëª…ì–¸ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”. íŠ¹íˆ {style_guide['tone']} í†¤ê³¼ {style_guide['focus']} ìŠ¤íƒ€ì¼ì„ ê°•ë ¥í•˜ê²Œ ë°˜ì˜í•´ì•¼ í•©ë‹ˆë‹¤. ì ˆëŒ€ë¡œ ë…ì„œ ë‚´ìš©ê³¼ ë¬´ê´€í•œ ì¼ë°˜ì ì¸ ëª…ì–¸ì„ ìƒì„±í•˜ì§€ ë§ˆì„¸ìš”."},
                {"role": "user", "content": final_prompt}
            ],
            max_tokens=800,  # í† í° ìˆ˜ ì¦ê°€
            temperature=0.7
        )
        
        quote_text = response.choices[0].message.content
        return quote_text
        
    except Exception as e:
        st.error(f"ëª…ì–¸ ìƒì„± ì¤‘ ì˜¤ë¥˜: {e}")
        return None

# ëª…ì–¸ ìŒì„± ìƒì„± í•¨ìˆ˜
def generate_quote_audio(quote_text, language_option="í•œêµ­ì–´+ì˜ì–´"):
    """ëª…ì–¸ì„ ìŒì„±ìœ¼ë¡œ ë³€í™˜"""
    try:
        # ì–¸ì–´ë³„ ëª…ì–¸ì„ ë¶„ë¦¬
        lines = quote_text.split('\n')
        quotes = {}
        
        for line in lines:
            if line.startswith('í•œê¸€ ëª…ì–¸:'):
                quotes['korean'] = line.replace('í•œê¸€ ëª…ì–¸:', '').strip().strip('"')
            elif line.startswith('ì˜ë¬¸ ëª…ì–¸:'):
                quotes['english'] = line.replace('ì˜ë¬¸ ëª…ì–¸:', '').strip().strip('"')
            elif line.startswith('ì¤‘êµ­ì–´ ëª…ì–¸:'):
                quotes['chinese'] = line.replace('ì¤‘êµ­ì–´ ëª…ì–¸:', '').strip().strip('"')
            elif line.startswith('í•œì–´ë³‘ìŒ:'):
                quotes['pinyin'] = line.replace('í•œì–´ë³‘ìŒ:', '').strip().strip('"')
            elif line.startswith('ì¼ë³¸ì–´ ëª…ì–¸:'):
                quotes['japanese'] = line.replace('ì¼ë³¸ì–´ ëª…ì–¸:', '').strip().strip('"')
            elif line.startswith('ì¹´íƒ€ì¹´ë‚˜:'):
                quotes['katakana'] = line.replace('ì¹´íƒ€ì¹´ë‚˜:', '').strip().strip('"')
        
        # ì–¸ì–´ ì˜µì…˜ì— ë”°ë¥¸ ìŒì„± í…ìŠ¤íŠ¸ êµ¬ì„±
        audio_texts = {
            "í•œêµ­ì–´": f"ì˜¤ëŠ˜ì˜ ëª…ì–¸ì…ë‹ˆë‹¤. {quotes.get('korean', '')}",
            "í•œêµ­ì–´+ì˜ì–´": f"ì˜¤ëŠ˜ì˜ ëª…ì–¸ì…ë‹ˆë‹¤. {quotes.get('korean', '')}. In English, {quotes.get('english', '')}",
            "í•œêµ­ì–´+ì˜ì–´+ì¤‘êµ­ì–´": f"ì˜¤ëŠ˜ì˜ ëª…ì–¸ì…ë‹ˆë‹¤. {quotes.get('korean', '')}. In English, {quotes.get('english', '')}. ä¸­æ–‡, {quotes.get('chinese', '')}",
            "í•œêµ­ì–´+ì˜ì–´+ì¤‘êµ­ì–´+ì¼ë³¸ì–´": f"ì˜¤ëŠ˜ì˜ ëª…ì–¸ì…ë‹ˆë‹¤. {quotes.get('korean', '')}. In English, {quotes.get('english', '')}. ä¸­æ–‡, {quotes.get('chinese', '')}. æ—¥æœ¬èª, {quotes.get('japanese', '')}"
        }
        
        full_text = audio_texts.get(language_option, audio_texts["í•œêµ­ì–´+ì˜ì–´"])
        
        # OpenAI TTS APIë¥¼ ì‚¬ìš©í•˜ì—¬ ìŒì„± ìƒì„±
        response = client.audio.speech.create(
            model="tts-1",
            voice="nova",  # ì—¬ì„± ëª©ì†Œë¦¬
            input=full_text,
            response_format="mp3"
        )
        
        # ìŒì„± ë°ì´í„°ë¥¼ ë°”ì´íŠ¸ë¡œ ë³€í™˜
        audio_data = response.content
        return audio_data, quotes
        
    except Exception as e:
        st.error(f"ìŒì„± ìƒì„± ì¤‘ ì˜¤ë¥˜: {e}")
        return None, None, None

# ë©”ì¸ ì•±
def main():
    #st.markdown("### ğŸµ ì´ì•¼ê¸° ì¬ìƒ")
    st.write("ì €ì¥ëœ AI ìš”ì•½ê³¼ ìš°í™” ì½˜í…ì¸ ë¥¼ ì¡°íšŒí•˜ê³  ìŒì„±ì„ ì¬ìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
    
    # ë°ì´í„° ê°œìˆ˜ ì„ íƒ
    col1, col2 = st.columns([3, 1])
    with col1:
        record_count = st.selectbox(
            "í‘œì‹œí•  ìµœê·¼ ë ˆì½”ë“œ ìˆ˜",
            [3, 5, 10, 15, 20, 30, 50],
            index=1,  # ë””í´íŠ¸ 10ê°œ
            key="record_count"
        )
    with col2:
        if st.button("ğŸ”„ ìƒˆë¡œê³ ì¹¨"):
            st.rerun()
    
    # ìµœê·¼ Nê°œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    all_records = get_reading_discussion_records()
    filtered_records = all_records[:record_count]
    
    if filtered_records:
        # í—¤ë”
        st.write(f"### ğŸ“‹ ì´ {len(filtered_records)}ê°œì˜ ê¸°ë¡ì´ ìˆìŠµë‹ˆë‹¤.")
        
        for i, record in enumerate(filtered_records):
            with st.expander(f"{'ğŸ“' if record['content_type'] == 'summary' else 'ğŸ“‹' if record['content_type'] == 'application' else 'ğŸ“š'} {record['book_title']} - {record['content_type'].upper()} ({record['created_at'].strftime('%Y-%m-%d %H:%M')})"):
                # ë©”íƒ€ë°ì´í„° ì •ë³´
                meta_col1, meta_col2 = st.columns(2)
                with meta_col1:
                    st.write(f"**ğŸ“– ì±… ì œëª©:** {record['book_title']}")
                    st.write(f"**ğŸ“„ ì›ë³¸ íŒŒì¼:** {record['source_file_name'] or 'N/A'}")
                    st.write(f"**ğŸ¤– ì‚¬ìš© ëª¨ë¸:** {record['model_used'] or 'N/A'}")
                with meta_col2:
                    if record['content_type'] == 'fable':
                        st.write(f"**ğŸ­ ìš°í™” ìŠ¤íƒ€ì¼:** {record['fable_type'] or 'N/A'}")
                    if record['next_topic']:
                        st.write(f"**â¡ï¸ ë‹¤ìŒ ì£¼ì œ:** {record['next_topic']}")
                    if record['previous_topic']:
                        st.write(f"**â¬…ï¸ ì´ì „ ì£¼ì œ:** {record['previous_topic']}")
                
                # ì¶”ê°€ í”„ë¡¬í”„íŠ¸ê°€ ìˆë‹¤ë©´ í‘œì‹œ
                if record['extra_prompt']:
                    st.write(f"**ğŸ’¡ ì¶”ê°€ í”„ë¡¬í”„íŠ¸:** {record['extra_prompt']}")
                
                # AI ìƒì„± ì½˜í…ì¸  í‘œì‹œ
                if record['ai_content']:
                    st.markdown("#### ğŸ“ ì €ì¥ëœ ì½˜í…ì¸ ")
                    if record['content_type'] == 'summary':
                        # ìš”ì•½ì˜ ê²½ìš° ì›ë³¸ê³¼ AI ìš”ì•½ì„ êµ¬ë¶„í•˜ì—¬ í‘œì‹œ
                        content = record['ai_content']
                        if "=== ğŸ“ ì›ë³¸ ìš”ì•½ íŒŒì¼ ===" in content and "=== ğŸ¤– AI ìƒì„± í•µì‹¬ ìš”ì•½ ===" in content:
                            parts = content.split("=== ğŸ¤– AI ìƒì„± í•µì‹¬ ìš”ì•½ ===")
                            if len(parts) == 2:
                                original_content = parts[0].replace("=== ğŸ“ ì›ë³¸ ìš”ì•½ íŒŒì¼ ===", "").strip()
                                ai_content = parts[1].strip()
                                # íƒ­ ì—†ì´ í•œ í™”ë©´ì— í‘œì‹œ
                                st.markdown("##### ğŸ“ ì›ë³¸ ìš”ì•½")
                                st.markdown(format_bullet_points(original_content))
                                st.markdown("---")
                                st.markdown("##### ğŸ¤– ë¹„ì¦ˆë‹ˆìŠ¤ ì‹¤ì „ ì ìš© í•µì‹¬")
                                st.markdown(format_bullet_points(ai_content))
                            else:
                                st.markdown(format_bullet_points(content))
                        else:
                            st.markdown(format_bullet_points(content))
                    elif record['content_type'] == 'application':
                        # ì ìš© íŒŒì¼ì˜ ê²½ìš° ì›ë³¸ê³¼ AI ìš”ì•½ì„ êµ¬ë¶„í•˜ì—¬ í‘œì‹œ
                        content = record['ai_content']
                        if "=== ğŸ“ ì›ë³¸ ì ìš© íŒŒì¼ ===" in content and "=== ğŸ¤– AI ìš”ì•½ ë° ì´í‰ ===" in content:
                            parts = content.split("=== ğŸ¤– AI ìš”ì•½ ë° ì´í‰ ===")
                            if len(parts) == 2:
                                original_content = parts[0].replace("=== ğŸ“ ì›ë³¸ ì ìš© íŒŒì¼ ===", "").strip()
                                ai_content = parts[1].strip()
                                
                                # íƒ­ìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ í‘œì‹œ
                                sub_tab1, sub_tab2 = st.tabs(["ğŸ“ ì›ë³¸ ì ìš© íŒŒì¼", "ğŸ¤– AI ìš”ì•½ ë° ì´í‰"])
                                with sub_tab1:
                                    st.markdown(format_bullet_points(original_content))
                                with sub_tab2:
                                    st.markdown(ai_content)
                            else:
                                st.markdown(format_bullet_points(content))
                        else:
                            st.markdown(format_bullet_points(content))
                    else:
                        # ìš°í™”ì˜ ê²½ìš° ê·¸ëŒ€ë¡œ í‘œì‹œ
                        st.markdown(record['ai_content'])
                
                # ìŒì„± ì¬ìƒ ê¸°ëŠ¥
                if record['audio_data']:
                    st.markdown("#### ğŸµ ìŒì„± ì¬ìƒ")
                    try:
                        # BLOB ë°ì´í„°ë¥¼ base64ë¡œ ë³€í™˜í•˜ì—¬ ì¬ìƒ
                        audio_base64 = base64.b64encode(record['audio_data']).decode('utf-8')
                        audio_html = f'''
                            <audio controls style="width: 100%;">
                                <source src="data:audio/mp3;base64,{audio_base64}" type="audio/mp3">
                                Your browser does not support the audio element.
                            </audio>
                        '''
                        st.markdown(audio_html, unsafe_allow_html=True)
                        
                        # ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í‘œì‹œ
                        st.download_button(
                            label="ğŸµ ìŒì„± íŒŒì¼ ë‹¤ìš´ë¡œë“œ",
                            data=record['audio_data'],
                            file_name=record['audio_filename'] or f"{record['content_type']}_{record['book_title']}_{record['id']}.mp3",
                            mime="audio/mp3",
                            key=f"download_audio_{record['id']}"
                        )
                    except Exception as e:
                        st.error(f"ìŒì„± ì¬ìƒ ì¤‘ ì˜¤ë¥˜: {str(e)}")
                else:
                    st.info("ì €ì¥ëœ ìŒì„± íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
                
                # êµ¬ë¶„ì„ 
                st.markdown("---")
    else:
        st.info("ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. AI ìš”ì•½ì´ë‚˜ ìš°í™”ë¥¼ ìƒì„±í•˜ê³  ìŒì„±ì„ ìƒì„±í•´ë³´ì„¸ìš”!")
    
    # í‘¸í„°
    st.markdown("---")
    st.markdown("""
    **ğŸ’¡ ì‚¬ìš© íŒ:**
    - **íƒ­ êµ¬ë¶„**: "AI í•µì‹¬ ìš”ì•½" ë° "AI ìš”ì•½ ë° ì´í‰" íƒ­ì˜ ë‚´ìš©ì´ ì‹¤ì œ ìŒì„±ìœ¼ë¡œ ë³€í™˜ëœ í…ìŠ¤íŠ¸ì…ë‹ˆë‹¤
    - **ë‹¤ìš´ë¡œë“œ**: ê° ìŒì„± íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
    - **ğŸŒ ì–¸ì–´ ì„ íƒ**: 4ê°€ì§€ ì–¸ì–´ ì˜µì…˜ì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
      - **í•œêµ­ì–´+ì˜ì–´** (ê¸°ë³¸): í•œêµ­ì–´ì™€ ì˜ì–´ë¡œ ëª…ì–¸ ìƒì„±
      - **í•œêµ­ì–´**: í•œêµ­ì–´ë¡œë§Œ ëª…ì–¸ ìƒì„±
      - **í•œêµ­ì–´+ì˜ì–´+ì¤‘êµ­ì–´**: í•œêµ­ì–´, ì˜ì–´, ì¤‘êµ­ì–´ë¡œ ëª…ì–¸ ìƒì„± (ì¤‘êµ­ì–´ì— í•œì–´ë³‘ìŒ í¬í•¨)
      - **í•œêµ­ì–´+ì˜ì–´+ì¤‘êµ­ì–´+ì¼ë³¸ì–´**: í•œêµ­ì–´, ì˜ì–´, ì¤‘êµ­ì–´, ì¼ë³¸ì–´ë¡œ ëª…ì–¸ ìƒì„± (ì¤‘êµ­ì–´ì— í•œì–´ë³‘ìŒ, ì¼ë³¸ì–´ì— ì¹´íƒ€ì¹´ë‚˜ í¬í•¨)
    - **ìµœì‹ ìˆœ ì •ë ¬**: ê°€ì¥ ìµœê·¼ì— ìƒì„±ëœ ì½˜í…ì¸ ë¶€í„° í‘œì‹œë©ë‹ˆë‹¤
    """)

if __name__ == "__main__":
    main() 