import streamlit as st
import requests
import json
import pandas as pd
from datetime import datetime
import os
from typing import Dict, List, Optional, Any
from dotenv import load_dotenv

# .env íŒŒì¼ ë¡œë“œ
load_dotenv()

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(
    page_title="Notion ë°ì´í„° ì½ê¸°",
    page_icon="ğŸ“",
    layout="wide"
)

# ì‚¬ì´ë“œë°” ì„¤ì •
st.sidebar.title("âš™ï¸ ì„¤ì •")

# Notion API ì„¤ì • (.envì—ì„œ ì½ì–´ì˜¤ê¸°)
NOTION_API_KEY = os.getenv("NOTION_API_KEY")
NOTION_DB_URL = os.getenv("NOTION_DB_URL")

# Database ID ì¶”ì¶œ í•¨ìˆ˜
def extract_database_id(url: str) -> str:
    """Notion URLì—ì„œ Database IDë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤."""
    import re
    
    # ë‹¤ì–‘í•œ URL íŒ¨í„´ì—ì„œ Database ID ì¶”ì¶œ
    patterns = [
        r'notion\.so/workspace/([a-zA-Z0-9]{32})',
        r'notion\.so/([a-zA-Z0-9]{32})',
        r'notion\.so/workspace/([a-zA-Z0-9]{32})\?',
        r'notion\.so/([a-zA-Z0-9]{32})\?'
    ]
    
    for pattern in patterns:
        match = re.search(pattern, url)
        if match:
            return match.group(1)
    
    return None

# Database ID ì¶”ì¶œ
DATABASE_ID = None
if NOTION_DB_URL:
    DATABASE_ID = extract_database_id(NOTION_DB_URL)
    if DATABASE_ID:
        st.sidebar.success(f"âœ… Database IDê°€ URLì—ì„œ ì¶”ì¶œë˜ì—ˆìŠµë‹ˆë‹¤: {DATABASE_ID[:8]}...")
    else:
        st.sidebar.error("âŒ URLì—ì„œ Database IDë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        st.sidebar.info("ğŸ’¡ ì˜¬ë°”ë¥¸ Notion ë°ì´í„°ë² ì´ìŠ¤ URLì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.")
else:
    st.sidebar.error("âŒ .env íŒŒì¼ì—ì„œ NOTION_DB_URLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    st.sidebar.info("ğŸ’¡ .env íŒŒì¼ì— NOTION_DB_URL=your_notion_url í˜•ì‹ìœ¼ë¡œ ì¶”ê°€í•´ì£¼ì„¸ìš”.")

# ìˆ˜ë™ Database ID ì…ë ¥ (ë°±ì—…ìš©)
MANUAL_DATABASE_ID = st.sidebar.text_input(
    "Database ID (ìˆ˜ë™ ì…ë ¥)",
    help="ìë™ ì¶”ì¶œì´ ì‹¤íŒ¨í•œ ê²½ìš° ìˆ˜ë™ìœ¼ë¡œ Database IDë¥¼ ì…ë ¥í•˜ì„¸ìš”."
)

# ìµœì¢… Database ID ê²°ì •
FINAL_DATABASE_ID = DATABASE_ID or MANUAL_DATABASE_ID

if NOTION_API_KEY:
    st.sidebar.success("âœ… Notion API í‚¤ê°€ .env íŒŒì¼ì—ì„œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.")
else:
    st.sidebar.error("âŒ .env íŒŒì¼ì—ì„œ NOTION_API_KEYë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    st.sidebar.info("ğŸ’¡ .env íŒŒì¼ì— NOTION_API_KEY=your_api_key í˜•ì‹ìœ¼ë¡œ ì¶”ê°€í•´ì£¼ì„¸ìš”.")

# ë©”ì¸ í•¨ìˆ˜ë“¤
def test_notion_connection(api_key: str) -> Dict:
    """Notion API ì—°ê²°ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤."""
    url = "https://api.notion.com/v1/users/me"
    
    headers = {
        "Authorization": f"Bearer {api_key}",
        "Notion-Version": "2022-06-28",
        "Content-Type": "application/json"
    }
    
    try:
        response = requests.get(url, headers=headers)
        response.raise_for_status()
        return {"success": True, "data": response.json()}
    except requests.exceptions.RequestException as e:
        return {"success": False, "error": str(e), "status_code": response.status_code if 'response' in locals() else None}

def get_notion_database(database_id: str, api_key: str) -> Dict:
    """Notion ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤."""
    url = f"https://api.notion.com/v1/databases/{database_id}/query"
    
    headers = {
        "Authorization": f"Bearer {api_key}",
        "Notion-Version": "2022-06-28",
        "Content-Type": "application/json"
    }
    
    try:
        response = requests.post(url, headers=headers)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.RequestException as e:
        st.error(f"API ìš”ì²­ ì˜¤ë¥˜: {e}")
        if hasattr(e, 'response') and e.response is not None:
            st.error(f"ìƒíƒœ ì½”ë“œ: {e.response.status_code}")
            try:
                error_detail = e.response.json()
                st.error(f"ì˜¤ë¥˜ ìƒì„¸: {error_detail}")
            except:
                st.error(f"ì‘ë‹µ ë‚´ìš©: {e.response.text}")
        return None

def parse_notion_properties(properties: Dict) -> Dict:
    """Notion ì†ì„±ë“¤ì„ íŒŒì‹±í•©ë‹ˆë‹¤."""
    parsed = {}
    
    for key, value in properties.items():
        prop_type = value.get("type")
        
        if prop_type == "title":
            title_content = value.get("title", [])
            if title_content:
                parsed[key] = title_content[0].get("plain_text", "")
            else:
                parsed[key] = ""
                
        elif prop_type == "rich_text":
            rich_text_content = value.get("rich_text", [])
            if rich_text_content:
                parsed[key] = rich_text_content[0].get("plain_text", "")
            else:
                parsed[key] = ""
                
        elif prop_type == "number":
            parsed[key] = value.get("number")
            
        elif prop_type == "select":
            select_value = value.get("select")
            if select_value:
                parsed[key] = select_value.get("name", "")
            else:
                parsed[key] = ""
                
        elif prop_type == "multi_select":
            multi_select_values = value.get("multi_select", [])
            parsed[key] = ", ".join([item.get("name", "") for item in multi_select_values])
            
        elif prop_type == "date":
            date_value = value.get("date")
            if date_value:
                parsed[key] = date_value.get("start", "")
            else:
                parsed[key] = ""
                
        elif prop_type == "checkbox":
            parsed[key] = value.get("checkbox", False)
            
        elif prop_type == "url":
            parsed[key] = value.get("url", "")
            
        elif prop_type == "email":
            parsed[key] = value.get("email", "")
            
        elif prop_type == "phone_number":
            parsed[key] = value.get("phone_number", "")
            
        else:
            parsed[key] = str(value)
    
    return parsed

def convert_to_dataframe(notion_data: Dict) -> pd.DataFrame:
    """Notion ë°ì´í„°ë¥¼ DataFrameìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤."""
    if not notion_data or "results" not in notion_data:
        return pd.DataFrame()
    
    rows = []
    for page in notion_data["results"]:
        properties = page.get("properties", {})
        parsed_properties = parse_notion_properties(properties)
        
        # í˜ì´ì§€ IDì™€ ìƒì„±/ìˆ˜ì • ì‹œê°„ ì¶”ê°€
        parsed_properties["page_id"] = page.get("id", "")
        parsed_properties["created_time"] = page.get("created_time", "")
        parsed_properties["last_edited_time"] = page.get("last_edited_time", "")
        
        rows.append(parsed_properties)
    
    return pd.DataFrame(rows)

def export_data(df: pd.DataFrame, format_type: str):
    """ë°ì´í„°ë¥¼ ë‹¤ì–‘í•œ í˜•ì‹ìœ¼ë¡œ ë‚´ë³´ëƒ…ë‹ˆë‹¤."""
    if df.empty:
        st.warning("ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return
    
    if format_type == "CSV":
        csv = df.to_csv(index=False, encoding='utf-8-sig')
        st.download_button(
            label="CSV ë‹¤ìš´ë¡œë“œ",
            data=csv,
            file_name=f"notion_data_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv",
            mime="text/csv"
        )
    elif format_type == "Excel":
        output = pd.ExcelWriter('temp.xlsx', engine='openpyxl')
        df.to_excel(output, index=False, sheet_name='Notion Data')
        output.close()
        
        with open('temp.xlsx', 'rb') as f:
            excel_data = f.read()
        
        st.download_button(
            label="Excel ë‹¤ìš´ë¡œë“œ",
            data=excel_data,
            file_name=f"notion_data_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx",
            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        )
        
        # ì„ì‹œ íŒŒì¼ ì‚­ì œ
        if os.path.exists('temp.xlsx'):
            os.remove('temp.xlsx')

def get_notion_page_content(page_id: str, api_key: str) -> Dict:
    """Notion í˜ì´ì§€ì˜ ìƒì„¸ ë‚´ìš©ì„ ê°€ì ¸ì˜µë‹ˆë‹¤."""
    url = f"https://api.notion.com/v1/pages/{page_id}"
    
    headers = {
        "Authorization": f"Bearer {api_key}",
        "Notion-Version": "2022-06-28",
        "Content-Type": "application/json"
    }
    
    try:
        response = requests.get(url, headers=headers)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.RequestException as e:
        st.error(f"í˜ì´ì§€ ë‚´ìš© ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜: {e}")
        return None

def get_notion_page_blocks(page_id: str, api_key: str) -> List[Dict]:
    """Notion í˜ì´ì§€ì˜ ë¸”ë¡ ë‚´ìš©ì„ ê°€ì ¸ì˜µë‹ˆë‹¤."""
    url = f"https://api.notion.com/v1/blocks/{page_id}/children"
    
    headers = {
        "Authorization": f"Bearer {api_key}",
        "Notion-Version": "2022-06-28",
        "Content-Type": "application/json"
    }
    
    try:
        response = requests.get(url, headers=headers)
        response.raise_for_status()
        return response.json().get("results", [])
    except requests.exceptions.RequestException as e:
        st.error(f"ë¸”ë¡ ë‚´ìš© ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜: {e}")
        return []

def parse_notion_blocks(blocks: List[Dict], api_key: str = None) -> str:
    """Notion ë¸”ë¡ë“¤ì„ í…ìŠ¤íŠ¸ë¡œ íŒŒì‹±í•©ë‹ˆë‹¤."""
    content = []
    
    for block in blocks:
        block_type = block.get("type")
        
        if block_type == "paragraph":
            rich_text = block.get("paragraph", {}).get("rich_text", [])
            if rich_text:
                text = "".join([rt.get("plain_text", "") for rt in rich_text])
                if text.strip():
                    content.append(text)
                    
        elif block_type == "heading_1":
            rich_text = block.get("heading_1", {}).get("rich_text", [])
            if rich_text:
                text = "".join([rt.get("plain_text", "") for rt in rich_text])
                if text.strip():
                    content.append(f"# {text}")
                    
        elif block_type == "heading_2":
            rich_text = block.get("heading_2", {}).get("rich_text", [])
            if rich_text:
                text = "".join([rt.get("plain_text", "") for rt in rich_text])
                if text.strip():
                    content.append(f"## {text}")
                    
        elif block_type == "heading_3":
            rich_text = block.get("heading_3", {}).get("rich_text", [])
            if rich_text:
                text = "".join([rt.get("plain_text", "") for rt in rich_text])
                if text.strip():
                    content.append(f"### {text}")
                    
        elif block_type == "bulleted_list_item":
            rich_text = block.get("bulleted_list_item", {}).get("rich_text", [])
            if rich_text:
                text = "".join([rt.get("plain_text", "") for rt in rich_text])
                if text.strip():
                    content.append(f"â€¢ {text}")
                    
        elif block_type == "numbered_list_item":
            rich_text = block.get("numbered_list_item", {}).get("rich_text", [])
            if rich_text:
                text = "".join([rt.get("plain_text", "") for rt in rich_text])
                if text.strip():
                    content.append(f"1. {text}")
                    
        elif block_type == "quote":
            rich_text = block.get("quote", {}).get("rich_text", [])
            if rich_text:
                text = "".join([rt.get("plain_text", "") for rt in rich_text])
                if text.strip():
                    content.append(f"> {text}")
                    
        elif block_type == "code":
            rich_text = block.get("code", {}).get("rich_text", [])
            if rich_text:
                text = "".join([rt.get("plain_text", "") for rt in rich_text])
                if text.strip():
                    content.append(f"```\n{text}\n```")
                    
        elif block_type == "divider":
            content.append("---")
            
        elif block_type == "table_of_contents":
            content.append("[ëª©ì°¨]")
            
        elif block_type == "callout":
            rich_text = block.get("callout", {}).get("rich_text", [])
            if rich_text:
                text = "".join([rt.get("plain_text", "") for rt in rich_text])
                if text.strip():
                    icon = block.get("callout", {}).get("icon", {}).get("emoji", "ğŸ’¡")
                    content.append(f"{icon} {text}")
                    
        elif block_type == "toggle":
            rich_text = block.get("toggle", {}).get("rich_text", [])
            if rich_text:
                text = "".join([rt.get("plain_text", "") for rt in rich_text])
                if text.strip():
                    content.append(f"â–¶ {text}")
                    
        elif block_type == "to_do":
            rich_text = block.get("to_do", {}).get("rich_text", [])
            if rich_text:
                text = "".join([rt.get("plain_text", "") for rt in rich_text])
                if text.strip():
                    checked = block.get("to_do", {}).get("checked", False)
                    checkbox = "â˜‘" if checked else "â˜"
                    content.append(f"{checkbox} {text}")
                    
        elif block_type == "synced_block":
            # ë™ê¸°í™”ëœ ë¸”ë¡ì€ í•˜ìœ„ ë¸”ë¡ë“¤ì„ ì¬ê·€ì ìœ¼ë¡œ ì²˜ë¦¬
            children = block.get("synced_block", {}).get("children", [])
            if children:
                child_content = parse_notion_blocks(children, api_key)
                if child_content.strip():
                    content.append(child_content)
                    
        elif block_type == "child_database":
            # í•˜ìœ„ ë°ì´í„°ë² ì´ìŠ¤ëŠ” ë§í¬ë¡œ í‘œì‹œ
            database_id = block.get("child_database", {}).get("id", "")
            if database_id:
                content.append(f"[ğŸ“Š í•˜ìœ„ ë°ì´í„°ë² ì´ìŠ¤](https://notion.so/{database_id})")
                
        elif block_type == "child_page":
            # í•˜ìœ„ í˜ì´ì§€ì˜ ì‹¤ì œ ë‚´ìš©ì„ ê°€ì ¸ì™€ì„œ í‘œì‹œ
            page_id = block.get("child_page", {}).get("id", "")
            if page_id and api_key:
                # í•˜ìœ„ í˜ì´ì§€ì˜ ì œëª© ê°€ì ¸ì˜¤ê¸°
                page_info = get_notion_page_content(page_id, api_key)
                if page_info:
                    properties = page_info.get("properties", {})
                    title = ""
                    
                    # ì œëª© ì†ì„± ì°¾ê¸°
                    for prop_name, prop_value in properties.items():
                        if prop_value.get("type") == "title":
                            title_content = prop_value.get("title", [])
                            if title_content:
                                title = title_content[0].get("plain_text", "")
                                break
                    
                    if title:
                        content.append(f"## ğŸ“„ {title}")
                        
                        # í•˜ìœ„ í˜ì´ì§€ì˜ ë¸”ë¡ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
                        child_blocks = get_notion_page_blocks(page_id, api_key)
                        if child_blocks:
                            child_content = parse_notion_blocks(child_blocks, api_key)
                            if child_content.strip():
                                content.append(child_content)
                            else:
                                content.append("*[ë‚´ìš© ì—†ìŒ]*")
                        else:
                            content.append("*[ë‚´ìš©ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŒ]*")
                    else:
                        content.append(f"[ğŸ“„ í•˜ìœ„ í˜ì´ì§€](https://notion.so/{page_id})")
                else:
                    content.append(f"[ğŸ“„ í•˜ìœ„ í˜ì´ì§€](https://notion.so/{page_id})")
            else:
                content.append(f"[ğŸ“„ í•˜ìœ„ í˜ì´ì§€](https://notion.so/{page_id})")
                
        elif block_type == "embed":
            # ì„ë² ë“œëœ ì½˜í…ì¸ 
            url = block.get("embed", {}).get("url", "")
            if url:
                content.append(f"[ğŸ”— ì„ë² ë“œ ë§í¬]({url})")
                
        elif block_type == "image":
            # ì´ë¯¸ì§€
            url = block.get("image", {}).get("file", {}).get("url", "")
            if url:
                content.append(f"![ì´ë¯¸ì§€]({url})")
                
        elif block_type == "video":
            # ë¹„ë””ì˜¤
            url = block.get("video", {}).get("file", {}).get("url", "")
            if url:
                content.append(f"ğŸ¥ [ë¹„ë””ì˜¤]({url})")
                
        elif block_type == "file":
            # íŒŒì¼
            url = block.get("file", {}).get("file", {}).get("url", "")
            if url:
                content.append(f"ğŸ“ [íŒŒì¼]({url})")
                
        elif block_type == "pdf":
            # PDF
            url = block.get("pdf", {}).get("file", {}).get("url", "")
            if url:
                content.append(f"ğŸ“„ [PDF]({url})")
                
        elif block_type == "bookmark":
            # ë¶ë§ˆí¬
            url = block.get("bookmark", {}).get("url", "")
            if url:
                content.append(f"ğŸ”– [ë¶ë§ˆí¬]({url})")
                
        elif block_type == "equation":
            # ìˆ˜ì‹
            expression = block.get("equation", {}).get("expression", "")
            if expression:
                content.append(f"$${expression}$$")
                
        elif block_type == "table":
            # í…Œì´ë¸” (ê°„ë‹¨í•œ í…ìŠ¤íŠ¸ë¡œ í‘œì‹œ)
            content.append("[ğŸ“Š í…Œì´ë¸”]")
            
        elif block_type == "column_list":
            # ì»¬ëŸ¼ ë¦¬ìŠ¤íŠ¸
            content.append("[ğŸ“‹ ì»¬ëŸ¼ ë ˆì´ì•„ì›ƒ]")
            
        elif block_type == "column":
            # ì»¬ëŸ¼
            content.append("[ğŸ“‹ ì»¬ëŸ¼]")
            
        elif block_type == "template":
            # í…œí”Œë¦¿
            content.append("[ğŸ“‹ í…œí”Œë¦¿]")
            
        elif block_type == "link_preview":
            # ë§í¬ ë¯¸ë¦¬ë³´ê¸°
            url = block.get("link_preview", {}).get("url", "")
            if url:
                content.append(f"ğŸ”— [ë§í¬ ë¯¸ë¦¬ë³´ê¸°]({url})")
                
        elif block_type == "unsupported":
            # ì§€ì›ë˜ì§€ ì•ŠëŠ” ë¸”ë¡
            content.append("[âš ï¸ ì§€ì›ë˜ì§€ ì•ŠëŠ” ë¸”ë¡]")
            
        else:
            # ì•Œ ìˆ˜ ì—†ëŠ” ë¸”ë¡ íƒ€ì…
            content.append(f"[â“ ì•Œ ìˆ˜ ì—†ëŠ” ë¸”ë¡: {block_type}]")
    
    return "\n\n".join(content)

def display_meeting_details(df: pd.DataFrame, api_key: str):
    """íšŒì˜ë¡ ìƒì„¸ ë‚´ìš©ì„ í‘œì‹œí•©ë‹ˆë‹¤."""
    if df.empty:
        st.warning("í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return
    
    # íšŒì˜ë¡ í•­ëª©ë“¤ë§Œ í•„í„°ë§ (ì´ë¦„ì´ ìˆëŠ” í•­ëª©ë“¤)
    meeting_items = df[df['ì´ë¦„'].notna() & (df['ì´ë¦„'] != '')]
    
    if meeting_items.empty:
        st.warning("íšŒì˜ë¡ í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return
    
    st.subheader("ğŸ“‹ íšŒì˜ë¡ ìƒì„¸ ë‚´ìš©")
    
    # ëª¨ë“  í•­ëª© í‘œì‹œ
    st.info(f"ğŸ“Š ì´ {len(meeting_items)}ê°œì˜ íšŒì˜ë¡ì´ ìˆìŠµë‹ˆë‹¤:")
    for idx, row in meeting_items.iterrows():
        st.info(f"  - {row['ì´ë¦„']} (ìƒì„±ì¼: {row['created_time'][:10]})")
    
    # íšŒì˜ë¡ ì„ íƒ
    selected_meeting = st.selectbox(
        "íšŒì˜ë¡ ì„ íƒ",
        options=meeting_items['ì´ë¦„'].tolist(),
        index=0,
        help="ë¶„ì„í•  íšŒì˜ë¡ì„ ì„ íƒí•˜ì„¸ìš”"
    )
    
    if selected_meeting:
        # ì„ íƒëœ íšŒì˜ë¡ì˜ í˜ì´ì§€ ID ì°¾ê¸°
        selected_row = meeting_items[meeting_items['ì´ë¦„'] == selected_meeting].iloc[0]
        page_id = selected_row['page_id']
        
        st.info(f"ğŸ“„ **{selected_meeting}**")
        st.info(f"ğŸ“… ìƒì„±ì¼: {selected_row['created_time']}")
        st.info(f"ğŸ“ ìˆ˜ì •ì¼: {selected_row['last_edited_time']}")
        st.info(f"ğŸ†” í˜ì´ì§€ ID: `{page_id}`")
        
        # í˜ì´ì§€ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
        with st.spinner("íšŒì˜ë¡ ë‚´ìš©ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."):
            blocks = get_notion_page_blocks(page_id, api_key)
            
            if blocks:
                st.success(f"âœ… {len(blocks)}ê°œì˜ ë¸”ë¡ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.")
                
                # ë¸”ë¡ íƒ€ì… ë¶„ì„
                block_types = [block.get("type", "unknown") for block in blocks]
                type_counts = {}
                for block_type in block_types:
                    type_counts[block_type] = type_counts.get(block_type, 0) + 1
                
                st.info("ğŸ“Š ë¸”ë¡ íƒ€ì… ë¶„ì„:")
                for block_type, count in type_counts.items():
                    st.info(f"  - {block_type}: {count}ê°œ")
                
                content = parse_notion_blocks(blocks, api_key)
                
                if content.strip():
                    st.markdown("---")
                    st.markdown("### ğŸ“ íšŒì˜ë¡ ë‚´ìš©")
                    st.markdown(content)
                    
                    # LLM ë¶„ì„ ê¸°ëŠ¥
                    st.markdown("---")
                    st.subheader("ğŸ¤– LLM ë¶„ì„")
                    
                    # ë¶„ì„ ì˜µì…˜
                    analysis_type = st.selectbox(
                        "ë¶„ì„ ìœ í˜• ì„ íƒ",
                        [
                            "íšŒì˜ë¡ ìš”ì•½",
                            "ì£¼ìš” ë…¼ì˜ ì‚¬í•­ ì¶”ì¶œ",
                            "ì•¡ì…˜ ì•„ì´í…œ ì¶”ì¶œ",
                            "ê²°ì • ì‚¬í•­ ì •ë¦¬",
                            "ì°¸ì„ìë³„ ì—­í•  ë¶„ì„",
                            "ì „ì²´ ë¶„ì„ ë¦¬í¬íŠ¸"
                        ],
                        help="ì›í•˜ëŠ” ë¶„ì„ ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”"
                    )
                    
                    if st.button("ğŸ” LLM ë¶„ì„ ì‹œì‘", type="primary"):
                        with st.spinner("LLMì´ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤..."):
                            analysis_result = analyze_with_llm(content, analysis_type)
                            if analysis_result:
                                st.markdown("### ğŸ“Š ë¶„ì„ ê²°ê³¼")
                                st.markdown(analysis_result)
                                
                                # ë¶„ì„ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
                                st.download_button(
                                    label="ğŸ“„ ë¶„ì„ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ",
                                    data=analysis_result,
                                    file_name=f"{selected_meeting}_ë¶„ì„ê²°ê³¼_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md",
                                    mime="text/markdown"
                                )
                    
                    # ì›ë³¸ JSON ë°ì´í„° (ë””ë²„ê¹…ìš©)
                    with st.expander("ğŸ”§ ì›ë³¸ ë°ì´í„° ë³´ê¸°"):
                        st.json(blocks)
                        
                    # ë¸”ë¡ íƒ€ì…ë³„ ìƒì„¸ ì •ë³´
                    with st.expander("ğŸ” ë¸”ë¡ íƒ€ì…ë³„ ìƒì„¸ ì •ë³´"):
                        for i, block in enumerate(blocks):
                            block_type = block.get("type", "unknown")
                            st.write(f"**ë¸”ë¡ {i+1}**: {block_type}")
                            if block_type in ["paragraph", "heading_1", "heading_2", "heading_3"]:
                                rich_text = block.get(block_type, {}).get("rich_text", [])
                                if rich_text:
                                    text = "".join([rt.get("plain_text", "") for rt in rich_text])
                                    st.write(f"  ë‚´ìš©: {text}")
                            st.write("---")
                else:
                    st.warning("âš ï¸ íšŒì˜ë¡ ë‚´ìš©ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.")
                    st.info("ğŸ’¡ ë‹¤ìŒ ì‚¬í•­ë“¤ì„ í™•ì¸í•´ì£¼ì„¸ìš”:")
                    st.info("1. í˜ì´ì§€ì— ì‹¤ì œ ë‚´ìš©ì´ ìˆëŠ”ì§€ í™•ì¸")
                    st.info("2. Integrationì´ í˜ì´ì§€ì— ì ‘ê·¼ ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸")
                    st.info("3. í˜ì´ì§€ê°€ ë¹„ì–´ìˆê±°ë‚˜ íŠ¹ìˆ˜í•œ ë¸”ë¡ íƒ€ì…ë§Œ ìˆëŠ”ì§€ í™•ì¸")
                    
                    # ë””ë²„ê¹…ì„ ìœ„í•´ ì›ë³¸ ë°ì´í„° í‘œì‹œ
                    with st.expander("ğŸ”§ ë””ë²„ê¹…: ì›ë³¸ ë¸”ë¡ ë°ì´í„°"):
                        st.json(blocks)
            else:
                st.error("âŒ íšŒì˜ë¡ ë‚´ìš©ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                st.info("ğŸ’¡ ë‹¤ìŒ ì‚¬í•­ë“¤ì„ í™•ì¸í•´ì£¼ì„¸ìš”:")
                st.info("1. Integrationì´ í˜ì´ì§€ì— ì ‘ê·¼ ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸")
                st.info("2. í˜ì´ì§€ IDê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸")
                st.info("3. í˜ì´ì§€ê°€ ì‚­ì œë˜ì—ˆê±°ë‚˜ ì´ë™ë˜ì—ˆëŠ”ì§€ í™•ì¸")
                
                # í˜ì´ì§€ ì •ë³´ í™•ì¸
                page_info = get_notion_page_content(page_id, api_key)
                if page_info:
                    with st.expander("ğŸ”§ í˜ì´ì§€ ì •ë³´"):
                        st.json(page_info)

def analyze_with_llm(content: str, analysis_type: str) -> str:
    """LLMì„ ì‚¬ìš©í•˜ì—¬ íšŒì˜ë¡ì„ ë¶„ì„í•©ë‹ˆë‹¤."""
    try:
        # OpenAI API í‚¤ í™•ì¸
        openai_api_key = os.getenv("OPENAI_API_KEY")
        if not openai_api_key:
            return "âŒ OpenAI API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. .env íŒŒì¼ì— OPENAI_API_KEYë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”."
        
        import openai
        client = openai.OpenAI(api_key=openai_api_key)
        
        # ë¶„ì„ í”„ë¡¬í”„íŠ¸ ìƒì„±
        prompts = {
            "íšŒì˜ë¡ ìš”ì•½": "ë‹¤ìŒ íšŒì˜ë¡ì„ ê°„ê²°í•˜ê²Œ ìš”ì•½í•´ì£¼ì„¸ìš”. ì£¼ìš” ë‚´ìš©ì„ 3-4ê°œì˜ í•µì‹¬ í¬ì¸íŠ¸ë¡œ ì •ë¦¬í•´ì£¼ì„¸ìš”.",
            "ì£¼ìš” ë…¼ì˜ ì‚¬í•­ ì¶”ì¶œ": "ë‹¤ìŒ íšŒì˜ë¡ì—ì„œ ì£¼ìš” ë…¼ì˜ ì‚¬í•­ë“¤ì„ ì¶”ì¶œí•´ì£¼ì„¸ìš”. ê° í•­ëª©ì„ ëª…í™•í•˜ê²Œ êµ¬ë¶„í•´ì„œ ì •ë¦¬í•´ì£¼ì„¸ìš”.",
            "ì•¡ì…˜ ì•„ì´í…œ ì¶”ì¶œ": "ë‹¤ìŒ íšŒì˜ë¡ì—ì„œ ì•¡ì…˜ ì•„ì´í…œ(í•´ì•¼ í•  ì¼)ë“¤ì„ ì¶”ì¶œí•´ì£¼ì„¸ìš”. ë‹´ë‹¹ìì™€ ê¸°í•œì´ ìˆë‹¤ë©´ í•¨ê»˜ í‘œì‹œí•´ì£¼ì„¸ìš”.",
            "ê²°ì • ì‚¬í•­ ì •ë¦¬": "ë‹¤ìŒ íšŒì˜ë¡ì—ì„œ ê²°ì •ëœ ì‚¬í•­ë“¤ì„ ì •ë¦¬í•´ì£¼ì„¸ìš”. ê° ê²°ì • ì‚¬í•­ì˜ ë°°ê²½ê³¼ ì´ìœ ë„ í¬í•¨í•´ì£¼ì„¸ìš”.",
            "ì°¸ì„ìë³„ ì—­í•  ë¶„ì„": "ë‹¤ìŒ íšŒì˜ë¡ì—ì„œ ì°¸ì„ìë“¤ì˜ ì—­í• ê³¼ ê¸°ì—¬ë„ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”. ê°ìì˜ ì±…ì„ê³¼ ì—­í• ì„ ì •ë¦¬í•´ì£¼ì„¸ìš”.",
            "ì „ì²´ ë¶„ì„ ë¦¬í¬íŠ¸": "ë‹¤ìŒ íšŒì˜ë¡ì„ ì¢…í•©ì ìœ¼ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”. ìš”ì•½, ì£¼ìš” ë…¼ì˜ ì‚¬í•­, ì•¡ì…˜ ì•„ì´í…œ, ê²°ì • ì‚¬í•­, ì°¸ì„ì ì—­í• ì„ ëª¨ë‘ í¬í•¨í•œ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”."
        }
        
        prompt = prompts.get(analysis_type, "ë‹¤ìŒ íšŒì˜ë¡ì„ ë¶„ì„í•´ì£¼ì„¸ìš”.")
        
        # LLM í˜¸ì¶œ
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": "ë‹¹ì‹ ì€ íšŒì˜ë¡ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì£¼ì–´ì§„ íšŒì˜ë¡ì„ ì²´ê³„ì ìœ¼ë¡œ ë¶„ì„í•˜ê³  ëª…í™•í•˜ê²Œ ì •ë¦¬í•´ì£¼ì„¸ìš”."},
                {"role": "user", "content": f"{prompt}\n\níšŒì˜ë¡ ë‚´ìš©:\n{content}"}
            ],
            max_tokens=2000,
            temperature=0.3
        )
        
        return response.choices[0].message.content
        
    except Exception as e:
        return f"âŒ LLM ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"

# ë©”ì¸ ì•±
def main():
    st.title("ğŸ“ Notion ë°ì´í„° ì½ê¸°")
    st.markdown("---")
    
    # ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
    if 'notion_data' not in st.session_state:
        st.session_state.notion_data = None
    if 'selected_meeting' not in st.session_state:
        st.session_state.selected_meeting = None
    if 'meeting_content' not in st.session_state:
        st.session_state.meeting_content = None
    
    # API í‚¤ì™€ ë°ì´í„°ë² ì´ìŠ¤ ID í™•ì¸
    if not NOTION_API_KEY:
        st.warning("âš ï¸ Notion API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        st.info("ğŸ’¡ Notion API í‚¤ëŠ” https://www.notion.so/my-integrations ì—ì„œ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
        return
    
    # API ì—°ê²° í…ŒìŠ¤íŠ¸
    if st.button("ğŸ”— API ì—°ê²° í…ŒìŠ¤íŠ¸", type="secondary"):
        with st.spinner("API ì—°ê²°ì„ í…ŒìŠ¤íŠ¸í•˜ëŠ” ì¤‘..."):
            test_result = test_notion_connection(NOTION_API_KEY)
            
            if test_result["success"]:
                st.success("âœ… API ì—°ê²° ì„±ê³µ!")
                st.json(test_result["data"])
            else:
                st.error(f"âŒ API ì—°ê²° ì‹¤íŒ¨: {test_result['error']}")
                if test_result.get("status_code"):
                    st.error(f"ìƒíƒœ ì½”ë“œ: {test_result['status_code']}")
    
    if not FINAL_DATABASE_ID:
        st.warning("âš ï¸ Database IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        st.info("ğŸ’¡ Database IDëŠ” Notion ë°ì´í„°ë² ì´ìŠ¤ URLì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
        return
    
    # ë°ì´í„°ë² ì´ìŠ¤ ì •ë³´ í‘œì‹œ
    st.info(f"ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ ID: `{FINAL_DATABASE_ID}`")
    
    # ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ë²„íŠ¼
    if st.button("ğŸ”„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°", type="primary"):
        with st.spinner("ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."):
            notion_data = get_notion_database(FINAL_DATABASE_ID, NOTION_API_KEY)
            
            if notion_data:
                df = convert_to_dataframe(notion_data)
                
                if not df.empty:
                    st.session_state.notion_data = df
                    st.success(f"âœ… {len(df)}ê°œì˜ í•­ëª©ì„ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤!")
                    
                    # ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°
                    st.subheader("ğŸ“Š ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°")
                    st.dataframe(df, use_container_width=True)
                    
                    # íšŒì˜ë¡ ìƒì„¸ ë‚´ìš© í‘œì‹œ
                    display_meeting_details(df, NOTION_API_KEY)
                    
                    # ë°ì´í„° í†µê³„
                    st.subheader("ğŸ“ˆ ë°ì´í„° í†µê³„")
                    col1, col2, col3 = st.columns(3)
                    
                    with col1:
                        st.metric("ì´ í•­ëª© ìˆ˜", len(df))
                    
                    with col2:
                        st.metric("ì»¬ëŸ¼ ìˆ˜", len(df.columns))
                    
                    with col3:
                        st.metric("ë°ì´í„° í¬ê¸°", f"{df.memory_usage(deep=True).sum() / 1024:.1f} KB")
                    
                    # ë°ì´í„° ë‚´ë³´ë‚´ê¸°
                    st.subheader("ğŸ’¾ ë°ì´í„° ë‚´ë³´ë‚´ê¸°")
                    export_format = st.selectbox(
                        "ë‚´ë³´ë‚¼ í˜•ì‹ ì„ íƒ",
                        ["CSV", "Excel"]
                    )
                    
                    export_data(df, export_format)
                    
                    # ë°ì´í„° ê²€ìƒ‰ ë° í•„í„°ë§
                    st.subheader("ğŸ” ë°ì´í„° ê²€ìƒ‰")
                    search_term = st.text_input("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”")
                    
                    if search_term:
                        # ëª¨ë“  ë¬¸ìì—´ ì»¬ëŸ¼ì—ì„œ ê²€ìƒ‰
                        mask = pd.DataFrame([df[col].astype(str).str.contains(search_term, case=False, na=False) 
                                          for col in df.select_dtypes(include=['object']).columns]).any()
                        filtered_df = df[mask]
                        st.dataframe(filtered_df, use_container_width=True)
                    
                else:
                    st.warning("âš ï¸ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                    st.info("ğŸ’¡ ë°ì´í„°ë² ì´ìŠ¤ì— í•­ëª©ì´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.")
            else:
                st.error("âŒ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
                st.info("ğŸ’¡ ë‹¤ìŒ ì‚¬í•­ë“¤ì„ í™•ì¸í•´ì£¼ì„¸ìš”:")
                st.info("1. Integrationì´ ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸")
                st.info("2. Integrationì— ì½ê¸° ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸")
                st.info("3. ë°ì´í„°ë² ì´ìŠ¤ IDê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸")
    
    # ì„¸ì…˜ì— ì €ì¥ëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ í‘œì‹œ
    elif st.session_state.notion_data is not None:
        df = st.session_state.notion_data
        
        st.success(f"âœ… {len(df)}ê°œì˜ í•­ëª©ì´ ë¡œë“œë˜ì–´ ìˆìŠµë‹ˆë‹¤.")
        
        # ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°
        st.subheader("ğŸ“Š ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°")
        st.dataframe(df, use_container_width=True)
        
        # íšŒì˜ë¡ ìƒì„¸ ë‚´ìš© í‘œì‹œ
        display_meeting_details(df, NOTION_API_KEY)
        
        # ë°ì´í„° í†µê³„
        st.subheader("ğŸ“ˆ ë°ì´í„° í†µê³„")
        col1, col2, col3 = st.columns(3)
        
        with col1:
            st.metric("ì´ í•­ëª© ìˆ˜", len(df))
        
        with col2:
            st.metric("ì»¬ëŸ¼ ìˆ˜", len(df.columns))
        
        with col3:
            st.metric("ë°ì´í„° í¬ê¸°", f"{df.memory_usage(deep=True).sum() / 1024:.1f} KB")
        
        # ë°ì´í„° ë‚´ë³´ë‚´ê¸°
        st.subheader("ğŸ’¾ ë°ì´í„° ë‚´ë³´ë‚´ê¸°")
        export_format = st.selectbox(
            "ë‚´ë³´ë‚¼ í˜•ì‹ ì„ íƒ",
            ["CSV", "Excel"]
        )
        
        export_data(df, export_format)
        
        # ë°ì´í„° ê²€ìƒ‰ ë° í•„í„°ë§
        st.subheader("ğŸ” ë°ì´í„° ê²€ìƒ‰")
        search_term = st.text_input("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”")
        
        if search_term:
            # ëª¨ë“  ë¬¸ìì—´ ì»¬ëŸ¼ì—ì„œ ê²€ìƒ‰
            mask = pd.DataFrame([df[col].astype(str).str.contains(search_term, case=False, na=False) 
                              for col in df.select_dtypes(include=['object']).columns]).any()
            filtered_df = df[mask]
            st.dataframe(filtered_df, use_container_width=True)

# ì•± ì‹¤í–‰
if __name__ == "__main__":
    main()
