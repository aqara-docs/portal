import streamlit as st
import os
from datetime import datetime
import time
import random
from dotenv import load_dotenv
from openai import OpenAI
import anthropic
from langchain_anthropic import ChatAnthropic
import json
import asyncio
import threading
from concurrent.futures import ThreadPoolExecutor, as_completed

# RAG ê´€ë ¨ import ì¶”ê°€
import mysql.connector
import pandas as pd
from sqlalchemy import create_engine
import requests
from bs4 import BeautifulSoup
from urllib.parse import urljoin, urlparse
from urllib.robotparser import RobotFileParser
import nltk
import logging
from pathlib import Path
import hashlib

# ë²¡í„° ë°ì´í„°ë² ì´ìŠ¤ ê´€ë ¨ import
from langchain.embeddings import OpenAIEmbeddings
from langchain.vectorstores.faiss import FAISS
from langchain.text_splitter import CharacterTextSplitter
from langchain.document_loaders import UnstructuredFileLoader
from langchain.schema import Document

# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

# í‘œì¤€í™”ëœ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í•¨ìˆ˜
def connect_to_db():
    """ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°"""
    try:
        conn = mysql.connector.connect(
            host=os.getenv('SQL_HOST'),
            user=os.getenv('SQL_USER'),
            password=os.getenv('SQL_PASSWORD'),
            database=os.getenv('SQL_DATABASE_NEWBIZ'),
            charset='utf8mb4',
            collation='utf8mb4_unicode_ci'
        )
        return conn
    except mysql.connector.Error as err:
        st.error(f"ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì˜¤ë¥˜: {err}")
        return None

# ë¡œê¹… ì„¤ì •
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# NLTK ì„¤ì •
try:
    nltk.download('punkt', quiet=True)
except:
    pass

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(
    page_title="ğŸ¢ ê°€ìƒíšŒì‚¬ C-Level ë©€í‹°ì—ì´ì „íŠ¸ + RAG",
    page_icon="ğŸ¢",
    layout="wide"
)

# ìŠ¤íƒ€ì¼ë§
st.markdown("""
<style>
.persona-card {
    background: linear-gradient(145deg, #f0f2f6, #ffffff);
    border-radius: 15px;
    padding: 20px;
    margin: 10px 0;
    box-shadow: 5px 5px 15px #d1d9e6, -5px -5px 15px #ffffff;
    border-left: 5px solid #0066cc;
}

.persona-header {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
}

.persona-emoji {
    font-size: 2.5rem;
    margin-right: 15px;
}

.persona-title {
    color: #0066cc;
    font-size: 1.3rem;
    font-weight: bold;
    margin: 0;
}

.persona-subtitle {
    color: #666;
    font-size: 0.9rem;
    margin: 0;
}

.result-container {
    background: linear-gradient(145deg, #f8f9fa, #ffffff);
    border-radius: 12px;
    padding: 20px;
    margin: 15px 0;
    border-left: 4px solid #28a745;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.result-container h4 {
    color: #28a745;
    margin: 0;
    font-size: 1.1rem;
}

.ceo-final {
    background: linear-gradient(145deg, #fff3cd, #ffeaa7);
    border-left: 4px solid #f39c12;
    border-radius: 15px;
    padding: 20px;
    margin: 20px 0;
    box-shadow: 0 4px 15px rgba(243, 156, 18, 0.2);
}

.progress-indicator {
    background: linear-gradient(145deg, #0066cc, #0052a3);
    color: white;
    text-align: center;
    padding: 15px 20px;
    border-radius: 12px;
    margin: 15px 0;
    box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);
    border: none;
}

.progress-indicator strong {
    font-size: 1.1rem;
    font-weight: 600;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
}

.progress-section {
    background: #f8f9fa;
    border-radius: 15px;
    padding: 25px;
    margin: 20px 0;
    border: 2px solid #e9ecef;
}

.progress-section h2 {
    color: #0066cc;
    text-align: center;
    margin-bottom: 20px;
    font-size: 1.5rem;
}

.analysis-complete {
    background: linear-gradient(145deg, #d4edda, #c3e6cb);
    border: 2px solid #28a745;
    border-radius: 12px;
    padding: 15px;
    margin: 10px 0;
    text-align: center;
}

.analysis-complete h4 {
    color: #155724;
    margin: 0;
    font-size: 1.1rem;
}

.ceo-synthesis {
    background: linear-gradient(145deg, #ffeaa7, #fdcb6e);
    border: 2px solid #f39c12;
    border-radius: 12px;
    padding: 20px;
    margin: 15px 0;
    text-align: center;
}

.ceo-synthesis strong {
    color: #8e5b00;
    font-size: 1.2rem;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
}

.main-title {
    text-align: center;
    color: #0066cc;
    margin-bottom: 10px;
}

.main-subtitle {
    text-align: center;
    color: #666;
    font-size: 1.1rem;
    margin-bottom: 30px;
}
</style>
""", unsafe_allow_html=True)

# C-Level í˜ë¥´ì†Œë‚˜ ì •ì˜
PERSONAS = {
    "CTO": {
        "name": "Chief Technology Officer",
        "emoji": "ğŸ’»",
        "role": "ê¸°ìˆ  ì „ëµ ë° í˜ì‹  ì±…ì„ì",
        "expertise": "ê¸°ìˆ  ì•„í‚¤í…ì²˜, ê°œë°œ ì „ëµ, í˜ì‹ , ë””ì§€í„¸ ì „í™˜",
        "perspective": "ê¸°ìˆ ì  íƒ€ë‹¹ì„±, êµ¬í˜„ ê°€ëŠ¥ì„±, ê¸°ìˆ  íŠ¸ë Œë“œ, ë³´ì•ˆ, í™•ì¥ì„±ì„ ì¤‘ì‹¬ìœ¼ë¡œ ë¶„ì„",
        "system_prompt": """ë‹¹ì‹ ì€ ê²½í—˜ì´ í’ë¶€í•œ CTO(Chief Technology Officer)ì…ë‹ˆë‹¤. 
ê¸°ìˆ  ì „ëµ, ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜, ê°œë°œ ë°©ë²•ë¡ , ë³´ì•ˆ, í™•ì¥ì„± ê´€ì ì—ì„œ ë¶„ì„í•˜ê³  ì¡°ì–¸í•©ë‹ˆë‹¤.
í•­ìƒ ê¸°ìˆ ì  íƒ€ë‹¹ì„±ê³¼ êµ¬í˜„ ê°€ëŠ¥ì„±ì„ ìš°ì„ ì ìœ¼ë¡œ ê³ ë ¤í•˜ë©°, ìµœì‹  ê¸°ìˆ  íŠ¸ë Œë“œë¥¼ ë°˜ì˜í•©ë‹ˆë‹¤.
ì‹¤ìš©ì ì´ê³  êµ¬ì²´ì ì¸ ê¸°ìˆ  ì†”ë£¨ì…˜ì„ ì œì‹œí•©ë‹ˆë‹¤."""
    },
    "CSO_Strategy": {
        "name": "Chief Strategy Officer",
        "emoji": "ğŸ¯",
        "role": "ì „ëµ ê¸°íš ë° ì‚¬ì—… ê°œë°œ ì±…ì„ì",
        "expertise": "ì‚¬ì—… ì „ëµ, ì‹œì¥ ë¶„ì„, ê²½ìŸ ë¶„ì„, ì„±ì¥ ì „ëµ",
        "perspective": "ì‹œì¥ ê¸°íšŒ, ê²½ìŸ ìš°ìœ„, ì„±ì¥ ì ì¬ë ¥, ë¦¬ìŠ¤í¬ ë¶„ì„ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì „ëµì  ê´€ì  ì œì‹œ",
        "system_prompt": """ë‹¹ì‹ ì€ ì „ëµì  ì‚¬ê³ ê°€ ë›°ì–´ë‚œ CSO(Chief Strategy Officer)ì…ë‹ˆë‹¤.
ì‹œì¥ ë¶„ì„, ê²½ìŸ ë¶„ì„, ì‚¬ì—… ëª¨ë¸, ì„±ì¥ ì „ëµì„ ì „ë¬¸ìœ¼ë¡œ í•©ë‹ˆë‹¤.
ì¥ê¸°ì  ê´€ì ì—ì„œ ì „ëµì  ê¸°íšŒì™€ ìœ„í—˜ì„ í‰ê°€í•˜ê³ , ì§€ì† ê°€ëŠ¥í•œ ì„±ì¥ ë°©ì•ˆì„ ì œì‹œí•©ë‹ˆë‹¤.
ë°ì´í„° ê¸°ë°˜ì˜ ë…¼ë¦¬ì ì´ê³  ì²´ê³„ì ì¸ ì „ëµì„ ìˆ˜ë¦½í•©ë‹ˆë‹¤."""
    },
    "CMO": {
        "name": "Chief Marketing Officer",
        "emoji": "ğŸ“¢",
        "role": "ë§ˆì¼€íŒ… ë° ë¸Œëœë“œ ì „ëµ ì±…ì„ì",
        "expertise": "ë¸Œëœë“œ ì „ëµ, ê³ ê° ê²½í—˜, ë””ì§€í„¸ ë§ˆì¼€íŒ…, ì‹œì¥ ì¡°ì‚¬",
        "perspective": "ê³ ê° ë‹ˆì¦ˆ, ë¸Œëœë“œ í¬ì§€ì…”ë‹, ë§ˆì¼€íŒ… ì±„ë„, ê³ ê° ê²½í—˜ì„ ì¤‘ì‹¬ìœ¼ë¡œ ë¶„ì„",
        "system_prompt": """ë‹¹ì‹ ì€ ì°½ì˜ì ì´ê³  ê³ ê° ì¤‘ì‹¬ì ì¸ CMO(Chief Marketing Officer)ì…ë‹ˆë‹¤.
ë¸Œëœë“œ ì „ëµ, ê³ ê° ê²½í—˜, ë§ˆì¼€íŒ… ìº í˜ì¸, ì‹œì¥ í¬ì§€ì…”ë‹ì„ ì „ë¬¸ìœ¼ë¡œ í•©ë‹ˆë‹¤.
ê³ ê°ì˜ ê´€ì ì—ì„œ ê°€ì¹˜ë¥¼ ì°½ì¶œí•˜ê³ , íš¨ê³¼ì ì¸ ë§ˆì¼€íŒ… ì „ëµì„ ìˆ˜ë¦½í•©ë‹ˆë‹¤.
ë°ì´í„° ê¸°ë°˜ ë§ˆì¼€íŒ…ê³¼ ì°½ì˜ì  ì•„ì´ë””ì–´ë¥¼ ê²°í•©í•©ë‹ˆë‹¤."""
    },
    "CFO": {
        "name": "Chief Financial Officer",
        "emoji": "ğŸ’°",
        "role": "ì¬ë¬´ ì „ëµ ë° ë¦¬ìŠ¤í¬ ê´€ë¦¬ ì±…ì„ì",
        "expertise": "ì¬ë¬´ ë¶„ì„, íˆ¬ì í‰ê°€, ë¦¬ìŠ¤í¬ ê´€ë¦¬, ìˆ˜ìµì„± ë¶„ì„",
        "perspective": "ì¬ë¬´ì  íƒ€ë‹¹ì„±, íˆ¬ì ìˆ˜ìµë¥ , ë¹„ìš© íš¨ìœ¨ì„±, ë¦¬ìŠ¤í¬ ê´€ë¦¬ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ë¶„ì„",
        "system_prompt": """ë‹¹ì‹ ì€ ì‹ ì¤‘í•˜ê³  ë¶„ì„ì ì¸ CFO(Chief Financial Officer)ì…ë‹ˆë‹¤.
ì¬ë¬´ ë¶„ì„, íˆ¬ì í‰ê°€, ì˜ˆì‚° ê³„íš, ë¦¬ìŠ¤í¬ ê´€ë¦¬ë¥¼ ì „ë¬¸ìœ¼ë¡œ í•©ë‹ˆë‹¤.
ëª¨ë“  ê²°ì •ì„ ì¬ë¬´ì  ê´€ì ì—ì„œ í‰ê°€í•˜ê³ , ìˆ˜ìµì„±ê³¼ ì§€ì†ê°€ëŠ¥ì„±ì„ ì¤‘ì‹œí•©ë‹ˆë‹¤.
ì •í™•í•œ ìˆ˜ì¹˜ ë¶„ì„ê³¼ ì‹ ì¤‘í•œ ì¬ë¬´ ì „ëµì„ ì œì‹œí•©ë‹ˆë‹¤."""
    },
    "CSO_Sales": {
        "name": "Chief Sales Officer",
        "emoji": "ğŸ¤",
        "role": "ì˜ì—… ì „ëµ ë° ê³ ê° ê´€ê³„ ì±…ì„ì",
        "expertise": "ì˜ì—… ì „ëµ, ê³ ê° ê´€ê³„ ê´€ë¦¬, ì‹œì¥ ê°œë°œ, íŒŒíŠ¸ë„ˆì‹­",
        "perspective": "ì˜ì—… íš¨ìœ¨ì„±, ê³ ê° ë§Œì¡±ë„, ì‹œì¥ í™•ëŒ€, ìˆ˜ìµ ì°½ì¶œì„ ì¤‘ì‹¬ìœ¼ë¡œ ë¶„ì„",
        "system_prompt": """ë‹¹ì‹ ì€ ì„±ê³¼ ì§€í–¥ì ì´ê³  ê´€ê³„ ì¤‘ì‹¬ì ì¸ CSO(Chief Sales Officer)ì…ë‹ˆë‹¤.
ì˜ì—… ì „ëµ, ê³ ê° ê´€ê³„ ê´€ë¦¬, ì‹œì¥ ê°œë°œ, íŒŒíŠ¸ë„ˆì‹­ êµ¬ì¶•ì„ ì „ë¬¸ìœ¼ë¡œ í•©ë‹ˆë‹¤.
ê³ ê°ê³¼ì˜ ê´€ê³„ë¥¼ ì¤‘ì‹œí•˜ë©°, ì‹¤ì§ˆì ì¸ ë§¤ì¶œ ì„±ê³¼ë¥¼ ì¶”êµ¬í•©ë‹ˆë‹¤.
ì‹œì¥ ë™í–¥ì„ íŒŒì•…í•˜ê³  íš¨ê³¼ì ì¸ ì˜ì—… ì „ëµì„ ìˆ˜ë¦½í•©ë‹ˆë‹¤."""
    },
    "CIO": {
        "name": "Chief Information Officer",
        "emoji": "ğŸ”",
        "role": "ì •ë³´ì‹œìŠ¤í…œ ë° ë°ì´í„° ì „ëµ ì±…ì„ì",
        "expertise": "ì •ë³´ì‹œìŠ¤í…œ, ë°ì´í„° ê´€ë¦¬, IT ê±°ë²„ë„ŒìŠ¤, ë””ì§€í„¸ ì¸í”„ë¼",
        "perspective": "ì‹œìŠ¤í…œ íš¨ìœ¨ì„±, ë°ì´í„° í™œìš©, ë³´ì•ˆ, IT ê±°ë²„ë„ŒìŠ¤ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ë¶„ì„",
        "system_prompt": """ë‹¹ì‹ ì€ ì²´ê³„ì ì´ê³  ë³´ì•ˆ ì¤‘ì‹¬ì ì¸ CIO(Chief Information Officer)ì…ë‹ˆë‹¤.
ì •ë³´ì‹œìŠ¤í…œ, ë°ì´í„° ê´€ë¦¬, IT ê±°ë²„ë„ŒìŠ¤, ì‚¬ì´ë²„ ë³´ì•ˆì„ ì „ë¬¸ìœ¼ë¡œ í•©ë‹ˆë‹¤.
ì •ë³´ ìì‚°ì˜ íš¨ìœ¨ì  í™œìš©ê³¼ ë³´ì•ˆì„ ì¤‘ì‹œí•˜ë©°, ì²´ê³„ì ì¸ IT ì „ëµì„ ìˆ˜ë¦½í•©ë‹ˆë‹¤.
ë°ì´í„° ê¸°ë°˜ ì˜ì‚¬ê²°ì •ì„ ì§€ì›í•˜ëŠ” ì‹œìŠ¤í…œì„ êµ¬ì¶•í•©ë‹ˆë‹¤."""
    }
}

# CEO í˜ë¥´ì†Œë‚˜ (ì‚¬ìš©ì)
CEO_PERSONA = {
    "name": "Chief Executive Officer",
    "emoji": "ğŸ‘‘",
    "role": "ìµœê³ ê²½ì˜ì (ì‚¬ìš©ì í˜ë¥´ì†Œë‚˜)",
    "expertise": "ì¢…í•©ì  ê²½ì˜ íŒë‹¨, ì˜ì‚¬ê²°ì •, ë¦¬ë”ì‹­, ë¹„ì „ ì œì‹œ",
    "perspective": "ì „ì²´ì  ê´€ì ì—ì„œ ì¢…í•© ë¶„ì„í•˜ê³  ìµœì¢… ì˜ì‚¬ê²°ì • ì§€ì›",
    "system_prompt": """ë‹¹ì‹ ì€ ê²½í—˜ì´ í’ë¶€í•œ CEO(Chief Executive Officer)ì…ë‹ˆë‹¤.
ê° ì„ì›ì§„ë“¤ì˜ ë¶„ì„ê³¼ ì œì•ˆì„ ì¢…í•©í•˜ì—¬ ìµœì¢…ì ì¸ ì˜ì‚¬ê²°ì •ì„ ë‚´ë¦½ë‹ˆë‹¤.
ì „ì²´ì ì¸ ê´€ì ì—ì„œ ê· í˜• ì¡íŒ íŒë‹¨ì„ í•˜ë©°, íšŒì‚¬ì˜ ë¹„ì „ê³¼ ëª©í‘œì— ë§ëŠ” ë°©í–¥ì„ ì œì‹œí•©ë‹ˆë‹¤.
ë¦¬ë”ì‹­ê³¼ ì‹¤í–‰ë ¥ì„ ê²¸ë¹„í•œ í†µí•©ì  ì‚¬ê³ ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤."""
}

# RAG ë°ì´í„° ì†ŒìŠ¤ ì„¤ì •
RAG_SOURCES = {
    "mysql": {
        "name": "MySQL ë°ì´í„°ë² ì´ìŠ¤",
        "emoji": "ğŸ—„ï¸",
        "description": "íšŒì‚¬ ë°ì´í„°ë² ì´ìŠ¤ì˜ ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ë¶„ì„ì— í™œìš©"
    },
    "website": {
        "name": "ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§",
        "emoji": "ğŸŒ", 
        "description": "ê´€ë ¨ ì›¹ì‚¬ì´íŠ¸ì˜ ìµœì‹  ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ì—¬ ë¶„ì„"
    },
    "files": {
        "name": "ë¬¸ì„œ íŒŒì¼",
        "emoji": "ğŸ“„",
        "description": "ì—…ë¡œë“œëœ ë¬¸ì„œë“¤ì˜ ë‚´ìš©ì„ ë¶„ì„ì— ë°˜ì˜"
    }
}

# ì§€ì›ë˜ëŠ” íŒŒì¼ í˜•ì‹
SUPPORTED_FILE_TYPES = {
    "txt": {"max_size_mb": 10, "description": "í…ìŠ¤íŠ¸ íŒŒì¼"},
    "md": {"max_size_mb": 10, "description": "ë§ˆí¬ë‹¤ìš´ íŒŒì¼"},
    "pdf": {"max_size_mb": 50, "description": "PDF ë¬¸ì„œ"},
    "docx": {"max_size_mb": 50, "description": "Word ë¬¸ì„œ"},
    "csv": {"max_size_mb": 20, "description": "CSV íŒŒì¼"},
    "json": {"max_size_mb": 20, "description": "JSON íŒŒì¼"}
}

# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
if 'messages' not in st.session_state:
    st.session_state.messages = []

if 'current_analysis' not in st.session_state:
    st.session_state.current_analysis = {}

if 'analysis_complete' not in st.session_state:
    st.session_state.analysis_complete = False

if 'selected_model' not in st.session_state:
    st.session_state.selected_model = 'claude-3-5-sonnet-latest'

# RAG ê´€ë ¨ ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
if 'rag_sources' not in st.session_state:
    st.session_state.rag_sources = []

if 'mysql_data' not in st.session_state:
    st.session_state.mysql_data = {}

if 'website_data' not in st.session_state:
    st.session_state.website_data = {}

if 'files_data' not in st.session_state:
    st.session_state.files_data = {}

# ==================== RAG ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ ====================

def validate_file(file):
    """íŒŒì¼ ìœ íš¨ì„± ê²€ì‚¬"""
    errors = []
    file_ext = file.name.split('.')[-1].lower()
    if file_ext not in SUPPORTED_FILE_TYPES:
        errors.append(f"ì§€ì›ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹: {file_ext}")
        return errors
    
    file_size_mb = file.size / (1024 * 1024)
    max_size = SUPPORTED_FILE_TYPES[file_ext]["max_size_mb"]
    if file_size_mb > max_size:
        errors.append(f"íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤: {file_size_mb:.1f}MB (ìµœëŒ€: {max_size}MB)")
    
    return errors

def test_mysql_connection():
    """MySQL ì—°ê²° í…ŒìŠ¤íŠ¸"""
    try:
        # í™˜ê²½ë³€ìˆ˜ í™•ì¸
        required_vars = ['SQL_USER', 'SQL_PASSWORD', 'SQL_HOST', 'SQL_DATABASE_NEWBIZ']
        if not all([os.getenv(var) for var in required_vars]):
            return False, "í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
        
        # í‘œì¤€í™”ëœ ì—°ê²° í•¨ìˆ˜ ì‚¬ìš©
        connection = connect_to_db()
        if connection and connection.is_connected():
            connection.close()
            return True, "ì—°ê²° ì„±ê³µ"
        else:
            return False, "ì—°ê²° ì‹¤íŒ¨"
    except Exception as e:
        return False, str(e)

def get_mysql_tables():
    """MySQL í…Œì´ë¸” ëª©ë¡ ê°€ì ¸ì˜¤ê¸°"""
    try:
        # í‘œì¤€í™”ëœ ì—°ê²° í•¨ìˆ˜ ì‚¬ìš©
        connection = connect_to_db()
        if not connection:
            return [], {}
        
        cursor = connection.cursor()
        cursor.execute("SHOW TABLES")
        tables = [table[0] for table in cursor.fetchall()]
        
        # í…Œì´ë¸” ì •ë³´ ìˆ˜ì§‘
        table_info = {}
        for table in tables:
            cursor.execute(f"SELECT COUNT(*) FROM {table}")
            row_count = cursor.fetchone()[0]
            cursor.execute(f"DESCRIBE {table}")
            columns = cursor.fetchall()
            table_info[table] = {
                'rows': row_count,
                'columns': len(columns),
                'column_details': [(col[0], col[1]) for col in columns]
            }
        
        connection.close()
        return tables, table_info
    except Exception as e:
        logger.error(f"MySQL í…Œì´ë¸” ì¡°íšŒ ì˜¤ë¥˜: {e}")
        return [], {}

def load_mysql_data(selected_tables):
    """ì„ íƒëœ MySQL í…Œì´ë¸” ë°ì´í„° ë¡œë“œ"""
    try:
        # í‘œì¤€í™”ëœ ì—°ê²° í•¨ìˆ˜ ì‚¬ìš©
        connection = connect_to_db()
        if not connection:
            return {}
        
        data_frames = {}
        for table in selected_tables:
            query = f"SELECT * FROM {table} LIMIT 1000"  # ì„±ëŠ¥ì„ ìœ„í•´ ì œí•œ
            df = pd.read_sql(query, connection)
            data_frames[table] = df
        
        connection.close()
        return data_frames
    except Exception as e:
        logger.error(f"MySQL ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: {e}")
        return {}

def scrape_website_simple(url, max_pages=5):
    """ê°„ë‹¨í•œ ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§"""
    try:
        if not url.startswith(('http://', 'https://')):
            url = 'https://' + url
        
        visited_urls = set()
        texts = []
        urls_to_visit = [url]
        
        session = requests.Session()
        session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        })
        
        page_count = 0
        while urls_to_visit and page_count < max_pages:
            current_url = urls_to_visit.pop(0)
            
            if current_url in visited_urls:
                continue
                
            try:
                response = session.get(current_url, timeout=10)
                response.raise_for_status()
                
                visited_urls.add(current_url)
                page_count += 1
                
                soup = BeautifulSoup(response.content, "html.parser")
                
                # ë¶ˆí•„ìš”í•œ íƒœê·¸ ì œê±°
                for tag in soup(["script", "style", "nav", "header", "footer"]):
                    tag.decompose()
                
                page_text = soup.get_text(separator="\n", strip=True)
                lines = [line.strip() for line in page_text.split('\n') if line.strip()]
                cleaned_text = '\n'.join(lines)
                
                if len(cleaned_text) > 200:
                    page_title = soup.title.string.strip() if soup.title and soup.title.string else 'No Title'
                    texts.append({
                        'content': cleaned_text,
                        'url': current_url,
                        'title': page_title
                    })
                
                # ìƒˆë¡œìš´ ë§í¬ ì°¾ê¸° (ê°™ì€ ë„ë©”ì¸ë§Œ)
                base_domain = urlparse(url).netloc
                if page_count < max_pages:
                    for link in soup.find_all("a", href=True)[:10]:
                        absolute_link = urljoin(current_url, link['href'])
                        parsed_link = urlparse(absolute_link)
                        
                        if (parsed_link.netloc == base_domain and 
                            absolute_link not in visited_urls and 
                            absolute_link not in urls_to_visit):
                            urls_to_visit.append(absolute_link)
                
                time.sleep(1)  # ì§€ì—°ì‹œê°„
                
            except Exception as e:
                logger.error(f"í˜ì´ì§€ í¬ë¡¤ë§ ì˜¤ë¥˜ {current_url}: {e}")
                continue
        
        return texts
        
    except Exception as e:
        logger.error(f"ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ì˜¤ë¥˜: {e}")
        return []

def process_files(files):
    """ì—…ë¡œë“œëœ íŒŒì¼ë“¤ ì²˜ë¦¬"""
    processed_files = []
    
    for file in files:
        try:
            # íŒŒì¼ ì €ì¥
            file_path = f"./temp_uploads/{file.name}"
            os.makedirs("./temp_uploads", exist_ok=True)
            
            with open(file_path, "wb") as f:
                f.write(file.read())
            
            # íŒŒì¼ ë‚´ìš© ì½ê¸°
            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    content = f.read()
            except UnicodeDecodeError:
                with open(file_path, 'r', encoding='latin-1') as f:
                    content = f.read()
            
            processed_files.append({
                'name': file.name,
                'content': content,
                'size': len(content)
            })
            
            # ì„ì‹œ íŒŒì¼ ì‚­ì œ
            os.remove(file_path)
            
        except Exception as e:
            logger.error(f"íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜ {file.name}: {e}")
            continue
    
    return processed_files

def create_rag_context():
    """RAG ì»¨í…ìŠ¤íŠ¸ ìƒì„±"""
    context_parts = []
    
    # MySQL ë°ì´í„° ì»¨í…ìŠ¤íŠ¸
    if st.session_state.mysql_data:
        mysql_context = "=== MySQL ë°ì´í„°ë² ì´ìŠ¤ ì •ë³´ ===\n"
        for table_name, df in st.session_state.mysql_data.items():
            mysql_context += f"\n[{table_name}] í…Œì´ë¸”:\n"
            mysql_context += f"- í–‰ ìˆ˜: {len(df):,}ê°œ\n"
            mysql_context += f"- ì»¬ëŸ¼: {', '.join(df.columns.tolist())}\n"
            
            # ìƒ˜í”Œ ë°ì´í„° (ìƒìœ„ 3í–‰)
            if len(df) > 0:
                mysql_context += "- ìƒ˜í”Œ ë°ì´í„°:\n"
                mysql_context += df.head(3).to_string(index=False)
                mysql_context += "\n"
        
        context_parts.append(mysql_context)
    
    # ì›¹ì‚¬ì´íŠ¸ ë°ì´í„° ì»¨í…ìŠ¤íŠ¸
    if st.session_state.website_data:
        website_context = "=== ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ì •ë³´ ===\n"
        for i, page_data in enumerate(st.session_state.website_data[:3]):  # ìƒìœ„ 3ê°œ í˜ì´ì§€ë§Œ
            website_context += f"\n[í˜ì´ì§€ {i+1}] {page_data['title']}\n"
            website_context += f"URL: {page_data['url']}\n"
            website_context += f"ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°: {page_data['content'][:500]}...\n"
        
        context_parts.append(website_context)
    
    # íŒŒì¼ ë°ì´í„° ì»¨í…ìŠ¤íŠ¸
    if st.session_state.files_data:
        files_context = "=== ì—…ë¡œë“œëœ ë¬¸ì„œ ì •ë³´ ===\n"
        for file_data in st.session_state.files_data:
            files_context += f"\n[ë¬¸ì„œ] {file_data['name']}\n"
            files_context += f"í¬ê¸°: {file_data['size']:,}ì\n"
            files_context += f"ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°: {file_data['content'][:500]}...\n"
        
        context_parts.append(files_context)
    
    return "\n\n".join(context_parts)

# AI ë¶„ì„ í•¨ìˆ˜
def get_ai_response(prompt, model_name, system_prompt=""):
    """AI ëª¨ë¸ë¡œë¶€í„° ì‘ë‹µì„ ë°›ëŠ” í•¨ìˆ˜"""
    try:
        if model_name.startswith('claude'):
            client = ChatAnthropic(
                model=model_name, 
                api_key=os.getenv('ANTHROPIC_API_KEY'), 
                temperature=0.7, 
                max_tokens=4000
            )
            response = client.invoke([
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": prompt}
            ])
            return response.content if hasattr(response, 'content') else str(response)
        else:
            openai_key = os.getenv('OPENAI_API_KEY')
            if not openai_key or openai_key.strip() == '' or openai_key == 'NA':
                raise ValueError("OpenAI API í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.")
            
            client = OpenAI(api_key=openai_key)
            response = client.chat.completions.create(
                model=model_name,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": prompt}
                ],
                max_tokens=4000,
                temperature=0.7
            )
            return response.choices[0].message.content
    except Exception as e:
        st.error(f"AI ì‘ë‹µ ì¤‘ ì˜¤ë¥˜: {str(e)}")
        return None 

# C-Level í˜ë¥´ì†Œë‚˜ë³„ ë¶„ì„ ë‹¨ê³„ ì •ì˜
PERSONA_ANALYSIS_STAGES = {
    "CTO": [
        {"progress": 15, "message": "ê¸°ìˆ  ìš”êµ¬ì‚¬í•­ ë¶„ì„ ì¤‘..."},
        {"progress": 30, "message": "ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ê²€í†  ì¤‘..."},
        {"progress": 45, "message": "ê¸°ìˆ  íŠ¸ë Œë“œ ì¡°ì‚¬ ì¤‘..."},
        {"progress": 60, "message": "êµ¬í˜„ ê°€ëŠ¥ì„± í‰ê°€ ì¤‘..."},
        {"progress": 75, "message": "ë³´ì•ˆ ë° í™•ì¥ì„± ê²€í†  ì¤‘..."},
        {"progress": 90, "message": "ê¸°ìˆ  ì†”ë£¨ì…˜ ìˆ˜ë¦½ ì¤‘..."},
        {"progress": 100, "message": "ê¸°ìˆ  ë¶„ì„ ì™„ë£Œ!"}
    ],
    "CSO_Strategy": [
        {"progress": 12, "message": "ì‹œì¥ í™˜ê²½ ë¶„ì„ ì¤‘..."},
        {"progress": 28, "message": "ê²½ìŸì‚¬ í˜„í™© ì¡°ì‚¬ ì¤‘..."},
        {"progress": 42, "message": "ì„±ì¥ ê¸°íšŒ íƒìƒ‰ ì¤‘..."},
        {"progress": 58, "message": "ì „ëµì  ìœ„í—˜ í‰ê°€ ì¤‘..."},
        {"progress": 72, "message": "ì‚¬ì—… ëª¨ë¸ ê²€í†  ì¤‘..."},
        {"progress": 88, "message": "ì „ëµ ë°©í–¥ ìˆ˜ë¦½ ì¤‘..."},
        {"progress": 100, "message": "ì „ëµ ë¶„ì„ ì™„ë£Œ!"}
    ],
    "CMO": [
        {"progress": 18, "message": "ê³ ê° ë‹ˆì¦ˆ ë¶„ì„ ì¤‘..."},
        {"progress": 32, "message": "ë¸Œëœë“œ í¬ì§€ì…”ë‹ ê²€í†  ì¤‘..."},
        {"progress": 48, "message": "ë§ˆì¼€íŒ… ì±„ë„ ì¡°ì‚¬ ì¤‘..."},
        {"progress": 62, "message": "ê³ ê° ê²½í—˜ ì„¤ê³„ ì¤‘..."},
        {"progress": 78, "message": "ìº í˜ì¸ ì „ëµ ìˆ˜ë¦½ ì¤‘..."},
        {"progress": 92, "message": "ë§ˆì¼€íŒ… í”Œëœ ì™„ì„± ì¤‘..."},
        {"progress": 100, "message": "ë§ˆì¼€íŒ… ë¶„ì„ ì™„ë£Œ!"}
    ],
    "CFO": [
        {"progress": 10, "message": "ì¬ë¬´ ë°ì´í„° ìˆ˜ì§‘ ì¤‘..."},
        {"progress": 25, "message": "íˆ¬ì ìˆ˜ìµë¥  ê³„ì‚° ì¤‘..."},
        {"progress": 40, "message": "ë¦¬ìŠ¤í¬ ìš”ì¸ ë¶„ì„ ì¤‘..."},
        {"progress": 55, "message": "ë¹„ìš© êµ¬ì¡° ê²€í†  ì¤‘..."},
        {"progress": 70, "message": "ìˆ˜ìµì„± ëª¨ë¸ë§ ì¤‘..."},
        {"progress": 85, "message": "ì¬ë¬´ ì „ëµ ìˆ˜ë¦½ ì¤‘..."},
        {"progress": 100, "message": "ì¬ë¬´ ë¶„ì„ ì™„ë£Œ!"}
    ],
    "CSO_Sales": [
        {"progress": 16, "message": "ì‹œì¥ ê·œëª¨ ì¡°ì‚¬ ì¤‘..."},
        {"progress": 34, "message": "ê³ ê° ì„¸ê·¸ë¨¼íŠ¸ ë¶„ì„ ì¤‘..."},
        {"progress": 50, "message": "ì˜ì—… ì±„ë„ í‰ê°€ ì¤‘..."},
        {"progress": 66, "message": "íŒŒíŠ¸ë„ˆì‹­ ê¸°íšŒ íƒìƒ‰ ì¤‘..."},
        {"progress": 80, "message": "ì˜ì—… ì „ëµ ì„¤ê³„ ì¤‘..."},
        {"progress": 94, "message": "ì‹¤í–‰ ê³„íš ìˆ˜ë¦½ ì¤‘..."},
        {"progress": 100, "message": "ì˜ì—… ë¶„ì„ ì™„ë£Œ!"}
    ],
    "CIO": [
        {"progress": 14, "message": "ì‹œìŠ¤í…œ í˜„í™© ë¶„ì„ ì¤‘..."},
        {"progress": 29, "message": "ë°ì´í„° êµ¬ì¡° ê²€í†  ì¤‘..."},
        {"progress": 44, "message": "ë³´ì•ˆ ìš”êµ¬ì‚¬í•­ í‰ê°€ ì¤‘..."},
        {"progress": 59, "message": "IT ê±°ë²„ë„ŒìŠ¤ ì„¤ê³„ ì¤‘..."},
        {"progress": 74, "message": "ì¸í”„ë¼ ìµœì í™” ê³„íš ì¤‘..."},
        {"progress": 89, "message": "ì •ë³´ì „ëµ ìˆ˜ë¦½ ì¤‘..."},
        {"progress": 100, "message": "ì •ë³´ì‹œìŠ¤í…œ ë¶„ì„ ì™„ë£Œ!"}
    ]
}

# AI ë¶„ì„ í•¨ìˆ˜ ìˆ˜ì • (RAG ì»¨í…ìŠ¤íŠ¸ í¬í•¨)
def analyze_with_persona_rag(user_query, persona_key, persona_info, custom_prompt="", model_name="claude-3-5-sonnet-latest"):
    """RAG ì»¨í…ìŠ¤íŠ¸ë¥¼ í¬í•¨í•œ í˜ë¥´ì†Œë‚˜ ë¶„ì„"""
    
    # RAG ì»¨í…ìŠ¤íŠ¸ ìƒì„±
    rag_context = create_rag_context()
    
    # ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ êµ¬ì„±
    analysis_prompt = f"""
ë‹¤ìŒ ì£¼ì œ/ì§ˆë¬¸ì— ëŒ€í•´ {persona_info['role']} ê´€ì ì—ì„œ ì „ë¬¸ì ìœ¼ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”:

ã€ì£¼ì œ/ì§ˆë¬¸ã€‘
{user_query}

"""

    # RAG ì»¨í…ìŠ¤íŠ¸ ì¶”ê°€
    if rag_context:
        analysis_prompt += f"""
ã€ì¶”ê°€ ì°¸ê³  ë°ì´í„°ã€‘
{rag_context}

ìœ„ ë°ì´í„°ë¥¼ ì°¸ê³ í•˜ì—¬ ë” êµ¬ì²´ì ì´ê³  ë°ì´í„° ê¸°ë°˜ì˜ ë¶„ì„ì„ ì œê³µí•´ì£¼ì„¸ìš”.

"""

    analysis_prompt += f"""
ã€ë¶„ì„ ìš”êµ¬ì‚¬í•­ã€‘
- {persona_info['perspective']}
- êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ì œì•ˆ í¬í•¨
- ë³¸ì¸ì˜ ì „ë¬¸ ë¶„ì•¼ì— íŠ¹í™”ëœ ì¸ì‚¬ì´íŠ¸ ì œê³µ
- ë‹¤ë¥¸ ë¶€ì„œì™€ì˜ í˜‘ì—… ë°©ì•ˆ ê³ ë ¤
- ì œê³µëœ ë°ì´í„°ë¥¼ ì ê·¹ í™œìš©í•œ ë¶„ì„

"""
    
    # ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ê°€ ìˆë‹¤ë©´ ì¶”ê°€
    if custom_prompt and custom_prompt.strip():
        analysis_prompt += f"""
ã€ì¶”ê°€ ë¶„ì„ ìš”ì²­ì‚¬í•­ã€‘
{custom_prompt.strip()}

"""
    
    analysis_prompt += """
ã€ì‘ë‹µ í˜•ì‹ã€‘
## í•µì‹¬ ë¶„ì„
(2-3ì¤„ë¡œ í•µì‹¬ í¬ì¸íŠ¸ ìš”ì•½)

## ìƒì„¸ ë¶„ì„
(ì „ë¬¸ ë¶„ì•¼ ê´€ì ì—ì„œ ìƒì„¸í•œ ë¶„ì„, ì œê³µëœ ë°ì´í„° í™œìš©)

## ë°ì´í„° ê¸°ë°˜ ì¸ì‚¬ì´íŠ¸
(ì œê³µëœ ë°ì´í„°ì—ì„œ ë°œê²¬í•œ ì£¼ìš” ì¸ì‚¬ì´íŠ¸)

## ì‹¤í–‰ ì œì•ˆ
(êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ì•¡ì…˜ ì•„ì´í…œë“¤)

## ë‹¤ë¥¸ ë¶€ì„œ í˜‘ì—… ë°©ì•ˆ
(ë‹¤ë¥¸ C-levelê³¼ì˜ í˜‘ì—…ì´ í•„ìš”í•œ ë¶€ë¶„)

## ë¦¬ìŠ¤í¬ ë° ê³ ë ¤ì‚¬í•­
(ì£¼ì˜í•´ì•¼ í•  ì ë“¤)
"""
    
    return get_ai_response(analysis_prompt, model_name, persona_info['system_prompt'])

def analyze_persona_concurrent_rag(args):
    """RAG ê¸°ëŠ¥ì´ í¬í•¨ëœ ThreadPoolExecutor ë˜í¼ í•¨ìˆ˜"""
    user_query, persona_key, persona_info, custom_prompt, model_name = args
    try:
        result = analyze_with_persona_rag(user_query, persona_key, persona_info, custom_prompt, model_name)
        if result is None:
            return persona_key, f"AI ì‘ë‹µì´ Noneì…ë‹ˆë‹¤. API í‚¤ë‚˜ ëª¨ë¸ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.", False
        return persona_key, result, True
    except Exception as e:
        import traceback
        error_details = traceback.format_exc()
        return persona_key, f"ì˜¤ë¥˜ ë°œìƒ: {str(e)}\nìƒì„¸: {error_details}", False

def synthesize_ceo_analysis_rag(user_query, persona_analyses, model_name="claude-3-5-sonnet-latest"):
    """RAG ì»¨í…ìŠ¤íŠ¸ë¥¼ í¬í•¨í•œ CEO ì¢…í•© ë¶„ì„"""
    
    # RAG ì»¨í…ìŠ¤íŠ¸ ìƒì„±
    rag_context = create_rag_context()
    
    synthesis_prompt = f"""
ë‹¤ìŒì€ ìš°ë¦¬ íšŒì‚¬ C-level ì„ì›ì§„ë“¤ì´ ë¶„ì„í•œ ë‚´ìš©ì…ë‹ˆë‹¤. 
CEOë¡œì„œ ì´ë“¤ì˜ ë¶„ì„ì„ ì¢…í•©í•˜ì—¬ ìµœì¢… ì˜ì‚¬ê²°ì •ì„ ìœ„í•œ í†µí•© ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

ã€ì›ë˜ ì£¼ì œ/ì§ˆë¬¸ã€‘
{user_query}

"""

    # RAG ì»¨í…ìŠ¤íŠ¸ ì¶”ê°€
    if rag_context:
        synthesis_prompt += f"""
ã€ì°¸ê³  ë°ì´í„°ã€‘
{rag_context}

"""

    synthesis_prompt += """
ã€ê° ì„ì›ì§„ ë¶„ì„ ê²°ê³¼ã€‘
"""
    
    for persona_key, analysis in persona_analyses.items():
        if analysis and analysis.get('result'):
            persona_info = PERSONAS[persona_key]
            synthesis_prompt += f"""
--- {persona_info['emoji']} {persona_info['name']} ë¶„ì„ ---
{analysis['result']}

"""
    
    synthesis_prompt += """
ã€CEO ì¢…í•© ë¶„ì„ ìš”êµ¬ì‚¬í•­ã€‘
- ê° ì„ì›ì§„ì˜ ê´€ì ì„ ê· í˜•ìˆê²Œ ê³ ë ¤
- ì œê³µëœ ë°ì´í„°ë¥¼ ì ê·¹ í™œìš©í•œ ì˜ì‚¬ê²°ì •
- ì „ì‚¬ì  ê´€ì ì—ì„œì˜ ìš°ì„ ìˆœìœ„ ì„¤ì •
- ì‹¤í˜„ ê°€ëŠ¥í•œ í†µí•© ì‹¤í–‰ ê³„íš ìˆ˜ë¦½
- ë¦¬ìŠ¤í¬ì™€ ê¸°íšŒ ìš”ì¸ì˜ ì¢…í•©ì  í‰ê°€
- ëª…í™•í•œ ì˜ì‚¬ê²°ì • ë°©í–¥ ì œì‹œ

ã€ì‘ë‹µ í˜•ì‹ã€‘
## ğŸ¯ í•µì‹¬ ê²°ë¡  ë° ì˜ì‚¬ê²°ì •
(CEOë¡œì„œì˜ ìµœì¢… íŒë‹¨ê³¼ ê²°ì •ì‚¬í•­)

## ğŸ“Š ë°ì´í„° ê¸°ë°˜ í•µì‹¬ ì¸ì‚¬ì´íŠ¸  
(ì œê³µëœ ë°ì´í„°ì—ì„œ ë„ì¶œí•œ ì£¼ìš” ë°œê²¬ì‚¬í•­)

## ğŸ” ì„ì›ì§„ ë¶„ì„ ì¢…í•©
(ê° ì„ì›ì§„ ì˜ê²¬ì˜ í•µì‹¬ í¬ì¸íŠ¸ë“¤)

## ğŸš€ í†µí•© ì‹¤í–‰ ê³„íš
(ë‹¨ê³„ë³„ ì‹¤í–‰ ë°©ì•ˆ)

## âš–ï¸ ë¦¬ìŠ¤í¬ vs ê¸°íšŒ
(ì¢…í•©ì  ë¦¬ìŠ¤í¬-ê¸°íšŒ ë¶„ì„)

## ğŸ“ˆ ì„±ê³µ ì§€í‘œ ë° ëª¨ë‹ˆí„°ë§
(ì„±ê³¼ ì¸¡ì • ë°©ë²•)

## ğŸ’¡ CEO ìµœì¢… ë©”ì‹œì§€
(ì¡°ì§ì— ì „ë‹¬í•  í•µì‹¬ ë©”ì‹œì§€)
"""
    
    return get_ai_response(synthesis_prompt, model_name, CEO_PERSONA['system_prompt'])

def run_concurrent_analysis_with_progress_rag(user_query, persona_prompts, persona_status, persona_progress, model_name="claude-3-5-sonnet-latest"):
    """RAG ê¸°ëŠ¥ì´ í¬í•¨ëœ ë™ì‹œ ë¶„ì„ ì‹¤í–‰"""
    
    # ë¶„ì„ ì‘ì—… ì¤€ë¹„
    tasks = []
    for persona_key, persona_info in PERSONAS.items():
        custom_prompt = persona_prompts.get(persona_key, "")
        tasks.append((user_query, persona_key, persona_info, custom_prompt, model_name))
    
    # ê° í˜ë¥´ì†Œë‚˜ë³„ ì§„í–‰ ìƒíƒœ ì¶”ì 
    persona_stages = {}
    for persona_key in PERSONAS.keys():
        persona_stages[persona_key] = {
            'current_stage': 0,
            'last_update': time.time(),
            'stage_duration': random.uniform(2.0, 4.0)
        }
    
    # ì§„í–‰ë¥  ì• ë‹ˆë©”ì´ì…˜ í•¨ìˆ˜
    def animate_progress():
        while True:
            current_time = time.time()
            
            all_completed = True
            for persona_key, persona_info in PERSONAS.items():
                if persona_key not in st.session_state.get('completed_personas', set()):
                    all_completed = False
                    
                    stages = PERSONA_ANALYSIS_STAGES[persona_key]
                    stage_info = persona_stages[persona_key]
                    
                    if stage_info['current_stage'] < len(stages):
                        current_stage = stages[stage_info['current_stage']]
                        
                        elapsed_since_update = current_time - stage_info['last_update']
                        
                        if elapsed_since_update >= stage_info['stage_duration']:
                            stage_info['current_stage'] += 1
                            stage_info['last_update'] = current_time
                            stage_info['stage_duration'] = random.uniform(1.5, 3.5)
                            
                            if stage_info['current_stage'] < len(stages):
                                new_stage = stages[stage_info['current_stage']]
                                
                                if persona_progress[persona_key] is not None:
                                    persona_progress[persona_key].progress(new_stage['progress'])
                                
                                persona_status[persona_key].markdown(f"""
                                <div class="progress-indicator">
                                    <strong>ğŸš€ {persona_info['emoji']} {persona_info['name']}</strong><br>
                                    <span style="font-size: 0.9rem;">{new_stage['message']} ({new_stage['progress']}%)</span>
                                </div>
                                """, unsafe_allow_html=True)
                        else:
                            if stage_info['current_stage'] > 0:
                                prev_progress = stages[stage_info['current_stage'] - 1]['progress']
                                curr_progress = current_stage['progress']
                                
                                stage_progress = min(elapsed_since_update / stage_info['stage_duration'], 1.0)
                                interpolated_progress = prev_progress + (curr_progress - prev_progress) * stage_progress
                                
                                if persona_progress[persona_key] is not None:
                                    persona_progress[persona_key].progress(int(interpolated_progress))
                                
                                persona_status[persona_key].markdown(f"""
                                <div class="progress-indicator">
                                    <strong>ğŸš€ {persona_info['emoji']} {persona_info['name']}</strong><br>
                                    <span style="font-size: 0.9rem;">{current_stage['message']} ({int(interpolated_progress)}%)</span>
                                </div>
                                """, unsafe_allow_html=True)
            
            if all_completed:
                break
                
            time.sleep(0.3)
    
    st.session_state['completed_personas'] = set()
    
    progress_thread = threading.Thread(target=animate_progress)
    progress_thread.daemon = True
    progress_thread.start()
    
    # ThreadPoolExecutorë¡œ ë™ì‹œ ì‹¤í–‰ (RAG ë²„ì „ ì‚¬ìš©)
    results = {}
    with ThreadPoolExecutor(max_workers=len(PERSONAS)) as executor:
        future_to_persona = {
            executor.submit(analyze_persona_concurrent_rag, task): task[1] 
            for task in tasks
        }
        
        for future in as_completed(future_to_persona):
            persona_key = future_to_persona[future]
            try:
                persona_key, result, success = future.result()
                results[persona_key] = {
                    'result': result,
                    'success': success,
                    'completed': True,
                    'timestamp': datetime.now().isoformat()
                }
                
                st.session_state['completed_personas'].add(persona_key)
                
                if persona_progress[persona_key] is not None:
                    persona_progress[persona_key].progress(100)
                
                persona_info = PERSONAS[persona_key]
                if success:
                    completion_message = PERSONA_ANALYSIS_STAGES[persona_key][-1]['message']
                    persona_status[persona_key].markdown(f"""
                    <div class="analysis-complete">
                        <h4>ğŸ‰ {persona_info['emoji']} {persona_info['name']}</h4>
                        <p style="margin: 5px 0; font-size: 0.9rem; color: #155724;">
                            {completion_message}<br>
                            ì™„ë£Œ ì‹œê°„: {datetime.fromisoformat(results[persona_key]['timestamp']).strftime('%H:%M:%S')}
                        </p>
                    </div>
                    """, unsafe_allow_html=True)
                else:
                    persona_status[persona_key].markdown(f"""
                    <div style="background: #f8d7da; border: 2px solid #dc3545; border-radius: 12px; padding: 15px; margin: 10px 0; text-align: center;">
                        <h4 style="color: #721c24; margin: 0;">âŒ {persona_info['emoji']} {persona_info['name']} ë¶„ì„ ì˜¤ë¥˜</h4>
                        <p style="margin: 5px 0; font-size: 0.9rem; color: #721c24;">
                            ì˜¤ë¥˜ ì‹œê°„: {datetime.fromisoformat(results[persona_key]['timestamp']).strftime('%H:%M:%S')}
                        </p>
                    </div>
                    """, unsafe_allow_html=True)
                    
            except Exception as e:
                import traceback
                error_details = traceback.format_exc()
                results[persona_key] = {
                    'result': f"ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {str(e)}\nìƒì„¸: {error_details}",
                    'success': False,
                    'completed': True,
                    'timestamp': datetime.now().isoformat()
                }
                st.session_state['completed_personas'].add(persona_key)
    
    return results

# ==================== ì‚¬ì´ë“œë°” ì„¤ì • ====================

# ì‚¬ì´ë“œë°” ì„¤ì •
st.sidebar.title("ğŸ¢ C-Level ë©€í‹°ì—ì´ì „íŠ¸ ì„¤ì •")

# ëª¨ë¸ ì„ íƒ
available_models = []
has_anthropic_key = os.environ.get('ANTHROPIC_API_KEY') is not None
if has_anthropic_key:
    available_models.extend([
        'claude-3-5-sonnet-latest',
        'claude-3-5-haiku-latest',
    ])
has_openai_key = os.environ.get('OPENAI_API_KEY') is not None
if has_openai_key:
    available_models.extend(['gpt-4o', 'gpt-4o-mini'])

if not available_models:
    st.sidebar.error("API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
    available_models = ['claude-3-5-sonnet-latest']  # ê¸°ë³¸ê°’

selected_model = st.sidebar.selectbox(
    'ğŸ§  AI ëª¨ë¸ ì„ íƒ',
    options=available_models,
    index=available_models.index(st.session_state.selected_model) if st.session_state.selected_model in available_models else 0,
    help='ClaudeëŠ” ANTHROPIC_API_KEY, OpenAIëŠ” OPENAI_API_KEY í•„ìš”'
)

if selected_model != st.session_state.selected_model:
    st.session_state.selected_model = selected_model

st.sidebar.markdown("---")

# RAG ë°ì´í„° ì†ŒìŠ¤ ì„¤ì •
st.sidebar.markdown("### ğŸ” RAG ë°ì´í„° ì†ŒìŠ¤ ì„¤ì •")
st.sidebar.markdown("**ğŸ“Š ë¶„ì„ì— ì‚¬ìš©í•  ì¶”ê°€ ë°ì´í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”**")
st.sidebar.info("ğŸ’¡ RAG ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ë©´ ë” ì •í™•í•˜ê³  êµ¬ì²´ì ì¸ ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤!")

# í˜„ì¬ í™œì„± RAG ì†ŒìŠ¤ í‘œì‹œ
if st.session_state.rag_sources:
    # ì•ˆì „í•œ ë°©ì‹ìœ¼ë¡œ RAG ì†ŒìŠ¤ ìƒíƒœ í‘œì‹œ
    rag_names = []
    for source in st.session_state.rag_sources:
        if source in RAG_SOURCES:
            rag_names.append(f"{RAG_SOURCES[source]['emoji']} {RAG_SOURCES[source]['name']}")
    if rag_names:
        rag_status = "âœ… " + ", ".join(rag_names)
        st.sidebar.success(f"í™œì„± RAG ì†ŒìŠ¤: {rag_status}")
else:
    st.sidebar.warning("âŒ í™œì„± RAG ì†ŒìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ì—ì„œ ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.")

# MySQL ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
with st.sidebar.expander("ğŸ—„ï¸ MySQL ë°ì´í„°ë² ì´ìŠ¤", expanded=True):
    if st.sidebar.button("ğŸ” DB ì—°ê²° í…ŒìŠ¤íŠ¸", key="mysql_test"):
        success, message = test_mysql_connection()
        if success:
            st.sidebar.success(f"âœ… {message}")
        else:
            st.sidebar.error(f"âŒ {message}")
    
    if st.sidebar.button("ğŸ“‹ í…Œì´ë¸” ëª©ë¡ ì¡°íšŒ", key="mysql_tables"):
        tables, table_info = get_mysql_tables()
        if tables:
            st.session_state.available_tables = tables
            st.session_state.table_info = table_info
            st.sidebar.success(f"âœ… {len(tables)}ê°œ í…Œì´ë¸” ë°œê²¬")
        else:
            st.sidebar.error("âŒ í…Œì´ë¸” ì¡°íšŒ ì‹¤íŒ¨")
    
    # í…Œì´ë¸” ì„ íƒ
    if 'available_tables' in st.session_state:
        selected_tables = st.sidebar.multiselect(
            "ë¶„ì„í•  í…Œì´ë¸” ì„ íƒ",
            st.session_state.available_tables,
            help="ë„ˆë¬´ ë§ì€ í…Œì´ë¸”ì„ ì„ íƒí•˜ë©´ ì„±ëŠ¥ì´ ì €í•˜ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
            key="mysql_table_select"
        )
        
        if st.sidebar.button("ğŸ“¥ ì„ íƒëœ í…Œì´ë¸” ë¡œë“œ", key="mysql_load") and selected_tables:
            with st.sidebar:
                with st.spinner("MySQL ë°ì´í„° ë¡œë”© ì¤‘..."):
                    data_frames = load_mysql_data(selected_tables)
                    if data_frames:
                        st.session_state.mysql_data = data_frames
                        if 'mysql' not in st.session_state.rag_sources:
                            st.session_state.rag_sources.append('mysql')
                        total_rows = sum(len(df) for df in data_frames.values())
                        st.sidebar.success(f"âœ… {len(selected_tables)}ê°œ í…Œì´ë¸” ë¡œë“œ ì™„ë£Œ! (ì´ {total_rows:,}í–‰)")

# ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ì„¤ì •
with st.sidebar.expander("ğŸŒ ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§", expanded=True):
    website_url = st.sidebar.text_input("ì›¹ì‚¬ì´íŠ¸ URL", placeholder="https://example.com", key="website_url")
    max_pages = st.sidebar.slider("ìµœëŒ€ í˜ì´ì§€ ìˆ˜", 1, 10, 5, key="website_pages")
    
    if st.sidebar.button("ğŸ•·ï¸ ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ì‹œì‘", key="website_crawl") and website_url:
        with st.sidebar:
            with st.spinner("ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ì¤‘..."):
                scraped_data = scrape_website_simple(website_url, max_pages)
                if scraped_data:
                    st.session_state.website_data = scraped_data
                    if 'website' not in st.session_state.rag_sources:
                        st.session_state.rag_sources.append('website')
                    st.sidebar.success(f"âœ… {len(scraped_data)}ê°œ í˜ì´ì§€ í¬ë¡¤ë§ ì™„ë£Œ!")
                else:
                    st.sidebar.error("âŒ í¬ë¡¤ë§ ì‹¤íŒ¨")

# íŒŒì¼ ì—…ë¡œë“œ ì„¤ì •
with st.sidebar.expander("ğŸ“„ ë¬¸ì„œ íŒŒì¼", expanded=True):
    files = st.sidebar.file_uploader(
        "íŒŒì¼ ì—…ë¡œë“œ",
        type=list(SUPPORTED_FILE_TYPES.keys()),
        accept_multiple_files=True,
        help="ì—¬ëŸ¬ íŒŒì¼ì„ ë™ì‹œì— ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
        key="file_upload"
    )
    
    if files:
        valid_files = []
        for file in files:
            errors = validate_file(file)
            if not errors:
                valid_files.append(file)
            else:
                for error in errors:
                    st.sidebar.error(f"âŒ {file.name}: {error}")
        
        if valid_files and st.sidebar.button("ğŸ“ íŒŒì¼ ì²˜ë¦¬", key="file_process"):
            with st.sidebar:
                with st.spinner("íŒŒì¼ ì²˜ë¦¬ ì¤‘..."):
                    processed_files = process_files(valid_files)
                    if processed_files:
                        st.session_state.files_data = processed_files
                        if 'files' not in st.session_state.rag_sources:
                            st.session_state.rag_sources.append('files')
                        total_size = sum(f['size'] for f in processed_files)
                        st.sidebar.success(f"âœ… {len(processed_files)}ê°œ íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ! (ì´ {total_size:,}ì)")

# RAG ì†ŒìŠ¤ í˜„í™© í‘œì‹œ
if st.session_state.rag_sources:
    st.sidebar.markdown("### ğŸ“Š í™œì„± RAG ì†ŒìŠ¤")
    for source in st.session_state.rag_sources:
        if source in RAG_SOURCES:
            source_info = RAG_SOURCES[source]
            st.sidebar.markdown(f"âœ… {source_info['emoji']} {source_info['name']}")

st.sidebar.markdown("---")

# ë¶„ì„ í˜„í™© í‘œì‹œ
st.sidebar.subheader("ğŸ“Š ë¶„ì„ í˜„í™©")
if st.session_state.current_analysis:
    completed = len([k for k, v in st.session_state.current_analysis.items() if v.get('completed', False)])
    total = len(PERSONAS)
    st.sidebar.progress(completed / total)
    st.sidebar.write(f"ì§„í–‰ë¥ : {completed}/{total}")

# RAG ë°ì´í„° ìš”ì•½ í‘œì‹œ
if st.session_state.rag_sources:
    st.sidebar.markdown("### ğŸ“‹ ë¡œë“œëœ ë°ì´í„° ìš”ì•½")
    
    if 'mysql' in st.session_state.rag_sources and st.session_state.mysql_data:
        total_mysql_rows = sum(len(df) for df in st.session_state.mysql_data.values())
        st.sidebar.write(f"ğŸ—„ï¸ MySQL: {len(st.session_state.mysql_data)}ê°œ í…Œì´ë¸” ({total_mysql_rows:,}í–‰)")
    
    if 'website' in st.session_state.rag_sources and st.session_state.website_data:
        total_pages = len(st.session_state.website_data)
        st.sidebar.write(f"ğŸŒ ì›¹ì‚¬ì´íŠ¸: {total_pages}ê°œ í˜ì´ì§€")
    
    if 'files' in st.session_state.rag_sources and st.session_state.files_data:
        total_files = len(st.session_state.files_data)
        total_chars = sum(f['size'] for f in st.session_state.files_data)
        st.sidebar.write(f"ğŸ“„ íŒŒì¼: {total_files}ê°œ ë¬¸ì„œ ({total_chars:,}ì)")

# RAG ì†ŒìŠ¤ ê´€ë¦¬ ë²„íŠ¼ë“¤
if st.session_state.rag_sources:
    st.sidebar.markdown("### ğŸ”§ ë°ì´í„° ê´€ë¦¬")
    
    if st.sidebar.button("ğŸ—‘ï¸ ëª¨ë“  RAG ë°ì´í„° ì´ˆê¸°í™”", key="rag_reset"):
        st.session_state.rag_sources = []
        st.session_state.mysql_data = {}
        st.session_state.website_data = {}
        st.session_state.files_data = {}
        if 'available_tables' in st.session_state:
            del st.session_state.available_tables
        if 'table_info' in st.session_state:
            del st.session_state.table_info
        st.rerun()

st.sidebar.markdown("---")

# í˜ë¥´ì†Œë‚˜ë³„ ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ ì„¤ì •
st.sidebar.subheader("ğŸ­ í˜ë¥´ì†Œë‚˜ë³„ ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸")
st.sidebar.markdown("*ê° ì„ì›ì§„ì—ê²Œ íŠ¹ë³„í•œ ì§€ì‹œì‚¬í•­ì´ ìˆë‹¤ë©´ ì…ë ¥í•˜ì„¸ìš”*")

persona_prompts = {}
for persona_key, persona_info in PERSONAS.items():
    with st.sidebar.expander(f"{persona_info['emoji']} {persona_info['name']}"):
        st.markdown(f"**ì—­í• **: {persona_info['role']}")
        st.markdown(f"**ì „ë¬¸ë¶„ì•¼**: {persona_info['expertise']}")
        
        prompt_key = f"custom_prompt_{persona_key}"
        if prompt_key not in st.session_state:
            st.session_state[prompt_key] = ""
        
        persona_prompts[persona_key] = st.text_area(
            f"ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸",
            value=st.session_state[prompt_key],
            key=prompt_key,
            height=100,
            placeholder=f"{persona_info['name']}ì—ê²Œ íŠ¹ë³„íˆ ë¶„ì„í•´ë‹¬ë¼ê³  ìš”ì²­í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...",
            help=f"{persona_info['perspective']}"
        )

# ==================== ë©”ì¸ ì¸í„°í˜ì´ìŠ¤ ====================

st.markdown('<h1 class="main-title">ğŸ¢ ê°€ìƒíšŒì‚¬ C-Level ë©€í‹°ì—ì´ì „íŠ¸ + RAG</h1>', unsafe_allow_html=True)
st.markdown('<p class="main-subtitle"><strong>ë‹¹ì‹ ì€ CEOì…ë‹ˆë‹¤. C-level ì„ì›ì§„ë“¤ì´ ë‹¤ì–‘í•œ ë°ì´í„°ë¥¼ í™œìš©í•˜ì—¬ í˜‘ë ¥ ë¶„ì„í•˜ê³ , ìµœì¢… ì¢…í•© ë³´ê³ ì„œë¥¼ ì œê³µí•©ë‹ˆë‹¤.</strong></p>', unsafe_allow_html=True)

# í˜„ì¬ ì„¤ì • ì •ë³´ í‘œì‹œ
st.markdown("### âš™ï¸ í˜„ì¬ ì‹œìŠ¤í…œ ì„¤ì •")
col1, col2, col3 = st.columns([2, 2, 1])
with col1:
    st.markdown(f"**ğŸ§  AI ëª¨ë¸**: `{selected_model}`")
    
    # API í‚¤ ìƒíƒœ í™•ì¸
    if selected_model.startswith('claude'):
        api_key = os.getenv('ANTHROPIC_API_KEY')
        if api_key and len(api_key) > 10:
            st.markdown(f"**ğŸ”‘ Anthropic API**: âœ… ì„¤ì •ë¨ (`{api_key[:8]}...`)")
        else:
            st.markdown("**ğŸ”‘ Anthropic API**: âŒ ì„¤ì •ë˜ì§€ ì•ŠìŒ")
    else:
        api_key = os.getenv('OPENAI_API_KEY')
        if api_key and len(api_key) > 10:
            st.markdown(f"**ğŸ”‘ OpenAI API**: âœ… ì„¤ì •ë¨ (`{api_key[:8]}...`)")
        else:
            st.markdown("**ğŸ”‘ OpenAI API**: âŒ ì„¤ì •ë˜ì§€ ì•ŠìŒ")
            
with col2:
    if st.session_state.rag_sources:
        # ì•ˆì „í•œ ë°©ì‹ìœ¼ë¡œ RAG ì†ŒìŠ¤ ì´ëª¨ì§€ ìƒì„±
        rag_emojis = []
        for source in st.session_state.rag_sources:
            if source in RAG_SOURCES:
                rag_emojis.append(RAG_SOURCES[source]['emoji'])
        rag_emoji = "".join(rag_emojis)
        st.markdown(f"**ğŸ” RAG ì†ŒìŠ¤**: {rag_emoji} `{len(st.session_state.rag_sources)}ê°œ í™œì„±`")
    else:
        st.markdown("**ğŸ” RAG ì†ŒìŠ¤**: âš ï¸ `ì—†ìŒ (ì‚¬ì´ë“œë°”ì—ì„œ ì„¤ì •)`")
with col3:
    if st.button("ğŸ”„ ì´ˆê¸°í™”", help="ëª¨ë“  ë¶„ì„ ê²°ê³¼ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤"):
        st.session_state.current_analysis = {}
        st.session_state.analysis_complete = False
        st.rerun()

# API í‚¤ í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ì¶”ê°€
if st.button("ğŸ§ª AI ëª¨ë¸ ì—°ê²° í…ŒìŠ¤íŠ¸", help="ì„ íƒëœ AI ëª¨ë¸ê³¼ì˜ ì—°ê²°ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤"):
    try:
        test_response = get_ai_response("ì•ˆë…•í•˜ì„¸ìš”. ê°„ë‹¨í•œ ì¸ì‚¬ë§ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”.", selected_model, "ë‹¹ì‹ ì€ ë„ì›€ì´ ë˜ëŠ” AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.")
        if test_response:
            st.success(f"âœ… AI ëª¨ë¸ ì—°ê²° ì„±ê³µ!\nì‘ë‹µ: {test_response[:100]}...")
        else:
            st.error("âŒ AI ëª¨ë¸ ì‘ë‹µì´ Noneì…ë‹ˆë‹¤. API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")
    except Exception as e:
        st.error(f"âŒ AI ëª¨ë¸ ì—°ê²° ì‹¤íŒ¨: {str(e)}")

st.markdown("---")

# RAG ì„¤ì • ê°€ì´ë“œ
if not st.session_state.rag_sources:
    st.info("ğŸ’¡ **ë” ì •í™•í•œ ë¶„ì„ì„ ìœ„í•´ ì‚¬ì´ë“œë°”ì—ì„œ RAG ë°ì´í„° ì†ŒìŠ¤ë¥¼ ì„¤ì •í•´ë³´ì„¸ìš”!**\n"
           "- ğŸ—„ï¸ **MySQL**: íšŒì‚¬ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°\n"
           "- ğŸŒ **ì›¹ì‚¬ì´íŠ¸**: ì‹œì¥ ë™í–¥ ë° ê²½ìŸì‚¬ ì •ë³´ ìˆ˜ì§‘\n"
           "- ğŸ“„ **ë¬¸ì„œ**: ë³´ê³ ì„œ, ê³„íšì„œ ë“± ê´€ë ¨ ë¬¸ì„œ ì—…ë¡œë“œ")

# ì„ì›ì§„ ì†Œê°œ
st.markdown("## ğŸ‘¥ C-Level ì„ì›ì§„")
cols = st.columns(3)
for i, (persona_key, persona_info) in enumerate(PERSONAS.items()):
    with cols[i % 3]:
        st.markdown(f"""
        <div class="persona-card">
            <div class="persona-header">
                <div class="persona-emoji">{persona_info['emoji']}</div>
                <div>
                    <div class="persona-title">{persona_info['name']}</div>
                    <div class="persona-subtitle">{persona_info['role']}</div>
                </div>
            </div>
            <div style="font-size: 0.85rem; color: #666;">
                {persona_info['expertise']}
            </div>
        </div>
        """, unsafe_allow_html=True)

st.markdown("---")

# ë©”ì¸ ì…ë ¥
user_query = st.text_area(
    "ğŸ“ CEOë‹˜, ì–´ë–¤ ì£¼ì œì— ëŒ€í•´ C-level ì„ì›ì§„ë“¤ì˜ ë¶„ì„ì´ í•„ìš”í•˜ì‹ ê°€ìš”?",
    height=120,
    placeholder="ì˜ˆ: ìƒˆë¡œìš´ AI ì„œë¹„ìŠ¤ ë¡ ì¹­ ì „ëµì— ëŒ€í•´ ë¶„ì„í•´ì£¼ì„¸ìš”...\nì˜ˆ: ë””ì§€í„¸ ì „í™˜ì„ ìœ„í•œ íˆ¬ì ê³„íšì„ ê²€í† í•´ì£¼ì„¸ìš”...\nì˜ˆ: í•´ì™¸ ì‹œì¥ ì§„ì¶œ ë°©ì•ˆì„ ë¶„ì„í•´ì£¼ì„¸ìš”..."
)

# ë¶„ì„ ë²„íŠ¼ (í…ŒìŠ¤íŠ¸ìš© ìµœì†Œí•œ ë²„ì „)
if st.button("ğŸš€ C-Level ì„ì›ì§„ ë¶„ì„ ì‹œì‘", type="primary", use_container_width=True):
    if not user_query.strip():
        st.warning("ë¶„ì„í•  ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
    else:
        st.session_state.current_analysis = {}
        st.session_state.analysis_complete = False
        
        # ì§„í–‰ ìƒí™© í‘œì‹œ
        progress_container = st.container()
        
        with progress_container:
            st.markdown("""
            <div class="progress-section">
                <h2>ğŸš€ C-Level ì„ì›ì§„ ë™ì‹œ ë¶„ì„ ì‹œì‘!</h2>
                <p style="text-align: center; color: #666; margin-top: 10px;">
                    ëª¨ë“  ì„ì›ì§„ì´ ë™ì‹œì— ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤...
                </p>
            </div>
            """, unsafe_allow_html=True)
            
            # ëª¨ë“  í˜ë¥´ì†Œë‚˜ì— ëŒ€í•´ "ë¶„ì„ ì‹œì‘" ìƒíƒœ í‘œì‹œ
            persona_status = {}
            persona_progress = {}
            for persona_key, persona_info in PERSONAS.items():
                persona_status[persona_key] = st.empty()
                
                # ì²« ë²ˆì§¸ ë‹¨ê³„ë¡œ ì´ˆê¸° ìƒíƒœ í‘œì‹œ
                first_stage = PERSONA_ANALYSIS_STAGES[persona_key][0]
                persona_status[persona_key].markdown(f"""
                <div class="progress-indicator">
                    <strong>ğŸš€ {persona_info['emoji']} {persona_info['name']}</strong><br>
                    <span style="font-size: 0.9rem;">{first_stage['message']} (0%)</span>
                </div>
                """, unsafe_allow_html=True)
                
                # ì§„í–‰ë¥  ë°” ì¶”ê°€
                persona_progress[persona_key] = st.progress(0)
                st.markdown(f"<div style='margin-bottom: 20px;'></div>", unsafe_allow_html=True)
            
            # ë™ì‹œ ë¶„ì„ ì‹¤í–‰
            with st.spinner("ğŸ”¥ ëª¨ë“  C-Level ì„ì›ì§„ì´ ë™ì‹œì— ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤..."):
                # ì‹¤ì œ ë™ì‹œ ë¶„ì„ ìˆ˜í–‰
                analysis_results = run_concurrent_analysis_with_progress_rag(user_query, persona_prompts, persona_status, persona_progress, selected_model)
                
                # ê²°ê³¼ë¥¼ ì„¸ì…˜ì— ì €ì¥
                for persona_key, result_data in analysis_results.items():
                    st.session_state.current_analysis[persona_key] = result_data
                
                # ë¶„ì„ ê²°ê³¼ í‘œì‹œ (expanderë¡œ)
                st.markdown("### ğŸ“‹ ìƒì„¸ ë¶„ì„ ê²°ê³¼")
                for persona_key, result_data in analysis_results.items():
                    persona_info = PERSONAS[persona_key]
                    
                    if result_data['success']:
                        with st.expander(f"ğŸ“‹ {persona_info['emoji']} {persona_info['name']} ìƒì„¸ ë¶„ì„ ê²°ê³¼", expanded=True):
                            st.markdown(result_data['result'])
                    else:
                        with st.expander(f"âŒ {persona_info['emoji']} {persona_info['name']} ì˜¤ë¥˜ ìƒì„¸", expanded=True):
                            st.error(f"ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {result_data['result']}")
            
            # ì„±ê³µí•œ ë¶„ì„ë§Œ CEO ì¢…í•© ë¶„ì„ì— ì‚¬ìš©
            successful_analyses = {
                k: v for k, v in st.session_state.current_analysis.items() 
                if v.get('success', False)
            }
            
            if successful_analyses:
                # CEO ì¢…í•© ë¶„ì„
                st.markdown("---")
                st.markdown("""
                <div class="ceo-synthesis">
                    <strong>ğŸ‘‘ CEO ìµœì¢… ì¢…í•© ë¶„ì„ ì¤‘...</strong>
                    <p style="margin: 10px 0; font-size: 0.9rem;">
                        ëª¨ë“  ì„ì›ì§„ì˜ ë™ì‹œ ë¶„ì„ ê²°ê³¼ë¥¼ ì¢…í•©í•©ë‹ˆë‹¤
                    </p>
                </div>
                """, unsafe_allow_html=True)
                
                with st.spinner("CEO ìµœì¢… ì¢…í•© ë¶„ì„ ì¤‘..."):
                    ceo_synthesis = synthesize_ceo_analysis_rag(user_query, successful_analyses, selected_model)
                    
                    if ceo_synthesis:
                        st.session_state.current_analysis['CEO'] = {
                            'result': ceo_synthesis,
                            'completed': True,
                            'timestamp': datetime.now().isoformat()
                        }
                        st.session_state.analysis_complete = True
            else:
                st.error("âŒ ëª¨ë“  ì„ì›ì§„ ë¶„ì„ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.")
        
        # ì§„í–‰ ìƒí™© í‘œì‹œ ì œê±°
        progress_container.empty()
        
        if st.session_state.analysis_complete:
            st.balloons()
            st.success("ğŸ‰ ë™ì‹œ ë¶„ì„ì´ ëª¨ë‘ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")

# ë¶„ì„ ê²°ê³¼ í‘œì‹œ
if st.session_state.analysis_complete and 'CEO' in st.session_state.current_analysis:
    st.markdown("---")
    st.markdown("## ğŸ‘‘ CEO ìµœì¢… ì¢…í•© ë³´ê³ ì„œ")
    
    st.markdown(f"""
    <div class="ceo-final">
        <h3>ğŸ‘‘ CEO ìµœì¢… ì˜ì‚¬ê²°ì • ë³´ê³ ì„œ</h3>
        <p><strong>ë¶„ì„ ì™„ë£Œ ì‹œê°„:</strong> {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</p>
    </div>
    """, unsafe_allow_html=True)
    
    st.markdown(st.session_state.current_analysis['CEO']['result'])
    
    # ê°œë³„ ì„ì›ì§„ ë¶„ì„ ê²°ê³¼ (ì ‘ì„ ìˆ˜ ìˆëŠ” í˜•íƒœ)
    st.markdown("## ğŸ“‹ ê°œë³„ ì„ì›ì§„ ë¶„ì„ ê²°ê³¼")
    
    for persona_key, persona_info in PERSONAS.items():
        if persona_key in st.session_state.current_analysis:
            analysis_data = st.session_state.current_analysis[persona_key]
            with st.expander(f"{persona_info['emoji']} {persona_info['name']} ìƒì„¸ ë¶„ì„"):
                st.markdown(f"**ë¶„ì„ ì‹œê°„:** {analysis_data['timestamp']}")
                st.markdown("---")
                st.markdown(analysis_data['result'])

# í‘¸í„°
st.markdown("---")

# ì‚¬ìš©ë²• ì•ˆë‚´
with st.expander("ğŸ’¡ ì‚¬ìš©ë²• ì•ˆë‚´"):
    st.markdown("""
    ### ğŸ¢ C-Level ë©€í‹°ì—ì´ì „íŠ¸ + RAG ì‹œìŠ¤í…œ ì‚¬ìš©ë²•
    
    #### ğŸš€ ê¸°ë³¸ ì‚¬ìš© ë‹¨ê³„
    1. **ëª¨ë¸ ì„ íƒ**: ì‚¬ì´ë“œë°”ì—ì„œ ì‚¬ìš©í•  AI ëª¨ë¸ì„ ì„ íƒí•˜ì„¸ìš” (Claude/ChatGPT)
    2. **RAG ë°ì´í„° ì¤€ë¹„**: ë¶„ì„ì— í™œìš©í•  ì¶”ê°€ ë°ì´í„°ë¥¼ ì„¤ì •í•˜ì„¸ìš”
       - ğŸ—„ï¸ **MySQL ë°ì´í„°ë² ì´ìŠ¤**: íšŒì‚¬ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ë° í…Œì´ë¸” ì„ íƒ
       - ğŸŒ **ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§**: ê´€ë ¨ ì›¹ì‚¬ì´íŠ¸ì˜ ìµœì‹  ì •ë³´ ìˆ˜ì§‘
       - ğŸ“„ **ë¬¸ì„œ íŒŒì¼**: ë³´ê³ ì„œ, ê³„íšì„œ ë“± ê´€ë ¨ ë¬¸ì„œ ì—…ë¡œë“œ
    3. **ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸**: ê° ì„ì›ì§„ì—ê²Œ íŠ¹ë³„í•œ ë¶„ì„ì„ ìš”ì²­í•˜ê³  ì‹¶ë‹¤ë©´ ì„¤ì •í•˜ì„¸ìš”
    4. **ì£¼ì œ ì…ë ¥**: ë©”ì¸ ì°½ì—ì„œ ë¶„ì„í•˜ê³  ì‹¶ì€ ì£¼ì œë‚˜ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”
    5. **ë™ì‹œ ë¶„ì„**: ëª¨ë“  C-Level ì„ì›ì§„ì´ **ì‹¤ì œë¡œ ë™ì‹œì—** RAG ë°ì´í„°ë¥¼ í™œìš©í•˜ì—¬ ë¶„ì„í•©ë‹ˆë‹¤ ğŸš€
    6. **CEO ì¢…í•©**: ëª¨ë“  ë¶„ì„ì´ ëë‚˜ë©´ CEO(ë‹¹ì‹ )ê°€ ìµœì¢… ì¢…í•© ì˜ì‚¬ê²°ì •ì„ ì œì‹œí•©ë‹ˆë‹¤
    
    #### ğŸ­ í˜ë¥´ì†Œë‚˜ë³„ íŠ¹ì§•
    - **ğŸ’» CTO**: ê¸°ìˆ ì  íƒ€ë‹¹ì„±ê³¼ êµ¬í˜„ ë°©ì•ˆ, ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜
    - **ğŸ¯ CSO(ì „ëµ)**: ì‹œì¥ ë¶„ì„ê³¼ ì„±ì¥ ì „ëµ, ê²½ìŸ ë¶„ì„
    - **ğŸ“¢ CMO**: ë§ˆì¼€íŒ…ê³¼ ê³ ê° ê²½í—˜, ë¸Œëœë“œ ì „ëµ
    - **ğŸ’° CFO**: ì¬ë¬´ì  íƒ€ë‹¹ì„±ê³¼ ë¦¬ìŠ¤í¬, íˆ¬ì ë¶„ì„
    - **ğŸ¤ CSO(ì˜ì—…)**: ì˜ì—… ì „ëµê³¼ ê³ ê° ê´€ê³„, ì‹œì¥ ê°œë°œ
    - **ğŸ” CIO**: ì •ë³´ì‹œìŠ¤í…œê³¼ ë°ì´í„° ì „ëµ, IT ê±°ë²„ë„ŒìŠ¤
    - **ğŸ‘‘ CEO**: ìµœì¢… ì¢…í•© ì˜ì‚¬ê²°ì • ë° í†µí•© ì‹¤í–‰ ê³„íš
    
    #### ğŸ” RAG ë°ì´í„° ì†ŒìŠ¤ë³„ í™œìš©ë²•
    
    **ğŸ—„ï¸ MySQL ë°ì´í„°ë² ì´ìŠ¤**
    - íšŒì‚¬ì˜ ì‹¤ì‹œê°„ ìš´ì˜ ë°ì´í„°ë¥¼ ë¶„ì„ì— í™œìš©
    - ê³ ê° ë°ì´í„°, ë§¤ì¶œ ë°ì´í„°, ì¬ê³  í˜„í™© ë“±
    - ì˜ˆì‹œ: "ì§€ë‚œ ë¶„ê¸° ë§¤ì¶œ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë§ˆì¼€íŒ… ì „ëµì„ ìˆ˜ë¦½í•´ì£¼ì„¸ìš”"
    
    **ğŸŒ ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§**
    - ê²½ìŸì‚¬ ì›¹ì‚¬ì´íŠ¸, ì—…ê³„ ë‰´ìŠ¤, ì‹œì¥ ë™í–¥ íŒŒì•…
    - ìµœì‹  íŠ¸ë Œë“œì™€ ì‹œì¥ ì •ë³´ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°˜ì˜
    - ì˜ˆì‹œ: "ê²½ìŸì‚¬ ì›¹ì‚¬ì´íŠ¸ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìš°ë¦¬ì˜ ì°¨ë³„í™” ì „ëµì„ ì œì•ˆí•´ì£¼ì„¸ìš”"
    
    **ğŸ“„ ë¬¸ì„œ íŒŒì¼**
    - ê¸°ì¡´ ë³´ê³ ì„œ, ê³„íšì„œ, ì‹œì¥ ì¡°ì‚¬ ìë£Œ ë“±
    - ê³¼ê±° ë°ì´í„°ì™€ ë¶„ì„ ê²°ê³¼ë¥¼ í˜„ì¬ ë¶„ì„ì— í™œìš©
    - ì˜ˆì‹œ: "ì‘ë…„ ì‚¬ì—… ê³„íšì„œë¥¼ ì°¸ê³ í•˜ì—¬ ì˜¬í•´ ì „ëµì„ ìˆ˜ì •í•´ì£¼ì„¸ìš”"
    
    #### âš¡ ë™ì‹œ ì²˜ë¦¬ì˜ ì¥ì 
    - **ì†ë„**: ìˆœì°¨ ì²˜ë¦¬ ëŒ€ë¹„ **6ë°° ë¹ ë¥¸** ë¶„ì„ ì†ë„
    - **íš¨ìœ¨ì„±**: ëª¨ë“  ì„ì›ì§„ì´ **ì‹¤ì œë¡œ ë™ì‹œì—** ì‘ì—…
    - **ë°ì´í„° í™œìš©**: RAGë¥¼ í†µí•´ **ì‹¤ì œ ë°ì´í„° ê¸°ë°˜** ë¶„ì„
    - **ì‹¤ì‹œê°„**: ì™„ë£Œë˜ëŠ” ìˆœì„œëŒ€ë¡œ **ì¦‰ì‹œ ê²°ê³¼ í™•ì¸**
    - **ê²¬ê³ ì„±**: ì¼ë¶€ ë¶„ì„ì´ ì‹¤íŒ¨í•´ë„ ë‚˜ë¨¸ì§€ëŠ” ì •ìƒ ì§„í–‰
    
    #### ğŸ’¡ íš¨ê³¼ì ì¸ í™œìš© íŒ
    
    **ì£¼ì œ ì„¤ì •**
    - êµ¬ì²´ì ì´ê³  ëª…í™•í•œ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”
    - ì˜ˆ: "ì‹ ì œí’ˆ ì¶œì‹œë¥¼ ìœ„í•œ ì¢…í•© ì „ëµ" â†’ "AI ê¸°ë°˜ ì±—ë´‡ ì„œë¹„ìŠ¤ ì¶œì‹œë¥¼ ìœ„í•œ ë§ˆì¼€íŒ…, ê¸°ìˆ , ì¬ë¬´ ì „ëµ"
    
    **RAG ë°ì´í„° ì¡°í•©**
    - ì—¬ëŸ¬ ë°ì´í„° ì†ŒìŠ¤ë¥¼ ì¡°í•©í•˜ë©´ ë” í’ë¶€í•œ ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤
    - MySQL(ë‚´ë¶€ ë°ì´í„°) + ì›¹ì‚¬ì´íŠ¸(ì™¸ë¶€ ì •ë³´) + ë¬¸ì„œ(ê³¼ê±° ìë£Œ) ì¡°í•© ì¶”ì²œ
    
    **ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ í™œìš©**
    - ê° ì„ì›ì§„ì˜ ì „ë¬¸ ë¶„ì•¼ì— ë§ëŠ” êµ¬ì²´ì ì¸ ìš”ì²­ì„ ì¶”ê°€í•˜ì„¸ìš”
    - ì˜ˆ: CFOì—ê²Œ "ROI ê³„ì‚°ê³¼ í•¨ê»˜ 3ë…„ ì¬ë¬´ ì „ë§ í¬í•¨", CTOì—ê²Œ "ê¸°ìˆ  êµ¬í˜„ ì¼ì •ê³¼ ë¦¬ì†ŒìŠ¤ ìš”êµ¬ì‚¬í•­ í¬í•¨"
    """)

st.markdown("""
<div style="text-align: center; color: #666; font-size: 0.9rem;">
    ğŸ¢ ê°€ìƒíšŒì‚¬ C-Level ë©€í‹°ì—ì´ì „íŠ¸ + RAG ì‹œìŠ¤í…œ | Powered by Claude & ChatGPT<br>
    ğŸ” RAG: MySQL Database + Website Crawling + Document Analysis
</div>
""", unsafe_allow_html=True) 